!function(){function e(e,t,i,n){Object.defineProperty(e,t,{get:i,set:n,enumerable:!0,configurable:!0})}function t(e){return e&&e.__esModule?e.default:e}var i,n,r,a,s,o,l,h,c,u,p,d,g,f,v,m,y,x,b,B,w,k,C="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},S={},E={},I=C.parcelRequire94c2;null==I&&((I=function(e){if(e in S)return S[e].exports;if(e in E){var t=E[e];delete E[e];var i={id:e,exports:{}};return S[e]=i,t.call(i.exports,i,i.exports),i.exports}var n=Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}).register=function(e,t){E[e]=t},C.parcelRequire94c2=I);var A=I.register;function T(e,t,i,n,r,a,s){try{var o=e[a](s),l=o.value}catch(e){i(e);return}o.done?t(l):Promise.resolve(l).then(n,r)}function M(e){return function(){var t=this,i=arguments;return new Promise(function(n,r){var a=e.apply(t,i);function s(e){T(a,n,r,s,o,"next",e)}function o(e){T(a,n,r,s,o,"throw",e)}s(void 0)})}}A("8KHnw",function(t,i){function n(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}e(t.exports,"_type_of",function(){return n}),e(t.exports,"_",function(){return n})}),A("cx0mh",function(t,i){e(t.exports,"_",function(){return n});function n(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}}),A("7h4XF",function(t,i){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}e(t.exports,"_",function(){return r})}),A("eRyuE",function(e,t){e.exports=I("ih7W4")(I("2evKT").resolve("5RGAp")).then(function(){return I("fz5vW")})}),A("ih7W4",function(e,t){var i=I("5Y6Bl");e.exports=i(function(e){return new Promise(function(t,i){if([].concat(document.getElementsByTagName("script")).some(function(t){return t.src===e})){t();return}var n=document.createElement("link");n.href=e,n.rel="preload",n.as="script",document.head.appendChild(n);var r=document.createElement("script");r.async=!0,r.type="text/javascript",r.src=e,r.onerror=function(t){var n=TypeError("Failed to fetch dynamically imported module: ".concat(e,". Error: ").concat(t.message));r.onerror=r.onload=null,r.remove(),i(n)},r.onload=function(){r.onerror=r.onload=null,t()},document.getElementsByTagName("head")[0].appendChild(r)})})}),A("5Y6Bl",function(e,t){var i={},n={},r={};e.exports=function(e,t){return function(a){var s=function(e){switch(e){case"preload":return n;case"prefetch":return r;default:return i}}(t);return s[a]?s[a]:s[a]=e.apply(null,arguments).catch(function(e){throw delete s[a],e})}}}),A("6swkM",function(e,t){e.exports=I("ih7W4")(I("2evKT").resolve("2bKIP")).then(function(){return I("iGIhP")})}),A("bMRjr",function(e,t){e.exports=I("ih7W4")(I("2evKT").resolve("y5edP")).then(function(){return I("7ZPTi")})}),A("6AvxN",function(e,t){e.exports=I("ih7W4")(I("2evKT").resolve("cW2nR")).then(function(){return I("aeHic")})}),A("lSwOy",function(e,t){e.exports=I("ih7W4")(I("2evKT").resolve("kcBSP")).then(function(){return I("6vhv2")})}),A("hKOuy",function(e,t){e.exports=I("ih7W4")(I("2evKT").resolve("dsJ3g")).then(function(){return I("blNy6")})}),A("d3Z79",function(e,t){e.exports=I("ih7W4")(I("2evKT").resolve("lF1Tu")).then(function(){return I("iRLcJ")})}),A("dJPtW",function(t,i){e(t.exports,"Input",function(){return s}),e(t.exports,"input",function(){return o});var n=I("cx0mh"),r=I("7h4XF"),a=I("eWjiX"),s=function(){function e(t){var i,r,s=this;(0,n._)(this,e),this.keyListener={destroy:function(){}},this.rootEl=(0,a.BB).el({tagName:"label",content:t.label,css:{display:"flex",alignItems:"center",gap:"5px"}}),this.input=(0,a.BB).el({tagName:"input",parent:this.rootEl,title:t.title}),this.input.type,this.type=null!==(i=t.type)&&void 0!==i?i:"text";try{this.input.type=this.type}catch(e){}var o=null!==(r=t.step)&&void 0!==r?r:1;"number"===this.type&&(void 0!==t.min&&(this.input.min=""+t.min),void 0!==t.max&&(this.input.max=""+t.max),void 0!==t.step&&(this.input.step=""+o)),this.input.value=""+t.init;var l=this.input.value,h=function(){var e=l,i=s.input.value;if(t.doResetIfInvalid){var n=!1;""===i&&(i=l,n=!0),void 0!==t.min&&parseFloat(i)<t.min&&(i=""+t.min,n=!0),void 0!==t.max&&parseFloat(i)>t.max&&(i=""+t.max,n=!0),n&&(s.input.value=""+i)}return l=i,e!==i};if(t.onChange){var c=t.onChange;this.input.onchange=function(){h()&&c(s.input.value)}}if(t.css&&(0,a.BB).css(this.input,t.css),t.doScrollWithoutFocus&&"number"===t.type&&t.onChange){var u=t.onChange;this.keyListener=new a.BB.KeyListener({}),this.pointerListener=new a.BB.PointerListener({target:this.input,onWheel:function(e){var t=s.keyListener.isPressed("shift")?4:1;s.input.value=""+(parseFloat(s.input.value)-e.deltaY*o*t),h()&&u(s.input.value)}})}}return(0,r._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.input.value}},{key:"setValue",value:function(e){this.input.value=""+e}},{key:"destroy",value:function(){this.pointerListener&&this.pointerListener.destroy(),this.keyListener.destroy()}}]),e}(),o=function(e){var t=document.createElement("input");if(e.type)try{t.type=e.type}catch(e){}else t.type="text";return void 0!==e.min&&(t.min=""+e.min),void 0!==e.max&&(t.max=""+e.max),t.value=""+e.init,e.callback&&(t.onchange=function(){e.callback(t.value)}),e.css&&(0,a.BB).css(t,e.css),t}}),A("eWjiX",function(t,i){e(t.exports,"BB",function(){return k});var n=I("7jh4K"),r=I("6J2My"),a=I("idV3L"),s=I("04lDo"),o=I("eIcQa"),l=I("kVHNC"),h=I("4toIY"),c=I("af1iA"),u=I("dJ1E2"),p=I("72Jv0"),d=I("eg83P"),g=I("eelgW"),f=I("i0uIf"),v=I("6l0gQ"),m=I("jjWRi"),y=I("2pgVs"),x=I("joplQ"),b=I("c1lmK"),B=I("635F6"),w=I("gCzYB"),k={eventUsesHighResTimeStamp:r.eventUsesHighResTimeStamp,hasPointerEvents:r.hasPointerEvents,isCssMinMaxSupported:r.isCssMinMaxSupported,canShareFiles:r.canShareFiles,unsetEventHandler:r.unsetEventHandler,insertAfter:n.insertAfter,loadImage:n.loadImage,css:n.css,setAttributes:n.setAttributes,append:n.append,fitInto:n.fitInto,centerWithin:n.centerWithin,getDate:n.getDate,gcd:n.gcd,reduce:n.reduce,decToFraction:n.decToFraction,imageBlobToUrl:n.imageBlobToUrl,dateDayDifference:n.dateDayDifference,copyObj:n.copyObj,shareCanvas:n.shareCanvas,handleClick:n.handleClick,createSvg:n.createSvg,BbLog:f.BbLog,LocalStorage:v.LocalStorage,throwIfNull:n.throwIfNull,nullToUndefined:n.nullToUndefined,isDark:n.isDark,mix:d.mix,dist:d.dist,distSquared:d.distSquared,lenSquared:d.lenSquared,pointsToAngleRad:d.pointsToAngleRad,pointsToAngleDeg:d.pointsToAngleDeg,isInsideRect:d.isInsideRect,clamp:d.clamp,rotate:d.rotate,rotateAround:d.rotateAround,Matrix:l.Matrix,Vec2:h.Vec2,intDxy:d.intDxy,roundEven:d.roundEven,roundUneven:d.roundUneven,round:d.round,updateBounds:d.updateBounds,boundsInArea:d.boundsInArea,projectPointOnLine:c.projectPointOnLine,PointLine:c.PointLine,BezierLine:c.BezierLine,SplineInterpolator:c.SplineInterpolator,quadraticSplineInput:c.quadraticSplineInput,canvas:g.createCanvas,ctx:o.ctx,copyCanvas:o.copyCanvas,testShouldPixelate:o.testShouldPixelate,drawTransformedImageWithBounds:o.drawTransformedImageWithBounds,drawTransformedImageOnCanvas:o.drawTransformedImageOnCanvas,createCheckerCanvas:o.createCheckerCanvas,createCheckerDataUrl:o.createCheckerDataUrl,resizeCanvas:o.resizeCanvas,convertToAlphaChannelCanvas:o.convertToAlphaChannelCanvas,freeCanvas:o.freeCanvas,canvasBounds:o.canvasBounds,HSV:u.HSV,RGB:u.RGB,CMYK:u.CMYK,ColorConverter:u.ColorConverter,testIsWhiteBestContrast:u.testIsWhiteBestContrast,appendTextDiv:p.appendTextDiv,clearSelection:p.clearSelection,makeUnfocusable:p.makeUnfocusable,el:p.el,destroyEl:p.destroyEl,isInputFocused:p.isInputFocused,unfocusAnyInput:p.unfocusAnyInput,KeyListener:a.KeyListener,PointerListener:s.PointerListener,sameKeys:a.sameKeys,EventChain:w.EventChain,DoubleTapper:b.DoubleTapper,NFingerTapper:y.NFingerTapper,PinchZoomer:x.PinchZoomer,CoalescedExploder:m.CoalescedExploder,OnePointerLimiter:B.OnePointerLimiter};Object.keys(k)}),A("7jh4K",function(t,i){e(t.exports,"insertAfter",function(){return r}),e(t.exports,"loadImage",function(){return a}),e(t.exports,"css",function(){return s}),e(t.exports,"setAttributes",function(){return o}),e(t.exports,"append",function(){return l}),e(t.exports,"fitInto",function(){return h}),e(t.exports,"centerWithin",function(){return c}),e(t.exports,"getDate",function(){return u}),e(t.exports,"gcd",function(){return p}),e(t.exports,"reduce",function(){return d}),e(t.exports,"decToFraction",function(){return g}),e(t.exports,"imageBlobToUrl",function(){return f}),e(t.exports,"dateDayDifference",function(){return v}),e(t.exports,"copyObj",function(){return m}),e(t.exports,"shareCanvas",function(){return y}),e(t.exports,"handleClick",function(){return x}),e(t.exports,"createSvg",function(){return function e(t){var i=document.createElementNS("http://www.w3.org/2000/svg",t.elementType);return Object.entries(t).forEach(function(t){var r=(0,n._)(t,2),a=r[0],s=r[1];"childrenArr"===a?s.forEach(function(t){i.append(e(t))}):"elementType"!==a&&i.setAttribute(a,s)}),i}}),e(t.exports,"throwIfNull",function(){return b}),e(t.exports,"throwIfUndefined",function(){return B}),e(t.exports,"nullToUndefined",function(){return w}),e(t.exports,"isDark",function(){return C}),e(t.exports,"addIsDarkListener",function(){return S});var n=I("8N5YG");function r(e,t){e.parentNode&&e.parentNode.insertBefore(t,e.nextSibling)}function a(e,t){var i=0;!function n(){if(1e3===i){alert("couldn't load");return}e.complete?(i++,t()):setTimeout(n,1)}()}function s(e,t){for(var i,n=Object.keys(t),r=e.style,a=0;a<n.length;a++)r[i=n[a]]=t[i],"userSelect"===i&&(r.webkitUserSelect=t[i])}function o(e,t){for(var i,n=Object.keys(t),r=0;r<n.length;r++)i=n[r],e.setAttribute(i,t[i])}function l(e,t){var i=document.createDocumentFragment();t.forEach(function(e){return e&&i.append(e)}),e.append(i)}function h(e,t,i,n,r){var a=e*i,s=t*i;return a>i&&(s=i/a*s,a=i),s>n&&(a=n/s*a,s=n),r&&(a=Math.max(r,a),s=Math.max(r,s)),{width:a,height:s}}function c(e,t,i,n){return{x:e/2-i/2,y:t/2-n/2}}function u(){var e=new Date;return e.getFullYear()+"_"+(e.getMonth()+1).toString().padStart(2,"0")+"_"+e.getDate().toString().padStart(2,"0")+"_"+(60*e.getHours()+e.getMinutes()).toString(36).padStart(3,"0")+"_"}function p(e,t){return t?p(t,e%t):e}function d(e,t){var i=p(e,t);return[e/i,t/i]}function g(e){var t=Math.pow(10,e.toString().length-2);return d(e*t,t)}function f(e){if(!e)throw Error("blobObj is undefined or null");if(window.Blob&&e instanceof Blob)return URL.createObjectURL(e);if("Object"===e.constructor.name)return"data:"+e.type+";"+e.encoding+","+e.data;throw Error("unknown blob format")}function v(e,t){return e=new Date(e),t=new Date(t),e.setHours(0,0,0,0),t.setHours(0,0,0,0),(t.getTime()-e.getTime())/864e5}function m(e){return JSON.parse(JSON.stringify(e))}function y(e){var t="image/png",i=function(){return alert("sharing not supported")};e.canvas.toBlob(function(n){if(!n){i(),e.callback();return}try{var r=[new File([n],e.fileName,{type:t})];navigator.share({title:e.title,files:r}).then(function(){}).catch(function(){i()})}catch(e){i()}e.callback()},t)}function x(e){var t=e.target;return!!t&&(!!["A","LABEL","INPUT","SUMMARY"].includes(t.tagName)||!!t.allowClick||(e.preventDefault(),!1))}function b(e){if(null===e)throw Error("value is null");return e}function B(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"value is undefined";if(void 0===e)throw Error(t);return e}function w(e){return null===e?void 0:e}var k="matchMedia"in window&&window.matchMedia("(prefers-color-scheme: dark)");function C(){return k&&k.matches}function S(e){k&&"addEventListener"in k&&k.addEventListener("change",e)}}),A("8N5YG",function(t,i){e(t.exports,"_",function(){return o});var n=I("vDBh4"),r=I("lMMat"),a=I("keO5I"),s=I("kWe4k");function o(e,t){return(0,n._array_with_holes)(e)||(0,r._iterable_to_array_limit)(e,t)||(0,s._unsupported_iterable_to_array)(e,t)||(0,a._non_iterable_rest)()}}),A("vDBh4",function(t,i){e(t.exports,"_array_with_holes",function(){return n});function n(e){if(Array.isArray(e))return e}}),A("lMMat",function(t,i){e(t.exports,"_iterable_to_array_limit",function(){return n});function n(e,t){var i,n,r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var a=[],s=!0,o=!1;try{for(r=r.call(e);!(s=(i=r.next()).done)&&(a.push(i.value),!t||a.length!==t);s=!0);}catch(e){o=!0,n=e}finally{try{s||null==r.return||r.return()}finally{if(o)throw n}}return a}}}),A("keO5I",function(t,i){e(t.exports,"_non_iterable_rest",function(){return n});function n(){throw TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}}),A("kWe4k",function(t,i){e(t.exports,"_unsupported_iterable_to_array",function(){return r});var n=I("gszWS");function r(e,t){if(e){if("string"==typeof e)return(0,n._array_like_to_array)(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if("Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i)return Array.from(i);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return(0,n._array_like_to_array)(e,t)}}}),A("gszWS",function(t,i){e(t.exports,"_array_like_to_array",function(){return n});function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=Array(t);i<t;i++)n[i]=e[i];return n}}),A("6J2My",function(t,i){e(t.exports,"isFirefox",function(){return r}),e(t.exports,"eventUsesHighResTimeStamp",function(){return a}),e(t.exports,"hasPointerEvents",function(){return s}),e(t.exports,"isCssMinMaxSupported",function(){return o}),e(t.exports,"canShareFiles",function(){return l}),e(t.exports,"unsetEventHandler",function(){return h});var n,r=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,a=(n=new Event("").timeStamp<36e5,function(){return n}),s=!!window.PointerEvent,o=function(){var e;function t(){var t=document.createElement("div");t.style.position="absolute",t.style.top="0",t.style.left="max(0px, 25px)",document.body.append(t),setTimeout(function(){e=25===t.offsetLeft,t.remove()},25)}return document.body?t():window.addEventListener("DOMContentLoaded",function(){t()}),function(){if(void 0===e)throw Error("isCssMinMaxSupported not initialized");return e}}(),l=function(){return"share"in navigator&&"canShare"in navigator};function h(e){for(var t=arguments.length,i=Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];i.forEach(function(t){e[t]=null})}}),A("idV3L",function(t,i){e(t.exports,"KeyListener",function(){return b}),e(t.exports,"sameKeys",function(){return B});var n,r,a,s,o,l,h,c,u,p,d,g,f,v=I("cx0mh"),m=I("7h4XF"),y=I("8N5YG"),x=(n=function(e){var t=e.key,i=e.code;if(t in h){var n=h[t];if(l[n]){d(n,e,c.join("+"),!0);return}l[n]=!0,u[i]=n,c.push(n),d(n,e,c.join("+"))}},r=function(e){var t=e.code,i=c.join("+");if(["Meta","MetaLeft","MetaRight","OSLeft","OSRight"].includes(t)){a();return}var n=u[t];if(void 0!==n){l[n]=!1,u[t]=void 0;for(var r=0;r<c.length;r++)c[r]==n&&(c.splice(r,1),r--);g(n,e,i)}},a=function(){var e=c.join("+");c=[],u={};var t=[];o.forEach(function(e){l[e]&&(l[e]=!1,t.push(e))});for(var i=0;i<t.length;i++)g(t[i],{preventDefault:function(){},stopPropagation:function(){}},e);f()},o=Object.keys(s={space:[" ","Spacebar"],alt:["Alt","AltGraph"],shift:"Shift",ctrl:"Control",cmd:["Meta","MetaLeft","MetaRight"],enter:"Enter",esc:"Escape",backspace:"Backspace",delete:"Delete",sqbr_open:"[",sqbr_close:"]",a:["a","A"],b:["b","B"],c:["c","C"],e:["e","E"],f:["f","F"],g:["g","G"],r:["r","R"],s:["s","S"],t:["t","T"],u:["u","U"],x:["x","X"],y:["y","Y"],z:["z","Z"],plus:"+",minus:"-",left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown",home:"Home",end:"End"}),l=Object.entries(s).reduce(function(e,t){return e[(0,y._)(t,1)[0]]=!1,e},{}),h=Object.entries(s).reduce(function(e,t){var i=(0,y._)(t,2),n=i[0],r=i[1];return"string"==typeof r?e[r]=n:r.forEach(function(t){e[t]=n}),e},{}),c=[],u={},p=[],d=function(e,t,i,n){p.forEach(function(r){r[0]&&r[0](e,t,i,n)})},g=function(e,t,i){p.forEach(function(n){n[1]&&n[1](e,t,i)})},f=function(){p.forEach(function(e){e[2]&&e[2]()})},{add:function(e){if(!p.includes(e)){var t=0===p.length;p.push(e),t&&(document.addEventListener("keydown",n),document.addEventListener("keyup",r),window.addEventListener("blur",a))}},remove:function(e){if(p.includes(e)){for(var t=1===p.length,i=0;i<p.length;i++)if(p[i]===e){p.splice(i,1);break}t&&(document.removeEventListener("keydown",n),document.removeEventListener("keyup",r),window.removeEventListener("blur",a))}},getIsDown:function(){return l},getCombo:function(){return c}}),b=function(){function e(t){(0,v._)(this,e),this.onDown=t.onDown,this.onUp=t.onUp,this.onBlur=t.onBlur,this.ref=[this.onDown,this.onUp,this.onBlur],x.add(this.ref)}return(0,m._)(e,[{key:"isPressed",value:function(e){if(!(e in x.getIsDown()))throw'key "'+e+'" not found';return x.getIsDown()[e]}},{key:"getComboStr",value:function(){return x.getCombo().join("+")}},{key:"comboOnlyContains",value:function(e){for(var t=0;t<x.getCombo().length;t++)if(!e.includes(x.getCombo()[t]))return!1;return!0}},{key:"destroy",value:function(){x.remove(this.ref)}}]),e}();function B(e,t){return e.split("+").sort().join("+")===t.split("+").sort().join("+")}}),A("04lDo",function(t,i){e(t.exports,"PointerListener",function(){return B});var n=I("cx0mh"),r=I("7h4XF"),a=I("cL71g"),s=I("4EWN2"),o=I("6J2My"),l=I("93oLo"),h=I("eIAon"),c=[];function u(e){switch(e){case 1:return"left";case 2:return"right";case 4:return"middle";default:return}}var p=new h.PressureNormalizer,d=(0,o.eventUsesHighResTimeStamp)()?0:-performance.timing.navigationStart,g=o.hasPointerEvents?"pointerdown":"mousedown",f=o.hasPointerEvents?"pointermove":"mousemove",v=o.hasPointerEvents?"pointerup":"mouseup",m=o.hasPointerEvents?"pointercancel":"mousecancel",y=o.hasPointerEvents?"pointerleave":"mouseleave",x=o.hasPointerEvents?"pointerenter":"mouseenter";function b(e){if("corrected"in e)return e.corrected;var t,i={pointerId:e.pointerId,pointerType:e.pointerType,pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY,movementX:e.movementX,movementY:e.movementY,timeStamp:e.timeStamp+d,pressure:p.normalize(e.pressure),buttons:void 0!==e.buttons?e.buttons:void 0!==e.button?[1,4,2,8,16][e.button]:0,button:e.button,coalescedArr:[],eventPreventDefault:function(){return e.preventDefault()},eventStopPropagation:function(){return e.stopPropagation()}};e.corrected=i;var n=null;"pointerId"in e?"pressure"in e&&0!==e.buttons&&(["mouse"].includes(e.pointerType)||"touch"===e.pointerType&&0===e.pressure)&&(i.pressure=1,n=1):(i.pointerId=0,i.pointerType="mouse",i.pressure=0!==e.buttons?1:0,n=i.pressure),o.isFirefox&&"mouse"!=e.pointerType&&"pointermove"===e.type&&0===e.buttons&&(i.buttons=1);var r=[];"getCoalescedEvents"in e&&(r=e.getCoalescedEvents());for(var a=function(e){for(var t=c.length-1;t>=0;t--)if(e.pointerId===c[t].pointerId)return c[t];return null}(i)||(t={pointerId:i.pointerId,lastPageX:null,lastPageY:null},c.push(t),c.length>15&&c.shift(),t),s=a.lastPageX,l=a.lastPageY,h=0;h<r.length;h++){var u=r[h];i.coalescedArr.push({pageX:u.pageX,pageY:u.pageY,clientX:u.clientX,clientY:u.clientY,movementX:null===a.lastPageX?0:u.pageX-a.lastPageX,movementY:null===a.lastPageY?0:u.pageY-a.lastPageY,timeStamp:0===u.timeStamp?i.timeStamp:u.timeStamp+d,pressure:null===n?p.normalize(u.pressure):n}),a.lastPageX=u.pageX,a.lastPageY=u.pageY}return a.lastPageX=i.pageX,a.lastPageY=i.pageY,i.movementX=null===s?0:a.lastPageX-s,i.movementY=null===l?0:a.lastPageY-l,i}var B=function(){function e(t){var i=this;if((0,n._)(this,e),this.isDestroyed=!1,this.isOverCounter=0,this.dragObjArr=[],this.dragPointerIdArr=[],this.lastPointerType=null,this.didSkip=!1,this.targetElement=t.target,this.onPointerCallback=t.onPointer,this.onWheelCallback=t.onWheel,this.onEnterLeaveCallback=t.onEnterLeave,this.maxPointers=Math.max(1,t.maxPointers||1),this.wheelCleaner=new l.WheelCleaner(function(e){if(!i.isDestroyed&&i.onWheelCallback){var t=i.targetElement.getBoundingClientRect(),n=(0,s._)((0,a._)({},e),{relX:e.clientX-t.left+i.targetElement.scrollLeft,relY:e.clientY-t.top+i.targetElement.scrollTop});i.onWheelCallback(n)}}),this.onPointerCallback&&(this.onPointerMove=function(e){var t=b(e),n=i.lastPointerType;if(i.lastPointerType=t.pointerType,i.dragPointerIdArr.includes(t.pointerId)||i.dragPointerIdArr.length===i.maxPointers||"touch"===t.pointerType){i.didSkip=!1;return}if(!i.didSkip&&"mouse"===t.pointerType&&"pen"===n){i.didSkip=!0;return}i.didSkip=!1;var r=i.createPointerOutEvent("pointermove",t);i.onPointerCallback&&i.onPointerCallback(r)},this.onPointerDown=function(e,t){var n=b(e);if(!i.dragPointerIdArr.includes(n.pointerId)&&i.dragPointerIdArr.length!==i.maxPointers&&[1,2,4].includes(n.buttons)){0!==i.dragObjArr.length||t||i.setupDocumentListeners();var r={pointerId:n.pointerId,pointerType:n.pointerType,downPageX:n.pageX,downPageY:n.pageY,buttons:n.buttons,lastPageX:n.pageX,lastPageY:n.pageY,lastTimeStamp:n.timeStamp};i.dragObjArr.push(r),i.dragPointerIdArr.push(n.pointerId);var a=i.createPointerOutEvent("pointerdown",n,{downPageX:n.pageX,downPageY:n.pageY,button:u(n.buttons),pressure:n.pressure});i.onPointerCallback&&i.onPointerCallback(a)}},this.windowOnPointerMove=function(e){var t=b(e);if(i.dragPointerIdArr.includes(t.pointerId)){var n=i.getDragObj(t.pointerId);if(n){if(t.buttons!==n.buttons){1===i.dragObjArr.length&&i.destroyDocumentListeners(),i.removeDragObj(t.pointerId);var r=i.createPointerOutEvent("pointerup",t,{downPageX:n.downPageX,downPageY:n.downPageY});i.onPointerCallback&&i.onPointerCallback(r);return}if("pen"!==t.pointerType||t.pageX!==n.lastPageX||t.pageY!==n.lastPageY||t.timeStamp!==n.lastTimeStamp){var a=i.createPointerOutEvent("pointermove",t,{downPageX:n.downPageX,downPageY:n.downPageY,button:u(t.buttons),pressure:t.pressure});n.lastPageX=t.pageX,n.lastPageY=t.pageY,n.lastTimeStamp=t.timeStamp,i.onPointerCallback&&i.onPointerCallback(a)}}}},this.windowOnPointerUp=function(e){var t=b(e);if(i.dragPointerIdArr.includes(t.pointerId)){1===i.dragObjArr.length&&i.destroyDocumentListeners();var n=i.removeDragObj(t.pointerId);if(n){var r=i.createPointerOutEvent("pointerup",t,{downPageX:n.downPageX,downPageY:n.downPageY});i.onPointerCallback&&i.onPointerCallback(r)}}},this.windowOnPointerLeave=function(e){var t=b(e);if(i.dragPointerIdArr.includes(t.pointerId)){1===i.dragObjArr.length&&i.destroyDocumentListeners();var n=i.removeDragObj(t.pointerId);if(n){var r=i.createPointerOutEvent("pointerup",t,{downPageX:n.downPageX,downPageY:n.downPageY});i.onPointerCallback&&i.onPointerCallback(r)}}},this.targetElement.addEventListener(f,this.onPointerMove),this.targetElement.addEventListener(g,this.onPointerDown),!o.hasPointerEvents)){var r=function(e,t,i){return{pointerId:e.identifier,pointerType:"touch",pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY,button:i?0:void 0,buttons:i?1:0,timeStamp:t.timeStamp,target:t.target,pressure:i?1:0,preventDefault:function(){return t.preventDefault()},stopPropagation:function(){return t.stopPropagation()}}},h=function(e,t){for(var n=0;n<e.changedTouches.length;n++){var a=r(e.changedTouches[n],e,["start","move"].includes(t));"start"===t?i.onPointerDown(a,!1):"move"===t?i.windowOnPointerMove(a):"end"===t?i.windowOnPointerUp(a):i.windowOnPointerLeave(a)}};this.onTouchStart=function(e){e.preventDefault(),h(e,"start")},this.onTouchMove=function(e){h(e,"move")},this.onTouchEnd=function(e){h(e,"end")},this.onTouchCancel=function(e){h(e,"cancel")},this.targetElement.addEventListener("touchstart",this.onTouchStart),this.targetElement.addEventListener("touchmove",this.onTouchMove),this.targetElement.addEventListener("touchend",this.onTouchEnd),this.targetElement.addEventListener("touchcancel",this.onTouchCancel)}this.onWheelCallback&&(this.onWheel=function(e){i.wheelCleaner.process(e)},this.targetElement.addEventListener("wheel",this.onWheel)),this.onEnterLeaveCallback&&(this.onPointerEnter=function(){i.isOverCounter++,i.onEnterLeaveCallback&&i.onEnterLeaveCallback(!0)},this.onPointerLeave=function(){i.isOverCounter--,i.onEnterLeaveCallback&&i.onEnterLeaveCallback(!1)},this.targetElement.addEventListener(x,this.onPointerEnter),this.targetElement.addEventListener(y,this.onPointerLeave)),t.fixScribble&&(this.onTouchMoveScribbleFix=function(e){return e.preventDefault()},this.targetElement.addEventListener("touchmove",this.onTouchMoveScribbleFix))}return(0,r._)(e,[{key:"getDragObj",value:function(e){for(var t=0;t<this.dragObjArr.length;t++)if(e===this.dragObjArr[t].pointerId)return this.dragObjArr[t];return null}},{key:"removeDragObj",value:function(e){for(var t=null,i=0;i<this.dragPointerIdArr.length;i++)this.dragPointerIdArr[i]===e&&(t=this.dragObjArr[i],this.dragObjArr.splice(i,1),this.dragPointerIdArr.splice(i,1),i--);return t}},{key:"createPointerOutEvent",value:function(e,t,i){var n,r=this.targetElement.getBoundingClientRect(),s=(0,a._)({type:e,pointerId:t.pointerId,pointerType:t.pointerType,pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY,relX:t.clientX-r.left+this.targetElement.scrollLeft,relY:t.clientY-r.top+this.targetElement.scrollTop,dX:t.movementX,dY:t.movementY,time:t.timeStamp,eventPreventDefault:t.eventPreventDefault,eventStopPropagation:t.eventStopPropagation},i);if("pointermove"===e&&(s.coalescedArr=[],t.coalescedArr.length>1))for(var o=0;o<t.coalescedArr.length;o++)n=t.coalescedArr[o],s.coalescedArr.push({pageX:n.pageX,pageY:n.pageY,clientX:n.clientX,clientY:n.clientY,relX:n.clientX-r.left+this.targetElement.scrollLeft,relY:n.clientY-r.top+this.targetElement.scrollTop,dX:n.movementX,dY:n.movementY,time:n.timeStamp});return s}},{key:"setupDocumentListeners",value:function(){this.windowOnPointerMove&&document.addEventListener(f,this.windowOnPointerMove),this.windowOnPointerUp&&document.addEventListener(v,this.windowOnPointerUp),this.windowOnPointerLeave&&document.addEventListener(m,this.windowOnPointerLeave),this.windowOnPointerLeave&&document.addEventListener(y,this.windowOnPointerLeave)}},{key:"destroyDocumentListeners",value:function(){this.windowOnPointerMove&&document.removeEventListener(f,this.windowOnPointerMove),this.windowOnPointerUp&&document.removeEventListener(v,this.windowOnPointerUp),this.windowOnPointerLeave&&document.removeEventListener(m,this.windowOnPointerLeave),this.windowOnPointerLeave&&document.removeEventListener(y,this.windowOnPointerLeave)}},{key:"destroy",value:function(){!this.isDestroyed&&(this.isDestroyed=!0,this.onPointerEnter&&this.targetElement.removeEventListener(x,this.onPointerEnter),this.onPointerLeave&&this.targetElement.removeEventListener(y,this.onPointerLeave),this.onPointerMove&&this.targetElement.removeEventListener(f,this.onPointerMove),this.onPointerDown&&this.targetElement.removeEventListener(g,this.onPointerDown),this.onWheel&&this.targetElement.removeEventListener("wheel",this.onWheel),this.destroyDocumentListeners(),this.onTouchMoveScribbleFix&&document.removeEventListener("touchmove",this.onTouchMoveScribbleFix),this.onTouchStart&&this.targetElement.removeEventListener("touchstart",this.onTouchStart),this.onTouchMove&&this.targetElement.removeEventListener("touchmove",this.onTouchMove),this.onTouchEnd&&this.targetElement.removeEventListener("touchend",this.onTouchEnd),this.onTouchCancel&&this.targetElement.removeEventListener("touchcancel",this.onTouchCancel))}}]),e}()}),A("cL71g",function(t,i){e(t.exports,"_",function(){return r});var n=I("exh8t");function r(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},r=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(i).filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable}))),r.forEach(function(t){(0,n._define_property)(e,t,i[t])})}return e}}),A("exh8t",function(t,i){function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}e(t.exports,"_define_property",function(){return n}),e(t.exports,"_",function(){return n})}),A("4EWN2",function(t,i){e(t.exports,"_",function(){return n});function n(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):(function(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);i.push.apply(i,n)}return i})(Object(t)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(t,i))}),e}}),A("93oLo",function(t,i){e(t.exports,"WheelCleaner",function(){return a});var n=I("cx0mh"),r=I("7h4XF"),a=function(){function e(t){(0,n._)(this,e),this.callback=t,this.knownUnitArr=[100],this.sequenceLength=0,this.sequenceUnit=null,this.toEmitDelta=null,this.position=null}return(0,r._)(e,[{key:"emit",value:function(e){null!==this.position&&null!==this.sequenceUnit&&this.callback({deltaY:Math.round(e/this.sequenceUnit),pageX:this.position.pageX,pageY:this.position.pageY,clientX:this.position.clientX,clientY:this.position.clientY})}},{key:"endSequence",value:function(){null!==this.toEmitDelta&&(this.emit(this.toEmitDelta),this.toEmitDelta=null),null===this.sequenceUnit||this.knownUnitArr.includes(this.sequenceUnit)||this.knownUnitArr.push(this.sequenceUnit),this.sequenceLength=0,this.sequenceUnit=null}},{key:"process",value:function(e){var t=this;this.position={pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY},this.endSequenceTimeout&&clearTimeout(this.endSequenceTimeout),this.endSequenceTimeout=setTimeout(function(){return t.endSequence()},200);var i=e.deltaY;"deltaMode"in e&&1===e.deltaMode&&(i*=100/3);var n=Math.abs(i);if(0===this.sequenceLength){if(this.sequenceLength++,n<50)return;this.sequenceUnit=n,this.knownUnitArr.includes(this.sequenceUnit)?this.emit(i):this.toEmitDelta=i;return}if(null===this.sequenceUnit){this.toEmitDelta=null;return}if(0!==n){if(n===this.sequenceUnit||n/this.sequenceUnit%1<1e-4);else if(this.sequenceUnit/n%1<1e-4)this.sequenceUnit=n;else if(n!==this.sequenceUnit){this.sequenceUnit=null,this.toEmitDelta=null;return}null!==this.toEmitDelta&&(this.emit(this.toEmitDelta),this.toEmitDelta=null),this.emit(i)}}}]),e}()}),A("eIAon",function(t,i){e(t.exports,"PressureNormalizer",function(){return s});var n=I("cx0mh"),r=I("7h4XF"),a=I("eg83P"),s=function(){function e(){(0,n._)(this,e),this.count=0,this.avgPressure=0,this.normalizeIsComplete=!1,this.normalizeFactor=1}return(0,r._)(e,[{key:"normalize",value:function(e){return 0===e||1===e?e:(this.count<60?(0===this.count||null===this.count?this.avgPressure=e:this.avgPressure=(0,a.mix)(e,this.avgPressure,.95),this.count++):!this.normalizeIsComplete&&(this.normalizeIsComplete=!0,this.avgPressure<.13&&(this.normalizeFactor=2.3)),Math.pow(e,1/this.normalizeFactor))}}]),e}()}),A("eg83P",function(t,i){function n(e,t,i){return e*(1-i)+t*i}function r(e,t,i,n){return Math.sqrt(Math.pow(e-i,2)+Math.pow(t-n,2))}function a(e,t,i,n){return Math.pow(e-i,2)+Math.pow(t-n,2)}function s(e,t){return e*e+t*t}function o(e,t){return Math.atan2(t.y-e.y,t.x-e.x)}function l(e,t){return 180*o(e,t)/Math.PI}function h(e,t){return t.x<=e.x&&e.x<=t.x+t.width&&t.y<=e.y&&e.y<=t.y+t.height}function c(e,t,i){return e<t?t:e>i?i:e}function u(e,t,i){var n=Math.PI/180*i,r=Math.cos(n),a=Math.sin(n);return{x:e*r-t*a,y:e*a+t*r}}function p(e,t,i){var n=u(t.x-e.x,t.y-e.y,i);return n.x+=e.x,n.y+=e.y,n}function d(e,t,i){e.x+=t,e.y+=i;var n=Math.round(e.x),r=Math.round(e.y);return e.x-=n,e.y-=r,{dX:n,dY:r}}function g(e){if(e%1==0)return e%2==0?e:e+1;var t=Math.ceil(e),i=Math.floor(e);return t%2==0?t:i}function f(e){if(e%1==0)return e%2==0?e+1:e;var t=Math.ceil(e),i=Math.floor(e);return t%2==1?t:i}function v(e,t){var i=Math.pow(10,t);return Math.round(e*i)/i}function m(e,t){if(!t&&!e)throw Error("at least one param needs to be defined");return t&&(e?(e.x1=Math.min(e.x1,t.x1),e.y1=Math.min(e.y1,t.y1),e.x2=Math.max(e.x2,t.x2),e.y2=Math.max(e.y2,t.y2)):e={x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2}),e}function y(e,t,i){if(e){var n=Math.max(0,e.x1),r=Math.max(0,e.y1),a=Math.min(t-1,e.x2),s=Math.min(i-1,e.y2);if(!(n>a)&&!(r>s))return{x1:n,y1:r,x2:a,y2:s}}}e(t.exports,"mix",function(){return n}),e(t.exports,"dist",function(){return r}),e(t.exports,"distSquared",function(){return a}),e(t.exports,"lenSquared",function(){return s}),e(t.exports,"pointsToAngleRad",function(){return o}),e(t.exports,"pointsToAngleDeg",function(){return l}),e(t.exports,"isInsideRect",function(){return h}),e(t.exports,"clamp",function(){return c}),e(t.exports,"rotate",function(){return u}),e(t.exports,"rotateAround",function(){return p}),e(t.exports,"intDxy",function(){return d}),e(t.exports,"roundEven",function(){return g}),e(t.exports,"roundUneven",function(){return f}),e(t.exports,"round",function(){return v}),e(t.exports,"updateBounds",function(){return m}),e(t.exports,"boundsInArea",function(){return y})}),A("eIcQa",function(t,i){e(t.exports,"copyCanvas",function(){return s}),e(t.exports,"ctx",function(){return o}),e(t.exports,"testShouldPixelate",function(){return l}),e(t.exports,"drawTransformedImageWithBounds",function(){return h}),e(t.exports,"drawTransformedImageOnCanvas",function(){return c}),e(t.exports,"createCheckerCanvas",function(){return u}),e(t.exports,"createCheckerDataUrl",function(){return p}),e(t.exports,"resizeCanvas",function(){return function e(t,i,n,a,s){if(i&&n&&(i!==t.width||n!==t.height)){if(i=Math.max(i,1),n=Math.max(n,1),i<=t.width&&n<=t.height){a=a||(0,r.createCanvas)(),s=s||(0,r.createCanvas)();var o,l,h,c=((o={oldWidthEx:Math.round(Math.log2(t.width)),oldHeightEx:Math.round(Math.log2(t.height)),newWidthEx:Math.ceil(Math.log2(i)),newHeightEx:Math.ceil(Math.log2(n))}).oldWidthEx=Math.max(o.oldWidthEx,o.newWidthEx),o.oldHeightEx=Math.max(o.oldHeightEx,o.newHeightEx),o);s.width=c.oldWidthEx>c.newWidthEx?Math.pow(2,c.oldWidthEx):i,s.height=c.oldHeightEx>c.newHeightEx?Math.pow(2,c.oldHeightEx):n,a.getContext("2d").save(),s.getContext("2d").save();var u=a,p=s;l=c.oldWidthEx,h=c.oldHeightEx;var d=p.getContext("2d");d.imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",d.globalCompositeOperation="copy",d.drawImage(t,0,0,p.width,p.height);for(var g=p.width,f=p.height;l>c.newWidthEx||h>c.newHeightEx;l--,h--){(d=u.getContext("2d")).imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",d.globalCompositeOperation="copy";var v=l>c.newWidthEx?g/2:g,m=h>c.newHeightEx?f/2:f;u.width=v,u.height=m,d.drawImage(p,0,0,g,f,0,0,v,m),g=v,f=m;var y=u;u=p,p=y}t.width=i,t.height=n;var x=t.getContext("2d");x.save(),x.imageSmoothingEnabled=!0,x.imageSmoothingQuality="high",x.drawImage(p,0,0,g,f,0,0,i,n),x.restore(),a.getContext("2d").restore(),s.getContext("2d").restore()}else if(i>=t.width&&n>=t.height){(a=a||(0,r.createCanvas)()).width=i,a.height=n;var b=a.getContext("2d");b.save(),b.imageSmoothingEnabled=!0,b.imageSmoothingQuality="high",b.drawImage(t,0,0,i,n),b.restore(),t.width=i,t.height=n,t.getContext("2d").drawImage(a,0,0)}else e(t,i,t.height,a,s),e(t,i,n,a,s)}}}),e(t.exports,"convertToAlphaChannelCanvas",function(){return d}),e(t.exports,"freeCanvas",function(){return g}),e(t.exports,"canvasBounds",function(){return f});var n,r=I("eelgW"),a=I("7jh4K");function s(e){var t=(0,r.createCanvas)(e.width,e.height),i=t.getContext("2d");if(!i)throw Error("2d context not supported or canvas already initialized");return i.drawImage(e,0,0),t}function o(e,t){var i=e.getContext("2d",t);if(!i)throw Error("couldn't get 2d context");return i}function l(e,t,i){if(![1,-1].includes(t)||![1,-1].includes(i)||e.width%1!=0||e.height%1!=0||Math.abs(e.angleDeg)%90!=0)return!1;var n=Math.abs(e.angleDeg-90)%180==0,r=n?e.height:e.width,a=n?e.width:e.height;return(Math.abs(r)%2==0&&e.x%1==0||Math.abs(r)%2==1&&e.x%1==.5)&&(Math.abs(a)%2==0&&e.y%1==0||Math.abs(a)%2==1&&e.y%1==.5)}function h(e,t,i,n,r){n||(n={x:0,y:0,width:t.width,height:t.height}),e.save(),r?e.imageSmoothingEnabled=!1:(e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="high"),e.translate(i.x,i.y),e.rotate(i.angleDeg/180*Math.PI),e.scale(i.width>0?1:-1,i.height>0?1:-1),e.drawImage(t,n.x,n.y,n.width,n.height,-Math.abs(i.width)/2,-Math.abs(i.height)/2,Math.abs(i.width),Math.abs(i.height)),e.restore()}function c(e,t,i){(i=(0,a.copyObj)(i)).center||(i.center={x:t.width/2,y:t.height/2}),i.scale||(i.scale={x:1,y:1}),i.angleDegree||(i.angleDegree=0),i.translate||(i.translate={x:0,y:0});var n=e.getContext("2d");if(!n)throw Error("2d context not supported or canvas already initialized");n.save(),Math.abs(i.scale.x-1)>1e-6||Math.abs(i.scale.y-1)>1e-6||Math.abs(i.angleDegree%90)>1e-6?(n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high"):n.imageSmoothingEnabled=!1,n.translate(i.translate.x,i.translate.y),n.translate(i.center.x,i.center.y),n.rotate(i.angleDegree/180*Math.PI),n.scale(i.scale.x,i.scale.y),n.translate(-i.center.x,-i.center.y),n.drawImage(t,0,0,t.width,t.height),n.restore()}var u=function(e,t){var i,n=(0,r.createCanvas)();if(e<1){if(n.width=1,n.height=1,!(i=n.getContext("2d")))throw Error("2d context not supported or canvas already initialized");i.fillStyle="rgb(128, 128, 128)",i.fillRect(0,0,1,1)}else if(e>200)n.width=401,n.height=401;else{if(n.width=2*e,n.height=2*e,!(i=n.getContext("2d")))throw Error("2d context not supported or canvas already initialized");i.fillStyle=t?"rgb(90, 90, 90)":"rgb(255, 255, 255)",i.fillRect(0,0,2*e,2*e),i.fillStyle=t?"rgb(63, 63, 63)":"rgb(200, 200, 200)",i.fillRect(0,0,e,e),i.fillRect(e,e,2*e,2*e)}return n},p=(n={"8l":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMElEQVQ4T2M8ceLEfwY8wNzcHJ80A+OoAcMiDP7//483HZw8eRJ/Ohg1gIFx6IcBAIhJUqnarXQ1AAAAAElFTkSuQmCC","4l":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAJ0lEQVQoU2M8ceLEfwYkYG5ujsxlYKSDgv///6O44eTJk6huoL0CAGsOKVVu8UYvAAAAAElFTkSuQmCC"},function(e,t,i){var r=i?"d":"l";function a(e){if(n[""+(e=parseInt(""+e))+r])return n[""+e+r];var t=u(e,i).toDataURL("image/png");return n[""+e+r]=t,t}if(!t)return a(e);setTimeout(function(){t(a(e))},1)});function d(e){for(var t=e.getContext("2d").getImageData(0,0,e.width,e.height),i=0;i<t.data.length;i+=4)0!==t.data[i+3]&&(t.data[i+3]=(t.data[i]+t.data[i+1]+t.data[i+2])/3*(t.data[i+3]/255));e.getContext("2d").putImageData(t,0,0)}function g(e){e.width=1,e.height=1,e.remove()}function f(e){var t={x:0,y:0,width:0,height:0},i={x1:void 0,y1:void 0,x2:void 0,y2:void 0},n=e.getImageData(0,0,e.canvas.width,e.canvas.height);if(n.data[3]>0&&n.data[n.data.length-1]>0)i.x1=0,i.y1=0,i.x2=e.canvas.width-1,i.y2=e.canvas.height-1;else for(var r=3;r<n.data.length;r+=4)if(n.data[r]>0){var a=(r-3)/4%e.canvas.width,s=Math.floor((r-3)/4/e.canvas.width);(void 0===i.x1||i.x1>a)&&(i.x1=a),void 0===i.y1&&(i.y1=s),(void 0===i.x2||i.x2<a)&&(i.x2=a),(void 0===i.y2||i.y2<s)&&(i.y2=s)}if(void 0!==i.x1&&void 0!==i.y1&&void 0!==i.x2&&void 0!==i.y2)return t.x=i.x1,t.y=i.y1,t.width=i.x2-i.x1+1,t.height=i.y2-i.y1+1,t}}),A("eelgW",function(t,i){e(t.exports,"createCanvas",function(){return n});function n(e,t){var i=document.createElement("canvas");return e&&t&&(i.width=e,i.height=t),i}}),A("kVHNC",function(t,i){function n(e,t){return[t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15]]}e(t.exports,"Matrix",function(){return r});var r=Object.freeze({getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},multiplyMatrixAndPoint:n,multiplyMatrices:function(e,t){var i=[t[0],t[1],t[2],t[3]],r=[t[4],t[5],t[6],t[7]],a=[t[8],t[9],t[10],t[11]],s=[t[12],t[13],t[14],t[15]],o=n(e,i),l=n(e,r),h=n(e,a),c=n(e,s);return[o[0],o[1],o[2],o[3],l[0],l[1],l[2],l[3],h[0],h[1],h[2],h[3],c[0],c[1],c[2],c[3]]},createTranslationMatrix:function(e,t){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,0,1]},createRotationMatrix:function(e){return[Math.cos(-e),-Math.sin(-e),0,0,Math.sin(-e),Math.cos(-e),0,0,0,0,1,0,0,0,0,1]},createScaleMatrix:function(e){return[e,0,0,0,0,e,0,0,0,0,1,0,0,0,0,1]}})}),A("4toIY",function(t,i){e(t.exports,"Vec2",function(){return n});var n={add:function(e,t){return{x:e.x+t.x,y:e.y+t.y}},sub:function(e,t){return{x:e.x-t.x,y:e.y-t.y}},nor:function(e){var t=Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2));return{x:e.x/t,y:e.y/t}},len:function(e){return Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2))},dist:function(e,t){return n.len(n.sub(e,t))},mul:function(e,t){return{x:e.x*t,y:e.y*t}},angle:function(e,t){return Math.atan2(t.y-e.y,t.x-e.x)},dot:function(e,t){var i=[e.x,e.y],n=[t.x,t.y];return i.map(function(e,t){return i[t]*n[t]}).reduce(function(e,t){return e+t})}}}),A("af1iA",function(t,i){e(t.exports,"projectPointOnLine",function(){return l}),e(t.exports,"PointLine",function(){return h}),e(t.exports,"BezierLine",function(){return c}),e(t.exports,"SplineInterpolator",function(){return u}),e(t.exports,"quadraticSplineInput",function(){return p});var n=I("cx0mh"),r=I("7h4XF"),a=I("4toIY"),s=I("eg83P"),o=I("7jh4K"),l=function(e,t,i){if(e.x===t.x)return{x:e.x,y:i.y};var n,r=(t.y-e.y)/(t.x-e.x),a=e.y-r*e.x;return{x:(r*i.y+i.x-r*a)/(r*r+1),y:(r*r*i.y+r*i.x+a)/(r*r+1)}},h=function(){function e(t){var i=this;(0,n._)(this,e),this.segmentArr=[];for(var r=0;r<t.points.length;r++)!function(e){var n=0;e<t.points.length-1&&(n=(0,s.dist)(t.points[e].x,t.points[e].y,t.points[e+1].x,t.points[e+1].y)),i.segmentArr[e]={x:t.points[e].x,y:t.points[e].y,length:n}}(r)}return(0,r._)(e,[{key:"getAtDist",value:function(e){for(var t=Math.min(this.getLength(),e),i=0;t>this.segmentArr[i].length&&i<this.segmentArr.length-2;i++)t-=this.segmentArr[i].length;var n=Math.min(1,Math.max(0,t/this.segmentArr[i].length));return{x:this.segmentArr[i].x*(1-n)+this.segmentArr[i+1].x*n,y:this.segmentArr[i].y*(1-n)+this.segmentArr[i+1].y*n}}},{key:"getLength",value:function(){for(var e=0,t=0;t<this.segmentArr.length-1;t++)e+=this.segmentArr[t].length;return e}}]),e}(),c=function(){function e(){(0,n._)(this,e),this.lastDot=0,this.pointArr=[]}return(0,r._)(e,[{key:"getBezierPoints",value:function(e,t,i,n,r){for(var a,s=[],o=0;o<=r;o++)a=o/r,s[s.length]={x:Math.pow(1-a,3)*e.x+3*Math.pow(1-a,2)*a*t.x+3*(1-a)*Math.pow(a,2)*i.x+Math.pow(a,3)*n.x,y:Math.pow(1-a,3)*e.y+3*Math.pow(1-a,2)*a*t.y+3*(1-a)*Math.pow(a,2)*i.y+Math.pow(a,3)*n.y};return s}},{key:"add",value:function(e,t,i,n,r){if(!this.lastPoint||e!==this.lastPoint.x||t!==this.lastPoint.y){if(this.lastPoint={x:e,y:t},this.pointArr[this.pointArr.length]={x:e,y:t,spacing:i},1===this.pointArr.length){this.lastSpacing=i;return}if(2===this.pointArr.length){this.pointArr[0].dir=(0,a.Vec2).nor((0,a.Vec2).sub(this.pointArr[1],this.pointArr[0])),this.lastDot=i,this.lastSpacing=i;return}var l,c=this.pointArr[this.pointArr.length-1],u=this.pointArr[this.pointArr.length-2],p=this.pointArr[this.pointArr.length-3];u.dir=(0,a.Vec2).nor((0,a.Vec2).sub(c,p)),(isNaN(u.dir.x)||isNaN(u.dir.y))&&(u.dir=(0,o.copyObj)(p.dir));for(var d=this.pointArr[this.pointArr.length-3],g=this.pointArr[this.pointArr.length-2],f=(0,a.Vec2).add(d,(0,a.Vec2).mul(d.dir,(0,a.Vec2).dist(d,g)/4)),v=(0,a.Vec2).sub(g,(0,a.Vec2).mul(g.dir,(0,a.Vec2).dist(d,g)/4)),m=(l=new h(n?{points:this.getBezierPoints(d,f,v,g,20)}:{points:[d,g]})).getLength(),y=(0,s.mix)(this.lastSpacing,i,(0,s.clamp)(this.lastDot/m,0,1)),x=this.lastDot;x<=m;x+=y){y=(0,s.mix)(this.lastSpacing,i,(0,s.clamp)(x/m,0,1));var b=l.getAtDist(x),B=this.lastCallbackPoint?(0,s.pointsToAngleDeg)(this.lastCallbackPoint,b):void 0;n&&n({x:b.x,y:b.y,t:x/m,angle:B,dAngle:this.lastCallbackPoint?B-this.lastAngle:0}),this.lastCallbackPoint=b,this.lastAngle=B}n?this.lastDot=x-m:(this.lastDot=0,r&&r({p1:d,p2:f,p3:v,p4:g})),this.lastSpacing=i}}},{key:"addFinal",value:function(e,t,i){if(!(this.pointArr.length<2)){var n=this.pointArr[this.pointArr.length-2],r=this.pointArr[this.pointArr.length-1],s=(0,a.Vec2).add(r,(0,a.Vec2).sub(r,n));this.add(s.x,s.y,e,t,i)}}}]),e}(),u=function(){function e(t){(0,n._)(this,e);var i,r=t.length;for(this.xa=[],this.ya=[],this.u=[],this.y2=[],this.first=t[0][0],this.last=t[t.length-1][0],t.sort(function(e,t){return e[0]-t[0]}),i=0;i<r;i++)this.xa.push(t[i][0]),this.ya.push(t[i][1]);for(i=1,this.u[0]=0,this.y2[0]=0;i<r-1;++i){var a=this.xa[i+1]-this.xa[i-1],s=(this.xa[i]-this.xa[i-1])/a,o=s*this.y2[i-1]+2;this.y2[i]=(s-1)/o;var l=(this.ya[i+1]-this.ya[i])/(this.xa[i+1]-this.xa[i])-(this.ya[i]-this.ya[i-1])/(this.xa[i]-this.xa[i-1]);this.u[i]=(6*l/a-s*this.u[i-1])/o}for(this.y2[r-1]=0,i=r-2;i>=0;--i)this.y2[i]=this.y2[i]*this.y2[i+1]+this.u[i]}return(0,r._)(e,[{key:"getFirstX",value:function(){return this.first}},{key:"getLastX",value:function(){return this.last}},{key:"interpolate",value:function(e){for(var t=this.ya.length,i=0,n=t-1;n-i>1;){var r=n+i>>1;this.xa[r]>e?n=r:i=r}var a=this.xa[n]-this.xa[i],s=(this.xa[n]-e)/a,o=(e-this.xa[i])/a;return s*this.ya[i]+o*this.ya[n]+((s*s*s-s)*this.y2[i]+(o*o*o-o)*this.y2[n])*(a*a)/6}},{key:"findX",value:function(e,t){for(var i,n,r=0;r<=t;r++){var a=r/t,s=this.interpolate(a);if(void 0===i){i=a,n=Math.abs(s-e);continue}var o=Math.abs(s-e);if(o<n)i=a,n=o;else break}return i}}]),e}();function p(e,t,i){function n(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}for(var r=[],a=0;a<=1;a+=i)r.push([n(a,4),n(e+Math.pow(a,2)*(t-e),4)]);return r}}),A("dJ1E2",function(t,i){e(t.exports,"HSV",function(){return r}),e(t.exports,"RGB",function(){return a}),e(t.exports,"CMYK",function(){return s}),e(t.exports,"ColorConverter",function(){return o}),e(t.exports,"testIsWhiteBestContrast",function(){return l});var n=I("cx0mh"),r=function e(t,i,r){(0,n._)(this,e),this.h=Math.max(0,Math.min(360,t)),this.s=Math.max(.001,Math.min(100,i)),this.v=Math.max(0,Math.min(100,r))},a=function e(t,i,r){(0,n._)(this,e),this.r=Math.max(0,Math.min(255,t)),this.g=Math.max(0,Math.min(255,i)),this.b=Math.max(0,Math.min(255,r))},s=function e(t,i,r,a){(0,n._)(this,e),this.c=Math.max(0,Math.min(100,t)),this.m=Math.max(0,Math.min(100,i)),this.y=Math.max(0,Math.min(100,r)),this.k=Math.max(0,Math.min(100,a))},o={_RGBtoHSV:function(e){var t=new r(0,0,0),i=e.r/255,n=e.g/255,a=e.b/255,s=Math.min(i,n,a),o=Math.max(i,n,a),l=o-s;if(t.v=o,0==l)t.h=0,t.s=0;else{t.s=l/o;var h=((o-i)/6+l/2)/l,c=((o-n)/6+l/2)/l,u=((o-a)/6+l/2)/l;i==o?t.h=u-c:n==o?t.h=1/3+h-u:a==o&&(t.h=2/3+c-h),t.h<0&&(t.h+=1),t.h>1&&(t.h-=1)}return t.h=Math.round(360*t.h),t.s=Math.round(100*t.s),t.v=Math.round(100*t.v),t},_HSVtoRGB:function(e){var t,i,n,r,s,o,l,h,c=new a(0,0,0),u=e.h/360%1,p=e.s/100,d=e.v/100;return 0==p?(c.r=255*d,c.g=255*d,c.b=255*d):(i=Math.floor(t=6*u),n=d*(1-p),r=d*(1-p*(t-i)),s=d*(1-p*(1-(t-i))),0==i?(o=d,l=s,h=n):1==i?(o=r,l=d,h=n):2==i?(o=n,l=d,h=s):3==i?(o=n,l=r,h=d):4==i?(o=s,l=n,h=d):(o=d,l=n,h=r),c.r=255*o,c.g=255*l,c.b=255*h,c.r=Math.round(c.r),c.g=Math.round(c.g),c.b=Math.round(c.b)),c},_CMYKtoRGB:function(e){var t=new a(0,0,0),i=e.c/100,n=e.m/100,r=e.y/100,s=e.k/100;return t.r=1-Math.min(1,i*(1-s)+s),t.g=1-Math.min(1,n*(1-s)+s),t.b=1-Math.min(1,r*(1-s)+s),t.r=Math.round(255*t.r),t.g=Math.round(255*t.g),t.b=Math.round(255*t.b),t},_RGBtoCMYK:function(e){var t=new s(0,0,0,0),i=e.r/255,n=e.g/255,r=e.b/255;return t.k=Math.min(1-i,1-n,1-r),t.c=(1-i-t.k)/(1-t.k),t.m=(1-n-t.k)/(1-t.k),t.y=(1-r-t.k)/(1-t.k),t.c=Math.round(100*t.c),t.m=Math.round(100*t.m),t.y=Math.round(100*t.y),t.k=Math.round(100*t.k),t},toRGB:function(e){if(e instanceof a)return e;if(e instanceof r)return this._HSVtoRGB(e);if(e instanceof s)return this._CMYKtoRGB(e);throw Error("unknown type")},toHSV:function(e){if(e instanceof r)return e;if(e instanceof a)return this._RGBtoHSV(e);if(e instanceof s)return this._RGBtoHSV(this._CMYKtoRGB(e));throw Error("unknown type")},toCMYK:function(e){if(e instanceof s)return e;if(e instanceof a)return this._RGBtoCMYK(e);if(e instanceof r)return this._RGBtoCMYK(this._HSVtoRGB(e));throw Error("unknown type")},toHexString:function(e){if(e instanceof a||"r"in e&&"g"in e&&"b"in e){var t=parseInt(""+e.r).toString(16),i=parseInt(""+e.g).toString(16),n=parseInt(""+e.b).toString(16);return 1==t.length&&(t="0"+t),1==i.length&&(i="0"+i),1==n.length&&(n="0"+n),t+i+n}return"#000"},toRgbStr:function(e){return"rgb("+Math.round(e.r)+", "+Math.round(e.g)+", "+Math.round(e.b)+")"},toRgbaStr:function(e){return"rgba("+Math.round(e.r)+", "+Math.round(e.g)+", "+Math.round(e.b)+", "+e.a+")"},hexToRGB:function(e){e=(e=e.trim()).replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,i,n){return t+t+i+i+n+n});var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?new a(parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)):void 0}};function l(e){return .299*e.r+.587*e.g+.114*e.b<125}}),A("72Jv0",function(t,i){e(t.exports,"appendTextDiv",function(){return a}),e(t.exports,"isInputFocused",function(){return s}),e(t.exports,"unfocusAnyInput",function(){return o}),e(t.exports,"clearSelection",function(){return l}),e(t.exports,"makeUnfocusable",function(){return h}),e(t.exports,"el",function(){return u}),e(t.exports,"destroyEl",function(){return p});var n=I("7jh4K"),r=I("eWjiX");function a(e,t){var i=document.createElement("div");return i.innerHTML=t,e.append(i),i}function s(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=!!document.activeElement&&["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName);return t?i:i&&!(null===(e=document.activeElement)||void 0===e?void 0:e.getAttribute("data-ignore-focus"))}function o(){if(s(!0)){var e=(0,r.BB).el({parent:document.body,tagName:"input",css:{opacity:"0",width:"0",height:"0"}});setTimeout(function(){e.select(),e.focus(),e.remove()},10)}}function l(){if(window.getSelection){var e=window.getSelection();e&&(e.empty?e.empty():e.removeAllRanges&&e.removeAllRanges())}}var h=function(){function e(e){e.preventDefault();var t=!1;if(e.relatedTarget)try{e.relatedTarget.focus(),t=!0}catch(e){console.error("failed to focus")}t||e.currentTarget.blur()}return function(t){t.setAttribute("tabindex","-1"),t.addEventListener("focus",e)}}(),c=[];function u(e){if(!e)return document.createElement("div");var t=document.createElement(e.tagName?e.tagName:"div");e.css&&(0,n.css)(t,e.css),e.content&&("string"==typeof e.content?t.innerHTML=e.content:Array.isArray(e.content)?(0,r.BB).append(t,e.content):t.append(e.content)),e.textContent&&(t.textContent=e.textContent),e.className&&(t.className=e.className),e.id&&(t.id=e.id),e.parent&&e.parent.append(t),"title"in e&&void 0!==e.title&&(t.title=e.title);var i=[];if(void 0!==e.onClick&&(t.addEventListener("click",e.onClick),e.noRef||i.push(["click",e.onClick])),void 0!==e.onChange&&(t.addEventListener("change",e.onChange),e.noRef||i.push(["change",e.onChange])),i.length>0&&c.push({el:t,listeners:i}),"custom"in e&&e.custom)for(var a=Object.keys(e.custom),s=0;s<a.length;s++)t.setAttribute(a[s],e.custom[a[s]]);return t}function p(e){if(e)for(var t=0;t<c.length;t++){var i=c[t];if(i.el===e){i.listeners.forEach(function(t){e.removeEventListener(t[0],t[1])}),c.splice(t,1);break}}}}),A("i0uIf",function(t,i){e(t.exports,"BbLog",function(){return a});var n=I("cx0mh"),r=I("7h4XF"),a=function(){function e(){(0,n._)(this,e)}return(0,r._)(e,null,[{key:"subscribe",value:function(t){e.listeners.includes(t)||e.listeners.push(t)}},{key:"unsubscribe",value:function(t){for(var i=0;i<e.listeners.length;i++)if(t===e.listeners[i]){e.listeners.splice(i,1);return}}},{key:"emit",value:function(t){e.listeners.forEach(function(e){e(t)})}}]),e}();a.listeners=[]}),A("6l0gQ",function(t,i){e(t.exports,"LocalStorage",function(){return a});var n=I("cx0mh"),r=I("7h4XF"),a=function(){function e(){(0,n._)(this,e)}return(0,r._)(e,null,[{key:"getItem",value:function(e){var t=null;try{t=localStorage.getItem(e)}catch(e){this.error=e}return t}},{key:"setItem",value:function(e,t){try{localStorage.setItem(e,t)}catch(e){this.error=e}}},{key:"removeItem",value:function(e){try{localStorage.removeItem(e)}catch(e){this.error=e}}},{key:"getError",value:function(){return this.error}}]),e}()}),A("jjWRi",function(t,i){e(t.exports,"CoalescedExploder",function(){return s});var n=I("cx0mh"),r=I("7h4XF"),a=I("7jh4K"),s=function(){function e(){(0,n._)(this,e)}return(0,r._)(e,[{key:"setChainOut",value:function(e){this.chainOut=e}},{key:"chainIn",value:function(e){if("pointermove"!==e.type||!e.coalescedArr||!(e.coalescedArr.length>0))return e;for(var t=0;t<e.coalescedArr.length;t++){var i=(0,a.copyObj)(e);0===t&&(i.coalescedArr=[]);var n=e.coalescedArr[t];i.pageX=n.pageX,i.pageY=n.pageY,i.relX=n.relX,i.relY=n.relY,i.dX=n.dX,i.dY=n.dY,i.time=n.time,t<e.coalescedArr.length-1&&(i.isCoalesced=!0),this.chainOut&&this.chainOut(i)}return null}}]),e}()}),A("2pgVs",function(t,i){e(t.exports,"NFingerTapper",function(){return s});var n=I("cx0mh"),r=I("7h4XF"),a=I("eg83P"),s=function(){function e(t){(0,n._)(this,e),this.minSilenceBeforeDurationMs=50,this.maxTapMs=500,this.maxFirstLastFingerDownMs=250,this.maxPressedDistancePx=12,this.fingerArr=[],this.eventQueueArr=[],this.firstDownTime=0,this.lastEventTime=0,this.nowTime=performance.now(),this.pointersDownIdArr=[],this.timeoutObj={firstLastDownTimeout:null,tapTimeout:null},this.fingers=t.fingers,this.onTap=t.onTap}return(0,r._)(e,[{key:"failGesture",value:function(){if(0!==this.eventQueueArr.length){this.timeoutObj.firstLastDownTimeout&&clearTimeout(this.timeoutObj.firstLastDownTimeout),this.timeoutObj.tapTimeout&&clearTimeout(this.timeoutObj.tapTimeout);for(var e=0;e<this.eventQueueArr.length;e++)this.chainOut&&this.chainOut(this.eventQueueArr[e]);this.eventQueueArr=[],this.fingerArr=[]}}},{key:"success",value:function(){this.timeoutObj.firstLastDownTimeout&&clearTimeout(this.timeoutObj.firstLastDownTimeout),this.timeoutObj.tapTimeout&&clearTimeout(this.timeoutObj.tapTimeout),this.eventQueueArr=[],this.fingerArr=[],this.onTap()}},{key:"setupTimeout",value:function(e,t){var i=this,n=t-this.nowTime;return!(n<=0)&&(this.timeoutObj[e]=setTimeout(function(){return i.failGesture()},n),!0)}},{key:"processEvent",value:function(e){var t=this.lastEventTime;if(this.lastEventTime=e.time,"pointerdown"===e.type)this.pointersDownIdArr.push(e.pointerId);else if("pointerup"===e.type){for(var i=0;i<this.pointersDownIdArr.length;i++)if(this.pointersDownIdArr[i]===e.pointerId){this.pointersDownIdArr.splice(i,1);break}}if("touch"!==e.pointerType){this.fingerArr.length>0&&this.failGesture();return}if(this.nowTime=performance.now(),"pointerdown"===e.type){if(this.fingerArr.length+1!==this.pointersDownIdArr.length||this.fingerArr.length===this.fingers||this.fingerArr.length>0&&e.time-this.maxFirstLastFingerDownMs>this.fingerArr[0].downTimeMs||0===this.fingerArr.length&&e.time-this.minSilenceBeforeDurationMs<t||0===this.fingerArr.length&&(this.firstDownTime=e.time,!this.setupTimeout("firstLastDownTimeout",e.time+this.maxFirstLastFingerDownMs)||!this.setupTimeout("tapTimeout",e.time+this.maxTapMs))){this.failGesture();return}this.fingerArr.push({pointerId:e.pointerId,downTimeMs:e.time,downPageX:e.pageX,downPageY:e.pageY});return}if("pointermove"===e.type){if(0===this.fingerArr.length)return;for(var n=null,r=0;r<this.fingerArr.length;r++)if(this.fingerArr[r].pointerId===e.pointerId){n=this.fingerArr[r];break}if(null===n||e.time-this.maxTapMs>this.firstDownTime||(0,a.dist)(e.pageX,e.pageY,n.downPageX,n.downPageY)>this.maxPressedDistancePx){this.failGesture();return}}if("pointerup"===e.type){if(0===this.fingerArr.length)return;if(this.fingerArr.length!==this.fingers){this.failGesture();return}for(var s=null,o=0;o<this.fingerArr.length;o++)if(this.fingerArr[o].pointerId===e.pointerId){s=this.fingerArr[o];break}if(null===s)return;if(e.time-this.maxTapMs>this.firstDownTime||(0,a.dist)(e.pageX,e.pageY,s.downPageX,s.downPageY)>this.maxPressedDistancePx){this.failGesture();return}s.isUp=!0;for(var l=!0,h=0;h<this.fingerArr.length;h++)if(!this.fingerArr[h].isUp){l=!1;break}if(l)return this.success(),!0}}},{key:"chainIn",value:function(e){return!0===this.processEvent(e)?null:0===this.fingerArr.length?e:(this.eventQueueArr.push(e),null)}},{key:"setChainOut",value:function(e){this.chainOut=e}}]),e}()}),A("joplQ",function(t,i){e(t.exports,"PinchZoomer",function(){return s});var n=I("cx0mh"),r=I("7h4XF"),a=I("eg83P"),s=function(){function e(t){(0,n._)(this,e),this.firstFingerMaxDistancePx=10,this.untilSecondFingerDurationMs=250,this.pointersDownIdArr=[],this.gestureObj=null,this.eventQueueArr=[],this.nowTime=performance.now(),this.timeoutObj={secondFingerTimeout:null},this.pincherArr=[],this.onPinch=t.onPinch}return(0,r._)(e,[{key:"end",value:function(){this.gestureObj=null,this.eventQueueArr=[]}},{key:"fail",value:function(e){if(this.gestureObj){if(this.timeoutObj.secondFingerTimeout&&clearTimeout(this.timeoutObj.secondFingerTimeout),!e)for(var t=0;t<this.eventQueueArr.length;t++)this.chainOut&&this.chainOut(this.eventQueueArr[t]);this.end()}}},{key:"setupFailTimeout",value:function(e){var t=this,i=e-this.nowTime;return!(i<=0)&&(this.timeoutObj.secondFingerTimeout=setTimeout(function(){return t.fail()},i),!0)}},{key:"processEvent",value:function(e){if("pointerdown"===e.type)this.pointersDownIdArr.push(e.pointerId);else if("pointerup"===e.type){for(var t=0;t<this.pointersDownIdArr.length;t++)if(this.pointersDownIdArr[t]===e.pointerId){this.pointersDownIdArr.splice(t,1);break}}if(this.gestureObj||"touch"===e.pointerType&&("pointermove"!==e.type||!(this.pointersDownIdArr.length>0))&&!(this.pointersDownIdArr.length>1)&&"pointerup"!==e.type){if(this.nowTime=performance.now(),"pointerdown"===e.type){if(this.gestureObj){if("touch"===e.pointerType){this.gestureObj.touchPointerArr.push({pointerId:e.pointerId,relX:e.relX,relY:e.relY}),this.gestureObj.isInProgress?this.continuePinch(this.gestureObj,{type:"down",index:this.gestureObj.touchPointerArr.length-1}):(this.timeoutObj.secondFingerTimeout&&clearTimeout(this.timeoutObj.secondFingerTimeout),this.gestureObj.isInProgress=!0,this.beginPinch(this.gestureObj));return}this.gestureObj.isInProgress?this.gestureObj.otherPointerIdArr.push(e.pointerId):this.fail();return}this.gestureObj={touchPointerArr:[{pointerId:e.pointerId,relX:e.relX,relY:e.relY,downRelX:e.relX,downRelY:e.relY}],otherPointerIdArr:[],isInProgress:!1},this.setupFailTimeout(e.time+this.untilSecondFingerDurationMs)||this.fail();return}if(!this.gestureObj){this.fail();return}if("pointermove"===e.type&&"touch"===e.pointerType){for(var i=null,n=0;n<this.gestureObj.touchPointerArr.length;n++)if(e.pointerId===this.gestureObj.touchPointerArr[n].pointerId){i=this.gestureObj.touchPointerArr[n];break}if(!i){this.fail();return}if(i.relX=e.relX,i.relY=e.relY,this.gestureObj.isInProgress)n<2&&this.continuePinch(this.gestureObj,{type:"move",index:n});else{if(!("downRelX"in i&&void 0!==i.downRelX)||!("downRelY"in i&&void 0!==i.downRelY)){this.fail();return}(0,a.dist)(i.downRelX,i.downRelY,i.relX,i.relY)>this.firstFingerMaxDistancePx&&this.fail()}return}if("pointerup"===e.type){if("touch"===e.pointerType){for(var r=0;r<this.gestureObj.touchPointerArr.length;r++)if(this.gestureObj.touchPointerArr[r].pointerId===e.pointerId){this.gestureObj.touchPointerArr.splice(r,1);break}this.gestureObj.touchPointerArr.length>0&&this.continuePinch(this.gestureObj,{type:"up",index:r})}else for(var s=0;s<this.gestureObj.otherPointerIdArr.length;s++)if(this.gestureObj.otherPointerIdArr[s]===e.pointerId){this.gestureObj.otherPointerIdArr.splice(s,1);break}if(0===this.gestureObj.touchPointerArr.length&&0===this.gestureObj.otherPointerIdArr.length){this.gestureObj.isInProgress?(this.end(),this.endPinch()):this.fail();return}}}}},{key:"beginPinch",value:function(e){for(var t=0;t<e.touchPointerArr.length;t++){var i=e.touchPointerArr[t];this.pincherArr.push({pointerId:i.pointerId,relX:i.relX,relY:i.relY,downRelX:i.relX,downRelY:i.relY})}var n={type:"move",downRelX:0,downRelY:0,relX:0,relY:0,angleRad:0,scale:1};1===this.pincherArr.length?(n.relX=this.pincherArr[0].downRelX,n.relY=this.pincherArr[0].downRelY):(n.relX=.5*(this.pincherArr[0].downRelX+this.pincherArr[1].downRelX),n.relY=.5*(this.pincherArr[0].downRelY+this.pincherArr[1].downRelY)),n.downRelX=n.relX,n.downRelY=n.relY,this.onPinch(n)}},{key:"continuePinch",value:function(e,t){if(!(t.index>1)){if("move"===t.type){var i;if(this.pincherArr[t.index].relX=e.touchPointerArr[t.index].relX,this.pincherArr[t.index].relY=e.touchPointerArr[t.index].relY,1===this.pincherArr.length)i={type:"move",downRelX:this.pincherArr[0].downRelX,downRelY:this.pincherArr[0].downRelY,relX:this.pincherArr[0].relX,relY:this.pincherArr[0].relY,angleRad:0,scale:1};else{var n=(0,a.dist)(this.pincherArr[0].downRelX,this.pincherArr[0].downRelY,this.pincherArr[1].downRelX,this.pincherArr[1].downRelY),r=(0,a.dist)(this.pincherArr[0].relX,this.pincherArr[0].relY,this.pincherArr[1].relX,this.pincherArr[1].relY),s=(0,a.pointsToAngleRad)({x:this.pincherArr[0].downRelX,y:this.pincherArr[0].downRelY},{x:this.pincherArr[1].downRelX,y:this.pincherArr[1].downRelY}),o=(0,a.pointsToAngleRad)({x:this.pincherArr[0].relX,y:this.pincherArr[0].relY},{x:this.pincherArr[1].relX,y:this.pincherArr[1].relY});i={type:"move",downRelX:.5*(this.pincherArr[0].downRelX+this.pincherArr[1].downRelX),downRelY:.5*(this.pincherArr[0].downRelY+this.pincherArr[1].downRelY),relX:.5*(this.pincherArr[0].relX+this.pincherArr[1].relX),relY:.5*(this.pincherArr[0].relY+this.pincherArr[1].relY),angleRad:o-s,scale:r/n}}this.onPinch(i)}else("down"===t.type||"up"===t.type)&&(this.endPinch(),this.beginPinch(e))}}},{key:"endPinch",value:function(){this.pincherArr=[],this.onPinch({type:"end"})}},{key:"chainIn",value:function(e){return(this.processEvent(e),this.gestureObj)?(this.gestureObj.isInProgress||this.eventQueueArr.push(e),null):e}},{key:"setChainOut",value:function(e){this.chainOut=e}}]),e}()}),A("c1lmK",function(t,i){e(t.exports,"DoubleTapper",function(){return o});var n=I("cx0mh"),r=I("7h4XF"),a=I("bX4ja"),s=I("eg83P"),o=function(){function e(t){var i=this;(0,n._)(this,e),this.allowedPointerTypeArr=["touch","mouse","pen"],this.allowedButtonArr=["left"],this.minSilenceBeforeDurationMs=400,this.maxPressedDurationMs=300,this.maxPressedDistancePx=10,this.maxInbetweenDistancePx=19,this.maxUpToUpDurationMs=500,this.maxUntilSecondDownDurationMs=300,this.minSilenceAfterMs=250,this.sequenceArr=[],this.pointersDownIdArr=[],this.lastUpTime=0,this.nowTime=0,this.eventQueueArr=[],this.timeoutObj={fail:null,maxUntilSecondDown:null,success:null},this.onDoubleTap=t.onDoubleTap,t.isInstant&&(this.minSilenceBeforeDurationMs=0,this.minSilenceAfterMs=0),this.gestureFailed=function(){if(0!==i.sequenceArr.length){if(i.timeoutObj.fail&&clearTimeout(i.timeoutObj.fail),i.timeoutObj.maxUntilSecondDown&&clearTimeout(i.timeoutObj.maxUntilSecondDown),i.timeoutObj.success&&clearTimeout(i.timeoutObj.success),i.timeoutObj.fail=null,i.timeoutObj.maxUntilSecondDown=null,i.timeoutObj.success=null,i.chainOut)for(var e=0;e<i.eventQueueArr.length;e++)i.chainOut(i.eventQueueArr[e]);i.eventQueueArr=[],i.sequenceArr=[]}}}return(0,r._)(e,[{key:"success",value:function(){this.timeoutObj.fail=null,this.timeoutObj.success=null,this.eventQueueArr=[];var e=this.sequenceArr[this.sequenceArr.length-1];this.sequenceArr=[],"pageX"in e&&this.onDoubleTap({pageX:e.pageX,pageY:e.pageY,relX:e.relX,relY:e.relY})}},{key:"setupTimeout",value:function(e,t,i,n){var r=i-this.nowTime;return(!(r<=0)||!!n)&&(this.timeoutObj[e]=setTimeout(t,Math.max(0,r)),!0)}},{key:"processEvent",value:function(e){var t=this;if("pointerdown"===e.type)this.pointersDownIdArr.push(e.pointerId);else if("pointerup"===e.type){for(var i=0;i<this.pointersDownIdArr.length;i++)if(this.pointersDownIdArr[i]===e.pointerId){this.pointersDownIdArr.splice(i,1);break}}if(!this.allowedPointerTypeArr.includes(e.pointerType)){this.gestureFailed();return}this.nowTime=performance.now();var n=this.sequenceArr.length>0?this.sequenceArr[this.sequenceArr.length-1]:null;if("pointerup"===e.type&&(this.lastUpTime=e.time),"pointerdown"===e.type){if(this.pointersDownIdArr.length>1||null!==this.timeoutObj.success||0===this.sequenceArr.length&&this.nowTime-this.lastUpTime<this.minSilenceBeforeDurationMs||e.button&&!this.allowedButtonArr.includes(e.button)||n&&"isDown"in n&&n.isDown||this.sequenceArr.length>2){this.gestureFailed();return}if(n&&"position"in n&&(0,s.dist)(n.position[0],n.position[1],e.pageX,e.pageY)>this.maxInbetweenDistancePx&&(this.gestureFailed(),"time"in n&&this.nowTime-n.time<this.minSilenceBeforeDurationMs))return;if(this.sequenceArr.push({isDown:!0,time:this.nowTime,position:[e.pageX,e.pageY],pointerId:e.pointerId}),this.sequenceArr.length>1)this.timeoutObj.maxUntilSecondDown&&clearTimeout(this.timeoutObj.maxUntilSecondDown);else if(!this.setupTimeout("maxUntilSecondDown",function(){return t.gestureFailed()},e.time+this.maxUntilSecondDownDurationMs)){this.gestureFailed();return}if(this.timeoutObj.fail&&clearTimeout(this.timeoutObj.fail),!this.setupTimeout("fail",function(){return t.gestureFailed()},e.time+this.maxPressedDurationMs)){this.gestureFailed();return}}if(n&&"pointermove"===e.type&&"pointerId"in n&&n.pointerId===e.pointerId&&(0,s.dist)(n.position[0],n.position[1],e.pageX,e.pageY)>this.maxPressedDistancePx){this.gestureFailed();return}if(n&&"pointerup"===e.type){if("pointerId"in n&&n.pointerId!==e.pointerId||"time"in n&&this.nowTime>=n.time+this.maxPressedDurationMs){this.gestureFailed();return}if(this.timeoutObj.fail&&clearTimeout(this.timeoutObj.fail),this.sequenceArr.length<3){if(!this.setupTimeout("fail",function(){return t.gestureFailed()},e.time+this.maxUpToUpDurationMs)){this.gestureFailed();return}this.sequenceArr=[n,{isUp:!0,time:this.nowTime,position:[e.pageX,e.pageY]}];return}"time"in this.sequenceArr[1]&&this.nowTime<this.sequenceArr[1].time+this.maxUpToUpDurationMs?(this.sequenceArr.push({pageX:e.pageX,pageY:e.pageY,relX:e.relX,relY:e.relY}),this.setupTimeout("success",function(){return t.success()},e.time+this.minSilenceAfterMs,!0)||this.gestureFailed()):this.gestureFailed()}}},{key:"chainIn",value:function(e){return(this.processEvent(e),0===this.sequenceArr.length)?(this.gestureFailed(),e):(this.eventQueueArr.push(e),null)}},{key:"setChainOut",value:function(e){this.chainOut=e}},{key:"setAllowedPointerTypeArr",value:function(e){this.allowedPointerTypeArr=(0,a._)(e)}},{key:"setAllowedButtonArr",value:function(e){this.allowedButtonArr=(0,a._)(e)}}]),e}()}),A("bX4ja",function(t,i){e(t.exports,"_",function(){return o});var n=I("6KGpL"),r=I("5mm0I"),a=I("kD20o"),s=I("kWe4k");function o(e){return(0,n._array_without_holes)(e)||(0,r._iterable_to_array)(e)||(0,s._unsupported_iterable_to_array)(e)||(0,a._non_iterable_spread)()}}),A("6KGpL",function(t,i){e(t.exports,"_array_without_holes",function(){return r});var n=I("gszWS");function r(e){if(Array.isArray(e))return(0,n._array_like_to_array)(e)}}),A("5mm0I",function(t,i){e(t.exports,"_iterable_to_array",function(){return n});function n(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}}),A("kD20o",function(t,i){e(t.exports,"_non_iterable_spread",function(){return n});function n(){throw TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}}),A("635F6",function(t,i){e(t.exports,"OnePointerLimiter",function(){return a});var n=I("cx0mh"),r=I("7h4XF"),a=function(){function e(){(0,n._)(this,e),this.downPointerId=null,this.ignorePointerIdArr=[]}return(0,r._)(e,[{key:"chainIn",value:function(e){if(this.ignorePointerIdArr.includes(e.pointerId)){if("pointerup"===e.type){for(var t=0;t<this.ignorePointerIdArr.length;t++)if(this.ignorePointerIdArr[t]===e.pointerId){this.ignorePointerIdArr.splice(t,1);break}}return null}return null===this.downPointerId?("pointerdown"===e.type&&(this.downPointerId=e.pointerId),e):e.pointerId!==this.downPointerId?("pointerdown"===e.type&&this.ignorePointerIdArr.push(e.pointerId),null):("pointerup"===e.type&&(this.downPointerId=null),e)}},{key:"setChainOut",value:function(e){this.chainOut=e}}]),e}()}),A("gCzYB",function(t,i){e(t.exports,"EventChain",function(){return a});var n=I("cx0mh"),r=I("7h4XF"),a=function(){function e(t){var i=this;(0,n._)(this,e),this.chainArr=t.chainArr;for(var r=0;r<this.chainArr.length;r++)!function(e){i.chainArr[e].setChainOut(function(t){i.continueChain(e+1,t)})}(r)}return(0,r._)(e,[{key:"continueChain",value:function(e,t){for(;e<this.chainArr.length;e++)if(null===(t=this.chainArr[e].chainIn(t)))return null;return this.chainOut&&this.chainOut(t),null}},{key:"chainIn",value:function(e){return this.continueChain(0,e)}},{key:"setChainOut",value:function(e){this.chainOut=e}}]),e}()}),A("1C8RU",function(t,i){e(t.exports,"theme",function(){return o});var n=I("cx0mh"),r=I("7h4XF"),a=I("7jh4K"),s="klecks-theme",o=new(function(){function e(){var t=this;(0,n._)(this,e),this.mediaQueryTheme="light",this.theme="light",this.listeners=[],this.mediaQueryTheme=(0,a.isDark)()?"dark":"light",(0,a.addIsDarkListener)(function(){t.mediaQueryTheme=(0,a.isDark)()?"dark":"light",t.updateTheme()}),this.storedTheme=this.readLocalStorage(),addEventListener("storage",function(e){e.key===s&&(t.storedTheme=t.readLocalStorage(),t.updateTheme())}),this.updateTheme()}return(0,r._)(e,[{key:"updateTheme",value:function(){var e=this.theme;this.theme=this.storedTheme||this.mediaQueryTheme,this.theme!==e&&(document.body.classList.toggle("kl-theme-dark","dark"===this.theme),this.listeners.forEach(function(e){return e()}))}},{key:"readLocalStorage",value:function(){var e=localStorage.getItem(s);return e&&("string"!=typeof e||["dark","light"].includes(e))||(e=void 0,localStorage.removeItem(s)),e}},{key:"isDark",value:function(){return"dark"===this.theme}},{key:"addIsDarkListener",value:function(e){this.listeners.includes(e)||this.listeners.push(e)}},{key:"removeIsDarkListener",value:function(e){for(var t=0;t<this.listeners.length;t++)if(this.listeners[t]===e){this.listeners.splice(t,1);return}}},{key:"getMediaQueryTheme",value:function(){return this.mediaQueryTheme}},{key:"getStoredTheme",value:function(){return this.storedTheme}},{key:"setStoredTheme",value:function(e){e?localStorage.setItem(s,e):localStorage.removeItem(s),this.storedTheme=e,this.updateTheme()}}]),e}())}),A("dQMMg",function(e,t){Object.defineProperty(e.exports,"__esModule",{value:!0});var i=I("8O5Y2");I("exBzs"),I("csvAs"),I("5zE8f");var n=i.default({key:"css"}),r=n.flush,a=n.hydrate,s=n.cx,o=n.merge,l=n.getRegisteredStyles,h=n.injectGlobal,c=n.keyframes,u=n.css,p=n.sheet,d=n.cache;e.exports.cache=d,e.exports.css=u,e.exports.cx=s,e.exports.flush=r,e.exports.getRegisteredStyles=l,e.exports.hydrate=a,e.exports.injectGlobal=h,e.exports.keyframes=c,e.exports.merge=o,e.exports.sheet=p}),A("8O5Y2",function(e,t){var i=I("8KHnw");Object.defineProperty(e.exports,"__esModule",{value:!0});var n=I("exBzs"),r=I("csvAs"),a=I("5zE8f"),s=n&&n.__esModule?n:{default:n};function o(e,t){if(void 0===e.inserted[t.name])return e.insert("",t,e.sheet,!0)}function l(e,t,i){var n=[],r=a.getRegisteredStyles(e,n,i);return n.length<2?i:r+t(n)}var h=function e(t){for(var n="",r=0;r<t.length;r++){var a=t[r];if(null!=a){var s=void 0;switch(void 0===a?"undefined":(0,i._)(a)){case"boolean":break;case"object":if(Array.isArray(a))s=e(a);else for(var o in s="",a)a[o]&&o&&(s&&(s+=" "),s+=o);break;default:s=a}s&&(n&&(n+=" "),n+=s)}}return n};e.exports.default=function(e){var t=s.default(e);t.sheet.speedy=function(e){this.isSpeedy=e},t.compat=!0;var i=function(){for(var e=arguments.length,i=Array(e),n=0;n<e;n++)i[n]=arguments[n];var s=r.serializeStyles(i,t.registered,void 0);return a.insertStyles(t,s,!1),t.key+"-"+s.name};return{css:i,cx:function(){for(var e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];return l(t.registered,i,h(n))},injectGlobal:function(){for(var e=arguments.length,i=Array(e),n=0;n<e;n++)i[n]=arguments[n];var a=r.serializeStyles(i,t.registered);o(t,a)},keyframes:function(){for(var e=arguments.length,i=Array(e),n=0;n<e;n++)i[n]=arguments[n];var a=r.serializeStyles(i,t.registered),s="animation-"+a.name;return o(t,{name:a.name,styles:"@keyframes "+s+"{"+a.styles+"}"}),s},hydrate:function(e){e.forEach(function(e){t.inserted[e]=!0})},flush:function(){t.registered={},t.inserted={},t.sheet.flush()},sheet:t.sheet,cache:t,getRegisteredStyles:a.getRegisteredStyles.bind(null,t.registered),merge:l.bind(null,t.registered,i)}}}),A("exBzs",function(t,i){Object.defineProperty(t.exports,"__esModule",{value:!0,configurable:!0}),e(t.exports,"default",function(){return u});var n=I("hkMbk"),r=I("ikgWV");I("gZ0tz"),I("8ClKM");var a=function(e,t,i){for(var n=0,a=0;n=a,a=(0,r.peek)(),38===n&&12===a&&(t[i]=1),!(0,r.token)(a);)(0,r.next)();return(0,r.slice)(e,r.position)},s=function(e,t){var i=-1,n=44;do switch((0,r.token)(n)){case 0:38===n&&12===(0,r.peek)()&&(t[i]=1),e[i]+=a(r.position-1,t,i);break;case 2:e[i]+=(0,r.delimit)(n);break;case 4:if(44===n){e[++i]=58===(0,r.peek)()?"&\f":"",t[i]=e[i].length;break}default:e[i]+=(0,r.from)(n)}while(n=(0,r.next)())return e},o=new WeakMap,l=function(e){if("rule"===e.type&&e.parent&&!(e.length<1)){for(var t=e.value,i=e.parent,n=e.column===i.column&&e.line===i.line;"rule"!==i.type;)if(!(i=i.parent))return;if((1!==e.props.length||58===t.charCodeAt(0)||o.get(i))&&!n){o.set(e,!0);for(var a=[],l=(0,r.dealloc)(s((0,r.alloc)(t),a)),h=i.props,c=0,u=0;c<l.length;c++)for(var p=0;p<h.length;p++,u++)e.props[u]=a[c]?l[c].replace(/&\f/g,h[p]):h[p]+" "+l[c]}}},h=function(e){if("decl"===e.type){var t=e.value;108===t.charCodeAt(0)&&98===t.charCodeAt(2)&&(e.return="",e.value="")}},c=[function(e,t,i,n){if(e.length>-1&&!e.return)switch(e.type){case r.DECLARATION:e.return=function e(t,i){switch((0,r.hash)(t,i)){case 5103:return r.WEBKIT+"print-"+t+t;case 5737:case 4201:case 3177:case 3433:case 1641:case 4457:case 2921:case 5572:case 6356:case 5844:case 3191:case 6645:case 3005:case 6391:case 5879:case 5623:case 6135:case 4599:case 4855:case 4215:case 6389:case 5109:case 5365:case 5621:case 3829:return r.WEBKIT+t+t;case 5349:case 4246:case 4810:case 6968:case 2756:return r.WEBKIT+t+r.MOZ+t+r.MS+t+t;case 6828:case 4268:return r.WEBKIT+t+r.MS+t+t;case 6165:return r.WEBKIT+t+r.MS+"flex-"+t+t;case 5187:return r.WEBKIT+t+(0,r.replace)(t,/(\w+).+(:[^]+)/,r.WEBKIT+"box-$1$2"+r.MS+"flex-$1$2")+t;case 5443:return r.WEBKIT+t+r.MS+"flex-item-"+(0,r.replace)(t,/flex-|-self/,"")+t;case 4675:return r.WEBKIT+t+r.MS+"flex-line-pack"+(0,r.replace)(t,/align-content|flex-|-self/,"")+t;case 5548:return r.WEBKIT+t+r.MS+(0,r.replace)(t,"shrink","negative")+t;case 5292:return r.WEBKIT+t+r.MS+(0,r.replace)(t,"basis","preferred-size")+t;case 6060:return r.WEBKIT+"box-"+(0,r.replace)(t,"-grow","")+r.WEBKIT+t+r.MS+(0,r.replace)(t,"grow","positive")+t;case 4554:return r.WEBKIT+(0,r.replace)(t,/([^-])(transform)/g,"$1"+r.WEBKIT+"$2")+t;case 6187:return(0,r.replace)((0,r.replace)((0,r.replace)(t,/(zoom-|grab)/,r.WEBKIT+"$1"),/(image-set)/,r.WEBKIT+"$1"),t,"")+t;case 5495:case 3959:return(0,r.replace)(t,/(image-set\([^]*)/,r.WEBKIT+"$1$`$1");case 4968:return(0,r.replace)((0,r.replace)(t,/(.+:)(flex-)?(.*)/,r.WEBKIT+"box-pack:$3"+r.MS+"flex-pack:$3"),/s.+-b[^;]+/,"justify")+r.WEBKIT+t+t;case 4095:case 3583:case 4068:case 2532:return(0,r.replace)(t,/(.+)-inline(.+)/,r.WEBKIT+"$1$2")+t;case 8116:case 7059:case 5753:case 5535:case 5445:case 5701:case 4933:case 4677:case 5533:case 5789:case 5021:case 4765:if((0,r.strlen)(t)-1-i>6)switch((0,r.charat)(t,i+1)){case 109:if(45!==(0,r.charat)(t,i+4))break;case 102:return(0,r.replace)(t,/(.+:)(.+)-([^]+)/,"$1"+r.WEBKIT+"$2-$3$1"+r.MOZ+(108==(0,r.charat)(t,i+3)?"$3":"$2-$3"))+t;case 115:return~(0,r.indexof)(t,"stretch")?e((0,r.replace)(t,"stretch","fill-available"),i)+t:t}break;case 4949:if(115!==(0,r.charat)(t,i+1))break;case 6444:switch((0,r.charat)(t,(0,r.strlen)(t)-3-(~(0,r.indexof)(t,"!important")&&10))){case 107:return(0,r.replace)(t,":",":"+r.WEBKIT)+t;case 101:return(0,r.replace)(t,/(.+:)([^;!]+)(;|!.+)?/,"$1"+r.WEBKIT+(45===(0,r.charat)(t,14)?"inline-":"")+"box$3$1"+r.WEBKIT+"$2$3$1"+r.MS+"$2box$3")+t}break;case 5936:switch((0,r.charat)(t,i+11)){case 114:return r.WEBKIT+t+r.MS+(0,r.replace)(t,/[svh]\w+-[tblr]{2}/,"tb")+t;case 108:return r.WEBKIT+t+r.MS+(0,r.replace)(t,/[svh]\w+-[tblr]{2}/,"tb-rl")+t;case 45:return r.WEBKIT+t+r.MS+(0,r.replace)(t,/[svh]\w+-[tblr]{2}/,"lr")+t}return r.WEBKIT+t+r.MS+t+t}return t}(e.value,e.length);break;case r.KEYFRAMES:return(0,r.serialize)([(0,r.copy)(e,{value:(0,r.replace)(e.value,"@","@"+r.WEBKIT)})],n);case r.RULESET:if(e.length)return(0,r.combine)(e.props,function(t){switch((0,r.match)(t,/(::plac\w+|:read-\w+)/)){case":read-only":case":read-write":return(0,r.serialize)([(0,r.copy)(e,{props:[(0,r.replace)(t,/:(read-\w+)/,":"+r.MOZ+"$1")]})],n);case"::placeholder":return(0,r.serialize)([(0,r.copy)(e,{props:[(0,r.replace)(t,/:(plac\w+)/,":"+r.WEBKIT+"input-$1")]}),(0,r.copy)(e,{props:[(0,r.replace)(t,/:(plac\w+)/,":"+r.MOZ+"$1")]}),(0,r.copy)(e,{props:[(0,r.replace)(t,/:(plac\w+)/,r.MS+"input-$1")]})],n)}return""})}}],u=function(e){var t,i,a,s=e.key;if("css"===s){var o=document.querySelectorAll("style[data-emotion]:not([data-s])");Array.prototype.forEach.call(o,function(e){-1!==e.getAttribute("data-emotion").indexOf(" ")&&(document.head.appendChild(e),e.setAttribute("data-s",""))})}var u=e.stylisPlugins||c,p={},d=[];t=e.container||document.head,Array.prototype.forEach.call(document.querySelectorAll('style[data-emotion^="'+s+' "]'),function(e){for(var t=e.getAttribute("data-emotion").split(" "),i=1;i<t.length;i++)p[t[i]]=!0;d.push(e)});var g=[r.stringify,(0,r.rulesheet)(function(e){a.insert(e)})],f=(0,r.middleware)([l,h].concat(u,g));i=function(e,t,i,n){var s;a=i,s=e?e+"{"+t.styles+"}":t.styles,(0,r.serialize)((0,r.compile)(s),f),n&&(v.inserted[t.name]=!0)};var v={key:s,sheet:new n.StyleSheet({key:s,container:t,nonce:e.nonce,speedy:e.speedy,prepend:e.prepend,insertionPoint:e.insertionPoint}),nonce:e.nonce,inserted:p,registered:{},insert:i};return v.sheet.hydrate(d),v}}),A("hkMbk",function(t,i){e(t.exports,"StyleSheet",function(){return n});var n=function(){function e(e){var t=this;this._insertTag=function(e){var i;i=0===t.tags.length?t.insertionPoint?t.insertionPoint.nextSibling:t.prepend?t.container.firstChild:t.before:t.tags[t.tags.length-1].nextSibling,t.container.insertBefore(e,i),t.tags.push(e)},this.isSpeedy=void 0===e.speedy||e.speedy,this.tags=[],this.ctr=0,this.nonce=e.nonce,this.key=e.key,this.container=e.container,this.prepend=e.prepend,this.insertionPoint=e.insertionPoint,this.before=null}var t=e.prototype;return t.hydrate=function(e){e.forEach(this._insertTag)},t.insert=function(e){if(this.ctr%(this.isSpeedy?65e3:1)==0){var t;this._insertTag(((t=document.createElement("style")).setAttribute("data-emotion",this.key),void 0!==this.nonce&&t.setAttribute("nonce",this.nonce),t.appendChild(document.createTextNode("")),t.setAttribute("data-s",""),t))}var i=this.tags[this.tags.length-1];if(this.isSpeedy){var n=function(e){if(e.sheet)return e.sheet;for(var t=0;t<document.styleSheets.length;t++)if(document.styleSheets[t].ownerNode===e)return document.styleSheets[t]}(i);try{n.insertRule(e,n.cssRules.length)}catch(e){}}else i.appendChild(document.createTextNode(e));this.ctr++},t.flush=function(){this.tags.forEach(function(e){return e.parentNode&&e.parentNode.removeChild(e)}),this.tags=[],this.ctr=0},e}()}),A("ikgWV",function(t,i){e(t.exports,"MS",function(){return n}),e(t.exports,"MOZ",function(){return r}),e(t.exports,"WEBKIT",function(){return a}),e(t.exports,"RULESET",function(){return o}),e(t.exports,"DECLARATION",function(){return l}),e(t.exports,"KEYFRAMES",function(){return h}),e(t.exports,"from",function(){return u}),e(t.exports,"hash",function(){return d}),e(t.exports,"charat",function(){return m}),e(t.exports,"match",function(){return g}),e(t.exports,"replace",function(){return f}),e(t.exports,"indexof",function(){return v}),e(t.exports,"strlen",function(){return x}),e(t.exports,"combine",function(){return B}),e(t.exports,"position",function(){return S}),e(t.exports,"copy",function(){return T}),e(t.exports,"next",function(){return M}),e(t.exports,"peek",function(){return L}),e(t.exports,"slice",function(){return R}),e(t.exports,"token",function(){return P}),e(t.exports,"alloc",function(){return O}),e(t.exports,"dealloc",function(){return D}),e(t.exports,"delimit",function(){return z}),e(t.exports,"compile",function(){return _}),e(t.exports,"serialize",function(){return V}),e(t.exports,"stringify",function(){return H}),e(t.exports,"middleware",function(){return W}),e(t.exports,"rulesheet",function(){return X});var n="-ms-",r="-moz-",a="-webkit-",s="comm",o="rule",l="decl",h="@keyframes",c=Math.abs,u=String.fromCharCode,p=Object.assign;function d(e,t){return 45^m(e,0)?(((t<<2^m(e,0))<<2^m(e,1))<<2^m(e,2))<<2^m(e,3):0}function g(e,t){return(e=t.exec(e))?e[0]:e}function f(e,t,i){return e.replace(t,i)}function v(e,t){return e.indexOf(t)}function m(e,t){return 0|e.charCodeAt(t)}function y(e,t,i){return e.slice(t,i)}function x(e){return e.length}function b(e,t){return t.push(e),e}function B(e,t){return e.map(t).join("")}var w=1,k=1,C=0,S=0,E=0,I="";function A(e,t,i,n,r,a,s){return{value:e,root:t,parent:i,type:n,props:r,children:a,line:w,column:k,length:s,return:""}}function T(e,t){return p(A("",null,null,"",null,null,0),e,{length:-e.length},t)}function M(){return E=S<C?m(I,S++):0,k++,10===E&&(k=1,w++),E}function L(){return m(I,S)}function R(e,t){return y(I,e,t)}function P(e){switch(e){case 0:case 9:case 10:case 13:case 32:return 5;case 33:case 43:case 44:case 47:case 62:case 64:case 126:case 59:case 123:case 125:return 4;case 58:return 3;case 34:case 39:case 40:case 91:return 2;case 41:case 93:return 1}return 0}function O(e){return w=k=1,C=x(I=e),S=0,[]}function D(e){return I="",e}function z(e){return R(S-1,function e(t){for(;M();)switch(E){case t:return S;case 34:case 39:34!==t&&39!==t&&e(E);break;case 40:41===t&&e(t);break;case 92:M()}return S}(91===e?e+2:40===e?e+1:e)).trim()}function _(e){return D(function e(t,i,n,r,a,o,l,h,c){for(var p,d=0,g=0,B=l,C=0,T=0,O=0,D=1,_=1,V=1,H=0,W="",X=a,N=o,Y=r,U=W;_;)switch(O=H,H=M()){case 40:if(108!=O&&58==m(U,B-1)){-1!=v(U+=f(z(H),"&","&\f"),"&\f")&&(V=-1);break}case 34:case 39:case 91:U+=z(H);break;case 9:case 10:case 13:case 32:U+=function(e){for(;E=L();)if(E<33)M();else break;return P(e)>2||P(E)>3?"":" "}(O);break;case 92:U+=function(e,t){for(;--t&&M()&&!(E<48)&&!(E>102)&&(!(E>57)||!(E<65))&&(!(E>70)||!(E<97)););return R(e,S+(t<6&&32==L()&&32==M()))}(S-1,7);continue;case 47:switch(L()){case 42:case 47:b(A(p=function(e,t){for(;M();)if(e+E===57)break;else if(e+E===84&&47===L())break;return"/*"+R(t,S-1)+"*"+u(47===e?e:M())}(M(),S),i,n,s,u(E),y(p,2,-2),0),c);break;default:U+="/"}break;case 123*D:h[d++]=x(U)*V;case 125*D:case 59:case 0:switch(H){case 0:case 125:_=0;case 59+g:-1==V&&(U=f(U,/\f/g,"")),T>0&&x(U)-B&&b(T>32?F(U+";",r,n,B-1):F(f(U," ","")+";",r,n,B-2),c);break;case 59:U+=";";default:if(b(Y=j(U,i,n,d,g,a,h,W,X=[],N=[],B),o),123===H){if(0===g)e(U,i,Y,Y,X,o,B,h,N);else switch(99===C&&110===m(U,3)?100:C){case 100:case 108:case 109:case 115:e(t,Y,Y,r&&b(j(t,Y,Y,0,0,a,h,W,a,X=[],B),N),a,N,B,h,r?X:N);break;default:e(U,Y,Y,Y,[""],N,0,h,N)}}}d=g=T=0,D=V=1,W=U="",B=l;break;case 58:B=1+x(U),T=O;default:if(D<1){if(123==H)--D;else if(125==H&&0==D++&&125==(E=S>0?m(I,--S):0,k--,10===E&&(k=1,w--),E))continue}switch(U+=u(H),H*D){case 38:V=g>0?1:(U+="\f",-1);break;case 44:h[d++]=(x(U)-1)*V,V=1;break;case 64:45===L()&&(U+=z(M())),C=L(),g=B=x(W=U+=function(e){for(;!P(L());)M();return R(e,S)}(S)),H++;break;case 45:45===O&&2==x(U)&&(D=0)}}return o}("",null,null,null,[""],e=O(e),0,[0],e))}function j(e,t,i,n,r,a,s,l,h,u,p){for(var d=r-1,g=0===r?a:[""],v=g.length,m=0,x=0,b=0;m<n;++m)for(var B=0,w=y(e,d+1,d=c(x=s[m])),k=e;B<v;++B)(k=(x>0?g[B]+" "+w:f(w,/&\f/g,g[B])).trim())&&(h[b++]=k);return A(e,t,i,0===r?o:l,h,u,p)}function F(e,t,i,n){return A(e,t,i,l,y(e,0,n),y(e,n+1,-1),n)}function V(e,t){for(var i="",n=e.length,r=0;r<n;r++)i+=t(e[r],r,e,t)||"";return i}function H(e,t,i,n){switch(e.type){case"@layer":if(e.children.length)break;case"@import":case l:return e.return=e.return||e.value;case s:return"";case h:return e.return=e.value+"{"+V(e.children,n)+"}";case o:e.value=e.props.join(",")}return x(i=V(e.children,n))?e.return=e.value+"{"+i+"}":""}function W(e){var t=e.length;return function(i,n,r,a){for(var s="",o=0;o<t;o++)s+=e[o](i,n,r,a)||"";return s}}function X(e){return function(t){!t.root&&(t=t.return)&&e(t)}}}),A("gZ0tz",function(e,t){}),A("8ClKM",function(t,i){e(t.exports,"default",function(){return n});function n(e){var t=Object.create(null);return function(i){return void 0===t[i]&&(t[i]=e(i)),t[i]}}}),A("csvAs",function(t,i){e(t.exports,"serializeStyles",function(){return v});var n,r=I("8KHnw"),a=I("3worW"),s=I("1gYqP"),o=I("8ClKM"),l=/[A-Z]|^ms/g,h=/_EMO_([^_]+?)_([^]*?)_EMO_/g,c=function(e){return 45===e.charCodeAt(1)},u=function(e){return null!=e&&"boolean"!=typeof e},p=(0,o.default)(function(e){return c(e)?e:e.replace(l,"-$&").toLowerCase()}),d=function(e,t){switch(e){case"animation":case"animationName":if("string"==typeof t)return t.replace(h,function(e,t,i){return n={name:t,styles:i,next:n},t})}return 1===s.default[e]||c(e)||"number"!=typeof t||0===t?t:t+"px"};function g(e,t,i){if(null==i)return"";if(void 0!==i.__emotion_styles)return i;switch(void 0===i?"undefined":(0,r._)(i)){case"boolean":return"";case"object":if(1===i.anim)return n={name:i.name,styles:i.styles,next:n},i.name;if(void 0!==i.styles){var a=i.next;if(void 0!==a)for(;void 0!==a;)n={name:a.name,styles:a.styles,next:n},a=a.next;return i.styles+";"}return function(e,t,i){var n="";if(Array.isArray(i))for(var r=0;r<i.length;r++)n+=g(e,t,i[r])+";";else for(var a in i){var s=i[a];if("object"!=typeof s)null!=t&&void 0!==t[s]?n+=a+"{"+t[s]+"}":u(s)&&(n+=p(a)+":"+d(a,s)+";");else if(Array.isArray(s)&&"string"==typeof s[0]&&(null==t||void 0===t[s[0]]))for(var o=0;o<s.length;o++)u(s[o])&&(n+=p(a)+":"+d(a,s[o])+";");else{var l=g(e,t,s);switch(a){case"animation":case"animationName":n+=p(a)+":"+l+";";break;default:n+=a+"{"+l+"}"}}}return n}(e,t,i);case"function":if(void 0!==e){var s=n,o=i(e);return n=s,g(e,t,o)}}if(null==t)return i;var l=t[i];return void 0!==l?l:i}var f=/label:\s*([^\s;\n{]+)\s*(;|$)/g,v=function(e,t,i){if(1===e.length&&"object"==typeof e[0]&&null!==e[0]&&void 0!==e[0].styles)return e[0];var r,s=!0,o="";n=void 0;var l=e[0];null==l||void 0===l.raw?(s=!1,o+=g(i,t,l)):o+=l[0];for(var h=1;h<e.length;h++)o+=g(i,t,e[h]),s&&(o+=l[h]);f.lastIndex=0;for(var c="";null!==(r=f.exec(o));)c+="-"+r[1];return{name:(0,a.default)(o)+c,styles:o,next:n}}}),A("3worW",function(t,i){e(t.exports,"default",function(){return n});function n(e){for(var t,i=0,n=0,r=e.length;r>=4;++n,r-=4)t=(65535&(t=255&e.charCodeAt(n)|(255&e.charCodeAt(++n))<<8|(255&e.charCodeAt(++n))<<16|(255&e.charCodeAt(++n))<<24))*1540483477+((t>>>16)*59797<<16),t^=t>>>24,i=(65535&t)*1540483477+((t>>>16)*59797<<16)^(65535&i)*1540483477+((i>>>16)*59797<<16);switch(r){case 3:i^=(255&e.charCodeAt(n+2))<<16;case 2:i^=(255&e.charCodeAt(n+1))<<8;case 1:i^=255&e.charCodeAt(n),i=(65535&i)*1540483477+((i>>>16)*59797<<16)}return i^=i>>>13,(((i=(65535&i)*1540483477+((i>>>16)*59797<<16))^i>>>15)>>>0).toString(36)}}),A("1gYqP",function(t,i){e(t.exports,"default",function(){return n});var n={animationIterationCount:1,aspectRatio:1,borderImageOutset:1,borderImageSlice:1,borderImageWidth:1,boxFlex:1,boxFlexGroup:1,boxOrdinalGroup:1,columnCount:1,columns:1,flex:1,flexGrow:1,flexPositive:1,flexShrink:1,flexNegative:1,flexOrder:1,gridRow:1,gridRowEnd:1,gridRowSpan:1,gridRowStart:1,gridColumn:1,gridColumnEnd:1,gridColumnSpan:1,gridColumnStart:1,msGridRow:1,msGridRowSpan:1,msGridColumn:1,msGridColumnSpan:1,fontWeight:1,lineHeight:1,opacity:1,order:1,orphans:1,tabSize:1,widows:1,zIndex:1,zoom:1,WebkitLineClamp:1,fillOpacity:1,floodOpacity:1,stopOpacity:1,strokeDasharray:1,strokeDashoffset:1,strokeMiterlimit:1,strokeOpacity:1,strokeWidth:1}}),A("5zE8f",function(t,i){function n(e,t,i){var n="";return i.split(" ").forEach(function(i){void 0!==e[i]?t.push(e[i]+";"):n+=i+" "}),n}e(t.exports,"getRegisteredStyles",function(){return n}),e(t.exports,"insertStyles",function(){return a});var r=function(e,t,i){var n=e.key+"-"+t.name;!1===i&&void 0===e.registered[n]&&(e.registered[n]=t.styles)},a=function(e,t,i){r(e,t,i);var n=e.key+"-"+t.name;if(void 0===e.inserted[t.name]){var a=t;do e.insert(t===a?"."+n:"",a,e.sheet,!0),a=a.next;while(void 0!==a)}}}),A("6BHwO",function(e,t){e.exports=I("ih7W4")(I("2evKT").resolve("kNYzr")).then(function(){return I("2m2jt")})}),A("9I1T6",function(e,t){e.exports=I("ih7W4")(I("2evKT").resolve("62mlz")).then(function(){return I("17YSH")})}),A("iaSvl",function(e,t){e.exports=I("ih7W4")(I("2evKT").resolve("76QQo")).then(function(){return I("evhrb")})});var L=I("8KHnw");function R(e,t){var i,n,r,a,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(o){return function(l){return function(o){if(i)throw TypeError("Generator is already executing.");for(;a&&(a=0,o[0]&&(s=0)),s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=(r=s.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}}"function"==typeof SuppressedError&&SuppressedError;var P=I("8N5YG");if(!function(){function e(){var e=Array.prototype.slice.call(arguments),t=document.createDocumentFragment();e.forEach(function(e){var i=e instanceof Node;t.appendChild(i?e:document.createTextNode(String(e)))}),this.appendChild(t)}[Element.prototype,Document.prototype,DocumentFragment.prototype].forEach(function(t){t.hasOwnProperty("append")||Object.defineProperty(t,"append",{configurable:!0,enumerable:!0,writable:!0,value:e})})}(),!function(){function e(){var e=Array.prototype.slice.call(arguments),t=document.createDocumentFragment();e.forEach(function(e){var i=e instanceof Node;t.appendChild(i?e:document.createTextNode(String(e)))}),this.insertBefore(t,this.firstChild)}[Element.prototype,Document.prototype,DocumentFragment.prototype].forEach(function(t){t.hasOwnProperty("prepend")||Object.defineProperty(t,"prepend",{configurable:!0,enumerable:!0,writable:!0,value:e})})}(),String.prototype.padStart||(String.prototype.padStart=function(e,t){return e>>=0,t=String(t||" "),this.length>e?String(this):((e-=this.length)>t.length&&(t+=t.repeat(e/t.length)),t.slice(0,e)+String(this))}),Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(e){if(null==this)throw TypeError('"this" is null or not defined');var t=Object(this),i=t.length>>>0;if("function"!=typeof e)throw TypeError("predicate must be a function");for(var n=arguments[1],r=0;r<i;){var a=t[r];if(e.call(n,a,r,t))return r;r++}return -1}}),"scrollTo"in Element.prototype||Object.defineProperty(Element.prototype,"scrollTo",{value:function(e,t){this.scrollLeft=e,this.scrollTop=t}}),"scrollBy"in Element.prototype||Object.defineProperty(Element.prototype,"scrollBy",{value:function(e,t){this.scrollLeft+=e,this.scrollTop+=t}}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function e(){for(var t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];var r=isNaN(i[0])?1:Number(i[0]);return r?Array.prototype.reduce.call(this,function(t,i){return Array.isArray(i)?t.push.apply(t,e.call(i,r-1)):t.push(i),t},[]):Array.prototype.slice.call(this)},writable:!0}),String.prototype.replaceAll||Object.defineProperty(String.prototype,"replaceAll",{value:function(e,t){if("function"==typeof t)throw Error("replaceAll polyfill does not support replaceValue: function");return this.replace(RegExp(e,"g"),t)}}),Object.fromEntries||Object.defineProperty(Object,"fromEntries",{value:function(e){if(!e||!e[Symbol.iterator])throw Error("Object.fromEntries() requires a single iterable argument");var t={};return Object.keys(e).forEach(function(i){var n=(0,P._)(e[i],2),r=n[0],a=n[1];t[r]=a}),t}}),!("localStorage"in window))try{window.localStorage={getItem:function(){return null},setItem:function(){},removeItem:function(){}}}catch(e){}var O=I("cx0mh"),D=I("7h4XF"),z=I("bX4ja"),_=I("7jh4K"),j=!1,F=function(){function e(){(0,O._)(this,e)}return(0,D._)(e,[{key:"pause",value:function(){}},{key:"addListener",value:function(){}},{key:"push",value:function(){}},{key:"undo",value:function(){return[]}},{key:"redo",value:function(){}},{key:"getAll",value:function(){return[]}},{key:"canRedo",value:function(){return!1}},{key:"canUndo",value:function(){return!1}},{key:"getState",value:function(){return 0}},{key:"getActionNumber",value:function(){return 0}}]),e}(),V=new(function(){function e(){if((0,O._)(this,e),this.max=20,j)throw Error("klHistory already instantiated");j=!0,this.state=0,this.entries=[],this.listeners=[],this.pauseStack=0,this.maxState=-1,this.actionNumber=-1}return(0,D._)(e,[{key:"broadcast",value:function(e){var t=this;setTimeout(function(){for(var i=0;i<t.listeners.length;i++)t.listeners[i](e);t.state++},1)}},{key:"pause",value:function(e){e?this.pauseStack++:this.pauseStack=Math.max(0,this.pauseStack-1)}},{key:"addListener",value:function(e){this.listeners.push(e)}},{key:"push",value:function(e){if(!(this.pauseStack>0)){for(;this.actionNumber<this.entries.length-1;)this.entries.pop();var t=this.entries[this.entries.length-1];if(t&&"canvas"===e.tool[0]&&"canvas"===t.tool[0]&&"layerOpacity"===e.action&&"layerOpacity"===t.action&&t.params[0]===e.params[0]){this.entries[this.entries.length-1]=e,this.state++;return}if(t&&"canvas"===e.tool[0]&&"canvas"===t.tool[0]&&"setLayerIsVisible"===e.action&&"setLayerIsVisible"===t.action&&t.params[0]===e.params[0]&&t.params[1]!=e.params[1]){this.entries.pop(),this.actionNumber--,this.state++,this.broadcast(null);return}if("focusLayer"===e.action&&t&&"focusLayer"===t.action){this.entries[this.entries.length-1]=e,this.state++;return}this.entries[this.entries.length]=e,this.actionNumber=this.entries.length-1;var i=this.maxState;if(this.maxState=Math.max(this.maxState,this.actionNumber-this.max),i<this.maxState){var n=this.entries[this.maxState];if(!n)throw Error("this.dataArr[this.maxState] null");this.broadcast({bufferUpdate:n})}else this.broadcast(null);this.maxState>=0&&(this.entries[this.maxState]=null)}}},{key:"undo",value:function(){var e=[];if(!this.canUndo())return e;for(var t=this.maxState+1;t<this.actionNumber;t++)e.push((0,_.throwIfNull)(this.entries[t]));return this.actionNumber--,this.broadcast(null),e}},{key:"redo",value:function(){if(this.canRedo())return this.actionNumber++,this.broadcast(null),(0,_.throwIfNull)(this.entries[this.actionNumber])}},{key:"getAll",value:function(){return(0,z._)(this.entries)}},{key:"canRedo",value:function(){return this.actionNumber<this.entries.length-1}},{key:"canUndo",value:function(){return this.actionNumber>this.maxState}},{key:"getState",value:function(){return this.state}},{key:"getActionNumber",value:function(){return this.actionNumber+1}}]),e}()),O=I("cx0mh"),D=I("7h4XF"),H=new(function(){function e(){(0,O._)(this,e),this.listeners=[],this.count=0}return(0,D._)(e,[{key:"emit",value:function(){var e=this;this.listeners.forEach(function(t){t(e.count)})}},{key:"increase",value:function(e){void 0!==e?this.count+=e:this.count++,this.emit()}},{key:"decrease",value:function(e){void 0!==e?this.count-=e:this.count--,this.emit()}},{key:"get",value:function(){return this.count}},{key:"subscribe",value:function(e){this.listeners.push(e)}}]),e}()),W=I("eWjiX"),O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),N=t(JSON.parse('{"switch-ui-left-right":"Switch left/right UI","toggle-show-tools":"Show/Hide Tools","scroll":"Scroll","donate":"Donate","home":"Home","modal-new-tab":"Open in new tab","tab-edit":"Edit","tab-file":"File","tool-brush":"Brush","tool-paint-bucket":"Paint Bucket","tool-gradient":"Gradient","tool-shape":"Shape","tool-text":"Text","tool-hand":"Hand Tool","tool-zoom":"Zoom","undo":"Undo","redo":"Redo","brush-pen":"Pen","brush-blend":"Blend","brush-sketchy":"Sketchy","brush-pixel":"Pixel","brush-chemy":"Chemy","brush-smudge":"Smudge","brush-size":"Size","brush-blending":"Blending","brush-toggle-pressure":"Toggle Pressure Sensitivity","brush-pen-circle":"Circle","brush-pen-chalk":"Chalk","brush-pen-calligraphy":"Calligraphy","brush-pen-square":"Square","brush-sketchy-scale":"Scale","brush-pixel-dither":"Dither","brush-chemy-fill":"Fill","brush-chemy-stroke":"Stroke","brush-chemy-mirror-x":"Horizontal Symmetry","brush-chemy-mirror-y":"Vertical Symmetry","brush-chemy-gradient":"Gradient","brush-eraser-transparent-bg":"Transparent Background","stabilizer":"Stabilizer","stabilizer-title":"Stroke Stabilizer","eyedropper":"Eyedropper","secondary-color":"Secondary Color","manual-color-input":"Manual Color Input","mci-hex":"Hex","mci-copy":"Copy","modal-ok":"Ok","modal-cancel":"Cancel","modal-close":"Close","layers-active-layer":"Active Layer","layers-layer":"Layer","layers-copy":"copy","layers-blending":"Blending","layers-new":"New Layer","layers-remove":"Remove Layer","layers-duplicate":"Duplicate Layer","layers-merge":"Merge with layer below","layers-merge-all":"Merge all","layers-rename":"Rename","layers-active-layer-visible":"Active layer is visible","layers-active-layer-hidden":"Active layer is hidden","layers-visibility-toggle":"Layer Visibility","layers-blend-normal":"normal","layers-blend-darken":"darken","layers-blend-multiply":"multiply","layers-blend-color-burn":"color burn","layers-blend-lighten":"lighten","layers-blend-screen":"screen","layers-blend-color-dodge":"color dodge","layers-blend-overlay":"overlay","layers-blend-soft-light":"soft light","layers-blend-hard-light":"hard light","layers-blend-difference":"difference","layers-blend-exclusion":"exclusion","layers-blend-hue":"hue","layers-blend-saturation":"saturation","layers-blend-color":"color","layers-blend-luminosity":"luminosity","layers-rename-title":"Rename Layer","layers-rename-name":"Name","layers-rename-clear":"Clear Name","layers-rename-sketch":"Sketch","layers-rename-colors":"Colors","layers-rename-shading":"Shading","layers-rename-lines":"Lines","layers-rename-effects":"Effects","layers-rename-foreground":"Foreground","layers-merge-modal-title":"Merge/Mix Layers","layers-merge-description":"Merges the selected layer with the one underneath. Select the mix mode:","file-no-autosave":"No autosave, no cloud storage","file-new":"New","file-import":"Import","file-save":"Save","file-format":"File Format","file-copy":"Copy","file-copy-title":"Copy To Clipboard","file-share":"Share","file-storage":"Browser Storage","file-storage-thumb-title":"Restores when reopening page","file-storage-about":"About Browser Storage","file-storage-cant-access":"Can\'t access","file-storage-empty":"Empty","file-storage-store":"Store","file-storage-clear":"Clear","file-storage-storing":"Storing","file-storage-overwrite":"Overwrite","file-storage-min-ago":"{x}min ago","file-storage-hours-ago":"{x}h ago","file-storage-days-ago":"{x}d ago","file-storage-month-ago":"> 1month ago","file-storage-restored":"Restored from Browser Storage","file-storage-stored":"Stored to Browser Storage","file-storage-failed":"Failed to store to Browser Storage","file-storage-failed-1":"Failed to store. Possible causes:","file-storage-failed-2":"Out of disk space","file-storage-failed-3":"Storage disabled in incognito tab","file-storage-failed-4":"Browser doesn\'t support storage","file-storage-failed-clear":"Failed to clear.","file-upload":"Upload","cleared-layer":"Cleared layer","filled":"Filled","new-title":"New Image","new-current":"Current","new-fit":"Fit","new-oversize":"Oversize","new-square":"Square","new-landscape":"Landscape","new-portrait":"Portrait","new-screen":"Screen","new-video":"Video","new-din-paper":"DIN Paper","new-px":"px","new-ratio":"Ratio","upload-title":"Upload to Imgur","upload-link-notice":"Anyone with the link to your uploaded image will be able to view it.","upload-name":"Title","upload-title-untitled":"Untitled","upload-caption":"Caption","upload-submit":"Upload","upload-uploading":"Uploading...","upload-success":"Upload Successful","upload-failed":"Upload failed.","upload-delete":"To delete your image from Imgur visit:","cropcopy-title-copy":"Copy To Clipboard","cropcopy-title-crop":"Crop","cropcopy-click-hold":"Right-click or press hold to copy.","cropcopy-btn-copy":"To Clipboard","cropcopy-copied":"Copied.","cropcopy-btn-crop":"Apply Crop","crop-drag-to-crop":"Drag to crop","filter-crop-extend":"Crop/Extend","filter-flip":"Flip","filter-perspective":"Perspective","filter-resize":"Resize","filter-rotate":"Rotate","filter-transform":"Transform","filter-bright-contrast":"Bright/Contrast","filter-curves":"Curves","filter-hue-sat":"Hue/Saturation","filter-invert":"Invert","filter-tilt-shift":"Tilt Shift","filter-to-alpha":"To Alpha","filter-triangle-blur":"Triangle Blur","filter-unsharp-mask":"Unsharp Mask","filter-crop-title":"Crop / Extend","filter-crop-description":"Crop or extend the image.","filter-crop-left":"Left","filter-crop-right":"Right","filter-crop-top":"Top","filter-crop-bottom":"Bottom","filter-crop-rule-thirds":"Rule of Thirds","filter-crop-fill":"Fill","filter-flip-title":"Flip","filter-flip-description":"Flips layer or whole image.","filter-flip-horizontal":"Horizontal","filter-flip-vertical":"Vertical","filter-flip-image":"Flip Image","filter-flip-layer":"Flip Layer","filter-perspective-title":"Perspective","filter-perspective-description":"Transforms the selected layer.","filter-resize-title":"Resize","filter-resize-description":"Resizes the image.","filter-rotate-title":"Rotate","filter-rotate-description":"Rotates the image.","filter-transform-empty":"Layer is empty.","filter-transform-title":"Transform","filter-transform-description":"Transforms selected layer. Hold Shift for additional behavior.","filter-transform-rotation":"Rotation","filter-transform-flip":"Flip","filter-transform-center":"Center","filter-transform-constrain":"Constrain","filter-transform-snap":"Snap","filter-transform-snap-title":"Snap Rotation And Position","filter-bright-contrast-title":"Brightness / Contrast","filter-bright-contrast-description":"Change brightness and contrast for the selected layer.","filter-bright-contrast-brightness":"Brightness","filter-bright-contrast-contrast":"Contrast","filter-curves-title":"Curves","filter-curves-description":"Apply curves on the selected layer.","filter-curves-all":"All","filter-hue-sat-title":"Hue / Saturation","filter-hue-sat-description":"Change hue and saturation for the selected layer.","filter-hue-sat-hue":"Hue","filter-hue-sat-saturation":"Saturation","filter-applied":"applied","filter-tilt-shift-title":"Tilt Shift","filter-tilt-shift-description":"Applies tilt shift on the selected layer.","filter-tilt-shift-blur":"Blur Radius","filter-tilt-shift-gradient":"Gradient Radius","filter-to-alpha-title":"To Alpha","filter-to-alpha-description":"Generates alpha channel for selected layer from:","filter-to-alpha-inverted-lum":"Inverted Luminance","filter-to-alpha-lum":"Luminance","filter-to-alpha-replace":"Replace RGB","filter-triangle-blur-title":"Triangle Blur","filter-triangle-blur-description":"Applies triangle blur on the selected layer.","filter-unsharp-mask-title":"Unsharp Mask","filter-unsharp-mask-description":"Sharpens the selected layer by scaling pixels away from the average of their neighbors.","filter-unsharp-mask-strength":"Strength","filter-grid":"Grid","filter-grid-description":"Draws grid on selected layer.","filter-noise":"Noise","filter-noise-description":"Adds noise to selected layer.","filter-noise-scale":"Scale","filter-noise-alpha":"Alpha","filter-pattern":"Pattern","filter-pattern-description":"Generates pattern on selected layer. Drag the preview for further controls.","filter-distort":"Distort","filter-distort-description":"Distorts the selected layer.","filter-distort-phase":"Phase","filter-distort-stepsize":"Step Size","filter-distort-sync-xy":"Sync XY","filter-vanish-point":"Vanish Point","filter-vanish-point-title":"Vanishing Point","filter-vanish-point-description":"Adds vanishing point to selected layer. Drag preview to move.","filter-vanish-point-lines":"Lines","import-opening":"Opening file...","import-title":"Import Image","import-too-large":"Image too large, will be downscaled.","import-btn-as-layer":"As Layer","import-btn-as-image":"As Image","import-as-layer-title":"Import Image as New Layer","import-as-layer-description":"Adjust the position of the imported image.","import-as-layer-limit-reached":"Layer limit reached. Image will be placed on existing layer.","import-as-layer-fit":"Fit","import-flatten":"Flatten image","import-unsupported-file":"Unsupported file type. See Help for supported types.","import-broken-file":"Couldn\'t load image. File might be corrupted.","import-psd-unsupported":"Unsupported features. PSD had to be flattened.","import-psd-limited-support":"PSD support is limited. Flattened will more likely look correct.","import-psd-too-large":"Image exceeds maximum dimensions of {x} x {x} pixels. Unable to import.","import-psd-size":"Image size","hand-reset":"Reset","hand-fit":"Fit","bucket-tolerance":"Tolerance","bucket-sample":"Sample","bucket-sample-title":"Which layers to sample color from","bucket-sample-all":"All","bucket-sample-active":"Active","bucket-sample-above":"Above","bucket-grow":"Grow","bucket-grow-title":"Grow filled area (in pixels)","bucket-contiguous":"Contiguous","bucket-contiguous-title":"Only fill connected areas","gradient-linear":"Linear","gradient-linear-mirror":"Linear-Mirror","gradient-radial":"Radial","shape-stroke":"Stroke","shape-fill":"Fill","shape-rect":"Rectangle","shape-ellipse":"Ellipse","shape-line":"Line","shape-line-width":"Line Width","shape-outwards":"Outwards","shape-fixed":"Fixed 1:1","text-instruction":"Click canvas to place text","text-title":"Add Text","text-text":"Text","text-font":"Font","text-placeholder":"Your text","text-color":"Color","text-size":"Size","text-line-height":"Line Height","text-letter-spacing":"Letter Spacing","text-left":"Left","text-center":"Center","text-right":"Right","text-italic":"Italic","text-bold":"Bold","save-reminder-title":"Unsaved Work","save-reminder-text":"Image was not saved in {a} minutes{b}. Save now to prevent eventual loss.","save-reminder-save-psd":"Save As PSD","save-reminder-psd-layers":"PSD will remember all layers.","backup-drawing":"You can backup your drawing.","submit":"Submit","submit-title":"Submit Drawing","submit-prompt":"Submit drawing?","submit-submitting":"Submitting","embed-init-loading":"Loading app","embed-init-waiting":"Waiting for image","unsaved":"Unsaved","help":"Help","tab-settings":"Settings","settings-language":"Language","settings-language-reload":"Will update after reloading.","settings-theme":"Theme","settings-save-reminder-label":"Save Reminder","settings-save-reminder-disabled":"disabled","settings-save-reminder-confirm-title":"Turn off Save Reminder?","settings-save-reminder-confirm-a":"There is no autosave and browser tabs don\'t last forever. If you don\'t periodically save you will likely lose work.","settings-save-reminder-confirm-b":"Disable at your own risk?","settings-save-reminder-confirm-disable":"Disable","theme-dark":"Dark","theme-light":"Light","terms-of-service":"Terms of Service","licenses":"Licenses","source-code":"Source Code","auto":"auto","zoom-in":"Zoom In","zoom-out":"Zoom Out","radius":"Radius","constrain-proportions":"Constrain Proportions","width":"Width","height":"Height","opacity":"Opacity","red":"Red","green":"Green","blue":"Blue","eraser":"Eraser","center":"Center","layers":"Layers","background":"Background","scaling-algorithm":"Scaling Algorithm","algorithm-smooth":"Smooth","algorithm-pixelated":"Pixelated","preview":"Preview","angle-snap":"Snap","angle-snap-title":"45 Angle Snapping","lock-alpha":"Lock Alpha","lock-alpha-title":"Locks layer\'s alpha channel","reverse":"Reverse","compare-before":"Before","compare-after":"After","loading":"Loading","more":"More","x-minutes":"{x}min"}')),Y=[{code:"en",name:"English"},{code:"de",name:"Deutsch"},{code:"fr",name:"Franais"},{code:"ja",name:""},{code:"ko",name:""},{code:"ru",name:""},{code:"zh-CN",name:""},{code:"zh-TW",name:""}],U=(i=M(function(e){return R(this,function(t){switch(t.label){case 0:if("en"!==e)return[3,1];return[2,N];case 1:if("de"!==e)return[3,3];return[4,I("eRyuE")];case 2:case 4:case 6:case 8:case 10:case 12:case 14:return[2,t.sent()];case 3:if("fr"!==e)return[3,5];return[4,I("6swkM")];case 5:if("ja"!==e)return[3,7];return[4,I("bMRjr")];case 7:if("ko"!==e)return[3,9];return[4,I("6AvxN")];case 9:if("ru"!==e)return[3,11];return[4,I("lSwOy")];case 11:if("zh-CN"!==e)return[3,13];return[4,I("hKOuy")];case 13:if("zh-TW"!==e)return[3,15];return[4,I("d3Z79")];case 15:throw Error("unknown language code")}})}),function(e){return i.apply(this,arguments)}),G="klecks-language",K=function(){function e(){(0,O._)(this,e),this.listeners=[],this.data=(0,X._)({},N),this.code="en"}return(0,D._)(e,[{key:"setLanguage",value:function(e){var t=this;return M(function(){var i;return R(this,function(n){switch(n.label){case 0:if("en"!==e)return[3,1];return t.data=(0,X._)({},N),[3,3];case 1:return i=[{},N],[4,U(e)];case 2:t.data=(0,X._).apply(void 0,i.concat([n.sent()])),n.label=3;case 3:return t.code=e,document.documentElement.setAttribute("lang",e),t.listeners.forEach(function(e){e()}),[2]}})})()}},{key:"get",value:function(e){if(!(e in this.data))throw Error("translation code doesn't exist: "+e);return this.data[e]}},{key:"getLanguage",value:function(){var e=this;return Y.find(function(t){return t.code===e.code})}},{key:"getAutoLanguage",value:function(){var e=q(!1);return Y.find(function(t){return t.code===e})}},{key:"getCode",value:function(){return this.code}},{key:"subscribe",value:function(e){this.listeners.includes(e)||this.listeners.push(e)}},{key:"unsubscribe",value:function(e){for(var t=0;t<this.listeners.length;t++)if(e===this.listeners[t]){this.listeners.splice(t,1);return}}}]),e}();function q(e){var t="en",i=[];if((navigator.languages?navigator.languages:[navigator.language]).forEach(function(e){var t=e.split("-");i.push(e),2===t.length&&i.push(t[0])}),e)try{var n=localStorage.getItem(G);n&&i.unshift(n)}catch(e){}for(var r=0;r<i.length&&"break"!==function(e){var n=i[e],r=Y.find(function(e){return e.code.toLowerCase()===n.toLowerCase()});if(r)return t=r.code,"break"}(r);r++);return t}var Q=q(!0),Z=new K,J=function(e,t){if(!t)return Z.get(e);var i=Z.get(e);return Object.keys(t).forEach(function(e){i=i.replace("{".concat(e,"}"),t[e])}),i};window.onscroll=function(e){e.preventDefault()};var $={};$=I("f6OTe").getBundleURL("lYbF2")+"cancel.5edb67d5.svg";var ee={};function et(e){H.increase();var i,n,r=!1,a=!!e.ignoreBackground,s=(0,W.BB).el({parent:document.body,css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",overflow:"hidden"}}),o=(0,W.BB).el({parent:s,className:"kl-popup"}),l=(0,W.BB).el({parent:o,css:{width:"100%",minHeight:"100%",position:"relative",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}}),h=(0,W.BB).el({parent:l,onClick:function(){a||y("Cancel")},css:{position:"absolute",left:"0",top:"0",zIndex:"0",width:"100%",height:"100%"}}),c=(0,W.BB).el({tagName:"button",className:"popup-x",content:'<img alt="'.concat(J("modal-close"),'" height="20" src="').concat(t($),'">'),title:J("modal-close"),onClick:function(){y("Cancel")},css:{width:"40px",height:"40px",lineHeight:"40px",position:"absolute",right:"0",top:"0",background:"none",boxShadow:"none"}}),u=void 0;e.type&&(u=(0,W.BB).el({className:{error:"kl-popup__icon-error",ok:"kl-popup__icon-ok",warning:"kl-popup__icon-warning",upload:"kl-popup__icon-upload"}[e.type]}));var p=["kl-popup-box"];p.push("kl-popup-box--sm");var d=(0,W.BB).el({content:[c,u,(0,W.BB).el({content:e.message,css:{marginRight:"15px",marginBottom:e.div?"10px":void 0}}),e.div],className:p.join(" "),css:e.style?e.style:void 0});l.append((0,W.BB).el({css:{flex:"0.5"}}),d,(0,W.BB).el({css:{flex:"1"}}));var g=new W.BB.KeyListener({onDown:function(e,t,i){r||(n&&"enter"===i&&!(0,W.BB).isInputFocused()&&(t.stopPropagation(),setTimeout(function(){n&&n.click()},10)),"esc"===i&&(t.stopPropagation(),y("Cancel")))}}),f=function(e){g.isPressed("ctrl")&&e.preventDefault()};o.addEventListener("wheel",f),o.onclick=W.BB.handleClick,i=e.autoFocus?e.autoFocus:!1===e.autoFocus?void 0:"Ok";var v=e.buttons&&e.buttons.length>0?(0,W.BB).el({parent:d,css:{display:"flex",flexWrap:"wrap",justifyContent:"flex-end",marginTop:"12px",marginLeft:"-8px"}}):void 0,m=[];function y(t){!r&&(r=!0,(0,W.BB).clearSelection(),(0,W.BB).unfocusAnyInput(),s.remove(),H.decrease(),(0,W.BB).destroyEl(c),(0,W.BB).destroyEl(h),g.destroy(),o.removeEventListener("wheel",f),o.onclick=null,m.forEach(function(e){return(0,W.BB).destroyEl(e)}),m.splice(0,m.length),e.callback&&e.callback(t))}return e.buttons&&e.buttons.forEach(function(r){var a,s=["kl-popup__btn"];("Ok"===r||e.primaries&&e.primaries.includes(r))&&s.push("kl-button-primary");var l=r;"Ok"===r&&(l=J("modal-ok"),a=t(ee)),"Cancel"===r&&(l=J("modal-cancel"),a=t($),s.push("kl-button-cancel"));var h=void 0;a&&(h=(0,W.BB).el({tagName:"img",custom:{src:a,height:"17"}}));var c=(0,W.BB).el({parent:v,tagName:"button",className:s.join(" "),content:[h,(0,W.BB).el({className:"kl-popup__btn__text",content:l})],onClick:function(){y(r)}});m.push(c),i===r&&(setTimeout(function(){c.focus(),o.scrollTo(0,0)},10),setTimeout(function(){o.scrollTo(0,0)},20)),r===e.clickOnEnter&&(n=c)}),e.closeFunc&&e.closeFunc(function(){y("Cancel")}),{setIgnoreBackground:function(e){a=e}}}ee=I("f6OTe").getBundleURL("lYbF2")+"check.42e17e77.svg";var O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),ei=function(){function e(i){var n=this;(0,O._)(this,e),H.increase(),this.onClose=i.onClose,this.parent=document.body,this.rootEl=(0,W.BB).el({parent:this.parent,className:"g-root kl-d-modal-root",css:{position:"fixed",left:"0",top:"0",bottom:"0",right:"0",overflow:"auto",animationName:"consoleIn",animationDuration:"0.3s",animationTimingFunction:"ease-out"},onClick:W.BB.handleClick}),this.bgEl=(0,W.BB).el({parent:this.rootEl,css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0"},onClick:function(){return n.close()}});var r=(0,W.BB).el({parent:this.rootEl,className:"kl-d-modal",css:{position:"absolute",width:(0,W.BB).isCssMinMaxSupported()?"min(calc(100% - 40px), "+(i.width?i.width:400)+"px)":(i.width?i.width:400)+"px",height:"calc(100% - 40px)",borderRadius:"10px",overflow:"hidden"}});this.updatePos=function(){var e=r.offsetWidth,t=r.offsetHeight;(0,W.BB).css(r,{left:Math.max(0,(window.innerWidth-e)/2)+"px",top:Math.max(20,(window.innerHeight-t)/2-.2*t)+"px"})},this.updatePos(),window.addEventListener("resize",this.updatePos);var a=(0,W.BB).el({parent:r,css:{height:"40px",display:"flex",justifyContent:"space-between",alignItems:"center",paddingLeft:"20px"}});i.title&&a.append(i.title),this.xButton=(0,W.BB).el({parent:a,tagName:"button",className:"popup-x",content:'<img alt="'.concat(J("modal-close"),'" height="20" src="').concat(t($),'">'),title:J("modal-close"),onClick:function(){return n.close()},css:{width:"40px",height:"40px",lineHeight:"40px",background:"none",boxShadow:"none"},custom:{tabindex:"0"}});var s=(0,W.BB).el({parent:r,css:{height:"calc(100% - 40px)"}});i.content&&s.append(i.content),this.keyListener=new W.BB.KeyListener({onDown:function(e,t){"esc"===e&&(t.stopPropagation(),n.close())}})}return(0,D._)(e,[{key:"close",value:function(){H.decrease(),(0,W.BB).destroyEl(this.rootEl),this.rootEl.remove(),window.removeEventListener("resize",this.updatePos),this.keyListener.destroy(),(0,W.BB).destroyEl(this.xButton),(0,W.BB).destroyEl(this.bgEl),this.onClose&&this.onClose()}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),en=function(){function e(t){var i=this;(0,O._)(this,e),this.doHighlight=!!t.doHighlight,this.element=(0,W.BB).el({className:"kl-checkbox"});var n=(0,W.BB).el({parent:this.element,tagName:"label",className:"kl-checkbox__inner",css:{display:"flex"}});this.check=(0,W.BB).el({parent:n,tagName:"input",css:{margin:"0 5px 0 0"},custom:{type:"checkbox"}}),this.check.checked=!!t.init,this.doHighlight&&this.check.checked&&this.element.classList.add("kl-checkbox--highlight"),t.allowTab||(this.check.tabIndex=-1),t.title&&(n.title=t.title),(0,W.BB).el({parent:n,content:t.label,css:{}}).allowClick=!0,this.check.onchange=function(){i.doHighlight&&i.element.classList.toggle("kl-checkbox--highlight",i.check.checked),t.callback&&t.callback(i.check.checked),setTimeout(function(){i.check.blur()},0)},t.css&&(0,W.BB).css(this.element,t.css)}return(0,D._)(e,[{key:"getValue",value:function(){return this.check.checked}},{key:"setValue",value:function(e){this.check.checked=!!e,this.doHighlight&&this.element.classList.toggle("kl-checkbox--highlight",this.check.checked)}},{key:"getElement",value:function(){return this.element}},{key:"destroy",value:function(){this.check.onchange=null}}]),e}(),er=I("dJPtW"),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),ea=function(){function e(t){var i=this;(0,O._)(this,e),this.optionArr=[],this.selectEl=(0,W.BB).el({tagName:"select",title:t.title,className:"kl-select",css:{cursor:"pointer",fontSize:"15px",padding:"3px"}}),t.css&&(0,W.BB).css(this.selectEl,t.css);var n=t.isFocusable;n||(this.selectEl.tabIndex=-1),this.setOptionArr(t.optionArr),t.onChange&&(this.onChange=t.onChange),this.changeListener=function(){n||i.selectEl.blur(),i.onChange&&i.onChange(i.getValue())},this.selectEl.addEventListener("change",this.changeListener),this.selectEl.value=void 0!==t.initValue?t.initValue:""}return(0,D._)(e,[{key:"setValue",value:function(e){this.selectEl.value=void 0===e?"":e}},{key:"getValue",value:function(){return this.selectEl.value}},{key:"setDeltaValue",value:function(e){for(var t=0,i=0;i<this.optionArr.length;i++){var n=this.optionArr[i];if(n.item&&""+n.item[0]===this.selectEl.value){t=i;break}}t=Math.max(0,Math.min(this.optionArr.length-1,t+e));var r=this.optionArr[t];this.selectEl.value=r.item?r.item[0]:"",this.onChange&&this.onChange(this.getValue())}},{key:"getElement",value:function(){return this.selectEl}},{key:"updateLabel",value:function(e,t){this.optionArr.forEach(function(i){i.item&&i.item[0]===e&&i.el&&(i.item[1]=t,i.el.textContent=i.item[1])})}},{key:"setOptionArr",value:function(e){this.optionArr=[],this.selectEl.innerHTML="";for(var t=0;t<e.length;t++){var i=e[t];if(!i){this.optionArr.push({item:i});continue}var n=document.createElement("option");n.value=i[0],n.textContent=i[1],i[2]&&(0,W.BB).css(n,i[2].css),this.optionArr.push({item:i,el:n}),this.selectEl.append(n)}}},{key:"destroy",value:function(){this.selectEl.removeEventListener("change",this.changeListener)}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),es=function(){function e(t){var i=this;(0,O._)(this,e),this.isActive=!!t.initValue,this.rootEl=(0,W.BB).el({className:"image-toggle",title:t.title,content:(0,W.BB).el({className:"image-toggle__im"+(t.darkInvert?" dark-invert":""),css:{backgroundImage:"url('"+t.image+"')"}}),onClick:function(e){e.preventDefault(),t.isRadio&&i.isActive||(i.isActive=!i.isActive,i.update(),t.onChange(i.isActive))}}),this.update()}return(0,D._)(e,[{key:"update",value:function(){this.rootEl.classList.toggle("image-toggle-active",this.isActive)}},{key:"setValue",value:function(e){this.isActive=!!e,this.update()}},{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.isActive}},{key:"destroy",value:function(){(0,W.BB).destroyEl(this.rootEl)}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),eo=function(){function e(t){var i,n=this;(0,O._)(this,e),this.rootEl=(0,W.BB).el({className:"image-radio-wrapper",css:{display:"flex"}}),this.optionArr=[];for(var r=function(e,i){n.activeIndex=e;for(var r=0;r<n.optionArr.length;r++)n.optionArr[r].radioEl.setValue(r===n.activeIndex);t.onChange(i)},a=function(e,a){a.id===t.initId&&(i=e);var s=new es({image:a.image,title:a.title,initValue:a.id===t.initId,isRadio:!0,onChange:function(){r(e,a.id)},darkInvert:a.darkInvert});return n.rootEl.append(s.getElement()),{id:a.id,radioEl:s}},s=0;s<t.optionArr.length;s++)this.optionArr.push(a(s,t.optionArr[s]));if(void 0===i)throw Error("initId not in optionArr");this.activeIndex=i}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.optionArr[this.activeIndex].id}},{key:"destroy",value:function(){this.optionArr.forEach(function(e){e.radioEl.destroy()})}}]),e}(),W=I("eWjiX"),el={};el=I("f6OTe").getBundleURL("lYbF2")+"brush-pressure.f4437531.svg";var O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),eh=function(){function e(t){var i=this;(0,O._)(this,e),this.value=!!t.init,this.el=(0,W.BB).el({content:t.label,title:t.title,className:"string"==typeof t.label?"kl-box-toggle":"kl-box-toggle kl-box-toggle--custom-el",onClick:function(){i.value=!i.value,i.update(),t.onChange(i.value)},css:{cursor:"pointer"}}),"string"!=typeof t.label&&(0,W.BB).css(t.label,{display:"block",pointerEvents:"none"}),this.update()}return(0,D._)(e,[{key:"update",value:function(){this.el.classList.toggle("kl-box-toggle--active",this.value)}},{key:"getValue",value:function(){return this.value}},{key:"setValue",value:function(e){this.value=!!e,this.update()}},{key:"getElement",value:function(){return this.el}},{key:"destroy",value:function(){(0,W.BB).destroyEl(this.el)}}]),e}(),ec=function(e,i){return new eh({label:(0,W.BB).el({className:"dark-invert",css:{width:"17px",height:"17px",backgroundImage:'url("'+t(el)+'")',backgroundSize:"contain",backgroundRepeat:"no-repeat",margin:"1px",borderRadius:"3px"}}),title:J("brush-toggle-pressure"),init:e,onChange:function(e){i(e)}}).getElement()},O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX");function eu(e,t){var i=Math.min(10,1+Math.pow(Math.floor(e/50),2));return t&&(i*=2),1/i}var O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),er=I("dJPtW"),ep=function(){function e(t,i,n,r,a,s,o){var l,h=this;(0,O._)(this,e),this.onChange=a,this.onClose=s,this.isEnabled=!0,this.isClosed=!1,this.input=(0,er.input)({type:"number",init:t,min:i,max:n,callback:function(e){h.emit()}}),0!==o&&this.input.setAttribute("step","any"),this.input.onblur=function(){h.privateOnClose()},this.input.addEventListener("keyup",function(e){["Enter","Escape"].includes(e.key)?h.privateOnClose():h.emit()}),this.input.addEventListener("wheel",function(){return h.emit()}),this.scrollBefore={x:window.scrollX,y:window.scrollY},l=o||0===o?(0,W.BB).round(t,o):t,this.lastValue=l,this.input.value=""+l,(0,W.BB).css(this.input,{width:r.width+"px",height:r.height+"px"})}return(0,D._)(e,[{key:"emit",value:function(){this.lastValue!==Number(this.input.value)&&(this.onChange(Number(this.input.value)),this.lastValue=Number(this.input.value))}},{key:"privateOnClose",value:function(){var e=this;this.isClosed||(this.isClosed=!0,this.emit(),this.onClose(),setTimeout(function(){e.scrollBefore&&window.scrollTo(e.scrollBefore.x,e.scrollBefore.y),e.scrollBefore=void 0}))}},{key:"getElement",value:function(){return this.input}},{key:"setIsEnabled",value:function(e){this.isEnabled=!!e}},{key:"focus",value:function(){this.input.focus(),this.input.select()}},{key:"destroy",value:function(){(0,W.BB).destroyEl(this.input)}}]),e}(),ed=function(){function e(t){var i,n=this;if((0,O._)(this,e),this.isEnabled=!1!==t.isEnabled,this.manualInputRoundDigits=t.manualInputRoundDigits,this.useSpline=!!t.curve,!t.label)throw Error("KlSlider missing params");if(0!=t.min&&0!=t.max&&0!=t.value&&(!t.min||!t.max||!t.value)||t.min>=t.max)throw Error("KlSlider broken params");if(this.min=t.min,this.max=t.max,this.value=(0,W.BB).clamp(t.value,this.min,this.max),this.elementWidth=t.width,this.elementHeight=t.height,this.resolution=t.resolution?t.resolution:2*this.elementWidth,this.onChange=t.onChange?t.onChange:function(){},!t.toValue!=!t.toDisplayValue)throw Error("both or neither have to be set, toValue and toDisplayValue");if(this.displayValueToValue=t.toValue?t.toValue:function(e){return e},this.valueToDisplayValue=t.toDisplayValue?t.toDisplayValue:function(e){return e},this.isChangeOnFinal=!!t.isChangeOnFinal,this.formatFunc=t.formatFunc,this.eventResMs=t.eventResMs,this.unit=t.unit,this.useSpline){if(!t.curve)throw Error("curve needs to be set if useSpline true");var r="quadratic"===t.curve?(0,W.BB).quadraticSplineInput(this.min,this.max,.1):t.curve;this.splineInterpolator=new W.BB.SplineInterpolator(r)}this.rootEl=(0,W.BB).el({css:{display:"flex"}}),this.sliderWrapperEl=(0,W.BB).el({parent:this.rootEl,className:"slider-wrapper",css:{overflow:"hidden",position:"relative",width:this.elementWidth+"px",height:this.elementHeight+"px",userSelect:"none"}}),this.rootEl.oncontextmenu=function(){return!1},this.label=t.label;var a=this.elementHeight-14;this.textEl=(0,W.BB).el({content:this.label,css:{position:"absolute",display:"flex",alignItems:"center",marginLeft:"7px",height:"100%",fontSize:a+"px",pointerEvents:"none"}}),this.control=(0,W.BB).el({className:"slider-inner",css:{position:"absolute",left:"0",top:"0",width:this.valueToSliderValue(this.value)*this.elementWidth+"px",height:this.elementHeight+"px"}});var s=document.createElement("div");this.sliderWrapperEl.append(this.control,this.textEl),this.control.append(s),this.updateEnable();var o=new W.BB.DoubleTapper({onDoubleTap:function(){n.showManualInput()}});o.setAllowedButtonArr(["left","right"]);var l=new W.BB.EventChain({chainArr:[o]}),h=function(e){if(e.eventPreventDefault(),n.isEnabled){if("pointerdown"===e.type){if((0,W.BB).unfocusAnyInput(),n.sliderWrapperEl.className="slider-wrapper slider-wrapper--active","left"===e.button){var t=e.relX/n.elementWidth;t=Math.max(0,Math.min(1,t)),n.value=n.sliderValueToValue(t),n.updateLabel(),n.emit(!1)}i=n.valueToSliderValue(n.value)}if("pointermove"===e.type&&["left","right"].includes(e.button||"")){var r=e.dX;r*=eu(Math.abs(e.pageY-(e.downPageY||0)),"right"===e.button),r/=n.elementWidth;var a=Math.max(0,Math.min(1,i+=r));n.value=n.sliderValueToValue(a),n.updateLabel(),n.emit(!1)}"pointerup"===e.type&&(n.sliderWrapperEl.className="slider-wrapper",n.emit(!0))}};this.pointerListenerTimeout=setTimeout(function(){n.pointerListener=new W.BB.PointerListener({target:n.sliderWrapperEl,fixScribble:!0,onPointer:function(e){h(e),l.chainIn(e)},onWheel:function(e){var t=n.valueToSliderValue(n.value);t=(0,W.BB).clamp(t-e.deltaY/40,0,1),n.value=n.sliderValueToValue(t),n.updateLabel(),n.onChange(n.value)}}),n.updateLabel()},1)}return(0,D._)(e,[{key:"valueToSliderValue",value:function(e){return this.useSpline&&this.splineInterpolator?this.splineInterpolator.findX(e,Math.floor(this.resolution))||0:(e-this.min)/(this.max-this.min)}},{key:"sliderValueToValue",value:function(e){var t=this.min+e*(this.max-this.min);return this.useSpline&&this.splineInterpolator&&(t=this.splineInterpolator.interpolate(e)||0),t}},{key:"updateLabel",value:function(){var e=this.valueToDisplayValue(this.value);e=(e=this.formatFunc?this.formatFunc(e):Math.round(e)).toLocaleString(Z.getCode());var t=void 0!==this.unit?this.unit:"";this.textEl.innerHTML=this.label+'&nbsp;&nbsp;<span style="font-weight:bold">'+e+t+"</span>";var i=this.valueToSliderValue(this.value);this.control.style.width=i*this.elementWidth+"px"}},{key:"emit",value:function(e){var t=this;if(e||!this.isChangeOnFinal){if(e||!this.eventResMs){this.onChange(this.value),this.emitInterval&&(clearInterval(this.emitInterval),this.emitInterval=void 0);return}this.emitInterval?this.emitValue=this.value:(this.onChange(this.value),this.emitInterval=setInterval(function(){void 0===t.emitValue?(clearInterval(t.emitInterval),t.emitInterval=void 0):(t.onChange(t.emitValue),t.emitValue=void 0)},this.eventResMs))}}},{key:"updateEnable",value:function(){this.sliderWrapperEl.classList.toggle("slider-wrapper--disabled",!this.isEnabled),(0,W.BB).css(this.sliderWrapperEl,{opacity:this.isEnabled?"":"0.5",pointerEvents:this.isEnabled?"":"none"}),this.manualInput&&this.manualInput.setIsEnabled(this.isEnabled)}},{key:"showManualInput",value:function(){var e=this;this.manualInput=new ep(this.valueToDisplayValue(this.value),this.valueToDisplayValue(this.min),this.valueToDisplayValue(this.max),this.sliderWrapperEl.getBoundingClientRect(),function(t){t=e.displayValueToValue(t),e.setValue((0,W.BB).clamp(t,e.min,e.max)),e.onChange(e.value)},function(){(0,W.BB).css(e.sliderWrapperEl,{display:""}),e.manualInput&&(e.manualInput.getElement().remove(),e.manualInput.destroy()),e.manualInput=void 0},this.manualInputRoundDigits&&this.manualInputRoundDigits>0?this.manualInputRoundDigits:0),this.manualInput.setIsEnabled(this.isEnabled),this.rootEl.append(this.manualInput.getElement()),setTimeout(function(){e.manualInput&&e.manualInput.focus()}),(0,W.BB).css(this.sliderWrapperEl,{display:"none"})}},{key:"changeSliderValue",value:function(e){if(this.isEnabled){var t=this.valueToSliderValue(this.value);t=(0,W.BB).clamp(t+e,0,1),this.value=this.sliderValueToValue(t),this.updateLabel(),this.onChange(this.value)}}},{key:"setValue",value:function(e){this.value=(0,W.BB).clamp(e,this.min,this.max),this.updateLabel()}},{key:"getValue",value:function(){return this.value}},{key:"update",value:function(e){if(this.min=e.min,this.max=e.max,this.useSpline=!!e.curve,this.useSpline){if(!e.curve)throw Error("curve needs to be set if useSpline true");var t="quadratic"===e.curve?(0,W.BB).quadraticSplineInput(this.min,this.max,.1):e.curve;this.splineInterpolator=new W.BB.SplineInterpolator(t)}else this.splineInterpolator=void 0;this.setIsEnabled(!e.isDisabled)}},{key:"setIsEnabled",value:function(e){this.isEnabled=!!e,this.updateEnable()}},{key:"destroy",value:function(){clearTimeout(this.pointerListenerTimeout),this.pointerListener&&this.pointerListener.destroy(),this.manualInput&&this.manualInput.destroy(),this.emitInterval&&clearInterval(this.emitInterval)}},{key:"getElement",value:function(){return this.rootEl}}]),e}(),O=I("cx0mh"),W=I("eWjiX"),er=I("dJPtW"),eg={};eg=I("f6OTe").getBundleURL("lYbF2")+"copy.4adadd0c.svg";var z=I("bX4ja"),W=I("eWjiX"),ef=I("72Jv0");function ev(e,t){if(void 0===e)return document.createElement("div");if("string"!=typeof e)return e instanceof HTMLElement||(e=(0,ef.el)(e)),t&&("string"==typeof t?e.innerHTML=t:(s=e).append.apply(s,(0,z._)(t))),e;var i,n,r,a,s,o,l=function(e){if(""===e)return{};var t,i,n=[];1===(t=e.split(".")).length?i=(t=t[0].split(",")).shift():(i=t.shift(),t.forEach(function(e,i){if(i===t.length-1){var r=(t=e.split(",")).shift();void 0!==r&&n.push(r)}else n.push(e)}));var r={};return""!==i&&(r.tagName=i),n.length>0&&(r.classes=n),t.length>0&&(r.styles=t),r}(e),h=document.createElement(null!==(o=l.tagName)&&void 0!==o?o:"div");return l.classes&&(a=h.classList).add.apply(a,(0,z._)(l.classes)),l.styles&&(i=l.styles,n={},r={c:function(e){n.color=e[0]},bg:function(e){n.background=e[0]},p:function(e){n.padding=e[0]+"px"},py:function(e){n.paddingTop=e[0]+"px",n.paddingBottom=e[0]+"px"},pt:function(e){n.paddingTop=e[0]+"px"},pr:function(e){n.paddingRight=e[0]+"px"},pb:function(e){n.paddingBottom=e[0]+"px"},pl:function(e){n.paddingLeft=e[0]+"px"},mt:function(e){n.marginTop=e[0]+"px"},mr:function(e){n.marginRight=e[0]+"px"},mb:function(e){n.marginBottom=e[0]+"px"},ml:function(e){n.marginLeft=e[0]+"px"},flex:function(){n.display="flex"},flexCol:function(){n.flexDirection="column"},flexWrap:function(){n.flexWrap="wrap"},gap:function(e){n.gap=e.map(function(e){return e+"px"}).join(" ")},grow:function(){n.flexGrow="1"},justify:function(e){n.justifyContent=e[0]},items:function(e){n.alignItems=e[0]},hidden:function(){n.display="none"},nowrap:function(){n.whiteSpace="nowrap"},abs:function(e){n.position="absolute",n.left=e[0]+"px",n.top=e[1]+"px"},w:function(e){n.width="full"===e[0]?"100%":e[0]+"px"},h:function(e){n.height="full"===e[0]?"100%":e[0]+"px"},minh:function(e){n.minHeight=e[0]+"px"},z:function(e){n.zIndex=e[0]},overflow:function(e){n.overflow=e[0]},pos:function(e){n.position=e[0]},left:function(e){n.left="full"===e[0]?"100%":e[0]+"px"},top:function(e){n.top="full"===e[0]?"100%":e[0]+"px"},right:function(e){n.right="full"===e[0]?"100%":e[0]+"px"},bottom:function(e){n.bottom="full"===e[0]?"100%":e[0]+"px"},size:function(e){n.fontSize=e[0]+"px"},pointer:function(e){n.pointerEvents=e[0]}},i.forEach(function(e){var t=e.split("-");r[t.shift()](t)}),(0,W.BB).css(h,n)),t&&("string"==typeof t?h.innerHTML=t:h.append.apply(h,(0,z._)(t))),h}var L=I("8KHnw"),em=I("exBzs"),ey=I("csvAs"),ex=I("5zE8f");function eb(e,t){if(void 0===e.inserted[t.name])return e.insert("",t,e.sheet,!0)}function eB(e,t,i){var n=[],r=(0,ex.getRegisteredStyles)(e,n,i);return n.length<2?i:r+t(n)}var ew=function e(t){for(var i="",n=0;n<t.length;n++){var r=t[n];if(null!=r){var a=void 0;switch(void 0===r?"undefined":(0,L._)(r)){case"boolean":break;case"object":if(Array.isArray(r))a=e(r);else for(var s in a="",r)r[s]&&s&&(a&&(a+=" "),a+=s);break;default:a=r}a&&(i&&(i+=" "),i+=a)}}return i};I("exBzs"),I("csvAs"),I("5zE8f");var ek=(n={key:"css"},(r=(0,em.default)(n)).sheet.speedy=function(e){this.isSpeedy=e},r.compat=!0,{css:a=function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=(0,ey.serializeStyles)(t,r.registered,void 0);return(0,ex.insertStyles)(r,n,!1),r.key+"-"+n.name},cx:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return eB(r.registered,a,ew(t))},injectGlobal:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=(0,ey.serializeStyles)(t,r.registered);eb(r,n)},keyframes:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=(0,ey.serializeStyles)(t,r.registered),a="animation-"+n.name;return eb(r,{name:n.name,styles:"@keyframes "+a+"{"+n.styles+"}"}),a},hydrate:function(e){e.forEach(function(e){r.inserted[e]=!0})},flush:function(){r.registered={},r.inserted={},r.sheet.flush()},sheet:r.sheet,cache:r,getRegisteredStyles:(0,ex.getRegisteredStyles).bind(null,r.registered),merge:eB.bind(null,r.registered,a)}),eC=(ek.flush,ek.hydrate,ek.cx,ek.merge,ek.getRegisteredStyles,ek.injectGlobal,ek.keyframes,ek.css);ek.sheet,ek.cache;var eS=function e(i){(0,O._)(this,e);var n=function(e,t){var i=(0,er.input)({init:r[t],min:0,max:255,type:"number",css:{width:"80px"},callback:function(){if(""===i.value||0>parseFloat(i.value)||parseFloat(i.value)>255){n.update();return}i.value=""+Math.round(parseFloat(i.value)),r[t]=Number(i.value),a.style.background="#"+(0,W.BB).ColorConverter.toHexString(r),o.value="#"+(0,W.BB).ColorConverter.toHexString(r)}}),n={update:function(){i.value=""+r[t]},destroy:function(){(0,W.BB).unsetEventHandler(i,"onchange")},element:ev("tr",[ev("td,pr-10",e),ev("td",[i])])};return n},r=new W.BB.RGB(i.color.r,i.color.g,i.color.b),a=(0,W.BB).el({css:{width:"20px",height:"20px",marginBottom:"10px",boxShadow:"inset 0 0 0 1px #fff, 0 0 0 1px #000",background:"#"+(0,W.BB).ColorConverter.toHexString(r)}}),s=(0,W.BB).el({content:J("mci-hex")}),o=(0,er.input)({init:"#"+(0,W.BB).ColorConverter.toHexString(r),css:{width:"80px"},callback:function(){var e=(0,W.BB).ColorConverter.hexToRGB(o.value);e?r=e:(e=r,o.value="#"+(0,W.BB).ColorConverter.toHexString(r)),a.style.background="#"+(0,W.BB).ColorConverter.toHexString(e);for(var t=0;t<c.length;t++)c[t].update()}}),l=(0,W.BB).el({tagName:"button",content:'<img src="'+t(eg)+'" height="20" alt=""/>',title:J("mci-copy"),onClick:function(){o.select(),navigator.clipboard.writeText(o.value).then().catch()}}),h=ev({css:{display:"flex",alignItems:"center",marginBottom:"15px",flexWrap:"wrap",gap:"5px 10px",maxWidth:"250px"}},[s,ev(",flex,items-center,gap-10",[o,l])]);setTimeout(function(){o.focus(),o.select()},0);var c=[n(J("red"),"r"),n(J("green"),"g"),n(J("blue"),"b")],u=ev("",[a,h,ev("table."+eC({borderCollapse:"collapse",td:{paddingBottom:"5px"}}),[ev("tbody",c.map(function(e){return e.element}))])]);et({target:document.body,message:"<b>".concat(J("manual-color-input"),"</b>"),div:u,autoFocus:!1,clickOnEnter:"Ok",buttons:["Ok","Cancel"],callback:function(e){(0,W.BB).destroyEl(l),c.forEach(function(e){return e.destroy()}),c.splice(0,c.length),i.onClose("Ok"===e?(0,W.BB).ColorConverter.hexToRGB(o.value):void 0)}})},O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),eE={};eE=I("f6OTe").getBundleURL("lYbF2")+"tool-picker.d0e69c3a.svg";var eI=I("1C8RU"),eA=((0,eI.theme).isDark(),255),eT=function(){function e(i){var n=this;(0,O._)(this,e),this.rootEl=(0,W.BB).el({className:"kl-color-picker",css:{position:"relative"}}),this.outputDiv=(0,W.BB).el({css:{display:"flex",alignItems:"center"}}),this.width=i.width,this.svHeight=i.svHeight,this.height=i.height,this.emitColor=i.onPick,this.primaryColorRGB={r:parseInt(""+i.startValue.r),g:parseInt(""+i.startValue.g),b:parseInt(""+i.startValue.b)},this.primaryColorHSV=(0,W.BB).ColorConverter.toHSV(i.startValue),this.secondaryColorRGB={r:eA,g:eA,b:eA},this.secondaryColorHSV=(0,W.BB).ColorConverter._RGBtoHSV(this.secondaryColorRGB);var r=(0,W.BB).el();this.svSvg=new DOMParser().parseFromString('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><defs><linearGradient id="value" gradientTransform="rotate(90)"><stop offset="0" stop-color="#fff"/><stop offset="100%" stop-color="#000"/></linearGradient><linearGradient id="hue" gradientTransform="rotate(0)"><stop offset="0" stop-color="#fff"/><stop id="hue-stop" offset="100%" stop-color="#f00"/></linearGradient></defs><rect x="0" y="0" width="100" height="100" fill="url(\'#hue\')"/><rect x="0" y="0" width="100" height="100" fill="url(\'#value\')" style="mix-blend-mode: multiply"/></svg>',"image/svg+xml").documentElement;var a=this.svSvg.querySelector("#hue-stop");if(!a)throw Error("#hue-stop not found in svSvg");this.hueStop=a,(0,W.BB).setAttributes(this.hueStop,{"stop-color":"#f0f"}),(0,W.BB).css(this.svSvg,{width:this.width+"px",height:this.svHeight+"px"}),r.append(this.svSvg);var s=(0,W.BB).el({className:"kl-color-picker__h",css:{overflow:"hidden",position:"relative",width:this.width+"px",height:this.height+"px",cursor:"ew-resize",marginTop:"1px",marginBottom:"1px"}});this.divPreview=(0,W.BB).el({className:"kl-color-picker__preview",css:{display:"flex",justifyContent:"space-between",width:2.5*this.height+"px",height:this.height+"px"}}),this.controlH=(0,W.BB).el();var o=function(e){var t=new Image;(0,W.BB).css(t,{position:"absolute",left:"0",top:"0",display:"none",pointerEvents:"none"});for(var i=(0,W.BB).canvas(n.width,n.height),r=(0,W.BB).ctx(i),a=r.createLinearGradient(0,0,n.width,0),s=0;s<1;s+=.01){var o=(0,W.BB).ColorConverter.toRGB(new W.BB.HSV(360*s,100,100)),l=parseInt(""+o.r).toString(16),h=parseInt(""+o.g).toString(16),c=parseInt(""+o.b).toString(16);1===l.length&&(l="0"+l),1===h.length&&(h="0"+h),1===c.length&&(c="0"+c),a.addColorStop(s,"#"+l+h+c)}r.fillStyle=a,r.fillRect(0,0,n.width,n.height),e.append(t),t.alt="hue",t.src=i.toDataURL("image/png"),t.style.display="block"};this.updateSVCanvas(),this.rootEl.style.width=this.width+"px",this.rootEl.oncontextmenu=function(){return!1},this.SVContainer=(0,W.BB).el({className:"kl-color-picker__sv",css:{width:this.width+"px",height:this.svHeight+"px",overflow:"hidden",display:"block",position:"relative",cursor:"crosshair"}}),this.pointerSV=(0,W.BB).el({css:{width:"12px",height:"12px",borderRadius:"6px",position:"absolute",pointerEvents:"none",boxShadow:"0px 0px 0 1px #000, inset 0px 0px 0 1px #fff"}}),this.SVContainer.append(r,this.pointerSV),this.updateSVPointer(),this.rootEl.append(this.SVContainer,s),this.outputDiv.append(this.divPreview),(0,W.BB).css(this.controlH,{width:"1px",height:this.height+"px",background:"#000",borderLeft:"1px solid #fff",position:"absolute",top:"0",left:parseInt(""+(this.primaryColorHSV.h/360*this.width-1))+"px"});var l={h:0,s:0,v:0};this.pickerButton=(0,W.BB).el({title:J("eyedropper")+" [Alt]",className:"color-picker-preview-button",css:{width:"30px",height:"30px",backgroundImage:"url("+t(eE)+")",backgroundRepeat:"no-repeat",backgroundSize:"70%",backgroundPosition:"center"},onClick:function(){n.isPicking?(n.pickCallback&&n.pickCallback(!1),n.pickingDone()):(n.pickerButton.classList.remove("color-picker-preview-button-hover"),n.pickerButton.classList.add("color-picker-preview-button-active"),n.isPicking=!0,n.pickCallback&&n.pickCallback(!0))}}),this.isPicking=!1,new W.BB.PointerListener({target:this.pickerButton,onEnterLeave:function(e){n.isPicking||n.pickerButton.classList.toggle("color-picker-preview-button-hover",e)}}),this.divPreview.append(this.pickerButton),this.hexButton=(0,W.BB).el({content:"#",className:"color-picker-preview-button",title:J("manual-color-input"),css:{height:"100%",width:this.height+"px",lineHeight:this.height+"px",fontSize:.65*this.height+"px"},onClick:function(){new eS({color:new W.BB.RGB(n.primaryColorRGB.r,n.primaryColorRGB.g,n.primaryColorRGB.b),onClose:function(e){e&&(n.setColor(e),n.emitColor(new W.BB.RGB(n.primaryColorRGB.r,n.primaryColorRGB.g,n.primaryColorRGB.b)))}})}}),new W.BB.PointerListener({target:this.hexButton,onEnterLeave:function(e){n.hexButton.classList.toggle("color-picker-preview-button-hover",e)}}),this.divPreview.append(this.hexButton),this.setColPreview(),setTimeout(function(){o(s),s.append(n.controlH),new W.BB.PointerListener({target:r,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&((0,W.BB).unfocusAnyInput(),n.SVContainer.classList.toggle("kl-color-picker--active",!0),"left"===e.button?(l.s=e.relX/n.width*100,l.v=100-e.relY/n.svHeight*100,n.primaryColorHSV=new W.BB.HSV(n.primaryColorHSV.h,l.s,l.v),n.primaryColorRGB=(0,W.BB).ColorConverter.toRGB(n.primaryColorHSV),n.updateSVPointer(),n.setColPreview(),n.emitColor((0,W.BB).ColorConverter.toRGB(n.primaryColorHSV))):(l.s=n.primaryColorHSV.s,l.v=n.primaryColorHSV.v)),"pointermove"===e.type&&["left","right"].includes(e.button||"")){var t=1;"right"===e.button&&(t=.5),l.s+=e.dX/n.width*100*t,l.v-=e.dY/n.svHeight*100*t,n.primaryColorHSV=new W.BB.HSV(n.primaryColorHSV.h,l.s,l.v),n.primaryColorRGB=(0,W.BB).ColorConverter.toRGB(n.primaryColorHSV),n.updateSVPointer(),n.setColPreview(),n.emitColor((0,W.BB).ColorConverter.toRGB(n.primaryColorHSV))}"pointerup"===e.type&&n.SVContainer.classList.toggle("kl-color-picker--active",!1)}}),new W.BB.PointerListener({target:s,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&((0,W.BB).unfocusAnyInput(),s.classList.toggle("kl-color-picker--active",!0),"left"===e.button?(l.h=e.relX/n.width*359.99,n.primaryColorHSV=new W.BB.HSV(l.h,n.primaryColorHSV.s,n.primaryColorHSV.v),n.primaryColorRGB=(0,W.BB).ColorConverter.toRGB(n.primaryColorHSV),n.controlH.style.left=Math.round(n.primaryColorHSV.h/359.99*n.width)-1+"px",n.updateSVCanvas(),n.setColPreview(),n.emitColor((0,W.BB).ColorConverter.toRGB(n.primaryColorHSV))):l.h=n.primaryColorHSV.h),"pointermove"===e.type&&["left","right"].includes(e.button||"")){var t=eu(Math.abs(e.pageY-e.downPageY),"right"===e.button);l.h+=e.dX/n.width*359.99*t,"right"===e.button&&(l.h=l.h%359.99,l.h<0&&(l.h+=359.99)),l.h=Math.min(359.99,l.h),n.primaryColorHSV=new W.BB.HSV(l.h,n.primaryColorHSV.s,n.primaryColorHSV.v),n.primaryColorRGB=(0,W.BB).ColorConverter.toRGB(n.primaryColorHSV),n.controlH.style.left=Math.round(n.primaryColorHSV.h/359.99*n.width)-1+"px",n.updateSVCanvas(),n.setColPreview(),n.emitColor((0,W.BB).ColorConverter.toRGB(n.primaryColorHSV))}"pointerup"===e.type&&s.classList.toggle("kl-color-picker--active",!1)}})},1),this.secondaryColorBtn=(0,W.BB).el({parent:this.outputDiv,title:J("secondary-color")+" [X]",className:"kl-color-picker__secondary",css:{cursor:"pointer",marginLeft:"5px",width:"22px",height:"22px"},onClick:function(e){e.preventDefault(),n.swapColors()}}),this.updateSecondaryColor()}return(0,D._)(e,[{key:"updatePrimaryHSV",value:function(e){0===e.s?this.primaryColorHSV=new W.BB.HSV(this.primaryColorHSV.h,e.s,e.v):this.primaryColorHSV=new W.BB.HSV(e.h,e.s,e.v)}},{key:"updateSVCanvas",value:function(){var e=(0,W.BB).ColorConverter.toRGB(new W.BB.HSV(this.primaryColorHSV.h,100,100));(0,W.BB).setAttributes(this.hueStop,{"stop-color":"#"+(0,W.BB).ColorConverter.toHexString(e)})}},{key:"updateSVPointer",value:function(){var e=this.primaryColorHSV.s/100*this.width-7,t=(1-this.primaryColorHSV.v/100)*this.svHeight-6;(0,W.BB).css(this.pointerSV,{left:e+"px",top:t+"px"})}},{key:"setColPreview",value:function(){this.divPreview.style.backgroundColor="rgb("+this.primaryColorRGB.r+","+this.primaryColorRGB.g+","+this.primaryColorRGB.b+")",(0,W.BB).testIsWhiteBestContrast(this.primaryColorRGB)?((0,W.BB).css(this.pickerButton,{filter:"invert(1)"}),(0,W.BB).css(this.hexButton,{filter:"invert(1)"})):((0,W.BB).css(this.pickerButton,{filter:""}),(0,W.BB).css(this.hexButton,{filter:""}))}},{key:"updateSecondaryColor",value:function(){this.secondaryColorBtn.style.backgroundColor=(0,W.BB).ColorConverter.toRgbStr(this.secondaryColorRGB)}},{key:"setColor",value:function(e){this.primaryColorRGB={r:parseInt(""+e.r),g:parseInt(""+e.g),b:parseInt(""+e.b)},this.updatePrimaryHSV((0,W.BB).ColorConverter.toHSV(e)),this.controlH.style.left=parseInt(""+(this.primaryColorHSV.h/359*this.width-1))+"px",this.updateSVCanvas(),this.updateSVPointer(),this.setColPreview()}},{key:"getColor",value:function(){return new W.BB.RGB(this.primaryColorRGB.r,this.primaryColorRGB.g,this.primaryColorRGB.b)}},{key:"getSecondaryRGB",value:function(){return new W.BB.RGB(this.secondaryColorRGB.r,this.secondaryColorRGB.g,this.secondaryColorRGB.b)}},{key:"setPickCallback",value:function(e){this.pickCallback=e}},{key:"pickingDone",value:function(){this.isPicking&&(this.isPicking=!1,this.pickerButton.classList.remove("color-picker-preview-button-active"))}},{key:"enable",value:function(e){e?(this.rootEl.style.pointerEvents="",this.rootEl.style.opacity="1",this.outputDiv.style.pointerEvents="",this.outputDiv.style.opacity="1"):(this.rootEl.style.pointerEvents="none",this.rootEl.style.opacity="0.5",this.outputDiv.style.pointerEvents="none",this.outputDiv.style.opacity="0.5")}},{key:"setHeight",value:function(e){(e=parseInt(""+(e-2*this.height-3),10))!==this.svHeight&&(this.svHeight=e,(0,W.BB).css(this.svSvg,{width:this.width+"px",height:this.svHeight+"px"}),this.SVContainer.style.height=this.svHeight+"px",this.updateSVPointer())}},{key:"swapColors",value:function(){var e=this.secondaryColorHSV;this.secondaryColorHSV=this.primaryColorHSV,this.updatePrimaryHSV(e),e=this.secondaryColorRGB,this.secondaryColorRGB=this.primaryColorRGB,this.primaryColorRGB=e,this.controlH.style.left=parseInt(""+(this.primaryColorHSV.h/359*this.width-1))+"px",this.updateSVCanvas(),this.updateSVPointer(),this.setColPreview(),this.updateSecondaryColor(),this.emitColor(new W.BB.RGB(this.primaryColorRGB.r,this.primaryColorRGB.g,this.primaryColorRGB.b))}},{key:"getElement",value:function(){return this.rootEl}},{key:"getOutputElement",value:function(){return this.outputDiv}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),eM=function(){function e(t){var i=this;(0,O._)(this,e),this.rootEl=(0,W.BB).el({css:{width:t.width+"px",position:"relative",overflow:"hidden",userSelect:"none"}}),this.rootEl.oncontextmenu=function(e){e.preventDefault()},this.color=(0,W.BB).ColorConverter.toHSV(new W.BB.RGB(t.color.r,t.color.g,t.color.b)),this.width=t.width,this.heightSV=t.heightSV,this.canvasSV=(0,W.BB).canvas(10,10),(0,W.BB).css(this.canvasSV,{width:this.width+"px",height:this.heightSV+"px",cursor:"crosshair"}),this.updateSV();var n=(0,W.BB).canvas(t.width,t.heightH);n.style.cursor="ew-resize",function(){for(var e=(0,W.BB).ctx(n),i=e.createLinearGradient(0,0,t.width,0),r=0;r<1;r+=.01){var a=(0,W.BB).ColorConverter.toRGB(new W.BB.HSV(360*r,100,100));i.addColorStop(r,"rgba("+parseInt(""+a.r)+", "+parseInt(""+a.g)+", "+parseInt(""+a.b)+", 1)")}e.fillStyle=i,e.fillRect(0,0,t.width,t.heightH)}(),(0,W.BB).css(this.canvasSV,{width:t.width+"px",height:t.heightSV+"px",overflow:"hidden",position:"relative"}),this.canvasSV.style.cssFloat="left",n.style.cssFloat="left",this.rootEl.append(this.canvasSV,n),this.pointerSV=(0,W.BB).el({parent:this.rootEl,css:{width:"8px",height:"8px",borderRadius:"8px",position:"absolute",pointerEvents:"none",boxShadow:"0 0 0 1px #000, inset 0 0 0 1px #fff"}}),this.pointerH=(0,W.BB).el({parent:this.rootEl,css:{width:"0",height:t.heightH+"px",borderLeft:"1px solid #fff",borderRight:"1px solid #000",position:"absolute",top:t.heightSV+"px",pointerEvents:"none"}}),this.updateSVPointer(),this.updateHPointer();var r={h:0,s:0,v:0};this.svPointerId=null,this.svPointerListener=new W.BB.PointerListener({target:this.canvasSV,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&((0,W.BB).unfocusAnyInput(),i.svPointerId=e.pointerId,"left"===e.button?(r.s=e.relX/t.width*100,r.v=100-e.relY/t.heightSV*100,i.color=new W.BB.HSV(i.color.h,r.s,r.v),i.updateSVPointer(),t.callback((0,W.BB).ColorConverter.toRGB(i.color))):(r.s=i.color.s,r.v=i.color.v)),"pointermove"===e.type&&["left","right"].includes(""+e.button)&&i.svPointerId===e.pointerId){var n=1;"right"===e.button&&(n=.5),r.s+=e.dX/t.width*100*n,r.v-=e.dY/t.heightSV*100*n,i.color=new W.BB.HSV(i.color.h,r.s,r.v),i.updateSVPointer(),t.callback((0,W.BB).ColorConverter.toRGB(i.color))}"pointerup"===e.type&&(i.svPointerId=null)}}),this.hPointerId=null,this.hPointerListener=new W.BB.PointerListener({target:n,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&(i.hPointerId=e.pointerId,"left"===e.button?(r.h=e.relX/t.width*359.99,i.color=new W.BB.HSV(r.h,i.color.s,i.color.v),i.updateSV(),i.updateHPointer(),t.callback((0,W.BB).ColorConverter.toRGB(i.color))):r.h=i.color.h),"pointermove"===e.type&&["left","right"].includes(""+e.button)&&i.hPointerId===e.pointerId){var n=eu(Math.abs(e.pageY-e.downPageY),"right"===e.button);r.h+=e.dX/t.width*359.99*n,"right"===e.button&&(r.h=r.h%359.99,r.h<0&&(r.h+=359.99)),r.h=Math.min(359.99,r.h),i.color=new W.BB.HSV(r.h,i.color.s,i.color.v),i.updateSV(),i.updateHPointer(),t.callback((0,W.BB).ColorConverter.toRGB(i.color))}"pointerup"===e.type&&(i.hPointerId=null)}}),(0,W.BB).el({parent:this.rootEl,css:{clear:"both"}})}return(0,D._)(e,[{key:"updateSV",value:function(){var e=(0,W.BB).ctx(this.canvasSV);if(!e)throw Error("couldnt create canvas");for(var t=0;t<this.canvasSV.height;t+=1){var i=e.createLinearGradient(0,0,this.canvasSV.width,0),n=(0,W.BB).ColorConverter.toRGB(new W.BB.HSV(this.color.h,1,100-t/this.canvasSV.height*100)),r=(0,W.BB).ColorConverter.toRGB(new W.BB.HSV(this.color.h,100,100-t/this.canvasSV.height*100));i.addColorStop(0,"#"+(0,W.BB).ColorConverter.toHexString(n)),i.addColorStop(1,"#"+(0,W.BB).ColorConverter.toHexString(r)),e.fillStyle="#ff0000",e.fillStyle=i,e.fillRect(0,t,this.canvasSV.width,1)}}},{key:"updateSVPointer",value:function(){var e=this.color.s/100*this.width-4,t=(1-this.color.v/100)*this.heightSV-4;(0,W.BB).css(this.pointerSV,{left:e+"px",top:t+"px"})}},{key:"updateHPointer",value:function(){this.pointerH.style.left=this.color.h/359.999*this.width-1+"px"}},{key:"setColor",value:function(e){this.color=(0,W.BB).ColorConverter.toHSV(new W.BB.RGB(e.r,e.g,e.b)),this.updateSV(),this.updateSVPointer(),this.updateHPointer()}},{key:"getColor",value:function(){return(0,W.BB).ColorConverter.toRGB(this.color)}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.svPointerListener.destroy(),this.hPointerListener.destroy()}},{key:"end",value:function(){this.svPointerId=null,this.hPointerId=null}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),eL=function(){function e(t){var i,n,r,a=this;(0,O._)(this,e),this.rootEl=(0,W.BB).el({css:{position:"relative"}}),(0,W.BB).el({parent:this.rootEl,className:"kl-point-slider__line",css:{marginTop:parseInt(""+(t.pointSize/2-1))+"px",width:t.width+"px"}}),this.sliderPoint=(0,W.BB).el({parent:this.rootEl,className:"kl-point-slider__point"}),(0,W.BB).el({parent:this.sliderPoint,css:{margin:"-7px 0 0 -7px",width:"calc(100% + 14px)",height:"calc(100% + 7px)"}});var s=function(){(0,W.BB).css(a.sliderPoint,{left:i+"px"})},o=function(){return i/(t.width-t.pointSize)};i=(0,W.BB).clamp(t.init*(t.width-t.pointSize),0,t.width-t.pointSize),(0,W.BB).css(this.sliderPoint,{width:t.pointSize+"px",height:t.pointSize+"px",borderRadius:t.pointSize+"px"}),s(),this.pointerListener=new W.BB.PointerListener({target:this.sliderPoint,fixScribble:!0,onPointer:function(e){"pointerdown"===e.type&&"left"===e.button?(n=!0,r=i,s(),e.eventStopPropagation()):"pointermove"===e.type&&"left"===e.button&&(e.eventStopPropagation(),r+=e.dX,i=parseInt(""+(0,W.BB).clamp(r,0,t.width-t.pointSize)),s(),t.callback(o(),n,!1),n=!1),"pointerup"===e.type&&(e.eventStopPropagation(),s(),t.callback(o(),!1,!0))}})}return(0,D._)(e,[{key:"getEl",value:function(){return this.rootEl}},{key:"setActive",value:function(e){this.sliderPoint.style.backgroundColor=e?"#fff":"#eaeaea"}},{key:"destroy",value:function(){this.pointerListener.destroy()}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),eR=I("4EWN2"),W=I("eWjiX"),eI=I("1C8RU"),eP=I("dJ1E2"),eO=function(){function e(t){var i,n=this;(0,O._)(this,e),this.colorArr=[],this.selectedIndex=0,this.rootEl=(0,W.BB).el({content:t.label?t.label:"",title:null!==(i=t.title)&&void 0!==i?i:void 0,css:{display:"flex",alignItems:"center",gap:"7px"}}),this.buttonArr=[];var r=(0,W.BB).createCheckerDataUrl(5,void 0,(0,eI.theme).isDark());this.onColorInputChange=function(){var e=n.selectedIndex,i=n.colorArr[e];if(i&&!(i.a<1)){var r=n.colorInput.value;n.buttonArr[n.selectedIndex].el.style.backgroundColor=r,n.colorArr[e]=(0,eR._)((0,X._)({},(0,eP.ColorConverter).hexToRGB(r)),{a:1}),t.onChange(n.colorArr[e])}},this.colorInput=(0,W.BB).el({tagName:"input",custom:{type:"color",tabIndex:"-1"}}),this.colorInput.onchange=this.onColorInputChange,this.colorInput.oninput=this.onColorInputChange;for(var a=0;a<t.colorArr.length;a++){for(var s=t.colorArr[a],o=!1,l=0;l<this.colorArr.length;l++){var h=this.colorArr[l];if(h===s||null!==h&&null!==s&&h.r===s.r&&h.g===s.g&&h.b===s.b&&h.a===s.a){o=!0;break}}!o&&(this.colorArr.push(s),"initialIndex"in t&&t.initialIndex===a&&(this.selectedIndex=this.colorArr.length-1))}for(var c=0;c<this.colorArr.length;c++)!function(e){var i=n.colorArr[e],a=(0,W.BB).el({parent:n.rootEl,content:i?"":"X",className:"kl-color-option",css:{width:"22px",height:"22px",backgroundColor:i?(0,W.BB).ColorConverter.toRgbaStr(i):"transparent",lineHeight:"23px"},onClick:function(r){if(n.selectedIndex===e){i&&1===i.a&&(n.colorInput.showPicker?n.colorInput.showPicker():n.colorInput.click());return}r.preventDefault(),n.selectedIndex=e,u(),t.onChange(n.colorArr[e])}});i&&0===i.a&&(a.style.backgroundImage="url("+r+")");var s=function(e){a.classList.toggle("kl-color-option--active",e)};n.buttonArr.push({el:a,setIsSelected:s})}(c);this.rootEl.append(ev(",w-0,h-0,overflow-hidden",[this.colorInput]));var u=function(){for(var e=0;e<n.buttonArr.length;e++)n.buttonArr[e].setIsSelected(e===n.selectedIndex)};u(),this.updateCheckerboard=function(){var e=(0,W.BB).createCheckerDataUrl(5,void 0,(0,eI.theme).isDark());n.buttonArr.forEach(function(t,i){var r=n.colorArr[i];r&&0===r.a&&(t.el.style.backgroundImage="url("+e+")")})},(0,eI.theme).addIsDarkListener(this.updateCheckerboard)}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.colorArr[this.selectedIndex]}},{key:"destroy",value:function(){this.rootEl.remove(),this.buttonArr.forEach(function(e){(0,W.BB).destroyEl(e.el)}),this.buttonArr.splice(0,this.buttonArr.length),(0,eI.theme).removeIsDarkListener(this.updateCheckerboard),this.colorInput.onchange=null,this.colorInput.oninput=null}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),eD=function(){function e(t){var i=this;(0,O._)(this,e),this.rootEl=(0,W.BB).el();var n=(0,W.BB).el({parent:this.rootEl,className:"kl-option-wrapper",css:{display:"flex"}});t.onChange&&(this.onChange=t.onChange),this.optionArr=[],this.selectedId="initialId"in t&&void 0!==t.initId?t.initId:t.optionArr[0].id;for(var r=0;r<t.optionArr.length;r++)!function(e){var r=["kl-option"];t.isSmall&&r.push("kl-option--small"),"string"!=typeof e.label&&(r.push("kl-option--custom-el"),(0,W.BB).css(e.label,{display:"block",pointerEvents:"none"}));var a={id:e.id,el:(0,W.BB).el({parent:n,content:e.label,className:r.join(" "),onClick:function(){i.selectedId!==a.id&&(i.selectedId=a.id,i.update(),i.onChange&&i.onChange(i.selectedId))}})};e.title&&(a.el.title=e.title),i.optionArr.push(a)}(t.optionArr[r]);this.update(),t.changeOnInit&&setTimeout(function(){i.onChange&&i.onChange(i.selectedId)},0)}return(0,D._)(e,[{key:"getIndex",value:function(){for(var e=0;e<this.optionArr.length;e++)if(this.optionArr[e].id===this.selectedId)return e;return -1}},{key:"update",value:function(){for(var e=0;e<this.optionArr.length;e++)this.optionArr[e].el.classList.toggle("kl-option-selected",this.optionArr[e].id===this.selectedId)}},{key:"getElement",value:function(){return this.rootEl}},{key:"getValue",value:function(){return this.selectedId}},{key:"next",value:function(){this.selectedId=this.optionArr[(this.getIndex()+1)%this.optionArr.length].id,this.update(),this.onChange&&this.onChange(this.selectedId)}},{key:"previous",value:function(){this.selectedId=this.optionArr[(this.optionArr.length+this.getIndex()-1)%this.optionArr.length].id,this.update(),this.onChange&&this.onChange(this.selectedId)}},{key:"destroy",value:function(){this.rootEl.remove(),this.optionArr.forEach(function(e){(0,W.BB).destroyEl(e.el)}),this.optionArr.splice(0,this.optionArr.length)}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),ez={};ez=I("f6OTe").getBundleURL("lYbF2")+"angle.f0b557ac.svg";var e_=function(){function e(){(0,O._)(this,e),this.isWide=!1,this.uiState="right",this.el=(0,W.BB).el({className:"top-overlay g-root",onClick:W.BB.handleClick}),this.updateUiState(),this.innerEl=(0,W.BB).el({className:"top-overlay--inner"}),this.angleIm=new Image,this.angleIm.src=t(ez),(0,W.BB).css(this.angleIm,{verticalAlign:"bottom",width:"20px",height:"20px",marginLeft:"5px",borderRadius:"10px"}),this.innerInnerEl=document.createElement("div"),this.innerInnerEl.style.display="inline-block",this.innerEl.append(this.innerInnerEl,this.angleIm),this.el.append(this.innerEl),document.body.append(this.el),this.el.style.display="none"}return(0,D._)(e,[{key:"updateUiState",value:function(){"left"===this.uiState?this.el.style.left="271px":this.el.style.removeProperty("left")}},{key:"setWide",value:function(e){this.isWide=e,this.el&&(this.isWide?(this.el.style.width="100%",this.el.style.left=""):(this.el.style.removeProperty("width"),this.el.style.left="left"===this.uiState?"271px":""))}},{key:"setUiState",value:function(e){this.uiState=e,this.updateUiState()}},{key:"out",value:function(e,t){var i=this;"string"==typeof e?(this.angleIm.style.display="none",this.innerInnerEl.innerHTML=e):"transform"===e.type?(this.angleIm.style.display="inline-block",this.angleIm.style.transform="rotate("+e.angleDeg+"deg)",e.angleDeg%90==0?this.angleIm.style.boxShadow="inset 0 0 0 1px rgba(255, 255, 255, 0.7)":this.angleIm.style.boxShadow="",this.innerInnerEl.innerHTML=Math.round(100*e.scale)+"%"):this.angleIm.style.display="none",t&&(this.innerEl.style.animation="",setTimeout(function(){return i.innerEl.style.animation="topOverlayPulse 0.5s ease-out"},20),clearTimeout(this.timeout3),this.timeout3=setTimeout(function(){return i.innerEl.style.animation=""},520)),clearTimeout(this.timeout),clearTimeout(this.timeout2),this.el.style.animationName=t?"consoleInFast":"consoleIn",this.el.style.opacity="1",this.timeout=setTimeout(function(){i.el.style.opacity="0",i.el.style.animationName="consoleOut",i.timeout2=setTimeout(function(){i.el.style.display="none"},450)},1200),this.el.style.display="flex"}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),eR=I("4EWN2"),z=I("bX4ja"),O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),eR=I("4EWN2"),W=I("eWjiX"),_=I("7jh4K"),eI=I("1C8RU");function ej(e,t){return Array.isArray(t)?[e.a*t[0]+e.c*t[1]+e.e,e.b*t[0]+e.d*t[1]+e.f]:{x:e.a*t.x+e.c*t.y+e.e,y:e.b*t.x+e.d*t.y+e.f}}function eF(e){var t=e.a,i=e.b,n=e.c,r=e.d,a=e.e,s=e.f,o=t*r-i*n;return{a:r/o,b:-(i/o),c:-(n/o),d:t/o,e:-((r*a-n*s)/o),f:(i*a-t*s)/o}}function eV(e){return void 0===e}function eH(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return{a:1,c:0,e:e,b:0,d:1,f:t}}var eW=I("vDBh4"),eX=I("5mm0I"),eN=I("keO5I"),eY=I("kWe4k"),z=I("bX4ja");function eU(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];t=Array.isArray(t[0])?t[0]:t;var n=function(e,t){return{a:e.a*t.a+e.c*t.b,c:e.a*t.c+e.c*t.d,e:e.a*t.e+e.c*t.f+e.e,b:e.b*t.a+e.d*t.b,d:e.b*t.c+e.d*t.d,f:e.b*t.e+e.d*t.f+e.f}};switch(t.length){case 0:throw Error("no matrices provided");case 1:return t[0];case 2:return n(t[0],t[1]);default:var r,a=(r=t,(0,eW._array_with_holes)(r)||(0,eX._iterable_to_array)(r)||(0,eY._unsupported_iterable_to_array)(r)||(0,eN._non_iterable_rest)()),s=a[0],o=a[1],l=a.slice(2),h=n(s,o);return eU.apply(void 0,[h].concat((0,z._)(l)))}}function eG(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return eU.apply(void 0,(0,z._)(t))}var eK=Math.cos,eq=Math.sin;function eQ(e,t,i){var n=eK(e),r=eq(e),a={a:n,c:-r,e:0,b:r,d:n,f:0};return eV(t)||eV(i)?a:eU([eH(t,i),a,eH(-t,-i)])}function eZ(e,t,i,n){eV(t)&&(t=e);var r={a:e,c:0,e:0,b:0,d:t,f:0};return eV(i)||eV(n)?r:eU([eH(i,n),r,eH(-i,-n)])}function eJ(e,t,i,n){var r=Error.call(this,e);return Object.setPrototypeOf&&Object.setPrototypeOf(r,eJ.prototype),r.expected=t,r.found=i,r.location=n,r.name="SyntaxError",r}function e$(e,t,i){return(i=i||" ",e.length>t)?e:(t-=e.length,e+(i+=i.repeat(t)).slice(0,t))}function e0(e){var t="scale"in e?e.scale:e.scaleX,i="scale"in e?e.scale:e.scaleY;return eG(eH(e.x,e.y),eQ(e.angleDeg/180*Math.PI),eZ(t,i))}function e1(e,t){return Math.round(t*e)/t}!function(e,t){function i(){this.constructor=e}i.prototype=t.prototype,e.prototype=new i}(eJ,Error),eJ.prototype.format=function(e){var t="Error: "+this.message;if(this.location){var i,n=null;for(i=0;i<e.length;i++)if(e[i].source===this.location.source){n=e[i].text.split(/\r\n|\n|\r/g);break}var r=this.location.start,a=this.location.source&&"function"==typeof this.location.source.offset?this.location.source.offset(r):r,s=this.location.source+":"+a.line+":"+a.column;if(n){var o=this.location.end,l=e$("",a.line.toString().length," "),h=n[r.line-1],c=(r.line===o.line?o.column:h.length+1)-r.column||1;t+="\n --> "+s+"\n"+l+" |\n"+a.line+" | "+h+"\n"+l+" | "+e$("",r.column-1," ")+e$("",c,"^")}else t+="\n at "+s}return t},eJ.buildMessage=function(e,t){var i={literal:function(e){return'"'+r(e.text)+'"'},class:function(e){var t=e.parts.map(function(e){return Array.isArray(e)?a(e[0])+"-"+a(e[1]):a(e)});return"["+(e.inverted?"^":"")+t.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(e){return e.description}};function n(e){return e.charCodeAt(0).toString(16).toUpperCase()}function r(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+n(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+n(e)})}function a(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+n(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+n(e)})}function s(e){return i[e.type](e)}return"Expected "+function(e){var t,i,n=e.map(s);if(n.sort(),n.length>0){for(t=1,i=1;t<n.length;t++)n[t-1]!==n[t]&&(n[i]=n[t],i++);n.length=i}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}(e)+" but "+(t?'"'+r(t)+'"':"end of input")+" found."};var e2=function(){function e(t){var i=this;(0,O._)(this,e),this.doResize=!0,this.onIsDark=function(){i.pattern=(0,_.throwIfNull)(i.ctx.createPattern((0,W.BB).createCheckerCanvas(10,(0,eI.theme).isDark()),"repeat")),i.render()},this.oldDPR=devicePixelRatio,this.resizeListener=function(){devicePixelRatio!==i.oldDPR&&(i.canvas.style.imageRendering=Math.round(devicePixelRatio)!==devicePixelRatio?"":"pixelated",i.oldDPR=devicePixelRatio)},this.width=t.width,this.height=t.height,this.project=t.project,this.useNativeResolution=!!t.useNativeResolution,this.drawBackground=!!t.drawBackground,this.doFillParent=!!t.fillParent,this.transform=(0,X._)({},t.transform),this.resFactor=this.useNativeResolution?devicePixelRatio:1,this.canvas=(0,W.BB).canvas(this.width*this.resFactor,this.height*this.resFactor),this.ctx=(0,W.BB).ctx(this.canvas),(0,W.BB).css(this.canvas,{width:this.doFillParent?"100%":this.width+"px",height:this.doFillParent?"100%":this.height+"px",imageRendering:Math.round(devicePixelRatio)!==devicePixelRatio?void 0:"pixelated",display:"block"}),window.addEventListener("resize",this.resizeListener),this.pattern=(0,_.throwIfNull)(this.ctx.createPattern((0,W.BB).createCheckerCanvas(10,(0,eI.theme).isDark()),"repeat")),(0,eI.theme).addIsDarkListener(this.onIsDark)}return(0,D._)(e,[{key:"render",value:function(){var e=this,t=(0,eI.theme).isDark(),i=(0,eR._)((0,X._)({},this.transform),{x:this.transform.x,y:this.transform.y,scale:this.transform.scale});this.doResize&&(this.doResize=!1,this.resFactor=this.useNativeResolution?devicePixelRatio:1,this.canvas.width=Math.round(this.width*this.resFactor),this.canvas.height=Math.round(this.height*this.resFactor));var n={x:Math.round(i.x),y:Math.round(i.y),scaleX:e1(i.scale,this.project.width),scaleY:e1(i.scale,this.project.height),angleDeg:i.angleDeg},r=e0(n);if(this.ctx.save(),this.ctx.imageSmoothingEnabled=!1,this.drawBackground?(this.ctx.fillStyle=t?"rgb(33, 33, 33)":"rgb(158,158,158)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)):(this.ctx.fillStyle=this.pattern,this.ctx.fillRect(0,0,this.width,this.height)),this.ctx.translate(n.x,n.y),this.ctx.scale(n.scaleX,n.scaleY),this.ctx.rotate(n.angleDeg/180*Math.PI),this.drawBackground){this.ctx.save(),this.ctx.fillStyle=(0,eI.theme).isDark()?"rgba(255,255,255,0.25)":"rgba(0,0,0,0.2)";var a=1/n.scaleX,s=1/n.scaleY;this.ctx.fillRect(-a,-s,this.project.width+2*a,this.project.height+2*s),this.ctx.fillStyle=this.pattern,this.pattern.setTransform(eF(r)),this.ctx.fillRect(0,0,this.project.width,this.project.height),this.ctx.restore()}this.project.layers.forEach(function(t){if(t.isVisible&&t.opacity){e.ctx.save(),e.ctx.globalCompositeOperation=t.mixModeStr,e.ctx.globalAlpha=t.opacity;var i={};if("function"==typeof t.image){var a=t.image(n,e.canvas.width,e.canvas.height);"image"in a&&"transform"in a?(i=a.image,e.ctx.setTransform(eG(r,a.transform))):i=a}else i=t.image;e.ctx.drawImage(i,0,0),e.ctx.restore()}}),this.ctx.restore()}},{key:"setSize",value:function(e,t){this.doResize=!0,this.width=e,this.height=t,(0,W.BB).css(this.canvas,{width:this.doFillParent?"100%":this.width+"px",height:this.doFillParent?"100%":this.height+"px"})}},{key:"setTransform",value:function(e){this.transform=(0,X._)({},e)}},{key:"getTransform",value:function(){return(0,X._)({},this.transform)}},{key:"setUseNativeResolution",value:function(e){this.useNativeResolution=e,this.doResize=!0}},{key:"getUseNativeResolution",value:function(){return this.useNativeResolution}},{key:"getElement",value:function(){return this.canvas}},{key:"destroy",value:function(){(0,W.BB).freeCanvas(this.canvas),(0,eI.theme).removeIsDarkListener(this.onIsDark),window.removeEventListener("resize",this.resizeListener)}}]),e}(),W=I("eWjiX"),e5=I("04lDo"),e3={};e3=I("f6OTe").getBundleURL("lYbF2")+"tool-zoom-in.d413f042.svg";var e4={};e4=I("f6OTe").getBundleURL("lYbF2")+"tool-zoom-out.299f4d1f.svg";var e6={};e6=I("f6OTe").getBundleURL("lYbF2")+"viewport-reset.25476ab5.svg";var e7={};e7=I("f6OTe").getBundleURL("lYbF2")+"tool-hand.e7fc81b9.svg";var e8={};e8=I("f6OTe").getBundleURL("lYbF2")+"edit-pencil.d7636d97.svg";var e9=I("gCzYB"),te=I("c1lmK");function tt(e,t){var i=Math.log2(e)/Math.abs(t);return i+=t>0?1:-1,Math.pow(2,i=Math.round(i)*Math.abs(t))}var ti=I("joplQ");function tn(e,t,i,n){var r=ej(eG(eZ(-i,-i),eQ(n/180*Math.PI)),t);return r.x+=e.x,r.y+=e.y,{x:r.x,y:r.y,scale:i,angleDeg:n}}function tr(e,t){var i=ej(eF(e0(e)),t);return{viewportP:t,canvasP:i,scale:e.scale,angleDeg:e.angleDeg}}var ta=function(){function e(i){var n,r=this;(0,O._)(this,e),this.isReset=!0,this.doRender=!1,this.lastEmittedTransform={x:0,y:0,scale:0,angleDeg:0},this.renderLoop=function(){if(r.animationFrameId=requestAnimationFrame(r.renderLoop),r.doRender){r.doRender=!1,r.viewport.render();var e=r.viewport.getTransform();r.onTransformChange&&JSON.stringify(r.lastEmittedTransform)!==JSON.stringify(e)&&(r.onTransformChange(e),r.lastEmittedTransform=e)}},this.onWheel=function(e){var t=r.viewport.getElement().getBoundingClientRect(),i=e.pageX-t.x,n=e.pageY-t.y,a=r.viewport.getTransform().scale,s=tt(a,-e.deltaY/2);r.transformCanvas({type:"zoom",vX:i,vY:n,fac:s/a})},this.width=i.width,this.height=i.height,this.project=i.project,this.onTransformChange=i.onTransformChange,this.padding=null!==(n=i.padding)&&void 0!==n?n:10;var a=(0,W.BB).fitInto(this.project.width,this.project.height,this.width-2*this.padding,this.height-2*this.padding).width/this.project.width;this.viewport=new e2({width:this.width,height:this.height,transform:tn({x:this.width/2,y:this.height/2},{x:this.project.width/2,y:this.project.height/2},a,0),project:this.project,useNativeResolution:!1,drawBackground:!0});var s=new te.DoubleTapper({onDoubleTap:function(e){var t=e0(r.viewport.getTransform()),i=ej(t,{x:0,y:0}),n=ej(t,{x:r.project.width,y:r.project.height}),a=(0,W.BB).isInsideRect({x:e.relX,y:e.relY},{x:i.x,y:i.y,width:n.x-i.x,height:n.y-i.y});(!r.isReset||a)&&r.resetOrZoom(e.relX,e.relY)},isInstant:!0}),o=void 0,l=new ti.PinchZoomer({onPinch:function(e){if("move"===e.type){o||(o=r.viewport.getTransform());var t=tr(o,{x:e.downRelX,y:e.downRelY});t.scale*=e.scale,t.viewportP.x+=e.relX-e.downRelX,t.viewportP.y+=e.relY-e.downRelY,r.viewport.setTransform(tn(t.viewportP,t.canvasP,t.scale,t.angleDeg)),r.requestRerender(),r.isReset=!1}else"end"===e.type&&(o=void 0)}});this.pointerChain=new e9.EventChain({chainArr:[l,s]}),this.pointerChain.setChainOut(function(e){e.button&&["left","middle"].includes(e.button)&&r.transformCanvas({type:"translate",x:e.dX,y:e.dY})}),this.viewport.getElement().classList.add(eC({cursor:"grab",":active":{cursor:"grabbing"}})),(0,W.BB).css(this.viewport.getElement(),{userSelect:"none",touchAction:"none"}),this.viewport.getElement().addEventListener("touchend",function(e){return e.preventDefault(),!1}),this.viewport.getElement().addEventListener("contextmenu",function(e){return e.preventDefault(),!1}),this.viewport.getElement().addEventListener("dragstart",function(e){return e.preventDefault(),!1}),this.viewportPointerListener=new e5.PointerListener({target:this.viewport.getElement(),onPointer:function(e){r.pointerChain.chainIn(e)},onWheel:this.onWheel,maxPointers:2}),this.viewport.getElement().addEventListener("wheel",function(e){e.preventDefault()}),i.hasEditMode&&(this.modeToggle=new eD({optionArr:["edit","hand"].map(function(e){var n,r=(0,W.BB).el({className:"dark-invert",css:{width:"28px",height:"28px",backgroundSize:"contain",margin:"5px",backgroundImage:"url(".concat("edit"===e?null!==(n=i.editIcon)&&void 0!==n?n:t(e8):t(e7),")"),backgroundPosition:"center",backgroundRepeat:"no-repeat"}});return{id:e,label:r,title:"edit"===e?J("tab-edit"):J("tool-hand")}}),initId:"edit",onChange:function(e){i.onModeChange&&i.onModeChange(e)}}));var h=eC(!1===i.hasBorder?{}:{borderTop:"1px solid #7f7f7f",borderBottom:"1px solid #7f7f7f",".kl-theme-dark &":{borderTop:"1px solid #636363",borderBottom:"1px solid #636363"}});this.rootEl=ev({className:h,css:{position:"relative"}},[this.viewport.getElement()].concat((0,z._)(this.modeToggle?[ev(",pos-absolute,left-5,top-5,z-1,pointer-auto",[this.modeToggle.getElement()])]:[]),[ev(",pos-absolute,right-5,bottom-5,flex,flexCol,gap-5,z-1,pointer-auto",[ev({tagName:"button",title:J("hand-reset"),onClick:function(){r.reset()},content:'<img alt="reset" height="20" src="'.concat(t(e6),'">'),noRef:!0}),ev({tagName:"button",title:J("zoom-in"),onClick:function(){var e=r.viewport.getTransform().scale,t=tt(e,1);r.transformCanvas({type:"zoom",fac:t/e})},content:'<img alt="zoom-in" height="20" src="'.concat(t(e3),'">'),noRef:!0}),ev({tagName:"button",title:J("zoom-out"),onClick:function(){var e=r.viewport.getTransform().scale,t=tt(e,-1);r.transformCanvas({type:"zoom",fac:t/e})},content:'<img alt="zoom-out" height="20" src="'.concat(t(e4),'">'),noRef:!0})])])),this.renderLoop()}return(0,D._)(e,[{key:"requestRerender",value:function(){this.doRender=!0}},{key:"resetOrZoom",value:function(e,t){if(this.isReset){this.isReset=!1;var i=ej(eF(e0(this.viewport.getTransform())),{x:e,y:t});this.viewport.setTransform(tn({x:this.width/2,y:this.height/2},i,1,0)),this.requestRerender()}else this.reset()}},{key:"reset",value:function(){var e=(0,W.BB).fitInto(this.project.width,this.project.height,this.width-2*this.padding,this.height-2*this.padding).width/this.project.width;this.viewport.setTransform(tn({x:this.width/2,y:this.height/2},{x:this.project.width/2,y:this.project.height/2},e,0)),this.isReset=!0,this.requestRerender()}},{key:"transformCanvas",value:function(e){if("translate"===e.type){var t=this.viewport.getTransform();if(0===e.x&&0===e.y)return;this.viewport.setTransform((0,eR._)((0,X._)({},t),{x:t.x+e.x,y:t.y+e.y}))}else if("zoom"===e.type){var i,n,r=this.viewport.getTransform(),a=this.viewport.getElement().getBoundingClientRect();e.vX=null!==(i=e.vX)&&void 0!==i?i:a.width/2,e.vY=null!==(n=e.vY)&&void 0!==n?n:a.height/2;var s=tr(r,{x:e.vX,y:e.vY});s.scale*=e.fac,this.viewport.setTransform(tn(s.viewportP,s.canvasP,s.scale,s.angleDeg))}this.isReset=!1,this.requestRerender()}},{key:"render",value:function(){this.requestRerender()}},{key:"setTransform",value:function(e){this.viewport.setTransform(e),this.requestRerender(),this.isReset=!1}},{key:"getTransform",value:function(){return this.viewport.getTransform()}},{key:"onPointer",value:function(e){this.pointerChain.chainIn(e)}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){void 0!==this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.viewport.destroy(),this.viewportPointerListener.destroy(),this.rootEl.remove(),this.modeToggle&&this.modeToggle.destroy()}}]),e}(),ts=I("eg83P"),to={};to=I("f6OTe").getBundleURL("lYbF2")+"edit-crop.16c534dd.svg";var e9=I("gCzYB"),tl=I("635F6"),th=function(){function e(i){var n,r,a=this;(0,O._)(this,e),this.crop={x:0,y:0,width:0,height:0},this.mode="edit",this.rootEl=(0,W.BB).el({className:"kl-edit-crop-preview",css:{position:"relative",height:i.height+"px",width:i.width+"px",overflow:"hidden"}}),i.onChange&&(this.onChange=i.onChange),this.canvas=i.canvas,this.resetCrop(),this.croppedCanvas=(0,W.BB).canvas(),this.eventTarget=this.croppedCanvas,i.isNotCopy||(this.croppedImage=new Image,this.eventTarget=this.croppedImage),(0,W.BB).css(this.eventTarget,{height:i.height+"px",width:i.width+"px"}),this.rootEl.append(this.eventTarget),this.updateCroppedCanvas(),this.preview=new ta({width:i.width,height:i.height-2,project:{width:i.canvas.width,height:i.canvas.height,layers:[{image:i.canvas,opacity:1,isVisible:!0,mixModeStr:"source-over",hasClipping:!1}]},hasEditMode:!0,onModeChange:function(e){a.mode=e,a.preview.getElement().style.pointerEvents="edit"===e?"none":"",a.rootEl.title="edit"===e?J("crop-drag-to-crop"):""},onTransformChange:function(){return a.updateSelectionRect()},padding:20,hasBorder:!1,editIcon:t(to)}),(0,W.BB).css(this.preview.getElement(),{position:"absolute",left:"0",top:"0",overflow:"hidden",pointerEvents:"none"}),this.preview.render(),this.rootEl.append(this.preview.getElement()),this.selectionRectEl=(0,W.BB).el({parent:this.preview.getElement(),className:"kl-edit-crop-preview__sel"}),this.updateSelectionRect();var s=function(e,t){var i=eF(e0(a.preview.getTransform())),n={x:Math.min(e.x,t.x),y:Math.min(e.y,t.y)},r={x:Math.max(e.x,t.x),y:Math.max(e.y,t.y)},s=ej(i,n),o=ej(i,r);return s.x=(0,ts.clamp)(Math.floor(s.x),0,a.canvas.width),s.y=(0,ts.clamp)(Math.floor(s.y),0,a.canvas.height),o.x=(0,ts.clamp)(Math.ceil(o.x),0,a.canvas.width),o.y=(0,ts.clamp)(Math.ceil(o.y),0,a.canvas.height),{x:s.x,y:s.y,width:o.x-s.x,height:o.y-s.y}},o=null,l=!1,h=!1,c=new e9.EventChain({chainArr:[new tl.OnePointerLimiter]});c.setChainOut(function(e){if("pointerdown"===e.type&&"left"===e.button){var t;(e.eventPreventDefault(),l=!0,n={x:e.relX,y:e.relY},!a.isReset()&&(t=n,(0,W.BB).isInsideRect(t,a.getViewportSelectionRect())))?o={x:a.crop.x,y:a.crop.y,width:a.crop.width,height:a.crop.height}:a.crop=s(n,n)}else if("pointermove"===e.type&&"left"===e.button){if(e.eventPreventDefault(),h=!0,o){var i=a.preview.getTransform();a.crop.x=o.x+Math.round((e.relX-n.x)/i.scale),a.crop.y=o.y+Math.round((e.relY-n.y)/i.scale),a.crop.x=(0,W.BB).clamp(a.crop.x,0,a.canvas.width-a.crop.width),a.crop.y=(0,W.BB).clamp(a.crop.y,0,a.canvas.height-a.crop.height)}else a.crop=s(n,{x:e.relX,y:e.relY});a.updateSelectionRect()}else"pointerup"===e.type&&n&&(e.eventPreventDefault(),l=!1,o=null,n=null,0!==a.crop.width&&0!==a.crop.height&&h||(a.resetCrop(),a.updateSelectionRect()),h=!1,r=setTimeout(function(){return a.updateCroppedCanvas()},1))}),this.pointerListener=new W.BB.PointerListener({target:this.eventTarget,fixScribble:!0,onWheel:function(e){a.preview.onWheel(e)},onPointer:function(e){if("hand"===a.mode){e.eventPreventDefault(),a.preview.onPointer(e);return}c.chainIn(e)},maxPointers:2}),this.keyListener=new W.BB.KeyListener({onDown:function(e,t){if(!l){var i=!1,n=Math.max(1,1/a.preview.getTransform().scale),s=a.keyListener.isPressed("shift");"left"===e&&(s?a.crop.width=(0,W.BB).clamp(a.crop.width-n,1,a.canvas.width-a.crop.x):a.crop.x=(0,W.BB).clamp(a.crop.x-n,0,a.canvas.width-a.crop.width),i=!0),"right"===e&&(s?a.crop.width=(0,W.BB).clamp(a.crop.width+n,1,a.canvas.width-a.crop.x):a.crop.x=(0,W.BB).clamp(a.crop.x+n,0,a.canvas.width-a.crop.width),i=!0),"up"===e&&(s?a.crop.height=(0,W.BB).clamp(a.crop.height-n,1,a.canvas.height-a.crop.y):a.crop.y=(0,W.BB).clamp(a.crop.y-n,0,a.canvas.height-a.crop.height),i=!0),"down"===e&&(s?a.crop.height=(0,W.BB).clamp(a.crop.height+n,1,a.canvas.height-a.crop.y):a.crop.y=(0,W.BB).clamp(a.crop.y+n,0,a.canvas.height-a.crop.height),i=!0),i&&(t.preventDefault(),a.updateSelectionRect(),clearTimeout(r),r=setTimeout(function(){return a.updateCroppedCanvas()},100))}}})}return(0,D._)(e,[{key:"resetCrop",value:function(){this.crop={x:0,y:0,width:this.canvas.width,height:this.canvas.height}}},{key:"getViewportSelectionRect",value:function(){var e=this.preview.getTransform(),t=ej(e0(e),this.crop);return{x:t.x,y:t.y,width:this.crop.width*e.scale,height:this.crop.height*e.scale}}},{key:"updateCroppedCanvas",value:function(){this.croppedCanvas.width=Math.round(this.crop.width),this.croppedCanvas.height=Math.round(this.crop.height),(0,W.BB).ctx(this.croppedCanvas).drawImage(this.canvas,Math.round(-this.crop.x),Math.round(-this.crop.y)),this.croppedImage&&(this.croppedImage.src=this.croppedCanvas.toDataURL("image/png")),this.onChange&&this.onChange(this.croppedCanvas.width,this.croppedCanvas.height)}},{key:"updateSelectionRect",value:function(){var e=this.getViewportSelectionRect();(0,W.BB).css(this.selectionRectEl,{left:e.x+"px",top:e.y+"px",width:e.width+"px",height:e.height+"px",display:this.isReset()?"none":""}),this.onChange&&this.onChange(Math.round(this.crop.width),Math.round(this.crop.height))}},{key:"getEl",value:function(){return this.rootEl}},{key:"reset",value:function(){this.resetCrop(),this.updateCroppedCanvas(),this.updateSelectionRect()}},{key:"destroy",value:function(){this.rootEl.remove(),this.eventTarget.style.removeProperty("width"),this.eventTarget.style.removeProperty("height"),this.keyListener.destroy(),this.pointerListener.destroy(),this.preview.destroy()}},{key:"isReset",value:function(){return 0===this.crop.x&&0===this.crop.y&&this.crop.width===this.canvas.width&&this.crop.height===this.canvas.height}},{key:"getRect",value:function(){return(0,W.BB).copyObj(this.crop)}},{key:"getCroppedCanvas",value:function(){return this.croppedCanvas}}]),e}(),tc=I("exh8t"),W=I("eWjiX"),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),O=I("cx0mh"),D=I("7h4XF"),z=I("bX4ja"),W=I("eWjiX");function tu(e,t,i,n,r){if(f=i%e+n,v=Math.floor(i/e)+r,!(f<0)&&!(v<0)&&!(f>=e)&&!(v>=t))return v*e+f}function tp(e,t,i,n,r,a,s){return void 0!==s&&255!==t[s]&&!!(e[4*s]===r[0]&&e[4*s+1]===r[1]&&e[4*s+2]===r[2]&&e[4*s+3]===r[3]||a>0&&Math.abs(e[4*s]-r[0])<=a&&Math.abs(e[4*s+1]-r[1])<=a&&Math.abs(e[4*s+2]-r[2])<=a&&Math.abs(e[4*s+3]-r[3])<=a)&&(t[s]=255,!0)}function td(e,t,i,n,r,a,s,o){n=Math.round(n),r=Math.round(r);var l=new Uint8Array(new ArrayBuffer(t*i));return!function(e,t,i,n,r,a,s,o,l){var h,c,u,p,d,g,f,v,m,y,x,b,B=[e[(a*i+r)*4],e[(a*i+r)*4+1],e[(a*i+r)*4+2],e[(a*i+r)*4+3]];if(l){var w,k,C=[];for(C.push(a*i+r),t[a*i+r]=255;C.length;)k=tu(i,n,w=C.pop(),-1,0),tp(e,t,i,n,B,s,k)&&C.push(k),k=tu(i,n,w,1,0),tp(e,t,i,n,B,s,k)&&C.push(k),k=tu(i,n,w,0,-1),tp(e,t,i,n,B,s,k)&&C.push(k),k=tu(i,n,w,0,1),tp(e,t,i,n,B,s,k)&&C.push(k)}else for(var S=0;S<i*n;S++)tp(e,t,i,n,B,s,S);if(0!==o){for(var E=0;E<i;E++)for(var I=0;I<n;I++)255===t[I*i+E]&&(h=E,c=E,u=I,p=I,d=255!==t[I*i+E-1],g=255!==t[(I-1)*i+E-1],f=255!==t[(I-1)*i+E],v=255!==t[(I-1)*i+E+1],m=255!==t[I*i+E+1],y=255!==t[(I+1)*i+E+1],x=255!==t[(I+1)*i+E],b=255!==t[(I+1)*i+E-1],d&&(h=E-o),d&&g&&f&&(h=E-o,u=I-o),f&&(u=Math.min(u,I-o)),f&&v&&m&&(u=Math.min(u,I-o),c=E+o),m&&(c=Math.max(c,E+o)),m&&y&&x&&(c=Math.max(c,E+o),p=Math.max(p,I+o)),x&&(p=Math.max(p,I+o)),x&&b&&d&&(h=Math.min(h,E-o),p=Math.max(p,I+o)),(d||g||f||v||m||y||x||b)&&function(e,t,i,n,r,a){for(var s=i;s<=r;s++)for(var o=n;o<=a;o++)255!==e[o*t+s]&&(e[o*t+s]=254)}(t,i,Math.max(0,h),Math.max(0,u),Math.min(i-1,c),Math.min(n-1,p)));for(var A=0;A<i*n;A++)254===t[A]&&(t[A]=255)}}(e,l,t,i,n,r,a,s,o),{data:l}}var O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),W=I("eWjiX"),tg=function(){function e(t){(0,O._)(this,e),this.downX=0,this.downY=0,this.downAngleRad=0,this.onShape=t.onShape}return(0,D._)(e,[{key:"onDown",value:function(e,t,i){this.downX=e,this.downY=t,this.downAngleRad=i}},{key:"onMove",value:function(e,t){this.onShape(!1,this.downX,this.downY,e,t,this.downAngleRad)}},{key:"onUp",value:function(e,t){this.onShape(!0,this.downX,this.downY,e,t,this.downAngleRad)}}]),e}();function tf(e,t){if(["rect","ellipse","line"].includes((t=(0,X._)({angleRad:0,isOutwards:!1,opacity:1,isEraser:!1,doLockAlpha:!1},(0,W.BB).copyObj(t))).type)){if(void 0===t.angleRad)throw Error("angleRad undefined");var i,n,r=void 0===t.lineWidth?-1:Math.round(t.lineWidth),a=180*t.angleRad/Math.PI;if(!t.isEraser&&void 0===t.fillRgb&&void 0===t.strokeRgb)throw Error("fillRgb and strokeRgb undefined");var s=t.isEraser?{r:255,g:255,b:255}:t.fillRgb?t.fillRgb:t.strokeRgb;e.save(),t.opacity&&(e.globalAlpha=t.opacity),t.isEraser&&(e.globalCompositeOperation="destination-out"),t.doLockAlpha&&(e.globalCompositeOperation="source-atop"),e.rotate(-t.angleRad),t.fillRgb?e.fillStyle=(0,W.BB).ColorConverter.toRgbStr(s):t.strokeRgb&&(e.strokeStyle=(0,W.BB).ColorConverter.toRgbStr(s),e.lineWidth=r);var o=t.x1,l=t.y1,h=t.x2,c=t.y2;if(t.isAngleSnap){var u=(0,W.BB).rotate(o,l,t.angleRad/Math.PI*180),p=(0,W.BB).rotate(h,c,t.angleRad/Math.PI*180),d=(0,W.BB).pointsToAngleDeg(u,p)+90,g=45*Math.round(d/45),f=(0,W.BB).rotateAround({x:o,y:l},{x:h,y:c},g-d);h=f.x,c=f.y,(a+g)%90==0&&(Math.round((a-g)/90)%2==0?h=o:c=l)}var v=o,m=l,y=h-o,x=c-l;if("line"!==t.type&&t.isFixedRatio){var b=(0,W.BB).rotate(t.x1,t.y1,t.angleRad/Math.PI*180),B=(0,W.BB).rotate(t.x2,t.y2,t.angleRad/Math.PI*180),w=b.x,k=b.y,C=B.x-b.x,S=B.y-b.y;Math.abs(C)<Math.abs(S)?S=Math.abs(C)*(S<0?-1:1):C=Math.abs(S)*(C<0?-1:1),B.x=w+C,B.y=k+S,b=(0,W.BB).rotate(b.x,b.y,-t.angleRad/Math.PI*180),B=(0,W.BB).rotate(B.x,B.y,-t.angleRad/Math.PI*180),o=b.x,l=b.y,h=B.x,c=B.y,v=o,m=l,y=h-o,x=c-l}if(t.isOutwards&&(v-=y,m-=x,y*=2,x*=2,o=v,l=m,h=v+y,c=m+x),"line"===t.type){var E=Math.round(o),I=Math.round(l),A=Math.round(h),T=Math.round(c),M=Math.floor(o),L=Math.floor(l),R=Math.floor(h),P=Math.floor(c);r%2==0?I===T?(i={x:M,y:I},n={x:R,y:T},M<R?n.x+=1:i.x+=1):E===A?(i={x:E,y:L},n={x:A,y:P},L<P?n.y+=1:i.y+=1):(i={x:o,y:l},n={x:h,y:c}):(i={x:M,y:L},n={x:R,y:P},L===P?(M<R?n.x+=1:i.x+=1,i.y+=.5,n.y+=.5):M===R?(L<P?n.y+=1:i.y+=1,i.x+=.5,n.x+=.5):(i.x=o,i.y=l,n.x=h,n.y=c)),i=(0,W.BB).rotate(i.x,i.y,t.angleRad/Math.PI*180),n=(0,W.BB).rotate(n.x,n.y,t.angleRad/Math.PI*180),e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(n.x,n.y),e.stroke()}else if("rect"===t.type){var O=Math.floor(o),D=Math.floor(l),z=Math.floor(h),_=Math.floor(c);a%90==0?t.fillRgb?(o%1==0&&(o+=1),l%1==0&&(l+=1),h%1==0&&(h+=1),c%1==0&&(c+=1),i={x:o<h?O:z,y:l<c?D:_},(n={x:Math.ceil((o<h?h:o)-i.x),y:Math.ceil((l<c?c:l)-i.y)}).x=i.x+n.x,n.y=i.y+n.y):r%2==0?(i={x:O,y:D},n={x:z,y:_}):(i={x:O+.5,y:D+.5},n={x:z+.5,y:_+.5}):(i={x:o,y:l},n={x:h,y:c}),i=(0,W.BB).rotate(i.x,i.y,t.angleRad/Math.PI*180),(n=(0,W.BB).rotate(n.x,n.y,t.angleRad/Math.PI*180)).x=n.x-i.x,n.y=n.y-i.y,t.fillRgb?e.fillRect(i.x,i.y,n.x,n.y):e.strokeRect(i.x,i.y,n.x,n.y)}else i=(0,W.BB).rotate(o,l,t.angleRad/Math.PI*180),n=(0,W.BB).rotate(h,c,t.angleRad/Math.PI*180),v=i.x,m=i.y,y=n.x-i.x,x=n.y-i.y,e.beginPath(),e.ellipse(v+y/2,m+x/2,Math.abs(y/2),Math.abs(x/2),0,0,2*Math.PI),t.fillRgb?e.fill():e.stroke();e.restore()}else throw Error("unknown shape")}function tv(e,t){t=(0,W.BB).copyObj(t);var i=(0,W.BB).ctx(e);i.save(),i.textAlign=t.align,i.letterSpacing=t.letterSpacing?t.letterSpacing+"px":"0";var n=[t.size+"px "+(t.font?t.font:"sans-serif")];t.isBold&&n.unshift("bold"),t.isItalic&&n.unshift("italic"),i.font=n.join(" "),i.fillStyle=t.fill?(0,W.BB).ColorConverter.toRgbaStr(t.fill.color):"transparent",i.strokeStyle=t.stroke?(0,W.BB).ColorConverter.toRgbaStr(t.stroke.color):"transparent",t.stroke&&(i.lineWidth=t.stroke.lineWidth,i.lineJoin="round"),i.translate(t.x,t.y),i.rotate(-t.angleRad);var r=t.text.split("\n").map(function(e){return e.replaceAll("	","    ")}),a={x1:0,y1:0,x2:0,y2:0},s=!0;return r.forEach(function(e,n){var r,o,l,h,c,u,p=i.measureText(e),d=t.size*(null!==(u=t.lineHeight)&&void 0!==u?u:1)*n,g=(r=t.align,h=null!==(o=p.fontBoundingBoxAscent)&&void 0!==o?o:p.actualBoundingBoxAscent,c=null!==(l=p.fontBoundingBoxDescent)&&void 0!==l?l:p.actualBoundingBoxDescent,"left"===r?{x:0,y:-h,width:p.width,height:h+c}:"right"===r?{x:-p.width,y:-h,width:p.width,height:h+c}:{x:-p.width/2,y:-h,width:p.width,height:h+c});s?(s=!1,a.x1=0+g.x,a.y1=d+g.y,a.x2=0+g.x+g.width,a.y2=d+g.y+g.height):(a.x1=Math.min(a.x1,0+g.x),a.y1=Math.min(a.y1,d+g.y),a.x2=Math.max(a.x2,0+g.x+g.width),a.y2=Math.max(a.y2,d+g.y+g.height))}),r.forEach(function(e,n){var r,a=t.size*(null!==(r=t.lineHeight)&&void 0!==r?r:1)*n;i.strokeText(e,0,a)}),r.forEach(function(e,n){var r,a=t.size*(null!==(r=t.lineHeight)&&void 0!==r?r:1)*n;i.fillText(e,0,a)}),i.restore(),{x:a.x1,y:a.y1,width:a.x2-a.x1,height:a.y2-a.y1}}var W=(I("eWjiX"),I("eWjiX"));function tm(e,t){var i=(0,W.BB).canvas(Math.max(1,Math.round(e.width*t)),Math.max(1,Math.round(e.height*t))),n=(0,W.BB).ctx(i);n.save(),t>1&&(n.imageSmoothingEnabled=!1);for(var r=0;r<e.layers.length;r++){var a=e.layers[r];if(a.isVisible&&0!==a.opacity){n.globalAlpha=a.opacity;var s=a.mixModeStr;n.globalCompositeOperation=void 0!==s?s:"source-over",n.drawImage(a.image,0,0,i.width,i.height)}}return n.restore(),i}var O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),eR=I("4EWN2"),W=I("eWjiX"),ty=function(){function e(t){(0,O._)(this,e),this.downX=0,this.downY=0,this.downAngleRad=0,this.onGradient=t.onGradient}return(0,D._)(e,[{key:"onDown",value:function(e,t,i){this.downX=e,this.downY=t,this.downAngleRad=i}},{key:"onMove",value:function(e,t){this.onGradient(!1,this.downX,this.downY,e,t,this.downAngleRad)}},{key:"onUp",value:function(e,t){this.onGradient(!0,this.downX,this.downY,e,t,this.downAngleRad)}}]),e}();function tx(e,t){e.save();var i,n=t.x1,r=t.y1,a=t.x2,s=t.y2;if(t.doSnap){var o=180*t.angleRad/Math.PI,l=(0,W.BB).rotate(n,r,t.angleRad/Math.PI*180),h=(0,W.BB).rotate(a,s,t.angleRad/Math.PI*180),c=(0,W.BB).pointsToAngleDeg(l,h)+90,u=45*Math.round(c/45),p=(0,W.BB).rotateAround({x:n,y:r},{x:a,y:s},u-c);a=p.x,s=p.y,(o+u)%90==0&&(Math.round((o-u)/90)%2==0?a=n:s=r)}var d=t.color1;t.isEraser&&t.doLockAlpha&&(d={r:255,g:255,b:255});var g=(0,eR._)((0,X._)({},d),{a:t.opacity}),f=(0,eR._)((0,X._)({},d),{a:0});if(t.isReversed){var v=g;g=f,f=v}if("linear"===t.type)(i=e.createLinearGradient(n,r,a,s)).addColorStop(0,(0,W.BB).ColorConverter.toRgbaStr(g)),i.addColorStop(1,(0,W.BB).ColorConverter.toRgbaStr(f));else if("linear-mirror"===t.type){var m={x:a-n,y:s-r};(i=e.createLinearGradient(n-m.x,r-m.y,a,s)).addColorStop(0,(0,W.BB).ColorConverter.toRgbaStr(f)),i.addColorStop(.5,(0,W.BB).ColorConverter.toRgbaStr(g)),i.addColorStop(1,(0,W.BB).ColorConverter.toRgbaStr(f))}else if("radial"===t.type){var y=(0,W.BB).Vec2.dist({x:n,y:r},{x:a,y:s});(i=e.createRadialGradient(n,r,0,n,r,y)).addColorStop(0,(0,W.BB).ColorConverter.toRgbaStr(g)),i.addColorStop(1,(0,W.BB).ColorConverter.toRgbaStr(f))}e.fillStyle=i,t.isEraser&&(e.globalCompositeOperation="destination-out"),t.doLockAlpha&&(e.globalCompositeOperation="source-atop"),e.fillRect(0,0,e.canvas.width,e.canvas.height),e.restore()}var _=I("7jh4K"),tb=["source-over","darken","multiply","color-burn","lighten","screen","color-dodge","overlay","soft-light","hard-light","difference","exclusion","hue","saturation","color","luminosity"],tB=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if((0,O._)(this,e),this.layerNrOffset=i,this.isDestroyed=!1,this.layerCanvasArr=[],this.pickCanvas=(0,W.BB).canvas(1,1),this.history=new F,"copy"in t?(this.width=1,this.height=1):"width"in t&&"height"in t?(this.width=t.width,this.height=t.height):(this.width=1,this.height=1),this.init(this.width,this.height),this.changeListenerArr=[],"copy"in t)try{this.copy(t.copy)}catch(e){throw this.destroy(),e}else if("projectObj"in t){var n=(0,z._)(t.projectObj.layers);if(this.init(t.projectObj.width,t.projectObj.height),!n.length)throw Error("project.layers needs at least 1 layer");for(var r=0;r<n.length;r++){var a=n[r].mixModeStr;if(a&&!tb.includes(a))throw Error("unknown mixModeStr "+n[r].mixModeStr);this.addLayer(),this.layerOpacity(r,n[r].opacity),this.layerCanvasArr[r].name=n[r].name,this.layerCanvasArr[r].isVisible=n[r].isVisible,this.layerCanvasArr[r].mixModeStr=a||"source-over",(0,W.BB).ctx(this.layerCanvasArr[r]).drawImage(n[r].image,0,0)}}this.updateIndices()}return(0,D._)(e,[{key:"init",value:function(e,t){if(!e||!t||isNaN(e)||isNaN(t)||e<1||t<1)throw Error("init - invalid canvas size: "+e+", "+t);this.width=e,this.height=t}},{key:"emitChange",value:function(){this.changeListenerArr.forEach(function(e){return e()})}},{key:"updateIndices",value:function(){this.layerCanvasArr.forEach(function(e,t){e.index=t})}},{key:"setHistory",value:function(e){this.history=e}},{key:"reset",value:function(e){if(!e.width||!e.height||e.width<1||e.height<1||isNaN(e.width)||isNaN(e.height))throw Error("invalid canvas size");if(this.history.pause(!0),this.width=e.width,this.height=e.height,this.layerCanvasArr.splice(1,Math.max(0,this.layerCanvasArr.length-1)),e.layers)for(var t=0;t<e.layers.length;t++){var i=e.layers[t];this.layerCanvasArr[t]||this.addLayer(),this.layerCanvasArr[t].name=i.name,this.layerCanvasArr[t].isVisible=i.isVisible,this.layerCanvasArr[t].width=this.width,this.layerCanvasArr[t].height=this.height,this.layerCanvasArr[t].mixModeStr=i.mixModeStr?i.mixModeStr:"source-over",(0,W.BB).ctx(this.layerCanvasArr[t]).drawImage(i.image,0,0),this.layerOpacity(t,i.opacity)}else this.layerCanvasArr[0].name=e.layerName?e.layerName:J("layers-layer")+" 1",this.layerCanvasArr[0].isVisible=!0,this.layerCanvasArr[0].width=this.width,this.layerCanvasArr[0].height=this.height,this.layerCanvasArr[0].mixModeStr="source-over",this.layerOpacity(0,1),e.color?this.layerFill(0,e.color):e.image&&(0,W.BB).ctx(this.layerCanvasArr[0]).drawImage(e.image,0,0);return this.updateIndices(),this.history.pause(!1),this.history.push({tool:["canvas"],action:"reset",params:[e]}),this.layerCanvasArr.length-1}},{key:"isLayerLimitReached",value:function(){return this.layerCanvasArr.length>=16}},{key:"getWidth",value:function(){return this.width}},{key:"getHeight",value:function(){return this.height}},{key:"copy",value:function(e){if(1>e.getWidth()||1>e.getHeight()||isNaN(e.getWidth())||isNaN(e.getHeight()))throw Error("invalid canvas size");for(var t=e.getLayers();this.layerCanvasArr.length>t.length;)this.removeLayer(this.layerCanvasArr.length-1);(e.getWidth()!=this.width||e.getHeight()!=this.height)&&this.init(e.getWidth(),e.getHeight());for(var i=0;i<t.length;i++)i>=this.layerCanvasArr.length?this.addLayer():(this.layerCanvasArr[i].width=this.width,this.layerCanvasArr[i].height=this.height),this.layerOpacity(i,t[i].opacity),this.layerCanvasArr[i].name=t[i].name,this.layerCanvasArr[i].isVisible=t[i].isVisible,this.layerCanvasArr[i].mixModeStr=t[i].mixModeStr,(0,W.BB).ctx(this.layerCanvasArr[i]).drawImage(t[i].context.canvas,0,0);this.updateIndices()}},{key:"getLayerCount",value:function(){return this.layerCanvasArr.length}},{key:"resize",value:function(e,t){var i,n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"smooth";if(!e||!t||e===this.width&&t===this.height||isNaN(e)||isNaN(t)||e<1||t<1)return!1;if(e=Math.max(e,1),t=Math.max(t,1),"pixelated"===r){i=(0,W.BB).canvas(e,t);var a=(0,W.BB).ctx(i);a.imageSmoothingEnabled=!1;for(var s=0;s<this.layerCanvasArr.length;s++){s>0&&a.clearRect(0,0,e,t);var o=this.layerCanvasArr[s];a.drawImage(o,0,0,e,t),o.width=e,o.height=t,(0,W.BB).ctx(o).drawImage(i,0,0)}}else if("smooth"===r){i=(0,W.BB).canvas(),n=(0,W.BB).canvas();for(var l=0;l<this.layerCanvasArr.length;l++)(0,W.BB).resizeCanvas(this.layerCanvasArr[l],e,t,i,n)}else throw Error("unknown resize algorithm");return this.width=e,this.height=t,!0}},{key:"resizeCanvas",value:function(e){var t=Math.round(e.left)+this.width+Math.round(e.right),i=Math.round(e.top)+this.height+Math.round(e.bottom),n=Math.round(e.left),r=Math.round(e.top);if(isNaN(t)||isNaN(i)||t<1||i<1)throw Error("KlCanvas.resizeCanvas - invalid canvas size");for(var a=0;a<this.layerCanvasArr.length;a++){var s=(0,W.BB).canvas(this.width,this.height),o=this.layerCanvasArr[a],l=(0,W.BB).ctx(this.layerCanvasArr[a]);(0,W.BB).ctx(s).drawImage(o,0,0),this.layerCanvasArr[a].width=t,this.layerCanvasArr[a].height=i,l.save(),0===a&&e.fillColor&&(l.fillStyle=(0,W.BB).ColorConverter.toRgbStr(e.fillColor),l.fillRect(0,0,t,i),l.clearRect(n,r,this.width,this.height)),l.drawImage(s,n,r),l.restore()}this.width=t,this.height=i}},{key:"addLayer",value:function(e){if(this.isLayerLimitReached())return!1;var t=(0,W.BB).canvas(this.width,this.height);if(!t.getContext("2d"))throw Error("kl-create-canvas-error");return t.isVisible=!0,t.mixModeStr="source-over",void 0===e?(this.layerCanvasArr[this.layerCanvasArr.length]=t,e=Math.max(0,this.layerCanvasArr.length-1)):(this.layerCanvasArr.splice(e+1,0,t),e++),t.name=J("layers-layer")+" "+(this.layerCanvasArr.length+this.layerNrOffset),this.history.pause(!0),this.layerOpacity(e,1),this.history.pause(!1),this.updateIndices(),this.history.push({tool:["canvas"],action:"addLayer",params:[e-1]}),e}},{key:"duplicateLayer",value:function(e){if(!this.layerCanvasArr[e]||this.isLayerLimitReached())return!1;var t=(0,W.BB).canvas(this.width,this.height);return this.layerCanvasArr.splice(e+1,0,t),t.name=this.layerCanvasArr[e].name+" "+J("layers-copy"),t.isVisible=this.layerCanvasArr[e].isVisible,t.mixModeStr=this.layerCanvasArr[e].mixModeStr,(0,W.BB).ctx(t).putImageData((0,W.BB).ctx(this.layerCanvasArr[e]).getImageData(0,0,this.width,this.height),0,0),this.history.pause(!0),this.layerOpacity(e+1,this.layerCanvasArr[e].opacity),this.history.pause(!1),this.updateIndices(),this.history.push({tool:["canvas"],action:"duplicateLayer",params:[e]}),e+1}},{key:"getLayerContext",value:function(e,t){if(this.layerCanvasArr[e])return(0,W.BB).ctx(this.layerCanvasArr[e]);if(t)return null;throw Error("layer of index "+e+" not found (in "+this.layerCanvasArr.length+" layers)")}},{key:"removeLayer",value:function(e){return!!this.layerCanvasArr[e]&&(this.layerCanvasArr.splice(e,1),this.updateIndices(),this.history.push({tool:["canvas"],action:"removeLayer",params:[e]}),Math.max(0,e-1))}},{key:"renameLayer",value:function(e,t){return!!this.layerCanvasArr[e]&&(this.layerCanvasArr[e].name=t,this.history.push({tool:["canvas"],action:"renameLayer",params:[e,t]}),!0)}},{key:"layerOpacity",value:function(e,t){this.layerCanvasArr[e]&&(t=Math.max(0,Math.min(1,t)),this.layerCanvasArr[e].opacity=t,this.history.push({tool:["canvas"],action:"layerOpacity",params:[e,t]}),this.emitChange())}},{key:"setLayerIsVisible",value:function(e,t){if(this.layerCanvasArr[e])this.layerCanvasArr[e].isVisible=t;else throw Error("layer ".concat(e," undefined"));this.history.push({tool:["canvas"],action:"setLayerIsVisible",params:[e,t]})}},{key:"moveLayer",value:function(e,t){if(0!==t&&this.layerCanvasArr[e]){var i=this.layerCanvasArr[e];this.layerCanvasArr.splice(e,1);var n=Math.max(0,Math.min(e+t,this.layerCanvasArr.length));return this.layerCanvasArr.splice(n,0,i),this.updateIndices(),this.history.push({tool:["canvas"],action:"moveLayer",params:[e,t]}),n}}},{key:"mergeLayers",value:function(e,t,i){if(this.layerCanvasArr[e]&&this.layerCanvasArr[t]&&e!==t){if(e>t){var n=e;e=t,t=n}var r=this.layerCanvasArr[t].opacity;if(0!==r&&r){var a=(0,W.BB).ctx(this.layerCanvasArr[e]);a.save(),"as-alpha"===i?((0,W.BB).convertToAlphaChannelCanvas(this.layerCanvasArr[t]),a.globalCompositeOperation="destination-in"):i&&(a.globalCompositeOperation=i),a.globalAlpha=r,(0,W.BB).ctx(this.layerCanvasArr[e]).drawImage(this.layerCanvasArr[t],0,0),a.restore(),i&&(a.save(),a.fillStyle="rgba(0,0,0,0.01)",a.fillRect(-.9999999,-.9999999,1,1),a.restore())}return this.updateIndices(),this.history.pause(!0),this.removeLayer(t),this.history.pause(!1),this.history.push({tool:["canvas"],action:"mergeLayers",params:[e,t,i]}),e}}},{key:"mergeAll",value:function(){if(1===this.layerCanvasArr.length)return!1;for(var e=(0,W.BB).ctx(this.layerCanvasArr[0]),t=1;t<this.layerCanvasArr.length;t++){var i=this.layerCanvasArr[t];i.isVisible&&0!==i.opacity&&(e.save(),e.globalCompositeOperation=i.mixModeStr,e.globalAlpha=i.opacity,e.drawImage(i,0,0),e.restore())}this.history.pause(!0);for(var n=this.layerCanvasArr.length-1;n>0;n--)this.removeLayer(n);return this.renameLayer(0,J("layers-layer")+" 1"),this.history.pause(!1),this.history.push({tool:["canvas"],action:"mergeAll",params:[]}),0}},{key:"rotate",value:function(e){for(;e<0;)e+=360;if((e%=360)%90==0&&0!==e){var t=(0,W.BB).canvas();0===e||180===e?(t.width=this.width,t.height=this.height):(90===e||270===e)&&(t.width=this.height,t.height=this.width);for(var i=(0,W.BB).ctx(t),n=0;n<this.layerCanvasArr.length;n++)i.clearRect(0,0,t.width,t.height),i.save(),i.translate(t.width/2,t.height/2),i.rotate(e*Math.PI/180),180===e?i.drawImage(this.layerCanvasArr[n],-t.width/2,-t.height/2):(90===e||270===e)&&i.drawImage(this.layerCanvasArr[n],-t.height/2,-t.width/2),this.layerCanvasArr[n].width=t.width,this.layerCanvasArr[n].height=t.height,(0,W.BB).ctx(this.layerCanvasArr[n]).clearRect(0,0,this.layerCanvasArr[n].width,this.layerCanvasArr[n].height),(0,W.BB).ctx(this.layerCanvasArr[n]).drawImage(t,0,0),i.restore();this.width=t.width,this.height=t.height}}},{key:"flip",value:function(e,t,i){if(e||t){var n=(0,W.BB).canvas(this.width,this.height);n.width=this.width,n.height=this.height;for(var r=(0,W.BB).ctx(n),a=0;a<this.layerCanvasArr.length;a++)(i||0===i)&&a!==i||(r.save(),r.clearRect(0,0,n.width,n.height),r.translate(n.width/2,n.height/2),r.scale(e?-1:1,t?-1:1),r.drawImage(this.layerCanvasArr[a],-n.width/2,-n.height/2),r.restore(),(0,W.BB).ctx(this.layerCanvasArr[a]).clearRect(0,0,this.layerCanvasArr[a].width,this.layerCanvasArr[a].height),(0,W.BB).ctx(this.layerCanvasArr[a]).drawImage(n,0,0))}}},{key:"layerFill",value:function(e,t,i){var n=(0,W.BB).ctx(this.layerCanvasArr[e]);n.save(),i&&(n.globalCompositeOperation=i),n.fillStyle="rgba("+t.r+","+t.g+","+t.b+",1)",n.fillRect(0,0,this.layerCanvasArr[e].width,this.layerCanvasArr[e].height),n.restore(),n.save(),n.fillStyle="rgba(0,0,0,0.01)",n.fillRect(-.9999999,-.9999999,1,1),n.restore(),this.history.push({tool:["canvas"],action:"layerFill",params:[e,t,i]})}},{key:"floodFill",value:function(e,t,i,n,r,a,s,o,l){if(!(t<0)&&!(i<0)&&!(t>=this.width)&&!(i>=this.height)&&0!==r){if(a=Math.round(a),!["above","current","all"].includes(s))throw Error("invalid sampleStr");if("all"===s){var h,c,u,p=1===this.layerCanvasArr.length?this.layerCanvasArr[0]:this.getCompleteCanvas(1);h=td((0,W.BB).ctx(p).getImageData(0,0,this.width,this.height).data,this.width,this.height,t,i,a,Math.round(o),l),u=(c=(0,W.BB).ctx(this.layerCanvasArr[e])).getImageData(0,0,this.width,this.height)}else{var d="above"===s?e+1:e;if(d>=this.layerCanvasArr.length)return;var g=(0,W.BB).ctx(this.layerCanvasArr[d]),f=g.getImageData(0,0,this.width,this.height);h=td(f.data,this.width,this.height,t,i,a,Math.round(o),l),c=e===d?g:(0,W.BB).ctx(this.layerCanvasArr[e]),u=e===d?f:c.getImageData(0,0,this.width,this.height)}var v=u.data;if(n){if(1===r)for(var m=0;m<this.width*this.height;m++)255===h.data[m]&&(v[4*m]=n.r,v[4*m+1]=n.g,v[4*m+2]=n.b,v[4*m+3]=255);else for(var y=0;y<this.width*this.height;y++)255===h.data[y]&&(v[4*y]=(0,W.BB).mix(v[4*y],n.r,r),v[4*y+1]=(0,W.BB).mix(v[4*y+1],n.g,r),v[4*y+2]=(0,W.BB).mix(v[4*y+2],n.b,r),v[4*y+3]=(0,W.BB).mix(v[4*y+3],255,r))}else if(1===r)for(var x=0;x<this.width*this.height;x++)255===h.data[x]&&(v[4*x+3]=0);else for(var b=0;b<this.width*this.height;b++)255===h.data[b]&&(v[4*b+3]=(0,W.BB).mix(v[4*b+3],0,r));c.putImageData(u,0,0),this.history.push({tool:["canvas"],action:"replaceLayer",params:[e,u]})}}},{key:"drawShape",value:function(e,t){(t.x1!==t.x2||t.y1!==t.y2)&&(tf((0,W.BB).ctx(this.layerCanvasArr[e]),t),this.history.push({tool:["canvas"],action:"drawShape",params:[e,(0,W.BB).copyObj(t)]}))}},{key:"drawGradient",value:function(e,t){tx((0,W.BB).ctx(this.layerCanvasArr[e]),t),this.history.push({tool:["canvas"],action:"drawGradient",params:[e,(0,W.BB).copyObj(t)]})}},{key:"text",value:function(e,t){tv(this.layerCanvasArr[e],(0,W.BB).copyObj(t)),this.history.push({tool:["canvas"],action:"text",params:[e,(0,W.BB).copyObj(t)]})}},{key:"replaceLayer",value:function(e,t){(0,W.BB).ctx(this.layerCanvasArr[e]).putImageData(t,0,0),this.history.push({tool:["canvas"],action:"replaceLayer",params:[e,t]})}},{key:"clearLayer",value:function(e){var t=(0,W.BB).ctx(this.layerCanvasArr[e]);t.save(),t.clearRect(0,0,this.layerCanvasArr[e].width,this.layerCanvasArr[e].height),t.restore(),this.history.push({tool:["canvas"],action:"clearLayer",params:[e]})}},{key:"getLayers",value:function(){return this.layerCanvasArr.map(function(e){return{context:(0,W.BB).ctx(e),isVisible:e.isVisible,opacity:e.opacity,name:e.name,mixModeStr:e.mixModeStr}})}},{key:"getLayersFast",value:function(){return this.layerCanvasArr.map(function(e){return{canvas:e,isVisible:e.isVisible,opacity:e.opacity,name:e.name,mixModeStr:e.mixModeStr}})}},{key:"getLayerIndex",value:function(e,t){for(var i=0;i<this.layerCanvasArr.length;i++)if(this.layerCanvasArr[i]===e)return i;if(!t)throw Error("layer not found (in "+this.layerCanvasArr.length+" layers)");return null}},{key:"getLayer",value:function(e,t){if(this.layerCanvasArr[e])return{context:(0,W.BB).ctx(this.layerCanvasArr[e]),isVisible:this.layerCanvasArr[e].isVisible,opacity:this.layerCanvasArr[e].opacity,name:this.layerCanvasArr[e].name,id:e};if(!t)throw Error("layer of index "+e+" not found (in "+this.layerCanvasArr.length+" layers)");return null}},{key:"getColorAt",value:function(e,t){e=Math.floor(e),t=Math.floor(t);var i=(0,W.BB).ctx(this.pickCanvas);i.save(),i.imageSmoothingEnabled=!1,i.clearRect(0,0,1,1);for(var n=0;n<this.layerCanvasArr.length;n++){var r=this.layerCanvasArr[n];r.isVisible&&0!==r.opacity&&(i.globalAlpha=r.opacity,i.globalCompositeOperation=r.mixModeStr,i.drawImage(r,-e,-t))}i.restore();var a=i.getImageData(0,0,1,1);return new W.BB.RGB(a.data[0],a.data[1],a.data[2])}},{key:"getCompleteCanvas",value:function(e){return tm(this.getProject(),e)}},{key:"getProject",value:function(){return{width:this.width,height:this.height,layers:this.layerCanvasArr.map(function(e){return{name:e.name,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr,image:e}})}}},{key:"addChangeListener",value:function(e){this.changeListenerArr.includes(e)||this.changeListenerArr.push(e)}},{key:"removeChangeListener",value:function(e){for(var t=0;t<this.changeListenerArr.length;t++)if(this.changeListenerArr[t]===e){this.changeListenerArr.splice(t,1);return}}},{key:"setMixMode",value:function(e,t){if(!this.layerCanvasArr[e])throw Error("invalid layer");this.layerCanvasArr[e].mixModeStr=t,this.history.push({tool:["canvas"],action:"setMixMode",params:[e,""+t]})}},{key:"setComposite",value:function(e,t){if(!this.layerCanvasArr[e])throw Error("invalid layer");this.layerCanvasArr[e].compositeObj=(0,_.nullToUndefined)(t)}},{key:"destroy",value:function(){this.isDestroyed||(this.layerCanvasArr.forEach(function(e){(0,W.BB).freeCanvas(e)}),this.layerCanvasArr=[],this.isDestroyed=!0)}}]),e}();function tw(e){if(!e)return J("layers-blend-normal");var t={"source-over":"layers-blend-normal",darken:"layers-blend-darken",multiply:"layers-blend-multiply","color-burn":"layers-blend-color-burn",lighten:"layers-blend-lighten",screen:"layers-blend-screen","color-dodge":"layers-blend-color-dodge",overlay:"layers-blend-overlay","soft-light":"layers-blend-soft-light","hard-light":"layers-blend-hard-light",difference:"layers-blend-difference",exclusion:"layers-blend-exclusion",hue:"layers-blend-hue",saturation:"layers-blend-saturation",color:"layers-blend-color",luminosity:"layers-blend-luminosity"};if(!(e in t))throw Error("unknown blend mode");return J(t[e])}var W=I("eWjiX"),tk={};tk=I("f6OTe").getBundleURL("lYbF2")+"remove-layer.4e9b2b7d.svg";var W=I("eWjiX"),eI=(I("1C8RU"),I("1C8RU")),_=I("7jh4K"),tC=I("6J2My"),O=I("cx0mh"),D=I("7h4XF"),ef=I("72Jv0"),tS=function(){function e(t){var i=this;(0,O._)(this,e),this.isExpanded=!1,this.onSetEnabled=function(){return 0};var n=ev("button,w-full,h-full",[t.button]);n.onclick=function(){o(!i.isExpanded)},t.buttonTitle&&(n.title=t.buttonTitle),(0,ef.makeUnfocusable)(n);var r=[],a={};t.items.forEach(function(e){var i=ev("button",e[1]);(0,ef.makeUnfocusable)(i),i.onclick=function(){o(!1),t.onItemClick(e[0])},r.push(i),a[e[0]]=i}),this.onSetEnabled=function(e,t){a[e].disabled=!t};var s=ev(".kl-dropdown-menu,right-0,top-full,nowrap,hidden",r);this.rootElement=ev(",pos-relative",[n,s]);var o=function(e){i.isExpanded=e,s.style.display=i.isExpanded?"block":"none",i.isExpanded?(document.addEventListener("pointerdown",l),window.addEventListener("blur",h)):(document.removeEventListener("pointerdown",l),window.removeEventListener("blur",h))},l=function(e){var t=e.target;n.contains(t)||s.contains(t)||o(!1)},h=function(){return o(!1)}}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootElement}},{key:"setEnabled",value:function(e,t){this.onSetEnabled(e,t)}}]),e}(),tE={};tE=I("f6OTe").getBundleURL("lYbF2")+"add-layer.ce1078bb.svg";var tI={};tI=I("f6OTe").getBundleURL("lYbF2")+"duplicate-layer.3314e3c7.svg";var tA={};tA=I("f6OTe").getBundleURL("lYbF2")+"merge-layers.19da79a6.svg";var tT={};tT=I("f6OTe").getBundleURL("lYbF2")+"rename-layer.7c31d4f4.svg";var tM={};tM=I("f6OTe").getBundleURL("lYbF2")+"caret-down.68d4cd16.svg";var tL=function(){function e(i,n,r,a){var s,o,l=this;(0,O._)(this,e),this.lastpos=0,this.layerHeight=35,this.layerSpacing=0,this.parentEl=r,this.klCanvas=i,this.layerElArr=[],this.layerHeight=35,this.layerSpacing=0,this.onSelect=n,this.uiState=a,this.largeThumbDiv=(0,W.BB).el({onClick:W.BB.handleClick,css:{position:"absolute",top:"500px",background:"#aaa",boxShadow:"1px 1px 3px rgba(0,0,0,0.3)",pointerEvents:"none",padding:"0",border:"1px solid #aaa",transition:"opacity 0.3s ease-out",userSelect:"none"}}),this.setUiState(a),(0,W.BB).createCheckerDataUrl(4,function(e){l.largeThumbDiv.style.backgroundImage="url("+e+")"},(0,eI.theme).isDark()),this.largeThumbCanvas=(0,W.BB).canvas(200,200),this.largeThumbCanvas.style.display="block",this.largeThumbDiv.append(this.largeThumbCanvas),this.largeThumbInDocument=!1,this.klCanvasLayerArr=this.klCanvas.getLayers(),this.selectedSpotIndex=this.klCanvasLayerArr.length-1,this.rootEl=(0,W.BB).el({css:{marginRight:"10px",marginBottom:"10px",marginLeft:"10px",marginTop:"10px",cursor:"default"}});var h=(0,W.BB).el({css:{width:"270px",position:"relative",margin:"0 -10px",zIndex:"0"}});this.layerListEl=(0,W.BB).el({parent:h}),this.addBtn=(0,W.BB).el({tagName:"button"}),this.duplicateBtn=(0,W.BB).el({tagName:"button"}),this.mergeBtn=(0,W.BB).el({tagName:"button"}),this.removeBtn=(0,W.BB).el({tagName:"button"});var c=(0,W.BB).el({tagName:"button"});this.moreDropdown=new tS({button:(0,W.BB).el({content:'<img src="'.concat(t(tM),'" width="13"/>'),css:{display:"flex",justifyContent:"center",opacity:"0.9"}}),buttonTitle:J("more"),items:[["merge-all",J("layers-merge-all")]],onItemClick:function(e){if("merge-all"===e){var t=l.klCanvas.mergeAll();!1!==t&&(l.klCanvasLayerArr=l.klCanvas.getLayers(),l.selectedSpotIndex=t,l.createLayerList(),V.pause(!0),l.onSelect(l.selectedSpotIndex),V.pause(!1),l.updateButtons())}}}),this.updateButtons(),this.rootEl.append((s=(0,W.BB).el(),setTimeout(function(){(0,W.BB).makeUnfocusable(l.addBtn),(0,W.BB).makeUnfocusable(l.duplicateBtn),(0,W.BB).makeUnfocusable(l.mergeBtn),(0,W.BB).makeUnfocusable(l.removeBtn),(0,W.BB).makeUnfocusable(c),l.addBtn.style.cssFloat="left",l.duplicateBtn.style.cssFloat="left",l.mergeBtn.style.cssFloat="left",l.removeBtn.style.cssFloat="left",c.style.cssFloat="left",l.addBtn.title=J("layers-new"),l.duplicateBtn.title=J("layers-duplicate"),l.removeBtn.title=J("layers-remove"),l.mergeBtn.title=J("layers-merge"),c.title=J("layers-rename-title"),l.addBtn.style.paddingLeft="5px",l.addBtn.style.paddingRight="3px",l.removeBtn.style.paddingLeft="5px",l.removeBtn.style.paddingRight="3px",l.duplicateBtn.style.paddingLeft="5px",l.duplicateBtn.style.paddingRight="3px",l.mergeBtn.style.paddingLeft="5px",l.mergeBtn.style.paddingRight="3px",c.style.height="30px",c.style.lineHeight="20px",l.addBtn.innerHTML="<img src='"+t(tE)+"' height='20'/>",l.duplicateBtn.innerHTML="<img src='"+t(tI)+"' height='20'/>",l.mergeBtn.innerHTML="<img src='"+t(tA)+"' height='20'/>",l.removeBtn.innerHTML="<img src='"+t(tk)+"' height='20'/>",c.innerHTML="<img src='"+t(tT)+"' height='20'/>",s.append(ev(",flex,gap-5,mb-10",[l.addBtn,l.removeBtn,l.duplicateBtn,l.mergeBtn,c,ev(",grow-1"),l.moreDropdown.getElement()])),l.addBtn.onclick=function(){!1!==l.klCanvas.addLayer(l.selectedSpotIndex)&&(l.klCanvasLayerArr=l.klCanvas.getLayers(),l.selectedSpotIndex=l.selectedSpotIndex+1,l.createLayerList(),V.pause(!0),l.onSelect(l.selectedSpotIndex),V.pause(!1),l.updateButtons())},l.duplicateBtn.onclick=function(){!1!==l.klCanvas.duplicateLayer(l.selectedSpotIndex)&&(l.klCanvasLayerArr=l.klCanvas.getLayers(),l.selectedSpotIndex++,l.createLayerList(),V.pause(!0),l.onSelect(l.selectedSpotIndex),V.pause(!1),l.updateButtons())},l.removeBtn.onclick=function(){l.layerElArr.length<=1||(l.klCanvas.removeLayer(l.selectedSpotIndex),l.selectedSpotIndex>0&&l.selectedSpotIndex--,l.klCanvasLayerArr=l.klCanvas.getLayers(),l.createLayerList(),V.pause(!0),l.onSelect(l.selectedSpotIndex),V.pause(!1),l.updateButtons())},l.mergeBtn.onclick=function(){l.selectedSpotIndex<=0||function(e,t){var i=(0,W.BB).el();i.innerHTML=J("layers-merge-description");var n=new eD({optionArr:[{id:t.mixModeStr,label:tw(t.mixModeStr)},{id:"source-in",label:"source-in"},{id:"source-out",label:"source-out"},{id:"source-atop",label:"source-atop"},{id:"destination-in",label:"destination-in"},{id:"destination-out",label:"destination-out"},{id:"destination-atop",label:"destination-atop"},{id:"xor",label:"xor"}],initId:t.mixModeStr,onChange:function(){h()},isSmall:!0});n.getElement().style.marginTop="5px",i.append(n.getElement());var r=(0,W.BB).fitInto(t.topCanvas.width,t.topCanvas.height,200,200,1),a=(0,W.BB).canvas(r.width,r.height);a.title=J("preview"),a.className="kl-merge-preview";var s=(0,W.BB).el({content:"<br/>",css:{clear:"both"}});function o(){(0,W.BB).createCheckerDataUrl(4,function(e){a.style.backgroundImage="url("+e+")"},(0,eI.theme).isDark())}i.append(s,a),o(),(0,eI.theme).addIsDarkListener(o);var l=(0,W.BB).copyCanvas(a);(0,W.BB).ctx(l).drawImage(t.topCanvas,0,0,l.width,l.height),(0,W.BB).convertToAlphaChannelCanvas(l);var h=function(){var e=(0,W.BB).ctx(a);e.save(),e.clearRect(0,0,a.width,a.height),a.width>t.topCanvas.width&&(e.imageSmoothingEnabled=!1),e.drawImage(t.bottomCanvas,0,0,a.width,a.height),"as-alpha"===n.getValue()?(e.globalCompositeOperation="destination-in",e.globalAlpha=t.topOpacity,e.drawImage(l,0,0,a.width,a.height)):(e.globalCompositeOperation=n.getValue(),e.globalAlpha=t.topOpacity,e.drawImage(t.topCanvas,0,0,a.width,a.height)),e.restore()};h();var c=new W.BB.KeyListener({onDown:function(e){"right"===e&&n.next(),"left"===e&&n.previous()}});et({target:e,message:"<b>".concat(J("layers-merge-modal-title"),"</b>"),div:i,buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(e){c.destroy(),n.destroy(),(0,eI.theme).removeIsDarkListener(o),"Ok"===e&&t.callback(n.getValue())}})}(l.parentEl,{topCanvas:l.klCanvasLayerArr[l.selectedSpotIndex].context.canvas,bottomCanvas:l.klCanvasLayerArr[l.selectedSpotIndex-1].context.canvas,topOpacity:l.klCanvas.getLayer(l.selectedSpotIndex).opacity,mixModeStr:l.klCanvasLayerArr[l.selectedSpotIndex].mixModeStr,callback:function(e){l.klCanvas.mergeLayers(l.selectedSpotIndex,l.selectedSpotIndex-1,e),l.klCanvasLayerArr=l.klCanvas.getLayers(),l.selectedSpotIndex--,l.createLayerList(),V.pause(!0),l.onSelect(l.selectedSpotIndex),V.pause(!1),l.updateButtons()}})},c.onclick=function(){l.renameLayer(l.selectedSpotIndex)}},1),s)),o=(0,W.BB).el({content:J("layers-blending")+"&nbsp;",css:{fontSize:"15px"}}),this.modeSelect=new ea({optionArr:["source-over",void 0,"darken","multiply","color-burn",void 0,"lighten","screen","color-dodge",void 0,"overlay","soft-light","hard-light",void 0,"difference","exclusion",void 0,"hue","saturation","color","luminosity"].map(function(e){return e?[e,tw(e)]:void 0}),onChange:function(e){l.klCanvas.setMixMode(l.selectedSpotIndex,e),l.update(l.selectedSpotIndex)},css:{marginBottom:"10px"}}),o.append(this.modeSelect.getElement()),this.rootEl.append(o),this.rootEl.append(h),setInterval(function(){if("block"===l.rootEl.style.display){var e=V.getState();if(e!==l.oldHistoryState){l.oldHistoryState=e;for(var t=0;t<l.layerElArr.length;t++)if(l.selectedSpotIndex===l.layerElArr[t].spot&&l.klCanvasLayerArr[l.layerElArr[t].spot]){var i=(0,W.BB).ctx(l.layerElArr[t].thumb);i.save(),i.clearRect(0,0,i.canvas.width,i.canvas.height),l.klCanvasLayerArr[l.layerElArr[t].spot].context.canvas.width<l.layerElArr[t].thumb.width&&(i.imageSmoothingEnabled=!1),i.drawImage(l.klCanvasLayerArr[l.layerElArr[t].spot].context.canvas,0,0,l.layerElArr[t].thumb.width,l.layerElArr[t].thumb.height),i.restore()}}}},1),(0,eI.theme).addIsDarkListener(function(){l.createLayerList()}),this.createLayerList()}return(0,D._)(e,[{key:"move",value:function(e,t){var i=this;if(isNaN(e)||isNaN(t))throw"layermanager - invalid move";for(var n=0;n<this.klCanvasLayerArr.length;n++)!function(n){var r=i.layerElArr[n].spot;i.layerElArr[n].spot===e?r=t:(i.layerElArr[n].spot>e&&r--,r>=t&&r++),i.layerElArr[n].spot=r,i.layerElArr[n].posY=(i.layerHeight+i.layerSpacing)*(i.klCanvasLayerArr.length-r-1),i.layerElArr[n].style.top=i.layerElArr[n].posY+"px"}(n);e!==t&&(this.klCanvas.moveLayer(this.selectedSpotIndex,t-e),this.klCanvasLayerArr=this.klCanvas.getLayers(),this.selectedSpotIndex=t,this.mergeBtn.disabled=0===this.selectedSpotIndex)}},{key:"posToSpot",value:function(e){var t=parseInt(""+(e/(this.layerHeight+this.layerSpacing)+.5));return t=Math.min(this.klCanvasLayerArr.length-1,Math.max(0,t)),t=this.klCanvasLayerArr.length-t-1}},{key:"updateLayersVerticalPosition",value:function(e,t){if((t=Math.min(this.klCanvasLayerArr.length-1,Math.max(0,t)))!==this.lastpos){for(var i=0;i<this.klCanvasLayerArr.length;i++)if(this.layerElArr[i].spot!==e){var n=this.layerElArr[i].spot;this.layerElArr[i].spot>e&&n--,n>=t&&n++,this.layerElArr[i].posY=(this.layerHeight+this.layerSpacing)*(this.klCanvasLayerArr.length-n-1),this.layerElArr[i].style.top=this.layerElArr[i].posY+"px"}this.lastpos=t}}},{key:"renameLayer",value:function(e){var i,n,r,a,s,o,l,h,c,u,p,d=this;i=this.parentEl,n=this.klCanvas.getLayer(e).name,r=function(t){void 0!==t&&t!==d.klCanvas.getLayer(e).name&&(d.klCanvas.renameLayer(e,t),d.createLayerList(),V.pause(!0),d.onSelect(e),V.pause(!1))},a=(0,W.BB).el(),s=(0,W.BB).el({content:J("layers-rename-name")+":",css:{marginRight:"5px"}}),o=(0,W.BB).el({css:{display:"flex"}}),(l=(0,W.BB).el({tagName:"input"})).value=n,l.setAttribute("data-ignore-focus","true"),h=(0,W.BB).el({tagName:"button",content:'<img src="'+t(tk)+'" height="20"/>',title:J("layers-rename-clear"),css:{marginLeft:"10px"},onClick:function(){l.value="",l.focus()}}),c=[J("layers-rename-sketch"),J("layers-rename-colors"),J("layers-rename-shading"),J("layers-rename-lines"),J("layers-rename-effects"),J("background"),J("layers-rename-foreground")],u=[],p=(0,W.BB).el({css:{display:"flex",flexWrap:"wrap",marginTop:"5px",marginLeft:"-5px"}}),c.forEach(function(e){var t=(0,W.BB).el({parent:p,tagName:"button",content:e,onClick:function(){l.value=""+t.textContent},css:{margin:"5px 0 0 5px"}});u.push(t)}),a.append(s),s.append(o,p),o.append(l,h),setTimeout(function(){l.focus(),l.select()},10),et({target:i,message:"<b>".concat(J("layers-rename-title"),"</b>"),div:a,buttons:[J("layers-rename"),"Cancel"],primaries:[J("layers-rename")],callback:function(e){(0,W.BB).destroyEl(h),u.forEach(function(e){(0,W.BB).destroyEl(e)}),u.splice(0,u.length),e===J("layers-rename")?r(l.value):r(void 0)},clickOnEnter:J("layers-rename")})}},{key:"updateHeight",value:function(){this.layerListEl.style.height=35*this.layerElArr.length+"px"}},{key:"createLayerList",value:function(){var e=this;this.oldHistoryState=V.getState(),this.klCanvasLayerArr=this.klCanvas.getLayers();var t=(0,W.BB).createCheckerDataUrl(4,void 0,(0,eI.theme).isDark());for(this.layerElArr=[];this.layerListEl.firstChild;){var i=this.layerListEl.firstChild;i.pointerListener.destroy(),i.opacitySlider.destroy(),i.remove()}for(var n=0;n<this.klCanvasLayerArr.length;n++)!function(i){var n,r=(0,_.throwIfNull)(e.klCanvas.getLayer(i)),a=r.name,s=e.klCanvasLayerArr[i].opacity,o=r.isVisible,l=e.klCanvasLayerArr[i].context.canvas,h=(0,W.BB).el({className:"kl-layer"});e.layerElArr[i]=h,h.posY=(e.klCanvasLayerArr.length-1)*35-35*i,(0,W.BB).css(h,{top:h.posY+"px"});var c=(0,W.BB).el();(0,W.BB).css(c,{position:"relative"});var u=(0,W.BB).el();(0,W.BB).css(u,{width:"270px",height:"34px"});var p=(0,W.BB).el();h.append(c),c.append(u,p),h.spot=i;var d=(0,W.BB).el({tagName:"label",parent:u,title:J("layers-visibility-toggle"),css:{display:"flex",width:"25px",height:"100%",justifyContent:"right",alignItems:"center",cursor:"pointer"}}),g=(0,W.BB).el({tagName:"input",parent:d,custom:{type:"checkbox",tabindex:"-1"},css:{display:"block",cursor:"pointer",margin:"0",marginRight:"5px"}});g.checked=o,g.onchange=function(){e.klCanvas.setLayerIsVisible(h.spot,g.checked),e.createLayerList(),h.spot===e.selectedSpotIndex&&(V.pause(!0),e.onSelect(e.selectedSpotIndex),V.pause(!1))};var f=function(e){e.preventDefault(),e.stopPropagation()};tC.hasPointerEvents?d.onpointerdown=f:d.onmousedown=f;var v=(0,W.BB).fitInto(l.width,l.height,30,30,1);h.thumb=(0,W.BB).canvas(v.width,v.height);var m=(0,W.BB).ctx(h.thumb);m.save(),h.thumb.width>l.width&&(m.imageSmoothingEnabled=!1),m.drawImage(l,0,0,h.thumb.width,h.thumb.height),m.restore(),(0,W.BB).css(h.thumb,{position:"absolute",left:(32-h.thumb.width)/2+25+"px",top:(32-h.thumb.height)/2+1+"px"}),h.thumb.style.backgroundImage="url("+t+")",h.label=(0,W.BB).el({className:"kl-layer__label"}),h.layerName=a,h.label.append(h.layerName),(0,W.BB).css(h.label,{position:"absolute",left:"63px",top:"1px",fontSize:"13px",width:"170px",height:"20px",overflow:"hidden",whiteSpace:"nowrap"}),h.label.ondblclick=function(){e.renameLayer(h.spot)},h.opacityLabel=(0,W.BB).el({className:"kl-layer__opacity-label"}),h.opacity=s,h.opacityLabel.append(parseInt(""+100*h.opacity)+"%"),(0,W.BB).css(h.opacityLabel,{position:"absolute",left:"214px",top:"1px",fontSize:"13px",textAlign:"right",width:"50px",transition:"color 0.2s ease-in-out",textDecoration:o?void 0:"line-through"});var y=new eL({init:h.opacity,width:200,pointSize:14,callback:function(t,i,r){if(i){n=e.klCanvas.getLayer(h.spot).opacity,V.pause(!0);return}if(r){V.pause(!1),n!==t&&e.klCanvas.layerOpacity(h.spot,t);return}h.opacityLabel.innerHTML=Math.round(100*t)+"%",e.klCanvas.layerOpacity(h.spot,t)}});(0,W.BB).css(y.getEl(),{position:"absolute",left:"64px",top:"17px"}),h.opacitySlider=y,h.thumb.onpointerover=function(t){if(0===t.buttons||t.pointerType&&"touch"===t.pointerType){var i=(0,W.BB).fitInto(l.width,l.height,250,250,1);(e.largeThumbCanvas.width!==i.width||e.largeThumbCanvas.height!==i.height)&&(e.largeThumbCanvas.width=i.width,e.largeThumbCanvas.height=i.height);var n=(0,W.BB).ctx(e.largeThumbCanvas);n.save(),e.largeThumbCanvas.width>l.width&&(n.imageSmoothingEnabled=!1),n.imageSmoothingQuality="high",n.clearRect(0,0,e.largeThumbCanvas.width,e.largeThumbCanvas.height),n.drawImage(l,0,0,e.largeThumbCanvas.width,e.largeThumbCanvas.height),n.restore(),(0,W.BB).css(e.largeThumbDiv,{top:t.clientY-e.largeThumbCanvas.height/2+"px",opacity:"0"}),e.largeThumbInDocument||(document.body.append(e.largeThumbDiv),e.largeThumbInDocument=!0),clearTimeout(e.largeThumbInTimeout),e.largeThumbInTimeout=setTimeout(function(){(0,W.BB).css(e.largeThumbDiv,{opacity:"1"})},20),clearTimeout(e.largeThumbTimeout)}},h.thumb.onpointerout=function(){clearTimeout(e.largeThumbInTimeout),(0,W.BB).css(e.largeThumbDiv,{opacity:"0"}),clearTimeout(e.largeThumbTimeout),e.largeThumbTimeout=setTimeout(function(){e.largeThumbInDocument&&(e.largeThumbDiv.remove(),e.largeThumbInDocument=!1)},300)},u.append(h.thumb,h.label,h.opacityLabel,y.getEl());var x=!1,b=!1;h.pointerListener=new W.BB.PointerListener({target:u,onPointer:function(t){if("pointerdown"===t.type&&"left"===t.button)(0,W.BB).css(h,{transition:"box-shadow 0.3s ease-in-out"}),h.style.zIndex="1",e.lastpos=h.spot,b=!1,h.isSelected||(b=!0,e.activateLayer(h.spot)),x=!0;else if("pointermove"===t.type&&"left"===t.button){x&&(x=!1,(0,W.BB).css(h,{boxShadow:"1px 3px 5px rgba(0,0,0,0.4)"})),h.posY+=t.dY;var i=Math.max(0,Math.min((e.klCanvasLayerArr.length-1)*35,h.posY));h.style.top=i+"px",e.updateLayersVerticalPosition(h.spot,e.posToSpot(h.posY))}if("pointerup"===t.type){(0,W.BB).css(h,{transition:"all 0.1s linear"}),setTimeout(function(){(0,W.BB).css(h,{boxShadow:""})},20),h.posY=Math.max(0,Math.min((e.klCanvasLayerArr.length-1)*35,h.posY)),h.style.zIndex="";var n=e.posToSpot(h.posY),r=h.spot;e.move(h.spot,n),r!=n&&(V.pause(!0),e.onSelect(e.selectedSpotIndex),V.pause(!1)),r===n&&b&&e.onSelect(e.selectedSpotIndex),b=!1}}}),e.layerListEl.append(h)}(n);this.activateLayer(this.selectedSpotIndex),this.updateHeight()}},{key:"updateButtons",value:function(){var e=16===this.klCanvasLayerArr.length,t=1===this.klCanvasLayerArr.length;this.addBtn.disabled=e,this.removeBtn.disabled=t,this.duplicateBtn.disabled=e,this.mergeBtn.disabled=0===this.selectedSpotIndex,this.moreDropdown.setEnabled("merge-all",!t)}},{key:"update",value:function(e){var t=this;this.klCanvasLayerArr=this.klCanvas.getLayers(),(e||0===e)&&(this.selectedSpotIndex=e),this.updateButtons(),setTimeout(function(){return t.createLayerList()},1)}},{key:"getSelected",value:function(){return this.selectedSpotIndex}},{key:"activateLayer",value:function(e){if(e<0||e>this.layerElArr.length-1)throw"invalid spotIndex "+e+", layerElArr.length "+this.layerElArr.length;this.selectedSpotIndex=e,this.modeSelect.setValue(this.klCanvasLayerArr[this.selectedSpotIndex].mixModeStr);for(var t=0;t<this.layerElArr.length;t++){var i=this.layerElArr[t],n=this.selectedSpotIndex===i.spot;(0,W.BB).css(i,{boxShadow:""}),i.classList.toggle("kl-layer--selected",n),i.opacitySlider.setActive(n),i.isSelected=n}this.mergeBtn.disabled=0===this.selectedSpotIndex}},{key:"setUiState",value:function(e){this.uiState=e,"left"===this.uiState?(0,W.BB).css(this.largeThumbDiv,{left:"280px",right:""}):(0,W.BB).css(this.largeThumbDiv,{left:"",right:"280px"})}},{key:"getElement",value:function(){return this.rootEl}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),tR=function(){function e(t){(0,O._)(this,e),this.rootElement=(0,W.BB).createSvg({elementType:"svg",width:""+t.width,height:""+t.height}),(0,W.BB).css(this.rootElement,{position:"absolute",left:"0",top:"0",pointerEvents:"none",userSelect:"none"}),this.brushCircleOuter=(0,W.BB).createSvg({elementType:"circle",r:"10",stroke:"rgba(0,0,0,0.7)","stroke-width":"1",fill:"none"}),this.brushCircleInner=(0,W.BB).createSvg({elementType:"circle",r:"9",stroke:"rgba(255,255,255,0.7)","stroke-width":"1",fill:"none"}),this.rootElement.append(this.brushCircleOuter,this.brushCircleInner),this.pickerPreviewBorder=(0,W.BB).createSvg({elementType:"circle",r:"47",stroke:"black","stroke-width":"22",fill:"none"}),this.pickerPreviewBorder.style.opacity="0",this.pickerPreviewCol=(0,W.BB).createSvg({elementType:"circle",r:"47",stroke:"black","stroke-width":"20",fill:"none"}),this.pickerPreviewCol.style.opacity="0",this.rootElement.append(this.pickerPreviewBorder,this.pickerPreviewCol),this.compassSize=30,this.compass=(0,W.BB).createSvg({elementType:"g",transform:"translate("+t.width/2+", "+t.height/2+")"}),(0,W.BB).css(this.compass,{transition:"opacity 0.25s ease-in-out",opacity:"0"}),this.compassInner=(0,W.BB).createSvg({elementType:"g",transform:"rotate(45)"}),this.compassBaseCircle=(0,W.BB).createSvg({elementType:"circle",fill:"rgba(0,0,0,0.9)",stroke:"none",cx:"0",cy:"0",r:""+this.compassSize}),this.compassLineCircle=(0,W.BB).createSvg({elementType:"circle",fill:"none",stroke:"rgba(255,255,255,0.75)","stroke-width":"1",cx:"0",cy:"0",r:""+.9*this.compassSize}),this.compassUpperTriangle=(0,W.BB).createSvg({elementType:"path",fill:"#f00",stroke:"none",d:"M -"+.25*this.compassSize+",0 "+.25*this.compassSize+",0 0,-"+.9*this.compassSize+" z"}),this.compassLowerTriangle=(0,W.BB).createSvg({elementType:"path",fill:"#fff",stroke:"none",d:"M -"+.25*this.compassSize+",0 "+.25*this.compassSize+",0 0,"+.9*this.compassSize+" z"}),this.compassInner.append(this.compassBaseCircle,this.compassLineCircle,this.compassUpperTriangle,this.compassLowerTriangle),this.compass.append(this.compassInner),this.rootElement.append(this.compass)}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootElement}},{key:"setSize",value:function(e,t){this.rootElement.setAttribute("width",""+e),this.rootElement.setAttribute("height",""+t),this.compass.setAttribute("transform","translate("+e/2+", "+t/2+")")}},{key:"updateCursor",value:function(e){void 0!==e.x&&(this.brushCircleOuter.setAttribute("cx",""+e.x),this.brushCircleInner.setAttribute("cx",""+e.x)),void 0!==e.y&&(this.brushCircleOuter.setAttribute("cy",""+e.y),this.brushCircleInner.setAttribute("cy",""+e.y)),void 0!==e.radius&&(this.brushCircleOuter.setAttribute("r",""+Math.max(0,e.radius)),this.brushCircleInner.setAttribute("r",""+Math.max(0,e.radius-1))),void 0!==e.isVisible&&(this.brushCircleOuter.style.opacity=e.isVisible?"1":"0",this.brushCircleInner.style.opacity=e.isVisible?"1":"0")}},{key:"updateColorPreview",value:function(e){if(void 0!==e.x&&(this.pickerPreviewCol.setAttribute("cx",""+e.x),this.pickerPreviewBorder.setAttribute("cx",""+e.x)),void 0!==e.y&&(this.pickerPreviewCol.setAttribute("cy",""+e.y),this.pickerPreviewBorder.setAttribute("cy",""+e.y)),e.color){this.pickerPreviewCol.setAttribute("stroke",(0,W.BB).ColorConverter.toRgbStr(e.color));var t=(0,W.BB).testIsWhiteBestContrast(e.color)?"rgba(255,255,255,0.5)":"rgba(0,0,0,0.5)";this.pickerPreviewBorder.setAttribute("stroke",t)}void 0!==e.isVisible&&(this.pickerPreviewCol.style.opacity=e.isVisible?"1":"0",this.pickerPreviewBorder.style.opacity=e.isVisible?"1":"0")}},{key:"updateCompass",value:function(e){void 0!==e.angleDeg&&(this.compassInner.setAttribute("transform","rotate("+e.angleDeg+")"),this.compassLineCircle.style.opacity=e.angleDeg%90==0?"1":"0"),void 0!==e.isVisible&&(this.compass.style.opacity=e.isVisible?"1":"0")}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),tP={};tP=I("f6OTe").getBundleURL("lYbF2")+"cursor-picker.dc155349.png";var tO={};tO=I("f6OTe").getBundleURL("lYbF2")+"cursor-zoom-ew.9ecaf1c2.png";var tD={};tD=I("f6OTe").getBundleURL("lYbF2")+"cursor-fill.999c4916.png";var tz={};tz=I("f6OTe").getBundleURL("lYbF2")+"cursor-text.582bc0db.png";var O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),t_=function(){function e(t){(0,O._)(this,e),this.downEvent=null,this.eventQueue=[],this.direction=null,this.onDraw=t.onDraw}return(0,D._)(e,[{key:"process",value:function(e){if("down"===e.type&&(this.downEvent=e,this.direction=null,e.shiftIsPressed)){this.onDraw({type:"line",x0:null,y0:null,pressure0:null,x1:e.x,y1:e.y,pressure1:e.pressure}),this.eventQueue.push(e);return}if("move"===e.type&&this.downEvent){if(e.shiftIsPressed){if(null===this.direction){var t=Math.abs(e.x-this.downEvent.x),i=Math.abs(e.y-this.downEvent.y);if(t>5||i>5){this.direction=t>i?0:1;for(var n=0;n<this.eventQueue.length;n++){var r=this.eventQueue[n];"up"!==r.type&&(0===this.direction?r.y=this.downEvent.y:r.x=this.downEvent.x),this.onDraw((0,W.BB).copyObj(r))}this.eventQueue=[]}}if(null===this.direction){this.eventQueue.push(e);return}0===this.direction?e.y=this.downEvent.y:e.x=this.downEvent.x}else if(this.eventQueue.length>0){for(var a=0;a<this.eventQueue.length;a++)this.onDraw((0,W.BB).copyObj(this.eventQueue[a]));this.eventQueue=[]}}"up"===e.type&&(this.eventQueue=[],this.downEvent=null),this.onDraw((0,W.BB).copyObj(e))}}]),e}(),eI=I("1C8RU"),tj={filenameBase:"Klecks"},tF=1/16;(s=m||(m={}))[s.Draw=0]="Draw",s[s.Hand=1]="Hand",s[s.HandGrabbing=2]="HandGrabbing",s[s.Pick=3]="Pick",s[s.Zoom=4]="Zoom",s[s.Rotate=5]="Rotate",s[s.Rotating=6]="Rotating",s[s.Fill=7]="Fill",s[s.Gradient=8]="Gradient",s[s.Text=9]="Text",s[s.Shape=10]="Shape";var tV=function(){function e(t){var i=this;(0,O._)(this,e),this.rootEl=(0,W.BB).el({css:{position:"absolute",left:"0",right:"0",top:"0",bottom:"0",cursor:"crosshair",userSelect:"none"}}),this.klCanvas=t.klCanvas,this.onViewChange=t.onViewChange,this.renderTargetCanvas=(0,W.BB).canvas(t.width,t.height),this.renderTargetCtx=(0,W.BB).ctx(this.renderTargetCanvas),this.renderWidth=t.width,this.renderHeight=t.height,this.compositeCanvas=(0,W.BB).canvas(1,1),this.compositeCtx=(0,W.BB).ctx(this.compositeCanvas),this.doResizeCanvas=!1,this.oldTransformObj=null,this.targetTransformObj={x:0,y:0,scale:1,angle:0},this.highResTransformObj={x:0,y:0,scale:1,angle:0},this.renderedTransformObj={},this.cursorPos={x:0,y:0},this.usesCssCursor=!1,this.bgVisible=!0,this.transformIsDirty=!0,this.doAnimateTranslate=!0,this.svgOverlay=new tR({width:t.width,height:t.height}),(0,W.BB).css(this.renderTargetCanvas,{userSelect:"none",pointerEvents:"none"}),(0,W.BB).createCheckerDataUrl(8,function(e){i.renderTargetCanvas.style.background="url("+e+")"},(0,eI.theme).isDark()),(0,eI.theme).addIsDarkListener(function(){i.renderTargetCanvas.style.background="url("+(0,W.BB).createCheckerDataUrl(8,void 0,(0,eI.theme).isDark())+")",i.lastRenderedState=-1,i.reqFrame()}),this.rootEl.append(this.renderTargetCanvas,this.svgOverlay.getElement()),this.rootEl.addEventListener("touchend",function(e){return e.preventDefault(),!1}),this.rootEl.addEventListener("contextmenu",function(e){return e.preventDefault(),!1}),this.rootEl.addEventListener("dragstart",function(e){return e.preventDefault(),!1}),this.emptyCanvas=(0,W.BB).canvas(1,1),this.emptyLightCanvas=(0,W.BB).canvas(1,1);var n=(0,W.BB).ctx(this.emptyCanvas);n.fillRect(0,0,1,1),(n=(0,W.BB).ctx(this.emptyLightCanvas)).fillStyle="#fff",n.fillRect(0,0,1,1),this.keyListener=new W.BB.KeyListener({onDown:function(e,t,n,r){if(!(rW.dialogCounter.get()>0||(0,W.BB).isInputFocused(!0))&&("alt"===e&&t.preventDefault(),!r)){if(i.currentInputProcessor)i.currentInputProcessor.onKeyDown(e,t,n,r);else{if([0,3,7,8,9,10].includes(i.globalMode)&&"space"===n){i.currentInputProcessor=i.inputProcessorObj.spaceHand,i.currentInputProcessor.onKeyDown(e,t,n,r);return}if([0,1,7,8,9,10].includes(i.globalMode)&&"alt"===n){i.currentInputProcessor=i.inputProcessorObj.altPicker,i.currentInputProcessor.onKeyDown(e,t,n,r);return}if(["r","shift+r"].includes(n)){i.currentInputProcessor=i.inputProcessorObj.rotate,i.currentInputProcessor.onKeyDown(e,t,n,r);return}if("z"===n){i.currentInputProcessor=i.inputProcessorObj.zoom,i.currentInputProcessor.onKeyDown(e,t,n,r);return}}}},onUp:function(e,t,n){"alt"===e&&t.preventDefault(),i.currentInputProcessor&&i.currentInputProcessor.onKeyUp(e,t,n)}}),this.updateChangeListener(),this.currentMode=0,this.globalMode=0,this.renderTime=0,this.lastDrawEvent=null,this.linetoolProcessor=new t_({onDraw:function(e){var n=function(){var e=i.getRenderedTransform(),t=(0,W.BB).Matrix.getIdentity();return t=(0,W.BB).Matrix.multiplyMatrices(t,(0,W.BB).Matrix.createScaleMatrix(1/e.scale)),t=(0,W.BB).Matrix.multiplyMatrices(t,(0,W.BB).Matrix.createRotationMatrix(-e.angle)),t=(0,W.BB).Matrix.multiplyMatrices(t,(0,W.BB).Matrix.createTranslationMatrix(-e.x,-e.y))};if("line"===e.type&&!i.lastDrawEvent){var r=n(),a=[e.x1,e.y1,0,1];a=(0,W.BB).Matrix.multiplyMatrixAndPoint(r,a),i.lastDrawEvent={x:a[0],y:a[1],pressure:e.pressure1};return}if("x"in e||"x0"in e){var s=n();if("x"in e){var o=[e.x,e.y,0,1];o=(0,W.BB).Matrix.multiplyMatrixAndPoint(s,o),e.x=o[0],e.y=o[1]}if("x0"in e){e.x0=i.lastDrawEvent.x,e.y0=i.lastDrawEvent.y,e.pressure0=i.lastDrawEvent.pressure;var l=[e.x1,e.y1,0,1];l=(0,W.BB).Matrix.multiplyMatrixAndPoint(s,l),e.x1=l[0],e.y1=l[1],i.lastDrawEvent={x:e.x1,y:e.y1,pressure:e.pressure1}}}("down"===e.type||"move"===e.type)&&(i.lastDrawEvent={x:e.x,y:e.y,pressure:e.pressure}),t.onDraw(e)}}),this.pointer=null,this.isDrawing=!1,this.inputProcessorObj={draw:{onPointer:function(e){i.reqFrame(),i.updateCursor(0);var t=i.keyListener.getComboStr(),n={scale:i.highResTransformObj.scale};if(n.shiftIsPressed="shift"===t,n.pressure=e.pressure,n.isCoalesced=!!e.isCoalesced,"pointerdown"===e.type)i.isDrawing=!0,n.type="down";else if(e.button)n.type="move";else{if("pointerup"!==e.type)return;i.isDrawing=!1,n.type="up",i.linetoolProcessor.process(n),i.resetInputProcessor();return}n.x=e.relX,n.y=e.relY,i.linetoolProcessor.process(n)},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},fill:{onPointer:function(e){if(i.reqFrame(),i.updateCursor(7),"pointerdown"===e.type){var n=i.workspaceToCanvasCoord({x:e.relX,y:e.relY});t.onFill(Math.floor(n.x),Math.floor(n.y))}else if("pointerup"===e.type){i.resetInputProcessor();return}},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},gradient:{onPointer:function(e){i.reqFrame(),i.updateCursor(8);var n=i.workspaceToCanvasCoord({x:e.relX,y:e.relY});"pointerdown"===e.type?(i.isDrawing=!0,t.onGradient("down",n.x,n.y,i.renderedTransformObj.angle)):"pointermove"===e.type?t.onGradient("move",n.x,n.y,i.renderedTransformObj.angle):"pointerup"===e.type&&(i.isDrawing=!1,t.onGradient("up",n.x,n.y,i.renderedTransformObj.angle),i.resetInputProcessor())},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},text:{onPointer:function(e){if(i.reqFrame(),i.updateCursor(9),"pointerdown"===e.type){var n=i.workspaceToCanvasCoord({x:e.relX,y:e.relY});t.onText(Math.floor(n.x),Math.floor(n.y),i.renderedTransformObj.angle)}else if("pointerup"===e.type){i.resetInputProcessor();return}},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},shape:{onPointer:function(e){i.reqFrame(),i.updateCursor(10);var n=i.workspaceToCanvasCoord({x:e.relX,y:e.relY});"pointerdown"===e.type?(i.isDrawing=!0,t.onShape("down",n.x,n.y,i.renderedTransformObj.angle)):"pointermove"===e.type?t.onShape("move",n.x,n.y,i.renderedTransformObj.angle):"pointerup"===e.type&&(i.isDrawing=!1,t.onShape("up",n.x,n.y,i.renderedTransformObj.angle),i.resetInputProcessor())},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},hand:{onPointer:function(e){i.updateCursor(1),["left","middle"].includes(e.button||"")?(i.updateCursor(2),i.targetTransformObj.x+=e.dX,i.targetTransformObj.y+=e.dY,i.highResTransformObj=(0,W.BB).copyObj(i.targetTransformObj),i.doAnimateTranslate=!1,i.transformIsDirty=!0,i.reqFrame(!0)):"pointerup"===e.type&&i.resetInputProcessor()},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},spaceHand:{onPointer:function(e){i.updateCursor(1),["left","middle"].includes(e.button||"")&&(i.updateCursor(2),i.targetTransformObj.x+=e.dX,i.targetTransformObj.y+=e.dY,i.highResTransformObj=(0,W.BB).copyObj(i.targetTransformObj),i.doAnimateTranslate=!1,i.transformIsDirty=!0,i.reqFrame(!0))},onKeyDown:function(e,t,n,r){"space"!==n?i.resetInputProcessor():i.updateCursor(1)},onKeyUp:function(e,t,n){i.resetInputProcessor()}},zoom:{onPointer:function(e){if(i.updateCursor(4),"left"===e.button&&!e.isCoalesced&&0!=e.dX){var t=e.pageX-e.relX,n=e.pageY-e.relY;i.internalZoomByStep(e.dX/175,e.downPageX-t,e.downPageY-n),i.highResTransformObj=(0,W.BB).copyObj(i.targetTransformObj),i.lastRenderedState=-1,i.reqFrame(),i.onViewChange({changed:["scale"],angle:i.targetTransformObj.angle,scale:i.targetTransformObj.scale})}},onKeyDown:function(e,t,n,r){"z"!==n?i.resetInputProcessor():i.updateCursor(4)},onKeyUp:function(e,t,n){i.resetInputProcessor()}},picker:{onPointer:function(e){if(i.updateCursor(3),["left","right"].includes(e.button||"")&&!e.isCoalesced||"pointerup"===e.type){var n=i.workspaceToCanvasCoord({x:e.relX,y:e.relY}),r=i.klCanvas.getColorAt(n.x,n.y);t.onPick(r,"pointerup"===e.type),i.svgOverlay.updateColorPreview({x:e.relX,y:e.relY,color:r,isVisible:"pointerup"!==e.type}),"pointerup"===e.type&&i.resetInputProcessor()}},onKeyDown:function(e,t,i,n){},onKeyUp:function(e,t,i){}},altPicker:{onPointer:function(e){if(i.updateCursor(3),["left","right"].includes(e.button||"")&&!e.isCoalesced||"pointerup"===e.type){var n=i.workspaceToCanvasCoord({x:e.relX,y:e.relY}),r=i.klCanvas.getColorAt(n.x,n.y);t.onPick(r,"pointerup"===e.type),i.svgOverlay.updateColorPreview({x:e.relX,y:e.relY,color:r,isVisible:"pointerup"!==e.type})}},onKeyDown:function(e,t,n,r){"alt"!==n?i.resetInputProcessor():i.updateCursor(3)},onKeyUp:function(e,t,n){i.resetInputProcessor()}},rotate:{onPointer:function(e){if(i.updateCursor("left"===e.button?6:5),"pointerdown"===e.type&&"left"===e.button)i.oldTransformObj=(0,W.BB).copyObj(i.targetTransformObj);else if("left"===e.button&&!e.isCoalesced&&i.oldTransformObj){var t=e.pageX-e.relX,n=e.pageY-e.relY,r={x:i.renderWidth/2,y:i.renderHeight/2},a=(0,W.BB).Vec2.angle(r,{x:e.downPageX-t,y:e.downPageY-n}),s=(0,W.BB).Vec2.angle(r,{x:e.pageX-t,y:e.pageY-n})-a;i.targetTransformObj=(0,W.BB).copyObj(i.oldTransformObj),i.targetTransformObj.angle+=s,i.keyListener.isPressed("shift")&&(i.targetTransformObj.angle=Math.round(i.targetTransformObj.angle/Math.PI*8)*Math.PI/8,s=i.targetTransformObj.angle-i.oldTransformObj.angle),i.targetTransformObj.angle=i.minimizeAngleRad(i.targetTransformObj.angle);var o=(0,W.BB).Matrix.getIdentity();o=(0,W.BB).Matrix.multiplyMatrices(o,(0,W.BB).Matrix.createTranslationMatrix(r.x,r.y)),o=(0,W.BB).Matrix.multiplyMatrices(o,(0,W.BB).Matrix.createRotationMatrix(s)),o=(0,W.BB).Matrix.multiplyMatrices(o,(0,W.BB).Matrix.createTranslationMatrix(-r.x,-r.y));var l=[i.targetTransformObj.x,i.targetTransformObj.y,0,1];l=(0,W.BB).Matrix.multiplyMatrixAndPoint(o,l),i.targetTransformObj.x=l[0],i.targetTransformObj.y=l[1],i.highResTransformObj=(0,W.BB).copyObj(i.targetTransformObj),i.transformIsDirty=!0,i.lastRenderedState=-1,i.reqFrame(),i.onViewChange({changed:["angle"],scale:i.targetTransformObj.scale,angle:i.targetTransformObj.angle})}},onKeyDown:function(e,t,n,r){["r","r+shift","shift+r","r+left","r+right","r+left+right","r+right+left","r+up"].includes(n)?i.updateCursor(5):i.resetInputProcessor()},onKeyUp:function(e,t,n){["r","r+shift","shift+r","r+left","r+right","r+left+right","r+right+left","r+up"].includes(i.keyListener.getComboStr())?i.updateCursor(5):i.resetInputProcessor()}}},this.currentInputProcessor=null,this.angleIsExtraSticky=!1,this.pinchZoomer=new W.BB.PinchZoomer({onPinch:function(e){if("move"===e.type){i.oldTransformObj||(i.oldTransformObj=(0,W.BB).copyObj(i.targetTransformObj),i.angleIsExtraSticky=i.targetTransformObj.angle%(Math.PI/2)==0),i.targetTransformObj=(0,W.BB).copyObj(i.oldTransformObj),e.scale=Math.max(tF,Math.min(128,i.targetTransformObj.scale*e.scale))/i.targetTransformObj.scale,i.targetTransformObj.scale*=e.scale,i.targetTransformObj.angle+=e.angleRad,i.targetTransformObj.angle=i.minimizeAngleRad(i.snapAngleRad(i.targetTransformObj.angle,90,i.angleIsExtraSticky?12:4)),i.targetTransformObj.angle%(Math.PI/2)!=0&&(i.angleIsExtraSticky=!1),e.angleRad=i.targetTransformObj.angle-i.oldTransformObj.angle;var t=(0,W.BB).Matrix.getIdentity();t=(0,W.BB).Matrix.multiplyMatrices(t,(0,W.BB).Matrix.createTranslationMatrix(e.relX,e.relY)),t=(0,W.BB).Matrix.multiplyMatrices(t,(0,W.BB).Matrix.createScaleMatrix(e.scale)),t=(0,W.BB).Matrix.multiplyMatrices(t,(0,W.BB).Matrix.createRotationMatrix(e.angleRad)),t=(0,W.BB).Matrix.multiplyMatrices(t,(0,W.BB).Matrix.createTranslationMatrix(-e.relX,-e.relY)),t=(0,W.BB).Matrix.multiplyMatrices(t,(0,W.BB).Matrix.createTranslationMatrix(e.relX-e.downRelX,e.relY-e.downRelY));var n=[i.targetTransformObj.x,i.targetTransformObj.y,0,1];n=(0,W.BB).Matrix.multiplyMatrixAndPoint(t,n),i.targetTransformObj.x=n[0],i.targetTransformObj.y=n[1],i.highResTransformObj=(0,W.BB).copyObj(i.targetTransformObj),i.onViewChange({changed:["scale","angle"],scale:i.targetTransformObj.scale,angle:i.targetTransformObj.angle}),i.reqFrame(),i.transformIsDirty=!0,i.lastRenderedState=-1}else"end"===e.type&&(i.oldTransformObj=null)}});var r=function(e){i.fitView(!0)?(i.lastRenderedState=-1,i.reqFrame()):(i.internalZoomByStep(2,e.relX,e.relY)&&i.onViewChange({changed:["scale"],angle:i.targetTransformObj.angle,scale:i.targetTransformObj.scale}),i.lastRenderedState=-1)};this.mainDoubleTapper=new W.BB.DoubleTapper({onDoubleTap:r}),this.middleDoubleTapper=new W.BB.DoubleTapper({onDoubleTap:r}),this.middleDoubleTapper.setAllowedButtonArr(["middle"]),this.twoFingerTap=new W.BB.NFingerTapper({fingers:2,onTap:function(){t.onUndo()}}),this.threeFingerTap=new W.BB.NFingerTapper({fingers:3,onTap:function(){t.onRedo()}}),this.pointerEventChain=new W.BB.EventChain({chainArr:[this.twoFingerTap,this.threeFingerTap,this.mainDoubleTapper,this.middleDoubleTapper,this.pinchZoomer,new W.BB.OnePointerLimiter,new W.BB.CoalescedExploder]}),this.pointerEventChain.setChainOut(function(e){if(i.cursorPos.x=e.relX,i.cursorPos.y=e.relY,"pointerup"===e.type&&"touch"===e.pointerType?(i.pointer=null,i.lastRenderedState=-1,i.reqFrame()):(i.pointer||(i.pointer={x:0,y:0}),i.pointer.x=e.relX,i.pointer.y=e.relY),i.currentInputProcessor)i.currentInputProcessor.onPointer(e);else{var t=i.keyListener.getComboStr();0===i.globalMode?["","shift","ctrl"].includes(t)&&"pointerdown"===e.type&&"left"===e.button?(i.currentInputProcessor=i.inputProcessorObj.draw,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):(i.updateCursor(0),i.reqFrame()):1===i.globalMode?"pointerdown"===e.type&&["left","middle"].includes(e.button||"")?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):i.updateCursor(1):3===i.globalMode?"pointerdown"===e.type&&["left","right"].includes(e.button||"")?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):i.updateCursor(3):7===i.globalMode?"pointerdown"===e.type&&"left"===e.button?(i.currentInputProcessor=i.inputProcessorObj.fill,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):(i.updateCursor(7),i.reqFrame()):8===i.globalMode?["","shift","ctrl"].includes(t)&&"pointerdown"===e.type&&"left"===e.button?(i.currentInputProcessor=i.inputProcessorObj.gradient,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):(i.updateCursor(8),i.reqFrame()):9===i.globalMode?"pointerdown"===e.type&&"left"===e.button?(i.currentInputProcessor=i.inputProcessorObj.text,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):(i.updateCursor(9),i.reqFrame()):10===i.globalMode&&(["","shift","ctrl"].includes(t)&&"pointerdown"===e.type&&"left"===e.button?(i.currentInputProcessor=i.inputProcessorObj.shape,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"right"===e.button?(i.currentInputProcessor=i.inputProcessorObj.picker,i.currentInputProcessor.onPointer(e)):[""].includes(t)&&"pointerdown"===e.type&&"middle"===e.button?(i.currentInputProcessor=i.inputProcessorObj.hand,i.currentInputProcessor.onPointer(e)):(i.updateCursor(10),i.reqFrame()))}}),this.rootEl.addEventListener("wheel",function(e){e.preventDefault()}),setTimeout(function(){i.pointerListener=new W.BB.PointerListener({target:i.rootEl,fixScribble:!0,onPointer:function(e){if("pointerdown"===e.type&&"middle"===e.button)try{e.eventPreventDefault()}catch(e){}"pointerdown"===e.type&&(0,W.BB).unfocusAnyInput(),i.pointerEventChain.chainIn(e)},onWheel:function(e){i.isDrawing||(i.reqFrame(),i.internalZoomByStep(-e.deltaY/(i.keyListener.isPressed("shift")?8:2),e.relX,e.relY)&&i.onViewChange({changed:["scale"],angle:i.targetTransformObj.angle,scale:i.targetTransformObj.scale}),i.lastRenderedState=-1)},onEnterLeave:function(e){e||i.isDrawing||(i.pointer=null,i.lastRenderedState=-1)},maxPointers:4})},1),this.brushRadius=1,this.animationFrameRequested=!1,this.lastRenderedState=-2,this.lastRenderTime=performance.now(),window.requestAnimationFrame(function(){return i.updateLoop()}),this.resetOrFitView()}return(0,D._)(e,[{key:"getRenderedTransform",value:function(){var e=this.renderedTransformObj;return e.x=this.highResTransformObj.x,e.y=this.highResTransformObj.y,e.scale=this.highResTransformObj.scale,e.angle=this.highResTransformObj.angle,e.angle%(Math.PI/2)==0&&e.scale%1==0&&(e.x=Math.round(e.x),e.y=Math.round(e.y)),e}},{key:"updateChangeListener",value:function(){var e=this;this.klCanvas.addChangeListener(function(){e.lastRenderedState=-1,e.reqFrame()})}},{key:"updateCursor",value:function(e,i){if(e!==this.currentMode||i){var n=this.currentMode;if(this.currentMode=e,this.lastRenderedState=-1,0===this.currentMode?this.rootEl.style.cursor="crosshair":1===this.currentMode?this.rootEl.style.cursor="grab":2===this.currentMode?this.rootEl.style.cursor="grabbing":3===this.currentMode?this.rootEl.style.cursor="url('"+t(tP)+"') 0 15, crosshair":4===this.currentMode?this.rootEl.style.cursor="url('"+t(tO)+"') 7 7, zoom-in":5===this.currentMode?this.rootEl.style.cursor="grab":6===this.currentMode?this.rootEl.style.cursor="grabbing":7===this.currentMode?this.rootEl.style.cursor="url('"+t(tD)+"') 1 12, crosshair":8===this.currentMode?this.rootEl.style.cursor="crosshair":9===this.currentMode?this.rootEl.style.cursor="url('"+t(tz)+"') 1 12, crosshair":10===this.currentMode&&(this.rootEl.style.cursor="crosshair"),[0,3,7,9,10].includes(this.globalMode)){var r=[1,2].includes(n),a=[1,2].includes(this.currentMode);!r&&a&&this.mainDoubleTapper.setAllowedPointerTypeArr(["mouse","pen","touch"]),r&&!a&&this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])}3!==this.currentMode&&this.svgOverlay.updateColorPreview({isVisible:!1})}}},{key:"internalZoomByStep",value:function(e,t,i){var n=Math.log2(this.targetTransformObj.scale)/Math.abs(e);n+=e>0?1:-1;var r=Math.max(tF,Math.min(128,Math.pow(2,n=Math.round(n)*Math.abs(e))));if(r===this.targetTransformObj.scale)return!1;var a=r/this.targetTransformObj.scale;this.targetTransformObj.scale=r;var s=(0,W.BB).Matrix.getIdentity();s=(0,W.BB).Matrix.multiplyMatrices(s,(0,W.BB).Matrix.createTranslationMatrix(t,i)),s=(0,W.BB).Matrix.multiplyMatrices(s,(0,W.BB).Matrix.createScaleMatrix(a)),s=(0,W.BB).Matrix.multiplyMatrices(s,(0,W.BB).Matrix.createTranslationMatrix(-t,-i));var o=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];return o=(0,W.BB).Matrix.multiplyMatrixAndPoint(s,o),this.targetTransformObj.x=o[0],this.targetTransformObj.y=o[1],this.transformIsDirty=!0,!0}},{key:"mixTransformObj",value:function(e,t,i){if(e.angle===t.angle){e.scale=(0,W.BB).mix(e.scale,t.scale,i),e.x=(0,W.BB).mix(e.x,t.x,i),e.y=(0,W.BB).mix(e.y,t.y,i),e.angle=(0,W.BB).mix(e.angle,t.angle,i);return}var n=this.klCanvas.getWidth(),r=this.klCanvas.getHeight(),a=this.canvasToWorkspaceCoord({x:n/2,y:r/2},e),s=this.canvasToWorkspaceCoord({x:n/2,y:r/2},t);e.x=(0,W.BB).mix(a.x,s.x,i),e.y=(0,W.BB).mix(a.y,s.y,i),e.scale=(0,W.BB).mix(e.scale,t.scale,i),e.angle=(0,W.BB).mix(e.angle,t.angle,i);var o=this.canvasToWorkspaceCoord({x:-n/2,y:-r/2},e);e.x=o.x,e.y=o.y}},{key:"render",value:function(){this.doResizeCanvas&&(this.doResizeCanvas=!1,this.renderTargetCanvas.width=this.renderWidth,this.renderTargetCanvas.height=this.renderHeight),this.renderContext(this.renderTargetCtx)}},{key:"testBgVisible",value:function(){var e=[[0,0],[this.renderWidth,0],[this.renderWidth,this.renderHeight],[0,this.renderHeight]],t=this.getRenderedTransform(),i=(0,W.BB).Matrix.getIdentity();i=(0,W.BB).Matrix.multiplyMatrices(i,(0,W.BB).Matrix.createScaleMatrix(1/t.scale)),i=(0,W.BB).Matrix.multiplyMatrices(i,(0,W.BB).Matrix.createRotationMatrix(-t.angle)),i=(0,W.BB).Matrix.multiplyMatrices(i,(0,W.BB).Matrix.createTranslationMatrix(-t.x,-t.y));for(var n=0;n<e.length;n++){var r=[e[n][0],e[n][1],0,1];if(!(0<=(r=(0,W.BB).Matrix.multiplyMatrixAndPoint(i,r))[0]&&r[0]<=this.klCanvas.getWidth()&&0<=r[1]&&r[1]<=this.klCanvas.getHeight()))return!0}return!1}},{key:"renderContext",value:function(e){var t=this.klCanvas.getWidth(),i=this.klCanvas.getHeight(),n=this.getRenderedTransform(),r=(0,eI.theme).isDark();n.scale>=4||1===n.scale&&0===n.angle?e.imageSmoothingEnabled=!1:(e.imageSmoothingEnabled=!0,e.imageSmoothingQuality="low"),e.save(),this.bgVisible?(e.fillStyle=r?"rgb(33, 33, 33)":"rgb(158,158,158)",e.fillRect(0,0,this.renderWidth,this.renderHeight)):e.clearRect(0,0,this.renderWidth,this.renderHeight),this.bgVisible&&(e.save(),e.translate(n.x,n.y),e.scale(n.scale,n.scale),e.rotate(n.angle),e.imageSmoothingEnabled=!1,e.globalAlpha=r?.25:.2,e.drawImage(r?this.emptyLightCanvas:this.emptyCanvas,-1/n.scale,-1/n.scale,t+2/n.scale,i+2/n.scale),e.globalAlpha=1,e.globalCompositeOperation="destination-out",e.drawImage(this.emptyCanvas,0,0,t,i),e.restore()),e.translate(n.x,n.y),e.scale(n.scale,n.scale),e.rotate(n.angle);for(var a=this.klCanvas.getLayersFast(),s=0;s<a.length;s++)if(a[s].isVisible&&0!==a[s].opacity){e.globalAlpha=a[s].opacity,e.globalCompositeOperation=a[s].mixModeStr;var o=a[s].canvas.compositeObj;o?(this.compositeCanvas.width!==a[s].canvas.width||this.compositeCanvas.height!==a[s].canvas.height?(this.compositeCanvas.width=a[s].canvas.width,this.compositeCanvas.height=a[s].canvas.height):this.compositeCtx.clearRect(0,0,this.compositeCanvas.width,this.compositeCanvas.height),this.compositeCtx.drawImage(a[s].canvas,0,0),o.draw(this.compositeCtx),e.drawImage(this.compositeCanvas,0,0,t,i)):e.drawImage(a[s].canvas,0,0,t,i)}e.globalAlpha=1,e.restore(),5===this.currentMode||6===this.currentMode?this.svgOverlay.updateCompass({isVisible:!0,angleDeg:n.angle/Math.PI*180}):this.svgOverlay.updateCompass({isVisible:!1})}},{key:"workspaceToCanvasCoord",value:function(e){var t=this.getRenderedTransform(),i=(0,W.BB).Matrix.getIdentity();i=(0,W.BB).Matrix.multiplyMatrices(i,(0,W.BB).Matrix.createScaleMatrix(1/t.scale)),i=(0,W.BB).Matrix.multiplyMatrices(i,(0,W.BB).Matrix.createRotationMatrix(-t.angle)),i=(0,W.BB).Matrix.multiplyMatrices(i,(0,W.BB).Matrix.createTranslationMatrix(-t.x,-t.y));var n=[e.x,e.y,0,1];return{x:(n=(0,W.BB).Matrix.multiplyMatrixAndPoint(i,n))[0],y:n[1]}}},{key:"canvasToWorkspaceCoord",value:function(e,t){var i=(0,W.BB).Matrix.getIdentity();i=(0,W.BB).Matrix.multiplyMatrices(i,(0,W.BB).Matrix.createTranslationMatrix(t.x,t.y)),i=(0,W.BB).Matrix.multiplyMatrices(i,(0,W.BB).Matrix.createRotationMatrix(t.angle)),i=(0,W.BB).Matrix.multiplyMatrices(i,(0,W.BB).Matrix.createScaleMatrix(t.scale));var n=[e.x,e.y,0,1];return{x:(n=(0,W.BB).Matrix.multiplyMatrixAndPoint(i,n))[0],y:n[1]}}},{key:"snapAngleRad",value:function(e,t,i){var n=180*e/Math.PI,r=Math.abs(n%t);return Math.min(r,t-r)<=i&&(n=Math.round(n/t)*t),n/180*Math.PI}},{key:"minimizeAngleRad",value:function(e){return(e%=2*Math.PI)>Math.PI?e-=2*Math.PI:e<-Math.PI&&(e+=2*Math.PI),e}},{key:"resetInputProcessor",value:function(){this.currentInputProcessor=null,this.updateCursor(this.globalMode),this.reqFrame(!0)}},{key:"reqFrame",value:function(e){this.animationFrameRequested=!0,e&&(this.lastRenderedState=-1)}},{key:"updateLoop",value:function(){var e=this;window.requestAnimationFrame(function(){return e.updateLoop()});var t=V.getState(),i=this.lastRenderedState<t,n=performance.now(),r=(n-this.lastRenderTime)*60/1e3;this.lastRenderTime=n,(this.animationFrameRequested||i)&&(this.animationFrameRequested=!1,this.checkChange(r))}},{key:"checkChange",value:function(e){var t=V.getState(),i=this.lastRenderedState<t||this.highResTransformObj.scale!==this.targetTransformObj.scale||this.highResTransformObj.x!==this.targetTransformObj.x||this.highResTransformObj.y!==this.targetTransformObj.y;if(!this.doAnimateTranslate&&(this.highResTransformObj.scale===this.targetTransformObj.scale||Math.abs(this.highResTransformObj.scale-this.targetTransformObj.scale)<.008*this.targetTransformObj.scale))this.highResTransformObj.scale=this.targetTransformObj.scale,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.highResTransformObj.angle=this.targetTransformObj.angle,this.transformIsDirty&&(this.transformIsDirty=!1,this.bgVisible=this.testBgVisible()),this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale});else if((this.highResTransformObj.x===this.targetTransformObj.x||.5>Math.abs(this.highResTransformObj.x-this.targetTransformObj.x))&&(this.highResTransformObj.y===this.targetTransformObj.y||.5>Math.abs(this.highResTransformObj.y-this.targetTransformObj.y))&&(this.highResTransformObj.scale===this.targetTransformObj.scale||Math.abs(this.highResTransformObj.scale-this.targetTransformObj.scale)<.008*this.targetTransformObj.scale))this.highResTransformObj.scale=this.targetTransformObj.scale,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.highResTransformObj.angle=this.targetTransformObj.angle,this.doAnimateTranslate=!1,this.transformIsDirty&&(this.transformIsDirty=!1,this.bgVisible=this.testBgVisible()),this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale});else{this.reqFrame();var n=Math.min(1,.3*e);this.mixTransformObj(this.highResTransformObj,this.targetTransformObj,n),this.bgVisible=!0,this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale})}if(this.pointer&&0==this.currentMode&&!this.usesCssCursor?this.svgOverlay.updateCursor({x:this.pointer.x,y:this.pointer.y,isVisible:!0}):this.svgOverlay.updateCursor({isVisible:!1}),i){this.lastRenderedState=t;var r=performance.now();this.render(),this.renderTime=(0,W.BB).mix(this.renderTime,performance.now()-r,.05)}}},{key:"getElement",value:function(){return this.rootEl}},{key:"setCanvas",value:function(e){this.klCanvas=e,this.lastDrawEvent=null,this.resetView(),this.updateChangeListener(),this.lastRenderedState=-1,this.reqFrame()}},{key:"setSize",value:function(e,t){var i=this.renderWidth,n=this.renderHeight;(e!==i||t!==n)&&(this.doResizeCanvas=!0,this.renderWidth=e,this.renderHeight=t,this.svgOverlay.setSize(e,t),this.targetTransformObj.x+=(e-i)/2,this.targetTransformObj.y+=(t-n)/2,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.bgVisible=this.testBgVisible(),this.lastRenderedState=-1,this.reqFrame())}},{key:"setMode",value:function(e){"draw"===e&&(this.globalMode=0,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"fill"===e&&(this.globalMode=7,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"gradient"===e&&(this.globalMode=8,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"text"===e&&(this.globalMode=9,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"shape"===e&&(this.globalMode=10,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"hand"===e&&(this.globalMode=1,this.mainDoubleTapper.setAllowedPointerTypeArr(["mouse","pen","touch"])),"pick"===e&&(this.globalMode=3,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"]))}},{key:"getMode",value:function(){if(0===this.globalMode)return"draw";if(7===this.globalMode)return"fill";if(8===this.globalMode)return"gradient";if(9===this.globalMode)return"text";if(10===this.globalMode)return"shape";if(1===this.globalMode)return"hand";if(3===this.globalMode)return"pick";throw Error("unknown globalMode")}},{key:"setCursorSize",value:function(e){var t=this;this.brushRadius=e/2,this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale}),null===this.pointer&&(this.hideBrushCursorTimeout&&clearTimeout(this.hideBrushCursorTimeout),this.svgOverlay.updateCursor({x:this.renderWidth/2,y:this.renderHeight/2,isVisible:!0}),this.hideBrushCursorTimeout=setTimeout(function(){null===t.pointer&&t.svgOverlay.updateCursor({isVisible:!1})},500))}},{key:"zoomByStep",value:function(e){this.internalZoomByStep(e,this.renderWidth/2,this.renderHeight/2)&&(this.lastRenderedState=-1,this.reqFrame(),this.onViewChange({changed:["scale"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale}))}},{key:"resetView",value:function(e){this.targetTransformObj.scale=1,this.targetTransformObj.angle=0,this.targetTransformObj.x=(this.renderWidth-this.klCanvas.getWidth())/2,this.targetTransformObj.y=(this.renderHeight-this.klCanvas.getHeight())/2,e?(this.doAnimateTranslate=!0,this.transformIsDirty=!0):this.highResTransformObj=(0,W.BB).copyObj(this.targetTransformObj),this.bgVisible=this.testBgVisible(),this.reqFrame(),e&&this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle})}},{key:"fitView",value:function(e){var t=this.snapAngleRad(this.targetTransformObj.angle,90,90),i=[[0,0],[this.klCanvas.getWidth(),0],[this.klCanvas.getWidth(),this.klCanvas.getHeight()],[0,this.klCanvas.getHeight()],[this.klCanvas.getWidth()/2,this.klCanvas.getHeight()/2]],n=(0,W.BB).Matrix.getIdentity();n=(0,W.BB).Matrix.multiplyMatrices(n,(0,W.BB).Matrix.createRotationMatrix(t));for(var r=0;r<i.length;r++){var a=[i[r][0],i[r][1],0,1];a=(0,W.BB).Matrix.multiplyMatrixAndPoint(n,a),i[r][0]=a[0],i[r][1]=a[1]}for(var s={},o=0;o<i.length;o++)(void 0===s.x1||i[o][0]<s.x1)&&(s.x1=i[o][0]),(void 0===s.y1||i[o][1]<s.y1)&&(s.y1=i[o][1]),(void 0===s.x2||i[o][0]>s.x2)&&(s.x2=i[o][0]),(void 0===s.y2||i[o][1]>s.y2)&&(s.y2=i[o][1]);var l=s.x2-s.x1,h=s.y2-s.y1,c=Math.min(128,(0,W.BB).fitInto(l,h,this.renderWidth-0,this.renderHeight-0,1).width/l),u={angle:t,x:this.renderWidth/2-(i[4][0]-i[0][0])*c,y:this.renderHeight/2-(i[4][1]-i[0][1])*c,scale:c};return(!(u.angle===this.targetTransformObj.angle&&1e-10>Math.abs(u.x-this.targetTransformObj.x)&&1e-10>Math.abs(u.y-this.targetTransformObj.y))||u.scale!==this.targetTransformObj.scale)&&(this.targetTransformObj=u,e?this.doAnimateTranslate=!0:this.highResTransformObj=(0,W.BB).copyObj(this.targetTransformObj),this.transformIsDirty=!0,this.reqFrame(),e&&this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle}),!0)}},{key:"resetOrFitView",value:function(){!tj.disableAutoFit&&this.klCanvas.getWidth()<=this.renderWidth/4&&this.klCanvas.getHeight()<=this.renderHeight/4?this.fitView():this.resetView()}},{key:"setAngle",value:function(e,t){var i={x:this.renderWidth/2,y:this.renderHeight/2},n=this.targetTransformObj.angle,r=e/180*Math.PI;t?this.targetTransformObj.angle+=r:this.targetTransformObj.angle=r,this.targetTransformObj.angle=this.minimizeAngleRad(this.snapAngleRad(this.targetTransformObj.angle,90,4));var a=(0,W.BB).Matrix.getIdentity();a=(0,W.BB).Matrix.multiplyMatrices(a,(0,W.BB).Matrix.createTranslationMatrix(i.x,i.y)),a=(0,W.BB).Matrix.multiplyMatrices(a,(0,W.BB).Matrix.createRotationMatrix(this.targetTransformObj.angle-n)),a=(0,W.BB).Matrix.multiplyMatrices(a,(0,W.BB).Matrix.createTranslationMatrix(-i.x,-i.y));var s=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];s=(0,W.BB).Matrix.multiplyMatrixAndPoint(a,s),this.targetTransformObj.x=s[0],this.targetTransformObj.y=s[1],this.highResTransformObj=(0,W.BB).copyObj(this.targetTransformObj),this.transformIsDirty=!0,this.reqFrame(!0)}},{key:"translateView",value:function(e,t){this.targetTransformObj.x+=40*e,this.targetTransformObj.y+=40*t,this.transformIsDirty=!0,this.doAnimateTranslate=!0,this.reqFrame(!0)}},{key:"getIsDrawing",value:function(){return this.isDrawing}},{key:"getScale",value:function(){return this.targetTransformObj.scale}},{key:"getAngleDeg",value:function(){return 180*this.targetTransformObj.angle/Math.PI}},{key:"getMaxScale",value:function(){return 128}},{key:"getMinScale",value:function(){return tF}},{key:"requestFrame",value:function(){this.lastRenderedState=-1,this.reqFrame()}},{key:"setLastDrawEvent",value:function(e,t,i){if(void 0===e){this.lastDrawEvent=null;return}this.lastDrawEvent||(this.lastDrawEvent={x:0,y:0,pressure:0}),this.lastDrawEvent.x=e,this.lastDrawEvent.y=t,this.lastDrawEvent.pressure=i}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),eI=I("1C8RU"),tH=function(){function e(t){var i=this;(0,O._)(this,e),this.layers=t.layers;var n=t.width/t.layers[0].image.width,r=n>1?t.layers[0].image.width:t.width,a=n>1?t.layers[0].image.height:t.height;this.canvas=(0,W.BB).canvas(r,a),this.updateCheckerboard=function(){i.canvas.style.backgroundImage="url("+(0,W.BB).createCheckerDataUrl(8,void 0,(0,eI.theme).isDark())+")"},this.updateCheckerboard(),this.ctx=(0,W.BB).ctx(this.canvas),(0,W.BB).css(this.canvas,{width:"100%",height:"100%",imageRendering:n>1?"pixelated":void 0}),setTimeout(function(){return i.render()},0),(0,eI.theme).addIsDarkListener(this.updateCheckerboard)}return(0,D._)(e,[{key:"getElement",value:function(){return this.canvas}},{key:"render",value:function(){if(this.ctx){this.ctx.save(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var e=0;e<this.layers.length;e++){var t=this.layers[e];t.isVisible&&0!==t.opacity&&(this.ctx.globalAlpha=this.layers[e].opacity,this.ctx.globalCompositeOperation=this.layers[e].mixModeStr,this.canvas.width>this.layers[e].image.width&&(this.ctx.imageSmoothingEnabled=!1),this.ctx.drawImage(this.layers[e].image,0,0,this.canvas.width,this.canvas.height))}this.ctx.restore()}}},{key:"destroy",value:function(){(0,eI.theme).removeIsDarkListener(this.updateCheckerboard)}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),W=I("eWjiX"),tW={};tW=I("f6OTe").getBundleURL("lYbF2")+"cursor-rotate.4dea8425.png";var W=I("eWjiX");function tX(e){if(Math.abs(e.angleDeg)%90==0){e.width=Math.round(e.width),e.height=Math.round(e.height);var t=Math.abs(e.angleDeg-90)%180==0;e.x=(t?e.height:e.width)%2==0?Math.round(e.x):Math.round(e.x-.5)+.5,e.y=(t?e.width:e.height)%2==0?Math.round(e.y):Math.round(e.y-.5)+.5}}function tN(e){return{x:e.x,y:e.y,width:e.width,height:e.height,angleDeg:e.angleDeg}}function tY(e,t,i){var n=(0,W.BB).rotateAround({x:0,y:0},{x:e,y:t},i.angleDeg);return{x:n.x+i.x,y:n.y+i.y}}var tU=function(){function e(i){var n,r=this;(0,O._)(this,e);var a=function(){s.x=0,s.y=0};this.scaled={x:0,y:0,width:0,height:0,corners:[{x:0,y:0}]},this.minSnapDist=7,this.cornerCursors=["nw","n","ne","e","se","s","sw","w"],this.gripSize=16,this.edgeSize=10,this.corners=[],this.edges=[],this.viewportTransform=(0,X._)({},i.viewportTransform),this.value={x:i.x,y:i.y,width:i.width,height:i.height,angleDeg:i.angleDeg},this.isConstrained=i.isConstrained,this.snapX=i.snapX,this.snapY=i.snapY,this.callback=i.callback,this.snappingEnabled=!0,this.ratio=this.value.width/this.value.height,this.rootEl=(0,W.BB).el({className:"kl-free-transform",css:{userSelect:"none"}}),this.transEl=(0,W.BB).el({parent:this.rootEl,css:{position:"absolute"}}),this.boundsEl=(0,W.BB).el({css:{position:"absolute",cursor:"move",boxShadow:"rgba(255, 255, 255, 0.5) 0 0 0 1px inset, rgba(0, 0, 0, 0.5) 0 0 0 1px"}});var s={x:0,y:0};this.keyListener=new W.BB.KeyListener({});var o={x:0,y:0};this.boundsPointerListener=new W.BB.PointerListener({target:this.boundsEl,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointerdown"===e.type&&(o={x:r.value.x,y:r.value.y}),"pointermove"===e.type&&"left"===e.button){r.value.x=o.x+(e.pageX-e.downPageX)/r.viewportTransform.scale,r.value.y=o.y+(e.pageY-e.downPageY)/r.viewportTransform.scale;var t={distX:-1,distY:-1};if(r.snappingEnabled){for(n=0;n<r.snapX.length;n++)(i=Math.abs(r.value.x-r.snapX[n]))<r.minSnapDist/r.viewportTransform.scale&&(void 0===t.x||i<t.distX)&&(t.x=r.snapX[n],t.distX=i);for(n=0;n<r.snapY.length;n++)(i=Math.abs(r.value.y-r.snapY[n]))<r.minSnapDist/r.viewportTransform.scale&&(void 0===t.y||i<t.distY)&&(t.y=r.snapY[n],t.distY=i);for(n=0;n<4;n++){a=tY(r.corners[n].x,r.corners[n].y,r.value);var i,n,a,s=void 0;for(s=0;s<r.snapX.length;s++)(i=Math.abs(a.x-r.snapX[s]))<r.minSnapDist/r.viewportTransform.scale&&(void 0===t.x||i<t.distX)&&(t.x=r.snapX[s]-(a.x-r.value.x),t.distX=i);for(s=0;s<r.snapY.length;s++)(i=Math.abs(a.y-r.snapY[s]))<r.minSnapDist/r.viewportTransform.scale&&(void 0===t.y||i<t.distY)&&(t.y=r.snapY[s]-(a.y-r.value.y),t.distY=i)}}if("shift"===r.keyListener.getComboStr()){var l=(0,W.BB).projectPointOnLine({x:0,y:o.y},{x:10,y:o.y},{x:r.value.x,y:r.value.y}),h=(0,W.BB).dist(l.x,l.y,r.value.x,r.value.y);t={x:l.x,y:l.y,distX:h,distY:h},l=(0,W.BB).projectPointOnLine({x:o.x,y:0},{x:o.x,y:10},{x:r.value.x,y:r.value.y}),(h=(0,W.BB).dist(l.x,l.y,r.value.x,r.value.y))<t.distX&&(t={x:l.x,y:l.y,distX:h,distY:h}),l=(0,W.BB).projectPointOnLine({x:o.x,y:o.y},{x:o.x+1,y:o.y+1},{x:r.value.x,y:r.value.y}),(h=(0,W.BB).dist(l.x,l.y,r.value.x,r.value.y))<t.distX&&(t={x:l.x,y:l.y,distX:h,distY:h}),l=(0,W.BB).projectPointOnLine({x:o.x,y:o.y},{x:o.x+1,y:o.y-1},{x:r.value.x,y:r.value.y}),(h=(0,W.BB).dist(l.x,l.y,r.value.x,r.value.y))<t.distX&&(t={x:l.x,y:l.y,distX:h,distY:h})}void 0!=t.x&&(r.value.x=t.x),void 0!=t.y&&(r.value.y=t.y),Math.abs(r.value.angleDeg)%90==0&&(tX(r.value),r.updateCornerPositions()),r.updateDOM()}}});for(var l=0;l<4;l++)!function(e){var t=r.corners[e]={i:e,el:(0,W.BB).el({css:{width:r.gripSize+"px",height:r.gripSize+"px",background:"#fff",borderRadius:r.gripSize+"px",position:"absolute",border:"2px solid #000"}}),x:0,y:0,virtualPos:{x:0,y:0}};t.updateDOM=function(){var i=[[-1,-1],[1,-1],[1,1],[-1,1]].map(function(e){return e[0]*=r.value.width>0?1:-1,e[1]*=r.value.height>0?1:-1,e}),n=20>Math.abs(r.scaled.width)||20>Math.abs(r.scaled.height)?10:0;(0,W.BB).css(t.el,{left:r.scaled.corners[t.i].x-r.gripSize/2+i[e][0]*n+"px",top:r.scaled.corners[t.i].y-r.gripSize/2+i[e][1]*n+"px"});for(var a=(0,W.BB).pointsToAngleDeg({x:r.value.x,y:r.value.y},tY(t.x,t.y,r.value))+135;a<0;)a+=360;var s=Math.round(a/45)%r.cornerCursors.length;(0,W.BB).css(t.el,{cursor:r.cornerCursors[s]+"-resize"})},t.pointerListener=new W.BB.PointerListener({target:r.corners[e].el,fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointerdown"===t.type&&"left"===t.button)r.corners[e].virtualPos=tY(r.corners[e].x,r.corners[e].y,r.value);else if("pointermove"===t.type&&"left"===t.button){r.corners[e].virtualPos.x+=t.dX/r.viewportTransform.scale,r.corners[e].virtualPos.y+=t.dY/r.viewportTransform.scale;var i={x:r.corners[e].virtualPos.x,y:r.corners[e].virtualPos.y};i=r.constrainCorner(e,i.x,i.y),r.isConstrained||(i=r.snapCorner(i.x,i.y)),Math.abs(r.value.angleDeg)%90==0&&(i.x=Math.round(i.x),i.y=Math.round(i.y));var n=function(e,t,i){n=e-i.x,r=t-i.y;var n,r,a=(0,W.BB).rotateAround({x:0,y:0},{x:n,y:r},-i.angleDeg);return{x:n=a.x,y:r=a.y}}(i.x,i.y,r.value),a=n.x-r.corners[e].x,s=n.y-r.corners[e].y;r.corners[e].x=n.x,r.corners[e].y=n.y;var o=[];0===e?o=[3,1,2]:1===e?o=[2,0,3]:2===e?o=[1,3,0]:3===e&&(o=[0,2,1]),r.corners[o[0]].x=r.corners[e].x,r.corners[o[1]].y=r.corners[e].y,r.keyListener.isPressed("shift")&&(r.corners[o[2]].x-=a,r.corners[o[2]].y-=s,r.corners[o[1]].x=r.corners[o[2]].x,r.corners[o[0]].y=r.corners[o[2]].y),r.updateTransformViaCorners()}}})}(l);this.updateCornerPositions(),this.updateScaled();for(var h=0;h<4;h++)!function(e){r.edges[e]={el:(0,W.BB).el({css:{width:r.edgeSize+"px",height:r.edgeSize+"px",position:"absolute"}})};var t=r.edges[e];t.updateDOM=function(){0===e?(0,W.BB).css(t.el,{left:Math.min(r.scaled.corners[0].x,r.scaled.corners[1].x)+"px",top:Math.min(r.scaled.corners[0].y,r.scaled.corners[3].y)-r.edgeSize+"px",width:Math.abs(r.scaled.width)+"px",height:r.edgeSize+"px"}):1===e?(0,W.BB).css(t.el,{left:Math.max(r.scaled.corners[0].x,r.scaled.corners[1].x)+"px",top:Math.min(r.scaled.corners[1].y,r.scaled.corners[2].y)+"px",width:r.edgeSize+"px",height:Math.abs(r.scaled.height)+"px"}):2===e?(0,W.BB).css(t.el,{left:Math.min(r.scaled.corners[3].x,r.scaled.corners[2].x)+"px",top:Math.max(r.scaled.corners[0].y,r.scaled.corners[3].y)+"px",width:Math.abs(r.scaled.width)+"px",height:r.edgeSize+"px"}):3===e&&(0,W.BB).css(t.el,{left:Math.min(r.scaled.corners[0].x,r.scaled.corners[1].x)-r.edgeSize+"px",top:Math.min(r.scaled.corners[0].y,r.scaled.corners[3].y)+"px",width:r.edgeSize+"px",height:Math.abs(r.scaled.height)+"px"});for(var i=Math.round(r.value.angleDeg/45);i<0;)i+=8;i=(2*e+1+i)%r.cornerCursors.length,t.el.style.cursor=r.cornerCursors[i]+"-resize"};var i=[0,2].includes(e);t.pointerListener=new W.BB.PointerListener({target:r.edges[e].el,fixScribble:!0,onPointer:function(t){if(t.eventPreventDefault(),"pointerdown"===t.type&&"left"===t.button&&(n=i?r.corners[0].y>=r.corners[3].y:r.corners[0].x>=r.corners[1].x,a()),"pointermove"===t.type&&"left"===t.button){var o=(0,W.BB).rotateAround({x:0,y:0},{x:t.dX/r.viewportTransform.scale,y:t.dY/r.viewportTransform.scale},-r.value.angleDeg),l={dX:o.x,dY:o.y};Math.abs(r.value.angleDeg)%90==0&&(l=(0,W.BB).intDxy(s,o.x,o.y));var h=[];0===e?h=[2,3,0,1]:1===e?h=[0,3,1,2]:2===e?h=[0,1,2,3]:3===e&&(h=[1,2,0,3]);var c=i?"y":"x",u=i?l.dY:l.dX;n?(r.corners[h[0]][c]+=u,r.corners[h[1]][c]+=u):(r.corners[h[2]][c]+=u,r.corners[h[3]][c]+=u),r.keyListener.isPressed("shift")&&(n?(r.corners[h[2]][c]-=u,r.corners[h[3]][c]-=u):(r.corners[h[0]][c]-=u,r.corners[h[1]][c]-=u)),i?r.restoreRatio(!1,!0):r.restoreRatio(!0,!1),r.updateTransformViaCorners()}}})}(h);this.angleGrip={el:(0,W.BB).el({css:{cursor:"url("+t(tW)+") 10 10, move",width:this.gripSize+"px",height:this.gripSize+"px",background:"#0ff",borderRadius:this.gripSize+"px",position:"absolute",boxShadow:"inset 0 0 0 2px #000"}}),x:0,y:0,snap:!1,updateDOM:function(){(0,W.BB).css(r.angleGrip.el,{left:r.angleGrip.x-r.gripSize/2+"px",top:r.angleGrip.y-r.gripSize/2+"px"})}},(0,W.BB).el({parent:this.angleGrip.el,css:{width:"2px",height:"13px",left:this.gripSize/2-1+"px",top:this.gripSize+"px",background:"#0ff",position:"absolute"}}),this.anglePointerListener=new W.BB.PointerListener({target:this.angleGrip.el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=r.rootEl.getBoundingClientRect(),i={x:t.left-r.rootEl.scrollLeft+r.viewportTransform.x,y:t.top-r.rootEl.scrollTop+r.viewportTransform.y},n={x:(e.clientX-i.x)/r.viewportTransform.scale,y:(e.clientY-i.y)/r.viewportTransform.scale},a=(0,W.BB).pointsToAngleDeg({x:r.value.x,y:r.value.y},n)+90;r.value.angleDeg=a;var s=45*Math.round(a/360*8);"shift"===r.keyListener.getComboStr()?r.value.angleDeg=s:r.snappingEnabled&&8>Math.abs(s-a)&&(r.value.angleDeg=s),r.updateDOM()}"pointerup"===e.type&&Math.abs(r.value.angleDeg)%90==0&&(tX(r.value),r.updateCornerPositions(),r.updateDOM())}}),tX(this.value),this.updateDOM(!0),(0,W.BB).append(this.transEl,[this.boundsEl,this.edges[0].el,this.edges[1].el,this.edges[2].el,this.edges[3].el,this.corners[0].el,this.corners[1].el,this.corners[2].el,this.corners[3].el,this.angleGrip.el])}return(0,D._)(e,[{key:"updateScaled",value:function(){var e=this;this.scaled.x=this.value.x*this.viewportTransform.scale,this.scaled.y=this.value.y*this.viewportTransform.scale,this.scaled.width=this.value.width*this.viewportTransform.scale,this.scaled.height=this.value.height*this.viewportTransform.scale,this.scaled.corners=this.corners.map(function(t){return{x:t.x*e.viewportTransform.scale,y:t.y*e.viewportTransform.scale}})}},{key:"snapCorner",value:function(e,t){if(!this.snappingEnabled)return{x:e,y:t};for(var i,n,r,a={x:void 0,y:void 0,dist:{x:void 0,y:void 0}},s=0;s<this.snapX.length;s++)(i=Math.abs(e-this.snapX[s]))<this.minSnapDist/this.viewportTransform.scale&&(void 0===a.x||i<a.dist.x)&&(a.x=this.snapX[s],a.dist.x=i);for(var o=0;o<this.snapY.length;o++)(i=Math.abs(t-this.snapY[o]))<this.minSnapDist/this.viewportTransform.scale&&(void 0===a.y||i<a.dist.y)&&(a.y=this.snapY[o],a.dist.y=i);return void 0===a.x&&void 0===a.y?{x:e,y:t}:{x:null!==(n=a.x)&&void 0!==n?n:e,y:null!==(r=a.y)&&void 0!==r?r:t}}},{key:"constrainCorner",value:function(e,t,i){if(!this.isConstrained)return{x:t,y:i};var n=this.value.width*this.value.height<0?-1:1;return(0,W.BB).projectPointOnLine({x:this.value.x,y:this.value.y},tY(this.ratio,n*([0,2].includes(e)?1:-1),this.value),{x:t,y:i})}},{key:"updateCornerPositions",value:function(){this.corners[0].x=-this.value.width/2,this.corners[0].y=-this.value.height/2,this.corners[1].x=this.value.width/2,this.corners[1].y=-this.value.height/2,this.corners[2].x=this.value.width/2,this.corners[2].y=this.value.height/2,this.corners[3].x=-this.value.width/2,this.corners[3].y=this.value.height/2}},{key:"restoreRatio",value:function(e,t){if(this.isConstrained){var i=Math.abs(this.value.angleDeg)%90==0,n=Math.abs(this.value.angleDeg-90)%180==0;if(t&&!e){var r=Math.abs(this.corners[3].y-this.corners[0].y),a=this.ratio*r;i&&(a=(n?this.value.y%1:this.value.x%1)==0?(0,W.BB).roundEven(a):(0,W.BB).roundUneven(a)),this.corners[1].x-this.corners[0].x<0&&(a*=-1),this.corners[0].x=-a/2,this.corners[3].x=-a/2,this.corners[1].x=a/2,this.corners[2].x=a/2}if(!t&&e){var s=Math.abs(this.corners[0].x-this.corners[1].x)/this.ratio;i&&(s=(n?this.value.x%1:this.value.y%1)==0?(0,W.BB).roundEven(s):(0,W.BB).roundUneven(s)),this.corners[3].y-this.corners[0].y<0&&(s*=-1),this.corners[0].y=-s/2,this.corners[1].y=-s/2,this.corners[2].y=s/2,this.corners[3].y=s/2}}}},{key:"updateTransformViaCorners",value:function(){var e=(0,W.BB).rotateAround({x:0,y:0},{x:(this.corners[0].x+this.corners[1].x)/2,y:(this.corners[0].y+this.corners[3].y)/2},this.value.angleDeg);this.value.x=e.x+this.value.x,this.value.y=e.y+this.value.y,this.value.width=this.corners[1].x-this.corners[0].x,this.value.height=this.corners[3].y-this.corners[0].y,this.updateCornerPositions(),this.updateDOM()}},{key:"updateDOM",value:function(e){this.updateScaled(),(0,W.BB).css(this.transEl,{left:this.viewportTransform.x+this.scaled.x+"px",top:this.viewportTransform.y+this.scaled.y+"px",transformOrigin:"0 0",transform:"rotate("+this.value.angleDeg+"deg)"}),(0,W.BB).css(this.boundsEl,{width:Math.abs(this.scaled.width)+"px",height:Math.abs(this.scaled.height)+"px",left:Math.min(this.scaled.corners[0].x,this.scaled.corners[1].x)+"px",top:Math.min(this.scaled.corners[0].y,this.scaled.corners[3].y)+"px"}),this.corners[0].updateDOM(),this.corners[1].updateDOM(),this.corners[2].updateDOM(),this.corners[3].updateDOM(),this.edges[0].updateDOM(),this.edges[1].updateDOM(),this.edges[2].updateDOM(),this.edges[3].updateDOM(),this.angleGrip.x=0,this.angleGrip.y=-Math.abs(this.value.height*this.viewportTransform.scale)/2-20,this.angleGrip.updateDOM(),!e&&this.callback&&this.callback(tN(this.value))}},{key:"getValue",value:function(){return tN(this.value)}},{key:"setIsConstrained",value:function(e){this.isConstrained=e,e&&0!==this.value.width&&0!==this.value.height&&(this.ratio=Math.abs(this.value.width/this.value.height))}},{key:"setSnapping",value:function(e){this.snappingEnabled=e}},{key:"setPos",value:function(e){this.value.x=e.x,this.value.y=e.y,this.updateDOM(!0)}},{key:"move",value:function(e,t){this.value.x+=e,this.value.y+=t,this.updateDOM(!1)}},{key:"setSize",value:function(e,t){this.value.width=e,this.value.height=t,Math.abs(this.value.angleDeg)%90==0&&tX(this.value),this.updateCornerPositions(),this.updateDOM(!1)}},{key:"setAngleDeg",value:function(e){this.value.angleDeg=e,Math.abs(this.value.angleDeg)%90==0&&(tX(this.value),this.updateCornerPositions()),this.updateDOM(!0)}},{key:"setViewportTransform",value:function(e){this.viewportTransform=e,this.updateScaled(),this.updateDOM()}},{key:"getElement",value:function(){return this.rootEl}},{key:"getRatio",value:function(){return this.ratio}},{key:"destroy",value:function(){this.keyListener.destroy(),this.boundsPointerListener.destroy(),this.corners.forEach(function(e){return e.pointerListener.destroy()}),this.edges.forEach(function(e){return e.pointerListener.destroy()}),this.anglePointerListener.destroy()}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),tG={};tG=I("dQMMg");var tK=function(){function e(t){var i=this;(0,O._)(this,e),this.imageWidth=t.imageWidth,this.imageHeight=t.imageHeight,this.rootEl=(0,W.BB).el({className:"kl-preview-wrapper",css:{width:t.elementWidth+"px",height:t.elementHeight+"px"}}),this.rootEl.oncontextmenu=function(){return!1},this.layers=t.layers,this.transformIndex=t.transformIndex,this.previewLayerArr=this.layers.map(function(e){var t;return{image:e.image,isVisible:e.isVisible,mixModeStr:null!==(t=e.mixModeStr)&&void 0!==t?t:"source-over",opacity:e.opacity,hasClipping:!1}}),this.previewCanvas=(0,W.BB).canvas(this.imageWidth,this.imageHeight),this.previewLayerArr[this.previewLayerArr.length-1].image=this.previewCanvas,this.preview=new ta({width:t.elementWidth,height:t.elementHeight,project:{width:t.imageWidth,height:t.imageHeight,layers:this.previewLayerArr},hasEditMode:!0,onModeChange:function(e){i.freeTransform.getElement().style.pointerEvents="edit"===e?"":"none",i.freeTransform.getElement().style.opacity="edit"===e?"":"0.5"},onTransformChange:function(e){i.freeTransform.setViewportTransform(e)},padding:30}),this.preview.getElement().classList.add((0,tG.css)({overflow:"hidden",marginLeft:"-20px",marginRight:"-20px"})),this.rootEl.append(this.preview.getElement()),this.initTransform={x:this.imageWidth/2,y:this.imageHeight/2,width:this.layers[this.transformIndex].image.width,height:this.layers[this.transformIndex].image.height},this.freeTransform=new tU({x:this.initTransform.x,y:this.initTransform.y,width:this.initTransform.width,height:this.initTransform.height,angleDeg:0,isConstrained:!0,snapX:[0,this.imageWidth],snapY:[0,this.imageHeight],viewportTransform:this.preview.getTransform(),callback:function(){i.updatePreview()}}),this.preview.getElement().append(this.freeTransform.getElement()),(0,W.BB).css(this.freeTransform.getElement(),{position:"absolute",left:"0",top:"0"}),setTimeout(function(){return i.updatePreview()},0)}return(0,D._)(e,[{key:"updatePreview",value:function(){var e=this.freeTransform.getValue(),t=(0,W.BB).ctx(this.previewCanvas);t.save(),t.clearRect(0,0,this.previewCanvas.width,this.previewCanvas.height),(0,W.BB).drawTransformedImageWithBounds(t,this.layers[this.transformIndex].image,e,void 0,(0,W.BB).testShouldPixelate(e,e.width/this.initTransform.width,e.height/this.initTransform.height)),t.restore(),this.preview.render()}},{key:"move",value:function(e,t){this.freeTransform.move(e,t)}},{key:"reset",value:function(){var e=this.layers[this.transformIndex].image.width,t=this.layers[this.transformIndex].image.height;this.freeTransform.setSize(e,t),this.freeTransform.setPos({x:e/2,y:t/2}),this.freeTransform.setAngleDeg(0),this.updatePreview()}},{key:"setTransformFit",value:function(){var e=(0,W.BB).fitInto(this.layers[this.transformIndex].image.width,this.layers[this.transformIndex].image.height,this.imageWidth,this.imageHeight,1);this.freeTransform.setSize(e.width,e.height),this.freeTransform.setPos({x:e.width/2,y:e.height/2}),this.freeTransform.setAngleDeg(0),this.updatePreview()}},{key:"setTransformCenter",value:function(){this.freeTransform.setPos({x:this.imageWidth/2,y:this.imageHeight/2}),this.freeTransform.setAngleDeg(0),this.updatePreview()}},{key:"getTransformation",value:function(){return this.freeTransform.getValue()}},{key:"getIsPixelated",value:function(){var e=this.freeTransform.getValue();return(0,W.BB).testShouldPixelate(e,e.width/this.initTransform.width,e.height/this.initTransform.height)}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.freeTransform.destroy(),this.preview.destroy(),(0,W.BB).freeCanvas(this.previewCanvas)}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),tq=function(){function e(t){var i=this;(0,O._)(this,e),this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.scale=t.scale,this.callback=t.callback;var n=t.maxW,r=t.maxW;this.rootEl=(0,W.BB).el();var a=["nw","n","ne","e","se","s","sw","w"];this.keyListener=new W.BB.KeyListener({}),(0,W.BB).css(this.rootEl,{position:"absolute",left:this.x*this.scale+"px",top:this.y*this.scale+"px"}),this.outline={el:(0,W.BB).el({css:{position:"absolute",border:"1px dashed #fff",cursor:"move"}}),update:function(){(0,W.BB).css(i.outline.el,{left:i.grips[0].x*i.scale-1+"px",top:i.grips[0].y*i.scale-1+"px",width:(i.grips[2].x-i.grips[0].x)*i.scale+"px",height:(i.grips[2].y-i.grips[0].y)*i.scale+"px"})}},this.pointerRemainder={x:0,y:0},this.outlinePointerListener=new W.BB.PointerListener({target:this.outline.el,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=(0,W.BB).intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;i.grips[0].x+=n,i.grips[0].y+=r,i.grips[1].x+=n,i.grips[1].y+=r,i.grips[2].x+=n,i.grips[2].y+=r,i.grips[3].x+=n,i.grips[3].y+=r,i.update()}"pointerup"===e.type&&i.commit()}}),this.thirdsHorizontal={el:(0,W.BB).el({css:{position:"absolute",borderTop:"1px solid #0ff",borderBottom:"1px solid #0ff"}}),update:function(){(0,W.BB).css(i.thirdsHorizontal.el,{left:i.grips[0].x*i.scale+"px",top:(i.grips[0].y+(i.grips[2].y-i.grips[0].y)/3)*i.scale+"px",width:(i.grips[2].x-i.grips[0].x)*i.scale+"px",height:(i.grips[2].y-i.grips[0].y)/3*i.scale+"px"})}},this.thirdsVertical={el:(0,W.BB).el({css:{position:"absolute",borderLeft:"1px solid #0ff",borderRight:"1px solid #0ff"}}),update:function(){(0,W.BB).css(i.thirdsVertical.el,{left:(i.grips[0].x+(i.grips[2].x-i.grips[0].x)/3)*i.scale+"px",top:i.grips[0].y*i.scale+"px",width:(i.grips[2].x-i.grips[0].x)/3*i.scale+"px",height:(i.grips[2].y-i.grips[0].y)*i.scale+"px"})}},this.grips=[{x:0,y:0},{x:this.width,y:0},{x:this.width,y:this.height},{x:0,y:this.height}];var s=function(e){i.grips[0].y+=e,i.grips[0].y=(0,W.BB).clamp(i.grips[0].y,i.grips[3].y-r,i.grips[3].y-1),i.grips[1].y=i.grips[0].y},o=function(e){i.grips[1].x+=e,i.grips[1].x=(0,W.BB).clamp(i.grips[1].x,i.grips[0].x+1,i.grips[0].x+n),i.grips[2].x=i.grips[1].x},l=function(e){i.grips[2].y+=e,i.grips[2].y=(0,W.BB).clamp(i.grips[2].y,i.grips[1].y+1,i.grips[1].y+r),i.grips[3].y=i.grips[2].y},h=function(e){i.grips[0].x+=e,i.grips[0].x=(0,W.BB).clamp(i.grips[0].x,i.grips[1].x-n,i.grips[1].x-1),i.grips[3].x=i.grips[0].x};this.edges=[];for(var c=0;c<4;c++)!function(e){var t=(0,W.BB).el({css:{width:"40px",height:"40px",position:"absolute"}}),n=function(){0===e?(0,W.BB).css(t,{left:i.grips[0].x*i.scale+10+"px",top:i.grips[0].y*i.scale-80+10+"px",width:(i.grips[1].x-i.grips[0].x)*i.scale-20+"px",height:"80px"}):1===e?(0,W.BB).css(t,{left:i.grips[1].x*i.scale-10+"px",top:i.grips[1].y*i.scale+10+"px",width:"80px",height:(i.grips[2].y-i.grips[1].y)*i.scale-20+"px"}):2===e?(0,W.BB).css(t,{left:i.grips[3].x*i.scale+10+"px",top:i.grips[3].y*i.scale-10+"px",width:(i.grips[2].x-i.grips[3].x)*i.scale-20+"px",height:"80px"}):3===e&&(0,W.BB).css(t,{left:i.grips[0].x*i.scale-80+10+"px",top:i.grips[0].y*i.scale+10+"px",width:"80px",height:(i.grips[3].y-i.grips[0].y)*i.scale-20+"px"});var n=2*e+1;t.style.cursor=a[n]+"-resize"};i.edges[e]={el:t,update:n}}(c);this.darken=[];for(var u=0;u<4;u++)!function(e){var t=(0,W.BB).el({css:{position:"absolute",background:"#000",opacity:"0.5"}}),n=function(){0===e?(0,W.BB).css(t,{left:i.grips[0].x*i.scale+"px",top:i.grips[0].y*i.scale-8e3+"px",width:(i.grips[1].x-i.grips[0].x)*i.scale+"px",height:"8000px"}):1===e?(0,W.BB).css(t,{left:i.grips[1].x*i.scale+"px",top:i.grips[1].y*i.scale-8e3+"px",width:"8000px",height:"16000px"}):2===e?(0,W.BB).css(t,{left:i.grips[3].x*i.scale+"px",top:i.grips[3].y*i.scale+"px",width:(i.grips[2].x-i.grips[3].x)*i.scale+"px",height:"8000px"}):3===e&&(0,W.BB).css(t,{left:i.grips[0].x*i.scale-8e3+"px",top:i.grips[0].y*i.scale-8e3+"px",width:"8000px",height:"16000px"})};i.darken[e]={el:t,update:n}}(u);this.edge0PointerListener=new W.BB.PointerListener({target:this.edges[0].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=(0,W.BB).intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale).dY;s(t),i.keyListener.isPressed("shift")&&l(-t),i.update()}"pointerup"===e.type&&i.commit()}}),this.edge1PointerListener=new W.BB.PointerListener({target:this.edges[1].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=(0,W.BB).intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX;t.dY,o(n),i.keyListener.isPressed("shift")&&h(-n),i.update()}"pointerup"===e.type&&i.commit()}}),this.edge2PointerListener=new W.BB.PointerListener({target:this.edges[2].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=(0,W.BB).intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=(t.dX,t.dY);l(n),i.keyListener.isPressed("shift")&&s(-n),i.update()}"pointerup"===e.type&&i.commit()}}),this.edge3PointerListener=new W.BB.PointerListener({target:this.edges[3].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=(0,W.BB).intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX;t.dY,h(n),i.keyListener.isPressed("shift")&&o(-n),i.update()}"pointerup"===e.type&&i.commit()}}),this.cornerElArr=[],function(){for(var e=0;e<4;e++)!function(e){var t=(0,W.BB).el({css:{width:"80px",height:"80px",position:"absolute",cursor:["nwse-resize","nesw-resize"][e%2]}}),n=function(){0===e?(0,W.BB).css(t,{left:i.grips[0].x*i.scale-80+10+"px",top:i.grips[0].y*i.scale-80+10+"px"}):1===e?(0,W.BB).css(t,{left:i.grips[1].x*i.scale-10+"px",top:i.grips[1].y*i.scale-80+10+"px"}):2===e?(0,W.BB).css(t,{left:i.grips[1].x*i.scale-10+"px",top:i.grips[2].y*i.scale-10+"px"}):3===e&&(0,W.BB).css(t,{left:i.grips[0].x*i.scale-80+10+"px",top:i.grips[2].y*i.scale-10+"px"})};i.cornerElArr[e]={el:t,update:n}}(e)}(),this.corner0PointerListener=new W.BB.PointerListener({target:this.cornerElArr[0].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=(0,W.BB).intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;h(n),s(r),i.keyListener.isPressed("shift")&&(o(-n),l(-r)),i.update()}"pointerup"===e.type&&i.commit()}}),this.corner1PointerListener=new W.BB.PointerListener({target:this.cornerElArr[1].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=(0,W.BB).intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;o(n),s(r),i.keyListener.isPressed("shift")&&(h(-n),l(-r)),i.update()}"pointerup"===e.type&&i.commit()}}),this.corner2PointerListener=new W.BB.PointerListener({target:this.cornerElArr[2].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=(0,W.BB).intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;o(n),l(r),i.keyListener.isPressed("shift")&&(h(-n),s(-r)),i.update()}"pointerup"===e.type&&i.commit()}}),this.corner3PointerListener=new W.BB.PointerListener({target:this.cornerElArr[3].el,fixScribble:!0,onPointer:function(e){if(e.eventPreventDefault(),"pointermove"===e.type&&"left"===e.button){var t=(0,W.BB).intDxy(i.pointerRemainder,e.dX/i.scale,e.dY/i.scale),n=t.dX,r=t.dY;h(n),l(r),i.keyListener.isPressed("shift")&&(o(-n),s(-r)),i.update()}"pointerup"===e.type&&i.commit()}}),this.rootEl.append(this.darken[1].el,this.darken[0].el,this.darken[2].el,this.darken[3].el,this.thirdsHorizontal.el,this.thirdsVertical.el,this.outline.el,this.edges[1].el,this.edges[0].el,this.edges[2].el,this.edges[3].el,this.cornerElArr[0].el,this.cornerElArr[1].el,this.cornerElArr[2].el,this.cornerElArr[3].el),this.update()}return(0,D._)(e,[{key:"update",value:function(){this.edges[0].update(),this.edges[1].update(),this.edges[2].update(),this.edges[3].update(),this.cornerElArr[0].update(),this.cornerElArr[1].update(),this.cornerElArr[2].update(),this.cornerElArr[3].update(),this.darken[0].update(),this.darken[1].update(),this.darken[2].update(),this.darken[3].update(),this.outline.update(),this.thirdsHorizontal.update(),this.thirdsVertical.update()}},{key:"commit",value:function(){this.pointerRemainder.x=0,this.pointerRemainder.y=0,this.callback(this.getTransform())}},{key:"getTransform",value:function(){return this.grips[1].x-=this.grips[0].x,this.grips[1].y-=this.grips[0].y,this.grips[2].x-=this.grips[0].x,this.grips[2].y-=this.grips[0].y,this.grips[3].x-=this.grips[0].x,this.grips[3].y-=this.grips[0].y,this.x+=this.grips[0].x,this.y+=this.grips[0].y,this.grips[0].x=0,this.grips[0].y=0,{x:this.x,y:this.y,width:this.grips[1].x,height:this.grips[2].y}}},{key:"setTransform",value:function(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,(0,W.BB).css(this.rootEl,{left:this.x*this.scale+"px",top:this.y*this.scale+"px"}),this.grips[0].x=0,this.grips[0].y=0,this.grips[1].x=this.width,this.grips[1].y=0,this.grips[2].x=this.width,this.grips[2].y=this.height,this.grips[3].x=0,this.grips[3].y=this.height,this.update(),this.commit()}},{key:"setScale",value:function(e){this.scale=e,(0,W.BB).css(this.rootEl,{left:this.x*this.scale+"px",top:this.y*this.scale+"px"}),this.update()}},{key:"showThirds",value:function(e){this.thirdsHorizontal.el.style.display=e?"block":"none",this.thirdsVertical.el.style.display=e?"block":"none"}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.keyListener.destroy(),this.outlinePointerListener.destroy(),this.corner0PointerListener.destroy(),this.corner1PointerListener.destroy(),this.corner2PointerListener.destroy(),this.corner3PointerListener.destroy(),this.edge0PointerListener.destroy(),this.edge1PointerListener.destroy(),this.edge2PointerListener.destroy(),this.edge3PointerListener.destroy()}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),eI=I("1C8RU"),_=I("7jh4K"),tQ=function(){function e(t){var i,n=this;(0,O._)(this,e),this.animationCanvasCheckerPattern={},this.largeCanvasCheckerPattern={},this.rootEl=(0,W.BB).el({className:"kl-layer-preview"}),this.isVisible=!0,this.height=40,this.canvasSize=this.height-10,this.largeCanvasSize=300,this.lastDrawnState=-2,this.lastDrawnSize={width:0,height:0},this.animationCanvas=(0,W.BB).canvas(),this.animationCanvasCtx=(0,W.BB).ctx(this.animationCanvas),this.animationLength=30,this.animationCount=0,this.largeCanvasIsVisible=!1,this.uiState=t.uiState,this.contentWrapperEl=(0,W.BB).el({css:{display:"flex",alignItems:"center",height:this.height+"px"}});var r=(0,W.BB).el({css:{display:"flex",justifyContent:"flex-end",alignItems:"center",width:"23px",flexShrink:"0"}});this.checkEl=(0,W.BB).el({parent:r,tagName:"input",css:{pointerEvents:"none"},custom:{type:"checkbox",disabled:"true"}});var a=(0,W.BB).el({css:{minWidth:this.height+"px",height:this.height+"px",display:"flex",justifyContent:"center",alignItems:"center"}});this.canvas=(0,W.BB).canvas(this.canvasSize,this.canvasSize),this.canvasCtx=(0,W.BB).ctx(this.canvas),this.canvas.title=J("layers-active-layer");var s=(0,W.BB).el({css:{flexGrow:"1",paddingLeft:"10px",fontSize:"13px",overflow:"hidden",position:"relative"}});this.nameLabelEl=(0,W.BB).el({content:"",css:{cssFloat:"left",whiteSpace:"nowrap"}});var o=(0,W.BB).el({css:{position:"absolute",left:"10px",top:"0",width:"90px",height:"100%"}});t.onClick&&(o.addEventListener("click",function(){return t.onClick()}),this.canvas.addEventListener("click",function(){return t.onClick()}),r.addEventListener("click",function(){return t.onClick()})),this.opacityEl=(0,W.BB).el({content:J("opacity")+"<br>100%",css:{minWidth:"60px",fontSize:"12px",textAlign:"center"}}),this.largeCanvasWrapper=(0,W.BB).el({onClick:W.BB.handleClick,css:{pointerEvents:"none",background:"#fff",position:"absolute",right:"280px",top:"10px",border:"1px solid #aaa",boxShadow:"1px 1px 3px rgba(0,0,0,0.3)",transition:"opacity 300ms ease-in-out",userSelect:"none",display:"block",webkitTouchCallout:"none"}}),this.largeCanvas=(0,W.BB).canvas(this.largeCanvasSize,this.largeCanvasSize),this.largeCanvasWrapper.append(this.largeCanvas),this.largeCanvasCtx=(0,W.BB).ctx(this.largeCanvas),(0,W.BB).css(this.largeCanvas,{display:"block"}),a.append(this.canvas),s.append(this.nameLabelEl,o),this.contentWrapperEl.append(r,a,s,this.opacityEl),this.rootEl.append(this.contentWrapperEl),this.updateCheckerPatterns(),(0,eI.theme).addIsDarkListener(function(){n.updateCheckerPatterns(),n.draw(!0)}),setInterval(function(){n.layerObj&&V.getState()!==n.lastDrawnState&&(n.layerObj.opacity=n.layerObj.context.canvas.opacity,n.draw(!1))},2e3);var l=function(){n.largeCanvasWrapper.remove()},h=function(e){n.largeCanvasIsVisible!==e&&(clearTimeout(i),n.largeCanvasIsVisible=e,e?i=setTimeout(function(){n.drawLargeCanvas(),n.largeCanvasWrapper.style.opacity="0",t.klRootEl.append(n.largeCanvasWrapper),setTimeout(function(){n.largeCanvasWrapper.style.opacity="1"},20)},250):(n.largeCanvasWrapper.style.opacity="0",i=setTimeout(l,320)))};new W.BB.PointerListener({target:this.canvas,onEnterLeave:function(e){h(e)}})}return(0,D._)(e,[{key:"updateCheckerPatterns",value:function(){var e=(0,W.BB).createCheckerCanvas(4,(0,eI.theme).isDark());this.animationCanvasCheckerPattern=(0,_.throwIfNull)(this.animationCanvasCtx.createPattern(e,"repeat")),this.largeCanvasCheckerPattern=(0,_.throwIfNull)(this.canvasCtx.createPattern(e,"repeat"))}},{key:"animate",value:function(){var e=this;0!==this.animationCount&&(this.animationCount--,this.canvasCtx.save(),this.canvasCtx.globalAlpha=Math.pow((this.animationLength-this.animationCount)/this.animationLength,2),this.canvasCtx.drawImage(this.animationCanvas,0,0),this.canvasCtx.restore(),this.animationCount>0&&requestAnimationFrame(function(){return e.animate()}))}},{key:"drawLargeCanvas",value:function(){if(this.largeCanvasIsVisible&&this.layerObj){var e=this.layerObj.context.canvas,t=(0,W.BB).fitInto(e.width,e.height,this.largeCanvasSize,this.largeCanvasSize,1);this.largeCanvas.width=Math.round(t.width),this.largeCanvas.height=Math.round(t.height),this.largeCanvasCtx.save(),this.largeCanvas.width>e.width?this.largeCanvasCtx.imageSmoothingEnabled=!1:(this.largeCanvasCtx.imageSmoothingEnabled=!0,this.largeCanvasCtx.imageSmoothingQuality="high"),this.largeCanvasCtx.fillStyle=this.largeCanvasCheckerPattern,this.largeCanvasCtx.fillRect(0,0,this.largeCanvas.width,this.largeCanvas.height),this.largeCanvasCtx.drawImage(e,0,0,this.largeCanvas.width,this.largeCanvas.height),this.largeCanvasCtx.restore();var i=this.rootEl.getBoundingClientRect();(0,W.BB).css(this.largeCanvasWrapper,{top:Math.max(10,i.top+this.height/2-this.largeCanvas.height/2)+"px"})}}},{key:"draw",value:function(e){if(this.isVisible&&this.layerObj){var t=this.layerObj.isVisible;this.checkEl.parentElement.title=t?J("layers-active-layer-visible"):J("layers-active-layer-hidden"),this.checkEl.checked=t,this.checkEl.style.boxShadow=t?"":"0 0 0 1px red",this.nameLabelEl.textContent=this.layerObj.name,this.layerObj.isVisible?this.opacityEl.innerHTML=J("opacity")+"<br>"+Math.round(100*this.layerObj.opacity)+"%":this.opacityEl.innerHTML=J("opacity")+"<br><s>"+Math.round(100*this.layerObj.opacity)+"%</s>";var i=this.layerObj.context.canvas;if(i.width!==this.lastDrawnSize.width||i.height!==this.lastDrawnSize.height){var n=(0,W.BB).fitInto(i.width,i.height,this.canvasSize,this.canvasSize,1);this.canvas.width=Math.round(n.width),this.canvas.height=Math.round(n.height),e=!0}this.animationCanvas.width=this.canvas.width,this.animationCanvas.height=this.canvas.height,this.animationCanvasCtx.save(),this.animationCanvasCtx.imageSmoothingEnabled=!1,this.animationCanvasCtx.fillStyle=this.animationCanvasCheckerPattern,this.animationCanvasCtx.fillRect(0,0,this.animationCanvas.width,this.animationCanvas.height),this.animationCanvasCtx.drawImage(i,0,0,this.animationCanvas.width,this.animationCanvas.height),this.animationCanvasCtx.restore(),e?(this.animationCount=0,this.canvasCtx.save(),this.canvasCtx.drawImage(this.animationCanvas,0,0),this.canvasCtx.restore()):(this.animationCount=this.animationLength,this.animate()),this.drawLargeCanvas(),this.lastDrawnState=V.getState(),this.lastDrawnSize.width=i.width,this.lastDrawnSize.height=i.height}}},{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){if(this.isVisible!==e){this.isVisible=e,this.contentWrapperEl.style.display=this.isVisible?"flex":"none",this.rootEl.style.marginBottom=this.isVisible?"":"10px";var t=V.getState();e&&this.lastDrawnState!==t&&this.draw(!0)}}},{key:"setLayer",value:function(e){this.layerObj=e,this.draw(!0)}},{key:"setUiState",value:function(e){this.uiState=e,"left"===this.uiState?(0,W.BB).css(this.largeCanvasWrapper,{left:"280px",right:""}):(0,W.BB).css(this.largeCanvasWrapper,{left:"",right:"280px"})}}]),e}(),W=I("eWjiX");function tZ(){return window.innerWidth<550}var tJ={width:340,height:220},t$={width:540,height:300};function t0(e){return e?tJ.width:t$.width}function t1(e){return e?tJ.height:t$.height}var O=I("cx0mh"),W=I("eWjiX"),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),t2=function(){function e(t){var i=this;(0,O._)(this,e);var n={width:150,svHeight:90,hHeight:20,sliderHeight:25},r=!1;this.rootEl=(0,W.BB).el({className:"kl-overlay-toolspace"});var a={color:null,size:null,opacity:null},s=(0,W.BB).el({parent:this.rootEl,className:"kl-overlay-toolspace__color"}),o=new eM({width:n.width,heightSV:n.svHeight,heightH:n.hHeight,color:t.brushSettingService.getColor(),callback:function(e){l.style.backgroundColor="rgb("+e.r+","+e.g+","+e.b+")",t.brushSettingService.setColor(e,d)}}),l=(0,W.BB).el({css:{width:n.width+"px",height:n.hHeight+"px",pointerEvents:"none"}}),h=t.brushSettingService.getColor();l.style.backgroundColor="rgb("+h.r+","+h.g+","+h.b+")",s.append(l,o.getElement());var c=function(e){o.setColor(e),l.style.backgroundColor="rgb("+e.r+","+e.g+","+e.b+")"},u=new ed({label:J("brush-size"),width:n.width,height:n.sliderHeight,min:0,max:500,value:50,resolution:225,eventResMs:1e3/30,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(e){t.brushSettingService.setSize(e)},formatFunc:function(e){return e<10?(0,W.BB).round(e,1):Math.round(e)}});(0,W.BB).css(u.getElement(),{marginTop:"2px"});var p=new ed({label:J("opacity"),width:n.width,height:n.sliderHeight,min:0,max:1,value:1,resolution:225,eventResMs:1e3/30,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(e){t.brushSettingService.setOpacity(e)}});(0,W.BB).css(p.getElement(),{margin:"2px 0"}),this.rootEl.append(u.getElement(),p.getElement());var d=function(e){"color"===e.type&&(r?c(e.value):a.color=e.value),"size"===e.type&&(r?u.setValue(e.value):a.size=e.value),"opacity"===e.type&&(r?p.setValue(e.value):a.opacity=e.value),"sliderConfig"===e.type&&(u.update(e.value.sizeSlider),p.update(e.value.opacitySlider))};t.brushSettingService.subscribe(d);var g=t.brushSettingService.getSliderConfig();u.update(g.sizeSlider),p.update(g.opacitySlider),u.setValue(t.brushSettingService.getSize()),p.setValue(t.brushSettingService.getOpacity());var f=function(){(0,W.BB).unfocusAnyInput(),i.rootEl.style.display=r?"block":"none",r&&v&&(0,W.BB).css(i.rootEl,{left:v.x-Math.round(n.width/2)+"px",top:v.y-Math.round(n.svHeight+3*n.hHeight/2)+"px"})},v=null;document.addEventListener("pointermove",function(e){v={x:e.pageX,y:e.pageY}}),new W.BB.KeyListener({onDown:function(e,i,n,s){if(!s){if(r){r=!1,f();return}t.enabledTest()&&v&&["ctrl+alt","cmd+alt","alt+ctrl","alt+cmd"].includes(n)&&(i.preventDefault(),r=!0,null!==a.color&&(c(a.color),a.color=null),null!==a.size&&(u.setValue(a.size),a.size=null),null!==a.opacity&&(p.setValue(a.opacity),a.opacity=null),f())}},onUp:function(e,t,i){["ctrl+alt","cmd+alt","alt+ctrl","alt+cmd"].includes(i)&&r&&(r=!1,o.end(),f())},onBlur:function(){r&&(r=!1,o.end(),f())}})}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),t5={};t5=I("f6OTe").getBundleURL("lYbF2")+"klecks-logo.2dcce02e.png";var t3={};t3=I("f6OTe").getBundleURL("lYbF2")+"new-image.2d692480.svg";var t4={};t4=I("f6OTe").getBundleURL("lYbF2")+"import.7a68c844.svg";var t6={};t6=I("f6OTe").getBundleURL("lYbF2")+"export.2deb9ff8.svg";var t7={};t7=I("f6OTe").getBundleURL("lYbF2")+"share.454898d1.svg";var t8={};t8=I("f6OTe").getBundleURL("lYbF2")+"help.208e9032.svg";var t9=function(){function e(i){(0,O._)(this,e);var n=function(e){var t=6+(e.extraPadding?e.extraPadding:0),i=(0,W.BB).el({className:"toolspace-row-button nohighlight",title:e.title,onClick:e.onClick,css:{padding:e.contain?t+"px 0":""}}),n=(0,W.BB).el({className:e.darkInvert?"dark-invert":void 0,css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:e.contain?"contain":"",height:"100%"}});n.style.pointerEvents="none",i.append(n);var r=new W.BB.PointerListener({target:i,onEnterLeave:function(e){i.classList.toggle("toolspace-row-button-hover",e)}});return{el:i,pointerListener:r}};this.rootEl=(0,W.BB).el({className:"kl-toolspace-row",css:{height:"36px",display:"flex"}});var r=n({onClick:i.onLogo,title:J("home"),image:i.logoImg?i.logoImg:t(t5),contain:!0,darkInvert:!0});r.el.classList.add("kl-tool-row-border-right"),(0,W.BB).css(r.el,{width:"46px"});var a=n({onClick:i.onNew,title:J("file-new"),image:t(t3),extraPadding:1,contain:!0}),s=n({onClick:i.onImport,title:J("file-import"),image:t(t4),extraPadding:1,contain:!0}),o=n({onClick:i.onSave,title:J("file-save"),image:t(t6),extraPadding:1,contain:!0}),l=null;(0,W.BB).canShareFiles()&&(l=n({onClick:i.onShare,title:J("file-share"),image:t(t7),contain:!0,darkInvert:!0}));var h=n({onClick:i.onHelp,title:J("help"),image:t(t8),contain:!0,darkInvert:!0});(0,W.BB).append(this.rootEl,[r.el,a.el,s.el,o.el,l?l.el:void 0,h.el])}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),ie={};ie=I("f6OTe").getBundleURL("lYbF2")+"tool-paint.f73a8943.svg";var it={};it=I("f6OTe").getBundleURL("lYbF2")+"tool-fill.3358320a.svg";var ii={};ii=I("f6OTe").getBundleURL("lYbF2")+"tool-gradient.64486254.svg";var ir={};ir=I("f6OTe").getBundleURL("lYbF2")+"tool-text.1cbd0325.svg";var ia={};ia=I("f6OTe").getBundleURL("lYbF2")+"tool-shape.3de78c3f.svg";var is=function(){function e(i){var n,r,a,s=this;(0,O._)(this,e),this.smallMargin="6px 0",this.optionArr=["draw","fill","gradient","text","shape"],this.imArr=[t(ie),t(it),t(ii),t(ir),t(ia)],this.titleArr=["".concat(J("tool-brush")," [B]"),"".concat(J("tool-paint-bucket")," [G]"),"".concat(J("tool-gradient")," [G]"),"".concat(J("tool-text")," [T]"),"".concat(J("tool-shape")," [U]")],this.currentActiveIndex=0,this.isActive=!0;var o=!1;setTimeout(function(){for(var e=1;e<s.imArr.length;e++)new Image().src=s.imArr[e]},100),this.rootEl=(0,W.BB).el({css:{position:"relative",flexGrow:"1"}});var l=!1;W.BB.hasPointerEvents&&new W.BB.PointerListener({target:this.rootEl,onPointer:function(e){if("pointerdown"===e.type)o||(n=setTimeout(function(){g()},400),l=!0,r=e.pageX,a=e.pageY);else if("pointermove"===e.type)l&&!o&&(0,W.BB).dist(r,a,e.pageX,e.pageY)>5&&(clearTimeout(n),g());else if("pointerup"===e.type){if(clearTimeout(n),o&&l){for(var t=document.elementFromPoint(e.pageX,e.pageY),h=0;h<s.dropdownBtnArr.length;h++)if(t===s.dropdownBtnArr[h].wrapper){f(),s.isActive=!0,s.currentActiveIndex=h,s.updateButton(),i.onChange(s.optionArr[s.currentActiveIndex]);break}}l=!1}}}),this.activeButton=(0,W.BB).el({parent:this.rootEl,className:"toolspace-row-button nohighlight toolspace-row-button-activated",title:this.titleArr[this.currentActiveIndex],onClick:function(e){if(s.isActive&&!o){e.preventDefault(),e.stopPropagation(),g();return}s.isActive=!0,i.onChange(s.optionArr[s.currentActiveIndex]),o&&f()},css:{padding:"10px 0",pointerEvents:"auto",height:"100%",boxSizing:"border-box"}}),this.activeButtonIm=(0,W.BB).el({parent:this.activeButton,className:"dark-invert",css:{backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",width:"calc(100% - 7px)",height:"100%",pointerEvents:"none",opacity:"0.75"}}),this.arrowButton=(0,W.BB).el({parent:this.activeButton,className:"dark-invert",css:{position:"absolute",right:"1px",bottom:"1px",width:"18px",height:"18px",cursor:"pointer",backgroundImage:"url('"+t(tM)+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"60%"},title:"More Tools",onClick:function(e){e.preventDefault(),e.stopPropagation(),g()}});var h=(0,W.BB).el({css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0"}});new W.BB.PointerListener({target:h,onPointer:function(e){"pointerdown"===e.type&&(e.eventPreventDefault(),f())}});var c=(0,W.BB).el({className:"tool-dropdown-wrapper",css:{position:"absolute",width:"100%",height:100*(this.optionArr.length-1)+"%",top:"100%",left:"0",zIndex:"1",boxSizing:"border-box",cursor:"pointer",transition:"height 0.1s ease-in-out, opacity 0.1s ease-in-out",borderBottomLeftRadius:"5px",borderBottomRightRadius:"5px",overflow:"hidden"}});this.dropdownBtnArr=[];for(var u=function(e){var t=(0,W.BB).el({parent:c,className:"tool-dropdown-button",title:e.title,css:{padding:"10px 0",height:100/(s.optionArr.length-1)+"%",boxSizing:"border-box"},onClick:function(t){t.preventDefault(),t.stopPropagation(),e.onClick(e.index)}});return(0,W.BB).el({parent:t,className:"dark-invert",css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",height:"100%",pointerEvents:"none",opacity:"0.75"}}),{wrapper:t,show:function(e){t.style.display=e?"block":"none"},setIsSmall:function(e){t.style.padding=e?s.smallMargin:"10px 0"}}},p=function(e){f(),s.isActive=!0,s.currentActiveIndex=e,s.updateButton(),i.onChange(s.optionArr[s.currentActiveIndex])},d=0;d<this.optionArr.length;d++)this.dropdownBtnArr.push(u({index:d,id:this.optionArr[d],image:this.imArr[d],title:this.titleArr[d],onClick:p}));var g=function(){H.increase(.5),o=!0;for(var e=0;e<s.optionArr.length;e++)s.dropdownBtnArr[e].show(s.currentActiveIndex!==e);s.arrowButton.style.display="none",s.rootEl.style.zIndex="1",document.body.append(h),s.rootEl.append(c)},f=function(){H.decrease(.5),o=!1,s.arrowButton.style.removeProperty("display"),s.rootEl.style.removeProperty("z-index"),h.remove(),c.remove()};this.updateButton()}return(0,D._)(e,[{key:"updateButton",value:function(){this.activeButton.title=this.titleArr[this.currentActiveIndex],this.activeButtonIm.style.backgroundImage="url('"+this.imArr[this.currentActiveIndex]+"')"}},{key:"setIsSmall",value:function(e){this.activeButton.style.padding=e?this.smallMargin:"10px 0";for(var t=0;t<this.optionArr.length;t++)this.dropdownBtnArr[t].setIsSmall(e);e?(this.arrowButton.style.width="14px",this.arrowButton.style.height="14px"):(this.arrowButton.style.width="18px",this.arrowButton.style.height="18px")}},{key:"setActive",value:function(e){if(this.optionArr.includes(e)){this.isActive=!0;for(var t=0;t<this.optionArr.length;t++)if(this.optionArr[t]===e){this.currentActiveIndex=t;break}this.activeButton.classList.add("toolspace-row-button-activated"),this.updateButton()}else this.isActive=!1,this.activeButton.classList.remove("toolspace-row-button-activated")}},{key:"getActive",value:function(){return this.optionArr[this.currentActiveIndex]}},{key:"getElement",value:function(){return this.rootEl}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),io={};io=I("f6OTe").getBundleURL("lYbF2")+"tool-undo.540bf765.svg";var il=function(){function e(i){var n=this;(0,O._)(this,e),this.rootEl=(0,W.BB).el({className:"kl-toolspace-row",css:{height:"54px",display:"flex"}}),this.onActivate=i.onActivate,this.currentActiveStr="draw";var r=function(e){var t=e.doLighten?"6px 0":"8px 0",i=(0,W.BB).el({className:"toolspace-row-button nohighlight",onClick:e.onClick,css:{padding:e.contain?"10px 0":""}}),n=(0,W.BB).el({className:"dark-invert",css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:e.contain?"contain":"",height:"100%",transform:e.doMirror?"scale(-1, 1)":"",pointerEvents:"none",opacity:e.doLighten?"0.75":"1"}});i.append(n);var r=new W.BB.PointerListener({target:i,onEnterLeave:function(e){i.classList.toggle("toolspace-row-button-hover",e)}});return{el:i,pointerListener:r,setIsSmall:function(n){i.style.padding=e.contain?n?t:"10px 0":""}}},a=function(e){var t=(0,W.BB).el({css:{flexGrow:"1",position:"relative"}}),i=(0,W.BB).createSvg({elementType:"svg",width:"67px",height:"54px",viewBox:"0 0 100 100",preserveAspectRatio:"none"});(0,W.BB).css(i,{position:"absolute",left:"0",top:"0"});var n=(0,W.BB).createSvg({elementType:"defs",childrenArr:[{elementType:"filter",id:"innershadow",x0:"-50%",y0:"-50%",width:"200%",height:"200%",childrenArr:[{elementType:"feGaussianBlur",in:"SourceAlpha",stdDeviation:"10",result:"blur"},{elementType:"feOffset",dx:"2",dy:"2"},{elementType:"feComposite",in2:"SourceAlpha",operator:"arithmetic",k2:"-1",k3:"1",result:"shadowDiff"},{elementType:"feFlood","flood-color":"#000","flood-opacity":"0.2"},{elementType:"feComposite",in2:"shadowDiff",operator:"in"},{elementType:"feComposite",in2:"SourceGraphic",operator:"over",result:"firstfilter"},{elementType:"feGaussianBlur",in:"firstfilter",stdDeviation:"10",result:"blur2"},{elementType:"feOffset",dx:"2",dy:"2"},{elementType:"feComposite",in2:"firstfilter",operator:"arithmetic",k2:"-1",k3:"1",result:"shadowDiff"},{elementType:"feFlood","flood-color":"#000","flood-opacity":"0.2"},{elementType:"feComposite",in2:"shadowDiff",operator:"in"},{elementType:"feComposite",in2:"firstfilter",operator:"over"}]}]}),r=(0,W.BB).createSvg({elementType:"path","vector-effect":"non-scaling-stroke",d:"M0,0 L 100,0 0,100 z",fill:"rgba(0,0,0,0)",class:"toolspace-svg-triangle-button"});r.onclick=function(){e.onLeft(),r.classList.remove("toolspace-svg-triangle-button-hover")};var a=(0,W.BB).createSvg({elementType:"path","vector-effect":"non-scaling-stroke",d:"M100,100 L 100,0 0,100 z",fill:"rgba(0,0,0,0)",class:"toolspace-svg-triangle-button"});a.onclick=function(){e.onRight(),a.classList.remove("toolspace-svg-triangle-button-hover")};var s=new W.BB.PointerListener({target:r,onEnterLeave:function(e){r.classList.toggle("toolspace-svg-triangle-button-hover",e)}}),o=new W.BB.PointerListener({target:a,onEnterLeave:function(e){a.classList.toggle("toolspace-svg-triangle-button-hover",e)}});i.append(n,r,a),t.append(i);var l=(0,W.BB).el({parent:t,className:"dark-invert",css:{backgroundImage:"url('"+e.leftImage+"')",backgroundRepeat:"no-repeat",backgroundSize:"contain",width:"20px",height:"20px",position:"absolute",left:"10px",top:"8px",pointerEvents:"none"}});t.append(l);var h=(0,W.BB).el({parent:t,className:"dark-invert",css:{backgroundImage:"url('"+(e.rightImage?e.rightImage:e.leftImage)+"')",backgroundRepeat:"no-repeat",backgroundSize:"contain",width:"20px",height:"20px",position:"absolute",right:"10px",bottom:"8px",transform:e.rightImage?"":"scale(-1, 1)",pointerEvents:"none"}});return{el:t,setIsEnabledLeft:function(e){r.classList.toggle("toolspace-row-button-disabled",!e),l.classList.toggle("toolspace-row-button-disabled",!e)},setIsEnabledRight:function(e){a.classList.toggle("toolspace-row-button-disabled",!e),h.classList.toggle("toolspace-row-button-disabled",!e)},leftPointerListener:s,rightPointerListener:o}};this.toolDropdown=new is({onChange:function(e){n.setActive(e,!0)}}),this.rootEl.append(this.toolDropdown.getElement()),this.handButton=r({onClick:function(){n.setActive("hand",!0)},image:t(e7),contain:!0,doLighten:!0}),this.handButton.el.classList.add("kl-tool-row-border-right"),this.handButton.el.title=J("tool-hand"),this.rootEl.append(this.handButton.el),this.zoomInNOutButton=a({onLeft:i.onZoomIn,onRight:i.onZoomOut,leftImage:t(e3),rightImage:t(e4)}),this.zoomInNOutButton.el.title=J("tool-zoom"),this.rootEl.append(this.zoomInNOutButton.el),this.zoomInButton=r({onClick:i.onZoomIn,image:t(e3),contain:!0}),this.zoomInButton.el.title=J("zoom-in"),this.rootEl.append(this.zoomInButton.el),this.zoomOutButton=r({onClick:i.onZoomOut,image:t(e4),contain:!0}),this.zoomOutButton.el.title=J("zoom-out"),this.rootEl.append(this.zoomOutButton.el),this.undoNRedoButton=a({onLeft:i.onUndo,onRight:i.onRedo,leftImage:t(io),rightImage:null}),this.undoNRedoButton.el.title=J("undo")+"/"+J("redo"),this.undoNRedoButton.setIsEnabledLeft(!1),this.undoNRedoButton.setIsEnabledRight(!1),this.rootEl.append(this.undoNRedoButton.el),this.undoButton=r({onClick:i.onUndo,image:t(io),contain:!0}),this.undoButton.el.title=J("undo"),this.undoButton.el.classList.add("toolspace-row-button-disabled"),this.rootEl.append(this.undoButton.el),this.redoButton=r({onClick:i.onRedo,image:t(io),contain:!0,doMirror:!0}),this.redoButton.el.title=J("redo"),this.redoButton.el.classList.add("toolspace-row-button-disabled"),this.rootEl.append(this.redoButton.el),this.zoomInButton.el.style.display="none",this.zoomOutButton.el.style.display="none",this.undoButton.el.style.display="none",this.redoButton.el.style.display="none"}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setIsSmall",value:function(e){(0,W.BB).css(this.rootEl,{height:e?"36px":"54px"}),this.toolDropdown.setIsSmall(e),this.handButton.setIsSmall(e),this.zoomInButton.setIsSmall(e),this.zoomOutButton.setIsSmall(e),this.undoButton.setIsSmall(e),this.redoButton.setIsSmall(e),e?(this.zoomInNOutButton.el.style.display="none",this.undoNRedoButton.el.style.display="none",this.zoomInButton.el.style.display="block",this.zoomOutButton.el.style.display="block",this.undoButton.el.style.display="block",this.redoButton.el.style.display="block"):(this.zoomInNOutButton.el.style.display="block",this.undoNRedoButton.el.style.display="block",this.zoomInButton.el.style.display="none",this.zoomOutButton.el.style.display="none",this.undoButton.el.style.display="none",this.redoButton.el.style.display="none")}},{key:"setEnableZoomIn",value:function(e){this.zoomInButton.el.classList.toggle("toolspace-row-button-disabled",!e),this.zoomInNOutButton.setIsEnabledLeft(e)}},{key:"setEnableZoomOut",value:function(e){this.zoomOutButton.el.classList.toggle("toolspace-row-button-disabled",!e),this.zoomInNOutButton.setIsEnabledRight(e)}},{key:"setEnableUndo",value:function(e){this.undoButton.el.classList.toggle("toolspace-row-button-disabled",!e),this.undoNRedoButton.setIsEnabledLeft(e)}},{key:"setEnableRedo",value:function(e){this.redoButton.el.classList.toggle("toolspace-row-button-disabled",!e),this.undoNRedoButton.setIsEnabledRight(e)}},{key:"setActive",value:function(e,t){this.currentActiveStr!==e&&(this.currentActiveStr=e,this.toolDropdown.setActive(this.currentActiveStr),this.handButton.el.classList.toggle("toolspace-row-button-activated","hand"===this.currentActiveStr),t&&this.onActivate(this.currentActiveStr))}},{key:"getActive",value:function(){return this.currentActiveStr}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),ih=function(){function e(t){(0,O._)(this,e),this.rootEl=(0,W.BB).el({tagName:"label",className:"kl-stabilizer",content:J("stabilizer")+"&nbsp;",title:J("stabilizer-title")});var i=new ea({optionArr:[["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"]],initValue:""+t.smoothing,onChange:function(e){t.onSelect(parseInt(e))}});this.rootEl.append(i.getElement()),this.pointerListener=new W.BB.PointerListener({target:this.rootEl,onWheel:function(e){i.setDeltaValue(e.deltaY)}})}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),ic={};ic=I("f6OTe").getBundleURL("lYbF2")+"inverted-border.3353c7f3.svg";var iu=function(){function e(i){var n,r=this;(0,O._)(this,e);var a=null!==(n=i.height)&&void 0!==n?n:35;this.rootEl=(0,W.BB).el({className:"tabrow",css:{height:a+1+"px"}}),this.tabArr=[],this.roundRight=(0,W.BB).el({css:{width:"10px",height:"10px",backgroundImage:"url('".concat(t(ic),"')"),backgroundSize:"cover",position:"absolute",right:"-10px",bottom:"0",pointerEvents:"none"}}),this.roundLeft=(0,W.BB).el({css:{width:"10px",height:"10px",backgroundImage:"url('".concat(t(ic),"')"),backgroundSize:"cover",position:"absolute",left:"-10px",bottom:"0",transform:"scale(-1,1)",pointerEvents:"none"}});for(var s=function(e,t,i){var n=!("isVisible"in e)||void 0===e.isVisible||e.isVisible,s={id:e.id,isVisible:n,onOpen:e.onOpen,onClose:e.onClose,update:function(e){s.el.className=e===s?i?"tabrow__tab tabrow__tab--opened-accented":"tabrow__tab tabrow__tab--opened":"tabrow__tab",s.el.style.display=s.isVisible?"block":"none"},el:(0,W.BB).el({parent:r.rootEl,content:("label"in e)?e.label:"",title:("title"in e)?e.title:void 0,className:t===e.id?i?"tabrow__tab tabrow__tab--opened-accented":"tabrow__tab tabrow__tab--opened":"tabrow__tab",css:{lineHeight:a+"px",display:n?"block":"none",zIndex:"0"},onClick:function(){r.activeTab!==s&&r.open(s.id)}}),pointerListener:{}};return("image"in e)&&(0,W.BB).el({tagName:"span",parent:s.el,className:"dark-invert",css:{backgroundImage:'url("'.concat(e.image,'")'),backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat",display:"flex",height:a-7+"px",justifyContent:"center",margin:"4px auto"}}),("css"in e)&&void 0!==e.css&&(0,W.BB).css(s.el,e.css),s.pointerListener=new W.BB.PointerListener({target:s.el,onEnterLeave:function(e){s.el.classList.toggle("tabrow__tab-hover",e)}}),t===s.id?(s.onOpen(),s.el.append(r.roundRight,r.roundLeft)):s.onClose(),s},o=null,l=0;l<i.tabArr.length;l++){var h=s(i.tabArr[l],i.initialId,i.useAccent||!1);h.id===i.initialId&&(o=h),this.tabArr.push(h)}if(!o)throw"invalid initialId";this.activeTab=o}return(0,D._)(e,[{key:"update",value:function(){for(var e=0;e<this.tabArr.length;e++)this.tabArr[e].update(this.activeTab)}},{key:"getElement",value:function(){return this.rootEl}},{key:"open",value:function(e){for(var t=0;t<this.tabArr.length;t++)if(this.tabArr[t].id===e){if(this.activeTab===this.tabArr[t])return;this.activeTab.onClose(),this.activeTab=this.tabArr[t],this.activeTab.onOpen(),this.activeTab.el.append(this.roundRight,this.roundLeft),this.update();return}throw"TabRow.open - invalid tabId"}},{key:"getOpenedTabId",value:function(){return""+this.activeTab.id}},{key:"setIsVisible",value:function(e,t){for(var i=0;i<this.tabArr.length;i++)if(this.tabArr[i].id===e){this.tabArr[i].isVisible=t,this.update();return}throw"TabRow.setIsVisible - invalid tabId"}},{key:"destroy",value:function(){this.tabArr.forEach(function(e){(0,W.BB).destroyEl(e.el),e.pointerListener.destroy()})}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),ip={};ip=I("f6OTe").getBundleURL("lYbF2")+"edit-rotate.fd0e572a.svg";var id=function(){function e(i){(0,O._)(this,e),this.isVisible=!0,this.rootEl=(0,W.BB).el({css:{margin:"10px"}}),this.scale=i.scale,this.angleDeg=i.angleDeg,this.onAngleChange=i.onAngleChange;var n=(0,W.BB).el({css:{marginBottom:"10px",display:"flex"}}),r=(0,W.BB).el({css:{display:"flex",marginBottom:"10px"}}),a=(0,W.BB).el({css:{display:"flex"}});this.rootEl.append(n,r,a),this.scaleEl=(0,W.BB).el({css:{width:"55px",userSelect:"none"}}),n.append(this.scaleEl),this.angleIm=new Image,this.angleIm.src=t(ez),(0,W.BB).css(this.angleIm,{verticalAlign:"bottom",width:"20px",height:"20px",marginRight:"5px",borderRadius:"10px",background:"rgba(0,0,0,0.2)",userSelect:"none"}),n.append(this.angleIm),this.angleEl=(0,W.BB).el({parent:n,css:{userSelect:"none"}}),this.updateUi();var s=(0,W.BB).el({tagName:"button",content:J("hand-reset"),onClick:i.onReset});(0,W.BB).makeUnfocusable(s);var o=(0,W.BB).el({tagName:"button",content:J("hand-fit"),css:{marginLeft:"10px"},onClick:i.onFit});(0,W.BB).makeUnfocusable(o),r.append(s,o);var l=(0,W.BB).el({tagName:"button",content:'<img height="20" src="'+t(ip)+'" alt="Rotate" style="transform: scale(-1, 1)"/>',onClick:function(){i.onAngleChange(-15,!0)}});(0,W.BB).makeUnfocusable(l);var h=(0,W.BB).el({tagName:"button",content:"0",css:{marginLeft:"10px"},onClick:function(){i.onAngleChange(0)}});(0,W.BB).makeUnfocusable(h);var c=(0,W.BB).el({tagName:"button",content:'<img height="20" src="'+t(ip)+'" alt="Rotate"/>',css:{marginLeft:"10px"},onClick:function(){i.onAngleChange(15,!0)}});(0,W.BB).makeUnfocusable(c),a.append(l,h,c)}return(0,D._)(e,[{key:"updateUi",value:function(){this.scaleEl.innerHTML=Math.round(100*this.scale)+"%",this.angleEl.innerHTML=Math.round(this.angleDeg)+"",this.angleIm.style.transform="rotate("+this.angleDeg+"deg)",this.angleDeg%90==0?this.angleIm.style.boxShadow="inset 0 0 0 1px rgba(255,255,255, 1), 0 0 0 1px rgba(0, 0, 0, 0.3)":this.angleIm.style.boxShadow=""}},{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=!!e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.updateUi()}},{key:"update",value:function(e,t){this.scale=e,this.angleDeg=t,this.isVisible&&this.updateUi()}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),ig=function(){function e(t){var i=this;(0,O._)(this,e),this.rootEl=(0,W.BB).el({css:{margin:"10px"}}),this.isVisible=!0,this.colorDiv=(0,W.BB).el({parent:this.rootEl,css:{marginBottom:"10px"}}),this.colorSlider=t.colorSlider,this.opacitySlider=new ed({label:J("opacity"),width:250,height:30,min:.01,max:1,value:1,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e}}),this.rootEl.append(this.opacitySlider.getElement()),this.toleranceSlider=new ed({label:J("bucket-tolerance"),width:250,height:30,min:0,max:255,value:51,toValue:function(e){return 2.55*e},toDisplayValue:function(e){return e/2.55}}),(0,W.BB).css(this.toleranceSlider.getElement(),{marginTop:"10px"}),this.rootEl.append(this.toleranceSlider.getElement());var n=(0,W.BB).el({parent:this.rootEl,css:{display:"flex",marginTop:"10px"}}),r=(0,W.BB).el({content:J("bucket-sample")+"&nbsp;",title:J("bucket-sample-title"),css:{fontSize:"15px"}});this.modeSelect=new ea({optionArr:[["all",J("bucket-sample-all")],["current",J("bucket-sample-active")],["above",J("bucket-sample-above")]],initValue:"all"}),new W.BB.PointerListener({target:this.modeSelect.getElement(),onWheel:function(e){i.modeSelect.setDeltaValue(e.deltaY)}}),r.append(this.modeSelect.getElement()),n.append(r);var a=(0,W.BB).el({content:J("bucket-grow")+"&nbsp;",title:J("bucket-grow-title"),css:{fontSize:"15px",marginLeft:"10px"}});this.growSelect=new ea({optionArr:[["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"]],initValue:"0"}),new W.BB.PointerListener({target:this.growSelect.getElement(),onWheel:function(e){i.growSelect.setDeltaValue(e.deltaY)}}),a.append(this.growSelect.getElement()),n.append(a),this.isContiguous=!0;var s=new en({init:!0,label:J("bucket-contiguous"),title:J("bucket-contiguous-title"),callback:function(e){i.isContiguous=e},css:{paddingRight:"5px",display:"inline-block",width:"50%"}});this.eraserToggle=new en({init:!1,label:J("eraser"),css:{paddingRight:"5px",display:"inline-block",width:"50%"}}),this.rootEl.append((0,W.BB).el({content:[s.getElement(),this.eraserToggle.getElement()],css:{display:"flex",marginTop:"10px"}}))}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=!!e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.colorDiv.append(this.colorSlider.getElement(),this.colorSlider.getOutputElement())}},{key:"getTolerance",value:function(){return this.toleranceSlider.getValue()}},{key:"getOpacity",value:function(){return this.opacitySlider.getValue()}},{key:"getSample",value:function(){return this.modeSelect.getValue()}},{key:"getGrow",value:function(){return parseInt(this.growSelect.getValue(),10)}},{key:"getContiguous",value:function(){return this.isContiguous}},{key:"getIsEraser",value:function(){return this.eraserToggle.getValue()}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),iv=function(){function e(t){(0,O._)(this,e),this.isVisible=!0,this.rootEl=(0,W.BB).el({css:{margin:"10px"}}),this.colorSlider=t.colorSlider,this.colorDiv=(0,W.BB).el({parent:this.rootEl,css:{marginBottom:"10px"}}),(0,W.BB).el({parent:this.rootEl,content:J("text-instruction")})}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=!!e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.colorDiv.append(this.colorSlider.getElement(),this.colorSlider.getOutputElement())}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),im=function(){function e(t){var i=this;(0,O._)(this,e),this.shape="rect",this.mode="stroke",this.rootEl=(0,W.BB).el({css:{margin:"10px"}}),this.isVisible=!0,this.colorDiv=(0,W.BB).el({parent:this.rootEl,css:{marginBottom:"10px"}}),this.colorSlider=t.colorSlider;var n=(0,W.BB).createSvg({elementType:"rect",x:"8",width:"19"}),r=(0,W.BB).createSvg({elementType:"svg",width:"35",height:"35"});r.classList.add("dark-invert"),r.append(n),(0,W.BB).css(r,{display:"block"});var a=(0,W.BB).createSvg({elementType:"rect",x:"8",width:"19"}),s=(0,W.BB).createSvg({elementType:"svg",width:"35",height:"35"});s.classList.add("dark-invert"),s.append(a),(0,W.BB).css(s,{display:"block"});var o=(0,W.BB).createSvg({elementType:"ellipse",cx:"17.5",cy:"17.5",rx:"9.5"}),l=(0,W.BB).createSvg({elementType:"svg",width:"35",height:"35"});l.classList.add("dark-invert"),l.append(o),(0,W.BB).css(l,{display:"block"});var h=(0,W.BB).createSvg({elementType:"ellipse",cx:"17.5",cy:"17.5",rx:"9.5"}),c=(0,W.BB).createSvg({elementType:"svg",width:"35",height:"35"});c.classList.add("dark-invert"),c.append(h),(0,W.BB).css(c,{display:"block"});var u=(0,W.BB).createSvg({elementType:"line",x1:"8",x2:"27"}),p=(0,W.BB).createSvg({elementType:"svg",width:"35",height:"35"});p.classList.add("dark-invert"),p.append(u),(0,W.BB).css(p,{display:"block"});var d=function(){var e=(0,W.BB).clamp(Math.round(i.lineWidthSlider.getValue()/10),1,10)+"px";(0,W.BB).css(n,{fill:"none",stroke:"black",strokeWidth:e}),(0,W.BB).css(a,{fill:"black",stroke:"none"}),(0,W.BB).css(o,{fill:"none",stroke:"black",strokeWidth:e}),(0,W.BB).css(h,{fill:"black",stroke:"none"}),(0,W.BB).css(u,{fill:"none",stroke:"black",strokeWidth:e}),i.fixedToggle.getValue()?(n.setAttribute("y","8"),n.setAttribute("height","19"),a.setAttribute("y","8"),a.setAttribute("height","19"),o.setAttribute("ry","9.5"),h.setAttribute("ry","9.5")):(n.setAttribute("y","10.8"),n.setAttribute("height","13.399999999999999"),a.setAttribute("y","10.8"),a.setAttribute("height","13.399999999999999"),o.setAttribute("ry","6.699999999999999"),h.setAttribute("ry","6.699999999999999")),i.snapToggle.getValue()?(u.setAttribute("y1","27"),u.setAttribute("y2","8")):(u.setAttribute("y1","24.2"),u.setAttribute("y2","10.8"))},g=(0,W.BB).el({parent:this.rootEl,css:{display:"flex",justifyContent:"space-between",alignItems:"start"}}),f=new eD({optionArr:[{id:"rect-stroke",label:r,title:J("shape-rect")+" "+J("shape-stroke")},{id:"ellipse-stroke",label:l,title:J("shape-ellipse")+" "+J("shape-stroke")},{id:"line",label:p,title:J("shape-line")},{id:"rect-fill",label:s,title:J("shape-rect")+" "+J("shape-fill")},{id:"ellipse-fill",label:c,title:J("shape-ellipse")+" "+J("shape-fill")}],initId:this.shape+" "+this.mode,onChange:function(e){var t=e.split("-");i.shape=t[0],i.mode=t[1],(0,W.BB).css(i.fixedToggle.getElement(),{display:"line"===i.shape?"none":""}),(0,W.BB).css(i.snapToggle.getElement(),{display:"line"===i.shape?"":"none"}),(0,W.BB).css(i.lineWidthSlider.getElement(),{display:"line"!==i.shape&&"fill"===i.mode?"none":""})},changeOnInit:!0});f.getElement().style.width="120px",g.append(f.getElement()),this.eraserToggle=new en({init:!1,label:J("eraser"),callback:function(){d()}}),this.lockAlphaToggle=new en({init:!1,label:J("lock-alpha"),title:J("lock-alpha-title"),doHighlight:!0}),this.lockAlphaToggle.getElement().style.marginTop="10px",g.append((0,W.BB).el({content:[this.eraserToggle.getElement(),this.lockAlphaToggle.getElement()]})),this.lineWidthSlider=new ed({label:J("shape-line-width"),width:250,height:30,min:1,max:200,value:4,curve:"quadratic",onChange:function(){d()}}),(0,W.BB).css(this.lineWidthSlider.getElement(),{marginTop:"10px"}),this.rootEl.append(this.lineWidthSlider.getElement()),this.opacitySlider=new ed({label:J("opacity"),width:250,height:30,min:.01,max:1,value:1,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e}}),(0,W.BB).css(this.opacitySlider.getElement(),{marginTop:"10px"}),this.rootEl.append(this.opacitySlider.getElement());var v=(0,W.BB).el({parent:this.rootEl,css:{display:"flex",alignItems:"center",marginTop:"10px"}});this.outwardsToggle=new en({init:!1,label:J("shape-outwards"),css:{width:"50%",marginRight:"10px"}}),v.append(this.outwardsToggle.getElement()),this.fixedToggle=new en({init:!1,label:J("shape-fixed"),callback:function(){d()},css:{flexGrow:"1"}}),v.append(this.fixedToggle.getElement()),this.snapToggle=new en({init:!1,label:J("angle-snap"),title:J("angle-snap-title"),callback:function(){d()},css:{flexGrow:"1"}}),v.append(this.snapToggle.getElement()),d()}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=!!e,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&(this.colorDiv.append(this.colorSlider.getElement()),this.colorDiv.append(this.colorSlider.getOutputElement()))}},{key:"getShape",value:function(){return this.shape}},{key:"getMode",value:function(){return this.mode}},{key:"getIsEraser",value:function(){return this.eraserToggle.getValue()}},{key:"getOpacity",value:function(){return this.opacitySlider.getValue()}},{key:"getLineWidth",value:function(){return this.lineWidthSlider.getValue()}},{key:"getIsOutwards",value:function(){return this.outwardsToggle.getValue()}},{key:"getIsFixed",value:function(){return this.fixedToggle.getValue()}},{key:"getIsSnap",value:function(){return this.snapToggle.getValue()}},{key:"getDoLockAlpha",value:function(){return this.lockAlphaToggle.getValue()}}]),e}(),W=I("eWjiX"),z=I("bX4ja"),W=I("eWjiX");function iy(e,t){var i=(0,W.BB).el({tagName:"table",className:"kl-table"});return e.forEach(function(e,n){var r=(0,W.BB).el({tagName:"tr"});r.append.apply(r,(0,z._)(e.map(function(e,i){var r=(0,W.BB).el({tagName:"td",content:e}),a=n+"."+i;return void 0!==t&&a in t&&(r.rowSpan=t[a].rowspan),r}))),i.append(r)}),i}var eI=I("1C8RU"),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),ix={};ix=I("f6OTe").getBundleURL("lYbF2")+"ui-collapse.2b5dfc6a.svg";var ib=function(){function e(i){var n=this;(0,O._)(this,e),this.stateIsOpen=!0,this.directionStr="right",this.rootEl=(0,W.BB).el({className:"kl-toolspace-toggle",css:{width:"36px",height:"36px",background:"rgba(100, 100, 100, 0.9)",color:"#fff",position:"absolute",top:"0",textAlign:"center",lineHeight:"36px",cursor:"pointer",userSelect:"none",padding:"6px",boxSizing:"border-box"},title:J("toggle-show-tools"),onClick:function(e){e.preventDefault(),n.stateIsOpen=!n.stateIsOpen,n.update(),i.onChange()}}),this.icon=(0,W.BB).el({parent:this.rootEl,css:{backgroundImage:"url(".concat(t(ix),")"),width:"100%",height:"100%",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center",userSelect:"none"}}),this.rootEl.oncontextmenu=function(){return!1}}return(0,D._)(e,[{key:"update",value:function(){"left"===this.directionStr?this.icon.style.transform=this.stateIsOpen?"rotate(180deg)":"":this.icon.style.transform=this.stateIsOpen?"":"rotate(180deg)"}},{key:"isOpen",value:function(){return this.stateIsOpen}},{key:"setDirection",value:function(e){this.directionStr=e,this.update()}},{key:"getElement",value:function(){return this.rootEl}}]),e}(),X=I("cL71g"),eR=I("4EWN2"),W=I("eWjiX"),O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),eR=I("4EWN2"),_=I("7jh4K"),iB=function(){function e(t){var i=this;(0,O._)(this,e);var n=function(){t.onUpdate(i.getValues())},r=[null,t.fill?(0,eR._)((0,X._)({},t.fill.color),{a:1}):null,(0,eR._)((0,X._)({},t.primaryColor),{a:1}),(0,eR._)((0,X._)({},t.secondaryColor),{a:1}),{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];this.colorOptions=new eO({colorArr:r,initialIndex:t.fill?1:0,title:J("shape-fill"),onChange:function(e){i.opacitySlider.getElement().style.display=null!==e?"":"none",n()}}),this.opacitySlider=new ed({label:J("opacity"),width:150,height:30,min:.01,max:1,value:t.fill?t.fill.color.a:1,resolution:225,eventResMs:1e3/30,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e},onChange:function(){return n()}}),this.opacitySlider.getElement().style.display=t.fill?"":"none";var a=(0,_.createSvg)({elementType:"svg",class:"dark-invert",width:"25px",height:"25px",viewBox:"0 0 30 30",childrenArr:[{elementType:"polyline",points:"0,0 30,0 30,8 19,8 19,30 11,30 11,8 0,8 0,0 1,0","transform-origin":"15px 15px",transform:"scale(0.8)",fill:"#000c"}]});this.rootEl=ev(",flex,gap-10,items-center,flexWrap,minh-30",[a,this.colorOptions.getElement(),this.opacitySlider.getElement()])}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"getValues",value:function(){var e=this.colorOptions.getValue();return null===e||(null==e?void 0:e.a)===0?{fill:void 0}:{fill:{color:(0,eR._)((0,X._)({},e),{a:this.opacitySlider.getValue()})}}}},{key:"destroy",value:function(){this.colorOptions.destroy(),this.opacitySlider.destroy()}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),z=I("bX4ja"),W=I("eWjiX"),er=I("dJPtW"),iw={};iw=I("f6OTe").getBundleURL("lYbF2")+"align-left.4876a845.svg";var ik={};ik=I("f6OTe").getBundleURL("lYbF2")+"align-center.6f56d4bd.svg";var iC={};iC=I("f6OTe").getBundleURL("lYbF2")+"align-right.1521d61c.svg";var iS={};iS=I("f6OTe").getBundleURL("lYbF2")+"typo-italic.7ab32910.svg";var iE={};iE=I("f6OTe").getBundleURL("lYbF2")+"typo-bold.5c790c89.svg";var iI={};iI=I("f6OTe").getBundleURL("lYbF2")+"Caveat-Regular.2fe80bbd.woff2";var iA={};iA=I("f6OTe").getBundleURL("lYbF2")+"ClimateCrisis-Regular-VariableFont_YEAR.3ad02523.woff2";var iT={};iT=I("f6OTe").getBundleURL("lYbF2")+"CorrectionBrush.a69973aa.woff2";var iM={};iM=I("f6OTe").getBundleURL("lYbF2")+"DancingScript-Regular.ef2fe647.woff2";var iL={};iL=I("f6OTe").getBundleURL("lYbF2")+"Diabolik-Regular-VF.f4eeb79e.woff2";var iR={};iR=I("f6OTe").getBundleURL("lYbF2")+"FreckleFace-Regular.05946539.woff2";var iP={};iP=I("f6OTe").getBundleURL("lYbF2")+"Gloock-Regular.60f8f765.woff2";var iO={};iO=I("f6OTe").getBundleURL("lYbF2")+"Pacha.08c8457a.woff2";var iD={};iD=I("f6OTe").getBundleURL("lYbF2")+"GochiHand-Regular.c45792b0.woff2";var iz={};iz=I("f6OTe").getBundleURL("lYbF2")+"PassionOne-Bold.9e08b0dc.woff2";var i_={};i_=I("f6OTe").getBundleURL("lYbF2")+"PixeloidSans.bc292131.woff2";var ij={};ij=I("f6OTe").getBundleURL("lYbF2")+"PlaypenSans-Thin.314b29a4.woff2";var iF={};iF=I("f6OTe").getBundleURL("lYbF2")+"Quicksand-Light.1f0c44a2.woff2";var iV={};iV=I("f6OTe").getBundleURL("lYbF2")+"Silkscreen-Regular.cef2b4cb.woff2";var iH={};iH=I("f6OTe").getBundleURL("lYbF2")+"Tehroc-Regular.4540047b.woff2";var iW={};iW=I("f6OTe").getBundleURL("lYbF2")+"YUNGA-Display.30c04a15.woff2";var iX=[{name:"Caveat",url:t(iI)},{name:"ClimateCrisis",url:t(iA)},{name:"CorrectionBrush",url:t(iT)},{name:"DancingScript",url:t(iM)},{name:"Diabolik",url:t(iL)},{name:"FreckleFace",url:t(iR)},{name:"Gloock",url:t(iP)},{name:"GochiHand",url:t(iD)},{name:"Pacha",url:t(iO)},{name:"PassionOne",url:t(iz)},{name:"PixeloidSans",url:t(i_)},{name:"PlaypenSans",url:t(ij)},{name:"Quicksand",url:t(iF)},{name:"Silkscreen",url:t(iV)},{name:"Tehroc",url:t(iH)},{name:"YUNGA",url:t(iW)}],iN=[{fontFamily:"sans-serif",fontName:"Sans-serif"},{fontFamily:"serif",fontName:"Serif"},{fontFamily:"monospace",fontName:"Monospace"},{fontFamily:"cursive",fontName:"Cursive"},{fontFamily:"fantasy",fontName:"Fantasy"}].concat((0,z._)(iX.map(function(e){return{fontFamily:e.name,fontName:e.name}}))),iY=!1;function iU(){return(iU=M(function(){var e,t,i;return R(this,function(n){switch(n.label){case 0:if(e=function(e){t.push(M(function(){var t,i,n;return R(this,function(r){switch(r.label){case 0:return[4,fetch((t=iX[e]).url)];case 1:return[4,r.sent().arrayBuffer()];case 2:return i=r.sent(),n=new FontFace(t.name,i),document.fonts.add(n),[2]}})})())},iY)return[2];for(i=0,iY=!0,t=[];i<iX.length;i++)e(i);return[4,Promise.all(t)];case 1:return n.sent(),[2]}})})).apply(this,arguments)}var iG=function(){function e(i){var n,r,a=this;(0,O._)(this,e),this.onUpdate=i.onUpdate,this.fontSelect=new ea({initValue:i.font,optionArr:iN.map(function(e){return[e.fontFamily,e.fontName,{css:{fontFamily:e.fontFamily,fontSize:"1.2em"}}]}),isFocusable:!0,css:{width:"180px"},onChange:function(e){a.loadBundledFonts(),i.onUpdate({font:e})}}),this.onFocus=function(){return a.loadBundledFonts()},this.fontSelect.getElement().addEventListener("focus",this.onFocus),this.fontPointerListener=new W.BB.PointerListener({target:this.fontSelect.getElement(),onWheel:function(e){return a.fontSelect.setDeltaValue(e.deltaY)}}),this.importButton=(0,W.BB).el({tagName:"button",content:J("file-import"),onClick:function(){a.importFont()}});var s=(0,W.BB).el({content:'<div><span style="font-size: 0.6em; margin-right: -1px">A</span>A</div>',css:{width:"25px",height:"25px",display:"flex",justifyContent:"center",alignItems:"center",fontSize:"1.2em",userSelect:"none"}});this.sizeInput=new er.Input({title:J("text-size"),type:"number",min:0,max:1e3,init:i.size,onChange:function(e){i.onUpdate({size:parseFloat(e)})},doResetIfInvalid:!0,doScrollWithoutFocus:!0,css:{width:"70px"}}),this.lineHeightInput=new er.Input({label:J("text-line-height"),type:"number",min:0,max:10,step:.1,init:null!==(n=i.lineHeight)&&void 0!==n?n:1,onChange:function(e){i.onUpdate({lineHeight:parseFloat(e)})},doResetIfInvalid:!0,doScrollWithoutFocus:!0,css:{width:"60px"}}),this.letterSpacingInput=new er.Input({label:J("text-letter-spacing"),type:"number",min:-100,max:100,init:null!==(r=i.letterSpacing)&&void 0!==r?r:0,onChange:function(e){i.onUpdate({letterSpacing:parseFloat(e)})},doResetIfInvalid:!0,doScrollWithoutFocus:!0,css:{width:"60px"}}),this.alignRadioList=new eo({optionArr:[{id:"left",title:J("text-left"),image:t(iw),darkInvert:!0},{id:"center",title:J("text-center"),image:t(ik),darkInvert:!0},{id:"right",title:J("text-right"),image:t(iC),darkInvert:!0}],initId:i.align,onChange:function(e){return i.onUpdate({align:e})}}),this.italicToggle=new es({image:t(iS),title:J("text-italic"),initValue:i.isItalic,onChange:function(e){return i.onUpdate({isItalic:e})},darkInvert:!0}),this.boldToggle=new es({image:t(iE),title:J("text-bold"),initValue:i.isBold,onChange:function(e){return i.onUpdate({isBold:e})},darkInvert:!0}),this.rootEl=ev(",flex,flexWrap,gap-10-15,items-center",[ev(",flex,gap-5,items-center",[s,this.sizeInput.getElement()]),ev(",flex,gap-5",[this.fontSelect.getElement(),this.importButton]),ev(",flex,gap-7",[this.alignRadioList.getElement(),this.italicToggle.getElement(),this.boldToggle.getElement()]),this.letterSpacingInput.getElement(),this.lineHeightInput.getElement()])}return(0,D._)(e,[{key:"loadBundledFonts",value:function(){var e=this;iY||(function(){return iU.apply(this,arguments)})().then(function(){e.onUpdate({font:e.fontSelect.getValue()})})}},{key:"importFont",value:function(){var e=document.createElement("input");e.type="file",e.multiple=!0,e.accept=".ttf, .otf, .woff, .woff2, .eot",e.focus(),e.click();var t=this;e.onchange=M(function(){var i,n,r,a,s,o,l,h,c;return R(this,function(u){switch(u.label){case 0:if(!e.files||0===e.files.length)return[2];i=void 0,n=iN.map(function(e){return e.fontFamily}),r=0,u.label=1;case 1:if(!(r<e.files.length))return[3,4];if(a=e.files[r],s="kl-"+iN.length,n.includes(s))return[3,3];return i||(i=s,t.importButton.disabled=!0,t.importButton.innerText=J("loading")),(o=a.name.split(".")).pop(),iN.push({fontFamily:s,fontName:o.join(".")}),h=FontFace.bind,c=[void 0,s],[4,a.arrayBuffer()];case 2:l=new(h.apply(FontFace,c.concat([u.sent()]))),document.fonts.add(l),u.label=3;case 3:return r++,[3,1];case 4:return setTimeout(function(){t.fontSelect.setOptionArr(iN.map(function(e){return[e.fontFamily,e.fontName,{css:{fontFamily:e.fontFamily,fontSize:"1.2em"}}]})),t.fontSelect.setValue(i),t.onUpdate({font:i}),t.importButton.disabled=!1,t.importButton.innerText=J("file-import")}),[2]}})})}},{key:"getElement",value:function(){return this.rootEl}},{key:"getValues",value:function(){return{font:this.fontSelect.getValue(),size:+this.sizeInput.getValue(),letterSpacing:+this.letterSpacingInput.getValue(),lineHeight:+this.lineHeightInput.getValue(),align:this.alignRadioList.getValue(),isItalic:this.italicToggle.getValue(),isBold:this.boldToggle.getValue()}}},{key:"destroy",value:function(){this.fontPointerListener.destroy(),this.fontSelect.getElement().removeEventListener("focus",this.onFocus),this.fontSelect.destroy(),(0,W.BB).destroyEl(this.importButton),this.sizeInput.destroy(),this.lineHeightInput.destroy(),this.letterSpacingInput.destroy(),this.alignRadioList.destroy(),this.italicToggle.destroy(),this.boldToggle.destroy()}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),eR=I("4EWN2"),W=I("eWjiX"),_=I("7jh4K"),iK=function(){function e(t){var i=this;(0,O._)(this,e),this.rootEl=(0,W.BB).el({css:{boxShadow:"0 0 0 1px #aaa"}});var n=function(){t.onUpdate(i.getValues())},r=[null,t.stroke?(0,eR._)((0,X._)({},t.stroke.color),{a:1}):null,(0,eR._)((0,X._)({},t.secondaryColor),{a:1}),(0,eR._)((0,X._)({},t.primaryColor),{a:1}),{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1}];this.colorOptions=new eO({colorArr:r,initialIndex:t.stroke?1:0,title:J("shape-stroke"),onChange:function(e){i.opacitySlider.getElement().style.display=null!==e?"":"none",i.lineWidthSlider.getElement().style.display=null!==e?"":"none",n()}}),this.opacitySlider=new ed({label:J("opacity"),width:150,height:30,min:.01,max:1,value:t.stroke?t.stroke.color.a:1,resolution:225,eventResMs:1e3/30,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e},onChange:function(){return n()}}),this.lineWidthSlider=new ed({label:J("shape-line-width"),width:150,height:30,min:.5,max:100,value:t.stroke?t.stroke.lineWidth:2,eventResMs:1e3/30,curve:"quadratic",onChange:function(){return n()}}),this.opacitySlider.getElement().style.display=t.stroke?"":"none",this.lineWidthSlider.getElement().style.display=t.stroke?"":"none";var a=(0,_.createSvg)({elementType:"svg",class:"dark-invert",width:"25px",height:"25px",viewBox:"0 0 30 30",childrenArr:[{elementType:"polyline",points:"0,0 30,0 30,8 19,8 19,30 11,30 11,8 0,8 0,0 1,0",fill:"none",stroke:"#000c","stroke-width":"3","transform-origin":"15px 15px",transform:"scale(0.8)"}]});this.rootEl=ev(",flex,gap-10,items-center,flexWrap,minh-30",[a,this.colorOptions.getElement(),this.opacitySlider.getElement(),this.lineWidthSlider.getElement()])}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"getValues",value:function(){var e=this.colorOptions.getValue();return null===e||(null==e?void 0:e.a)===0?{stroke:void 0}:{stroke:{color:(0,eR._)((0,X._)({},e),{a:this.opacitySlider.getValue()}),lineWidth:this.lineWidthSlider.getValue()}}}},{key:"destroy",value:function(){this.colorOptions.destroy(),this.opacitySlider.destroy(),this.lineWidthSlider.destroy()}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),iq=function(){function e(t){var i=this;(0,O._)(this,e),this.onInput=function(){i.emit()},this.lastEmittedText=t.text,this.onUpdate=t.onUpdate,this.rootEl=ev(""),this.textInput=(0,W.BB).el({tagName:"textarea",parent:this.rootEl,content:t.text,custom:{placeholder:J("text-placeholder")},css:{whiteSpace:"pre",overflow:"auto",width:"100%",height:"70px",resize:"vertical"},onChange:function(){i.emit()}}),this.textInput.addEventListener("input",this.onInput)}return(0,D._)(e,[{key:"emit",value:function(){var e=this.textInput.value;e!==this.lastEmittedText&&(this.lastEmittedText=e,this.onUpdate({text:e}))}},{key:"getElement",value:function(){return this.rootEl}},{key:"getValues",value:function(){return{text:this.textInput.value}}},{key:"focus",value:function(){this.textInput.focus()}},{key:"destroy",value:function(){(0,W.BB).destroyEl(this.textInput),this.textInput.removeEventListener("input",this.onInput)}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),eR=I("4EWN2"),W=I("eWjiX"),_=I("7jh4K"),eI=I("1C8RU"),iQ=function(){function e(i){var n=this;(0,O._)(this,e),this.offset={x:0,y:0},this.zoomFac=0,this.scale=1,this.layerArr=[],this.onDarkChange=function(){n.checkerPattern=(0,_.throwIfNull)(n.previewCtx.createPattern((0,W.BB).createCheckerCanvas(8,(0,eI.theme).isDark()),"repeat")),n.render()},this.rootEl=ev(),this.text=i.text,this.layerIndex=i.layerIndex;var r=window.innerWidth<550,a=window.innerHeight<630;this.width=r?340:540,this.height=r?a?210:260:a?230:350,this.layerArr=i.klCanvas.getLayersFast(),this.textCanvas=(0,W.BB).canvas(i.klCanvas.getWidth(),i.klCanvas.getHeight()),this.textCtx=(0,W.BB).ctx(this.textCanvas),this.targetCanvas=(0,W.BB).canvas(this.width,this.height),this.targetCtx=(0,W.BB).ctx(this.targetCanvas),this.layersCanvas=(0,W.BB).canvas(this.width,this.height),this.layersCtx=(0,W.BB).ctx(this.layersCanvas),this.previewCanvas=(0,W.BB).canvas(this.width,this.height),this.previewCtx=(0,W.BB).ctx(this.previewCanvas),(0,W.BB).css(this.previewCanvas,{display:"block"}),this.previewWrapper=(0,W.BB).el({parent:this.rootEl,css:{position:"relative",width:this.width+"px",cursor:"move",touchAction:"none"}}),(0,W.BB).el({parent:this.previewWrapper,className:"kl-text-preview-wrapper"}),this.previewWrapper.append(this.previewCanvas),this.checkerPattern=(0,_.throwIfNull)(this.previewCtx.createPattern((0,W.BB).createCheckerCanvas(8,(0,eI.theme).isDark()),"repeat")),this.emptyCanvas=(0,W.BB).canvas(1,1),this.emptyCanvasLight=(0,W.BB).canvas(1,1);var s=(0,W.BB).ctx(this.emptyCanvas);s.fillRect(0,0,1,1),(s=(0,W.BB).ctx(this.emptyCanvasLight)).fillStyle="#fff",s.fillRect(0,0,1,1),(0,eI.theme).addIsDarkListener(this.onDarkChange),this.previewCanvas.oncontextmenu=function(e){return e.preventDefault()};var o=!1,l=!1,h=!1;this.previewPointerListener=new W.BB.PointerListener({target:this.previewCanvas,onPointer:function(e){if("pointerdown"===e.type&&(o=!1,l=!0),"pointermove"===e.type&&l&&(o=!0),"pointerup"===e.type&&(l&&o&&"mouse"===e.pointerType&&i.onDragEnd(),o=!1,l=!1),"pointermove"===e.type&&"left"===e.button&&(e.eventPreventDefault(),n.offset={x:0,y:0},n.move(-e.dX,-e.dY)),"pointerdown"===e.type&&"right"===e.button&&document.body.append(n.eventCapture),"pointerup"===e.type&&setTimeout(function(){return n.eventCapture.remove()},20),"pointermove"===e.type&&"right"===e.button&&(h=!0,e.eventPreventDefault(),n.offset.x-=e.dX,n.offset.y-=e.dY,n.render()),"pointerup"===e.type&&h){var t=0;n.interval=setInterval(function(){t>8&&(clearInterval(n.interval),n.offset={x:0,y:0},n.render()),n.offset={x:.6*n.offset.x,y:.6*n.offset.y},n.render(),t++},10),n.offset={x:.6*n.offset.x,y:.6*n.offset.y},n.render()}},onWheel:function(e){n.changeZoomFac(-e.deltaY)}}),this.previewCanvas.addEventListener("wheel",function(e){return e.preventDefault()}),this.rotationSlider=new ed({label:J("filter-transform-rotation"),width:150,height:30,min:-Math.PI,max:Math.PI,value:i.text.angleRad,resolution:225,toValue:function(e){return e*Math.PI/180},toDisplayValue:function(e){return e/Math.PI*180},onChange:function(){n.offset={x:0,y:0},n.render()},unit:""}),this.zoomInBtn=(0,W.BB).el({tagName:"button",content:'<img height="20" src="'.concat(t(e3),'">'),title:J("zoom-in"),onClick:function(){return n.changeZoomFac(1)},css:{fontWeight:"bold"}}),this.zoomOutBtn=(0,W.BB).el({tagName:"button",content:'<img height="20" src="'.concat(t(e4),'">'),title:J("zoom-out"),onClick:function(){return n.changeZoomFac(-1)},css:{fontWeight:"bold"}}),this.eventCapture=(0,W.BB).el({css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",zIndex:"999",cursor:"move"}}),this.eventCapture.oncontextmenu=function(e){return e.preventDefault()},this.keyListener=new W.BB.KeyListener({onDown:function(e){if(!(0,W.BB).isInputFocused(!0)){var t=n.keyListener.isPressed("shift")?4:1;"left"===e&&n.move(-t,0),"right"===e&&n.move(t,0),"up"===e&&n.move(0,-t),"down"===e&&n.move(0,t)}}}),this.inputsRootEl=ev(",flex,gap-5",[this.rotationSlider.getElement(),ev(),this.zoomInBtn,this.zoomOutBtn])}return(0,D._)(e,[{key:"canZoom",value:function(e){return this.zoomFac!==Math.min(2,Math.max(-2,this.zoomFac+e))}},{key:"changeZoomFac",value:function(e){this.zoomFac=Math.min(2,Math.max(-2,this.zoomFac+e)),this.render(),this.zoomInBtn.disabled=!this.canZoom(1),this.zoomOutBtn.disabled=!this.canZoom(-1)}},{key:"move",value:function(e,t){var i=(0,W.BB).rotate(e,t,-this.rotationSlider.getValue()/Math.PI*180);this.text.x+=i.x/this.scale,this.text.y+=i.y/this.scale,this.render()}},{key:"render",value:function(){var e=this.rotationSlider.getValue();this.textCtx.clearRect(0,0,this.textCanvas.width,this.textCanvas.height);var t=tv(this.textCanvas,(0,eR._)((0,X._)({},this.text),{x:this.text.x,y:this.text.y,angleRad:this.rotationSlider.getValue()})),i=(0,W.BB).Vec2.mul((0,W.BB).rotate(this.offset.x,this.offset.y,-e/Math.PI*180),1/this.scale);t.width=Math.max(t.width,1),t.height=Math.max(t.height,1);var n=(0,W.BB).rotate(t.x,t.y,-e/Math.PI*180),r=(0,W.BB).rotate(t.width,t.height,-e/Math.PI*180),a=this.text.x+n.x+r.x/2+i.x,s=this.text.y+n.y+r.y/2+i.y,o=(0,W.BB).fitInto(t.width,t.height,this.width-100,this.height-100);this.scale=Math.min(1,o.width/t.width),this.scale=Math.min(4,this.scale*Math.pow(2,this.zoomFac)),this.targetCtx.save(),this.scale>=4?this.targetCtx.imageSmoothingEnabled=!1:(this.targetCtx.imageSmoothingEnabled=!0,this.targetCtx.imageSmoothingQuality=this.scale>=1?"low":"medium"),this.targetCtx.clearRect(0,0,this.previewCanvas.width,this.previewCanvas.height),this.targetCtx.translate(this.width/2,this.height/2),this.targetCtx.scale(this.scale,this.scale),this.targetCtx.rotate(e),this.targetCtx.drawImage(this.layerArr[this.layerIndex].canvas,-a,-s),this.targetCtx.drawImage(this.textCanvas,-a,-s),this.targetCtx.restore();var l=(0,eI.theme).isDark();this.layersCtx.save(),this.layersCtx.fillStyle=l?"rgb(33,33,33)":"rgb(158,158,158)",this.layersCtx.fillRect(0,0,this.width,this.height),this.layersCtx.save(),this.layersCtx.translate(this.width/2,this.height/2),this.layersCtx.scale(this.scale,this.scale),this.layersCtx.rotate(e),this.layersCtx.imageSmoothingEnabled=!1;var h=1/this.scale;this.layersCtx.globalAlpha=l?.25:.2,this.layersCtx.drawImage(l?this.emptyCanvasLight:this.emptyCanvas,-a-h,-s-h,this.textCanvas.width+2*h,this.textCanvas.height+2*h),this.layersCtx.globalAlpha=1,this.layersCtx.globalCompositeOperation="destination-out",this.layersCtx.drawImage(this.emptyCanvas,-a,-s,this.textCanvas.width,this.textCanvas.height),this.layersCtx.restore(),this.scale>=4?this.layersCtx.imageSmoothingEnabled=!1:(this.layersCtx.imageSmoothingEnabled=!0,this.layersCtx.imageSmoothingQuality=this.scale>=1?"low":"medium"),this.layersCtx.save(),this.layersCtx.translate(this.width/2,this.height/2),this.layersCtx.scale(this.scale,this.scale),this.layersCtx.rotate(e);for(var c=0;c<this.layerIndex;c++)this.layerArr[c].isVisible&&this.layerArr[c].opacity>0&&(this.layersCtx.globalAlpha=this.layerArr[c].opacity,this.layersCtx.globalCompositeOperation=this.layerArr[c].mixModeStr,this.layersCtx.drawImage(this.layerArr[c].canvas,-a,-s));this.layersCtx.restore(),this.layersCtx.globalAlpha=this.layerArr[this.layerIndex].opacity*(this.layerArr[this.layerIndex].isVisible?1:0),this.layersCtx.globalCompositeOperation=this.layerArr[this.layerIndex].mixModeStr,this.layersCtx.drawImage(this.targetCanvas,0,0),this.layersCtx.save(),this.layersCtx.translate(this.width/2,this.height/2),this.layersCtx.scale(this.scale,this.scale),this.layersCtx.rotate(e);for(var u=this.layerIndex+1;u<this.layerArr.length;u++)this.layerArr[u].isVisible&&this.layerArr[u].opacity>0&&(this.layersCtx.globalAlpha=this.layerArr[u].opacity,this.layersCtx.globalCompositeOperation=this.layerArr[u].mixModeStr,this.layersCtx.drawImage(this.layerArr[u].canvas,-a,-s));this.layersCtx.restore(),this.layersCtx.restore(),this.previewCtx.save(),this.previewCtx.fillStyle=this.checkerPattern,this.previewCtx.fillRect(0,0,this.previewCanvas.width,this.previewCanvas.height),this.previewCtx.drawImage(this.layersCanvas,0,0),this.previewCtx.restore(),this.previewCtx.save(),this.previewCtx.globalCompositeOperation="difference",this.previewCtx.strokeStyle="#fff",this.previewCtx.lineWidth=.5,this.previewCtx.translate(-this.offset.x,-this.offset.y),this.previewCtx.strokeRect(Math.round(this.width/2-t.width/2*this.scale)+.5,Math.round(this.height/2-t.height/2*this.scale)+.5,Math.round(t.width*this.scale),Math.round(t.height*this.scale)),this.previewCtx.restore()}},{key:"getElement",value:function(){return this.rootEl}},{key:"getInputsElement",value:function(){return this.inputsRootEl}},{key:"getValues",value:function(){return{x:this.text.x,y:this.text.y,angleRad:this.rotationSlider.getValue()}}},{key:"setText",value:function(e){var t=this.text.x,i=this.text.y,n=this.text.angleRad;this.text=(0,eR._)((0,X._)({},e),{x:t,y:i,angleRad:n}),this.render()}},{key:"setSize",value:function(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.targetCanvas.width=this.width,this.targetCanvas.height=this.height,this.layersCanvas.width=this.width,this.layersCanvas.height=this.height,this.previewCanvas.width=this.width,this.previewCanvas.height=this.height,this.previewWrapper.style.width=this.width+"px",this.render())}},{key:"destroy",value:function(){(0,W.BB).destroyEl(this.rootEl),(0,W.BB).destroyEl(this.inputsRootEl),(0,W.BB).destroyEl(this.previewWrapper),clearInterval(this.interval),this.rotationSlider.destroy(),(0,W.BB).destroyEl(this.zoomInBtn),(0,W.BB).destroyEl(this.zoomOutBtn),this.eventCapture.remove(),this.previewPointerListener.destroy(),this.keyListener.destroy(),(0,eI.theme).removeIsDarkListener(this.onDarkChange)}}]),e}();y="_5vlQAW_viewportWrapper";var W=I("eWjiX"),iZ={};e(iZ,"blendPsdToKl",function(){return i0}),e(iZ,"blendKlToPsd",function(){return i1}),e(iZ,"readPsd",function(){return i2}),e(iZ,"klPsdToKlProject",function(){return i5});var iJ=I("eelgW"),W=I("eWjiX"),_=I("7jh4K");function i$(){x||(b=Object.fromEntries(Object.entries(x={"source-over":"normal",darken:"darken",multiply:"multiply","color-burn":"color burn",lighten:"lighten",screen:"screen","color-dodge":"color dodge",overlay:"overlay","soft-light":"soft light","hard-light":"hard light",difference:"difference",exclusion:"exclusion",hue:"hue",saturation:"saturation",color:"color",luminosity:"luminosity"}).map(function(e){return e.reverse()})))}function i0(e){return i$(),b[e]}function i1(e){return i$(),x[e]}function i2(e){if(!e.canvas)throw Error("psdObj.canvas undefined");var t,i={type:"psd",canvas:e.canvas,width:e.width,height:e.height};function n(e){i.warningArr||(i.warningArr=[]),i.warningArr.includes(e)||i.warningArr.push(e)}function r(e){var t=i0(e);return t||(n("blend-mode"),t="source-over"),t}if(8!==e.bitsPerChannel&&n("bits-per-channel"),!e.children||0+function e(t){var i=0;if(t.blendMode){var r=i0(t.blendMode);if(r&&"source-over"!==r)return 1}if(t.children)for(var a=0;a<t.children.length;a++){var s=t.children[a];!s.clipping&&!s.adjustment&&(s.children?(n("group"),i+=e(s)):i++)}return i}(e)>16)return i.error=!0,i;function a(e,t){var i=(0,W.BB).ctx(e),n=i.getImageData(0,0,e.width,e.height);if(0===t)for(var r=0;r<n.data.length;r+=4)n.data[r+3]=n.data[r];else for(var a=0;a<n.data.length;a+=4)n.data[a+3]=255-n.data[a];i.putImageData(n,0,0)}return i.layers=[],i.layers=function e(t){var s,o,l=[],h=!t.hidden,c=(0,_.throwIfUndefined)(t.opacity,"groupOpacity is undefined"),u=r(t.blendMode);if("source-over"!==u&&(s=(0,iJ.createCanvas)(i.width,i.height),o=(0,W.BB).ctx(s)),t.mask&&(n("mask"),a(t.mask.canvas,t.mask.defaultColor)),t.children)for(var p=0;p<t.children.length;p++){var d=t.children[p];if(!d.clipping){if(d.adjustment){n("adjustment");continue}var g=(d.children||d.canvas)&&t.children[p+1]&&t.children[p+1].clipping;if(g&&n("clipping"),d.children){for(var f=e(d),v=0;v<f.length;v++){var m=f[v],y=(0,W.BB).ctx(m.image);if(g){var x=(0,iJ.createCanvas)(i.width,i.height),b=(0,W.BB).ctx(x);b.drawImage(m.image,0,0);for(var B=p+1;B<t.children.length&&t.children[B].clipping;B++){var w=t.children[B];if(0!==w.opacity&&!w.hidden){if(void 0===w.blendMode)throw Error("clippingItem.blendMode undefined");if(void 0===w.opacity)throw Error("clippingItem.opacity undefined");if(void 0===w.canvas)throw Error("clippingItem.canvas undefined");if(void 0===w.left)throw Error("clippingItem.left undefined");if(void 0===w.top)throw Error("clippingItem.top undefined");b.globalCompositeOperation=r(w.blendMode),b.globalAlpha=w.opacity,b.drawImage(w.canvas,w.left,w.top)}}y.globalCompositeOperation="source-atop",y.drawImage(x,0,0)}if(t.mask){if(y.globalCompositeOperation=0===t.mask.defaultColor?"destination-in":"destination-out",void 0===t.mask.canvas)throw Error("psdGroupObj.mask.canvas undefined");if(void 0===t.mask.left)throw Error("psdGroupObj.mask.left undefined");if(void 0===t.mask.top)throw Error("psdGroupObj.mask.top undefined");y.drawImage(t.mask.canvas,t.mask.left,t.mask.top)}if(s){if(void 0===o)throw Error("groupCtx undefined");o.globalCompositeOperation=m.mixModeStr,o.globalAlpha=m.opacity,o.drawImage(m.image,0,0)}else m.opacity=m.opacity*c,l.push(m)}continue}var k=(0,iJ.createCanvas)(i.width,i.height),C=(0,W.BB).ctx(k);if(d.canvas){if(void 0===d.top)throw Error("item.top undefined");if(void 0===d.left)throw Error("item.left undefined");C.drawImage(d.canvas,d.left,d.top)}if(d.effects&&n("layer-effect"),d.mask){if(n("mask"),void 0===d.mask.canvas)throw Error("item.mask.canvas undefined");if(void 0===d.mask.defaultColor)throw Error("item.mask.defaultColor undefined");if(void 0===d.mask.left)throw Error("item.mask.left undefined");if(void 0===d.mask.top)throw Error("item.mask.top undefined");a(d.mask.canvas,d.mask.defaultColor),C.globalCompositeOperation=0===d.mask.defaultColor?"destination-in":"destination-out",C.drawImage(d.mask.canvas,d.mask.left,d.mask.top)}if(g){if(void 0===d.right)throw Error("item.right undefined");if(void 0===d.left)throw Error("item.left undefined");if(void 0===d.bottom)throw Error("item.bottom undefined");if(void 0===d.top)throw Error("item.top undefined");if(void 0===d.canvas)throw Error("item.canvas undefined");var S=(0,iJ.createCanvas)(d.right-d.left,d.bottom-d.top),E=(0,W.BB).ctx(S);E.drawImage(d.canvas,0,0);for(var I=p+1;I<t.children.length&&t.children[I].clipping;I++){var A=t.children[I];if(0!==A.opacity&&!A.hidden){if(void 0===A.blendMode)throw Error("clippingItem.blendMode undefined");if(void 0===A.opacity)throw Error("clippingItem.opacity undefined");if(void 0===A.canvas)throw Error("clippingItem.canvas undefined");if(void 0===A.left)throw Error("clippingItem.left undefined");if(void 0===A.top)throw Error("clippingItem.top undefined");E.globalCompositeOperation=r(A.blendMode),E.globalAlpha=A.opacity,E.drawImage(A.canvas,A.left-d.left,A.top-d.top)}}C.globalCompositeOperation="source-atop",C.drawImage(S,d.left,d.top)}if(t.mask){if(C.globalCompositeOperation=0===t.mask.defaultColor?"destination-in":"destination-out",void 0===t.mask.canvas)throw Error("psdGroupObj.mask.canvas undefined");if(void 0===t.mask.left)throw Error("psdGroupObj.mask.left undefined");if(void 0===t.mask.top)throw Error("psdGroupObj.mask.top undefined");C.drawImage(t.mask.canvas,t.mask.left,t.mask.top)}if(void 0===d.blendMode)throw Error("item.blendMode undefined");if(void 0===d.hidden)throw Error("item.hidden  undefined");if(void 0===d.opacity)throw Error("item.opacity undefined");if(s&&o)c>0&&(o.globalCompositeOperation=r(d.blendMode),o.globalAlpha=d.hidden?0:d.opacity,o.drawImage(k,0,0));else{if(void 0===d.name)throw Error("item.name undefined");l.push({name:d.name,isVisible:!d.hidden&&h,opacity:d.opacity*c,mixModeStr:r(d.blendMode),image:k})}}}if(s){if(void 0===t.name)throw Error("psdGroupObj.name undefined");l=[{name:t.name,isVisible:h,opacity:c,mixModeStr:u,image:s}]}return l}({name:"root",opacity:1,blendMode:"normal",children:e.children}),i}function i5(e){var t={width:e.width,height:e.height,layers:[]};return e.layers?t.layers=e.layers.map(function(e){return{name:e.name,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr,image:e.image}}):t.layers=[{name:J("background"),isVisible:!0,opacity:1,mixModeStr:"source-over",image:e.canvas}],t}var i3={};e(i3,"setDbName",function(){return i8}),e(i3,"getKlProjectObj",function(){return ne}),e(i3,"storeKlProjectObj",function(){return nt}),e(i3,"clear",function(){return ni});var i4=!!window.indexedDB,i6="Klecks",i7="ProjectStore";function i8(e){i6=""+e}function i9(e,t,i){var n,r=!1;function a(e){r||(r=!0,i(e))}if(!i4){setTimeout(function(){a("no indexed db available")},0);return}try{n=window.indexedDB.open(i6,1)}catch(e){a(e.message);return}n.onupgradeneeded=function(){try{n.result.createObjectStore(i7,{keyPath:"id"}).createIndex("id","id",{unique:!0})}catch(e){a(e.message)}},n.onerror=function(){a("indexedDB.open failed, "+n.error)},n.onsuccess=function(){var i,s,o;try{if(!(i=n.result).objectStoreNames.contains(i7)){window.indexedDB.deleteDatabase(i6),a("object store "+i7+" missing. destroying db");return}(o=(s=i.transaction(i7,"readwrite")).objectStore(i7)).index("id")}catch(e){a(e.message);return}i.onerror=function(){a("database error, "+i.error)};try{e(o)}catch(e){a(e.message);return}s.oncomplete=function(){r||(r=!0,t()),i.close()},s.onerror=function(){a("transaction error, "+s.error)}}}function ne(e,t){if(i4){var i;i9(function(e){i=e.get(1)},function(){e(i.result)},function(e){t("execIndexedDBTransaction error, "+e)})}else e(void 0)}function nt(e,t,i){i9(function(t){t.put(e)},function(){t()},function(e){i(e)})}function ni(e,t){i9(function(e){e.delete(1)},function(){e()},function(e){t(e)})}var nn={};nn=I("f6OTe").getBundleURL("lYbF2")+"edit-brightness-contrast.8430cb26.svg";var nr={};nr=I("f6OTe").getBundleURL("lYbF2")+"edit-curves.bbdb97b2.svg";var na={};na=I("f6OTe").getBundleURL("lYbF2")+"edit-flip.00fd2c6b.svg";var ns={};ns=I("f6OTe").getBundleURL("lYbF2")+"edit-hue-saturation.6e36cf05.svg";var no={};no=I("f6OTe").getBundleURL("lYbF2")+"edit-invert.f5d05ba3.png";var nl={};nl=I("f6OTe").getBundleURL("lYbF2")+"edit-perspective.e23100db.svg";var nh={};nh=I("f6OTe").getBundleURL("lYbF2")+"edit-resize.56391e2b.svg";var nc={};nc=I("f6OTe").getBundleURL("lYbF2")+"edit-tilt-shift.f8ae88b3.png";var nu={};nu=I("f6OTe").getBundleURL("lYbF2")+"edit-to-alpha.f7a2065a.svg";var np={};np=I("f6OTe").getBundleURL("lYbF2")+"edit-transform.c8795430.svg";var nd={};nd=I("f6OTe").getBundleURL("lYbF2")+"edit-triangle-blur.d2c20f1d.png";var ng={};ng=I("f6OTe").getBundleURL("lYbF2")+"edit-unsharp-mask.f1520547.png";var nf={};nf=I("f6OTe").getBundleURL("lYbF2")+"edit-grid.e900ce7b.svg";var nv={};nv=I("f6OTe").getBundleURL("lYbF2")+"edit-noise.51bd751c.svg";var nm={};nm=I("f6OTe").getBundleURL("lYbF2")+"edit-pattern.1a06e094.svg";var ny={};ny=I("f6OTe").getBundleURL("lYbF2")+"edit-vanish-point.fc5858e4.svg";var nx={};nx=I("f6OTe").getBundleURL("lYbF2")+"edit-distort.bdb643f2.svg";var nb={isLoaded:!1},nB={brightnessContrast:{lang:{name:"filter-bright-contrast-title",button:"filter-bright-contrast",description:"filter-bright-contrast-description"},icon:t(nn),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},cropExtend:{lang:{name:"filter-crop-title",button:"filter-crop-extend",description:"filter-crop-description"},icon:t(to),updatePos:!0,getDialog:null,apply:null,inEmbed:!1},curves:{lang:{name:"filter-curves-title",button:"filter-curves",description:"filter-curves-description"},icon:t(nr),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},distort:{lang:{name:"filter-distort",button:"filter-distort",description:"filter-distort-description"},icon:t(nx),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},flip:{lang:{name:"filter-flip-title",button:"filter-flip",description:"filter-flip-description"},icon:t(na),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},hueSaturation:{lang:{name:"filter-hue-sat-title",button:"filter-hue-sat",description:"filter-hue-sat-description"},icon:t(ns),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},invert:{lang:{name:"filter-invert",button:"filter-invert"},icon:t(no),updatePos:!1,isInstant:!0,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},perspective:{lang:{name:"filter-perspective-title",button:"filter-perspective",description:"filter-perspective-description"},icon:t(nl),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},resize:{lang:{name:"filter-resize-title",button:"filter-resize",description:"filter-resize-description"},icon:t(nh),updatePos:!0,getDialog:null,apply:null,inEmbed:!1},rotate:{lang:{name:"filter-rotate-title",button:"filter-rotate",description:"filter-rotate-description"},icon:t(ip),updatePos:!0,getDialog:null,apply:null,inEmbed:!1},tiltShift:{lang:{name:"filter-tilt-shift-title",button:"filter-tilt-shift",description:"filter-tilt-shift-description"},icon:t(nc),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},toAlpha:{lang:{name:"filter-to-alpha-title",button:"filter-to-alpha",description:"filter-to-alpha-description"},icon:t(nu),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},transform:{lang:{name:"filter-transform-title",button:"filter-transform",description:"filter-transform-description"},icon:t(np),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},blur:{lang:{name:"filter-triangle-blur-title",button:"filter-triangle-blur",description:"filter-triangle-blur-description"},icon:t(nd),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},unsharpMask:{lang:{name:"filter-unsharp-mask-title",button:"filter-unsharp-mask",description:"filter-unsharp-mask-description"},icon:t(ng),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},grid:{lang:{name:"filter-grid",button:"filter-grid",description:"filter-grid-description"},icon:t(nf),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},noise:{lang:{name:"filter-noise",button:"filter-noise",description:"filter-noise-description"},icon:t(nv),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},pattern:{lang:{name:"filter-pattern",button:"filter-pattern",description:"filter-pattern-description"},icon:t(nm),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},vanishPoint:{lang:{name:"filter-vanish-point-title",button:"filter-vanish-point",description:"filter-vanish-point-description"},icon:t(ny),updatePos:!1,getDialog:null,apply:null,inEmbed:!0}},O=I("cx0mh"),D=I("7h4XF"),W=(I("eWjiX"),I("eWjiX")),O=I("cx0mh"),D=I("7h4XF"),nw={},nk=function(){function e(t,i,n){(0,O._)(this,e),this.x=t,this.y=i,this.z=n}return(0,D._)(e,[{key:"dot2",value:function(e,t){return this.x*e+this.y*t}}]),e}(),nC=[new nk(1,1,0),new nk(-1,1,0),new nk(1,-1,0),new nk(-1,-1,0),new nk(1,0,1),new nk(-1,0,1),new nk(1,0,-1),new nk(-1,0,-1),new nk(0,1,1),new nk(0,-1,1),new nk(0,1,-1),new nk(0,-1,-1)],nS=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],nE=Array(512),nI=Array(512);nw.seed=function(e){e>0&&e<1&&(e*=65536),(e=Math.floor(e))<256&&(e|=e<<8);for(var t=0;t<256;t++){var i=void 0;i=1&t?nS[t]^255&e:nS[t]^e>>8&255,nE[t]=nE[t+256]=i,nI[t]=nI[t+256]=nC[i%12]}},nw.seed(0);var nA=.5*(Math.sqrt(3)-1),nT=(3-Math.sqrt(3))/6;function nM(e){for(var t=e/500,i=(0,W.BB).canvas(e,e),n=(0,W.BB).ctx(i),r=n.createImageData(e,e),a=0;a<e;a++)for(var s=0;s<e;s++){var o=(s*e+a)*4,l=t+.04*nw.simplex2(a/50/t,s/50/t),h=100+(nw.simplex2(a/50/l,s/50/l)+1)/2*100;h-=(nw.simplex2(a/10/t,s/10/t)+1)/2*100;var c=(0,W.BB).dist(e/2,e/2,a,s);h*=(0,W.BB).clamp(1-((c-e/2.5)/(e/14)+nw.simplex2(a/22/l,s/22/l)),0,1)*(2*(0,W.BB).clamp(1-c/e,0,1)),r.data[o]=0,r.data[o+1]=0,r.data[o+2]=0,r.data[o+3]=(0,W.BB).clamp(h,0,255)}return n.putImageData(r,0,0),i}function nL(e){var t,i;t=2/3*(1/4),i=1/3*(1/4);for(var n={x:1/4*e,y:e-1/4*e},r={x:e-1/4*e,y:1/4*e},a=(0,W.BB).canvas(e,e),s=(0,W.BB).ctx(a),o=s.createImageData(e,e),l=0;l<e;l++)for(var h=0;h<e;h++){var c=(h*e+l)*4,u=function(e,t,i){var n=(0,W.BB).Vec2.sub(i,t),r=(0,W.BB).Vec2.sub(e,t),a=(0,W.BB).clamp((0,W.BB).Vec2.dot(r,n)/(0,W.BB).Vec2.dot(n,n),0,1);return(0,W.BB).Vec2.len((0,W.BB).Vec2.sub(r,(0,W.BB).Vec2.mul(n,a)))}({x:l,y:h},n,r);u=(0,W.BB).clamp(255-(u-e*t)/(e*i)*255,0,255),o.data[c]=0,o.data[c+1]=0,o.data[c+2]=0,o.data[c+3]=u}return s.putImageData(o,0,0),a}nw.simplex2=function(e,t){var i,n,r,a,s,o=(e+t)*nA,l=Math.floor(e+o),h=Math.floor(t+o),c=(l+h)*nT,u=e-l+c,p=t-h+c;u>p?(a=1,s=0):(a=0,s=1);var d=u-a+nT,g=p-s+nT,f=u-1+2*nT,v=p-1+2*nT,m=nI[(l&=255)+nE[h&=255]],y=nI[l+a+nE[h+s]],x=nI[l+1+nE[h+1]],b=.5-u*u-p*p;b<0?i=0:(b*=b,i=b*b*m.dot2(u,p));var B=.5-d*d-g*g;B<0?n=0:(B*=B,n=B*B*y.dot2(d,g));var w=.5-f*f-v*v;return w<0?r=0:(w*=w,r=w*w*x.dot2(f,v)),70*(i+n+r)};var nR=[];nR[1]=nM(128),nR[2]=nL(128);var nP=2*Math.PI,nO=function(){function e(){(0,O._)(this,e),this.context={},this.history=new rW.DecoyKlHistory,this.settingHasOpacityPressure=!1,this.settingHasSizePressure=!0,this.settingSize=2,this.settingSpacing=.8489,this.settingOpacity=1,this.settingColor={},this.settingColorStr="",this.settingAlphaId=0,this.settingLockLayerAlpha=!1,this.hasDrawnDot=!1,this.lineToolLastDot=0,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.inputArr=[],this.inputIsDrawing=!1,this.bezierLine=null,this.alphaCanvas128=(0,W.BB).canvas(128,128),this.alphaCanvas64=(0,W.BB).canvas(64,64),this.alphaCanvas32=(0,W.BB).canvas(32,32),this.alphaOpacityArr=[1,.9,1,1]}return(0,D._)(e,[{key:"updateAlphaCanvas",value:function(){if(0!==this.settingAlphaId&&3!==this.settingAlphaId)for(var e,t=[[this.alphaCanvas128,128],[this.alphaCanvas64,64],[this.alphaCanvas32,32]],i=0;i<t.length;i++)(e=(0,W.BB).ctx(t[i][0])).save(),e.clearRect(0,0,t[i][1],t[i][1]),e.fillStyle="rgba("+this.settingColor.r+", "+this.settingColor.g+", "+this.settingColor.b+", "+this.alphaOpacityArr[this.settingAlphaId]+")",e.fillRect(0,0,t[i][1],t[i][1]),e.globalCompositeOperation="destination-in",e.imageSmoothingQuality="high",e.drawImage(nR[this.settingAlphaId],0,0,t[i][1],t[i][1]),e.restore()}},{key:"calcOpacity",value:function(e){return this.settingOpacity*(this.settingHasOpacityPressure?e*e:1)}},{key:"drawDot",value:function(e,t,i,n,r,a){if(!(i<=0)){if(this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop"),a&&a[3]===n||(this.context.globalAlpha=n),a||0!==this.settingAlphaId&&3!==this.settingAlphaId||(this.context.fillStyle=this.settingColorStr),0===this.settingAlphaId)this.context.beginPath(),this.context.arc(e,t,i,0,nP),this.context.closePath(),this.context.fill(),this.hasDrawnDot=!0;else if(3===this.settingAlphaId)void 0!==r&&(this.context.save(),this.context.translate(e,t),this.context.rotate(r/180*Math.PI),this.context.fillRect(-i,-i,2*i,2*i),this.context.restore(),this.hasDrawnDot=!0);else{this.context.save(),this.context.translate(e,t);var s=this.alphaCanvas128;i<=32&&i>16?s=this.alphaCanvas64:i<=16&&(s=this.alphaCanvas32),this.context.scale(i,i),1===this.settingAlphaId&&this.context.rotate((e+t)*53123%nP),this.context.drawImage(s,-1,-1,2,2),this.context.restore(),this.hasDrawnDot=!0}}}},{key:"continueLine",value:function(e,t,i,n){var r=this;null===this.bezierLine&&(this.bezierLine=new W.BB.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,function(){}));var a=[],s=function(e){var t=(0,W.BB).mix(r.lastInput2.pressure,n,e.t),i=r.calcOpacity(t),s=Math.max(.1,r.settingSize*(r.settingHasSizePressure?t:1));a.push([e.x,e.y,s,i,e.angle])},o=i*this.settingSpacing;null===e||null===t?this.bezierLine.addFinal(o,s):this.bezierLine.add(e,t,o,s),this.context.save();for(var l=void 0,h=0;h<a.length;h++){var c=a[h];this.drawDot(c[0],c[1],c[2],c[3],c[4],l),l=c}this.context.restore()}},{key:"startLine",value:function(e,t,i){this.historyEntry={tool:["brush","PenBrush"],actions:[{action:"opacityPressure",params:[this.settingHasOpacityPressure]},{action:"sizePressure",params:[this.settingHasSizePressure]},{action:"setSize",params:[this.settingSize]},{action:"setSpacing",params:[this.settingSpacing]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setAlpha",params:[this.settingAlphaId]},{action:"setLockAlpha",params:[this.settingLockLayerAlpha]}]},i=(0,W.BB).clamp(i,0,1);var n=this.calcOpacity(i),r=this.settingHasSizePressure?Math.max(.1,i*this.settingSize):Math.max(.1,this.settingSize);this.hasDrawnDot=!1,this.inputIsDrawing=!0,this.context.save(),this.drawDot(e,t,r,n),this.context.restore(),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2.pressure=i,this.inputArr=[{x:e,y:t,pressure:i}],this.historyEntry.actions.push({action:"startLine",params:[e,t,i]})}},{key:"goLine",value:function(e,t,i){if(this.inputIsDrawing){this.historyEntry.actions.push({action:"goLine",params:[e,t,i]});var n=(0,W.BB).clamp(i,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.context.save(),this.continueLine(e,t,r,this.lastInput.pressure),this.context.restore(),this.lastInput.x=e,this.lastInput.y=t,this.lastInput2.pressure=this.lastInput.pressure,this.lastInput.pressure=n,this.inputArr.push({x:e,y:t,pressure:i})}}},{key:"endLine",value:function(e,t){var i=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);if(this.context.save(),this.continueLine(null,null,i,this.lastInput.pressure),this.context.restore(),this.inputIsDrawing=!1,3===this.settingAlphaId&&!this.hasDrawnDot){var n=this.inputArr[0];this.inputArr.forEach(function(e){e.pressure>n.pressure&&(n=e)}),this.context.save();var r=(0,W.BB).clamp(n.pressure,0,1),a=this.calcOpacity(r);this.drawDot(n.x,n.y,i,a,0),this.context.restore()}this.bezierLine=null,this.historyEntry&&(this.historyEntry.actions.push({action:"endLine",params:[e,t]}),this.history.push(this.historyEntry),this.historyEntry=void 0),this.hasDrawnDot=!1,this.inputArr=[]}},{key:"drawLineSegment",value:function(e,t,i,n){if(this.lastInput.x=i,this.lastInput.y=n,this.lastInput.pressure=1,!this.inputIsDrawing&&void 0!==e){var r,a=(0,W.BB).pointsToAngleDeg({x:e,y:t},{x:i,y:n}),s=Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2)),o=(i-e)/s,l=(n-t)/s,h=this.settingSize*this.settingSpacing;for(this.lineToolLastDot=this.settingSize*this.settingSpacing,this.context.save(),r=this.lineToolLastDot;r<=s;r+=h)this.drawDot(e+o*r,t+l*r,this.settingSize,this.settingOpacity,a);this.context.restore();var c={tool:["brush","PenBrush"],actions:[{action:"opacityPressure",params:[this.settingHasOpacityPressure]},{action:"sizePressure",params:[this.settingHasSizePressure]},{action:"setSize",params:[this.settingSize]},{action:"setSpacing",params:[this.settingSpacing]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setAlpha",params:[this.settingAlphaId]},{action:"setLockAlpha",params:[this.settingLockLayerAlpha]},{action:"drawLineSegment",params:[e,t,i,n]}]};this.history.push(c)}}},{key:"isDrawing",value:function(){return this.inputIsDrawing}},{key:"setAlpha",value:function(e){this.settingAlphaId!==e&&(this.settingAlphaId=e,this.updateAlphaCanvas())}},{key:"setColor",value:function(e){this.settingColor!==e&&(this.settingColor={r:e.r,g:e.g,b:e.b},this.settingColorStr="rgb("+this.settingColor.r+","+this.settingColor.g+","+this.settingColor.b+")",this.updateAlphaCanvas())}},{key:"setContext",value:function(e){this.context=e}},{key:"setHistory",value:function(e){this.history=e}},{key:"setSize",value:function(e){this.settingSize=e}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"setSpacing",value:function(e){this.settingSpacing=e}},{key:"sizePressure",value:function(e){this.settingHasSizePressure=e}},{key:"opacityPressure",value:function(e){this.settingHasOpacityPressure=e}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=e}},{key:"getSpacing",value:function(){return this.settingSpacing}},{key:"getSize",value:function(){return this.settingSize}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),ts=I("eg83P"),nD=function(){function e(){(0,O._)(this,e),this.isTesting=!1,this.context={},this.color={},this.size=29,this.opacity=.6,this.blending=.65,this.settingLockLayerAlpha=!1,this.settingSizePressure=!0,this.settingOpacityPressure=!1,this.blendCol={r:0,g:0,b:0,a:1},this.blendMix=.45,this.mixCol={r:0,g:0,b:0},this.localColOld={},this.isDrawing=!1,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.cells=[],this.drawBuffer=[]}return(0,D._)(e,[{key:"updateRedrawBounds",value:function(e){this.redrawBounds=(0,W.BB).updateBounds(this.redrawBounds,e)}},{key:"getCellsWidth",value:function(){return Math.ceil(this.context.canvas.width/256)}},{key:"drawChangedCells",value:function(){var e=this;if(this.redrawBounds){var t=this.cells.map(function(){});this.getTouchedCells(this.redrawBounds).forEach(function(i,n){i&&(t[n]=e.cells[n])}),this.drawCells(t),this.redrawBounds=void 0}}},{key:"getTouchedCells",value:function(e){var t=this.cells.map(function(){return!1}),i=this.getCellsWidth();e={x1:Math.floor(e.x1/256),y1:Math.floor(e.y1/256),x2:Math.floor(e.x2/256),y2:Math.floor(e.y2/256)};for(var n=e.x1;n<=e.x2;n++)for(var r=e.y1;r<=e.y2;r++)t[r*i+n]=!0;return t}},{key:"sliceBounds",value:function(e){var t=this,i=this.getCellsWidth(),n=[];return this.getTouchedCells(e).forEach(function(r,a){if(r){var s=a%i*256,o=256*Math.floor(a/i),l=t.cells[a].width,h=t.cells[a].height,c={x1:Math.max(0,e.x1-s),y1:Math.max(0,e.y1-o),x2:Math.min(l-1,e.x2-s),y2:Math.min(h-1,e.y2-o)};c.x1>c.x2||c.y1>c.y2||n.push({index:a,bounds:c})}}),n}},{key:"copyFromCanvas",value:function(e){var t=this;if(e){var i=this.getTouchedCells(e),n=this.getCellsWidth();i.forEach(function(e,i){if(e&&!t.cells[i]){var r=i%n,a=Math.floor(i/n),s=(Math.min(256*r+256,t.context.canvas.width)-1)%256+1,o=(Math.min(256*a+256,t.context.canvas.height)-1)%256+1,l=(0,W.BB).canvas(s,o),h=(0,W.BB).ctx(l);h.drawImage(t.context.canvas,-(256*r),-(256*a)),t.cells[i]=h.getImageData(0,0,s,o)}})}}},{key:"getAverage",value:function(e,t,i){var n=this,r=Math.max(0,Math.floor(e-(i=Math.max(.5,.75*i)))),a=Math.max(0,Math.floor(t-i)),s=Math.min(this.context.canvas.width-1,Math.ceil(e+i)),o=Math.min(this.context.canvas.height-1,Math.ceil(t+i));if(r>s||a>o)return{r:0,g:0,b:0,a:0};var l,h=0,c=0,u=0,p=0;return this.sliceBounds({x1:r,y1:a,x2:s,y2:o}).forEach(function(e){for(var t=n.cells[e.index].width,i=n.cells[e.index].data,r=e.bounds,a=r.y1;a<=r.y2;a+=4)for(var s=r.x1,o=a*t*4+4*r.x1;s<=r.x2;s+=4,o+=16)l=i[o+3],h+=i[o]*l,c+=i[o+1]*l,u+=i[o+2]*l,p+=l}),0!==p&&(h/=p,c/=p,u/=p,p=Math.min(1,p)),{r:h,g:c,b:u,a:p}}},{key:"prepDot",value:function(e,t,i){var n=Math.max(0,Math.floor(e-(i=Math.max(.5,i)))),r=Math.max(0,Math.floor(t-i)),a=Math.min(this.context.canvas.width-1,Math.ceil(e+i)),s=Math.min(this.context.canvas.height-1,Math.ceil(t+i));if(!(n>a)&&!(r>s))return{x1:n,y1:r,x2:a,y2:s}}},{key:"drawDot",value:function(e){for(var t=this,i=0,n=e.size>30?1024:512,r=[],a=0;a<n;a++)r[a]=(Math.random()-.5)/1.001+.5;var s=[8,4,4,4,2,2,2,2,2,2][Math.floor(2*e.size)],o=s?s*s:0,l=[];if(s)for(var h=0,c=0;c<s;c++)for(var u=0;u<s;u++,h+=2)l[h]=(c+1)/s,l[h+1]=(u+1)/s;var p=.8*Math.pow(e.opacity,2),d=1-p,g=e.size*e.size,f=g*d/e.opacity,v=(1+p/d)*e.opacity,m=this.sliceBounds({x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2}),y=this.getCellsWidth();m.forEach(function(a){for(var s=a.index%y*256,h=256*Math.floor(a.index/y),c=t.cells[a.index].width,u=t.cells[a.index].data,p=a.bounds.y1,d=p+h-e.y;p<=a.bounds.y2;p++,d++)for(var m=a.bounds.x1,x=p*c*4+4*a.bounds.x1,b=m+s-e.x;m<=a.bounds.x2;m++,x+=4,b++){var B=0;if(o){for(var w=0;w<l.length;w+=2){var k=(0,W.BB).lenSquared(b+l[w],d+l[w+1]);k>=g||(B+=(0,ts.clamp)(v-k/f,0,e.opacity))}if(!B)continue;B/=o}else{var C=Math.pow(b,2)+Math.pow(d,2);if(C>=g)continue;B=(0,ts.clamp)(v-C/f,0,e.opacity)}var S=1-B,E=u[x+3]/255;if(t.settingLockLayerAlpha){var I=e.r*B+u[x]*S,A=e.g*B+u[x+1]*S,T=e.b*B+u[x+2]*S;E&&(u[x]=Math.floor(I+r[i]),u[x+1]=Math.floor(A+r[i]),u[x+2]=Math.floor(T+r[i]))}else{var M=e.r*B+u[x]*E*S,L=e.g*B+u[x+1]*E*S,R=e.b*B+u[x+2]*E*S,P=1-S*(1-E);u[x+3]=Math.floor(Math.min(255,255*P)+.5),P&&(u[x]=Math.floor(M/P+r[i]),u[x+1]=Math.floor(L/P+r[i]),u[x+2]=Math.floor(R/P+r[i]))}i=(i+1)%n}})}},{key:"calcSpacing",value:function(e){return(0,W.BB).mix(2*e/2,2*e/9,(0,ts.clamp)((e-2.7)/9.3,0,1))}},{key:"continueLine",value:function(e,t,i,n){var r,a,s,o,l=this;this.drawBuffer=[];var h=this.settingSizePressure?Math.max(1,i*this.size):Math.max(1,this.size),c=this.calcSpacing(h),u=void 0===e?this.lastInput.x:e,p=void 0===t?this.lastInput.y:t;if(0===this.blending)this.mixCol.r=this.color.r,this.mixCol.g=this.color.g,this.mixCol.b=this.color.b;else{if(n)o={r:this.localColOld.r,g:this.localColOld.g,b:this.localColOld.b,a:0};else{var d=[u,p,this.settingSizePressure?Math.max(.5,i*this.size):Math.max(.5,this.size)],g=this.prepDot(d[0],d[1],d[2]);g&&this.copyFromCanvas(g),o=this.getAverage(d[0],d[1],d[2])}s={r:0,g:0,b:0,a:0},o.a>0&&0===this.blendCol.a?(this.blendCol.r=o.r,this.blendCol.g=o.g,this.blendCol.b=o.b,this.blendCol.a=o.a):(0===o.a&&(o.r=this.color.r,o.g=this.color.g,o.b=this.color.b,o.a=1-this.blending),this.blendCol.r=(0,W.BB).mix(this.blendCol.r,(0,W.BB).mix(this.blendCol.r,o.r,this.blendMix),o.a),this.blendCol.g=(0,W.BB).mix(this.blendCol.g,(0,W.BB).mix(this.blendCol.g,o.g,this.blendMix),o.a),this.blendCol.b=(0,W.BB).mix(this.blendCol.b,(0,W.BB).mix(this.blendCol.b,o.b,this.blendMix),o.a),this.blendCol.a=Math.min(1,this.blendCol.a+o.a)),s.r=this.blendCol.r,s.g=this.blendCol.g,s.b=this.blendCol.b,s.a=this.blendCol.a}var f=function(e){if(!(l.blending>=1)||!(l.blendCol.a<=0)){var t=e.t;r=l.lastInput2.pressure*(1-t)+i*t,a=l.settingOpacityPressure?l.opacity*r*r:l.opacity,h=l.settingSizePressure?Math.max(.1,r*l.size):Math.max(.1,l.size),0!=l.blending&&(l.mixCol.r=(0,W.BB).mix(l.localColOld.r,s.r,t),l.mixCol.g=(0,W.BB).mix(l.localColOld.g,s.g,t),l.mixCol.b=(0,W.BB).mix(l.localColOld.b,s.b,t)),1===l.blending&&0===l.localColOld.a&&(l.mixCol.r=s.r,l.mixCol.g=s.g,l.mixCol.b=s.b);var n=l.prepDot(e.x,e.y,h);n&&(l.updateRedrawBounds(n),l.drawBuffer.push({x:e.x,y:e.y,size:h,opacity:a,x1:n.x1,y1:n.y1,x2:n.x2,y2:n.y2,r:(0,W.BB).mix(l.color.r,l.mixCol.r,l.blending),g:(0,W.BB).mix(l.color.g,l.mixCol.g,l.blending),b:(0,W.BB).mix(l.color.b,l.mixCol.b,l.blending)}))}};void 0===e||void 0===t?this.bezierLine.addFinal(c,f):this.bezierLine.add(e,t,c,f),this.copyFromCanvas(this.redrawBounds),this.drawBuffer.forEach(function(e){l.drawDot(e)}),this.drawBuffer=[],this.localColOld=s}},{key:"setHistory",value:function(e){this.history=e}},{key:"getSize",value:function(){return this.size}},{key:"setSize",value:function(e){this.size=e}},{key:"getOpacity",value:function(){return this.opacity}},{key:"setOpacity",value:function(e){this.opacity=e}},{key:"getBlending",value:function(){return this.blending}},{key:"setBlending",value:function(e){this.blending=e}},{key:"setColor",value:function(e){this.color=(0,W.BB).copyObj(e)}},{key:"setContext",value:function(e){this.context=e}},{key:"setSizePressure",value:function(e){this.settingSizePressure=e}},{key:"setOpacityPressure",value:function(e){this.settingOpacityPressure=e}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=e}},{key:"getIsDrawing",value:function(){return this.isDrawing}},{key:"setIsTesting",value:function(e){this.isTesting=e}},{key:"startLine",value:function(e,t,i){var n=this;this.historyEntry={tool:["brush","BlendBrush"],actions:[]};var r=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.cells="0".repeat(r).split("").map(function(){}),this.isDrawing=!0,i=Math.max(0,Math.min(1,i));var a=this.settingOpacityPressure?this.opacity*i*i:this.opacity,s=this.settingSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size);if(0===this.blending)this.mixCol.r=this.color.r,this.mixCol.g=this.color.g,this.mixCol.b=this.color.b;else{this.copyFromCanvas(this.prepDot(e,t,s));var o=this.getAverage(e,t,this.settingSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size));0===o.a?this.blendCol={r:this.color.r,g:this.color.g,b:this.color.b,a:1-this.blending}:this.blendCol={r:o.r,g:o.g,b:o.b,a:o.a},this.mixCol.r=this.blendCol.r,this.mixCol.g=this.blendCol.g,this.mixCol.b=this.blendCol.b}if(this.localColOld={r:this.mixCol.r,g:this.mixCol.g,b:this.mixCol.b,a:this.blendCol.a},this.redrawBounds=void 0,this.drawBuffer=[],this.blending<1||this.blendCol.a>0){var l=this.prepDot(e,t,s);l&&(this.updateRedrawBounds(l),this.drawBuffer.push({x:e,y:t,size:s,opacity:a,x1:l.x1,y1:l.y1,x2:l.x2,y2:l.y2,r:(0,W.BB).mix(this.color.r,this.mixCol.r,this.blending),g:(0,W.BB).mix(this.color.g,this.mixCol.g,this.blending),b:(0,W.BB).mix(this.color.b,this.mixCol.b,this.blending)}))}this.copyFromCanvas(this.redrawBounds),this.drawBuffer.forEach(function(e){n.drawDot(e)}),this.drawBuffer=[],this.bezierLine=new W.BB.BezierLine,this.bezierLine.add(e,t,0,function(){}),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2=(0,W.BB).copyObj(this.lastInput),this.isTesting||this.drawChangedCells()}},{key:"goLine",value:function(e,t,i,n){this.isDrawing&&(this.continueLine(e,t,this.lastInput.pressure,n),this.lastInput2=(0,W.BB).copyObj(this.lastInput),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.isTesting||this.drawChangedCells())}},{key:"endLine",value:function(){this.bezierLine&&this.continueLine(void 0,void 0,this.lastInput.pressure,!1),this.isDrawing=!1,this.bezierLine=void 0,this.drawChangedCells(),this.historyEntry&&this.history&&this.cells.find(function(e){return!!e})&&(this.historyEntry.actions.push({action:"drawCells",params:[this.cells]}),this.history.push(this.historyEntry),this.historyEntry=void 0),this.cells=[]}},{key:"drawCells",value:function(e){var t=this,i=this.getCellsWidth();e.forEach(function(e,n){if(e){var r=256*Math.floor(n/i);t.context.putImageData(e,n%i*256,r)}})}},{key:"drawLineSegment",value:function(e,t,i,n){var r=this;if(this.lastInput.x=i,this.lastInput.y=n,!this.isDrawing&&void 0!==e){var a=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.cells="0".repeat(a).split("").map(function(){}),this.redrawBounds=void 0,this.drawBuffer=[],this.copyFromCanvas(this.prepDot(e,t,Math.max(.1,this.size)));var s=this.getAverage(e,t,Math.max(.1,this.size));0===s.a?this.blendCol={r:this.color.r,g:this.color.g,b:this.color.b,a:1-this.blending}:this.blendCol={r:s.r,g:s.g,b:s.b,a:s.a},this.mixCol.r=this.color.r*(1-this.blendCol.a)+(this.blending*this.blendCol.r+this.color.r*(1-this.blending))*this.blendCol.a,this.mixCol.g=this.color.g*(1-this.blendCol.a)+(this.blending*this.blendCol.g+this.color.g*(1-this.blending))*this.blendCol.a,this.mixCol.b=this.color.b*(1-this.blendCol.a)+(this.blending*this.blendCol.b+this.color.b*(1-this.blending))*this.blendCol.a;for(var o=this.settingOpacityPressure?1*this.opacity:this.opacity,l=this.settingSizePressure?Math.max(.1,1*this.size):Math.max(.1,this.size),h=Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2)),c=(i-e)/h,u=(n-t)/h,p=this.calcSpacing(l),d=0;d<=h;d+=p){var g=this.prepDot(e+c*d,t+u*d,l);g&&(this.copyFromCanvas(g),this.drawBuffer.push({x:e+c*d,y:t+u*d,size:l,opacity:o,x1:g.x1,y1:g.y1,x2:g.x2,y2:g.y2,r:(0,W.BB).mix(this.color.r,this.mixCol.r,this.blending),g:(0,W.BB).mix(this.color.g,this.mixCol.g,this.blending),b:(0,W.BB).mix(this.color.b,this.mixCol.b,this.blending)}))}this.drawBuffer.forEach(function(e){r.drawDot(e)}),this.drawBuffer=[],this.history&&this.cells.find(function(e){return!!e})&&(this.drawCells(this.cells),this.historyEntry={tool:["brush","BlendBrush"],actions:[{action:"drawCells",params:[this.cells]}]},this.history.push(this.historyEntry),this.historyEntry=void 0),this.cells=[]}}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),nz=(0,W.BB).canvas(32,32),n_=(0,W.BB).ctx(nz),nj=function(){function e(){(0,O._)(this,e),this.context={},this.settingColor={},this.settingSize=1,this.settingOpacity=.2,this.settingBlending=.5,this.settingScale=1,this.lastX=0,this.lastY=0,this.inputIsDrawing=!1,this.lastInput={x:0,y:0,pressure:0},this.history=new rW.DecoyKlHistory,this.sketchySeed=0,this.points=[],this.count=0,this.mixMode=[function(e){return e},function(e,t){var i=new W.BB.RGB(e.r,e.g,e.b);return i.r*=t.r/255,i.g*=t.g/255,i.b*=t.b/255,i}]}return(0,D._)(e,[{key:"rand",value:function(){return this.sketchySeed++,.5*Math.sin(6324634.2345*Math.cos(5342.3423*this.sketchySeed))+.5}},{key:"setHistory",value:function(e){this.history=e}},{key:"setSeed",value:function(e){this.sketchySeed=parseInt(""+e)}},{key:"getSeed",value:function(){return parseInt(""+this.sketchySeed)}},{key:"getSize",value:function(){return this.settingSize/2}},{key:"setColor",value:function(e){this.settingColor=e}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"getBlending",value:function(){return this.settingBlending}},{key:"setBlending",value:function(e){this.settingBlending=e}},{key:"setSize",value:function(e){this.settingSize=2*e}},{key:"getScale",value:function(){return this.settingScale}},{key:"setScale",value:function(e){this.settingScale=e}},{key:"setContext",value:function(e){this.context=e}},{key:"startLine",value:function(e,t,i,n){n&&this.lastInput.x?(this.inputIsDrawing=!0,this.endLine()):(this.inputIsDrawing=!0,this.lastX=e,this.lastY=t,this.lastInput.x=e,this.lastInput.y=t,this.historyEntry={tool:["brush","SketchyBrush"],actions:[{action:"setScale",params:[this.settingScale]},{action:"setSize",params:[this.settingSize/2]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setBlending",params:[this.settingBlending]},{action:"startLine",params:[e,t,i]}]})}},{key:"goLine",value:function(e,t,i,n){if(this.inputIsDrawing&&(e!==this.lastInput.x||t!==this.lastInput.y)){var r,a,s,o,l=parseInt(""+e),h=parseInt(""+t);this.points.push([l,h]);var c=this.settingColor.r,u=this.settingColor.g,p=this.settingColor.b;if(n)c=n.r,u=n.g,p=n.b;else if(0!==this.settingBlending&&l+5>=0&&h+5>=0&&l-5<this.context.canvas.width-1&&h-5<this.context.canvas.height-1){c=0,u=0,p=0;var d=Math.min(this.context.canvas.width-1,Math.max(0,l-5)),g=Math.min(this.context.canvas.height-1,Math.max(0,h-5)),f=Math.min(this.context.canvas.width-1,Math.max(0,l+5)),v=Math.min(this.context.canvas.height-1,Math.max(0,h+5));if(f-=d,v-=g,f>0&&v>0){for(var m=this.context.getImageData(d,g,f,v),y=0,x=0;x<m.data.length;x+=4)c+=m.data[x+0],u+=m.data[x+1],p+=m.data[x+2],y++;c/=y,u/=y,p/=y}var b=this.mixMode[0](new W.BB.RGB(c,u,p),this.settingColor);c=parseInt(""+(0,W.BB).mix(this.settingColor.r,b.r,this.settingBlending)),u=parseInt(""+(0,W.BB).mix(this.settingColor.g,b.g,this.settingBlending)),p=parseInt(""+(0,W.BB).mix(this.settingColor.b,b.b,this.settingBlending))}for(this.context.save(),this.context.strokeStyle="rgba("+c+", "+u+", "+p+", "+this.settingOpacity+")",this.context.lineWidth=this.settingSize,this.context.beginPath(),this.context.moveTo(this.lastX,this.lastY),this.context.lineTo(l,h),r=0;r<this.points.length;r++)(o=(a=this.points[r][0]-this.points[this.count][0])*a+(s=this.points[r][1]-this.points[this.count][1])*s)<4e3*this.settingScale*this.settingScale&&this.rand()>o/2e3/this.settingScale/this.settingScale&&(this.context.moveTo(this.points[this.count][0]+.3*a,this.points[this.count][1]+.3*s),this.context.lineTo(this.points[r][0]-.3*a,this.points[r][1]-.3*s));this.context.stroke(),this.context.restore(),this.count++,this.lastX=l,this.lastY=h,this.lastInput.x=l,this.lastInput.y=h,this.historyEntry.actions.push({action:"goLine",params:[e,t,i,{r:c,g:u,b:p}]})}}},{key:"endLine",value:function(){this.inputIsDrawing=!1,this.count=0,this.points=[],this.historyEntry&&(this.historyEntry.actions.push({action:"endLine",params:[]}),this.history.push(this.historyEntry),this.historyEntry=void 0)}},{key:"drawLineSegment",value:function(e,t,i,n){if(this.lastInput.x=i,this.lastInput.y=n,!this.inputIsDrawing&&void 0!==e){this.context.save(),this.context.lineWidth=this.settingSize;var r={r:this.settingColor.r,g:this.settingColor.g,b:this.settingColor.b};if(e+5>=0&&t+5>=0&&e-5<this.context.canvas.width-1&&t-5<this.context.canvas.height-1){r.r=0,r.g=0,r.b=0;var a=Math.min(this.context.canvas.width-1,Math.max(0,e-5)),s=Math.min(this.context.canvas.height-1,Math.max(0,t-5)),o=Math.min(this.context.canvas.width-1,Math.max(0,e+5)),l=Math.min(this.context.canvas.height-1,Math.max(0,t+5));if(o-=a,l-=s,o>0&&l>0){var h=Math.min(nz.width,o),c=Math.min(nz.height,l);n_.save(),n_.globalCompositeOperation="copy",n_.drawImage(this.context.canvas,a,s,o,l,0,0,h,c),n_.restore();for(var u=n_.getImageData(a,s,o,l),p=0,d=0;d<u.data.length;d+=4)r.r+=u.data[d+0],r.g+=u.data[d+1],r.b+=u.data[d+2],p++;r.r/=p,r.g/=p,r.b/=p}}var g=this.mixMode[0](new W.BB.RGB(r.r,r.g,r.b),this.settingColor);r.r=parseInt(""+(this.settingBlending*g.r+this.settingColor.r*(1-this.settingBlending))),r.g=parseInt(""+(this.settingBlending*g.g+this.settingColor.g*(1-this.settingBlending))),r.b=parseInt(""+(this.settingBlending*g.b+this.settingColor.b*(1-this.settingBlending))),this.context.strokeStyle="rgba("+r.r+", "+r.g+", "+r.b+", "+this.settingOpacity+")",this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(i,n),this.context.stroke(),this.context.strokeStyle="rgba("+r.r+", "+r.g+", "+r.b+", "+this.settingOpacity+")",this.context.restore();var f={tool:["brush","SketchyBrush"],actions:[{action:"setScale",params:[this.settingScale]},{action:"setSize",params:[this.settingSize/2]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setBlending",params:[this.settingBlending]},{action:"drawLineSegment",params:[e,t,i,n]}]};this.history.push(f)}}},{key:"isDrawing",value:function(){return this.inputIsDrawing}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),_=I("7jh4K"),nF=function(){function e(){(0,O._)(this,e),this.history=new rW.DecoyKlHistory,this.context={},this.settingHasSizePressure=!0,this.settingHasOpacityPressure=!1,this.settingSize=.5,this.settingSpacing=.9,this.settingOpacity=1,this.settingColor={},this.settingColorStr="",this.settingLockLayerAlpha=!1,this.settingIsEraser=!1,this.settingUseDither=!0,this.inputIsDrawing=!1,this.lineToolLastDot=0,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.bezierLine=null,this.ditherArr=[[3,2],[1,0],[3,0],[1,2],[2,1],[0,3],[0,1],[2,3],[2,0],[0,2],[0,0],[2,2],[1,1],[3,3],[3,1],[1,3]],this.ditherPattern={},this.ditherCanvas=(0,W.BB).canvas(4,4),this.ditherCtx=(0,W.BB).ctx(this.ditherCanvas)}return(0,D._)(e,[{key:"updateDither",value:function(){this.ditherCtx.clearRect(0,0,4,4),this.ditherCtx.fillStyle=this.settingIsEraser?"rgb(".concat(eA,",").concat(eA,",").concat(eA,")"):this.settingColorStr;for(var e=0;e<Math.max(1,Math.round(this.settingOpacity*this.ditherArr.length));e++)this.ditherCtx.fillRect(this.ditherArr[e][0],this.ditherArr[e][1],1,1);this.ditherPattern=(0,_.throwIfNull)(this.context.createPattern(this.ditherCanvas,"repeat"))}},{key:"cubicCurveOverThreshold",value:function(e,t,i,n,r){var a=(0,W.BB).Vec2.nor({x:n.x-e.x,y:n.y-e.y}),s=(0,W.BB).Vec2.nor({x:t.x-e.x,y:t.y-e.y}),o=(0,W.BB).Vec2.nor({x:n.x-i.x,y:n.y-i.y});return Math.max((0,W.BB).Vec2.dist(a,s),(0,W.BB).Vec2.dist(a,o))>r}},{key:"plotCubicBezierLine",value:function(e,t,i,n){var r=this.cubicCurveOverThreshold(e,t,i,n,.1);e.x=Math.floor(e.x),e.y=Math.floor(e.y),n.x=Math.floor(n.x),n.y=Math.floor(n.y);var a=(0,W.BB).dist(e.x,e.y,n.x,n.y);if(!r||a<7){this.plotLine(e.x,e.y,n.x,n.y,!0);return}for(var s=Math.max(2,Math.round(a/4)),o=[],l=0;l<=s;l++){var h=l/s,c=Math.pow(1-h,3),u=3*h*Math.pow(1-h,2),p=3*Math.pow(h,2)*(1-h),d=Math.pow(h,3);o.push({x:c*e.x+u*t.x+p*i.x+d*n.x,y:c*e.y+u*t.y+p*i.y+d*n.y})}for(var g=0;g<s;g++)this.plotLine(Math.round(o[g].x),Math.round(o[g].y),Math.round(o[g+1].x),Math.round(o[g+1].y),!0)}},{key:"drawDot",value:function(e,t,i,n){this.context.save(),this.settingIsEraser?(this.context.fillStyle=this.settingUseDither?this.ditherPattern:"#fff",this.settingLockLayerAlpha?this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out"):(this.context.fillStyle=this.settingUseDither?this.ditherPattern:this.settingColorStr,this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop")),this.context.globalAlpha=this.settingUseDither?1:n,this.context.fillRect(Math.round(e+-i),Math.round(t+-i),Math.round(2*i),Math.round(2*i)),this.context.restore()}},{key:"continueLine",value:function(e,t,i,n){var r=this;null===this.bezierLine&&(this.bezierLine=new W.BB.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,function(){})),this.context.save();var a=function(e){var t=(0,W.BB).mix(r.lastInput2.pressure,n,e.t),i=r.settingOpacity*(r.settingHasOpacityPressure?t*t:1),a=Math.max(.5,r.settingSize*(r.settingHasSizePressure?t:1));r.drawDot(e.x,e.y,a,i)},s=function(e){r.plotCubicBezierLine(e.p1,e.p2,e.p3,e.p4)};if(1===Math.round(2*this.settingSize))null===e||null===t?this.bezierLine.addFinal(4,void 0,s):this.bezierLine.add(e,t,4,void 0,s);else{var o=i*this.settingSpacing;null===e||null===t?this.bezierLine.addFinal(o,a):this.bezierLine.add(e,t,o,a)}this.context.restore()}},{key:"plotLine",value:function(e,t,i,n,r){this.context.save(),this.settingIsEraser?(this.context.fillStyle=this.settingUseDither?this.ditherPattern:"#fff",this.settingLockLayerAlpha?this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out"):(this.context.fillStyle=this.settingUseDither?this.ditherPattern:this.settingColorStr,this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop")),this.context.globalAlpha=this.settingUseDither?1:this.settingOpacity,e=Math.floor(e),t=Math.floor(t);for(var a=Math.abs((i=Math.floor(i))-e),s=e<i?1:-1,o=-Math.abs((n=Math.floor(n))-t),l=t<n?1:-1,h=a+o;r?r=!1:this.context.fillRect(e,t,1,1),e!==i||t!==n;){var c=2*h;c>=o&&(h+=o,e+=s),c<=a&&(h+=a,t+=l)}this.context.restore()}},{key:"startLine",value:function(e,t,i){this.historyEntry={tool:["brush","PixelBrush"],actions:[{action:"sizePressure",params:[this.settingHasSizePressure]},{action:"opacityPressure",params:[this.settingHasOpacityPressure]},{action:"setSize",params:[this.settingSize]},{action:"setSpacing",params:[this.settingSpacing]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setLockAlpha",params:[this.settingLockLayerAlpha]},{action:"setIsEraser",params:[this.settingIsEraser]},{action:"setUseDither",params:[this.settingUseDither]}]},this.settingUseDither&&this.updateDither(),i=Math.max(0,Math.min(1,i));var n=this.settingHasOpacityPressure?this.settingOpacity*i*i:this.settingOpacity,r=this.settingHasSizePressure?Math.max(.5,i*this.settingSize):Math.max(.5,this.settingSize);this.inputIsDrawing=!0,this.drawDot(e,t,r,n),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2=(0,W.BB).copyObj(this.lastInput),this.historyEntry.actions.push({action:"startLine",params:[e,t,i]})}},{key:"goLine",value:function(e,t,i){if(this.inputIsDrawing){this.historyEntry.actions.push({action:"goLine",params:[e,t,i]});var n=(0,W.BB).clamp(i,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(e,t,r,this.lastInput.pressure),this.lastInput2=(0,W.BB).copyObj(this.lastInput),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=n}}},{key:"endLine",value:function(e,t){var i=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(null,null,i,this.lastInput.pressure),this.inputIsDrawing=!1,this.bezierLine=null,this.historyEntry&&(this.historyEntry.actions.push({action:"endLine",params:[e,t]}),this.history.push(this.historyEntry),this.historyEntry=void 0)}},{key:"drawLineSegment",value:function(e,t,i,n){if(this.lastInput.x=i,this.lastInput.y=n,this.lastInput.pressure=1,!this.inputIsDrawing&&void 0!==e){if(this.settingUseDither&&this.updateDither(),1===Math.round(2*this.settingSize))this.plotLine(e,t,i,n,!0);else{var r,a=Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2)),s=(i-e)/a,o=(n-t)/a,l=this.settingSize*this.settingSpacing;for(this.lineToolLastDot=this.settingSize*this.settingSpacing,r=this.lineToolLastDot;r<=a;r+=l)this.drawDot(e+s*r,t+o*r,this.settingSize,this.settingOpacity)}var h={tool:["brush","PixelBrush"],actions:[{action:"sizePressure",params:[this.settingHasSizePressure]},{action:"opacityPressure",params:[this.settingHasOpacityPressure]},{action:"setSize",params:[this.settingSize]},{action:"setSpacing",params:[this.settingSpacing]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setLockAlpha",params:[this.settingLockLayerAlpha]},{action:"setIsEraser",params:[this.settingIsEraser]},{action:"setUseDither",params:[this.settingUseDither]},{action:"drawLineSegment",params:[e,t,i,n]}]};this.history.push(h)}}},{key:"isDrawing",value:function(){return this.inputIsDrawing}},{key:"setColor",value:function(e){this.settingColor!==e&&(this.settingColor=e,this.settingColorStr="rgb("+this.settingColor.r+","+this.settingColor.g+","+this.settingColor.b+")")}},{key:"setContext",value:function(e){this.context=e}},{key:"setHistory",value:function(e){this.history=e}},{key:"setSize",value:function(e){this.settingSize=Math.round(2*e)/2}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"setSpacing",value:function(e){this.settingSpacing=e}},{key:"sizePressure",value:function(e){this.settingHasSizePressure=e}},{key:"opacityPressure",value:function(e){this.settingHasOpacityPressure=e}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=e}},{key:"setIsEraser",value:function(e){this.settingIsEraser=e}},{key:"setUseDither",value:function(e){this.settingUseDither=e}},{key:"getSpacing",value:function(){return this.settingSpacing}},{key:"getSize",value:function(){return this.settingSize}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}},{key:"getIsEraser",value:function(){return this.settingIsEraser}},{key:"getUseDither",value:function(){return this.settingUseDither}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),nV=function(){function e(){(0,O._)(this,e),this.size=30,this.spacing=.4,this.opacity=1,this.useSizePressure=!0,this.useOpacityPressure=!1,this.isTransparentBG=!1,this.history=new rW.DecoyKlHistory,this.isBaseLayer=!1,this.context={},this.started=!1,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0}}return(0,D._)(e,[{key:"drawDot",value:function(e,t,i,n){this.context.save(),this.isBaseLayer?this.isTransparentBG?this.context.globalCompositeOperation="destination-out":this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out";var r=this.context.createRadialGradient(i,i,0,i,i,i),a=Math.pow(n,2);a=Math.max(0,Math.min((i-1)/i,a));var s=Math.max(0,Math.min(1,n));r.addColorStop(a,"rgba(".concat(eA,", ").concat(eA,", ").concat(eA,", ")+(2*s-s*s)+")"),r.addColorStop(1,"rgba(".concat(eA,", ").concat(eA,", ").concat(eA,", 0)")),this.context.fillStyle=r,this.context.translate(e-i,t-i),this.context.fillRect(0,0,2*i,2*i),this.context.restore()}},{key:"continueLine",value:function(e,t,i){var n,r,a=this;i=Math.max(0,Math.min(1,i));var s=this.useSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size),o=Math.max(1,Math.max(.5,1-this.opacity)*s*this.spacing),l=function(e){var t=e.t;n=a.lastInput2.pressure*(1-t)+i*t,r=a.useOpacityPressure?a.opacity*n*n:a.opacity,s=a.useSizePressure?Math.max(.1,n*a.size):Math.max(.1,a.size),a.drawDot(e.x,e.y,s,r)};void 0===e||void 0===t?this.bezierLine.addFinal(o,l):this.bezierLine.add(e,t,o,l)}},{key:"startLine",value:function(e,t,i){this.historyEntry={tool:["brush","EraserBrush"],actions:[{action:"opacityPressure",params:[this.useOpacityPressure]},{action:"sizePressure",params:[this.useSizePressure]},{action:"setSize",params:[this.size]},{action:"setOpacity",params:[this.opacity]},{action:"setTransparentBG",params:[this.isTransparentBG]},{action:"startLine",params:[e,t,i]}]},this.isBaseLayer=0===this.context.canvas.index,i=Math.max(0,Math.min(1,i));var n=this.useOpacityPressure?this.opacity*i*i:this.opacity,r=this.useSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size);this.started=!0,r>1&&this.drawDot(e,t,r,n),this.lastDot=r*this.spacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2=(0,W.BB).copyObj(this.lastInput),this.bezierLine=new W.BB.BezierLine,this.bezierLine.add(e,t,0,function(){})}},{key:"goLine",value:function(e,t,i){var n;this.started&&this.historyEntry&&(null===(n=this.historyEntry.actions)||void 0===n||n.push({action:"goLine",params:[e,t,i]}),this.continueLine(e,t,this.lastInput.pressure),this.lastInput2=(0,W.BB).copyObj(this.lastInput),this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i)}},{key:"endLine",value:function(){if(this.bezierLine&&this.continueLine(void 0,void 0,this.lastInput.pressure),this.started=!1,this.bezierLine=void 0,this.historyEntry){var e;null===(e=this.historyEntry.actions)||void 0===e||e.push({action:"endLine",params:[]}),this.history.push(this.historyEntry),this.historyEntry=void 0}}},{key:"drawLineSegment",value:function(e,t,i,n){if(this.isBaseLayer=0===this.context.canvas.index,this.lastInput.x=i,this.lastInput.y=n,!this.started&&void 0!==e){var r,a=Math.sqrt(Math.pow(i-e,2)+Math.pow(n-t,2)),s=(i-e)/a,o=(n-t)/a,l=Math.max(1,Math.max(.5,1-this.opacity)*this.size*this.spacing);for(this.lastDot=0,r=this.lastDot;r<=a;r+=l)this.drawDot(e+s*r,t+o*r,this.size,this.opacity);var h={tool:["brush","EraserBrush"],actions:[{action:"opacityPressure",params:[this.useOpacityPressure]},{action:"sizePressure",params:[this.useSizePressure]},{action:"setSize",params:[this.size]},{action:"setOpacity",params:[this.opacity]},{action:"setTransparentBG",params:[this.isTransparentBG]},{action:"drawLineSegment",params:[e,t,i,n]}]};this.history.push(h)}}},{key:"isDrawing",value:function(){return this.started}},{key:"setContext",value:function(e){this.context=e}},{key:"setHistory",value:function(e){this.history=e}},{key:"setSize",value:function(e){this.size=e}},{key:"setOpacity",value:function(e){this.opacity=e}},{key:"sizePressure",value:function(e){this.useSizePressure=e}},{key:"opacityPressure",value:function(e){this.useOpacityPressure=e}},{key:"setTransparentBG",value:function(e){this.isTransparentBG=e}},{key:"getSize",value:function(){return this.size}},{key:"getOpacity",value:function(){return this.opacity}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),ts=I("eg83P"),nH=function(){function e(){(0,O._)(this,e),this.context={},this.history=new rW.DecoyKlHistory,this.settingColor={r:0,g:0,b:0},this.settingSize=35,this.settingSpacing=.20446882736951905,this.settingOpacity=.8,this.settingHasSizePressure=!1,this.settingHasOpacityPressure=!1,this.settingLockLayerAlpha=!1,this.lineToolLastDot=0,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.isDrawing=!1,this.copyImageData={},this.drawBuffer=[],this.copiedCells=[]}return(0,D._)(e,[{key:"resetRedrawBounds",value:function(){this.redrawBounds=void 0}},{key:"updateRedrawBounds",value:function(e){this.redrawBounds=(0,W.BB).updateBounds(this.redrawBounds,e)}},{key:"updateCompleteRedrawBounds",value:function(e,t,i,n){this.completeRedrawBounds=(0,W.BB).updateBounds(this.completeRedrawBounds,{x1:e,y1:t,x2:i,y2:n})}},{key:"copyFromCanvas",value:function(){var e=this,t=this.copiedCells.map(function(){return!1}),i=[],n=Math.ceil(this.copyImageData.width/256);this.redrawBounds&&(i.push({x1:Math.floor(this.redrawBounds.x1/256),y1:Math.floor(this.redrawBounds.y1/256),x2:Math.floor(this.redrawBounds.x2/256),y2:Math.floor(this.redrawBounds.y2/256)}),i.forEach(function(e){for(var i=e.x1;i<=e.x2;i++)for(var r=e.y1;r<=e.y2;r++)t[r*n+i]=!0}),t.forEach(function(t,i){if(t&&!e.copiedCells[i]){e.copiedCells[i]=!0;var r=i%n,a=Math.floor(i/n),s=(Math.min(256*r+256,e.copyImageData.width)-1)%256+1,o=(Math.min(256*a+256,e.copyImageData.height)-1)%256+1,l=(0,W.BB).canvas(s,o),h=(0,W.BB).ctx(l);h.drawImage(e.context.canvas,-(256*r),-(256*a));for(var c=h.getImageData(0,0,s,o),u=0;u<o;u++)for(var p=0,d=u*s*4,g=((256*a+u)*e.copyImageData.width+256*r)*4;p<s;p++,d+=4,g+=4)e.copyImageData.data[g]=c.data[d],e.copyImageData.data[g+1]=c.data[d+1],e.copyImageData.data[g+2]=c.data[d+2],e.copyImageData.data[g+3]=c.data[d+3]}}))}},{key:"prepDot",value:function(e,t,i,n){if(!this.lastDot){this.lastDot={x:e,y:t};return}var r=Math.round(2*(i=Math.round(i))),a=Math.round(2*i),s=function(e,t,i,n,r){if(i.x===n.x&&i.y===n.y)return null;i=(0,W.BB).copyObj(i),n=(0,W.BB).copyObj(n),r=(0,W.BB).copyObj(r);var a=0,s=0,o=0,l=0;return(i.x<0&&(l=-i.x),i.y<0&&(a=-i.y),n.x<0&&(l=Math.max(l,-n.x)),n.y<0&&(a=Math.max(a,-n.y)),i.x+r.w>e&&(s=i.x+r.w-e),i.y+r.h>t&&(o=i.y+r.h-t),n.x+r.w>e&&(s=Math.max(s,n.x+r.w-e)),n.y+r.h>t&&(o=Math.max(o,n.y+r.h-t)),i.x+=l,n.x+=l,i.y+=a,n.y+=a,r.w=r.w-l-s,r.h=r.h-a-o,r.w<=0||r.h<=0)?null:{aP:{x:i.x,y:i.y},bP:{x:n.x,y:n.y},size:{w:r.w,h:r.h}}}(this.copyImageData.width,this.copyImageData.height,{x:Math.round(this.lastDot.x-i),y:Math.round(this.lastDot.y-i)},{x:Math.round(e-i),y:Math.round(t-i)},{w:r,h:a});if(s){var o={aP:s.aP,bP:s.bP,size:s.size,brush:{center:{x:e,y:t},size:i,opacity:n,alphaLock:this.settingLockLayerAlpha}};this.updateRedrawBounds({x1:o.bP.x,y1:o.bP.y,x2:o.bP.x+2*o.brush.size,y2:o.bP.y+2*o.brush.size}),this.drawBuffer.push(o)}this.lastDot={x:e,y:t}}},{key:"continueLine",value:function(e,t,i,n){var r=this;this.drawBuffer=[],this.bezierLine||(this.bezierLine=new W.BB.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,function(){}));var a=[],s=function(e){var t=(0,W.BB).mix(r.lastInput2.pressure,n,e.t),i=r.settingOpacity*(r.settingHasOpacityPressure?t*t:1),s=Math.max(.1,r.settingSize*(r.settingHasSizePressure?t:1));a.push([e.x,e.y,s,i])},o=i*this.settingSpacing/3;void 0===e||void 0===t?this.bezierLine.addFinal(o,s):this.bezierLine.add(e,t,o,s);for(var l=0;l<a.length;l++){var h=a[l];this.prepDot(h[0],h[1],h[2],h[3])}this.copyFromCanvas();for(var c=0;c<this.drawBuffer.length;c++)!function(e,t){for(var i=(t=(0,W.BB).copyObj(t)).brush.size,n=t.brush.center.x,r=t.brush.center.y,a=t.aP.y*e.width+t.aP.x,s=(t.bP.y*e.width+t.bP.x-a)*4,o=0,l=i>30?1024:512,h=[],c=0;c<l;c++)h[c]=(Math.random()-.5)/1.001+.5;var u=Math.max(3,Math.min(8,t.brush.size-8)),p=function(a,s,c,p){var d,g=(0,W.BB).dist(n,r,c,p),f=1-t.brush.opacity*(1-(0,ts.clamp)((g-(i-u))/u,0,1));1!==f&&(e.data[a+3]&&(e.data[s+3]?(d=e.data[a+3]<e.data[s+3]?1-e.data[a+3]/e.data[s+3]*(1-f):e.data[s+3]/e.data[a+3]*f,e.data[s]=Math.floor((0,W.BB).mix(e.data[a],e.data[s+0],d)+h[o]),e.data[s+1]=Math.floor((0,W.BB).mix(e.data[a+1],e.data[s+1],d)+h[o]),e.data[s+2]=Math.floor((0,W.BB).mix(e.data[a+2],e.data[s+2],d)+h[o]),o=(o+1)%l):(e.data[s]=e.data[a],e.data[s+1]=e.data[a+1],e.data[s+2]=e.data[a+2])),t.brush.alphaLock||(e.data[s+3]=Math.floor((0,W.BB).mix(e.data[a+3],e.data[s+3],f)+.5)))},d=4*t.bP.x,g=d+(t.size.w-1)*4;if(t.aP.y<t.bP.y)for(var f=t.size.h-1,v=t.bP.y+t.size.h-1;f>=0;f--,v--)for(var m=(f+t.bP.y)*e.width*4,y=g+m,x=g+m-s,b=t.bP.x+t.size.w-1;y>=d+m;y-=4,x-=4,b--)p(x,y,b,v);else if(t.aP.y>t.bP.y)for(var B=0,w=t.bP.y;B<t.size.h;B++,w++)for(var k=(B+t.bP.y)*e.width*4,C=g+k,S=g+k-s,E=t.bP.x+t.size.w-1;C>=d+k;C-=4,S-=4,E--)p(S,C,E,w);else if(t.aP.x<t.bP.x)for(var I=t.size.h-1,A=t.bP.y+t.size.h-1;I>=0;I--,A--)for(var T=(I+t.bP.y)*e.width*4,M=g+T,L=g+T-s,R=t.bP.x+t.size.w-1;M>=d+T;M-=4,L-=4,R--)p(L,M,R,A);else for(var P=0,O=t.bP.y;P<t.size.h;P++,O++)for(var D=(P+t.bP.y)*e.width*4,z=d+D,_=d+D-s,j=t.bP.x;z<g+D;z+=4,_+=4,j++)p(_,z,j,O)}(this.copyImageData,this.drawBuffer[c])}},{key:"startLine",value:function(e,t,i){this.historyEntry={tool:["brush","SmudgeBrush"],actions:[]},i=(0,W.BB).clamp(i,0,1);var n=this.settingHasOpacityPressure?this.settingOpacity*i*i:this.settingOpacity,r=this.settingHasSizePressure?Math.max(.1,i*this.settingSize):Math.max(.1,this.settingSize);this.lastDot=void 0,this.isDrawing=!0,this.copyImageData=new ImageData(this.context.canvas.width,this.context.canvas.height);var a=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.copiedCells="0".repeat(a).split("").map(function(){return!1}),this.prepDot(e,t,r,n),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=e,this.lastInput.y=t,this.lastInput.pressure=i,this.lastInput2.pressure=i,this.completeRedrawBounds=void 0}},{key:"goLine",value:function(e,t,i){if(this.isDrawing){this.resetRedrawBounds();var n=(0,W.BB).clamp(i,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(e,t,r,this.lastInput.pressure),this.redrawBounds&&(this.context.putImageData(this.copyImageData,0,0,this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2-this.redrawBounds.x1-1,this.redrawBounds.y2-this.redrawBounds.y1-1),this.updateCompleteRedrawBounds(this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2,this.redrawBounds.y2)),this.lastInput.x=e,this.lastInput.y=t,this.lastInput2.pressure=this.lastInput.pressure,this.lastInput.pressure=n}}},{key:"endLine",value:function(){this.resetRedrawBounds();var e=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);if(this.context.save(),this.continueLine(void 0,void 0,e,this.lastInput.pressure),this.context.restore(),this.isDrawing=!1,this.bezierLine=void 0,this.redrawBounds&&(this.context.putImageData(this.copyImageData,0,0,this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2-this.redrawBounds.x1-1,this.redrawBounds.y2-this.redrawBounds.y1-1),this.updateCompleteRedrawBounds(this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2,this.redrawBounds.y2)),this.historyEntry&&this.completeRedrawBounds){var t=this.copyImageData;if(!(0===this.completeRedrawBounds.x1&&0===this.completeRedrawBounds.y1&&this.completeRedrawBounds.x2>=this.context.canvas.width-1&&this.completeRedrawBounds.y2>=this.context.canvas.height-1)){var i=(0,W.BB).canvas(this.completeRedrawBounds.x2-this.completeRedrawBounds.x1+1,this.completeRedrawBounds.y2-this.completeRedrawBounds.y1+1);(0,W.BB).ctx(i).drawImage(this.context.canvas,-this.completeRedrawBounds.x1,-this.completeRedrawBounds.y1),t=i}this.historyEntry.actions.push({action:"drawImage",params:[t,this.completeRedrawBounds.x1,this.completeRedrawBounds.y1]}),this.history.push(this.historyEntry),this.historyEntry=void 0}this.copyImageData={}}},{key:"drawImage",value:function(e,t,i){e instanceof ImageData?this.context.putImageData(e,t,i):(this.context.clearRect(t,i,e.width,e.height),this.context.drawImage(e,t,i))}},{key:"drawLineSegment",value:function(e,t,i,n){}},{key:"getIsDrawing",value:function(){return this.isDrawing}},{key:"setColor",value:function(e){(this.settingColor.r!==e.r||this.settingColor.g!==e.g||this.settingColor.b!==e.b)&&(this.settingColor={r:e.r,g:e.g,b:e.b})}},{key:"setContext",value:function(e){this.context=e}},{key:"setHistory",value:function(e){this.history=e}},{key:"setSize",value:function(e){this.settingSize=e}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"setSpacing",value:function(e){this.settingSpacing=e}},{key:"sizePressure",value:function(e){this.settingHasSizePressure=e}},{key:"opacityPressure",value:function(e){this.settingHasOpacityPressure=e}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=e}},{key:"getSpacing",value:function(){return this.settingSpacing}},{key:"getSize",value:function(){return this.settingSize}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),W=I("eWjiX"),nW={PenBrush:nO,BlendBrush:nD,SketchyBrush:nj,PixelBrush:nF,ChemyBrush:function(){function e(){(0,O._)(this,e),this.context={},this.settingColor={},this.settingSize=.25,this.settingOpacity=1,this.settingLockLayerAlpha=!1,this.settingIsEraser=!1,this.settingMode="fill",this.settingDistort=0,this.settingXSymmetry=!1,this.settingYSymmetry=!1,this.settingGradient=!1,this.isDrawing=!1,this.history=new rW.DecoyKlHistory,this.copyCanvas={},this.path=[],this.minY=0,this.maxY=0}return(0,D._)(e,[{key:"updateCompleteRedrawBounds",value:function(e,t){var i={x1:e,y1:t,x2:e,y2:t};this.settingXSymmetry&&(i=(0,W.BB).updateBounds(i,{x1:-e+this.copyCanvas.width,y1:t,x2:-e+this.copyCanvas.width,y2:t})),this.settingYSymmetry&&(i=(0,W.BB).updateBounds(i,{x1:e,y1:-t+this.copyCanvas.height,x2:e,y2:-t+this.copyCanvas.height}));var n="stroke"===this.settingMode?this.settingSize+1:1;i.x1=Math.floor(i.x1-n),i.y1=Math.floor(i.y1-n),i.x2=Math.ceil(i.x2+n),i.y2=Math.ceil(i.y2+n),this.completeRedrawBounds=(0,W.BB).updateBounds(this.completeRedrawBounds,i)}},{key:"drawShape",value:function(){var e=this;this.context.save(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.drawImage(this.copyCanvas,0,0);var t=(0,X._)({},this.settingColor);if(this.settingIsEraser?(t.r=eA,t.g=eA,t.b=eA,this.settingLockLayerAlpha?this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out"):this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop"),this.path.length>1){var i=new Path2D;this.path.forEach(function(e,t){0===t?i.moveTo(e.x,e.y):i.lineTo(e.x,e.y)});var n=(0,W.BB).ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:this.settingOpacity});if(this.settingGradient){var r=this.path[0].x>this.path[this.path.length-1].x,a=this.context.createLinearGradient(0,r?this.minY:this.maxY,0,r?this.maxY:this.minY);a.addColorStop(0,(0,W.BB).ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:this.settingOpacity})),a.addColorStop(1,(0,W.BB).ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:0})),n=a}"fill"===this.settingMode?this.context.fillStyle=n:(this.context.lineWidth=2*this.settingSize,this.context.lineJoin="bevel",this.context.strokeStyle=n);var s=function(){"fill"===e.settingMode?e.context.fill(i):e.context.stroke(i)};s(),this.settingXSymmetry&&(this.context.save(),this.context.translate(this.context.canvas.width/2,0),this.context.scale(-1,1),this.context.translate(-this.context.canvas.width/2,0),s(),this.context.restore()),this.settingYSymmetry&&(this.context.save(),this.context.translate(0,this.context.canvas.height/2),this.context.scale(1,-1),this.context.translate(0,-this.context.canvas.height/2),s(),this.context.restore(),this.settingXSymmetry&&(this.context.save(),this.context.translate(this.context.canvas.width/2,this.context.canvas.height/2),this.context.scale(-1,-1),this.context.translate(-this.context.canvas.width/2,-this.context.canvas.height/2),s(),this.context.restore()))}this.context.restore()}},{key:"setHistory",value:function(e){this.history=e}},{key:"getSize",value:function(){return"stroke"===this.settingMode?this.settingSize:0}},{key:"setSize",value:function(e){this.settingSize=e}},{key:"getOpacity",value:function(){return this.settingOpacity}},{key:"setOpacity",value:function(e){this.settingOpacity=e}},{key:"setColor",value:function(e){this.settingColor=(0,W.BB).copyObj(e)}},{key:"setContext",value:function(e){this.context=e}},{key:"setMode",value:function(e){this.settingMode=e}},{key:"getMode",value:function(){return this.settingMode}},{key:"setDistort",value:function(e){this.settingDistort=(0,W.BB).clamp(e,0,1)}},{key:"getDistort",value:function(){return this.settingDistort}},{key:"setXSymmetry",value:function(e){this.settingXSymmetry=e}},{key:"getXSymmetry",value:function(){return this.settingXSymmetry}},{key:"setYSymmetry",value:function(e){this.settingYSymmetry=e}},{key:"getYSymmetry",value:function(){return this.settingYSymmetry}},{key:"setGradient",value:function(e){this.settingGradient=e}},{key:"getGradient",value:function(){return this.settingGradient}},{key:"getLockAlpha",value:function(){return this.settingLockLayerAlpha}},{key:"setLockAlpha",value:function(e){this.settingLockLayerAlpha=e}},{key:"getIsEraser",value:function(){return this.settingIsEraser}},{key:"setIsEraser",value:function(e){this.settingIsEraser=e}},{key:"getIsDrawing",value:function(){return this.isDrawing}},{key:"startLine",value:function(e,t){this.isDrawing=!0,this.path=[{x:e,y:t}],this.minY=t,this.maxY=t,this.copyCanvas=(0,W.BB).canvas(this.context.canvas.width,this.context.canvas.height),(0,W.BB).ctx(this.copyCanvas).drawImage(this.context.canvas,0,0),this.completeRedrawBounds=void 0,this.updateCompleteRedrawBounds(e,t)}},{key:"goLine",value:function(e,t){if(this.isDrawing){var i={x:e,y:t};this.settingDistort>0&&(i.x+=(Math.random()-.5)*this.settingDistort*80,i.y+=(Math.random()-.5)*this.settingDistort*80),this.minY=Math.min(this.minY,i.y),this.maxY=Math.max(this.maxY,i.y),this.path.push(i),this.updateCompleteRedrawBounds(e,t),this.drawShape()}}},{key:"endLine",value:function(){if(this.isDrawing=!1,this.completeRedrawBounds=(0,W.BB).boundsInArea(this.completeRedrawBounds,this.copyCanvas.width,this.copyCanvas.height),this.path.length>1&&this.completeRedrawBounds){var e=(0,W.BB).canvas(this.completeRedrawBounds.x2-this.completeRedrawBounds.x1+1,this.completeRedrawBounds.y2-this.completeRedrawBounds.y1+1);(0,W.BB).ctx(e).drawImage(this.context.canvas,-this.completeRedrawBounds.x1,-this.completeRedrawBounds.y1),this.history.push({tool:["brush","ChemyBrush"],actions:[{action:"drawImage",params:[e,this.completeRedrawBounds.x1,this.completeRedrawBounds.y1]}]})}this.path=[],this.copyCanvas={}}},{key:"drawImage",value:function(e,t,i){this.context.save(),this.context.clearRect(t,i,e.width,e.height),this.context.drawImage(e,t,i),this.context.restore()}},{key:"drawLineSegment",value:function(e,t,i,n){}}]),e}(),SmudgeBrush:nH,EraserBrush:nV},W=I("eWjiX"),nX=(o={image:t(I("f6OTe").getBundleURL("lYbF2")+"brush-pen.49a7b91e.svg"),tooltip:J("brush-pen"),sizeSlider:{min:.5,max:100,curve:(0,W.BB).quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1,curve:[[0,.01],[.5,.3],[1,1]]}},l=[J("brush-pen-circle"),J("brush-pen-chalk"),J("brush-pen-calligraphy"),J("brush-pen-square")],Z.subscribe(function(){o.tooltip=J("brush-pen"),l=[J("brush-pen-circle"),J("brush-pen-chalk"),J("brush-pen-calligraphy"),J("brush-pen-square")]}),o.Ui=function(e){var t,i,n,r,a=document.createElement("div"),s=new nW.PenBrush;s.setHistory(V),e.onSizeChange(s.getSize());var h=new eD({optionArr:[0,1,2,3].map(function(e){var t=(0,W.BB).el({className:"dark-invert",css:{width:"31px",height:"31px",backgroundSize:"contain",margin:"2px"}}),i=(0,W.BB).canvas(70,70),n=(0,W.BB).ctx(i);return 0===e||3===e?0===e?(n.beginPath(),n.arc(35,35,30,0,2*Math.PI),n.closePath(),n.fill()):n.fillRect(5,5,60,60):1===e?n.drawImage(nM(60),5,5):2===e&&n.drawImage(nL(60),5,5),t.style.backgroundImage="url("+i.toDataURL("image/png")+")",{id:e,label:t,title:l[e]}}),initId:0,onChange:function(e){s.setAlpha(e)}}),c=new en({init:s.getLockAlpha(),label:J("lock-alpha"),callback:function(e){s.setLockAlpha(e)},doHighlight:!0,title:J("lock-alpha-title"),css:{display:"inline-block"}}),u=new W.BB.SplineInterpolator([[0,15],[8,7],[14,4],[30,3],[50,2.7],[100,2]]);function p(e){s.setSize(e),s.setSpacing(Math.max(2,u.interpolate(e))/15)}n=new ed({label:J("brush-size"),width:225,height:30,min:o.sizeSlider.min,max:o.sizeSlider.max,value:s.getSize(),curve:o.sizeSlider.curve,eventResMs:20,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){p(t),e.onSizeChange(t)},formatFunc:function(e){return e<10?(0,W.BB).round(e,1):Math.round(e)},manualInputRoundDigits:1}),r=new ed({label:J("opacity"),width:225,height:30,min:o.opacitySlider.min,max:o.opacitySlider.max,value:o.opacitySlider.max,curve:o.opacitySlider.curve,eventResMs:20,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){s.setOpacity(t),e.onOpacityChange(t)}}),t=ec(!0,function(e){s.sizePressure(e)}),i=ec(!1,function(e){s.opacityPressure(e)}),a.append((0,W.BB).el({content:[n.getElement(),t],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),(0,W.BB).el({content:[r.getElement(),i],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),(0,W.BB).el({content:h.getElement(),css:{marginTop:"10px"}}),(0,W.BB).el({content:c.getElement(),css:{marginTop:"10px"}})),this.increaseSize=function(e){s.isDrawing()||n.changeSliderValue(e)},this.decreaseSize=function(e){s.isDrawing()||n.changeSliderValue(-e)},this.getSize=function(){return s.getSize()},this.setSize=function(e){p(e),n.setValue(e)},this.getOpacity=function(){return s.getOpacity()},this.setOpacity=function(e){s.setOpacity(e),r.setValue(e)},this.setColor=function(e){s.setColor(e)},this.setContext=function(e){s.setContext(e)},this.startLine=function(e,t,i){s.startLine(e,t,i)},this.goLine=function(e,t,i){s.goLine(e,t,i)},this.endLine=function(e,t){s.endLine(e,t)},this.getBrush=function(){return s},this.isDrawing=function(){return s.isDrawing()},this.getElement=function(){return a}},o),W=I("eWjiX"),nN=(h={image:t(I("f6OTe").getBundleURL("lYbF2")+"brush-blend.3706e8a1.svg"),tooltip:J("brush-blend"),sizeSlider:{min:.5,max:100,curve:(0,W.BB).quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1}},Z.subscribe(function(){h.tooltip=J("brush-blend")}),h.Ui=function(e){var t,i,n,r,a,s,o=document.createElement("div"),l=new nW.BlendBrush;function c(e){l.setSize(e)}l.setHistory(V),e.onSizeChange(l.getSize()),a=new ed({label:J("brush-size"),width:225,height:30,min:h.sizeSlider.min,max:h.sizeSlider.max,value:58,curve:h.sizeSlider.curve,eventResMs:20,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){c(t),e.onSizeChange(t)}}),s=new ed({label:J("opacity"),width:225,height:30,min:h.opacitySlider.min,max:h.opacitySlider.max,value:l.getOpacity(),curve:h.opacitySlider.curve,eventResMs:20,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){l.setOpacity(t),e.onOpacityChange(t)}}),(t=new ed({label:J("brush-blending"),width:225,height:30,min:0,max:1,value:l.getBlending(),eventResMs:20,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(e){l.setBlending(e)}})).getElement().style.marginTop="10px",i=ec(!0,function(e){l.setSizePressure(e)}),n=ec(!1,function(e){l.setOpacityPressure(e)}),r=new en({init:l.getLockAlpha(),label:J("lock-alpha"),callback:function(e){l.setLockAlpha(e)},doHighlight:!0,title:J("lock-alpha-title"),css:{marginTop:"10px",display:"inline-block"}}),o.append((0,W.BB).el({content:[a.getElement(),i],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),(0,W.BB).el({content:[s.getElement(),n],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),t.getElement(),r.getElement()),this.increaseSize=function(e){l.getIsDrawing()||a.changeSliderValue(e)},this.decreaseSize=function(e){l.getIsDrawing()||a.changeSliderValue(-e)},this.getSize=function(){return l.getSize()},this.setSize=function(e){c(e),a.setValue(e)},this.getOpacity=function(){return l.getOpacity()},this.setOpacity=function(e){l.setOpacity(e),s.setValue(e)},this.setColor=function(e){l.setColor(e)},this.setContext=function(e){l.setContext(e)},this.startLine=function(e,t,i){l.startLine(e,t,i)},this.goLine=function(e,t,i,n){l.goLine(e,t,i,n)},this.endLine=function(){l.endLine()},this.getBrush=function(){return l},this.isDrawing=function(){return l.getIsDrawing()},this.getElement=function(){return o}},h),nY={};nY=I("f6OTe").getBundleURL("lYbF2")+"brush-sketchy.4c477c01.png";var W=I("eWjiX"),nU=(c={image:t(nY),tooltip:J("brush-sketchy"),sizeSlider:{min:.5,max:10},opacitySlider:{min:.01,max:1}},Z.subscribe(function(){c.tooltip=J("brush-sketchy")}),c.Ui=function(e){var t,i,n,r,a=document.createElement("div"),s=new nW.SketchyBrush;s.setHistory(V),e.onSizeChange(s.getSize()),n=new ed({label:J("brush-size"),width:250,height:30,min:c.sizeSlider.min,max:c.sizeSlider.max,value:2*s.getSize(),eventResMs:20,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){s.setSize(t),e.onSizeChange(t)},formatFunc:function(e){return e<10?(0,W.BB).round(e,1):Math.round(e)},manualInputRoundDigits:1}),r=new ed({label:J("opacity"),width:250,height:30,min:c.opacitySlider.min,max:c.opacitySlider.max,value:s.getOpacity(),eventResMs:20,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){s.setOpacity(t),e.onOpacityChange(t)}}),t=new ed({label:J("brush-blending"),width:250,height:30,min:0,max:1,value:s.getBlending(),eventResMs:20,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(e){s.setBlending(e)}}),i=new ed({label:J("brush-sketchy-scale"),width:250,height:30,min:1,max:20,value:s.getScale(),eventResMs:20,onChange:function(e){s.setScale(e)}}),r.getElement().style.marginTop="10px",t.getElement().style.marginTop="10px",i.getElement().style.marginTop="10px",a.append(n.getElement(),r.getElement(),t.getElement(),i.getElement()),this.increaseSize=function(e){s.isDrawing()||n.changeSliderValue(e)},this.decreaseSize=function(e){s.isDrawing()||n.changeSliderValue(-e)},this.getSize=function(){return s.getSize()},this.setSize=function(e){s.setSize(e),n.setValue(e)},this.getOpacity=function(){return s.getOpacity()},this.setOpacity=function(e){s.setOpacity(e),r.setValue(e)},this.setColor=function(e){s.setColor(e)},this.setContext=function(e){s.setContext(e)},this.startLine=function(e,t,i){s.startLine(e,t,i)},this.goLine=function(e,t,i){s.goLine(e,t,i,void 0)},this.endLine=function(){s.endLine()},this.getSeed=function(){return parseInt(""+s.getSeed())},this.setSeed=function(e){s.setSeed(parseInt(""+e))},this.getBrush=function(){return s},this.isDrawing=function(){return s.isDrawing()},this.getElement=function(){return a}},c),W=I("eWjiX"),nG=(u={image:t(I("f6OTe").getBundleURL("lYbF2")+"brush-pixel.673f3e4c.svg"),tooltip:J("brush-pixel"),sizeSlider:{min:.5,max:100,curve:(0,W.BB).quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1,curve:[[0,.01],[.5,.3],[1,1]]}},Z.subscribe(function(){u.tooltip=J("brush-pixel")}),u.Ui=function(e){var t,i,n,r=document.createElement("div"),a=new nW.PixelBrush;a.setHistory(V),e.onSizeChange(a.getSize());var s=new en({init:a.getLockAlpha(),label:J("lock-alpha"),callback:function(e){a.setLockAlpha(e)},doHighlight:!0,title:J("lock-alpha-title"),css:{marginRight:"10px"}}),o=new en({init:a.getIsEraser(),label:J("eraser"),callback:function(e){a.setIsEraser(e)},css:{marginRight:"10px"}}),l=new en({init:a.getUseDither(),label:J("brush-pixel-dither"),callback:function(e){a.setUseDither(e)}}),h=new W.BB.SplineInterpolator([[.5,.45],[100,4]]);function c(e){a.setSize(e),a.setSpacing(h.interpolate(e)/e)}i=new ed({label:J("brush-size"),width:225,height:30,min:u.sizeSlider.min,max:u.sizeSlider.max,value:a.getSize(),curve:u.sizeSlider.curve,eventResMs:20,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){c(t),e.onSizeChange(t)}}),n=new ed({label:J("opacity"),width:225,height:30,min:u.opacitySlider.min,max:u.opacitySlider.max,value:u.opacitySlider.max,eventResMs:20,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){a.setOpacity(t),e.onOpacityChange(t)}}),t=ec(!0,function(e){a.sizePressure(e)}),r.append((0,W.BB).el({content:[i.getElement(),t],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),n.getElement()),(0,W.BB).el({parent:r,css:{display:"flex",marginTop:"10px"}}).append(s.getElement(),o.getElement(),l.getElement()),this.increaseSize=function(e){a.isDrawing()||i.changeSliderValue(e)},this.decreaseSize=function(e){a.isDrawing()||i.changeSliderValue(-e)},this.getSize=function(){return a.getSize()},this.setSize=function(e){c(e),i.setValue(2*e)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(e){a.setOpacity(e),n.setValue(100*e)},this.setColor=function(e){a.setColor(e)},this.setContext=function(e){a.setContext(e)},this.startLine=function(e,t,i){a.startLine(e,t,i)},this.goLine=function(e,t,i){a.goLine(e,t,i)},this.endLine=function(e,t){a.endLine(e,t)},this.getBrush=function(){return a},this.isDrawing=function(){return a.isDrawing()},this.toggleEraser=function(){o.setValue(!o.getValue()),a.setIsEraser(o.getValue())},this.getElement=function(){return r}},u),W=I("eWjiX"),nK=(p={image:t(I("f6OTe").getBundleURL("lYbF2")+"brush-eraser.a9e10dce.svg"),tooltip:J("eraser")+" [E]",sizeSlider:{min:.5,max:200,curve:(0,W.BB).quadraticSplineInput(.5,200,.1)},opacitySlider:{min:.01,max:1}},Z.subscribe(function(){p.tooltip=J("eraser")+" [E]"}),p.Ui=function(e){var t,i,n,r,a,s=document.createElement("div"),o=new nW.EraserBrush;o.setHistory(V),e.onSizeChange(o.getSize());var l=!1;function h(e){o.setSize(e)}r=new ed({label:J("brush-size"),width:225,height:30,min:p.sizeSlider.min,max:p.sizeSlider.max,value:30,curve:p.sizeSlider.curve,eventResMs:20,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){h(t),e.onSizeChange(t)},formatFunc:function(e){return e<10?(0,W.BB).round(e,1):Math.round(e)},manualInputRoundDigits:1}),a=new ed({label:J("opacity"),width:225,height:30,min:p.opacitySlider.min,max:p.opacitySlider.max,value:p.opacitySlider.max,eventResMs:20,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){o.setOpacity(t),e.onOpacityChange(t)}}),t=ec(!0,function(e){o.sizePressure(e)}),i=ec(!1,function(e){o.opacityPressure(e)}),s.append((0,W.BB).el({content:[r.getElement(),t],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),(0,W.BB).el({content:[a.getElement(),i],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}})),n=new en({init:!1,label:J("brush-eraser-transparent-bg"),callback:function(e){l=e,o.setTransparentBG(e)},css:{marginTop:"10px"}}),s.append(n.getElement()),this.increaseSize=function(e){o.isDrawing()||r.changeSliderValue(e)},this.decreaseSize=function(e){o.isDrawing()||r.changeSliderValue(-e)},this.getSize=function(){return o.getSize()},this.setSize=function(e){h(e),r.setValue(e)},this.getOpacity=function(){return o.getOpacity()},this.setOpacity=function(e){o.setOpacity(e),a.setValue(e)},this.setColor=function(){},this.setContext=function(e){o.setContext(e)},this.startLine=function(e,t,i){o.startLine(e,t,i)},this.goLine=function(e,t,i){o.goLine(e,t,i)},this.endLine=function(){o.endLine()},this.getBrush=function(){return o},this.getIsTransparentBg=function(){return l},this.isDrawing=function(){return o.isDrawing()},this.getElement=function(){return s}},p),W=I("eWjiX"),nq=(d={image:t(I("f6OTe").getBundleURL("lYbF2")+"brush-smudge.45852bcd.svg"),tooltip:J("brush-smudge"),sizeSlider:{min:.5,max:100,curve:(0,W.BB).quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1,curve:[[0,.01],[.5,.3],[1,1]]}},Z.subscribe(function(){d.tooltip=J("brush-smudge")}),d.Ui=function(e){var t,i,n,r,a=document.createElement("div"),s=new nW.SmudgeBrush;s.setHistory(V),e.onSizeChange(s.getSize());var o=new en({init:s.getLockAlpha(),label:J("lock-alpha"),callback:function(e){s.setLockAlpha(e)},doHighlight:!0,title:J("lock-alpha-title")}),l=new W.BB.SplineInterpolator([[0,15],[8,7],[14,4],[30,3],[50,2.7],[100,2]]);function h(e){s.setSize(e),s.setSpacing(Math.max(2,l.interpolate(e))/15)}n=new ed({label:J("brush-size"),width:225,height:30,min:d.sizeSlider.min,max:d.sizeSlider.max,value:s.getSize(),curve:d.sizeSlider.curve,eventResMs:20,toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){h(t),e.onSizeChange(t)},formatFunc:function(e){return e<10?(0,W.BB).round(e,1):Math.round(e)},manualInputRoundDigits:1}),r=new ed({label:J("opacity"),width:225,height:30,min:d.opacitySlider.min,max:d.opacitySlider.max,value:s.getOpacity(),curve:d.opacitySlider.curve,eventResMs:20,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){s.setOpacity(t),e.onOpacityChange(t)}}),t=ec(!1,function(e){s.sizePressure(e)}),i=ec(!1,function(e){s.opacityPressure(e)}),a.append((0,W.BB).el({content:[n.getElement(),t],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),(0,W.BB).el({content:[r.getElement(),i],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}})),(0,W.BB).el({parent:a,css:{marginTop:"10px"}}).append(o.getElement()),this.increaseSize=function(e){s.getIsDrawing()||n.changeSliderValue(e)},this.decreaseSize=function(e){s.getIsDrawing()||n.changeSliderValue(-e)},this.getSize=function(){return s.getSize()},this.setSize=function(e){h(e),n.setValue(e)},this.getOpacity=function(){return s.getOpacity()},this.setOpacity=function(e){s.setOpacity(e),r.setValue(e)},this.setColor=function(e){s.setColor(e)},this.setContext=function(e){s.setContext(e)},this.startLine=function(e,t,i){s.startLine(e,t,i)},this.goLine=function(e,t,i){s.goLine(e,t,i)},this.endLine=function(){s.endLine()},this.getBrush=function(){return s},this.isDrawing=function(){return s.getIsDrawing()},this.getElement=function(){return a}},d),W=I("eWjiX"),nQ=(g={image:t(I("f6OTe").getBundleURL("lYbF2")+"brush-chemy.a5a188f6.svg"),tooltip:J("brush-chemy"),sizeSlider:{min:.25,max:25,curve:(0,W.BB).quadraticSplineInput(.25,25,.1),isDisabled:!0},opacitySlider:{min:.01,max:1}},Z.subscribe(function(){g.tooltip=J("brush-chemy")}),g.Ui=function(e){var t,i,n,r,a,s,o,l,h,c,u=document.createElement("div"),p=new nW.ChemyBrush;function d(e){p.setSize(e)}p.setHistory(V),e.onSizeChange(p.getSize()),l=new ed({label:J("brush-size"),width:250,height:30,min:g.sizeSlider.min,max:g.sizeSlider.max,value:p.getSize(),curve:g.sizeSlider.curve,eventResMs:20,isEnabled:"stroke"===p.getMode(),toDisplayValue:function(e){return 2*e},toValue:function(e){return e/2},onChange:function(t){d(t),e.onSizeChange(t)},formatFunc:function(e){return e<5?(0,W.BB).round(e,1):Math.round(e)},manualInputRoundDigits:1}),h=new ed({label:J("opacity"),width:250,height:30,min:g.opacitySlider.min,max:g.opacitySlider.max,value:p.getOpacity(),eventResMs:20,toDisplayValue:function(e){return 100*e},toValue:function(e){return e/100},onChange:function(t){p.setOpacity(t),e.onOpacityChange(t)}}),(0,W.BB).css(h.getElement(),{marginTop:"10px"}),c=new en({init:p.getIsEraser(),label:J("eraser"),callback:function(e){p.setIsEraser(e)},css:{marginTop:"10px",marginLeft:"10px"}}),t=new en({init:p.getLockAlpha(),label:J("lock-alpha"),callback:function(e){p.setLockAlpha(e)},doHighlight:!0,title:J("lock-alpha-title"),css:{marginTop:"10px"}}),i=(0,W.BB).el({css:{display:"flex",marginTop:"10px"}}),n=new eD({optionArr:[{id:"fill",label:(0,W.BB).createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"#000",style:"transform-origin: 0 0; transform: translate(-0.5px, -0.5px) scale(".concat(19,", ").concat(19,") translate(0.5px, 0.5px)"),d:"M 0,0 C 1.5,0 -0.5,1 1,1"}]}),title:J("brush-chemy-fill")},{id:"stroke",label:(0,W.BB).createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 0.12px; transform-origin: 0 0; transform: translate(-0.5px, -0.5px) scale(".concat(19,", ").concat(19,") translate(0.5px, 0.5px)"),d:"M 0,0 C 1.5,0 -0.5,1 1,1"}]}),title:J("brush-chemy-stroke")}],initId:p.getMode(),onChange:function(t){p.setMode(t),g.sizeSlider.isDisabled="fill"===p.getMode(),l.setIsEnabled(!g.sizeSlider.isDisabled);var i=p.getSize();l.setValue(i),e.onSizeChange(i),e.onConfigChange()}}),r=new eh({label:(0,W.BB).createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 1px",d:"M ".concat(17.5,",").concat(8," ").concat(17.5,",").concat(27)}]}),title:J("brush-chemy-mirror-x"),init:p.getXSymmetry(),onChange:function(e){p.setXSymmetry(e)}}),a=new eh({label:(0,W.BB).createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 1px",d:"M ".concat(8,",").concat(17.5," ").concat(27,",").concat(17.5)}]}),title:J("brush-chemy-mirror-y"),init:p.getYSymmetry(),onChange:function(e){p.setYSymmetry(e)}}),s=new eh({label:(0,W.BB).createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"defs",childrenArr:[{elementType:"linearGradient",id:"gradient",x1:"0",y1:"0",x2:"0",y2:"1",childrenArr:[{elementType:"stop",offset:"0%","stop-color":"rgba(0,0,0,0)"},{elementType:"stop",offset:"100%","stop-color":"rgba(0,0,0,1)"}]}]},{elementType:"rect",fill:"url('#gradient')",x:"8",y:"8",width:"19",height:"19"}]}),title:J("brush-chemy-gradient"),init:p.getGradient(),onChange:function(e){p.setGradient(e)}}),(0,W.BB).css(r.getElement(),{marginLeft:"10px"}),o={marginLeft:"4px"},(0,W.BB).css(a.getElement(),o),(0,W.BB).css(s.getElement(),o),i.append(n.getElement(),r.getElement(),a.getElement(),s.getElement()),u.append(l.getElement(),h.getElement(),i,(0,W.BB).el({content:[t.getElement(),c.getElement()],css:{display:"flex"}})),this.increaseSize=function(e){p.getIsDrawing()||"stroke"!==p.getMode()||l.changeSliderValue(e)},this.decreaseSize=function(e){p.getIsDrawing()||"stroke"!==p.getMode()||l.changeSliderValue(-e)},this.getSize=function(){return p.getSize()},this.setSize=function(e){d(e),l.setValue(e)},this.getOpacity=function(){return p.getOpacity()},this.setOpacity=function(e){p.setOpacity(e),h.setValue(e)},this.setColor=function(e){p.setColor(e)},this.setContext=function(e){p.setContext(e)},this.startLine=function(e,t,i){p.startLine(e,t)},this.goLine=function(e,t,i,n){p.goLine(e,t)},this.endLine=function(){p.endLine()},this.getBrush=function(){return p},this.isDrawing=function(){return p.getIsDrawing()},this.toggleEraser=function(){c.setValue(!c.getValue()),p.setIsEraser(c.getValue())},this.getElement=function(){return u}},g),W=I("eWjiX");function nZ(e,t){if(!t&&(window.innerHeight<500||window.innerWidth<700)){window.open(e);return}var i,n=(0,W.BB).el({tagName:"iframe",custom:{src:e},css:{width:"100%",height:"100%",opacity:"0"}});setTimeout(function(){n.style.opacity=""},500);var r=(0,W.BB).el();t||(i=(0,W.BB).el({tagName:"a",parent:r,content:J("modal-new-tab"),custom:{href:"help",target:"_blank"},onClick:function(){a.close()}}),n.onload=function(){i&&n.contentWindow&&(0,W.BB).setAttributes(i,{href:""+n.contentWindow.location}),n.style.opacity=""});var a=new ei({title:r,content:n,width:880,isMaxHeight:!0,onClose:function(){i&&(n.src="about:blank",(0,W.BB).destroyEl(i),i=void 0)}})}var O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),nJ=function(){function e(t){var i=this,n=t.name,r=t.init,a=t.items,s=t.ignoreFocus;(0,O._)(this,e),this.inputs=[],this.el=(0,W.BB).el({className:"kl-radio"}),a.forEach(function(e){var t=(0,W.BB).el({tagName:"label"}),a=(0,W.BB).el({tagName:"input",parent:t,custom:{name:n,value:e.value,type:"radio"}});s&&a.setAttribute("data-ignore-focus","true"),r===e.value&&(a.checked=!0),t.append(e.label),i.el.append(t),i.inputs.push(a)})}return(0,D._)(e,[{key:"getValue",value:function(){for(var e=0;e<this.inputs.length;e++)if(this.inputs[e].checked)return this.inputs[e].value;return null}},{key:"getElement",value:function(){return this.el}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),eI=I("1C8RU"),n$=function(){function e(i,n,r,a,s){var o,l=this;(0,O._)(this,e),this.projectStore=i,this.getProject=n,this.saveReminder=r,this.klRootEl=a,this.options=s,this.previewEl={},this.infoEl={},this.ageEl={},this.storeButtonEl={},this.clearButtonEl={},this.storeListener={},this.updateCheckerboard=function(){},this.element=(0,W.BB).el({css:{display:"grid",gridTemplateColumns:"1fr 0fr",gridTemplateRows:"0fr 0fr 0fr",gap:"0 0",gridTemplateAreas:'"title title" "preview store" "preview clear"'}});var h=(0,W.BB).el({parent:this.element,content:J("file-storage"),css:{gridArea:"title",display:"flex",margin:"-5px 0",gap:"5px"}});if(this.infoEl=(0,W.BB).el({parent:h,content:"?",className:"kl-info-btn",title:J("file-storage-about"),onClick:function(){nZ("./help/#help-browser-storage",!1)}}),this.projectStore.isBroken()){(0,W.BB).el({parent:this.element,content:"\uD83D\uDD34 "+J("file-storage-cant-access"),css:{marginTop:"10px"}});return}this.previewEl=(0,W.BB).el({parent:this.element,title:J("file-storage-thumb-title"),className:"kl-storage-preview"}),this.ageEl=(0,W.BB).el({css:{position:"absolute",right:"1px",bottom:"1px",width:"calc(100% - 2px)",textAlign:"center",background:"rgba(0,0,0,0.7)",color:"#fff",textSize:"13px"}});var c=(null==s?void 0:s.isFocusable)?{}:{tabIndex:"-1"};this.storeButtonEl=(0,W.BB).el({parent:this.element,tagName:"button",className:"grid-button",content:J("file-storage-store"),css:{gridArea:"store"},custom:c,onClick:function(){return l.store()}}),this.clearButtonEl=(0,W.BB).el({parent:this.element,tagName:"button",className:"grid-button",content:'<img src="'+t(tk)+'" height="20"/> '+J("file-storage-clear"),css:{gridArea:"clear"},custom:c,onClick:function(){return l.clear()}}),(null===(o=this.options)||void 0===o?void 0:o.hideClearButton)&&(this.clearButtonEl.style.visibility="hidden"),this.storeListener={onUpdate:function(e,t){l.updateThumb(e,t)}},this.projectStore.subscribe(this.storeListener),this.updateCheckerboard=function(){l.thumbnail&&(0,W.BB).css(l.thumbnail,{background:"url('"+(0,W.BB).createCheckerCanvas(4,(0,eI.theme).isDark()).toDataURL("image/png")+"')"})},(0,eI.theme).addIsDarkListener(this.updateCheckerboard),setInterval(function(){return l.updateAge()},6e4);var u=this;M(function(){var e,t;return R(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,u.projectStore.read()];case 1:return(e=i.sent())?u.updateThumb(e.timestamp,e.thumbnail):u.updateThumb(),[3,3];case 2:return t=i.sent(),setTimeout(function(){throw Error("storage-ui: failed initial read browser storage, "+t)},0),[3,3];case 3:return[2]}})})()}return(0,D._)(e,[{key:"updateAge",value:function(){if(this.timestamp){var e,t=new Date().getTime()-this.timestamp;t=Math.floor(t/1e3/60),e=J("file-storage-min-ago").replace("{x}",""+t),t>60&&(t=Math.floor(t/60),e=J("file-storage-hours-ago").replace("{x}",""+t),t>24&&(t=Math.floor(t/24),e=J("file-storage-days-ago").replace("{x}",""+t),t>31&&(e=J("file-storage-month-ago")))),this.ageEl.textContent=e}}},{key:"resetButtons",value:function(){this.timestamp?(this.storeButtonEl.textContent=J("file-storage-overwrite"),this.storeButtonEl.disabled=!1,this.clearButtonEl.disabled=!1):(this.storeButtonEl.textContent=J("file-storage-store"),this.storeButtonEl.disabled=!1,this.clearButtonEl.disabled=!0)}},{key:"updateThumb",value:function(e,t){this.timestamp=e,this.thumbnail=t,this.timestamp&&t?(t.classList.add("kl-storage-preview__im"),this.previewEl.innerHTML="",this.updateAge(),this.previewEl.append(t,this.ageEl)):this.previewEl.innerHTML=J("file-storage-empty"),this.resetButtons()}},{key:"store",value:function(){var e=this;return M(function(){var t;return R(this,function(i){switch(i.label){case 0:return e.storeButtonEl.textContent=J("file-storage-storing"),e.storeButtonEl.disabled=!0,e.clearButtonEl.disabled=!0,[4,new Promise(function(e){setTimeout(function(){return e(null)},20)})];case 1:i.sent(),i.label=2;case 2:return i.trys.push([2,4,,5]),[4,e.projectStore.store(e.getProject())];case 3:return i.sent(),e.saveReminder.reset(),[3,5];case 4:return t=i.sent(),e.resetButtons(),rW.popup({target:e.klRootEl,type:"error",message:["".concat(J("file-storage-failed-1"),"<ul>"),"<li>".concat(J("file-storage-failed-2"),"</li>"),"<li>".concat(J("file-storage-failed-3"),"</li>"),"<li>".concat(J("file-storage-failed-4"),"</li>"),"</ul>"].join(""),buttons:["Ok"]}),setTimeout(function(){throw Error("storage-ui: failed to store browser storage, "+t)},0),[3,5];case 5:return[2]}})})()}},{key:"clear",value:function(){var e=this;return M(function(){var t;return R(this,function(i){switch(i.label){case 0:e.storeButtonEl.disabled=!0,e.clearButtonEl.disabled=!0,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,e.projectStore.clear()];case 2:return i.sent(),[3,4];case 3:return t=i.sent(),e.resetButtons(),rW.popup({target:e.klRootEl,type:"error",message:J("file-storage-failed-clear"),buttons:["Ok"]}),setTimeout(function(){throw Error("storage-ui: failed to clear browser storage, "+t)},0),[3,4];case 4:return[2]}})})()}},{key:"getElement",value:function(){return this.element}},{key:"show",value:function(){}},{key:"hide",value:function(){}},{key:"destroy",value:function(){(0,W.BB).destroyEl(this.infoEl),(0,W.BB).destroyEl(this.storeButtonEl),(0,W.BB).destroyEl(this.clearButtonEl),(0,eI.theme).removeIsDarkListener(this.updateCheckerboard),this.projectStore.unsubscribe(this.storeListener)}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX");function n0(e){for(var t=e.match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/),i=atob(t[3]),n=new Uint8Array(new ArrayBuffer(i.length)),r=0;r<n.length;r++)n[r]=i.charCodeAt(r);return new Blob([n],{type:t[1]})}function n1(e){return new Promise(function(t,i){var n=new Image;try{n.src=(0,W.BB).imageBlobToUrl(e)}catch(e){i("imageBlobToUrl, "+(e instanceof Error?e.message:""));return}n.onload=function(){URL.revokeObjectURL(n.src),t(n)},n.onabort=function(){i("layer image failed loading")},n.onerror=function(){i("layer image failed loading")}})}var n2=function(){function e(){(0,O._)(this,e)}return(0,D._)(e,null,[{key:"createThumbnail",value:function(e){var t=(0,W.BB).fitInto(e.width,e.height,240,240).width/e.width;return tm(e,t)}},{key:"createStorageProject",value:function(t){return{id:1,timestamp:new Date().getTime(),thumbnail:n0(e.createThumbnail(t).toDataURL("image/png")),width:t.width,height:t.height,layers:t.layers.map(function(e){var t;if(e.image instanceof HTMLCanvasElement)t=n0(e.image.toDataURL("image/png"));else throw Error("Not implemented");return{name:e.name,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr,blob:t}})}}},{key:"readStorageProject",value:function(t){return M(function(){var i,n,r;return R(this,function(a){switch(a.label){case 0:if(!t.width||!t.height||isNaN(t.width)||isNaN(t.height)||t.width<1||t.height<1)throw Error("readStorageProject invalid canvas size: "+t.width+", "+t.height);return n={width:t.width,height:t.height},[4,Promise.all(t.layers.map(function(e){return n1(e.blob)}))];case 1:if(n.layers=a.sent().map(function(e,i){var n=t.layers[i];return{name:n.name,isVisible:!("isVisible"in n)||n.isVisible,opacity:n.opacity,mixModeStr:n.mixModeStr,image:e}}),i=n,!t.thumbnail)return[3,3];return[4,n1(t.thumbnail)];case 2:return r=a.sent(),[3,4];case 3:r=e.createThumbnail(i),a.label=4;case 4:return[2,{project:i,timestamp:t.timestamp,thumbnail:r}]}})})()}}]),e}(),n5=I("6l0gQ");function n3(e){return new Promise(function(t,i){e(t,i)})}var n4=function(){function e(){var t=this;(0,O._)(this,e),this.listeners=[],this.accessHasFailed=!1,window.addEventListener("storage",function(e){if("indexedDbUpdatedAt"===e.key&&0!==t.listeners.length)try{M(function(){var e;return R(this,function(i){switch(i.label){case 0:return[4,t.read()];case 1:return(e=i.sent())?t.emit(e.timestamp,e.thumbnail):t.emit(),[2]}})})()}catch(e){e instanceof Error&&0===e.message.indexOf("db-error")&&(t.accessHasFailed=!0)}})}return(0,D._)(e,[{key:"lowLevelStore",value:function(e){return M(function(){return R(this,function(t){switch(t.label){case 0:return[4,new Promise(function(t,i){nt(e,t,i)})];case 1:return t.sent(),[2]}})})()}},{key:"lowLevelRead",value:function(){return M(function(){return R(this,function(e){switch(e.label){case 0:return[4,n3(ne)];case 1:return[2,e.sent()]}})})()}},{key:"lowLevelClear",value:function(){return M(function(){return R(this,function(e){switch(e.label){case 0:return[4,n3(ni)];case 1:return e.sent(),[2]}})})()}},{key:"emit",value:function(e,t){this.listeners.forEach(function(i){i.onUpdate(e,t)})}},{key:"updateTimestamp",value:function(){(0,n5.LocalStorage).setItem("indexedDbUpdatedAt",""+new Date().getTime())}},{key:"read",value:function(){var e=this;return M(function(){var t,i,n;return R(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,e.lowLevelRead()];case 1:return t=r.sent(),[3,3];case 2:throw i=r.sent(),e.accessHasFailed=!0,Error("db-error: "+i);case 3:if(!t)return[2,void 0];r.label=4;case 4:return r.trys.push([4,6,,7]),[4,n2.readStorageProject(t)];case 5:return n=r.sent(),[3,7];case 6:throw Error("format-error: "+r.sent());case 7:return[2,n]}})})()}},{key:"store",value:function(e){var t=this;return M(function(){var i,n,r,a,s;return R(this,function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),i=n2.createStorageProject(e),[4,t.lowLevelStore(i)];case 1:return o.sent(),[3,3];case 2:throw n=o.sent(),t.accessHasFailed=!0,Error("db-error: "+n);case 3:return[4,t.lowLevelRead()];case 4:r=o.sent(),o.label=5;case 5:return o.trys.push([5,7,,9]),[4,n2.readStorageProject(r)];case 6:return a=o.sent(),[3,9];case 7:return s=o.sent(),[4,t.lowLevelClear()];case 8:throw o.sent(),t.updateTimestamp(),setTimeout(function(){return t.emit()},0),Error("format-error: "+s);case 9:return t.updateTimestamp(),setTimeout(function(){return t.emit(a.timestamp,a.thumbnail)},0),[2]}})})()}},{key:"clear",value:function(){var e=this;return M(function(){return R(this,function(t){switch(t.label){case 0:return[4,e.lowLevelClear()];case 1:return t.sent(),e.updateTimestamp(),setTimeout(function(){return e.emit()},0),[2]}})})()}},{key:"subscribe",value:function(e){this.listeners.includes(e)||this.listeners.push(e)}},{key:"unsubscribe",value:function(e){for(var t=0;t<this.listeners.length;t++)if(e===this.listeners[t]){this.listeners.splice(t,1);return}}},{key:"isBroken",value:function(){return this.accessHasFailed}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),n6={};n6=I("f6OTe").getBundleURL("lYbF2")+"upload.5289e924.svg";var n7=function(){function e(i,n,r,a,s,o,l,h,c,u,p,d){var g=this;(0,O._)(this,e),this.exportType=a,this.rootEl=document.createElement("div"),setTimeout(function(){var e=document.createElement("div"),a=document.createElement("button"),f=document.createElement("button"),v=document.createElement("button"),m=document.createElement("button"),y=document.createElement("button");a.style.cssFloat="left",(0,W.BB).css(f,{cssFloat:"left",clear:"both",flexGrow:"1"}),(0,W.BB).css(y,{cssFloat:"left",clear:"both"}),a.tabIndex=-1,f.tabIndex=-1,v.tabIndex=-1,m.tabIndex=-1,y.tabIndex=-1,a.innerHTML='<img class="dark-no-invert" src=\''.concat(t(t3),"' alt='icon' height='20'/>").concat(J("file-new")),f.innerHTML="<img src='".concat(t(t6),"' alt='icon' height='20'/>").concat(J("file-save")),v.innerHTML="<img src='".concat(t(t7),"' alt='icon' height='20'/>").concat(J("file-share")),m.innerHTML="<img style='float:left' src='".concat(t(n6),"' height='20' alt='icon'/>").concat(J("file-upload")),y.innerHTML="<img src='".concat(t(eg),"' alt='icon' height='20'/>").concat(J("file-copy")),y.title=J("file-copy-title"),a.className="grid-button",f.className="grid-button",v.className="grid-button",m.className="grid-button",y.className="grid-button";var x=(0,W.BB).el({className:"grid-button",css:{position:"relative",cursor:"pointer",cssFloat:"left"}}),b=(0,W.BB).el({parent:x,css:{width:"120px",height:"28px",overflow:"hidden",cursor:"pointer",position:"relative"}});g.importButton=(0,W.BB).el({tagName:"input",parent:b,css:{display:"none"}}),g.importButton.tabIndex=-1,g.importButton.type="file",g.importButton.multiple=!0,g.importButton.accept="image",g.importButton.size=71,g.importButton.onchange=function(){g.importButton&&(g.importButton.files&&o(g.importButton.files,"default"),g.importButton.value="")};var B=(0,W.BB).el({tagName:"button",parent:x,content:"<img class=\"dark-no-invert\" style='float:left' height='20' src='"+t(t4)+"' alt='icon'/>"+J("file-import"),css:{width:"120px",display:"box",position:"absolute",left:"0",top:"0",cursor:"pointer"}});B.tabIndex=-1,B.onclick=function(){return g.importButton&&g.importButton.click()};var w=new rW.Select({optionArr:[["png","PNG"],["psd","PSD"],["layers",J("layers")+" (PNG)"]],initValue:g.exportType,onChange:function(e){g.exportType=e,s(g.exportType),l()},title:J("file-format")});(0,W.BB).css(w.getElement(),{width:"50%",height:"30px",marginTop:"10px",marginLeft:"10px"}),a.onclick=h,f.onclick=function(){l()},v.onclick=function(){v.disabled=!0,c(function(){v.disabled=!1})},m.onclick=function(){return u()},y.onclick=function(){y.blur(),p()};var k=(0,W.BB).el({className:"kl-toolspace-note",textContent:J("file-no-autosave"),css:{margin:"10px 10px 0 10px"}}),C=function(){var e=document.createElement("div"),t=document.createElement("div"),i=(0,W.BB).el({className:"grid-hr"});return e.append(t,i),(0,W.BB).css(t,{clear:"both"}),e};g.fileBrowserStorage=new n$(n,r,d,i),(0,W.BB).css(g.fileBrowserStorage.getElement(),{margin:"10px"});var S=(0,W.BB).el({content:[f,w.getElement()],className:"kl-file-save-row"});(0,W.BB).append(e,[k,a,x,(0,W.BB).el({css:{clear:"both"}}),S,y,(0,W.BB).canShareFiles()?v:void 0,(0,W.BB).el({css:{clear:"both"}}),C(),g.fileBrowserStorage.getElement(),C(),m]),g.rootEl.append(e)},1)}return(0,D._)(e,[{key:"refresh",value:function(){}},{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){e&&this.refresh()}},{key:"triggerImport",value:function(){this.importButton&&this.importButton.click()}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),P=I("8N5YG"),W=(I("eWjiX"),I("eWjiX"));function n8(e,t,i,n){(i||this._.texture).use(),this._.spareTexture.drawTo(function(){e.uniforms(t).drawRect()}),this._.spareTexture.swapWith(n||this._.texture)}var O=I("cx0mh"),D=I("7h4XF"),P=I("8N5YG"),W=I("eWjiX"),n9=function(){function e(t,i,n){if((0,O._)(this,e),this.vertexAttribute=null,this.texCoordAttribute=null,this.program=(0,W.BB).throwIfNull(B.createProgram()),t=t||"    attribute vec2 vertex;    attribute vec2 _texCoord;    varying vec2 texCoord;    void main() {        texCoord = _texCoord;        gl_Position = vec4(vertex * 2.0 - 1.0, 0.0, 1.0);    }",i=i||"    uniform sampler2D texture;    varying vec2 texCoord;    void main() {        gl_FragColor = texture2D(texture, texCoord);    }",w||(w=this.testPrecisionSupport(B.HIGH_FLOAT)?"highp":this.testPrecisionSupport(B.MEDIUM_FLOAT)?"mediump":"lowp"),i="precision "+w+" float;"+i,B.attachShader(this.program,this.compileSource(B.VERTEX_SHADER,t,n+"(vertex)")),B.attachShader(this.program,this.compileSource(B.FRAGMENT_SHADER,i,n+"(fragment)")),B.linkProgram(this.program),!B.getProgramParameter(this.program,B.LINK_STATUS))throw"link error: "+B.getProgramInfoLog(this.program)}return(0,D._)(e,[{key:"compileSource",value:function(e,t,i){var n=(0,W.BB).throwIfNull(B.createShader(e));if(B.shaderSource(n,t.replace(/#define.*/,"")),B.compileShader(n),!B.getShaderParameter(n,B.COMPILE_STATUS))throw"compile error: "+i+" - "+B.getShaderInfoLog(n);return n}},{key:"testPrecisionSupport",value:function(e){var t=B.getShaderPrecisionFormat(B.FRAGMENT_SHADER,e);return null!==t&&0!==t.precision}},{key:"destroy",value:function(){B.deleteProgram(this.program),this.program=null}},{key:"uniforms",value:function(e){var t=this;return B.useProgram(this.program),Object.entries(e).forEach(function(e){var i=(0,P._)(e,2),n=i[0],r=i[1],a=B.getUniformLocation(t.program,n);if(null!==a){if("[object Array]"==Object.prototype.toString.call(r))switch(r.length){case 1:B.uniform1fv(a,new Float32Array(r));break;case 2:B.uniform2fv(a,new Float32Array(r));break;case 3:B.uniform3fv(a,new Float32Array(r));break;case 4:B.uniform4fv(a,new Float32Array(r));break;case 9:B.uniformMatrix3fv(a,!1,new Float32Array(r));break;case 16:B.uniformMatrix4fv(a,!1,new Float32Array(r));break;default:throw"dont't know how to load uniform \""+n+'" of length '+r.length}else if("[object Number]"==Object.prototype.toString.call(r))B.uniform1f(a,r);else throw'attempted to set uniform "'+n+'" to invalid value '+(r||"undefined").toString()}}),this}},{key:"textures",value:function(e){var t=this;return B.useProgram(this.program),Object.entries(e).forEach(function(e){var i=(0,P._)(e,2),n=i[0],r=i[1];B.uniform1i(B.getUniformLocation(t.program,n),r)}),this}},{key:"drawRect",value:function(e,t,i,n){var r,a=B.getParameter(B.VIEWPORT);t=t!==r?(t-a[1])/a[3]:0,e=e!==r?(e-a[0])/a[2]:0,i=i!==r?(i-a[0])/a[2]:1,n=n!==r?(n-a[1])/a[3]:1,(B.vertexBuffer===r||null===B.vertexBuffer)&&(B.vertexBuffer=(0,W.BB).throwIfNull(B.createBuffer())),B.bindBuffer(B.ARRAY_BUFFER,B.vertexBuffer),B.bufferData(B.ARRAY_BUFFER,new Float32Array([e,t,e,n,i,t,i,n]),B.STATIC_DRAW),null==B.texCoordBuffer&&(B.texCoordBuffer=(0,W.BB).throwIfNull(B.createBuffer()),B.bindBuffer(B.ARRAY_BUFFER,B.texCoordBuffer),B.bufferData(B.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),B.STATIC_DRAW)),null==this.vertexAttribute&&(this.vertexAttribute=B.getAttribLocation(this.program,"vertex"),B.enableVertexAttribArray(this.vertexAttribute)),null==this.texCoordAttribute&&(this.texCoordAttribute=B.getAttribLocation(this.program,"_texCoord"),B.enableVertexAttribArray(this.texCoordAttribute)),B.useProgram(this.program),B.bindBuffer(B.ARRAY_BUFFER,B.vertexBuffer),B.vertexAttribPointer(this.vertexAttribute,2,B.FLOAT,!1,0,0),B.bindBuffer(B.ARRAY_BUFFER,B.texCoordBuffer),B.vertexAttribPointer(this.texCoordAttribute,2,B.FLOAT,!1,0,0),B.drawArrays(B.TRIANGLE_STRIP,0,4)}}],[{key:"getDefaultShader",value:function(){return B.defaultShader=B.defaultShader||new e,B.defaultShader}}]),e}(),re=function(e,t){return B.brightnessContrast=B.brightnessContrast||new n9(null,"        uniform sampler2D texture;        uniform float brightness;        uniform float contrast;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color.rgb += brightness;            if (contrast > 0.0) {                color.rgb = (color.rgb - 0.5) / (1.0 - contrast) + 0.5;            } else {                color.rgb = (color.rgb - 0.5) * (1.0 + contrast) + 0.5;            }            gl_FragColor = color;        }    ","brightnessContrast"),n8.call(this,B.brightnessContrast,{brightness:(0,W.BB).clamp(e,-1,1),contrast:(0,W.BB).clamp(t,-1,1)}),this},O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),rt=function(){function e(t,i,n,r){(0,O._)(this,e),this.gl=B,this.id=(0,W.BB).throwIfNull(B.createTexture()),this.width=t,this.height=i,this.format=n,this.type=r,this.canvas=null,B.bindTexture(B.TEXTURE_2D,this.id),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_MAG_FILTER,B.LINEAR),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_MIN_FILTER,B.LINEAR),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_WRAP_S,B.CLAMP_TO_EDGE),B.texParameteri(B.TEXTURE_2D,B.TEXTURE_WRAP_T,B.CLAMP_TO_EDGE),t&&i&&B.texImage2D(B.TEXTURE_2D,0,this.format,t,i,0,this.format,this.type,null)}return(0,D._)(e,[{key:"loadContentsOf",value:function(e){this.width=e.width||e.videoWidth,this.height=e.height||e.videoHeight,B.bindTexture(B.TEXTURE_2D,this.id),B.texImage2D(B.TEXTURE_2D,0,this.format,this.format,this.type,e)}},{key:"initFromBytes",value:function(e,t,i){this.width=e,this.height=t,this.format=B.RGBA,this.type=B.UNSIGNED_BYTE,B.bindTexture(B.TEXTURE_2D,this.id),B.texImage2D(B.TEXTURE_2D,0,B.RGBA,e,t,0,B.RGBA,this.type,new Uint8Array(i))}},{key:"destroy",value:function(){B.deleteTexture(this.id),this.id=null}},{key:"use",value:function(e){B.activeTexture(B.TEXTURE0+(e||0)),B.bindTexture(B.TEXTURE_2D,this.id)}},{key:"unuse",value:function(e){B.activeTexture(B.TEXTURE0+(e||0)),B.bindTexture(B.TEXTURE_2D,null)}},{key:"ensureFormat",value:function(e,t,i,n){(e!=this.width||t!=this.height||i!=this.format||n!=this.type)&&(this.width=e,this.height=t,this.format=i,this.type=n,B.bindTexture(B.TEXTURE_2D,this.id),B.texImage2D(B.TEXTURE_2D,0,this.format,e,t,0,this.format,this.type,null))}},{key:"ensureFormatViaTexture",value:function(e){this.ensureFormat(e.width,e.height,e.format,e.type)}},{key:"drawTo",value:function(e){if(B.framebuffer=B.framebuffer||B.createFramebuffer(),B.bindFramebuffer(B.FRAMEBUFFER,B.framebuffer),B.framebufferTexture2D(B.FRAMEBUFFER,B.COLOR_ATTACHMENT0,B.TEXTURE_2D,this.id,0),B.checkFramebufferStatus(B.FRAMEBUFFER)!==B.FRAMEBUFFER_COMPLETE)throw Error("incomplete framebuffer");B.viewport(0,0,this.width,this.height),e(),B.bindFramebuffer(B.FRAMEBUFFER,null)}},{key:"swapWith",value:function(e){var t;t=e.id,e.id=this.id,this.id=t,t=e.width,e.width=this.width,this.width=t,t=e.height,e.height=this.height,this.height=t,t=e.format,e.format=this.format,this.format=t}}],[{key:"fromElement",value:function(t){var i=new e(0,0,B.RGBA,B.UNSIGNED_BYTE);return i.loadContentsOf(t),i}}]),e}(),W=I("eWjiX");function ri(e){for(var t=new W.BB.SplineInterpolator(e),i=[],n=0;n<256;n++)i.push((0,W.BB).clamp(Math.floor(256*t.interpolate(n/255)),0,255));return i}var rn=function(e,t,i){for(var n=ri(e),r=ri(t),a=ri(i),s=[],o=0;o<256;o++)s.splice(s.length,0,n[o],r[o],a[o],255);return this._.extraTexture.initFromBytes(256,1,s),this._.extraTexture.use(1),B.curves=B.curves||new n9(null,"        uniform sampler2D texture;        uniform sampler2D map;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color.r = texture2D(map, vec2(color.r)).r;            color.g = texture2D(map, vec2(color.g)).g;            color.b = texture2D(map, vec2(color.b)).b;            gl_FragColor = color;        }    ","curves"),B.curves.textures({map:1}),n8.call(this,B.curves,{}),this},W=I("eWjiX"),rr=function(e,t){return B.hueSaturation=B.hueSaturation||new n9(null,"        uniform sampler2D texture;        uniform float hue;        uniform float saturation;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);                        /* hue adjustment, wolfram alpha: RotationTransform[angle, {1, 1, 1}][{x, y, z}] */            float angle = hue * 3.14159265;            float s = sin(angle), c = cos(angle);            vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;            float len = length(color.rgb);            color.rgb = vec3(                dot(color.rgb, weights.xyz),                dot(color.rgb, weights.zxy),                dot(color.rgb, weights.yzx)            );                        /* saturation adjustment */            float average = (color.r + color.g + color.b) / 3.0;            if (saturation > 0.0) {                color.rgb += (average - color.rgb) * (1.0 - 1.0 / (1.001 - saturation));            } else {                color.rgb += (average - color.rgb) * (-saturation);            }                        gl_FragColor = color;        }    ","hueSaturation"),n8.call(this,B.hueSaturation,{hue:(0,W.BB).clamp(e,-1,1),saturation:(0,W.BB).clamp(t,-1,1)}),this},ra={};ra="#define GLSLIFY 1\nuniform sampler2D texture;\nvarying vec2 texCoord;\nuniform vec2 texSize;\n\nuniform float seed;\nuniform float type;\nuniform vec2 scale;\nuniform vec2 offset;\nuniform float octaves;\nuniform float samples;\n\nuniform float peaks;\nuniform float contrast;\nuniform float brightness;\nuniform float isReversed;\n\nuniform vec3 colA;\nuniform vec3 colB;\n\nuniform float channels; // 0 - rgb, 1 - alpha\n\n// fbm, cellular_noise based on\n// https://github.com/Gonkee/Gonkees-Shaders\n// MIT, Copyright  Gonkee\n\n// hash & simplex based on\n// https://www.shadertoy.com/view/Msf3WH\n// MIT, Copyright  2013 Inigo Quilez\n// https://www.youtube.com/c/InigoQuilez\n// https://iquilezles.org\n\nfloat rand(vec2 co) {\n    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);\n}\n\nfloat value_noise(vec2 coord){\n    return rand(floor(coord) / 100.0);\n}\n\nfloat cellular_noise(vec2 coord) {\n    vec2 i = floor(coord);\n    vec2 f = fract(coord);\n\n    float min_dist = 99999.0;\n    for (float x = -1.0; x <= 1.0; x++) {\n        for (float y = -1.0; y <= 1.0; y++) {\n            vec2 node = rand(i + vec2(x, y)) + vec2(x, y);\n            float dist = sqrt((f - node).x * (f - node).x + (f - node).y * (f - node).y);\n            min_dist = min(min_dist, dist);\n        }\n    }\n    return min_dist;\n}\n\n// ---------- Simplex Alternative ---------------------\n\nvec3 hash(vec3 p)\n{ p=vec3(dot(p, vec3(127.1, 311.7, 74.7))\n, dot(p, vec3(269.5, 183.3, 246.1))\n, dot(p, vec3(113.5, 271.9, 124.6)))\n;return fract(sin(p)*43758.5453123)*2.-1.; }\n\nmat3 hash(mat3 p)\n{ return mat3(hash(p[0]), hash(p[1]), hash(p[2])); }\n\nvec3 dots(mat3 a, vec3 w, mat3 b){ return vec3\n(dot(a[0], w-b[0]), dot(a[1], w-b[1]), dot(a[2], w-b[2])); }\n\n//return noiseGra13dx as .x, and its derivatives as .yzw\n// https://www.shadertoy.com/view/llByD1\nvec3 noiseGra13dx(in vec3 x) {\n    vec3 p=floor(x), w=fract(x)\n    #if 1\n    , u=w*w*w*(w*(w*6.-15.)+10.), v=30.*w*w*(w*(w-2.)+1.)//quintic hermite\n    #else\n    , u=w*w*(3.-2.*w), v=6.*w*(1.-w)//cubic hermite\n    #endif\n    //gradients\n    , G=hash(p+vec3(0)), F=hash(p+vec3(1))\n    ;mat3 D=hash(mat3(p, p, p)+mat3(1)), E=hash(mat3(p, p, p)+1.-mat3(1));\n    //projections\n    vec3 d=dots(D, w, mat3(1)), e=dots(E, w, 1.-mat3(1));\n    //interpolations\n    float g=dot(G, w), f=dot(F, w-vec3(1));\n    vec3 h=u.yzx*(g-d.xyx-d.yzz+e.zxy)+d-g, U=u*h, a=d-e;\n    mat3 S=D-mat3(G, G, G), W=D-E;\n    a.x=(a.x+a.y+a.z)+f-g;\n    ;float b=u.x*u.y*u.z;\n\n    vec4 result = vec4(g+U.x+U.y+U.z+a.x*b// value\n    , G*(1.-b)+b*(W[0]+W[1]+W[2]+F)//https://www.shadertoy.com/view/llByD1\n    +u.x*(S[0]+u.y*(G-D[0]-D[1]+E[2]))// derivatives\n    +u.y*(S[1]+u.z*(G-D[1]-D[2]+E[0]))\n    +u.z*(S[2]+u.x*(G-D[0]-D[2]+E[1]))\n    +v*(u.zxy*(g-d.xxy-d.zyz+e.yzx)+h+u.yzx*u.zxy*a.x));\n    return 0.5 + 0.5 * result.xxx;\n}\n\nfloat fbm(vec2 coord) {\n    float normalize_factor = 0.0;\n    float value = 0.0;\n    float scale = 0.5;\n\n    for (float i = 0.0; i < 7.0; i++){\n        if (i < octaves) {\n            if (type == 0.0) {\n                value += value_noise(coord) * scale;\n            } else if (type == 1.0) {\n                value += noiseGra13dx(vec3(coord.x, coord.y, 0.0)).r * scale;\n            } else if (type == 2.0) {\n                value += cellular_noise(coord) * scale;\n            }\n            normalize_factor += scale;\n            coord *= 2.0;\n            scale *= 0.5;\n        }\n    }\n    return value / normalize_factor;\n}\n\nfloat render (vec2 pos) {\n    float result = fbm(pos);\n    //\n\n    if (peaks > 0.0) {\n        result = abs(mod(result * peaks - 0.5, 1.0) - 0.5) * 2.0;// triangle\n        //result = mod(result * (peaks + 1.0), 1.0); // sawtooth\n    }\n\n    result += brightness;\n    if (contrast > 0.0) {\n        result = clamp((result - 0.5) / (1.0 - contrast) + 0.5, 0.0, 1.0);\n    } else if (contrast < 0.0) {\n        result = clamp((result - 0.5) * (1.0 + contrast) + 0.5, 0.0, 1.0);\n    }\n\n    if (isReversed == 1.0) {\n        result = 1.0 - result;\n    }\n    return result;\n}\n\nvoid main() {\n    vec4 color;\n\n    vec2 seedOffset;\n    seedOffset.x = (rand(vec2(seed, 0.0)) * 100.0 - 50.0);\n    seedOffset.y = (rand(vec2(0.0, seed)) * 100.0 - 50.0);\n\n    float val = 0.0;\n    vec2 basePos = texCoord * texSize / scale - offset / scale + seedOffset;\n\n    if (samples == 1.0) {\n        val = render(basePos);\n\n    }/* else if (samples == 4.0) {\n        for (float i = 0.0; i < 2.0; i++) {\n            for (float e = 0.0; e < 2.0; e++) {\n                val += render(basePos + (vec2(i, e) - 0.5) * 0.5 / scale);\n            }\n        }\n        val /= 4.0;\n\n    }*/ else if (samples == 16.0) {\n        for (float i = 0.0; i < 4.0; i++) {\n            for (float e = 0.0; e < 4.0; e++) {\n                val += render(basePos + (vec2(i, e) - 0.25) * 0.25 / scale);\n            }\n        }\n        val /= 16.0;\n    }\n\n    if (channels == 0.0) {\n        gl_FragColor = vec4(vec3(mix(colA, colB, val)), 1.0);\n    } else {\n        gl_FragColor = vec4(vec3(1.0), val);\n    }\n}";var rs=function(e,i,n,r,a,s,o,l,h,c,u,p,d){return B.noise=B.noise||new n9(null,t(ra).replace(/#define.*/,""),"noise"),n8.call(this,B.noise,{seed:e||0,type:i,scale:[n[0],n[1]],offset:r,octaves:a,samples:s,texSize:[this.width,this.height],peaks:o,brightness:l,contrast:h,isReversed:c?1:0,colA:u?[u.r/255,u.g/255,u.b/255]:[0,0,0],colB:p?[p.r/255,p.g/255,p.b/255]:[1,1,1],channels:"rgb"===d?0:1}),this},ro="    float random(vec3 scale, float seed) {        /* use the fragment position for a different seed per-pixel */        return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);    }",rl=function(e){return B.triangleBlur=B.triangleBlur||new n9(null,"        uniform sampler2D texture;        uniform vec2 delta;        varying vec2 texCoord;        "+ro+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec4 sample = texture2D(texture, texCoord + delta * percent);                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;        }    ","triangleBlur"),n8.call(this,B.triangleBlur,{delta:[e/this.width,0]}),n8.call(this,B.triangleBlur,{delta:[0,e/this.height]}),this},rh=function(e,t,i,n,r,a){B.tiltShift=B.tiltShift||new n9(null,"        uniform sampler2D texture;        uniform float blurRadius;        uniform float gradientRadius;        uniform vec2 start;        uniform vec2 end;        uniform vec2 delta;        uniform vec2 texSize;        varying vec2 texCoord;        "+ro+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        vec2 normal = normalize(vec2(start.y - end.y, end.x - start.x));            float radius = smoothstep(0.0, 1.0, abs(dot(texCoord * texSize - start, normal)) / gradientRadius) * blurRadius;            for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec4 sample = texture2D(texture, texCoord + delta / texSize * percent * radius);                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;        }    ","tiltShift");var s=i-e,o=n-t,l=Math.sqrt(s*s+o*o);return n8.call(this,B.tiltShift,{blurRadius:r,gradientRadius:a,start:[e,t],end:[i,n],delta:[s/l,o/l],texSize:[this.width,this.height]}),n8.call(this,B.tiltShift,{blurRadius:r,gradientRadius:a,start:[e,t],end:[i,n],delta:[-o/l,s/l],texSize:[this.width,this.height]}),this};function rc(e,t){return new n9(null,e+"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {        vec2 coord = texCoord * texSize;        "+t+"        gl_FragColor = texture2D(texture, coord / texSize);        vec2 clampedCoord = clamp(coord, vec2(0.0), texSize);        if (coord != clampedCoord) {            /* fade to transparent if we are outside the image */            gl_FragColor.a *= max(0.0, 1.0 - length(coord - clampedCoord));        }    }","warp")}function ru(e,t,i,n,r,a,s,o){var l=i-r,h=n-a,c=s-r,u=o-a,p=e-i+r-s,d=t-n+a-o,g=l*u-c*h,f=(p*u-c*d)/g,v=(l*d-p*h)/g;return[i-e+f*i,n-t+f*n,f,s-e+v*s,o-t+v*o,v,e,t,1]}function rp(e){var t=e[0],i=e[1],n=e[2],r=e[3],a=e[4],s=e[5],o=e[6],l=e[7],h=e[8],c=t*a*h-t*s*l-i*r*h+i*s*o+n*r*l-n*a*o;return[(a*h-s*l)/c,(n*l-i*h)/c,(i*s-n*a)/c,(s*o-r*h)/c,(t*h-n*o)/c,(n*r-t*s)/c,(r*l-a*o)/c,(i*o-t*l)/c,(t*a-i*r)/c]}var rd=function(e,t,i){if(B.matrixWarp=B.matrixWarp||rc("        uniform mat3 matrix;        uniform bool useTextureSpace;    ","        if (useTextureSpace) coord = coord / texSize * 2.0 - 1.0;        vec3 warp = matrix * vec3(coord, 1.0);        coord = warp.xy / warp.z;        if (useTextureSpace) coord = (coord * 0.5 + 0.5) * texSize;    "),4==(e=e.flat()).length)e=[e[0],e[1],0,e[2],e[3],0,0,0,1];else if(9!=e.length)throw"can only warp with 2x2 or 3x3 matrix";return n8.call(this,B.matrixWarp,{matrix:t?rp(e):e,texSize:[this.width,this.height],useTextureSpace:i?1:0}),this},rg=function(e,t){return B.unsharpMask=B.unsharpMask||new n9(null,"        uniform sampler2D blurredTexture;        uniform sampler2D originalTexture;        uniform float strength;        uniform float threshold;        varying vec2 texCoord;        void main() {            vec4 blurred = texture2D(blurredTexture, texCoord);            vec4 original = texture2D(originalTexture, texCoord);            gl_FragColor = mix(blurred, original, 1.0 + strength);        }    ","unsharpMask"),this._.extraTexture.ensureFormatViaTexture(this._.texture),this._.texture.use(),this._.extraTexture.drawTo(function(){n9.getDefaultShader().drawRect()}),this._.extraTexture.use(1),this.triangleBlur(e),B.unsharpMask.textures({originalTexture:1}),n8.call(this,B.unsharpMask,{strength:t}),this._.extraTexture.unuse(1),this},rf=function(e,t){return B.toAlpha=B.toAlpha||new n9(null,"    uniform bool isInverted;    uniform vec4 replace;    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        float alpha = (color.r + color.g + color.b) / 3.0;        if (isInverted) alpha = 1.0 - alpha;        alpha = min(color.a, alpha);        if (replace.a > 0.0) color = replace;        gl_FragColor = vec4(color.r, color.g, color.b, alpha);    }","toAlpha"),n8.call(this,B.toAlpha,{isInverted:e?1:0,replace:t?[t.r/255,t.g/255,t.b/255,t.a]:[0,0,0,0],texSize:[this.width,this.height]}),this},rv=function(){return B.invert=B.invert||new n9(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        color.rgb = 1.0 - color.rgb;        gl_FragColor = color;    }","invert"),n8.call(this,B.invert,{texSize:[this.width,this.height]}),this},z=I("bX4ja"),rm=function(e,t){var i,n=ru.apply(void 0,(0,z._)(t)),r=ru.apply(void 0,(0,z._)(e)),a=[(i=rp(n))[0]*r[0]+i[1]*r[3]+i[2]*r[6],i[0]*r[1]+i[1]*r[4]+i[2]*r[7],i[0]*r[2]+i[1]*r[5]+i[2]*r[8],i[3]*r[0]+i[4]*r[3]+i[5]*r[6],i[3]*r[1]+i[4]*r[4]+i[5]*r[7],i[3]*r[2]+i[4]*r[5]+i[5]*r[8],i[6]*r[0]+i[7]*r[3]+i[8]*r[6],i[6]*r[1]+i[7]*r[4]+i[8]*r[7],i[6]*r[2]+i[7]*r[5]+i[8]*r[8]];return this.matrixWarp(a)},ry=function(){return B.unmultiplyAlpha=B.unmultiplyAlpha||new n9(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        if(color.a > 0.0) {            color.rgb /= color.a;        }        gl_FragColor = color;    }","unmultiplyAlpha"),n8.call(this,B.unmultiplyAlpha,{texSize:[this.width,this.height]}),this},rx=function(e){return B.distort=B.distort||rc("\n    uniform float stepSize;\n    uniform vec2 scale;\n    uniform vec2 strength;\n    uniform vec2 phase;\n    uniform float type;\n    uniform vec2 offset;\n","\n    const float PI = 3.14159265;\n    float x = coord.x + offset.x;\n    float y = coord.y + offset.y;\n    if (stepSize > 1.0) {\n        x = floor(x / stepSize) * stepSize;\n        y = floor(y / stepSize) * stepSize;\n    }\n    float distortX = sin((x/scale.x + phase.x) * PI * 2.0) * strength.x;\n    float distortY = sin((y/scale.y + phase.y) * PI * 2.0) * strength.y;\n    if (type == 0.0) {\n        coord.y += distortX;\n        coord.x += distortY;\n    } else if (type == 1.0) {\n        coord.x += distortX;\n        coord.y += distortY;\n    } else if (type == 2.0) {\n        x -= offset.x;\n        y -= offset.y;\n        gl_FragColor = texture2D(texture, vec2(x, y) / texSize);\n        coord.y += sin(gl_FragColor.r/scale.x*200.0 + phase.x * PI * 2.0) * strength.x;\n        coord.x += cos(gl_FragColor.g/scale.y*200.0 + phase.y * PI * 2.0) * strength.y;\n    }\n    coord.x = mod(coord.x, texSize.x);\n    coord.y = mod(coord.y, texSize.y);\n"),n8.call(this,B.distort,{stepSize:e.stepSize,type:e.distortType,scale:[e.scale.x,e.scale.y],strength:[e.strength.x,e.strength.y],phase:[e.phase.x,e.phase.y],offset:[e.offset.x,e.offset.y],texSize:[this.width,this.height]}),this},rb=function(){return B.multiplyAlpha=B.multiplyAlpha||new n9(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        color.rgb *= color.a;        gl_FragColor = color;    }","multiplyAlpha"),n8.call(this,B.multiplyAlpha,{texSize:[this.width,this.height]}),this},W=I("eWjiX"),rB=function(){function e(e){return{_:e,loadContentsOf:function(e){B=this._.gl,this._.loadContentsOf(e)},destroy:function(){B=this._.gl,this._.destroy()}}}function t(t){return e(rt.fromElement(t))}function i(e,t){var i=function(){var e=B.UNSIGNED_BYTE;if(B.getExtension("WEBGL_color_buffer_float")&&B.getExtension("OES_texture_float")&&B.getExtension("OES_texture_float_linear")){var t=new rt(100,100,B.RGBA,B.FLOAT);try{t.drawTo(function(){e=B.FLOAT})}catch(e){}t.destroy()}return e}();this._.texture&&this._.texture.destroy(),this._.spareTexture&&this._.spareTexture.destroy(),this.width=e,this.height=t,this._.texture=new rt(e,t,B.RGBA,i),this._.spareTexture=new rt(e,t,B.RGBA,i),this._.extraTexture=this._.extraTexture||new rt(0,0,B.RGBA,i),this._.flippedShader=this._.flippedShader||new n9(null,"\nuniform sampler2D texture;\nvarying vec2 texCoord;\nvoid main() {\n    gl_FragColor = texture2D(texture, vec2(texCoord.x, 1.0 - texCoord.y));\n}\n        ","flippedShader"),this._.isInitialized=!0}function n(e,t,n){return this._.isInitialized&&e._.width==this.width&&e._.height==this.height||i.call(this,t||e._.width,n||e._.height),e._.use(),this._.texture.drawTo(function(){n9.getDefaultShader().drawRect()}),this}function r(){return this._.texture.use(),this._.flippedShader.drawRect(),this}function a(){var t=new rt(this._.texture.width,this._.texture.height,B.RGBA,B.UNSIGNED_BYTE);return this._.texture.use(),t.drawTo(function(){n9.getDefaultShader().drawRect()}),e(t)}function s(){var e=this._.texture.width,t=this._.texture.height,i=new Uint8Array(e*t*4);return this._.texture.drawTo(function(){B.readPixels(0,0,e,t,B.RGBA,B.UNSIGNED_BYTE,i)}),i}function o(e){return function(){for(var t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];return B=this._.gl,e.apply(this,i)}}return function(){if(!window.WebGLRenderingContext)throw"WebGLRenderingContext not set. Browser does not support WebGL.";var e,i,l=(0,W.BB).canvas(1,1),h=(e={premultipliedAlpha:!1},i=null,["webgl","experimental-webgl","webgl2"].forEach(function(t){if(!i)try{i=l.getContext(t,e)}catch(e){}}),i);if(!h)throw"This browser does not support WebGL";return B=h,l._={gl:B,isInitialized:!1,texture:null,spareTexture:null,flippedShader:null},l.texture=o(t),l.draw=o(n),l.update=o(r),l.contents=o(a),l.getPixelArray=o(s),l.brightnessContrast=o(re),l.hueSaturation=o(rr),l.triangleBlur=o(rl),l.unsharpMask=o(rg),l.perspective=o(rm),l.matrixWarp=o(rd),l.tiltShift=o(rh),l.noise=o(rs),l.curves=o(rn),l.invert=o(rv),l.multiplyAlpha=o(rb),l.unmultiplyAlpha=o(ry),l.toAlpha=o(rf),l.distort=o(rx),l}}(),rw=!1,rk=null;function rC(){if(rw)return rk;if(!rk||rk._.gl.isContextLost())try{rk=rB()}catch(e){rw=!0,rk=null,setTimeout(function(){throw e})}return rk}var rS=function(){function e(t,i,n,r,a,s,o,l,h,c,u){(0,O._)(this,e),this.klRootEl=t,this.klColorSlider=i,this.layerManager=n,this.klCanvasWorkspace=r,this.handUi=a,this.getCurrentColor=s,this.getKlMaxCanvasSize=o,this.getKlCanvas=l,this.getCurrentLayerCtx=h,this.isEmbed=c,this.statusOverlay=u,this.isInit=!1,this.rootEl=document.createElement("div")}return(0,D._)(e,[{key:"testHasWebGL",value:function(){return!!rC()}},{key:"init",value:function(){var e=this,t=rW.filterLib,i=[];if(!rW.filterLibStatus.isLoaded)throw Error("filters not loaded");var n=this.testHasWebGL();if(!n){var r=(0,W.BB).el({parent:this.rootEl,className:"kl-toolspace-note",content:"Features disabled because WebGL is failing.",css:{margin:"10px",marginBottom:"0"}});(0,W.BB).el({parent:r,tagName:"button",textContent:"Learn More",css:{marginLeft:"5px"}}).onclick=function(){rW.popup({target:e.klRootEl,message:"<b>WebGL is not working</b>",div:(0,W.BB).el({content:'\nSee if your browser supports WebGL and has it enabled: <a href="https://get.webgl.org" target="_blank" rel="noopener noreferrer">get.webgl.org</a><br>\n<br>\nRecently (2023-05) a number of Chrome users on Chrome OS reported that WebGL fails, although it is enabled & supported.\nThis has been reported to Google.\n'}),buttons:["Ok"],clickOnEnter:"Ok"})}}var a=function(r){var a=t[r],s=document.createElement("button"),o=J(a.lang.button),l="<img "+(a.darkNoInvert?'class="dark-no-invert"':"")+' height="20" width="18" src="'+a.icon+'" style="margin-right: 3px" alt="icon" />';s.innerHTML=l+o,s.className="grid-button grid-button--filter",(0,W.BB).css(s,{lineHeight:"20px",fontSize:"12px"}),s.tabIndex=-1;var h=J(a.lang.name),c=!0;return a.webGL&&!n&&(c=!1),c?s.onclick=function(){var i=function(e,t){var i;if(!("error"in t)){if("Cancel"==e){t.destroy&&t.destroy();return}try{i=t.getInput()}catch(e){if(-1!==e.message.indexOf(".getInput is not a function"))throw"filterDialog.getInput is not a function, filter: "+h;throw e}n(i)}};if(!("apply"in t[r])){rW.popup({target:e.klRootEl,message:"Application not fully loaded",type:"error"});return}var n=function(i){!1===t[r].apply({context:e.getCurrentLayerCtx(),klCanvas:e.getKlCanvas(),history:V,input:i})&&rW.popup({target:e.klRootEl,message:"Couldn't apply the edit action",type:"error"}),!0===t[r].updatePos&&(e.klCanvasWorkspace.resetOrFitView(),e.handUi.update(e.klCanvasWorkspace.getScale(),e.klCanvasWorkspace.getAngleDeg())),e.layerManager.update()};if(t[r].isInstant)s.blur(),n(null),e.statusOverlay.out('"'+h+'" '+J("filter-applied"),!0);else{var o,l,c=e.klColorSlider.getSecondaryRGB(),u=void 0;try{u=t[r].getDialog({context:e.getCurrentLayerCtx(),klCanvas:e.getKlCanvas(),maxWidth:e.getKlMaxCanvasSize(),maxHeight:e.getKlMaxCanvasSize(),currentColorRgb:{r:e.getCurrentColor().r,g:e.getCurrentColor().g,b:e.getCurrentColor().b},secondaryColorRgb:{r:c.r,g:c.g,b:c.b}})}catch(e){setTimeout(function(){throw e})}if(!u||"error"in u){rW.popup({target:e.klRootEl,message:u?u.error:"Error: Could not perform action.",type:"error"});return}u.errorCallback=function(t){rW.popup({target:e.klRootEl,message:"Error: Could not perform action.",type:"error"}),setTimeout(function(){throw t},0),o()};var p={};"width"in u&&(p.width=u.width+"px");var d=[ev("b",h)];void 0!==a.lang.description&&d.push(ev({className:"kl-info-btn",onClick:function(){rW.popup({target:e.klRootEl,message:J(a.lang.description)})},title:J(a.lang.description),noRef:!0},"?")),l=ev(",flex,gap-5",d),rW.popup({target:e.klRootEl,message:l,div:u.element,style:p,buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(e){i(e,u)},closeFunc:function(e){o=e}})}}:s.disabled=!0,i.push(s),s},s=function(i){Object.entries(t).forEach(function(t){var n=(0,P._)(t,2),r=n[0],s=n[1];i.includes(r)&&(!e.isEmbed||s.inEmbed)&&e.rootEl.append(a(r))})};s(["cropExtend","flip","perspective","resize","rotate","transform"]),this.rootEl.append((0,W.BB).el({className:"grid-hr"})),s(["brightnessContrast","curves","distort","hueSaturation","invert","tiltShift","toAlpha","blur","unsharpMask"]),this.rootEl.append((0,W.BB).el({className:"grid-hr"})),s(["grid","noise","pattern","vanishPoint"]),this.isInit=!0}},{key:"getElement",value:function(){return this.rootEl}},{key:"show",value:function(){this.isInit||this.init(),this.rootEl.style.display="block"}},{key:"hide",value:function(){this.rootEl.style.display="none"}}]),e}(),W=I("eWjiX"),rE={};function rI(){return(rI=M(function(e,i,n,r,a){var s,o,l,h,c,u,p,d,g;return R(this,function(f){switch(f.label){case 0:if(s=n0(e.toDataURL("image/"+r)),!(o=window.open()))throw Error("could not create new tab");l=o.document.createElement("div"),(h=o.document.createElement("img")).src=t(rE),l.append(h),(0,W.BB).css(h,{filter:"invert(1)"}),(0,W.BB).css(o.document.body,{backgroundColor:"#121211",backgroundImage:"linear-gradient(#2b2b2b 0%, #121211 50%)",backgroundRepeat:"no-repeat"}),(c=o.document.createElement("div")).style.marginTop="10px",l.append(c),c.textContent=J("upload-uploading"),o.document.body.append(l),(0,W.BB).css(l,{marginLeft:"auto",marginRight:"auto",marginTop:"100px",fontFamily:"system-ui, sans-serif",fontSize:"20px",textAlign:"center",transition:"opacity 0.3s ease-in-out",opacity:"0",color:"#ccc"}),setTimeout(function(){l.style.opacity="1"},20),f.label=1;case 1:return f.trys.push([1,3,,4]),(p=new FormData).append("title",i),p.append("description",n),p.append("image",s),[4,fetch("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID "+a},body:p})];case 2:return u=f.sent(),[3,4];case 3:throw d=f.sent(),o.close(),d;case 4:if(!u.ok)throw o.close(),Error();return[4,u.json()];case 5:return g=f.sent().data,o.location.href=g.link.replace(/\.(jpg|png)/,""),[2,g]}})})).apply(this,arguments)}function rA(){return rT.apply(this,arguments)}function rT(){return(rT=M(function(){return R(this,function(e){switch(e.label){case 0:if(k)return[3,2];return[4,I("6BHwO")];case 1:k=e.sent(),e.label=2;case 2:return[2,k]}})})).apply(this,arguments)}rE=I("f6OTe").getBundleURL("lYbF2")+"loading.7ff8a2ac.gif";var O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),rM="kl-save-reminder",rL=function(){function e(t,i,n,r,a,s,o){var l,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"Klecks";(0,O._)(this,e),this.history=t,this.showReminder=i,this.changeTitle=n,this.onSaveAsPsd=r,this.isDrawing=a,this.projectStore=s,this.getProject=o,this.title=h,this.lastSavedAt=0,this.lastReminderShownAt=0,this.setting=null!==(l=localStorage.getItem(rM))&&void 0!==l?l:"20min"}return(0,D._)(e,[{key:"showPopup",value:function(){var e=this;if(!this.projectStore||!this.getProject)throw Error("projectStore and getProject need to be set");var t=Math.round((performance.now()-this.lastSavedAt)/1e3/60),i=(0,W.BB).el();i.append((0,W.BB).el({content:J("save-reminder-text",{a:"<strong>"+t,b:"</strong>"}),css:{marginBottom:"20px"}}));var n=(0,W.BB).el({css:{borderTop:"1px solid #aaa",margin:"0 -20px",padding:"20px"}}),r=(0,W.BB).el({css:{borderTop:"1px solid #aaa",margin:"0 -20px",padding:"20px",paddingBottom:"0"}});i.append(n,r);var a=(0,W.BB).el({tagName:"button",className:"kl-button",content:J("save-reminder-save-psd"),onClick:function(){return e.onSaveAsPsd()}});n.append(a,(0,W.BB).el({content:J("save-reminder-psd-layers"),css:{marginTop:"10px"}}));var s=new n$(this.projectStore,this.getProject,this,document.body,{hideClearButton:!0,isFocusable:!0});r.append(s.getElement()),rW.popup({target:document.body,message:"<b>".concat(J("save-reminder-title"),"</b>"),div:i,ignoreBackground:!0,callback:function(){s.destroy(),(0,W.BB).destroyEl(a),e.closeFunc=void 0,e.lastReminderShownAt=performance.now()},closeFunc:function(t){e.closeFunc=t}}),setTimeout(function(){a.focus()},40)}},{key:"init",value:function(){var e=this;function t(e){e.preventDefault(),e.returnValue=""}void 0===this.lastSavedActionNumber&&(this.lastSavedActionNumber=this.history.getActionNumber(),this.lastReminderShownAt=performance.now(),this.lastSavedAt=performance.now(),this.showReminder&&setInterval(function(){if("visible"===document.visibilityState){var t=Math.abs(e.history.getActionNumber()-e.lastSavedActionNumber),i=6e4*({"20min":20,"40min":40,disabled:0})[e.setting];i>0&&0===rW.dialogCounter.get()&&!e.isDrawing()&&e.lastReminderShownAt+i<performance.now()&&t>=100&&e.showPopup()}},5e3),this.history.addListener(function(){var i=e.history.getActionNumber();e.lastSavedActionNumber!==i?window.onbeforeunload=t:window.onbeforeunload=null}),this.changeTitle&&document.addEventListener("visibilitychange",function(){if("visible"===document.visibilityState)document.title=e.title,clearInterval(e.unsavedInterval);else{var t=e.history.getActionNumber();if(e.lastSavedActionNumber!==t){document.title=J("unsaved")+" - "+e.title;var i=0;e.unsavedInterval=setInterval(function(){1==(i=(i+1)%2)?document.title=J("unsaved")+"  "+e.title:document.title=J("unsaved")+" - "+e.title},18e4)}}}))}},{key:"reset",value:function(){void 0!==this.lastSavedActionNumber&&(this.lastSavedActionNumber=this.history.getActionNumber(),this.lastReminderShownAt=performance.now(),this.lastSavedAt=performance.now(),window.onbeforeunload=null,this.closeFunc&&this.closeFunc())}},{key:"getSetting",value:function(){return this.setting}},{key:"setSetting",value:function(e){this.setting=e,localStorage.setItem(rM,this.setting)}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX");function rR(e,t){var i=document.createElementNS("http://www.w3.org/1999/xhtml","a");i.download=t,i.rel="noopener",i.href=URL.createObjectURL(e),setTimeout(function(){return URL.revokeObjectURL(i.href)},4e4),setTimeout(function(){return i.click()},0)}var rP=function(){function e(t,i,n){(0,O._)(this,e),this.saveReminder=t,this.getExportType=i,this.getKlCanvas=n}return(0,D._)(e,[{key:"saveImage",value:function(e,t,i){var n=e.toDataURL(i).match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/);if(!n)throw Error("saveImage: empty parts");for(var r=atob(n[3]),a=new Uint8Array(new ArrayBuffer(r.length)),s=0;s<a.length;s++)a[s]=r.charCodeAt(s);rR(new Blob([a],{type:n[1]}),t)}},{key:"save",value:function(e){if(this.saveReminder.reset(),e||(e=this.getExportType()),"png"===e){var t=(0,W.BB).getDate()+tj.filenameBase+".png",i=this.getKlCanvas().getCompleteCanvas(1);try{this.saveImage(i,t,"image/png")}catch(e){throw alert("could not save"),Error("failed png export")}}else if("layers"===e)for(var n=(0,W.BB).getDate()+tj.filenameBase,r=this.getKlCanvas().getLayersFast(),a=0;a<r.length;a++){var s=r[a],o=[n,"_",(""+(a+1)).padStart(2,"0"),"_",s.name,".","png"];this.saveImage(s.canvas,o.join(""),"image/png")}else if("psd"===e){for(var l=this.getKlCanvas().getLayersFast(),h={width:this.getKlCanvas().getWidth(),height:this.getKlCanvas().getHeight(),children:[],canvas:this.getKlCanvas().getCompleteCanvas(1)},c=0;c<l.length;c++){var u=l[c];h.children.push({name:u.name,hidden:!u.isVisible,opacity:u.opacity,canvas:u.canvas,blendMode:rW.PSD.blendKlToPsd(u.mixModeStr),left:0,top:0})}rW.loadAgPsd().then(function(e){rR(new Blob([e.writePsdBuffer(h)],{type:"application/octet-stream"}),(0,W.BB).getDate()+tj.filenameBase+".psd")}).catch(function(){alert("Error: failed to load PSD library")})}}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),P=I("8N5YG"),z=I("bX4ja"),_=I("7jh4K");function rO(e,t,i,n,r,a){if("brush"===e.tool[0]){var s=n[e.tool[1]];e.actions.forEach(function(e){s[e.action].apply(s,(0,z._)(e.params))})}else if("canvas"===e.tool[0]){var o=e.params,l=i[e.action].apply(i,(0,z._)(o));if("number"==typeof l){t=l;var h=(0,_.throwIfNull)(i.getLayerContext(t));r(h),Object.entries(n).forEach(function(e){return(0,P._)(e,2)[1].setContext(h)})}}else if("filter"===e.tool[0]){var c,u=[{context:a(),klCanvas:i,input:e.params[0].input,history:new rW.DecoyKlHistory}];(c=rW.filterLib[e.tool[1]])[e.action].apply(c,(0,z._)(u))}else if("misc"===e.tool[0]&&"focusLayer"===e.action){t=e.params[0];var p=(0,_.throwIfNull)(i.getLayerContext(t));r(p),Object.entries(n).forEach(function(e){return(0,P._)(e,2)[1].setContext(p)})}else if("misc"===e.tool[0]&&"importImage"===e.action){var d=i.addLayer();if("number"==typeof d){t=d,e.params[1]&&i.renameLayer(t,e.params[1]);var g=(0,_.throwIfNull)(i.getLayerContext(t));r(g),Object.entries(n).forEach(function(e){return(0,P._)(e,2)[1].setContext(g)})}a().drawImage(e.params[0],0,0)}return t}var rD=function(){function e(t,i,n,r,a,s,o,l,h,c){(0,O._)(this,e),this.brushUiMap=t,this.layerPreview=i,this.layerManager=n,this.handUi=r,this.klCanvasWorkspace=a,this.getInitState=s,this.getKlCanvas=o,this.getCurrentLayerCtx=l,this.setCurrentLayerCtx=h,this.getCurrentBrush=c,this.doIgnore=!1}return(0,D._)(e,[{key:"shouldIgnoreTest",value:function(){var e=this;return!!this.doIgnore||(this.doIgnore=!0,setTimeout(function(){e.doIgnore=!1},0),!1)}},{key:"undo",value:function(){var e=this;if(this.shouldIgnoreTest()||!V.canUndo())return!1;var t=V.undo(),i=this.getKlCanvas();V.pause(!0);var n=this.getInitState(),r={w:i.getWidth(),h:i.getHeight()};i.copy(n.canvas);var a=n.focus;this.setCurrentLayerCtx((0,_.throwIfNull)(i.getLayerContext(a)));var s={};return Object.entries(rW.brushes).forEach(function(t){var i=(0,P._)(t,2),n=i[0],r=i[1];s[n]=new r,s[n].setContext(e.getCurrentLayerCtx())}),s.SketchyBrush.setSeed(n.brushes.SketchyBrush.getSeed()),t.forEach(function(t){a=rO(t,a,i,s,function(t){return e.setCurrentLayerCtx(t)},function(){return(0,_.throwIfNull)(e.getCurrentLayerCtx())})}),(r.w!==i.getWidth()||r.h!==i.getHeight())&&(this.klCanvasWorkspace.resetOrFitView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())),this.layerManager.update(a),this.layerPreview.setLayer((0,_.throwIfNull)(i.getLayer(a))),this.brushUiMap.sketchyBrush.setSeed(s.SketchyBrush.getSeed()),this.getCurrentBrush().setContext(this.getCurrentLayerCtx()),this.klCanvasWorkspace.setLastDrawEvent(),V.pause(!1),!0}},{key:"redo",value:function(){var e=this;if(this.shouldIgnoreTest()||!V.canRedo())return!1;var t=V.redo();if(!t)return setTimeout(function(){throw Error("redo failed. redo entry undefined")}),!1;var i=this.getKlCanvas();V.pause(!0);var n={w:i.getWidth(),h:i.getHeight()},r={};Object.entries(rW.brushes).forEach(function(t){var i=(0,P._)(t,2),n=i[0],a=i[1];r[n]=new a,r[n].setContext(e.getCurrentLayerCtx())}),r.SketchyBrush.setSeed(this.brushUiMap.sketchyBrush.getSeed()),rO(t,0,i,r,function(t){return e.setCurrentLayerCtx(t)},function(){return(0,_.throwIfNull)(e.getCurrentLayerCtx())}),(n.w!==i.getWidth()||n.h!==i.getHeight())&&(this.klCanvasWorkspace.resetOrFitView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg()));var a=(0,_.throwIfNull)(i.getLayerIndex(this.getCurrentLayerCtx().canvas));return this.layerManager.update(a),this.layerPreview.setLayer(i.getLayer(a)),this.brushUiMap.sketchyBrush.setSeed(r.SketchyBrush.getSeed()),this.getCurrentBrush().setContext(this.getCurrentLayerCtx()),this.klCanvasWorkspace.setLastDrawEvent(),V.pause(!1),!0}},{key:"catchup",value:function(e){if(e&&e.bufferUpdate){var t=this.getInitState(),i=t.canvas.getLayerContext(t.focus);t.focus=rO(e.bufferUpdate,t.focus,t.canvas,t.brushes,function(e){i=e},function(){return(0,_.throwIfNull)(i)})}}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),rz=function(){function e(t,i,n,r,a,s,o){if((0,O._)(this,e),this.onSetColor=t,this.onSetSize=i,this.onSetOpacity=n,this.onGetColor=r,this.onGetSize=a,this.onGetOpacity=s,this.onGetSliderConfig=o,this.subscriberArr=[],e.instance)throw Error("BrushSettingService already instantiated");e.instance=this}return(0,D._)(e,[{key:"emit",value:function(e,t){for(var i=0;i<this.subscriberArr.length;i++)this.subscriberArr[i]!==t&&this.subscriberArr[i](e)}},{key:"emitColor",value:function(e,t){this.emit({type:"color",value:e},t)}},{key:"emitSize",value:function(e,t){this.emit({type:"size",value:e},t)}},{key:"emitOpacity",value:function(e,t){this.emit({type:"opacity",value:e},t)}},{key:"emitSliderConfig",value:function(e,t){this.emit({type:"sliderConfig",value:e},t)}},{key:"setColor",value:function(e,t){this.onSetColor(e),this.emitColor(e,t)}},{key:"setSize",value:function(e,t){this.onSetSize(e)}},{key:"setOpacity",value:function(e,t){this.onSetOpacity(e)}},{key:"getColor",value:function(){return this.onGetColor()}},{key:"getSize",value:function(){return this.onGetSize()}},{key:"getOpacity",value:function(){return this.onGetOpacity()}},{key:"getSliderConfig",value:function(){return this.onGetSliderConfig()}},{key:"subscribe",value:function(e){this.subscriberArr.includes(e)||this.subscriberArr.push(e)}},{key:"unsubscribe",value:function(e){for(var t=0;t<this.subscriberArr.length;t++)e===this.subscriberArr[t]&&(this.subscriberArr.splice(t,1),t--)}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),z=I("bX4ja"),W=I("eWjiX"),r_={};r_=I("f6OTe").getBundleURL("lYbF2")+"bitbof-logo.bc5e3ed5.svg";var rj={};rj=I("f6OTe").getBundleURL("lYbF2")+"ui-swap-lr.7f474f51.svg";var n5=I("6l0gQ"),eI=I("1C8RU"),_=I("7jh4K"),W=I("eWjiX"),rF=function(){function e(i,n,r){(0,O._)(this,e);var a=function(e){return"dark"===e?" "+J("theme-dark"):" "+J("theme-light")},s=function(){return(0,W.BB).el({tagName:"a",content:J("licenses"),onClick:function(){var e,t,i,n;return t=ev("."+(e=eC({display:"flex",flexDirection:"column",gap:"10px","details > div":{padding:"10px",boxShadow:"0 0 0 1px",marginTop:"5px",fontFamily:"monospace",background:"#aaa2",overflow:"hidden"},summary:{cursor:"pointer",userSelect:"none"}})),J("loading")),i=ev("."+e,J("loading")),n=ev(",flex,flexCol,gap-10",[t,i]),void(new ei({title:(0,W.BB).el({content:J("licenses")}),content:(0,W.BB).el({content:n,css:{height:"100%",overflowY:"auto",padding:"10px",boxSizing:"border-box"}}),width:800,isMaxHeight:!0,onClose:function(){"#licenses"===window.location.hash&&history.replaceState("",document.title,window.location.pathname+window.location.search)}}),I("9I1T6").then(function(e){t.innerHTML="",e.licenses.forEach(function(e){t.append(ev("details",[ev("summary",e.title),ev("",e.full.replace(/\n/g,"<br>"))]))})}),I("iaSvl").then(function(e){i.innerHTML="",e.fontLicenses.forEach(function(e){i.append(ev("details",[ev("summary","Font: "+e.title),ev("",e.full.replace(/\n/g,"<br>"))]))})}))}})};this.rootEl=(0,W.BB).el({css:{margin:"10px"}});var o=Z.getAutoLanguage(),l=(0,W.BB).el({parent:this.rootEl,content:(0,W.BB).el({content:J("settings-language")+":",css:{marginRight:"5px",marginBottom:"2px"}}),css:{display:"flex",alignItems:"center",flexWrap:"wrap"}}),h=[["auto",J("auto")+"  ".concat(o.name," (").concat(o.code,")")]].concat((0,z._)(Y.map(function(e){return[e.code,e.name+" (".concat(e.code,")")]}))),c=new rW.Select({initValue:(0,_.nullToUndefined)((0,n5.LocalStorage).getItem(G)?(0,n5.LocalStorage).getItem(G):"auto"),optionArr:h,onChange:function(e){"auto"===e?(0,n5.LocalStorage).removeItem(G):(0,n5.LocalStorage).setItem(G,e),u.style.display="block"}});(0,W.BB).css(c.getElement(),{flexGrow:"1"});var u=(0,W.BB).el({className:"kl-toolspace-note",content:J("settings-language-reload"),css:{display:"none",marginTop:"5px",flexGrow:"1"}});l.append(c.getElement(),u);var p=new rW.Select({optionArr:[["auto",J("auto")+"  "+a((0,eI.theme).getMediaQueryTheme())],["light",a("light")],["dark",a("dark")]],initValue:(0,eI.theme).getStoredTheme()||"auto",onChange:function(e){(0,eI.theme).setStoredTheme("auto"===e?void 0:e)}});if((0,W.BB).css(p.getElement(),{flexGrow:"1"}),(0,_.addIsDarkListener)(function(){p.updateLabel("auto",J("auto")+"  "+a((0,eI.theme).getMediaQueryTheme()))}),(0,W.BB).el({parent:this.rootEl,content:[(0,W.BB).el({content:J("settings-theme")+":",css:{marginRight:"5px",marginBottom:"2px"}}),p.getElement()],css:{marginTop:"15px",display:"flex",alignItems:"center",flexWrap:"wrap"}}),n){var d=new rW.Select({optionArr:[["20min",J("x-minutes",{x:"20"})],["40min",J("x-minutes",{x:"40"})],["disabled"," "+J("settings-save-reminder-disabled")]],initValue:n.getSetting(),onChange:function(e){if("disabled"!==e){n.setSetting(e);return}var t=J("settings-save-reminder-confirm-disable");et({target:document.body,message:""+J("settings-save-reminder-confirm-title"),div:ev("",[ev(".info-hint",J("settings-save-reminder-confirm-a")),J("settings-save-reminder-confirm-b")]),buttons:[t,"Cancel"],callback:function(i){i===t?n.setSetting(e):d.setValue(n.getSetting())}})}});d.getElement().style.flexGrow="1",this.rootEl.append(ev(",flex,items-center,gap-5,mt-15,flexWrap",[J("settings-save-reminder-label")+":",d.getElement()]))}(0,W.BB).el({tagName:"button",parent:this.rootEl,content:'<img height="20" width="18" src="'+t(rj)+'" alt="icon" style="margin-right: 5px"/>'+J("switch-ui-left-right"),onClick:function(){return i()},css:{marginTop:"15px"},custom:{tabIndex:"-1"}}),this.rootEl.append((0,W.BB).el({className:"grid-hr",css:{margin:"10px 0"}})),r?(this.rootEl.append(r),r.innerHTML||(0,W.BB).el({parent:r,css:{textAlign:"center"}}).append((0,W.BB).el({content:'<img alt="icon" height="20" style="vertical-align:middle" src="'.concat(t(r_),'"> <a href="https://bitbof.com" target="_blank" tabIndex="-1">bitbof</a>  2023<br>')}),s())):(0,W.BB).el({parent:this.rootEl,css:{textAlign:"center"},content:'\n<img alt="Klecks" class="dark-invert" height="25" src="'.concat(t(t5),'"><br>\n<img alt="icon" height="20" style="vertical-align:middle" src="').concat(t(r_),'"> <a href="https://bitbof.com" target="_blank" tabIndex="-1">bitbof</a>  2023<br>')}).append(s(),document.createTextNode(" | "),(0,W.BB).el({tagName:"a",content:J("donate"),custom:{href:"https://kleki.com/donate/",target:"_blank"}}),document.createTextNode(" | "),(0,W.BB).el({tagName:"a",content:J("source-code"),custom:{href:"https://klecks.org",target:"_blank"}})),window.addEventListener("storage",function(e){e.key===G&&c.setValue((0,_.nullToUndefined)((0,n5.LocalStorage).getItem(G)?(0,n5.LocalStorage).getItem(G):"auto"))})}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),rV=function(){function e(t){var i=this;(0,O._)(this,e),this.toolspace=t.toolspace,this.upBtn=(0,W.BB).el({parent:this.toolspace,title:J("scroll"),className:"kl-scroller",css:{top:"0",transform:"rotate(180deg)"}}),this.downBtn=(0,W.BB).el({parent:this.toolspace,title:J("scroll"),className:"kl-scroller",css:{bottom:"0"}}),this.updateUiState(t.uiState),new W.BB.PointerListener({target:this.upBtn,onPointer:function(e){"pointerdown"===e.type&&(i.upInterval=setInterval(function(){i.toolspace.scrollBy(0,-13),i.update()},20)),"pointerup"===e.type&&(clearInterval(i.upInterval),setTimeout(function(){i.upInterval=null,i.update()},50))}}),new W.BB.PointerListener({target:this.downBtn,onPointer:function(e){"pointerdown"===e.type&&(i.downInterval=setInterval(function(){i.toolspace.scrollBy(0,13),i.update()},20)),"pointerup"===e.type&&(clearInterval(i.downInterval),setTimeout(function(){i.downInterval=null,i.update()},50))}});var n=function(e){i.toolspace.scrollBy(0,Math.round(.7*e.deltaY)),i.update()};this.upBtn.addEventListener("wheel",n),this.downBtn.addEventListener("wheel",n),this.update(),new MutationObserver(function(){return i.update()}).observe(this.toolspace,{attributes:!0,childList:!0,subtree:!0}),window.addEventListener("resize",function(){return i.update()}),H.subscribe(function(e){i.upBtn.style.opacity=e>=1?"0":"",i.downBtn.style.opacity=e>=1?"0":""})}return(0,D._)(e,[{key:"update",value:function(){var e=this.upBtn.style.display,t=this.downBtn.style.display;this.toolspace.scrollHeight>this.toolspace.offsetHeight+3?(this.upInterval||(e=0===this.toolspace.scrollTop?"none":"block"),this.downInterval||(t=this.toolspace.scrollTop+this.toolspace.offsetHeight+1>=this.toolspace.scrollHeight?"none":"block")):(e="none",t="none"),e!==this.upBtn.style.display&&(this.upBtn.style.display=e),t!==this.downBtn.style.display&&(this.downBtn.style.display=t)}},{key:"updateUiState",value:function(e){(0,W.BB).css(this.upBtn,{left:"left"===e?"0":"",right:"right"===e?"0":""}),(0,W.BB).css(this.downBtn,{left:"left"===e?"0":"",right:"right"===e?"0":""})}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),rH=function(){function e(t){var i=this;(0,O._)(this,e),this.settings={opacity:1,type:"linear",doLockAlpha:!1,doSnap:!1,isReversed:!1,isEraser:!1},this.colorSlider=t.colorSlider,this.rootEl=(0,W.BB).el({css:{margin:"10px"}}),this.isVisible=!0,this.colorDiv=(0,W.BB).el({parent:this.rootEl,css:{marginBottom:"10px"}}),this.iconArr=[],[0,1,2].forEach(function(){var e=(0,W.BB).el({className:"dark-invert",css:{width:"33px",height:"33px",borderRadius:"3px",margin:"1px"}});i.iconArr.push(e)}),this.updateIcons();var n=new eD({optionArr:[{id:"linear",label:this.iconArr[0],title:J("gradient-linear")},{id:"linear-mirror",label:this.iconArr[1],title:J("gradient-linear-mirror")},{id:"radial",label:this.iconArr[2],title:J("gradient-radial")}],initId:"linear",onChange:function(e){i.settings.type=e}});this.rootEl.append(n.getElement());var r=new ed({label:J("opacity"),width:250,height:30,min:.01,max:1,value:this.settings.opacity,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e},onChange:function(e){i.settings.opacity=e}});(0,W.BB).css(r.getElement(),{marginTop:"10px"}),this.rootEl.append(r.getElement());var a=(0,W.BB).el({parent:this.rootEl,css:{display:"flex",alignItems:"center",marginTop:"10px"}}),s=new en({init:!1,label:J("reverse"),callback:function(e){i.settings.isReversed=e,i.updateIcons()},css:{width:"50%"}}),o=new en({init:!1,label:J("angle-snap"),title:J("angle-snap-title"),callback:function(e){i.settings.doSnap=e},css:{width:"50%"}});a.append(s.getElement(),o.getElement());var l=(0,W.BB).el({parent:this.rootEl,css:{display:"flex",alignItems:"center",marginTop:"10px"}}),h=new en({init:this.settings.isEraser,label:J("eraser"),callback:function(e){i.settings.isEraser=e},css:{width:"50%"}}),c=new en({init:!1,label:J("lock-alpha"),title:J("lock-alpha-title"),callback:function(e){i.settings.doLockAlpha=e},doHighlight:!0,css:{width:"50%"}});l.append(h.getElement(),c.getElement())}return(0,D._)(e,[{key:"updateIcons",value:function(){var e=this.settings.isReversed?"#0000":"#000",t=this.settings.isReversed?"#000":"#0000";this.iconArr[0].style.background="linear-gradient(".concat(e,", ").concat(t,")"),this.iconArr[1].style.background="linear-gradient(".concat(t,", ").concat(e,", ").concat(t,")"),this.iconArr[2].style.background="radial-gradient(".concat(e,", ").concat(t,")")}},{key:"getElement",value:function(){return this.rootEl}},{key:"setIsVisible",value:function(e){this.isVisible=!!e,this.rootEl.style.display=e?"block":"none",e&&this.colorDiv.append(this.colorSlider.getElement(),this.colorSlider.getOutputElement())}},{key:"getSettings",value:function(){return(0,W.BB).copyObj(this.settings)}}]),e}(),rW={brushes:nW,brushesUI:{penBrush:nX,blendBrush:nN,sketchyBrush:nU,pixelBrush:nG,chemyBrush:nQ,smudgeBrush:nq,eraserBrush:nK},BrushSettingService:rz,KlCanvas:tB,drawProject:tm,WorkspaceSvgOverlay:tR,KlCanvasWorkspace:tV,KlCanvasPreview:tH,filterLibStatus:nb,filterLib:nB,UndoRedoCatchup:rD,renderText:tv,floodFillBits:td,ShapeTool:tg,drawShape:tf,GradientTool:ty,drawGradient:tx,PSD:iZ,setDbName:i8,indexedDb:i3,ProjectStore:n4,loadAgPsd:rA,SaveToComputer:rP,calcSliderFalloffFactor:eu,Checkbox:en,input:er.input,Select:ea,ImageToggle:es,ImageRadioList:eo,RadioList:nJ,createPenPressureToggle:ec,KlSlider:ed,HexColorDialog:eS,KlColorSlider:eT,KlColorSliderSmall:eM,PointSlider:eL,ColorOptions:eO,Options:eD,BoxToggle:eh,StatusOverlay:e_,CropCopy:th,FreeTransform:tU,FreeTransformCanvas:tK,Cropper:tq,LayerPreview:tQ,KlImageDropper:function e(t){var i=this;(0,O._)(this,e),this.rootEl=(0,W.BB).el({content:"Drop to import",css:{paddingTop:"100px",position:"fixed",left:"0",top:"0",width:"100%",height:"100%",background:"rgba(50, 50, 50, 0.7)",color:"#fff",textShadow:"2px 2px #000",textAlign:"center",fontSize:"25px"}});var n=(0,W.BB).el({css:{marginTop:"50px",display:"flex",justifyContent:"center"}}),r={width:"200px",padding:"50px",margin:"10px",borderRadius:"20px",border:"1px dashed #fff",background:"#00aefe",fontWeight:"bold"},a=(0,W.BB).el({content:"As Layer",css:r}),s=(0,W.BB).el({content:"As New Image",css:r});this.rootEl.append(n),n.append(a,s);var o=0,l=0,h=0,c=function(){o=0,l=0,h=0,i.rootEl.remove()},u=function(e){return!!e.dataTransfer&&!e.dataTransfer.types.includes("text/plain")},p=function(){var e="0 0 20px 4px #fff";l>0?(a.style.boxShadow=e,s.style.boxShadow=""):h>0?(a.style.boxShadow="",s.style.boxShadow=e):(a.style.boxShadow="",s.style.boxShadow="")};a.addEventListener("dragenter",function(){l++,p()}),a.addEventListener("dragleave",function(){l--,p()}),s.addEventListener("dragenter",function(){h++,p()}),s.addEventListener("dragleave",function(){h--,p()}),window.addEventListener("dragover",function(e){u(e)&&(e.stopPropagation(),e.preventDefault())},!1),window.addEventListener("dragenter",function(e){t.enabledTest()&&u(e)&&(0===o&&t.target.append(i.rootEl),o++)},!1),window.addEventListener("dragleave",function(e){u(e)&&0!==o&&0===(o=Math.max(0,o-1))&&i.rootEl.remove()},!1),window.addEventListener("drop",function(e){if(!u(e)||!e.dataTransfer||0===e.dataTransfer.files.length){c();return}e.stopPropagation(),e.preventDefault();var n="default";l>0?n="layer":h>0&&(n="image"),t.onDrop(e.dataTransfer.files,n),o>0&&i.rootEl.remove(),o=0,l=0,h=0,p()},!1),this.rootEl.addEventListener("pointerdown",function(){c()}),new W.BB.KeyListener({onDown:function(e){o>0&&"esc"===e&&c()}})},OverlayToolspace:t2,ToolspaceTopRow:t9,ToolDropdown:is,ToolspaceToolRow:il,ToolspaceStabilizerRow:ih,TabRow:iu,ToolspaceCollapser:ib,BrowserStorageUi:n$,SaveReminder:rL,ToolspaceScroller:rV,dialogCounter:H,popup:et,Popup:ei,clipboardDialog:function(e,t,i,n,r){var a,s,o=!1;try{o=!!ClipboardItem}catch(e){}var l=document.createElement("div"),h=window.innerWidth<550||window.innerHeight<550,c=(0,W.BB).el({content:J("crop-drag-to-crop")+(o?"":"<br>"+J("cropcopy-click-hold")),css:{textAlign:"center"}});l.append(c);var u=new th({width:h?340:540,height:h?300:350,canvas:t,isNotCopy:!1,onChange:function(){return setTimeout(function(){o&&(clearTimeout(a),a=setTimeout(function(){u.getCroppedCanvas().toBlob(function(e){p=null!=e?e:void 0},"image/png")},50))})}});(0,W.BB).css(u.getEl(),{marginTop:"10px",marginLeft:"-20px"}),l.append(u.getEl());var p=void 0;function d(){return g.apply(this,arguments)}function g(){return(g=M(function(){var e;return R(this,function(t){switch(t.label){case 0:if(!p)return[2];t.label=1;case 1:return t.trys.push([1,3,,4]),[4,navigator.clipboard.write([new ClipboardItem((0,tc._)({},p.type,p))])];case 2:return t.sent(),setTimeout(function(){n.out(J("cropcopy-copied"),!0)},200),[3,4];case 3:return console.error((e=t.sent()).name,e.message),[2];case 4:return[2]}})})).apply(this,arguments)}var f=new W.BB.KeyListener({onDown:function(e,t,i){["ctrl+c","cmd+c"].includes(i)&&(d(),s&&s())}});function v(){s&&s()}window.addEventListener("blur",v);var m=[];o&&m.push(J("cropcopy-btn-copy")),r&&m.push(J("cropcopy-btn-crop")),m.push("Cancel"),et({target:e,message:"<b>"+(r?"".concat(J("cropcopy-title-copy")," / ").concat(J("cropcopy-title-crop")):"".concat(J("cropcopy-title-copy")))+"</b>",div:l,style:h?{}:{width:"540px"},buttons:m,primaries:[J("cropcopy-btn-copy")],callback:function(e){if(e===J("cropcopy-btn-copy"))d();else if(e===J("cropcopy-btn-crop")){var n=u.getRect();i({left:Math.round(-n.x),right:Math.round(n.x+n.width-t.width),top:Math.round(-n.y),bottom:Math.round(n.y+n.height-t.height)})}window.removeEventListener("blur",v),(0,W.BB).freeCanvas(u.getCroppedCanvas()),u.destroy(),f.destroy()},clickOnEnter:J("cropcopy-btn-copy"),closeFunc:function(e){s=e}})},showImportAsLayerDialog:function(e){var t=document.createElement("div");if((0,W.BB).appendTextDiv(t,J("import-as-layer-description")),e.klCanvas.isLayerLimitReached()){var i=(0,W.BB).el({content:J("import-as-layer-limit-reached"),css:{background:"#ff0",padding:"10px",marginTop:"5px",marginBottom:"5px",border:"1px solid #e7d321",borderRadius:"5px"}});t.append(i)}var n=tZ(),r=(0,W.BB).el({css:{display:"flex"}}),a=(0,W.BB).el({tagName:"button",content:"1:1",css:{marginRight:"10px"},onClick:function(){u.reset()}}),s=(0,W.BB).el({tagName:"button",content:J("import-as-layer-fit"),css:{marginRight:"10px"},onClick:function(){u.setTransformFit()}}),o=(0,W.BB).el({tagName:"button",content:J("center"),css:{marginRight:"10px"},onClick:function(){u.setTransformCenter()}});r.append(a,s,o),t.append(r);for(var l=[],h=e.klCanvas.getLayers(),c=0;c<h.length;c++)l.push({image:h[c].context.canvas,isVisible:h[c].isVisible,opacity:h[c].opacity,mixModeStr:h[c].mixModeStr});l.push({image:e.importImage,isVisible:!0,opacity:1,mixModeStr:"source-over"});var u=new tK({elementWidth:t0(n),elementHeight:t1(n)+50,imageWidth:e.klCanvas.getLayerContext(0).canvas.width,imageHeight:e.klCanvas.getLayerContext(0).canvas.height,layers:l,transformIndex:l.length-1});function p(e,t){u.move(e,t)}(0,W.BB).css(u.getElement(),{marginTop:"10px",marginLeft:"-20px"}),t.append(u.getElement());var d=new W.BB.KeyListener({onDown:function(e){"left"===e&&p(-1,0),"right"===e&&p(1,0),"up"===e&&p(0,-1),"down"===e&&p(0,1)}});et({target:e.target,message:"<b>".concat(J("import-as-layer-title"),"</b>"),div:t,style:n?void 0:{width:"540px"},buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(t){d.destroy(),u.destroy(),(0,W.BB).destroyEl(a),(0,W.BB).destroyEl(s),(0,W.BB).destroyEl(o),"Ok"===t?e.callback(u.getTransformation(),u.getIsPixelated()):e.callback()}})},newImageDialog:function(e){var t=e.currentColor,i=e.secondaryColor,n=e.maxCanvasSize,r=e.canvasWidth,a=e.canvasHeight,s=e.workspaceWidth,o=e.workspaceHeight,l=e.onConfirm,h=e.onCancel;function c(e,t,i,r,a){return(0,W.BB).fitInto(e,t,Math.min(n,i-a),Math.min(n,r-a),1)}var u=(0,W.BB).el(),p=(0,W.BB).el({tagName:"input"}),d={color:"#888",fontSize:"12px",marginLeft:"5px"},g=(0,W.BB).el({textContent:J("new-px"),css:d}),f=(0,W.BB).el({tagName:"input"}),v=(0,W.BB).el({textContent:J("new-px"),css:d});p.setAttribute("data-ignore-focus","true"),f.setAttribute("data-ignore-focus","true"),p.type="number",p.min="1",p.max=""+n,(0,W.BB).css(p,{width:"70px"}),f.type="number",f.min="1",f.max=""+n,f.style.width="70px",p.value=""+r,f.value=""+a,p.onclick=function(){p.focus(),P()},f.onclick=function(){f.focus(),P()};var m=iy([[J("width")+":&nbsp;",p,g],[(0,W.BB).el({css:{height:"5px"}}),"",""],[J("height")+":&nbsp;",f,v]]);(0,W.BB).css(m,{marginBottom:"10px"});var y=(0,W.BB).el({css:{marginTop:"5px",color:"#888"}}),x=(0,W.BB).el(),b=(0,W.BB).el({tagName:"button"});x.style.marginBottom="10px";var B=(0,W.BB).el({tagName:"button"}),w=(0,W.BB).el({tagName:"button"}),k=(0,W.BB).el({tagName:"button"}),C=(0,W.BB).el({tagName:"button"}),S=(0,W.BB).el({tagName:"button"});B.textContent=J("new-current"),b.textContent=J("new-fit"),S.textContent=J("new-oversize"),k.textContent=J("new-landscape"),C.textContent=J("new-portrait"),w.textContent=J("new-square"),B.style.marginRight="5px",b.style.marginRight="5px",S.style.marginRight="5px",k.style.marginTop="5px",k.style.marginRight="5px",C.style.marginTop="5px",C.style.marginRight="5px",x.append(B,b,S,w,k,C),B.onclick=function(){p.value=""+r,f.value=""+a,P()},b.onclick=function(){p.value=""+s,f.value=""+o,P()},S.onclick=function(){p.value=""+(s+500),f.value=""+(o+500),P()},w.onclick=function(){var e=c(1,1,s,o,0);p.value=""+Math.round(e.width),f.value=""+Math.round(e.height),P()},k.onclick=function(){var e=c(4,3,s,o,0);p.value=""+Math.round(e.width),f.value=""+Math.round(e.height),P()},C.onclick=function(){var e=c(3,4,s,o,0);p.value=""+Math.round(e.width),f.value=""+Math.round(e.height),P()};var E=new ea({isFocusable:!0,optionArr:[["screen",J("new-screen")],["16 9",J("new-video")+" 16:9"],["3 2","3:2"],["5 3","5:3"],["2 1","2:1"],["paper",J("new-din-paper")+" 2:1"],["9 16","9:16"],["2 3","2:3"],["3 5","3:5"],["1 2","1:2"],["1 1.4142135623730951","1:2"]],onChange:function(e){if("screen"===e)p.value=""+window.screen.width,f.value=""+window.screen.height;else if("paper"===e){var t=c(Math.sqrt(2),1,s,o,0);p.value=""+Math.round(t.width),f.value=""+Math.round(t.height)}else{var i=e.split(" "),n=c(parseFloat(i[0]),parseFloat(i[1]),s,o,0);p.value=""+Math.round(n.width),f.value=""+Math.round(n.height)}P(),E.setValue(void 0)}});setTimeout(function(){E.setValue(void 0)},0),(0,W.BB).css(E.getElement(),{width:"80px"}),x.append(E.getElement());var I={r:255,g:255,b:255,a:1},A=[{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1},{r:0,g:0,b:0,a:0},{r:t.r,g:t.g,b:t.b,a:1},{r:i.r,g:i.g,b:i.b,a:1}],T=0;(0,eI.theme).isDark()&&A.forEach(function(e,t){e.r===eA&&e.g===eA&&e.b===eA&&(T=t,I=e)});var M=new eO({colorArr:A,initialIndex:T,onChange:function(e){I=e,R.style.backgroundColor="rgba("+e.r+","+e.g+","+e.b+", "+e.a+")"}}),L=(0,W.BB).el({className:"kl-transparent-preview",css:{boxSizing:"border-box",width:"340px",height:"140px",display:"table",padding:"10px",marginTop:"10px",marginLeft:"-20px"}}),R=(0,W.BB).el({className:"kl-transparent-preview__canvas",css:{width:"200px",height:"100px",backgroundColor:"rgba("+I.r+","+I.g+","+I.b+", "+I.a+")",marginLeft:"auto",marginRight:"auto",color:"#aaa",fontSize:"16px",fontWeight:"bold",textAlign:"center",verticalAlign:"center",display:"table",overflow:"hidden"}});function P(){p.value=""+Math.min(n,parseInt(p.value)),f.value=""+Math.min(n,parseInt(f.value));var e=parseInt(p.value),t=parseInt(f.value);(e<1||e>n||t<1||t>n)&&(e>n?e=n:t>n&&(t=n),p.value=""+e,f.value=""+t);for(var i=[[1,2],[2,1],[2,3],[3,2],[3,4],[4,3],[4,5],[5,4],[16,9],[9,16],[3,2],[2,3],[5,3],[3,5],[2,1],[1,2],[1.414,1],[1,1.414]],r=(0,W.BB).reduce(e,t),a=i[0],s=Math.abs(i[0][0]/i[0][1]-r[0]/r[1]),o=0;o<i.length;o++)Math.abs(i[o][0]/i[o][1]-r[0]/r[1])<s&&(a=i[o],s=Math.abs(i[o][0]/i[o][1]-r[0]/r[1]));s>0&&s<.005?y.innerText=J("new-ratio")+": ~"+a[0]+":"+a[1]:y.innerText=J("new-ratio")+": "+r[0]+":"+r[1];var l=e,h=function(e,t){for(var i=e,n=t;;){if(!(i%=n))return n;if(!(n%=i))return i}}(e,t);e/=h,t/=h,t*=260,(e*=260)>260&&(t=260/e*t,e=260),t>100&&(e=100/t*e,t=100),R.style.width=e+"px",R.style.height=t+"px",(0,W.BB).createCheckerDataUrl(parseInt(""+e/l*30),function(e){L.style.background="url("+e+")"},(0,eI.theme).isDark())}(0,W.BB).el({parent:L,content:R,css:{display:"table-cell",verticalAlign:"middle"}}),(0,W.BB).el({parent:R,css:{display:"table-cell",verticalAlign:"middle"}}),(0,eI.theme).addIsDarkListener(P),p.onchange=function(){(""===p.value||0>parseInt(p.value))&&(p.value="1"),P()},p.onkeyup=function(){P()},f.onchange=function(){(""===f.value||0>parseFloat(f.value))&&(f.value="1"),P()},f.onkeyup=function(){P()},P(),u.append(x);var O=(0,W.BB).el({parent:u,css:{display:"flex",justifyContent:"space-between",alignItems:"flex-end"}});(0,W.BB).el({parent:O}).append(m,y),O.append(M.getElement()),u.append(L),et({target:document.body,message:"<b>".concat(J("new-title"),"</b>"),div:u,buttons:["Ok","Cancel"],callback:function(e){if((0,W.BB).unsetEventHandler(p,"onclick","onchange","onkeyup"),(0,W.BB).unsetEventHandler(p,"onclick","onchange","onkeyup"),(0,W.BB).unsetEventHandler(B,"onclick"),(0,W.BB).unsetEventHandler(b,"onclick"),(0,W.BB).unsetEventHandler(S,"onclick"),(0,W.BB).unsetEventHandler(w,"onclick"),(0,W.BB).unsetEventHandler(k,"onclick"),(0,W.BB).unsetEventHandler(C,"onclick"),E.destroy(),M.destroy(),(0,eI.theme).removeIsDarkListener(P),"Cancel"===e||0>=parseInt(p.value)||0>=parseInt(f.value)||isNaN(parseInt(p.value))||isNaN(parseInt(f.value))){h();return}l(parseInt(p.value),parseInt(f.value),I)},clickOnEnter:"Ok"})},textToolDialog:function(e){var t=(0,W.BB).el({}),i=(0,W.BB).copyObj(e.text),n=(0,W.BB).el({className:y}),r=new iQ({text:i,klCanvas:e.klCanvas,layerIndex:e.layerIndex,onDragEnd:function(){return"text"===u.getOpenedTabId()?c.focus():0}});function a(e){i=(0,X._)({},i,e),r.setText(i)}r.render();var s=new iG((0,eR._)((0,X._)({},i),{onUpdate:function(e){a(e)}})),o=(0,W.BB).el({css:{display:"flex",gap:"10px",flexDirection:"column"}}),l=new iB({fill:i.fill,primaryColor:e.primaryColor,secondaryColor:e.secondaryColor,onUpdate:function(e){a(e)}}),h=new iK({stroke:i.stroke,primaryColor:e.primaryColor,secondaryColor:e.secondaryColor,onUpdate:function(e){a(e)}}),c=new iq({text:i.text,onUpdate:function(e){void 0!==e.text&&m.setIgnoreBackground(e.text.length>0),a(e)}}),u=new iu({initialId:"text",height:40,tabArr:[{id:"text",label:J("text-text"),onOpen:function(){c.getElement().style.display="",c.focus()},onClose:function(){c.getElement().style.display="none"}},{id:"font",label:J("text-font"),onOpen:function(){s.getElement().style.display="flex"},onClose:function(){s.getElement().style.display="none"}},{id:"color",label:J("text-color"),onOpen:function(){o.style.display="flex"},onClose:function(){o.style.display="none"}}]});u.getElement().classList.add(eC({minWidth:"200px",maxWidth:"500px",flexGrow:"1",borderBottom:"none !important"}));var p=eC({position:"relative",">*":{position:"absolute",right:0,top:10}}),d=eC({display:"flex",justifyContent:"space-between",flexDirection:"row-reverse",flexWrap:"wrap",marginTop:"10px",marginLeft:"-20px",marginRight:"-20px",padding:"0 20px","@media (min-width: 700px) and (min-height: 700px)":{display:"none !important"}}),g=eC({minHeight:72,marginTop:"10px","@media (min-width: 700px) and (min-height: 700px)":{display:"flex",flexDirection:"column",gap:"10px",">*":{display:"flex !important"}}});t.append(ev("",[ev(n,[r.getElement()]),ev("."+p,[r.getInputsElement()]),ev(".tabrow."+d,[ev(",w-240,h-40"),u.getElement()]),ev("."+g,[ev(o,[l.getElement(),h.getElement()]),s.getElement(),c.getElement()])]));var f=function(){var e=n.getBoundingClientRect(),t=Math.ceil(e.width),i=Math.ceil(e.height);r.setSize(t,i)};function v(){window.scrollTo(0,0)}window.addEventListener("resize",f),setTimeout(function(){f()}),setTimeout(function(){c.focus()},100),window.addEventListener("scroll",v);var m=et({target:document.body,message:"<b>".concat(J("text-title"),"</b>"),div:t,buttons:["Ok","Cancel"],ignoreBackground:e.text.text.length>0,callback:function(t){window.removeEventListener("resize",f),window.removeEventListener("scroll",v),r.destroy(),s.destroy(),l.destroy(),h.destroy(),c.destroy(),u.destroy(),"Ok"===t&&e.onConfirm((0,X._)({},r.getValues(),s.getValues(),l.getValues(),h.getValues(),c.getValues()))},style:{width:"calc(100% - 50px)",maxWidth:"1000px",minWidth:"300px",boxSizing:"border-box"},clickOnEnter:"Ok"})},showImportImageDialog:function(e){var t,i,n=(0,W.BB).el(),r=window.innerWidth<550||window.innerHeight<550,a=(0,W.BB).el({css:{marginTop:"10px",textAlign:"center",color:"#888",lineHeight:"20px"}}),s=new th({width:r?340:540,height:r?300:400,canvas:e.image.canvas,isNotCopy:!0,onChange:function(e,t){a&&o(e,t)}});function o(t,i){var n=(0,W.BB).fitInto(t,i,e.maxSize,e.maxSize);n.width<t?(a.innerHTML='<span class="kl-text-error">'.concat(t," X ").concat(i,"</span>  ").concat(Math.round(n.width)," X ").concat(Math.round(n.height)),a.title=J("import-too-large")):(a.innerHTML="".concat(t," X ").concat(i),a.title="")}(0,W.BB).css(s.getEl(),{marginLeft:"-20px"}),s.getEl().title=J("crop-drag-to-crop"),n.append(s.getEl(),a),o(e.image.width,e.image.height);var l=!1;if("psd"===e.image.type){if(e.image.layers){if(t=new en({init:l,label:J("import-flatten"),callback:function(e){l=e}}),n.append(t.getElement()),e.image.warningArr){var h=(0,W.BB).el({className:"kl-import-note",content:J("import-psd-limited-support")}),c=e.image.warningArr;i=(0,W.BB).el({parent:h,tagName:"a",content:"Details",css:{marginLeft:"5px"},onClick:function(){return function(e){for(var t=[],i={mask:"Masks not supported. Mask was applied.",clipping:"Clipping not supported. Clipping layers were merged.",group:"Groups not supported. Layers were ungrouped.",adjustment:"Adjustment layers not supported.","layer-effect":"Layer effects not supported.","smart-object":"Smart objects not supported.","blend-mode":"Unsupported layer blend mode.","bits-per-channel":"Unsupported color depth. Only 8bit per channel supported."},n=0;n<e.length;n++)t.push("- "+i[e[n]]);alert(t.join("\n"))}(c)}}),n.append(h)}}else{var u=(0,W.BB).el({className:"kl-import-note",content:J("import-psd-unsupported")});n.append(u)}}et({target:e.target,message:"<b>".concat(J("import-title"),"</b>"),div:n,style:r?{}:{width:"540px"},buttons:[J("import-btn-as-layer"),J("import-btn-as-image"),"Cancel"],primaries:[J("import-btn-as-layer"),J("import-btn-as-image")],callback:function(n){var r=s.getCroppedCanvas(),a=s.getRect(),o=e.image.width!==a.width&&e.image.height!==a.height;s.destroy(),(0,W.BB).destroyEl(i),t&&t.destroy(),n===J("import-btn-as-layer")?(e.callback({type:"as-layer",image:o?r:e.image.canvas}),o||(0,W.BB).freeCanvas(r)):n===J("import-btn-as-image")?"psd"===e.image.type?(l&&delete e.image.layers,e.callback({type:"as-image-psd",image:e.image,cropObj:a}),(0,W.BB).freeCanvas(r)):"image"===e.image.type&&e.callback({type:"as-image",image:r}):(e.callback({type:"cancel"}),(0,W.BB).freeCanvas(r))},autoFocus:"As Image"})},showIframePopup:nZ,imgurUpload:function(e,t,i,n){if(!n)throw Error("imgur key missing");var r,a=(0,W.BB).el({tagName:"input"});a.type="text",a.value=J("upload-title-untitled");var s=(0,W.BB).el({tagName:"textarea",custom:{rows:"2"},css:{width:"100%",maxWidth:"100%"}}),o=(0,W.BB).el({textContent:J("upload-name")+":"}),l=(0,W.BB).el({textContent:J("upload-caption")+":",css:{marginTop:"10px"}}),h=(0,W.BB).el({content:'<br/><a href="https://imgur.com/tos" target="_blank" rel="noopener noreferrer">'.concat(J("terms-of-service"),"</a>")}),c=new rW.RadioList({name:"filetype",init:"jpeg",items:[{label:"JPG",value:"jpeg"},{label:"PNG",value:"png"}],ignoreFocus:!0});(0,W.BB).css(c.getElement(),{marginBottom:"10px"});var u=(0,W.BB).el(),p=(0,W.BB).el({className:"info-hint",textContent:J("upload-link-notice")});u.append(p,c.getElement(),o,a,l,s,h),rW.popup({target:t,message:"<b>".concat(J("upload-title"),"</b>"),type:"upload",div:u,buttons:[J("upload-submit"),"Cancel"],clickOnEnter:J("upload-submit"),primaries:[J("upload-submit")],autoFocus:J("upload-submit"),callback:(r=M(function(r){var o;return R(this,function(l){switch(l.label){case 0:if(!(r===J("upload-submit")||"Yes"===r||"Ok"===r))return[3,4];l.label=1;case 1:return l.trys.push([1,3,,4]),[4,function(e,t,i,n,r){return rI.apply(this,arguments)}(e.getCompleteCanvas(1),a.value,s.value,c.getValue(),n)];case 2:return o=l.sent(),rW.popup({target:t,type:"ok",message:"<h3>".concat(J("upload-success"),"</h3><br>").concat(J("upload-delete"),"<br><a target='_blank' rel=\"noopener noreferrer\" href='https://imgur.com/delete/").concat(o.deletehash,"'>imgur.com/delete/").concat(o.deletehash,"</a><br><br>"),buttons:["Ok"]}),i.reset(),[3,4];case 3:return l.sent(),rW.popup({target:t,type:"error",message:J("upload-failed"),buttons:["Ok"]}),[3,4];case 4:return[2]}})}),function(e){return r.apply(this,arguments)})})},HandUi:id,FillUi:ig,GradientUi:rH,TextUi:iv,ShapeUi:im,FileTab:n7,FilterTab:rS,SettingsTab:rF,LayerManager:tL,klHistory:V,DecoyKlHistory:F};Object.keys(rW);var O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),eR=I("4EWN2"),P=I("8N5YG"),z=I("bX4ja"),W=I("eWjiX"),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),rX=function(){function e(i){(0,O._)(this,e);var n=function(e){var t=6+(e.extraPadding?e.extraPadding:0),i=(0,W.BB).el({className:"toolspace-row-button nohighlight",title:e.title,onClick:e.onClick,css:{padding:e.content?"":e.contain?t+"px 0":""}});if(e.content)i.append(e.content);else{var n=(0,W.BB).el({className:"dark-invert",css:{backgroundImage:"url('"+e.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:e.contain?"contain":"",height:"100%"}});n.style.pointerEvents="none",i.append(n)}var r=new W.BB.PointerListener({target:i,onEnterLeave:function(e){i.classList.toggle("toolspace-row-button-hover",e)}});return{el:i,pointerListener:r}};this.rootEl=(0,W.BB).el({className:"kl-toolspace-row",css:{height:"36px",display:"flex"}});var r=n({onClick:i.onSubmit,title:J("submit-title"),content:(0,W.BB).el({content:J("submit"),className:"toolspace-row-button__submit",css:{display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"100%"}}),contain:!0});r.el.style.width="45px";var a=n({onClick:i.onHelp,title:J("help"),image:t(t8),contain:!0}),s=n({onClick:i.onLeftRight,title:J("switch-ui-left-right"),image:t(rj),contain:!0});this.rootEl.append(r.el,s.el,a.el)}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),_=I("7jh4K"),rN=function(){function e(t){var i=this;(0,O._)(this,e),this.texture=void 0,this.oldOnUpdateProps={textureWidth:0,textureHeight:0,transform:{scaleX:0,scaleY:0,angleDeg:0,x:0,y:0}},this.render=function(e,t,n){var r,a=e0(e),s=ej(a,{x:0,y:0}),o=ej(a,{x:i.original.width,y:i.original.height});o.x=Math.round(o.x),o.y=Math.round(o.y);var l={x:Math.max(0,s.x),y:Math.max(0,s.y)},h={x:Math.min(t-0,o.x),y:Math.min(n-0,o.y)};if((r={x:l.x,y:l.y,width:h.x-l.x,height:h.y-l.y}).width<=0||r.height<=0)return i.textureSource.width=1,i.textureSource.height=1,i.textureSource;var c=eG(eF(a),eH(0,0),eH(r.x-0,r.y-0)),u={textureWidth:Math.ceil(r.width),textureHeight:Math.ceil(r.height),transform:{scaleX:e.scaleX,scaleY:e.scaleY,angleDeg:e.angleDeg,x:e.x-r.x,y:e.y-r.y}},p=0,d=0;if(e.scaleX>1){var g=ej(c,{x:0,y:0});p=-g.x,d=-g.y,g.x=Math.max(0,Math.floor(g.x)),g.y=Math.max(0,Math.floor(g.y)),p+=g.x,d+=g.y;var f=ej(c,{x:r.width,y:r.height});f.x=Math.min(i.original.width,Math.ceil(f.x)),f.y=Math.min(i.original.height,Math.ceil(f.y));var v=f.x-g.x,m=f.y-g.y;u.textureWidth=v,u.textureHeight=m,u.transform={scaleX:1,scaleY:1,angleDeg:0,x:-g.x,y:-g.y},c=eG(c,eZ(e.scaleX,e.scaleY),eH(p,d))}i.texture&&JSON.stringify(u)===JSON.stringify(i.oldOnUpdateProps)&&!i.postMix||(i.textureSource.width=u.textureWidth,i.textureSource.height=u.textureHeight,i.ctx.save(),i.ctx.imageSmoothingEnabled=!1,e.scaleX>1?i.ctx.setTransform(e0(u.transform)):i.ctx.setTransform(eF(c)),i.ctx.drawImage(i.original,0,0),i.ctx.restore(),i.texture&&JSON.stringify(u)===JSON.stringify(i.oldOnUpdateProps)||(i.texture&&i.texture.destroy(),i.texture=i.fxCanvas.texture(i.textureSource)),i.postMix||(i.textureSource.width=1,i.textureSource.height=1)),i.oldOnUpdateProps=u;var y=i.onUpdate(i.fxCanvas.draw(i.texture),u.transform).update();return i.postMix?(i.ctx.save(),i.ctx.globalAlpha=i.postMix.opacity,i.ctx.globalCompositeOperation=i.postMix.operation,i.ctx.drawImage(y,0,0),i.ctx.restore(),{image:i.textureSource,transform:c}):{image:y,transform:c}},this.original=t.original,this.onUpdate=t.onUpdate,this.textureSource=(0,W.BB).canvas(1,1),this.ctx=(0,W.BB).ctx(this.textureSource),this.fxCanvas=(0,_.throwIfNull)(rC()),this.postMix=t.postMix}return(0,D._)(e,[{key:"setPostMix",value:function(e){this.postMix=e}},{key:"destroy",value:function(){(0,W.BB).freeCanvas(this.textureSource),this.texture&&(this.texture=this.fxCanvas.texture(this.textureSource),this.fxCanvas.draw(this.texture).update(),this.texture&&this.texture.destroy())}}]),e}(),W=(I("eWjiX"),I("eWjiX")),er=I("dJPtW"),eI=I("1C8RU"),W=I("eWjiX"),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX");function rY(){return(0,W.BB).copyObj({r:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],g:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],b:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]]})}var rU=function(){function e(t){var i=this;(0,O._)(this,e),this.rootEl=(0,W.BB).el({css:{position:"relative",marginBottom:"10px"}}),this.rootEl.oncontextmenu=function(){return!1};var n="All",r=t.curves;this.modeButtons=new eD({optionArr:[{id:"All",label:J("filter-curves-all")},{id:"Red",label:J("red")},{id:"Green",label:J("green")},{id:"Blue",label:J("blue")}],initId:"All",onChange:function(e){"All"===(n=e)&&(r=rY());var t=r.r;"Green"===n&&(t=r.g),"Blue"===n&&(t=r.b),i.p0.setPos(0,o-t[0][1]*o),i.p1.setPos(t[1][0]*s,o-t[1][1]*o),i.p2.setPos(t[2][0]*s,o-t[2][1]*o),i.p3.setPos(s,o-t[3][1]*o),d()}}),this.rootEl.append(this.modeButtons.getElement());var a=(0,W.BB).el({parent:this.rootEl,className:"kl-curves-graph",css:{position:"relative",marginTop:"10px"}}),s=300,o=100,l=(0,W.BB).canvas(s,o),h=(0,W.BB).ctx(l);a.append(l);var c=function(e){return Math.max(0,Math.min(1,e))},u=function(e,t,i,n){var r=t,l=e,h=(0,W.BB).el({className:"kl-curves-graph__grip",css:{left:e-7+"px",top:t-7+"px",width:"14px",height:"14px",borderRadius:"14px"}}),c=function(){(0,W.BB).css(h,{left:e-7+"px",top:t-7+"px"})},u=new W.BB.PointerListener({target:h,onPointer:function(a){a.eventPreventDefault(),"pointerdown"===a.type&&(l=e,r=t),"left"===a.button&&"pointermove"===a.type&&(n||(l+=a.dX),e=Math.max(0,Math.min(s,l)),r+=a.dY,t=Math.max(0,Math.min(o,r)),c(),i({x:e,y:t}))}});return a.append(h),{el:h,setPos:function(i,n){e=i,r=t=n,l=e,(0,W.BB).css(h,{left:e-7+"px",top:t-7+"px"})},pointerListener:u}},p=function(e,t,i){"All"===n&&(r.r[e]=[c(t/s),c(1-i/o)],r.g[e]=[c(t/s),c(1-i/o)],r.b[e]=[c(t/s),c(1-i/o)]),"Red"===n&&(r.r[e]=[c(t/s),c(1-i/o)]),"Green"===n&&(r.g[e]=[c(t/s),c(1-i/o)]),"Blue"===n&&(r.b[e]=[c(t/s),c(1-i/o)])};this.p0=u(0,o,function(e){p(0,e.x,e.y),d()},!0),this.p1=u(s/3,o/3*2,function(e){p(1,e.x,e.y),d()}),this.p2=u(s/3*2,o/3,function(e){p(2,e.x,e.y),d()}),this.p3=u(s,0,function(e){p(3,e.x,e.y),d()},!0);var d=function(){(h=(0,W.BB).ctx(l)).clearRect(0,0,l.width,l.height);for(var e={r:[],g:[],b:[]},i=0;i<r.r.length;i++)e.r.push(r.r[i]),e.g.push(r.g[i]),e.b.push(r.b[i]);var a=function(e){h.beginPath();for(var t=new W.BB.SplineInterpolator(e),i=0;i<100;i++){var n=t.interpolate(i/100);n=Math.max(0,Math.min(1,n)),0===i?h.moveTo(i/100*s,o-n*o):h.lineTo(i/100*s,o-n*o)}h.stroke()};h.save(),"All"===n?(h.strokeStyle="black",a(e.r)):(h.globalAlpha=.5,h.strokeStyle="red",a(e.r),h.strokeStyle="green",a(e.g),h.strokeStyle="blue",a(e.b)),h.restore(),t.callback(e)};d()}return(0,D._)(e,[{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.p0.pointerListener.destroy(),this.p1.pointerListener.destroy(),this.p2.pointerListener.destroy(),this.p3.pointerListener.destroy()}},{key:"getModeButtons",value:function(){return this.modeButtons}}]),e}(),W=I("eWjiX"),_=I("7jh4K"),W=I("eWjiX"),z=I("bX4ja"),W=I("eWjiX"),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),rG=function(){function e(t){var i=this;(0,O._)(this,e),this.value=t.init,this.rootEl=(0,W.BB).el({className:"kl-2-tabs"}),this.leftTab=(0,W.BB).el({parent:this.rootEl,content:t.left,className:"kl-2-tabs__left"}),this.leftTab.onpointerdown=function(){return!1},this.rightTab=(0,W.BB).el({parent:this.rootEl,content:t.right,className:"kl-2-tabs__right"}),this.rightTab.onpointerdown=function(){return!1},this.update(),this.leftTab.onclick=function(){0!==i.value&&(i.value=0,i.update(),t.onChange(i.value))},this.rightTab.onclick=function(){1!==i.value&&(i.value=1,i.update(),t.onChange(i.value))}}return(0,D._)(e,[{key:"update",value:function(){this.leftTab.classList.toggle("kl-2-tabs--active",0===this.value),this.rightTab.classList.toggle("kl-2-tabs--active",1===this.value)}},{key:"getElement",value:function(){return this.rootEl}}]),e}(),_=I("7jh4K"),O=I("cx0mh"),D=I("7h4XF"),X=I("cL71g"),W=I("eWjiX"),rK=function(){function e(t){var i=this;(0,O._)(this,e),this.value=(0,X._)({},t.value),this.transform={x:0,y:0,scale:1,angleDeg:0},this.rootEl=(0,W.BB).el({css:{width:"16px",height:"16px",backgroundColor:"#fff",border:"2px solid #000",borderRadius:"16px",position:"absolute",cursor:"move",userSelect:"none",touchAction:"none"}}),this.pointerListener=new W.BB.PointerListener({target:this.rootEl,onPointer:function(e){e.eventPreventDefault(),"left"===e.button&&"pointermove"===e.type&&(i.value.x+=e.dX/i.transform.scale,i.value.y+=e.dY/i.transform.scale,i.update(),t.onChange(i.value))}})}return(0,D._)(e,[{key:"update",value:function(){var e=ej(e0(this.transform),this.value);(0,W.BB).css(this.rootEl,{left:e.x-8+"px",top:e.y-8+"px"})}},{key:"setTransform",value:function(e){JSON.stringify(this.transform)!==JSON.stringify(e)&&(this.transform=e,this.update())}},{key:"getValue",value:function(){return this.value}},{key:"setValue",value:function(e){this.value=(0,X._)({},e),this.update()}},{key:"getElement",value:function(){return this.rootEl}},{key:"destroy",value:function(){this.rootEl.remove(),this.pointerListener.destroy()}}]),e}(),W=I("eWjiX"),rq={};rq=I("f6OTe").getBundleURL("lYbF2")+"constrain.62f04e45.svg";var eI=I("1C8RU"),W=I("eWjiX"),eI=I("1C8RU"),W=(I("eWjiX"),I("eWjiX")),_=I("7jh4K"),W=(I("eWjiX"),I("eWjiX"),I("eWjiX"),I("eWjiX")),er=I("dJPtW");function rQ(e,t,i,n,r,a){e.save();var s=e.canvas.width,o=e.canvas.height,l=(n=Math.round(n))%2==0;e.beginPath(),e.lineWidth=n,e.strokeStyle=r,e.globalAlpha=a;for(var h=0;h<t-1;h++){var c=s/t*(h+1);c=l?Math.round(c):Math.round(c+.5)-.5,e.moveTo(c,0),e.lineTo(c,o)}for(var u=0;u<i-1;u++){var p=o/i*(u+1);p=l?Math.round(p):Math.round(p+.5)-.5,e.moveTo(0,p),e.lineTo(s,p)}e.stroke(),e.restore()}var _=I("7jh4K"),W=I("eWjiX"),eP=I("dJ1E2"),_=I("7jh4K"),rZ=[{type:0,scaleX:1,scaleY:1,offsetX:0,offsetY:0,octaves:1,samples:1,peaks:0,brightness:0,contrast:0,isReversed:!0},{type:1,scaleX:166,scaleY:164,offsetX:105,offsetY:30,octaves:6,samples:1,peaks:0,brightness:.055,contrast:.23,isReversed:!0},{type:1,scaleX:235,scaleY:190,offsetX:3227,offsetY:2156,octaves:4,samples:16,peaks:22,brightness:-.375,contrast:1,isReversed:!1},{type:1,scaleX:40,scaleY:40,offsetX:0,offsetY:0,octaves:1,samples:1,peaks:0,brightness:0,contrast:0,isReversed:!1},{type:0,scaleX:26,scaleY:26,offsetX:557,offsetY:365,octaves:1,samples:1,peaks:0,brightness:.02,contrast:1,isReversed:!0},{type:1,scaleX:1500,scaleY:1500,offsetX:745,offsetY:2871,octaves:5,samples:16,peaks:156.02,brightness:.03,contrast:1,isReversed:!0},{type:1,scaleX:11,scaleY:11,offsetX:2940,offsetY:2045,octaves:1,samples:16,peaks:1,brightness:-.045,contrast:1,isReversed:!0},{type:2,scaleX:74,scaleY:74,offsetX:4816,offsetY:1304,octaves:3,samples:1,peaks:2.78,brightness:0,contrast:0,isReversed:!1}];function rJ(e,t){e.noise(t.seed,t.type,[t.scaleX,t.scaleY],[e.width/2,e.height/2],t.octaves,t.samples,t.peaks,t.brightness,t.contrast,t.isReversed,t.colA,t.colB,t.channels?t.channels:"rgb").update()}var W=I("eWjiX"),er=I("dJPtW"),_=I("7jh4K");function r$(e,t){var i=t.blend?Math.round(t.blend*t.width/2):0,n=t.blend?Math.round(t.blend*t.height/2):0,r=(0,W.BB).canvas(t.width,t.height);if(t.blend){var a=(0,W.BB).canvas(2*t.width,2*t.height),s=(0,W.BB).ctx(a),o="#0000",l="#000";s.drawImage(e.canvas,-t.x+i,-t.y+n),s.save();var h=s.createLinearGradient(0,t.height,0,2*t.height);h.addColorStop(0,l),h.addColorStop(t.blend,o),s.globalCompositeOperation="destination-in",s.fillStyle=h,s.fillRect(0,0,a.width,a.height),s.restore(),s.save(),(h=s.createLinearGradient(0,0,0,t.height)).addColorStop(0,o),h.addColorStop(t.blend,l),s.globalCompositeOperation="destination-in",s.fillStyle=h,s.fillRect(0,0,2*t.width,2*t.height),s.restore(),s.save(),s.globalCompositeOperation="lighter",s.drawImage(a,0,-t.height),s.restore(),s.save(),(h=s.createLinearGradient(t.width,0,2*t.width,0)).addColorStop(0,l),h.addColorStop(t.blend,o),s.globalCompositeOperation="destination-in",s.fillStyle=h,s.fillRect(0,0,a.width,a.height),s.restore(),s.save(),(h=s.createLinearGradient(0,0,t.width,0)).addColorStop(0,o),h.addColorStop(t.blend,l),s.globalCompositeOperation="destination-in",s.fillStyle=h,s.fillRect(0,0,2*t.width,2*t.height),s.restore(),s.save(),s.globalCompositeOperation="lighter",s.drawImage(a,-t.width,0),s.restore(),(0,W.BB).ctx(r).drawImage(a,0,0)}else(0,W.BB).ctx(r).drawImage(e.canvas,-t.x,-t.y);e.save(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.translate(t.offsetX-i,t.offsetY-n),e.fillStyle=(0,_.throwIfNull)(e.createPattern(r,"repeat")),e.fillRect(-t.offsetX+i,-t.offsetY+n,e.canvas.width,e.canvas.height),e.restore()}var W=I("eWjiX"),_=I("7jh4K"),W=I("eWjiX"),er=I("dJPtW"),W=I("eWjiX");function r0(e,t,i,n,r,a,s){e.save();for(var o=180/n,l=0;l<180;l+=o){var h=(0,W.BB).rotateAround({x:t,y:i},{x:t+9999,y:i},l);tf(e,{type:"line",x1:t,y1:i,x2:h.x,y2:h.y,isOutwards:!0,opacity:s,strokeRgb:a,lineWidth:r})}e.restore()}var _=I("7jh4K");function r1(e,t){t.getDialog&&(e.getDialog=t.getDialog),e.apply=t.apply}function r2(){return(r2=M(function(e){var t,i;return R(this,function(n){switch(n.label){case 0:return t=e.getLayersFast(),i={width:e.getWidth(),height:e.getHeight(),children:t.map(function(e){return{name:e.name,hidden:!e.isVisible,opacity:e.opacity,canvas:e.canvas,blendMode:rW.PSD.blendKlToPsd(e.mixModeStr),left:0,top:0}})},[4,rA()];case 1:return[2,new Blob([n.sent().writePsdBuffer(i)],{type:"application/octet-stream"})]}})})).apply(this,arguments)}var n5=I("6l0gQ"),O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),r5=function(){function e(t){(0,O._)(this,e),this.smoothing=(0,W.BB).clamp(t.smoothing,0,1)}return(0,D._)(e,[{key:"chainIn",value:function(e){var t=this;if(e=(0,W.BB).copyObj(e),this.timeout&&clearTimeout(this.timeout),this.interval&&clearInterval(this.interval),"down"===e.type&&(this.lastMixedInput={x:e.x,y:e.y,pressure:e.pressure}),"move"===e.type){var i=e.x,n=e.y,r=e.pressure;e.x=(0,W.BB).mix(e.x,this.lastMixedInput.x,this.smoothing),e.y=(0,W.BB).mix(e.y,this.lastMixedInput.y,this.smoothing),e.pressure=(0,W.BB).mix(e.pressure,this.lastMixedInput.pressure,this.smoothing),this.lastMixedInput={x:e.x,y:e.y,pressure:e.pressure},this.smoothing>0&&(this.timeout=setTimeout(function(){t.interval=setInterval(function(){(e=JSON.parse(JSON.stringify(e))).x=(0,W.BB).mix(i,t.lastMixedInput.x,t.smoothing),e.y=(0,W.BB).mix(n,t.lastMixedInput.y,t.smoothing),e.pressure=(0,W.BB).mix(r,t.lastMixedInput.pressure,t.smoothing),t.lastMixedInput={x:e.x,y:e.y,pressure:e.pressure},t.chainOut&&t.chainOut(e)},35)},80))}return e}},{key:"setChainOut",value:function(e){this.chainOut=e}},{key:"setSmoothing",value:function(e){this.smoothing=(0,W.BB).clamp(e,0,1)}}]),e}(),O=I("cx0mh"),D=I("7h4XF"),r3=function(){function e(){(0,O._)(this,e),this.isDrawing=!1}return(0,D._)(e,[{key:"chainIn",value:function(e){return("down"===e.type&&(this.isDrawing?this.chainOut&&this.chainOut({type:"up",scale:e.scale,shiftIsPressed:e.shiftIsPressed,isCoalesced:!1}):this.isDrawing=!0),this.isDrawing||"move"!==e.type&&"up"!==e.type)?("up"===e.type&&this.isDrawing&&(this.isDrawing=!1),e):null}},{key:"setChainOut",value:function(e){this.chainOut=e}},{key:"getIsDrawing",value:function(){return this.isDrawing}}]),e}();function r4(e){return 1==e?.5:2==e?.84:3==e?.965:4==e?.9825:5==e?.99125:e}var O=I("cx0mh"),D=I("7h4XF"),W=I("eWjiX"),_=I("7jh4K"),r6=function(){function e(t,i){(0,O._)(this,e),this.klRootEl=t.klRootEl,this.klMaxCanvasSize=t.klMaxCanvasSize,this.layerManager=t.layerManager,this.setCurrentLayer=t.setCurrentLayer,this.klCanvas=t.klCanvas,this.klCanvasWorkspace=t.klCanvasWorkspace,this.handUi=t.handUi,this.onColor=i.onColor}return(0,D._)(e,[{key:"importFinishedLoading",value:function(e,t,i){var n=this;if(!e||isNaN(e.width)||isNaN(e.height)||e.width<=0||e.height<=0){rW.popup({target:this.klRootEl,type:"error",message:J("import-broken-file"),buttons:["Ok"]});return}var r=function(e,t){var i=parseInt(""+e),r=parseInt(""+t);return i>n.klMaxCanvasSize&&(r=n.klMaxCanvasSize/i*r,i=n.klMaxCanvasSize),r>n.klMaxCanvasSize&&(i=n.klMaxCanvasSize/r*i,r=n.klMaxCanvasSize),{width:i=parseInt(""+i),height:r=parseInt(""+r)}},a=function(e){var i=r(e.width,e.height),a=(0,W.BB).canvas(e.width,e.height);(0,W.BB).ctx(a).drawImage(e,0,0),(0,W.BB).resizeCanvas(a,i.width,i.height),n.klCanvas.reset({width:i.width,height:i.height,image:a,layerName:t}),n.layerManager.update(0),n.setCurrentLayer(n.klCanvas.getLayer(0)),n.klCanvasWorkspace.resetOrFitView(),n.handUi.update(n.klCanvasWorkspace.getScale(),n.klCanvasWorkspace.getAngleDeg())},s=function(e,t){var i,a=function(e,t,i){t.width=t.width,(0,W.BB).ctx(t).drawImage(e,-i.x,-i.y),e.width=i.width,e.height=i.height,(0,W.BB).ctx(e).drawImage(t,0,0)};if(t&&(t.width!==e.width||t.height!==e.height)){var s=(0,W.BB).canvas(t.width,t.height);if(e.width=t.width,e.height=t.height,e.layers||a(e.canvas,s,t),e.layers)for(var o=0;o<e.layers.length;o++)a(e.layers[o].image,s,t)}var l=r(e.width,e.height);if(e.width=l.width,e.height=l.height,e.layers||(0,W.BB).resizeCanvas(e.canvas,e.width,e.height),e.layers)for(var h=0;h<e.layers.length;h++){var c=e.layers[h];(0,W.BB).resizeCanvas(c.image,e.width,e.height)}i=e.layers?n.klCanvas.reset({width:e.width,height:e.height,layers:e.layers}):n.klCanvas.reset({width:e.width,height:e.height,image:e.canvas}),n.layerManager.update(i),n.setCurrentLayer((0,_.throwIfNull)(n.klCanvas.getLayer(i))),n.klCanvasWorkspace.resetOrFitView(),n.handUi.update(n.klCanvasWorkspace.getScale(),n.klCanvasWorkspace.getAngleDeg())},o=function(e){rW.showImportAsLayerDialog({target:n.klRootEl,klCanvas:n.klCanvas,importImage:e,callback:function(i,r){if(i){V.pause(!0),n.klCanvas.addLayer();var a=n.klCanvas.getLayers().length-1;t&&n.klCanvas.renameLayer(a,t);var s=(0,_.throwIfNull)(n.klCanvas.getLayerContext(a));(0,W.BB).drawTransformedImageWithBounds(s,e,i,void 0,r),n.setCurrentLayer((0,_.throwIfNull)(n.klCanvas.getLayer(a))),n.layerManager.update(a),V.pause(!1),V.push({tool:["misc"],action:"importImage",params:[(0,W.BB).copyCanvas(s.canvas),t]})}}})};"default"!==i&&i||rW.showImportImageDialog({image:e,target:this.klRootEl,maxSize:this.klMaxCanvasSize,callback:function(e){"as-image"===e.type?a(e.image):"as-image-psd"===e.type?s(e.image,e.cropObj):"as-layer"===e.type?o(e.image):e.type}}),"layer"===i&&o(e.canvas),"image"===i&&("psd"===e.type?s(e):a(e.canvas))}},{key:"onPaste",value:function(e){var t=this;!(rW.dialogCounter.get()>0)&&(e.stopPropagation(),e.preventDefault(),e.clipboardData&&(e.clipboardData.files[0]?function(e,t){if(e){for(var i=0;i<e.length;i++)if(-1!=e[i].type.indexOf("image")){var n=e[i].getAsFile();n&&t(n)}}}(e.clipboardData.items,function(e){var i=new Image;i.onload=function(){URL.revokeObjectURL(i.src),t.importFinishedLoading({type:"image",width:i.width,height:i.height,canvas:i},void 0,"default")};var n=window.URL||window.webkitURL;i.src=n.createObjectURL(e)}):e.clipboardData.items[0]&&e.clipboardData.items[0].getAsString(function(e){if((e=e.trim()).match(/^https?/)){var i=new Image;i.onload=function(){t.importFinishedLoading({type:"image",width:i.width,height:i.height,canvas:i},void 0,"default")},i.onerror=function(e){console.log("error loading",e)},i.crossOrigin="Anonymous",i.src=e}else if(e.match(/^#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/)){var n=(0,W.BB).ColorConverter.hexToRGB(e.replace("#",""));n&&t.onColor(n)}})))}},{key:"handleFileSelect",value:function(e,t){for(var i,n=this,r=function(){rW.popup({target:n.klRootEl,type:"warning",message:J("import-psd-unsupported")+"<br /><br />",buttons:["Ok"]})},a=!1,s=0;i=e[s];s++){var o=i.name.split(".");"psd"===o[o.length-1].toLowerCase()?function(i){if(i.size>=1073741824){rW.popup({target:n.klRootEl,type:"error",message:"File too big. Unable to import.<br /><br />",buttons:["Ok"]});return}var a,s=1===e.length&&i.size>=26214400,o=!0;s&&rW.popup({target:n.klRootEl,message:J("import-opening"),callback:function(e){o=!1,a=null},closeFunc:function(e){a=e}});var l=new FileReader;l.onload=function(e){var l=(0,_.throwIfNull)(e.target);rW.loadAgPsd().then(function(e){if(!s||o)try{var h;if((h=e.readPsd(l.result,{skipLayerImageData:!0,skipThumbnail:!0,skipCompositeImageData:!0})).width>4096||h.height>4096){a&&a(),rW.popup({target:n.klRootEl,type:"error",message:J("import-psd-too-large").replace(/{x}/g,"4096")+"<br /><br />"+J("import-psd-size")+": "+h.width+" x "+h.height+" pixels<br /><br />",buttons:["Ok"]});return}h=null;try{h=e.readPsd(l.result)}catch(e){}if(h){var c=rW.PSD.readPsd(h);"image"===t&&c.error&&r(),a&&a(),n.importFinishedLoading(c,i.name,t)}else h=e.readPsd(l.result,{skipLayerImageData:!0,skipThumbnail:!0}),"image"===t&&r(),a&&a(),n.importFinishedLoading({type:"psd",width:h.width,height:h.height,canvas:(0,_.throwIfUndefined)(h.canvas),error:!0},i.name,t)}catch(e){a&&a(),rW.popup({target:n.klRootEl,type:"error",message:"Failed to load PSD.<br /><br />",buttons:["Ok"]}),console.log(e),setTimeout(function(){throw Error("psd load error")})}}).catch(function(e){a&&a(),alert("Error: failed to load PSD library")})},l.readAsArrayBuffer(i)}(i):i.type.match("image.*")?function(e){window.URL=window.URL||window.webkitURL;var i=window.URL.createObjectURL(e),r=new Image;r.src=i,(0,W.BB).loadImage(r,function(){n.importFinishedLoading({type:"image",width:r.width,height:r.height,canvas:r},e.name,t)})}(i):a=!0}a&&rW.popup({target:this.klRootEl,message:J("import-unsupported-file"),type:"error",buttons:["OK"]})}}]),e}(),r7={};r7=I("f6OTe").getBundleURL("lYbF2")+"tab-settings.be84ac7c.svg";var r8={};r8=I("f6OTe").getBundleURL("lYbF2")+"tab-layers.c8a104e7.svg";var z=I("bX4ja"),_=I("7jh4K");nb.isLoaded||(r1(nB.brightnessContrast,{getDialog:function(e){var t=(0,W.BB).el(),i={element:t},n=tZ();n||(i.width=t0(n));var r=e.context,a=e.klCanvas;if(!r||!a)return!1;var s=a.getLayers(),o=a.getLayerIndex(r.canvas),l=0,h=0,c=new rN({original:r.canvas,onUpdate:function(e){return e.brightnessContrast(l,h)}});return setTimeout(function(){var e=new ed({label:J("filter-bright-contrast-brightness"),width:300,height:30,min:0,max:100,value:(l+1)*50,eventResMs:60,onChange:function(e){l=e/50-1,d.render()}}),a=new ed({label:J("filter-bright-contrast-contrast"),width:300,height:30,min:0,max:100,value:(h+1)*50,eventResMs:60,onChange:function(e){h=e/50-1,d.render()}});e.getElement().style.marginBottom="10px",a.getElement().style.marginBottom="10px",t.append(e.getElement(),a.getElement());for(var u=[],p=0;p<s.length;p++)u.push({image:p===o?c.render:s[p].context.canvas,isVisible:s[p].isVisible,opacity:s[p].opacity,mixModeStr:s[p].mixModeStr,hasClipping:!1});var d=new ta({width:t0(n),height:t1(n),project:{width:r.canvas.width,height:r.canvas.height,layers:u}});d.render(),d.getElement().classList.add((0,tG.css)({marginLeft:"-20px",marginRight:"-20px"})),t.append(d.getElement()),i.destroy=function(){e.destroy(),a.destroy(),c.destroy(),d.destroy()},i.getInput=function(){return i.destroy(),{brightness:l,contrast:h}}},1),i},apply:function(e){var t=e.context,i=e.input.brightness,n=e.input.contrast,r=e.history;if(!t||!r)return!1;r.pause(!0);var a=rC();if(!a)return!1;var s=a.texture(t.canvas);return a.draw(s).brightnessContrast(i,n).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),s.destroy(),r.pause(!1),r.push({tool:["filter","brightnessContrast"],action:"apply",params:[{input:e.input}]}),!0}}),r1(nB.cropExtend,{getDialog:function(e){var t=e.klCanvas;if(!t)return!1;var i=(0,W.BB).canvas(),n=(0,W.BB).fitInto(t.getWidth(),t.getHeight(),560,400,1),r=parseInt(""+n.width),a=parseInt(""+n.height),s=r/t.getWidth();i.width=r,i.height=a,i.style.display="block",(0,W.BB).ctx(i).drawImage(t.getCompleteCanvas(s),0,0,r,a);var o=(0,W.BB).el(),l={element:o},h=0,c=0,u=0,p=0,d=!1,g=!1,f=!1,v=!1,m=e.maxWidth,y=e.maxHeight,x=1,b=(0,W.BB).el({css:{lineHeight:"30px",height:"35px"}}),B=(0,W.BB).el({css:{lineHeight:"30px",height:"35px"}});o.append(b,B);var w=(0,er.input)({init:0,type:"number",min:-t.getWidth(),max:m,css:{width:"75px",marginRight:"20px"},callback:function(){d=!0,I()}}),k=(0,er.input)({init:0,type:"number",min:-t.getWidth(),max:m,css:{width:"75px"},callback:function(){g=!0,I()}}),C=(0,er.input)({init:0,type:"number",min:-t.getHeight(),max:y,css:{width:"75px",marginRight:"20px"},callback:function(){f=!0,I()}}),S=(0,er.input)({init:0,type:"number",min:-t.getHeight(),max:y,css:{width:"75px"},callback:function(){v=!0,I()}}),E={display:"inline-block",width:"60px"};function I(){h=parseInt(w.value),c=parseInt(k.value),u=parseInt(C.value),p=parseInt(S.value);var e=t.getWidth()+h+c,i=t.getHeight()+u+p;e<=0&&(d&&(h=-t.getWidth()-c+1,w.value=""+h),g&&(c=-t.getWidth()-h+1,k.value=""+c),e=1),e>m&&(d&&(h=-t.getWidth()-c+m,w.value=""+h),g&&(c=-t.getWidth()-h+m,k.value=""+c),e=m),i<=0&&(f&&(u=-t.getHeight()-p+1,C.value=""+u),v&&(p=-t.getHeight()-u+1,S.value=""+p),i=1),i>y&&(f&&(u=-t.getHeight()-p+y,C.value=""+u),v&&(p=-t.getHeight()-u+y,S.value=""+p),i=y),F.setTransform({x:-h,y:-u,width:e,height:i}),d=!1,g=!1,f=!1,v=!1}b.append((0,W.BB).el({content:J("filter-crop-left")+":",css:E}),w,(0,W.BB).el({content:J("filter-crop-right")+":",css:E}),k),B.append((0,W.BB).el({content:J("filter-crop-top")+":",css:E}),C,(0,W.BB).el({content:J("filter-crop-bottom")+":",css:E}),S);var A=!0,T=new en({init:!0,label:J("filter-crop-rule-thirds"),allowTab:!0,callback:function(e){A=e,F.showThirds(A)}});o.append((0,W.BB).el({css:{clear:"both"}}));var M={r:0,g:0,b:0,a:0},L=[{r:0,g:0,b:0,a:0},{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1}];L.push({r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1}),L.push({r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1});var R=new eO({label:J("filter-crop-fill"),colorArr:L,onChange:function(e){0===(M=e).a?(_.style.background="",i.style.background=""):(_.style.background=(0,W.BB).ColorConverter.toRgbStr(M),(0,W.BB).createCheckerDataUrl(parseInt(""+50*x),function(e){i.style.background="url("+e+")"},(0,eI.theme).isDark()))}}),P=(0,W.BB).el({css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"10px"}});function O(e){var n=(0,W.BB).fitInto(e.width,e.height,260,180,1);x=n.width/e.width;var r=(0,W.BB).centerWithin(tJ.width,D,n.width,n.height);i.style.width=t.getWidth()*x+"px",i.style.height=t.getHeight()*x+"px",j.style.left=r.x-e.x*x+"px",j.style.top=r.y-e.y*x+"px",h=parseInt(""+-e.x),u=parseInt(""+-e.y),c=parseInt(""+(e.x+e.width-t.getWidth())),p=parseInt(""+(e.y+e.height-t.getHeight())),w.value=""+h,C.value=""+u,k.value=""+c,S.value=""+p,(0,W.BB).createCheckerDataUrl(parseInt(""+50*x),function(e){z.style.background="url("+e+")",0!==M.a&&(i.style.background="url("+e+")")},(0,eI.theme).isDark()),z.style.backgroundPosition=r.x+"px "+r.y+"px",F.setScale(x)}o.append(P),P.append(T.getElement(),R.getElement());var D=tJ.height-2,z=(0,W.BB).el({className:"kl-edit-crop-preview",css:{width:tJ.width+"px",marginTop:"10px",marginLeft:"-20px",height:D+"px",backgroundColor:"#9e9e9e",position:"relative",borderTop:"1px solid rgb(144,144,144)",borderBottom:"1px solid rgb(144,144,144)",overflow:"hidden",userSelect:"none",touchAction:"none"}});z.oncontextmenu=function(){return!1};var _=(0,W.BB).el({css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0"}});z.append(_);var j=(0,W.BB).el({parent:z,css:{position:"absolute",left:"0",top:"0"}});(0,W.BB).el({parent:j,content:i,css:{boxShadow:"0 0 0px 1px rgb(130,130,130)",position:"absolute",left:"0px",top:"0px"}}),o.append(z);var F=new tq({x:0,y:0,width:t.getWidth(),height:t.getHeight(),scale:x,callback:O,maxW:m,maxH:y});function V(){I()}return O(F.getTransform()),j.append(F.getElement()),(0,eI.theme).addIsDarkListener(V),l.destroy=function(){F.destroy(),T.destroy(),(0,eI.theme).removeIsDarkListener(V),R.destroy()},l.getInput=function(){return l.destroy(),{left:h,right:c,top:u,bottom:p,fillColor:0===M.a?void 0:M}},l},apply:function(e){var t=e.klCanvas,i=e.history;return!(!t||!i||isNaN(e.input.left)||isNaN(e.input.right)||isNaN(e.input.top)||isNaN(e.input.bottom))&&(i.pause(!0),t.resizeCanvas(e.input),i.pause(!1),i.push({tool:["filter","cropExtend"],action:"apply",params:[{input:(0,W.BB).copyObj(e.input)}]}),!0)}}),r1(nB.curves,{getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),r=i.getLayerIndex(t.canvas),a=(0,W.BB).el(),s={element:a},o=tZ();o||(s.width=t0(o));var l=rY(),h=new rN({original:t.canvas,onUpdate:function(e){return e.curves(l.r,l.g,l.b)}});return setTimeout(function(){for(var e=[],i=0;i<n.length;i++)e.push({image:i===r?h.render:n[i].context.canvas,isVisible:n[i].isVisible,opacity:n[i].opacity,mixModeStr:n[i].mixModeStr,hasClipping:!1});var c=new ta({width:t0(o),height:t1(o),project:{width:t.canvas.width,height:t.canvas.height,layers:e}});c.getElement().classList.add((0,tG.css)({marginLeft:"-20px",marginRight:"-20px"}));var u=new rU({curves:l,callback:function(e){l=e,c.render()}}),p=u.getModeButtons();a.append(u.getElement(),c.getElement()),s.destroy=function(){u.destroy(),p.destroy(),h.destroy(),c.destroy()},s.getInput=function(){return s.destroy(),{curves:l}}},1),s},apply:function(e){var t=e.context,i=e.input.curves,n=e.history;if(!t||!n)return!1;n.pause(!0);var r=rC();if(!r)return!1;var a=r.texture(t.canvas);return r.draw(a).curves(i.r,i.g,i.b).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(r,0,0),a.destroy(),n.pause(!1),n.push({tool:["filter","curves"],action:"apply",params:[{input:e.input}]}),!0}}),r1(nB.flip,{getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),r=i.getLayerIndex(t.canvas),a=(0,W.BB).fitInto(t.canvas.width,t.canvas.height,280,200,1),s=parseInt(""+a.width),o=parseInt(""+a.height),l=(0,W.BB).el(),h={element:l},c=!0,u=!1,p=!0,d=new en({init:!0,label:J("filter-flip-horizontal")+" ",allowTab:!0,callback:function(e){c=e,b()},css:{marginBottom:"10px"}}),g=new en({init:u,label:J("filter-flip-vertical")+" ",allowTab:!0,callback:function(e){u=e,b()},css:{marginBottom:"10px"}});l.append(d.getElement()),l.append(g.getElement());var f=new eD({optionArr:[{id:!0,label:J("filter-flip-image")},{id:!1,label:J("filter-flip-layer")}],onChange:function(e){p=e,b()}});l.append(f.getElement());var v=(0,W.BB).el({className:"kl-preview-wrapper",css:{width:tJ.width+"px",height:tJ.height+"px"}}),m={image:(0,W.BB).canvas(Math.round(s),Math.round(o)),isVisible:!0,opacity:1,mixModeStr:"source-over"},y=new tH({width:Math.round(s),height:Math.round(o),layers:[m]}),x=(0,W.BB).el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+s)+"px",height:parseInt(""+o)+"px"}});function b(){var e=(0,W.BB).ctx(m.image);e.save(),e.clearRect(0,0,m.image.width,m.image.height),p&&(c&&(e.translate(m.image.width,0),e.scale(-1,1)),u&&(e.translate(0,m.image.height),e.scale(1,-1)));for(var t=0;t<n.length;t++)n[t].isVisible&&(e.save(),!p&&r===t&&(c&&(e.translate(m.image.width,0),e.scale(-1,1)),u&&(e.translate(0,m.image.height),e.scale(1,-1))),e.canvas.width>n[t].context.canvas.width&&(e.imageSmoothingEnabled=!1),e.globalAlpha=n[t].opacity,e.globalCompositeOperation=n[t].mixModeStr,e.drawImage(n[t].context.canvas,0,0,m.image.width,m.image.height),e.restore());y.render(),e.restore()}return x.append(y.getElement()),v.append(x),setTimeout(b,0),l.append(v),h.destroy=function(){d.destroy(),g.destroy(),f.destroy(),y.destroy()},h.getInput=function(){return h.destroy(),{horizontal:c,vertical:u,flipCanvas:p}},h},apply:function(e){var t=e.context,i=e.klCanvas,n=e.history,r=e.input.horizontal,a=e.input.vertical,s=e.input.flipCanvas;return!!t&&!!i&&!!n&&(n.pause(!0),i.flip(r,a,s?void 0:(0,_.throwIfNull)(i.getLayerIndex(t.canvas))),n.pause(!1),n.push({tool:["filter","flip"],action:"apply",params:[{input:e.input}]}),!0)}}),r1(nB.hueSaturation,{getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),r=i.getLayerIndex(t.canvas),a=(0,W.BB).el(),s={element:a},o=tZ();o||(s.width=t0(o));var l=0,h=0,c=new rN({original:t.canvas,onUpdate:function(e){return e.hueSaturation(l,h)}});return setTimeout(function(){var e=new ed({label:J("filter-hue-sat-hue"),width:300,height:30,min:-100,max:100,value:100*l,eventResMs:60,onChange:function(e){l=e/100,d.render()}}),i=new ed({label:J("filter-hue-sat-saturation"),width:300,height:30,min:0,max:100,value:(h+1)*50,eventResMs:60,onChange:function(e){h=e/50-1,d.render()}});e.getElement().style.marginBottom="10px",i.getElement().style.marginBottom="10px",a.append(e.getElement(),i.getElement());for(var u=[],p=0;p<n.length;p++)u.push({image:p===r?c.render:n[p].context.canvas,isVisible:n[p].isVisible,opacity:n[p].opacity,mixModeStr:n[p].mixModeStr,hasClipping:!1});var d=new ta({width:t0(o),height:t1(o),project:{width:t.canvas.width,height:t.canvas.height,layers:u}});d.render(),d.getElement().classList.add((0,tG.css)({marginLeft:"-20px",marginRight:"-20px"})),a.append(d.getElement()),s.destroy=function(){e.destroy(),i.destroy(),c.destroy(),d.destroy()},s.getInput=function(){return s.destroy(),{hue:l,saturation:h}}},1),s},apply:function(e){var t=e.context,i=e.input.hue,n=e.history,r=e.input.saturation;if(!t||null===i||null===r||!n)return!1;n.pause(!0);var a=rC();if(!a)return!1;var s=a.texture(t.canvas);return a.draw(s).hueSaturation(i,r).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),s.destroy(),n.pause(!1),n.push({tool:["filter","hueSaturation"],action:"apply",params:[{input:e.input}]}),!0}}),r1(nB.invert,{apply:function(e){var t=e.context,i=e.history;if(!t||!i)return!1;var n=rC();if(!n)return!1;i.pause(!0);var r=n.texture(t.canvas);return n.draw(r).invert().update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(n,0,0),r.destroy(),i.pause(!1),i.push({tool:["filter","invert"],action:"apply",params:[{input:e.input}]}),!0}}),r1(nB.perspective,{getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=tZ(),r=i.getLayers(),a=i.getLayerIndex(t.canvas),s=(0,W.BB).el(),o={element:s};return n||(o.width=t$.width),setTimeout(function(){var e,i=(0,_.throwIfNull)(rC()),l=(0,_.throwIfUndefined)(null==i?void 0:i.texture(t.canvas));function h(){g?i.draw(l).update():i.draw(l).perspective(d(u),d(p)).update(),y.render()}var c=[{x:0,y:0},{x:t.canvas.width,y:0},{x:t.canvas.width,y:t.canvas.height},{x:0,y:t.canvas.height}],u=c.map(function(e){return new rK({value:e,onChange:function(){h()}})});u.forEach(function(e){return e.getElement().style.display="none"});var p=c.map(function(e){return new rK({value:e,onChange:function(){h()}})});function d(e,t){return e.flatMap(function(e){var i=e.getValue();return t&&(i=ej(t,i)),[i.x,i.y]})}var g=!1,f=new rG({left:J("compare-before"),right:J("compare-after"),init:1,onChange:function(e){(g=0===e)?(u.forEach(function(e){return e.getElement().style.display="block"}),p.forEach(function(e){return e.getElement().style.display="none"})):(u.forEach(function(e,t){p[t].setValue(e.getValue())}),u.forEach(function(e){return e.getElement().style.display="none"}),p.forEach(function(e){return e.getElement().style.display="block"})),h()}});s.append(f.getElement());for(var v=[],m=0;m<r.length;m++)v.push({image:m===a?i:r[m].context.canvas,isVisible:r[m].isVisible,opacity:r[m].opacity,mixModeStr:r[m].mixModeStr,hasClipping:!1});var y=new ta({width:t0(n),height:t1(n),project:{width:t.canvas.width,height:t.canvas.height,layers:v},onTransformChange:function(e){u.forEach(function(t){return t.setTransform(e)}),p.forEach(function(t){return t.setTransform(e)})}});(0,W.BB).css(y.getElement(),{overflow:"hidden",marginLeft:"-20px",marginRight:"-20px"}),(e=y.getElement()).append.apply(e,(0,z._)(u.map(function(e){return e.getElement()})).concat((0,z._)(p.map(function(e){return e.getElement()})))),s.append(y.getElement()),h(),o.destroy=function(){y.destroy(),l.destroy,u.forEach(function(e){return e.destroy()}),p.forEach(function(e){return e.destroy()})},o.getInput=function(){return o.destroy(),{before:d(u),after:d(p)}}},1),o},apply:function(e){var t=e.context,i=e.history,n=e.input.before,r=e.input.after;if(!t||!n||!r||!i)return!1;i.pause(!0);var a=rC();if(!a)return!1;var s=a.texture(t.canvas);return a.draw(s).multiplyAlpha().perspective(n,r).unmultiplyAlpha().update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),s.destroy(),i.pause(!1),i.push({tool:["filter","perspective"],action:"apply",params:[{input:e.input}]}),!0}}),r1(nB.resize,{getDialog:function(e){var i=e.klCanvas;if(!i)return!1;var n=(0,W.BB).fitInto(i.getWidth(),i.getHeight(),280,200,1),r=parseInt(""+n.width),a=parseInt(""+n.height),s=r/i.getWidth(),o=i.getCompleteCanvas(1),l=(0,W.BB).el(),h={element:l},c=i.getWidth(),u=i.getHeight(),p=e.maxWidth,d=e.maxHeight,g=(0,W.BB).el({css:{width:"150px",height:"35px",lineHeight:"30px"}}),f=(0,W.BB).el({css:{width:"150px",height:"35px",lineHeight:"30px"}}),v=(0,W.BB).el({tagName:"input",css:{cssFloat:"right",width:"90px"},custom:{type:"number",min:"1",max:""+p,value:""+i.getWidth()}}),m=(0,W.BB).el({tagName:"input",css:{cssFloat:"right",width:"90px"},custom:{type:"number",min:"1",max:""+d,value:""+i.getHeight()}});v.onclick=function(){this.focus(),B=!0,A()},m.onclick=function(){this.focus(),b=!0,A()},v.onchange=function(){B=!0,A()},m.onchange=function(){b=!0,A()},g.append(J("width")+": ",v),f.append(J("height")+": ",m),(0,W.BB).el({css:{background:"url("+t(rq)+") no-repeat 140px 5px",backgroundSize:"50px 52px"}}).append(g,f);var y=new Image;y.src=t(rq),y.height=40;var x=iy([[J("width")+":&nbsp;",v,y],[(0,W.BB).el({css:{height:"5px"}}),"",""],[J("height")+":&nbsp;",m]],{"0.2":{rowspan:3}});(0,W.BB).css(x,{marginBottom:"10px"}),l.append(x);var b=!1,B=!1,w=i.getWidth()/i.getHeight(),k=!0,C=new en({init:!0,label:J("constrain-proportions"),allowTab:!0,callback:function(e){k=e,y.style.display=k?"":"none",k&&(v.value=""+i.getWidth(),m.value=""+i.getHeight(),A())}});l.append((0,W.BB).el({css:{clear:"both"}}));var S=new ea({isFocusable:!0,optionArr:[["smooth",J("algorithm-smooth")],["pixelated",J("algorithm-pixelated")]],title:J("scaling-algorithm"),initValue:"smooth",onChange:function(){A()}});(0,W.BB).el({parent:l,css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}).append(C.getElement(),S.getElement());var E=(0,W.BB).canvas(r,a);E.style.imageRendering="pixelated";var I=(0,W.BB).ctx(E);function A(){if(0===v.value.length&&B||0===m.value.length&&b){b=!1,B=!1;return}if(v.value=""+Math.max(1,parseInt(v.value)),m.value=""+Math.max(1,parseInt(m.value)),k&&(b&&(v.value=""+parseInt(""+parseInt(m.value)*w)),B&&(m.value=""+parseInt(""+parseInt(v.value)/w)),parseInt(v.value)>p||parseInt(m.value)>d)){var e=(0,W.BB).fitInto(parseInt(v.value),parseInt(m.value),p,d,1);v.value=""+parseInt(""+e.width),m.value=""+parseInt(""+e.height)}parseInt(v.value)>p&&(v.value=""+p),parseInt(m.value)>d&&(m.value=""+d),b=!1,B=!1,c=parseInt(v.value),u=parseInt(m.value);var t=(0,W.BB).fitInto(c,u,280,200,1),n=parseInt(""+t.width),r=parseInt(""+t.height);s=n/c;var a=(0,W.BB).centerWithin(tJ.width,tJ.height,n,r);"smooth"===S.getValue()?(E.style.imageRendering=s>1?"pixelated":"",E.width=i.getWidth(),E.height=i.getHeight(),I.save(),I.imageSmoothingQuality="high",I.drawImage(o,0,0),(0,W.BB).resizeCanvas(E,c,u)):(E.style.imageRendering="pixelated",E.width=c,E.height=u,I.save(),I.imageSmoothingEnabled=!1,I.drawImage(o,0,0,E.width,E.height)),I.restore(),E.style.width=Math.max(1,n)+"px",E.style.height=Math.max(1,r)+"px",M.style.left=a.x+"px",M.style.top=a.y+"px",M.style.width=Math.max(1,n)+"px",M.style.height=Math.max(1,r)+"px"}var T=(0,W.BB).el({className:"kl-transparent-preview",css:{width:tJ.width+"px",height:tJ.height+"px",marginLeft:"-20px",display:"table",marginTop:"10px",position:"relative",userSelect:"none"}}),M=(0,W.BB).el({parent:T,content:E,className:"kl-transparent-preview__canvas",css:{width:r+"px",height:a+"px",position:"absolute",overflow:"hidden"}});function L(){(0,W.BB).createCheckerDataUrl(8,function(e){T.style.background="url("+e+")"},(0,eI.theme).isDark())}return(0,eI.theme).addIsDarkListener(L),L(),l.append(T),A(),h.destroy=function(){C.destroy(),(0,eI.theme).removeIsDarkListener(L)},h.getInput=function(){return h.destroy(),{width:c,height:u,algorithm:S.getValue()}},h},apply:function(e){var t=e.klCanvas,i=e.history,n=e.input.width,r=e.input.height,a=e.input.algorithm;return!!t&&!!i&&(i.pause(!0),t.resize(n,r,a),i.pause(!1),i.push({tool:["filter","resize"],action:"apply",params:[{input:e.input}]}),!0)}}),r1(nB.rotate,{getDialog:function(e){var t=e.klCanvas;if(!t)return!1;var i=(0,W.BB).fitInto(t.getWidth(),t.getHeight(),280,200,1),n=parseInt(""+i.width),r=parseInt(""+i.height),a=n/t.getWidth(),s=(0,W.BB).canvas(n,r);s.style.display="block",(0,W.BB).ctx(s).drawImage(t.getCompleteCanvas(a),0,0,n,r);var o=(0,W.BB).el(),l={element:o},h=0;function c(){if(f.style.transform="rotate("+h+"deg)",90===Math.abs(h%180)){var e=parseInt(""+(0,W.BB).fitInto(r,n,280,200,1).height)/n;f.style.transform="rotate("+h+"deg) scale("+e+")"}}var u=document.createElement("button");u.innerHTML="<span style='font-size: 1.3em'></span> 90";var p=document.createElement("button");p.innerHTML="<span style='font-size: 1.3em'></span> 90",p.style.marginRight="5px",u.onclick=function(){h+=90,c()},p.onclick=function(){h-=90,c()},o.append(p,u);var d=(0,W.BB).el({className:"kl-preview-wrapper",css:{width:tJ.width+"px",height:tJ.height+"px",display:"table"}}),g=(0,W.BB).el({parent:d,css:{display:"table-cell",verticalAlign:"middle"}}),f=(0,W.BB).el({parent:g,content:s,className:"kl-preview-wrapper__canvas",css:{width:n+"px",height:r+"px",marginLeft:"auto",marginRight:"auto",overflow:"hidden"}});function v(){(0,W.BB).createCheckerDataUrl(8,function(e){f.style.background="url("+e+")"},(0,eI.theme).isDark())}return(0,eI.theme).addIsDarkListener(v),v(),f.style.transition="all 0.2s ease-out",o.append(d),c(),l.destroy=function(){(0,eI.theme).removeIsDarkListener(v)},l.getInput=function(){return l.destroy(),{deg:h}},l},apply:function(e){var t=e.klCanvas,i=e.history;return!!t&&!!i&&(i.pause(!0),t.rotate(e.input.deg),i.pause(!1),i.push({tool:["filter","rotate"],action:"apply",params:[{input:e.input}]}),!0)}}),r1(nB.tiltShift,{getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),r=i.getLayerIndex(t.canvas),a=(0,W.BB).el(),s={element:a},o=tZ();o||(s.width=t0(o));var l=20,h=200,c={destroy:function(){}};return setTimeout(function(){function e(){v.render()}c=new rN({original:t.canvas,onUpdate:function(e,t){i.setTransform(v.getTransform()),u.setTransform(v.getTransform());var n=e0(t),r=ej(n,i.getValue()),a=ej(n,u.getValue());return e.multiplyAlpha().tiltShift(r.x,r.y,a.x,a.y,l*t.scaleX,h*t.scaleX).unmultiplyAlpha()}});var i=new rK({value:{x:t.canvas.width/4,y:t.canvas.height/2},onChange:function(){e()}}),u=new rK({value:{x:3*t.canvas.width/4,y:t.canvas.height/2},onChange:function(){e()}}),p=new ed({label:J("filter-tilt-shift-gradient"),width:300,height:30,min:0,max:1e3,value:h,eventResMs:60,onChange:function(t){h=t,e()}});p.getElement().style.marginBottom="10px",a.append(p.getElement());var d=new ed({label:J("filter-tilt-shift-blur"),width:300,height:30,min:0,max:200,value:l,eventResMs:60,onChange:function(t){l=t,e()}});d.getElement().style.marginBottom="10px",a.append(d.getElement());for(var g=[],f=0;f<n.length;f++)g.push({image:f===r?c.render:n[f].context.canvas,isVisible:n[f].isVisible,opacity:n[f].opacity,mixModeStr:n[f].mixModeStr,hasClipping:!1});var v=new ta({width:t0(o),height:t1(o),project:{width:t.canvas.width,height:t.canvas.height,layers:g}});v.render(),(0,W.BB).css(v.getElement(),{overflow:"hidden",marginLeft:"-20px",marginRight:"-20px"}),v.getElement().append(i.getElement(),u.getElement()),a.append(v.getElement()),s.destroy=function(){d.destroy(),p.destroy(),i.destroy(),u.destroy(),c.destroy(),v.destroy()},s.getInput=function(){return s.destroy(),{a:i.getValue(),b:u.getValue(),blur:l,gradient:h}}},1),s},apply:function(e){var t=e.context,i=e.history,n=e.input.a,r=e.input.b,a=e.input.blur,s=e.input.gradient;if(!t||!i)return!1;i.pause(!0);var o=rC();if(!o)return!1;var l=o.texture(t.canvas);return o.draw(l).multiplyAlpha().tiltShift(n.x,n.y,r.x,r.y,a,s).unmultiplyAlpha().update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(o,0,0),l.destroy(),i.pause(!1),i.push({tool:["filter","tiltShift"],action:"apply",params:[{input:e.input}]}),!0}}),r1(nB.transform,{getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=tZ(),r=i.getLayers(),a=(0,_.throwIfNull)(i.getLayerIndex(t.canvas)),s=(0,W.BB).canvasBounds(t);if(!s)return{error:J("filter-transform-empty")};var o={x:s.x+s.width/2,y:s.y+s.height/2,width:s.width,height:s.height,angleDeg:0},l=(0,W.BB).el(),h={element:l};n||(h.width=t$.width);var c=new W.BB.KeyListener({onDown:function(e){(0,W.BB).isInputFocused(!0)||("left"===e&&(f.value=""+(parseFloat(f.value)-1),H()),"right"===e&&(f.value=""+(parseFloat(f.value)+1),H()),"up"===e&&(g.value=""+(parseFloat(g.value)-1),H()),"down"===e&&(g.value=""+(parseFloat(g.value)+1),H()))}}),u=(0,W.BB).el(),p=(0,W.BB).el(),d=(0,W.BB).el(),g=(0,W.BB).el({tagName:"input"}),f=(0,W.BB).el({tagName:"input"}),v=(0,W.BB).el({tagName:"input"});u.style.width="100px",u.style.height="30px",p.style.width="100px",p.style.height="30px",p.style.display="inline-block",u.style.display="inline-block",d.style.display="inline-block",d.style.width="150px",d.style.height="30px",g.type="number",f.type="number",v.type="number",f.style.width="70px",g.style.width="70px",v.style.width="70px",g.value="0",f.value="0",v.value="0",g.onclick=function(){g.focus(),H()},f.onclick=function(){f.focus(),H()},v.onclick=function(){v.focus(),H()},g.onchange=function(){H()},f.onchange=function(){H()},v.onchange=function(){H()},g.onkeyup=function(){H()},f.onkeyup=function(){H()},v.onkeyup=function(){H()},u.append("X: ",f),p.append("Y: ",g),d.append(J("filter-transform-rotation")+": ",v),n||(0,W.BB).el({parent:l,css:{marginTop:"10px"}}).append(u,p,d);var m={marginLeft:"10px",marginTop:"10px"},y=(0,W.BB).el({parent:l,css:{display:"flex",flexWrap:"wrap",marginLeft:"-10px"}}),x=(0,W.BB).el({parent:y,tagName:"button",content:J("filter-transform-flip")+" X",onClick:function(){var e=V.getValue();V.setSize(-e.width,e.height)},css:m}),b=(0,W.BB).el({parent:y,tagName:"button",content:J("filter-transform-flip")+" Y",onClick:function(){var e=V.getValue();V.setSize(e.width,-e.height)},css:m}),B=(0,W.BB).el({parent:y,tagName:"button",content:"-90",onClick:function(){var e=V.getValue();e.angleDeg-=90,e.angleDeg%=360,V.setAngleDeg(e.angleDeg),v.value=""+Math.round(e.angleDeg),F()},css:m}),w=(0,W.BB).el({parent:y,tagName:"button",content:"+90",onClick:function(){var e=V.getValue();e.angleDeg+=90,e.angleDeg%=360,V.setAngleDeg(e.angleDeg),v.value=""+Math.round(e.angleDeg),F()},css:m}),k=(0,W.BB).el({parent:y,tagName:"button",content:"2x",onClick:function(){var e=V.getValue();I.getValue()?V.setSize(V.getRatio()*e.height*2,2*e.height):V.setSize(2*e.width,2*e.height)},css:m}),C=(0,W.BB).el({parent:y,tagName:"button",content:"1/2x",onClick:function(){var e=V.getValue();V.setSize(Math.round(e.width/2),Math.round(e.height/2))},css:m}),S=(0,W.BB).el({parent:y,tagName:"button",content:J("center"),onClick:function(){var e=V.getValue();V.setPos({x:t.canvas.width/2,y:t.canvas.height/2}),V.setAngleDeg(e.angleDeg),F()},css:m}),E=!0,I=new en({init:!0,label:J("filter-transform-constrain"),title:J("constrain-proportions"),allowTab:!0,callback:function(e){E=e,V.setIsConstrained(E)},css:{display:"inline-block"}}),A=!1,T=new en({init:!0,label:J("filter-transform-snap"),title:J("filter-transform-snap-title"),allowTab:!0,callback:function(e){A=e,V.setSnapping(A)},css:{display:"inline-block",marginLeft:"10px"}}),M=(0,W.BB).el();M.append(I.getElement(),T.getElement()),l.append((0,W.BB).el({css:{clear:"both",height:"10px"}}));var L=(0,W.BB).el({parent:l,css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),R=new ea({isFocusable:!0,optionArr:[["smooth",J("algorithm-smooth")],["pixelated",J("algorithm-pixelated")]],initValue:"smooth",title:J("scaling-algorithm"),onChange:function(){F(!0)}});L.append(M,R.getElement());for(var P=(0,W.BB).canvas(t.canvas.width,t.canvas.height),O=[],D=0;D<r.length;D++)O.push({image:D===a?P:r[D].context.canvas,isVisible:r[D].isVisible,opacity:r[D].opacity,mixModeStr:r[D].mixModeStr,hasClipping:!1});var z=new ta({width:t0(n),height:t1(n),project:{width:t.canvas.width,height:t.canvas.height,layers:O},hasEditMode:!0,onModeChange:function(e){V.getElement().style.pointerEvents="edit"===e?"":"none",V.getElement().style.opacity="edit"===e?"":"0.5"},onTransformChange:function(e){V.setViewportTransform(e)},padding:30});z.render(),z.getElement().classList.add((0,tG.css)({overflow:"hidden",marginLeft:"-20px",marginRight:"-20px"})),l.append(z.getElement());var j="";function F(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(V){var t=V.getValue();if(JSON.stringify(t)!==j||e){j=JSON.stringify(t);var i=(0,W.BB).ctx(P);i.save(),i.clearRect(0,0,P.width,P.height),(0,W.BB).drawTransformedImageWithBounds(i,r[a].context.canvas,t,s,"pixelated"===R.getValue()||(0,W.BB).testShouldPixelate(t,t.width/o.width,t.height/o.height)),i.restore(),z.render()}}}var V=new tU({x:o.x,y:o.y,width:o.width,height:o.height,angleDeg:o.angleDeg,isConstrained:!0,snapX:[0,t.canvas.width],snapY:[0,t.canvas.height],callback:function(e){f.value=""+Math.round(e.x-o.x),g.value=""+Math.round(e.y-o.y),v.value=""+Math.round(e.angleDeg),F()},viewportTransform:z.getTransform()});function H(){V.setPos({x:parseInt(f.value)+o.x,y:parseInt(g.value)+o.y}),V.setAngleDeg(parseInt(v.value)),F()}return(0,W.BB).css(V.getElement(),{position:"absolute",left:"0",top:"0"}),z.getElement().append(V.getElement()),F(),h.destroy=function(){c.destroy(),V.destroy(),I.destroy(),T.destroy(),(0,W.BB).destroyEl(x),(0,W.BB).destroyEl(b),(0,W.BB).destroyEl(B),(0,W.BB).destroyEl(w),(0,W.BB).destroyEl(k),(0,W.BB).destroyEl(C),(0,W.BB).destroyEl(S),z.destroy(),(0,W.BB).freeCanvas(P)},h.getInput=function(){var e=V.getValue(),t={transform:e,bounds:s,isPixelated:"pixelated"===R.getValue()||(0,W.BB).testShouldPixelate(e,e.width/o.width,e.height/o.height)};return h.destroy(),(0,W.BB).copyObj(t)},h},apply:function(e){var t=e.context,i=e.history;if(!t||!i)return!1;i.pause(!0);var n=e.input,r=(0,W.BB).copyCanvas(t.canvas);return t.clearRect(0,0,t.canvas.width,t.canvas.height),(0,W.BB).drawTransformedImageWithBounds(t,r,n.transform,n.bounds,n.isPixelated),i.pause(!1),i.push({tool:["filter","transform"],action:"apply",params:[{input:n}]}),!0}}),r1(nB.blur,{getDialog:function(e){var t=e.klCanvas,i=e.context;if(!t||!i)return!1;var n=t.getLayers(),r=t.getLayerIndex(i.canvas),a=(0,W.BB).el(),s={element:a},o=tZ();o||(s.width=t0(o));var l=10,h=new rN({original:i.canvas,onUpdate:function(e,t){return e.multiplyAlpha().triangleBlur(l*t.scaleX).unmultiplyAlpha()}});return setTimeout(function(){var e=new ed({label:J("radius"),width:300,height:30,min:1,max:200,value:l,eventResMs:60,onChange:function(e){l=e,u.render()}});e.getElement().style.marginBottom="10px",a.append(e.getElement());for(var t=[],c=0;c<n.length;c++)t.push({image:c===r?h.render:n[c].context.canvas,isVisible:n[c].isVisible,opacity:n[c].opacity,mixModeStr:n[c].mixModeStr,hasClipping:!1});var u=new ta({width:t0(o),height:t1(o),project:{width:i.canvas.width,height:i.canvas.height,layers:t}});u.render(),u.getElement().classList.add((0,tG.css)({marginLeft:"-20px",marginRight:"-20px"})),a.append(u.getElement()),s.destroy=function(){e.destroy(),h.destroy(),u.destroy()},s.getInput=function(){return s.destroy(),{radius:l}}},1),s},apply:function(e){var t=e.context,i=e.history,n=e.input.radius;if(!t||!n||!i)return!1;i.pause(!0);var r=rC();if(!r)return!1;var a=r.texture(t.canvas);return r.draw(a).multiplyAlpha().triangleBlur(n).unmultiplyAlpha().update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(r,0,0),a.destroy(),i.pause(!1),i.push({tool:["filter","blur"],action:"apply",params:[{input:e.input}]}),!0}}),r1(nB.unsharpMask,{getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),r=i.getLayerIndex(t.canvas),a=(0,W.BB).el(),s={element:a},o=tZ();o||(s.width=t0(o));var l=2,h=.51,c=new rN({original:t.canvas,onUpdate:function(e,t){return e.unsharpMask(l*t.scaleX,h)}});return setTimeout(function(){function e(){g.render()}var i=new ed({label:J("radius"),width:300,height:30,min:0,max:200,value:2,onChange:function(t){l=t,e()},curve:[[0,0],[.1,2],[.5,50],[1,200]]}),u=new ed({label:J("filter-unsharp-mask-strength"),width:300,height:30,min:0,max:50,value:5.1,onChange:function(t){h=t/10,e()},curve:[[0,0],[.1,2],[.5,10],[1,50]]});i.getElement().style.marginBottom="10px",u.getElement().style.marginBottom="10px",a.append(i.getElement()),a.append(u.getElement());for(var p=[],d=0;d<n.length;d++)p.push({image:d===r?c.render:n[d].context.canvas,isVisible:n[d].isVisible,opacity:n[d].opacity,mixModeStr:n[d].mixModeStr,hasClipping:!1});var g=new ta({width:t0(o),height:t1(o),project:{width:t.canvas.width,height:t.canvas.height,layers:p}});e(),g.getElement().classList.add(eC({marginLeft:"-20px",marginRight:"-20px"})),a.append(g.getElement()),s.destroy=function(){i.destroy(),u.destroy(),c.destroy(),g.destroy()},s.getInput=function(){return s.destroy(),{radius:l,strength:h}}},1),s},apply:function(e){var t=e.context,i=e.history,n=e.input.radius,r=e.input.strength;if(!t||null===n||null===r||!i)return!1;i.pause(!0);var a=rC();if(!a)return!1;var s=a.texture(t.canvas);return a.draw(s).unsharpMask(n,r).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),s.destroy(),i.pause(!1),i.push({tool:["filter","unsharpMask"],action:"apply",params:[{input:e.input}]}),!0}}),r1(nB.toAlpha,{getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),r=i.getLayerIndex(t.canvas),a=(0,W.BB).el(),s={element:a},o=tZ();return o||(s.width=t0(o)),setTimeout(function(){var i=new rN({original:t.canvas,onUpdate:function(e){return e.toAlpha("inverted-luminance"===l,c)}}),l="inverted-luminance",h=new eD({optionArr:[{id:"inverted-luminance",label:J("filter-to-alpha-inverted-lum")},{id:"luminance",label:J("filter-to-alpha-lum")}],initId:l,onChange:function(e){l=e,f.render()}});a.append(h.getElement());var c={r:0,g:0,b:0,a:1},u=[null,{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1},{r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1},{r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1}],p=new eO({label:J("filter-to-alpha-replace"),colorArr:u,initialIndex:1,onChange:function(e){c=e,f.render()}});p.getElement().style.marginTop="10px",p.getElement().style.marginBottom="10px",a.append(p.getElement());for(var d=[],g=0;g<n.length;g++)d.push({image:g===r?i.render:n[g].context.canvas,isVisible:n[g].isVisible,opacity:n[g].opacity,mixModeStr:n[g].mixModeStr,hasClipping:!1});var f=new ta({width:t0(o),height:t1(o),project:{width:t.canvas.width,height:t.canvas.height,layers:d}});f.render(),f.getElement().classList.add((0,tG.css)({marginLeft:"-20px",marginRight:"-20px"})),a.append(f.getElement()),s.destroy=function(){h.destroy(),p.destroy(),i.destroy(),f.destroy()},s.getInput=function(){return s.destroy(),{sourceId:l,selectedRgbaObj:c}}},1),s},apply:function(e){var t=e.context,i=e.history,n=e.input.sourceId,r=e.input.selectedRgbaObj;if(!t||!n||!i)return!1;i.pause(!0);var a=rC();if(!a)return!1;var s=a.texture(t.canvas);return a.draw(s).toAlpha("inverted-luminance"===n,r).update(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.drawImage(a,0,0),s.destroy(),i.pause(!1),i.push({tool:["filter","toAlpha"],action:"apply",params:[{input:e.input}]}),!0}}),r1(nB.grid,{getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),r=(0,_.throwIfNull)(i.getLayerIndex(t.canvas)),a=(0,W.BB).el(),s={element:a},o=tZ();o||(s.width=t0(o));var l={x:2,y:2,thickness:8,color:"#000",opacity:1},h=(0,W.BB).el({parent:a,css:{display:"flex",alignItems:"center"}}),c=(0,W.BB).el({parent:a,css:{display:"flex",alignItems:"center",marginTop:"10px",marginBottom:"10px"}}),u=(0,er.input)({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(e){l.x=parseFloat(e),w()}}),p=(0,er.input)({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(e){l.y=parseFloat(e),w()}}),d=(0,er.input)({init:l.thickness,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(e){l.thickness=parseFloat(e),w()}}),g={r:0,g:0,b:0,a:1},f=[{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];f.push({r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1}),f.push({r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1}),l.color=(0,W.BB).ColorConverter.toRgbStr(g);var v=new eO({label:J("shape-stroke"),colorArr:f,onChange:function(e){g=e,l.color=(0,W.BB).ColorConverter.toRgbStr(g),w()}}),m={display:"inline-block",marginRight:"5px"};h.append((0,W.BB).el({content:"X:",css:m}),u,(0,W.BB).el({content:"Y:",css:m}),p),c.append((0,W.BB).el({content:J("shape-line-width")+":",css:m}),d,(0,W.BB).el({css:{flexGrow:"1"}}),v.getElement());var y=(0,W.BB).canvas(t.canvas.width,t.canvas.height),x=(0,W.BB).ctx(y),b=n.map(function(e,t){return{image:t===r?y:e.context.canvas,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr,hasClipping:!1}}),B=new ta({width:t0(o),height:t1(o),project:{width:t.canvas.width,height:t.canvas.height,layers:b}});function w(){x.save(),x.clearRect(0,0,y.width,y.height),x.drawImage(t.canvas,0,0),rQ(x,l.x,l.y,Math.max(l.thickness,1),l.color,l.opacity),x.restore(),B.render()}return B.getElement().classList.add((0,tG.css)({marginLeft:"-20px",marginRight:"-20px"})),a.append(B.getElement()),w(),B.render(),s.destroy=function(){B.destroy(),(0,W.BB).freeCanvas(y),v.destroy()},s.getInput=function(){return s.destroy(),(0,W.BB).copyObj(l)},s},apply:function(e){var t=e.context,i=e.klCanvas,n=e.history;return!!t&&!!i&&!!n&&(n.pause(!0),rQ(t,e.input.x,e.input.y,e.input.thickness,e.input.color,e.input.opacity),n.pause(!1),n.push({tool:["filter","grid"],action:"apply",params:[{input:e.input}]}),!0)}}),r1(nB.noise,{getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),r=(0,_.throwIfNull)(i.getLayerIndex(t.canvas)),a=[],s=(0,_.throwIfNull)(rC()),o=(0,W.BB).canvas(32,32),l=(0,W.BB).ctx(o),h=s.texture(o);s.draw(h).update(),h.destroy(),rZ.forEach(function(e){var t=new Image,i=(0,W.BB).copyObj(e);i.scaleX/=10,i.scaleY/=10,rJ(s,i),l.drawImage(s,0,0),t.src=o.toDataURL("image/png"),a.push(t)}),h.destroy();var c=(0,W.BB).el(),u={element:c},p=tZ();p||(u.width=t0(p));var d={seed:300*Math.random(),presetIndex:0,scale:50,opacity:.5,isReversed:!1,channels:"rgb",mixModeStr:"source-over",colA:{r:0,g:0,b:0},colB:{r:255,g:255,b:255}},g=new eD({optionArr:a.map(function(e,t){return(0,W.BB).css(e,{margin:"1px",borderRadius:"3px",transition:"all 0.1s ease-in-out"}),{id:""+t,label:e}}),initId:"0",onChange:function(e){d.presetIndex=Number(e),M()}});g.getElement().style.marginBottom="10px",c.append(g.getElement());var f=new ed({label:J("filter-noise-scale"),width:300,height:30,min:1,max:1e3,value:d.scale,eventResMs:60,curve:(0,W.BB).quadraticSplineInput(1,1e3,.1),onChange:function(e){d.scale=e,M()}});f.getElement().style.marginBottom="10px";var v=new ed({label:J("opacity"),width:300,height:30,min:.01,max:1,value:d.opacity,eventResMs:60,toValue:function(e){return e/100},toDisplayValue:function(e){return 100*e},onChange:function(e){d.opacity=e,M()}});v.getElement().style.marginBottom="10px";var m=(0,W.BB).el({css:{display:"flex",alignItems:"center",marginBottom:"10px"}}),y=(0,W.BB).el({css:{display:"flex",marginBottom:"10px"}}),x=new eD({optionArr:[{id:"rgb",label:"RGB"},{id:"alpha",label:J("filter-noise-alpha")}],initId:"rgb",onChange:function(e){d.channels=e,"rgb"===e?y.style.visibility="":y.style.visibility="hidden",M()}}),b=new en({label:J("reverse"),callback:function(e){d.isReversed=e,M()},allowTab:!0}),B=new ea({isFocusable:!0,optionArr:["source-over",void 0,"darken","multiply","color-burn",void 0,"lighten","screen","color-dodge",void 0,"overlay","soft-light","hard-light",void 0,"difference","exclusion",void 0,"hue","saturation","color","luminosity"].map(function(e){return e?[e,tw(e)]:void 0}),initValue:d.mixModeStr,onChange:function(e){d.mixModeStr=e,M()}});B.getElement().title=J("layers-blending");var w=(0,W.BB).el({css:{display:"flex"}}),k={width:"34px",height:"34px",marginRight:"5px"},C=rW.input({type:"color",init:"#"+(0,eP.ColorConverter).toHexString(d.colA),callback:function(e){var t=(0,eP.ColorConverter).hexToRGB(e);t&&(d.colA=t,M())},css:k}),S=rW.input({type:"color",init:"#"+(0,eP.ColorConverter).toHexString(d.colB),callback:function(e){var t=(0,eP.ColorConverter).hexToRGB(e);t&&(d.colB=t,M())},css:k});w.append(C,S),m.append(x.getElement(),(0,W.BB).el({css:{flexGrow:"1"}}),b.getElement()),y.append(B.getElement(),(0,W.BB).el({css:{flexGrow:"1"}}),w),c.append(f.getElement(),v.getElement(),m,y);for(var E=new rN({original:t.canvas,onUpdate:function(e,i){var n=(0,W.BB).copyObj(rZ[d.presetIndex]);return n.seed=d.seed,n.scaleX=n.scaleX*d.scale/50*i.scaleX,n.scaleY=n.scaleY*d.scale/50*i.scaleY,n.colA=d.colA,n.colB=d.colB,n.isReversed=d.isReversed?!n.isReversed:n.isReversed,n.channels=d.channels,n.offsetX=t.canvas.width/2*i.scaleX+i.x,n.offsetY=t.canvas.height/2*i.scaleY+i.y,e.noise(n.seed,n.type,[n.scaleX,n.scaleY],[n.offsetX,n.offsetY],n.octaves,n.samples,n.peaks,n.brightness,n.contrast,n.isReversed,n.colA,n.colB,n.channels?n.channels:"rgb")},postMix:{opacity:d.opacity,operation:"alpha"===d.channels?"destination-out":d.mixModeStr}}),I=[],A=0;A<n.length;A++)I.push({image:A===r?E.render:n[A].context.canvas,isVisible:n[A].isVisible,opacity:n[A].opacity,mixModeStr:n[A].mixModeStr,hasClipping:!1});var T=new ta({width:t0(p),height:t1(p),project:{width:t.canvas.width,height:t.canvas.height,layers:I}});function M(){E.setPostMix({opacity:d.opacity,operation:"alpha"===d.channels?"destination-out":d.mixModeStr}),T.render()}return T.render(),T.getElement().classList.add((0,tG.css)({marginLeft:"-20px",marginRight:"-20px"})),c.append(T.getElement()),u.destroy=function(){g.destroy(),f.destroy(),v.destroy(),b.destroy(),x.destroy(),B.destroy(),T.destroy(),E.destroy()},u.getInput=function(){return u.destroy(),(0,W.BB).copyObj(d)},u},apply:function(e){var t=e.context,i=e.klCanvas,n=e.history;if(!t||!i||!n)return!1;n.pause(!0);var r=rC();if(!r)return!1;var a=r.texture(t.canvas);r.draw(a).update(),a.destroy();var s=e.input,o=(0,W.BB).copyObj(rZ[s.presetIndex]);return o.seed=s.seed,o.scaleX=o.scaleX*s.scale/50,o.scaleY=o.scaleY*s.scale/50,o.colA=s.colA,o.colB=s.colB,o.isReversed=s.isReversed?!o.isReversed:o.isReversed,o.channels=s.channels,rJ(r,o),t.save(),t.globalAlpha=s.opacity,"alpha"===s.channels?t.globalCompositeOperation="destination-out":t.globalCompositeOperation=s.mixModeStr,t.drawImage(r,0,0),t.restore(),n.pause(!1),n.push({tool:["canvas"],action:"replaceLayer",params:[i.getLayerIndex(t.canvas),t.getImageData(0,0,t.canvas.width,t.canvas.height)]}),!0}}),r1(nB.pattern,{getDialog:function(e){var t,i=tZ(),n=(0,W.BB).el(),r=e.context,a=r.canvas.width,s=r.canvas.height,o={x:0,y:0,width:a<=250?Math.round(a/4):200,height:s<=250?Math.round(s/4):200,blend:0,offsetX:0,offsetY:0},l=(0,W.BB).canvasBounds(r);l&&l.width<=1024&&l.height<=1024&&(l.width<.75*a||l.height<.75*s)?(o.x=l.x,o.y=l.y,o.width=l.width,o.height=l.height):(o.x=Math.round(a/2-o.width/2),o.y=Math.round(s/2-o.height/2));var h=(0,er.input)({init:o.x,type:"number",min:0,max:a,css:{width:"100%"},callback:function(e){o.x=Number(e),F()}}),c=(0,er.input)({init:o.y,type:"number",min:0,max:s,css:{width:"100%"},callback:function(e){o.y=Number(e),F()}}),u=(0,er.input)({init:o.width,type:"number",min:1,max:Math.min(1024,a),css:{width:"100%"},callback:function(e){o.width=Number(e),F()}}),p=(0,er.input)({init:o.height,type:"number",min:1,max:Math.min(1024,s),css:{width:"100%"},callback:function(e){o.height=Number(e),F()}}),d={marginLeft:"5px",flex:"1"};n.append((0,W.BB).el({content:[(0,W.BB).el({tagName:"label",content:["X:",h],css:d}),(0,W.BB).el({tagName:"label",content:["Y:",c],css:d}),(0,W.BB).el({tagName:"label",content:[J("width")+":",u],css:d}),(0,W.BB).el({tagName:"label",content:[J("height")+":",p],css:d})],css:{display:"flex",marginLeft:"-5px"}}));var g=new ed({label:J("brush-blending"),width:300,height:30,min:0,max:1,value:o.blend,eventResMs:60,onChange:function(e){o.blend=e,F()},formatFunc:function(e){return(0,W.BB).round(e,2)},manualInputRoundDigits:2});(0,W.BB).css(g.getElement(),{margin:"10px 0"}),n.append(g.getElement());var f=1,v=new rG({left:J("compare-before"),right:J("compare-after"),init:f,onChange:function(e){f=e,T.style.display=0===e?"block":"none",F(!0)}});n.append(v.getElement());var m=e.klCanvas,y=m.getLayers(),x=(0,_.throwIfNull)(m.getLayerIndex(r.canvas)),b=(0,W.BB).fitInto(r.canvas.width,r.canvas.height,i?280:490,i?200:240,1),B=parseInt(""+b.width),w=parseInt(""+b.height),k=Math.min(B,r.canvas.width),C=Math.min(w,r.canvas.height),S=B/r.canvas.width,E=(0,W.BB).el({className:"kl-preview-wrapper",css:{width:t0(i)+"px",height:t1(i)+"px",marginTop:"0"}}),I={image:(0,W.BB).canvas(k,C),isVisible:y[x].isVisible,opacity:y[x].opacity,mixModeStr:y[x].mixModeStr},A=new tH({width:Math.round(B),height:Math.round(w),layers:y.map(function(e,t){return t===x?I:{image:e.context.canvas,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr}})}),T=(0,W.BB).canvas(B,w);(0,W.BB).css(T,{position:"absolute",left:"0",top:"0",mixBlendMode:"difference",imageRendering:"pixelated"});var M=(0,W.BB).el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+B)+"px",height:parseInt(""+w)+"px"}});M.append(A.getElement(),T),E.append(M),n.append(E);var L={};function R(){h.value=""+o.x,c.value=""+o.y,u.value=""+o.width,p.value=""+o.height}var P=new W.BB.KeyListener({});E.oncontextmenu=function(){return!1},M.style.touchAction="none";var O=new W.BB.PointerListener({target:M,onPointer:function(e){if(0===f){if("pointerdown"===e.type){if(!L.state){L.oldSettings=(0,W.BB).copyObj(o);var t=e.relX/S,i=e.relY/S;(0,W.BB).isInsideRect({x:t,y:i},{x:o.x,y:o.y,width:o.width,height:o.height})?L.state="move":L.state="select",L.start={x:t,y:i}}}else if("pointermove"===e.type){var n=e.relX/S,r=e.relY/S;if("select"===L.state){L.end={x:n,y:r};var l=Math.max(0,Math.min(L.start.x,L.end.x)),h=Math.max(0,Math.min(L.start.y,L.end.y)),c=Math.min(a,Math.max(L.start.x,L.end.x)),u=Math.min(s,Math.max(L.start.y,L.end.y));o.x=Math.floor(l),o.y=Math.floor(h),o.width=Math.min(1024,Math.ceil(c-o.x)),o.height=Math.min(1024,Math.ceil(u-o.y)),P.isPressed("shift")&&(o.width=Math.min(o.width,o.height),o.height=Math.min(o.width,o.height)),(0===o.width||0===o.height)&&(o=(0,W.BB).copyObj(L.oldSettings)),R(),F()}else if("move"===L.state){var p=Math.round(n-L.start.x),d=Math.round(r-L.start.y);o.x=(0,W.BB).clamp(L.oldSettings.x+p,0,a-o.width),o.y=(0,W.BB).clamp(L.oldSettings.y+d,0,s-o.height),R(),F()}}else"pointerup"===e.type&&L.state&&(L.state=null)}else"pointerdown"===e.type?L.state||(L.state="move",L.oldSettings=(0,W.BB).copyObj(o),L.start={x:e.relX/S,y:e.relY/S},L.end=null):"pointermove"===e.type?L.state&&(L.end={x:e.relX/S,y:e.relY/S},o.offsetX=Math.round(L.end.x-L.start.x)+L.oldSettings.offsetX,o.offsetY=Math.round(L.end.y-L.start.y)+L.oldSettings.offsetY,F()):"pointerup"===e.type&&L.state&&(L.end||(o.offsetX=0,o.offsetY=0,F()),L.state=null)}}),D=(0,W.BB).canvas(a,s),z=(0,W.BB).ctx(D);function j(e,t,i,n,r){var a=Math.round(t+.5)-.5,s=Math.round(i+.5)-.5,o=Math.round(t+n-a),l=Math.round(i+r-s);e.strokeRect(a,s,o,l)}function F(e){if(e||!t||JSON.stringify(t)!==JSON.stringify(o)){if(0===f){z.clearRect(0,0,a,s),z.drawImage(r.canvas,0,0);var i=I.image,n=(0,W.BB).ctx(i);n.save(),n.clearRect(0,0,k,C),n.drawImage(D,0,0,k,C),n.restore();var l=o.width*S,h=o.height*S,c=(0,W.BB).ctx(T);c.save(),c.clearRect(0,0,B,w),c.strokeStyle="#fff",j(c,o.x*S,o.y*S,l,h),o.blend>.05&&(c.strokeStyle="#f0f",j(c,o.x*S-l/2*o.blend,o.y*S-h/2*o.blend,l*(1+o.blend),h*(1+o.blend))),c.restore()}else{z.clearRect(0,0,a,s),z.drawImage(r.canvas,0,0),r$(z,o);var u=I.image,p=(0,W.BB).ctx(u);p.clearRect(0,0,k,C),p.drawImage(D,0,0,k,C)}A.render(),t=(0,W.BB).copyObj(o)}}F();var V=function(){g.destroy(),P.destroy(),O.destroy(),A.destroy()},H={element:n,destroy:V,getInput:function(){return V(),(0,W.BB).copyObj(o)}};return i||(H.width=t$.width),H},apply:function(e){var t=e.klCanvas,i=e.context,n=e.history;return!!t&&!!n&&(n.pause(!0),r$(i,e.input),n.pause(!1),n.push({tool:["filter","pattern"],action:"apply",params:[{input:e.input}]}),!0)}}),r1(nB.distort,{getDialog:function(e){var t=tZ(),i=(0,W.BB).el(),n=e.context,r=!0,a={stepSize:1,distortType:0,scale:{x:100,y:100},strength:{x:20,y:20},phase:{x:0,y:0},offset:{x:0,y:0}},s=[],o=(0,W.BB).canvas(32,32),l=(0,W.BB).ctx(o);l.beginPath(),l.arc(16,16,12.8,0,2*Math.PI),l.fill();var h=l.createLinearGradient(0,0,32,32);h.addColorStop(0,"#00f"),h.addColorStop(.5,"#f00"),h.addColorStop(1,"#fff"),l.fillStyle=h,l.globalCompositeOperation="source-atop",l.fillRect(0,0,32,32),(h=l.createLinearGradient(32,0,0,32)).addColorStop(0,"#000"),h.addColorStop(1,"#000"),l.fillStyle=h,l.globalCompositeOperation="destination-atop",l.fillRect(0,0,32,32);var c=(0,_.throwIfNull)(rC()),u=c.texture(o);c.draw(u).update(),[0,1,2].forEach(function(e){var t=new Image,i=(0,W.BB).copyObj(a);i.distortType=e,i.scale.x/=20,i.scale.y/=20,i.strength.x/=20,i.strength.y/=20,c.draw(u).multiplyAlpha().distort(i).unmultiplyAlpha().update(),l.clearRect(0,0,32,32),l.drawImage(c,0,0),t.src=o.toDataURL("image/png"),s.push(t)}),u.destroy();var p=(0,W.BB).el({parent:i,css:{display:"flex",alignItems:"center"}}),d=new eD({optionArr:s.map(function(e,t){return(0,W.BB).css(e,{margin:"1px",borderRadius:"3px",transition:"all 0.1s ease-in-out"}),{id:""+t,label:e}}),initId:"0",onChange:function(e){a.distortType=Number(e),I.render()}});function g(e){"x"===e?(a.scale.y=a.scale.x,a.strength.y=a.strength.x,a.phase.y=a.phase.x,b[3].setValue(a.scale.y),b[4].setValue(a.strength.y),b[5].setValue(a.phase.y)):(a.scale.x=a.scale.y,a.strength.x=a.strength.y,a.phase.x=a.phase.y,b[0].setValue(a.scale.x),b[1].setValue(a.strength.x),b[2].setValue(a.phase.x)),I.render()}var f=new en({init:!0,label:J("filter-distort-sync-xy"),callback:function(e){(r=e)&&g("x")}});p.append(d.getElement(),(0,W.BB).el({css:{flexGrow:"1"}}),f.getElement());var v=(0,W.BB).el({parent:i,css:{display:"flex",flexWrap:"wrap"}}),m=(0,W.BB).el({parent:v,css:{marginRight:"10px"}}),y=(0,W.BB).el({parent:v}),x=t?300:245,b=[];["x","y"].forEach(function(e,t){var i=0===t?m:y,n=new ed({label:J("filter-noise-scale")+" "+e.toUpperCase(),width:x,height:30,min:1,max:1e3,curve:"quadratic",value:a.scale[e],eventResMs:60,onChange:function(t){a.scale[e]=t,r?g(e):I.render()}});n.getElement().style.marginTop="20px",i.append(n.getElement());var s=new ed({label:J("filter-unsharp-mask-strength")+" "+e.toUpperCase(),width:x,height:30,min:0,max:200,curve:"quadratic",value:a.strength[e],eventResMs:60,onChange:function(t){a.strength[e]=t,r?g(e):I.render()}});s.getElement().style.marginTop="10px",i.append(s.getElement());var o=new ed({label:J("filter-distort-phase")+" "+e.toUpperCase(),width:x,height:30,min:0,max:1,value:a.phase[e],manualInputRoundDigits:2,eventResMs:60,formatFunc:function(e){return(0,W.BB).round(e,2)},onChange:function(t){a.phase[e]=t,r?g(e):I.render()}});o.getElement().style.marginTop="10px",i.append(o.getElement()),b.push(n),b.push(s),b.push(o)});var B=new ed({label:J("filter-distort-stepsize"),width:300,height:30,min:1,max:300,curve:"quadratic",value:a.stepSize,eventResMs:60,onChange:function(e){a.stepSize=Math.round(e),I.render()}});B.getElement().style.marginTop="20px",B.getElement().style.marginBottom="10px",i.append(B.getElement());var w=e.klCanvas,k=w.getLayers(),C=(0,_.throwIfNull)(w.getLayerIndex(n.canvas)),S=new rN({original:n.canvas,onUpdate:function(e,t){var i=(0,W.BB).copyObj(a);return i.stepSize*=t.scaleX,i.strength.x*=t.scaleX,i.strength.y*=t.scaleY,2!==i.distortType&&(i.scale.x*=t.scaleX,i.scale.y*=t.scaleY),i.offset.x=-t.x,i.offset.y=-t.y,e.multiplyAlpha().distort(i).unmultiplyAlpha()}}),E=k.map(function(e,t){return{image:t===C?S.render:e.context.canvas,isVisible:e.isVisible,opacity:e.opacity,mixModeStr:e.mixModeStr,hasClipping:!1}}),I=new ta({width:t0(t),height:t1(t),project:{width:n.canvas.width,height:n.canvas.height,layers:E}});I.render(),I.getElement().classList.add((0,tG.css)({marginLeft:"-20px",marginRight:"-20px"})),i.append(I.getElement());var A=function(){d.destroy(),b.forEach(function(e){return e.destroy()}),B.destroy(),f.destroy(),S.destroy(),I.destroy()},T={element:i,destroy:A,getInput:function(){return A(),(0,W.BB).copyObj(a)}};return t||(T.width=t$.width),T},apply:function(e){var t=e.klCanvas,i=e.context,n=e.history;if(!t||!n)return!1;n.pause(!0);var r=rC();if(!r)return!1;var a=r.texture(i.canvas);return r.draw(a).multiplyAlpha().distort(e.input).unmultiplyAlpha().update(),i.clearRect(0,0,i.canvas.width,i.canvas.height),i.drawImage(r,0,0),a.destroy(),n.pause(!1),n.push({tool:["filter","distort"],action:"apply",params:[{input:e.input}]}),!0}}),r1(nB.vanishPoint,{getDialog:function(e){var t=e.context,i=e.klCanvas;if(!t||!i)return!1;var n=i.getLayers(),r=(0,_.throwIfNull)(i.getLayerIndex(t.canvas)),a=(0,W.BB).canvas(t.canvas.width,t.canvas.height),s=(0,W.BB).ctx(a),o=(0,W.BB).el(),l={element:o},h=tZ();h||(l.width=t0(h));var c={x:t.canvas.width/2,y:t.canvas.height/2,lines:8,thickness:2,color:{r:0,g:0,b:0},opacity:1},u=new ed({label:J("filter-vanish-point-lines"),width:300,height:30,min:2,max:20,value:c.lines,curve:"quadratic",eventResMs:60,onChange:function(e){c.lines=Math.round(e),B()}});u.getElement().style.marginBottom="10px",o.append(u.getElement());var p=(0,W.BB).el({parent:o,css:{display:"flex",alignItems:"center"}}),d=(0,W.BB).el({parent:o,css:{display:"flex",alignItems:"center",marginTop:"10px",marginBottom:"10px"}}),g=(0,er.input)({init:c.x,type:"number",css:{width:"75px",marginRight:"20px"},callback:function(e){c.x=parseFloat(e),E.setValue({x:c.x,y:c.y}),B()}}),f=(0,er.input)({init:c.y,type:"number",css:{width:"75px",marginRight:"20px"},callback:function(e){c.y=parseFloat(e),E.setValue({x:c.x,y:c.y}),B()}}),v=(0,er.input)({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(e){c.thickness=parseFloat(e),B()}}),m={r:0,g:0,b:0,a:1},y=[{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];y.push({r:e.currentColorRgb.r,g:e.currentColorRgb.g,b:e.currentColorRgb.b,a:1}),y.push({r:e.secondaryColorRgb.r,g:e.secondaryColorRgb.g,b:e.secondaryColorRgb.b,a:1}),c.color=(0,W.BB).copyObj(m);var x=new eO({label:J("shape-stroke"),colorArr:y,onChange:function(e){m=e,c.color=(0,W.BB).copyObj(m),B()}}),b={display:"inline-block",marginRight:"5px"};function B(){var e=a.width,i=a.height;s.save(),s.clearRect(0,0,e,i),s.drawImage(t.canvas,0,0,e,i),r0(s,c.x,c.y,c.lines,Math.max(c.thickness,1),c.color,c.opacity),s.restore(),S.render()}p.append((0,W.BB).el({content:"X:",css:b}),g,(0,W.BB).el({content:"Y:",css:b}),f),d.append((0,W.BB).el({content:J("shape-line-width")+":",css:b}),v,(0,W.BB).el({css:{flexGrow:"1"}}),x.getElement());for(var w=function(){return E.setTransform(S.getTransform()),a},k=[],C=0;C<n.length;C++)k.push({image:C===r?w:n[C].context.canvas,isVisible:n[C].isVisible,opacity:n[C].opacity,mixModeStr:n[C].mixModeStr,hasClipping:!1});var S=new ta({width:t0(h),height:t1(h),project:{width:t.canvas.width,height:t.canvas.height,layers:k}});(0,W.BB).css(S.getElement(),{marginLeft:"-20px",marginRight:"-20px",overflow:"hidden"});var E=new rK({value:{x:c.x,y:c.y},onChange:function(e){c.x=Math.round(e.x),c.y=Math.round(e.y),g.value=""+c.x,f.value=""+c.y,B()}});return B(),S.getElement().append(E.getElement()),o.append(S.getElement()),l.destroy=function(){u.destroy(),x.destroy(),S.destroy()},l.getInput=function(){return l.destroy(),(0,W.BB).copyObj(c)},l},apply:function(e){var t=e.context,i=e.klCanvas,n=e.history;return!!t&&!!i&&!!n&&(n.pause(!0),r0(t,e.input.x,e.input.y,e.input.lines,e.input.thickness,e.input.color,e.input.opacity),n.pause(!1),n.push({tool:["filter","vanishPoint"],action:"apply",params:[{input:e.input}]}),!0)}}),nb.isLoaded=!0);var r9=function(){function e(i,n){var r,a,s,o,l,h,c,u,p,d,g=this;(0,O._)(this,e),this.collapseThreshold=820,this.toolWidth=271;var f=this;this.getPSD=M(function(){return R(this,function(e){switch(e.label){case 0:return[4,function(e){return r2.apply(this,arguments)}(f.klCanvas)];case 1:return[2,e.sent()]}})}),this.embed=n.embed;var v=Math.min(4096,Math.max(2048,Math.max(window.screen.width,window.screen.height)));this.uiState=this.embed?"left":(0,n5.LocalStorage).getItem("uiState")?(0,n5.LocalStorage).getItem("uiState"):"right";var m=n.projectStore;this.klRootEl=(0,W.BB).el({className:"g-root",css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0"}}),this.uiWidth=Math.max(0,window.innerWidth),this.uiHeight=Math.max(0,window.innerHeight);var y="png";this.klCanvas=new rW.KlCanvas(i?{projectObj:i}:{width:Math.max(10,Math.min(v,window.innerWidth<this.collapseThreshold?this.uiWidth:this.uiWidth-this.toolWidth)),height:Math.max(10,Math.min(v,this.uiHeight))},this.embed?-1:0),this.klCanvas.setHistory(V);var x=void 0;n.saveReminder||(n.saveReminder={init:function(){},reset:function(){}}),i?(i.layers.forEach(function(e){e.image=null}),i=null):(V.pause(!0),this.klCanvas.addLayer(),this.klCanvas.layerFill(0,{r:eA,g:eA,b:eA}),V.pause(!1));try{l={canvas:new rW.KlCanvas({copy:this.klCanvas},this.embed?-1:0),focus:this.klCanvas.getLayerCount()-1,brushes:{}}}catch(e){throw"kl-create-canvas-error"===e.message&&this.klCanvas.destroy(),e}Object.entries(rW.brushes).forEach(function(e){var t=(0,P._)(e,2),i=t[0],n=t[1];l.brushes[i]=new n,l.canvas&&l.brushes[i].setContext(l.canvas.getLayerContext(l.focus))});var b=new W.BB.RGB(0,0,0),B=(0,_.throwIfNull)(this.klCanvas.getLayerContext(this.klCanvas.getLayerCount()-1)),w=function(){if("eraserBrush"===c)return u;var e=Object.keys(L).filter(function(e){return"eraserBrush"!==e}),t=e.findIndex(function(e){return e===c});return e[(t+1)%e.length]},k=function(e){C.emitSize(e),g.klCanvasWorkspace&&g.klCanvasWorkspace.setCursorSize(2*e)},C=new rW.BrushSettingService(function(e){g.klColorSlider.setColor(e),h.setColor(e),b=(0,W.BB).copyObj(e)},function(e){h.setSize(e),g.klCanvasWorkspace.setCursorSize(2*e)},function(e){h.setOpacity(e)},function(){return g.klColorSlider.getColor()},function(){return L[c].getSize()},function(){return L[c].getOpacity()},function(){return{sizeSlider:rW.brushesUI[c].sizeSlider,opacitySlider:rW.brushesUI[c].opacitySlider}}),S=new r5({smoothing:r4(1)});this.lineSanitizer=new r3;var E=new W.BB.EventChain({chainArr:[this.lineSanitizer,S]});E.setChainOut(function(e){"down"===e.type&&(g.toolspace.style.pointerEvents="none",h.startLine(e.x,e.y,e.pressure),g.klCanvasWorkspace.requestFrame()),"move"===e.type&&(h.goLine(e.x,e.y,e.pressure,!1,e.isCoalesced),g.klCanvasWorkspace.setLastDrawEvent(e.x,e.y,e.pressure),g.klCanvasWorkspace.requestFrame()),"up"===e.type&&(g.toolspace.style.pointerEvents="",h.endLine(),g.klCanvasWorkspace.requestFrame()),"line"===e.type&&(h.getBrush().drawLineSegment(e.x0,e.y0,e.x1,e.y1),g.klCanvasWorkspace.requestFrame())});var I={size:20,align:"left",isBold:!1,isItalic:!1,font:"sans-serif",letterSpacing:0,lineHeight:1,fill:{color:{r:0,g:0,b:0,a:1}}};this.klCanvasWorkspace=new rW.KlCanvasWorkspace({klCanvas:this.klCanvas,width:Math.max(0,this.uiWidth-this.toolWidth),height:this.uiHeight,onDraw:function(e){return E.chainIn(e)},onPick:function(e,t){C.setColor(e),t&&(g.klColorSlider.pickingDone(),g.klCanvasWorkspace.setMode(g.toolspaceToolRow.getActive()))},onFill:function(e,t){var i=(0,_.throwIfNull)(g.klCanvas.getLayerIndex(B.canvas));g.klCanvas.floodFill(i,e,t,G.getIsEraser()?null:g.klColorSlider.getColor(),G.getOpacity(),G.getTolerance(),G.getSample(),G.getGrow(),G.getContiguous()),g.klCanvasWorkspace.requestFrame()},onGradient:function(e,t,i,n){"down"===e&&Z.onDown(t,i,n),"move"===e&&Z.onMove(t,i),"up"===e&&Z.onUp(t,i)},onText:function(e,t,i){rW.dialogCounter.get()>0||rW.textToolDialog({klCanvas:g.klCanvas,layerIndex:(0,_.throwIfNull)(g.klCanvas.getLayerIndex(B.canvas)),primaryColor:g.klColorSlider.getColor(),secondaryColor:g.klColorSlider.getSecondaryRGB(),text:(0,eR._)((0,X._)({},I),{text:"",x:e,y:t,angleRad:i,fill:I.fill?{color:(0,eR._)((0,X._)({},g.klColorSlider.getColor()),{a:I.fill.color.a})}:void 0,stroke:I.stroke?(0,eR._)((0,X._)({},I.stroke),{color:(0,eR._)((0,X._)({},g.klColorSlider.getSecondaryRGB()),{a:I.stroke.color.a})}):void 0}),onConfirm:function(e){I=(0,eR._)((0,X._)({},e),{text:""});var t=(0,_.throwIfNull)(g.klCanvas.getLayerIndex(B.canvas));g.klCanvas.text(t,e),g.klCanvasWorkspace.requestFrame()}})},onShape:function(e,t,i,n){"down"===e&&$.onDown(t,i,n),"move"===e&&$.onMove(t,i),"up"===e&&$.onUp(t,i)},onViewChange:function(e){e.changed.includes("scale")&&g.statusOverlay.out({type:"transform",scale:e.scale,angleDeg:180*e.angle/Math.PI}),g.toolspaceToolRow.setEnableZoomIn(e.scale!==g.klCanvasWorkspace.getMaxScale()),g.toolspaceToolRow.setEnableZoomOut(e.scale!==g.klCanvasWorkspace.getMinScale()),U.update(e.scale,180*e.angle/Math.PI)},onUndo:function(){V.canUndo()&&et.undo()&&g.statusOverlay.out(J("undo"),!0)},onRedo:function(){V.canRedo()&&et.redo()&&g.statusOverlay.out(J("redo"),!0)}});var A=function(){if(x)for(var e=g.toolspaceToolRow.getActive(),t=x.getOpenedTabId(),i=["draw","hand","fill","gradient","text","shape"],n=0;n<i.length;n++)e===i[n]?x.setIsVisible(i[n],!0):(x.setIsVisible(i[n],!1),t===i[n]&&x.open(e))},T=new W.BB.KeyListener({onDown:function(e,t,i){if(!(rW.dialogCounter.get()>0||(0,W.BB).isInputFocused(!0))&&!(g.lineSanitizer.getIsDrawing()||g.klCanvasWorkspace.getIsDrawing())){if("plus"===i&&g.klCanvasWorkspace.zoomByStep(T.isPressed("shift")?1/8:.5),"minus"===i&&g.klCanvasWorkspace.zoomByStep(T.isPressed("shift")?-1/8:-.5),"home"===i&&g.klCanvasWorkspace.fitView(!0),"end"===i&&g.klCanvasWorkspace.resetView(!0),["ctrl+z","cmd+z"].includes(i)&&(t.preventDefault(),et.undo()),(["ctrl+y","cmd+y"].includes(i)||((0,W.BB).sameKeys("ctrl+shift+z",i)||(0,W.BB).sameKeys("cmd+shift+z",i))&&"z"===e)&&(t.preventDefault(),et.redo()),!g.embed&&(["ctrl+s","cmd+s"].includes(i)&&(t.preventDefault(),g.saveToComputer.save()),["ctrl+shift+s","cmd+shift+s"].includes(i)&&(t.preventDefault(),M(function(){var e,t;return R(this,function(i){switch(i.label){case 0:e=!0,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,m.store(g.klCanvas.getProject())];case 2:return i.sent(),[3,4];case 3:return t=i.sent(),e=!1,setTimeout(function(){throw Error("keyboard-shortcut: failed to store browser storage, "+t)},0),g.statusOverlay.out(" "+J("file-storage-failed"),!0),[3,4];case 4:return e&&(n.saveReminder.reset(),g.statusOverlay.out(J("file-storage-stored"),!0)),[2]}})})()),["ctrl+c","cmd+c"].includes(i)&&(t.preventDefault(),er(!0))),["ctrl+a","cmd+a"].includes(i)&&t.preventDefault(),T.comboOnlyContains(["left","right","up","down"])&&("left"===e&&g.klCanvasWorkspace.translateView(1,0),"right"===e&&g.klCanvasWorkspace.translateView(-1,0),"up"===e&&g.klCanvasWorkspace.translateView(0,1),"down"===e&&g.klCanvasWorkspace.translateView(0,-1)),["r+left","r+right"].includes(i)&&("left"===e&&(g.klCanvasWorkspace.setAngle(-15,!0),U.update(g.klCanvasWorkspace.getScale(),g.klCanvasWorkspace.getAngleDeg())),"right"===e&&(g.klCanvasWorkspace.setAngle(15,!0),U.update(g.klCanvasWorkspace.getScale(),g.klCanvasWorkspace.getAngleDeg()))),["r+up"].includes(i)&&(g.klCanvasWorkspace.setAngle(0),U.update(g.klCanvasWorkspace.getScale(),g.klCanvasWorkspace.getAngleDeg())),"sqbr_open"===i&&h.decreaseSize(.03/g.klCanvasWorkspace.getScale()),"sqbr_close"===i&&h.increaseSize(.03/g.klCanvasWorkspace.getScale()),"enter"===i&&(g.klCanvas.layerFill((0,_.throwIfNull)(g.klCanvas.getLayerIndex(B.canvas)),g.klColorSlider.getColor()),g.statusOverlay.out(J("filled"),!0)),["delete","backspace"].includes(i)){var r=(0,_.throwIfNull)(g.klCanvas.getLayerIndex(B.canvas));0!==r||L.eraserBrush.getIsTransparentBg()?g.klCanvas.clearLayer(r):g.klCanvas.layerFill(r,{r:255,g:255,b:255},"source-in"),g.statusOverlay.out(J("cleared-layer"),!0)}if("shift+e"===i?(t.preventDefault(),h.toggleEraser&&h.toggleEraser()):"e"===i&&(t.preventDefault(),g.klCanvasWorkspace.setMode("draw"),g.toolspaceToolRow.setActive("draw"),x&&x.open("draw"),A(),Y.open("eraserBrush")),"b"===i){t.preventDefault();var a=g.klCanvasWorkspace.getMode();g.klCanvasWorkspace.setMode("draw"),g.toolspaceToolRow.setActive("draw"),x&&x.open("draw"),A(),Y.open("draw"===a?w():c)}if("g"===i){t.preventDefault();var s="fill"===g.klCanvasWorkspace.getMode()?"gradient":"fill";g.klCanvasWorkspace.setMode(s),g.toolspaceToolRow.setActive(s),x&&x.open(s),A()}"t"===i&&(t.preventDefault(),g.klCanvasWorkspace.setMode("text"),g.toolspaceToolRow.setActive("text"),x&&x.open("text"),A()),"u"===i&&(t.preventDefault(),g.klCanvasWorkspace.setMode("shape"),g.toolspaceToolRow.setActive("shape"),x&&x.open("shape"),A()),"x"===i&&(t.preventDefault(),g.klColorSlider.swapColors())}},onUp:function(e,t){}}),L={};Object.entries(rW.brushesUI).forEach(function(e){var t=(0,P._)(e,2),i=t[0],n=new t[1].Ui({onSizeChange:k,onOpacityChange:function(e){C.emitOpacity(e)},onConfigChange:function(){C.emitSliderConfig({sizeSlider:rW.brushesUI[c].sizeSlider,opacitySlider:rW.brushesUI[c].opacitySlider})}});L[i]=n,n.getElement().style.padding="10px"}),this.statusOverlay=new rW.StatusOverlay,this.toolspace=(0,W.BB).el({className:"kl-toolspace",css:{position:"absolute",right:"0",top:"0",bottom:"0",width:this.toolWidth+"px",overflow:"hidden",userSelect:"none",touchAction:"none"}}),this.toolspaceInner=(0,W.BB).el({parent:this.toolspace}),this.toolspace.oncontextmenu=function(){return!1},this.toolspace.onclick=W.BB.handleClick,this.toolspaceCollapser=new rW.ToolspaceCollapser({onChange:function(){g.updateCollapse()}}),this.updateCollapse(),setTimeout(function(){p=new rW.OverlayToolspace({enabledTest:function(){return 0===rW.dialogCounter.get()&&!g.lineSanitizer.getIsDrawing()},brushSettingService:C}),g.klRootEl.append(p.getElement())},0),(0,W.BB).append(this.klRootEl,[this.klCanvasWorkspace.getElement(),this.toolspace,this.toolspaceCollapser.getElement()]),(d=this.embed?new rX({onHelp:function(){nZ(g.embed.url+"/help.html",!!g.embed)},onSubmit:function(){var e,t=function(){var e,t=(0,W.BB).el({tagName:"button",textContent:J("save-reminder-save-psd"),css:{display:"block"}});t.onclick=function(){g.saveAsPsd(),e()},rW.popup({target:g.klRootEl,message:"<b>"+J("upload-failed")+"</b>",div:(0,W.BB).el({content:[(0,W.BB).el({content:J("backup-drawing"),css:{marginBottom:"10px"}}),t]}),ignoreBackground:!0,closeFunc:function(t){e=t}})};rW.popup({target:g.klRootEl,message:J("submit-prompt"),buttons:[J("submit"),"Cancel"],callback:(e=M(function(e){var i;return R(this,function(r){return e!==J("submit")||(i=(0,W.BB).el({parent:g.klRootEl,className:"upload-overlay",content:'<div class="spinner"></div> '+J("submit-submitting")}),g.embed.onSubmit(function(){n.saveReminder.reset(),i.remove()},function(){i.remove(),t()})),[2]})}),function(t){return e.apply(this,arguments)})})},onLeftRight:function(){g.uiState="left"===g.uiState?"right":"left",g.updateUi()}}):new rW.ToolspaceTopRow({logoImg:n.logoImg,onLogo:function(){nZ("./home/",!!g.embed)},onNew:function(){ei()},onImport:function(){ea.triggerImport()},onSave:function(){g.saveToComputer.save()},onShare:function(){en()},onHelp:function(){nZ("./help/",!!g.embed)}})).getElement().style.marginBottom="10px",this.toolspaceInner.append(d.getElement()),this.toolspaceToolRow=new rW.ToolspaceToolRow({onActivate:function(e){if("draw"===e)g.klCanvasWorkspace.setMode("draw");else if("hand"===e)g.klCanvasWorkspace.setMode("hand");else if("fill"===e)g.klCanvasWorkspace.setMode("fill");else if("gradient"===e)g.klCanvasWorkspace.setMode("gradient");else if("text"===e)g.klCanvasWorkspace.setMode("text");else if("shape"===e)g.klCanvasWorkspace.setMode("shape");else throw Error("unknown activeStr");x&&x.open(e),A(),g.klColorSlider.pickingDone()},onZoomIn:function(){g.klCanvasWorkspace.zoomByStep(T.isPressed("shift")?1/8:.5)},onZoomOut:function(){g.klCanvasWorkspace.zoomByStep(T.isPressed("shift")?-1/8:-.5)},onUndo:function(){et.undo()},onRedo:function(){et.redo()}}),this.toolspaceToolRow.setIsSmall(this.uiHeight<540),V.addListener(function(){g.toolspaceToolRow.setEnableUndo(V.canUndo()),g.toolspaceToolRow.setEnableRedo(V.canRedo())}),this.toolspaceInner.append(this.toolspaceToolRow.getElement()),this.klColorSlider=new rW.KlColorSlider({width:250,height:30,svHeight:100,startValue:new W.BB.RGB(0,0,0),onPick:function(e){b=e,h.setColor(e),C.emitColor(e),g.klColorSlider.pickingDone()}}),this.klColorSlider.setHeight(Math.max(163,Math.min(400,this.uiHeight-505))),this.klColorSlider.setPickCallback(function(e){e?g.klCanvasWorkspace.setMode("pick"):(g.klCanvasWorkspace.setMode(g.toolspaceToolRow.getActive()),A())});var D=function(e){"eraserBrush"!==e&&(u=e),g.klColorSlider&&("eraserBrush"===e?g.klColorSlider.enable(!1):g.klColorSlider.enable(!0)),c=e,(h=L[e]).setColor(b),h.setContext(B),g.klCanvasWorkspace.setMode("draw"),g.toolspaceToolRow.setActive("draw"),A()},j=function(e){B=e.context,h.setContext(e.context),g.layerPreview.setLayer(e)},F=(0,W.BB).el(),H=(0,W.BB).el({css:{margin:"10px",display:"flex",flexWrap:"wrap",justifyContent:"space-between",alignItems:"flex-end"}}),N=new rW.ToolspaceStabilizerRow({smoothing:1,onSelect:function(e){S.setSmoothing(r4(e))}});F.append(H),(0,W.BB).append(H,[this.klColorSlider.getElement(),this.klColorSlider.getOutputElement(),N.getElement()]);var Y=new rW.TabRow({initialId:"penBrush",useAccent:!0,tabArr:function(){for(var e=[],t=function(e){return{id:e,image:rW.brushesUI[e].image,title:rW.brushesUI[e].tooltip,onOpen:function(){L[e].getElement().style.display="block",D(e),g.klColorSlider.pickingDone(),C.emitSliderConfig({sizeSlider:rW.brushesUI[e].sizeSlider,opacitySlider:rW.brushesUI[e].opacitySlider}),k(L[e].getSize()),C.emitOpacity(L[e].getOpacity())},onClose:function(){L[e].getElement().style.display="none"}}},i=Object.keys(L),n=0;n<i.length;n++)e.push(t(i[n]));return e}()});(0,W.BB).append(F,[Y.getElement()].concat((0,z._)(Object.entries(rW.brushesUI).map(function(e){return L[(0,P._)(e,1)[0]].getElement()}))));var U=new rW.HandUi({scale:this.klCanvasWorkspace.getScale(),angleDeg:0,onReset:function(){g.klCanvasWorkspace.resetView(!0),U.update(g.klCanvasWorkspace.getScale(),g.klCanvasWorkspace.getAngleDeg())},onFit:function(){g.klCanvasWorkspace.fitView(!0),U.update(g.klCanvasWorkspace.getScale(),g.klCanvasWorkspace.getAngleDeg())},onAngleChange:function(e,t){g.klCanvasWorkspace.setAngle(e,t),U.update(g.klCanvasWorkspace.getScale(),g.klCanvasWorkspace.getAngleDeg())}}),G=new rW.FillUi({colorSlider:this.klColorSlider}),K=new rW.GradientUi({colorSlider:this.klColorSlider}),q=new rW.TextUi({colorSlider:this.klColorSlider}),Q=new rW.ShapeUi({colorSlider:this.klColorSlider}),Z=new rW.GradientTool({onGradient:function(e,t,i,n,r,a){var s=(0,_.throwIfNull)(g.klCanvas.getLayerIndex(B.canvas)),o=K.getSettings(),l={type:o.type,color1:g.klColorSlider.getColor(),isReversed:o.isReversed,opacity:o.opacity,doLockAlpha:o.doLockAlpha,isEraser:o.isEraser,doSnap:T.isPressed("shift")||o.doSnap,x1:t,y1:i,x2:n,y2:r,angleRad:a};e?(g.klCanvas.setComposite(s,null),g.klCanvas.drawGradient(s,l)):g.klCanvas.setComposite(s,{draw:function(e){rW.drawGradient(e,l)}}),g.klCanvasWorkspace.requestFrame()}}),$=new rW.ShapeTool({onShape:function(e,t,i,n,r,a){var s=(0,_.throwIfNull)(g.klCanvas.getLayerIndex(B.canvas)),o={type:Q.getShape(),x1:t,y1:i,x2:n,y2:r,angleRad:a,isOutwards:Q.getIsOutwards(),opacity:Q.getOpacity(),isEraser:Q.getIsEraser(),doLockAlpha:Q.getDoLockAlpha()};"line"===Q.getShape()?(o.strokeRgb=g.klColorSlider.getColor(),o.lineWidth=Q.getLineWidth(),o.isAngleSnap=Q.getIsSnap()||T.isPressed("shift")):(o.isFixedRatio=Q.getIsFixed()||T.isPressed("shift"),"stroke"===Q.getMode()?(o.strokeRgb=g.klColorSlider.getColor(),o.lineWidth=Q.getLineWidth()):o.fillRgb=g.klColorSlider.getColor()),e?(g.klCanvas.setComposite(s,null),g.klCanvas.drawShape(s,o)):g.klCanvas.setComposite(s,{draw:function(e){rW.drawShape(e,o)}}),g.klCanvasWorkspace.requestFrame()}});this.layerManager=new rW.LayerManager(this.klCanvas,function(e){j((0,_.throwIfNull)(g.klCanvas.getLayer(e))),V.push({tool:["misc"],action:"focusLayer",params:[e]})},this.klRootEl,this.uiState),this.layerPreview=new rW.LayerPreview({klRootEl:this.klRootEl,onClick:function(){x&&x.open("layers")},uiState:this.uiState}),this.layerPreview.setIsVisible(this.uiHeight>=579),this.layerPreview.setLayer(this.klCanvas.getLayer(this.klCanvas.getLayerIndex(B.canvas)));var ee=new rW.FilterTab(this.klRootEl,this.klColorSlider,this.layerManager,this.klCanvasWorkspace,U,function(){return b},function(){return v},function(){return g.klCanvas},function(){return B},!!this.embed,this.statusOverlay),et=new rW.UndoRedoCatchup(L,this.layerPreview,this.layerManager,U,this.klCanvasWorkspace,function(){if(!l)throw Error("initState not initialized");return l},function(){return g.klCanvas},function(){return B},function(e){B=e},function(){return h});V.addListener(function(e){et.catchup(e)});var ei=function(){rW.newImageDialog({currentColor:b,secondaryColor:g.klColorSlider.getSecondaryRGB(),maxCanvasSize:v,canvasWidth:g.klCanvas.getWidth(),canvasHeight:g.klCanvas.getHeight(),workspaceWidth:window.innerWidth<g.collapseThreshold?g.uiWidth:g.uiWidth-g.toolWidth,workspaceHeight:g.uiHeight,onConfirm:function(e,t,i){g.klCanvas.reset({width:e,height:t,color:1===i.a?i:void 0}),g.layerManager.update(0),j((0,_.throwIfNull)(g.klCanvas.getLayer(0))),g.klCanvasWorkspace.resetOrFitView(),U.update(g.klCanvasWorkspace.getScale(),g.klCanvasWorkspace.getAngleDeg())},onCancel:function(){}})},en=function(e){(0,W.BB).shareCanvas({canvas:g.klCanvas.getCompleteCanvas(1),fileName:(0,W.BB).getDate()+tj.filenameBase+".png",title:(0,W.BB).getDate()+tj.filenameBase+".png",callback:e||function(){}})};this.saveToComputer=new rW.SaveToComputer(n.saveReminder,function(){return y},function(){return g.klCanvas});var er=function(e){rW.clipboardDialog(g.klRootEl,g.klCanvas.getCompleteCanvas(1),function(e){(0!==e.left||0!==e.right||0!==e.top||0!==e.bottom)&&(rW.filterLib.cropExtend.apply({context:B,klCanvas:g.klCanvas,input:e,history:V}),g.layerManager.update(),g.klCanvasWorkspace.resetOrFitView(),U.update(g.klCanvasWorkspace.getScale(),g.klCanvasWorkspace.getAngleDeg()))},g.statusOverlay,e||!1)},ea=this.embed?null:new rW.FileTab(this.klRootEl,m,function(){return g.klCanvas.getProject()},y,function(e){y=e},function(e,t){return g.importHandler.handleFileSelect(e,t)},function(){return g.saveToComputer.save()},ei,en,function(){rW.imgurUpload(g.klCanvas,g.klRootEl,n.saveReminder,n.app&&n.app.imgurKey?n.app.imgurKey:"")},er,n.saveReminder),es=new rW.SettingsTab(function(){g.uiState="left"===g.uiState?"right":"left",g.updateUi(),g.embed||(0,n5.LocalStorage).setItem("uiState",g.uiState)},this.embed?void 0:n.saveReminder,n.aboutEl);x=new rW.TabRow({initialId:"draw",tabArr:[{id:"draw",title:J("tool-brush"),image:t(ie),onOpen:function(){"eraserBrush"===c&&g.klColorSlider.enable(!1),(0,W.BB).append(H,[g.klColorSlider.getElement(),g.klColorSlider.getOutputElement(),N.getElement()]),F.style.display="block"},onClose:function(){F.style.display="none"},css:{minWidth:"45px"}},{id:"hand",title:J("tool-hand"),image:t(e7),isVisible:!1,onOpen:function(){U.setIsVisible(!0)},onClose:function(){U.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"fill",title:J("tool-paint-bucket"),image:t(it),isVisible:!1,onOpen:function(){g.klColorSlider.enable(!0),G.setIsVisible(!0)},onClose:function(){G.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"gradient",title:J("tool-gradient"),image:t(ii),isVisible:!1,onOpen:function(){g.klColorSlider.enable(!0),K.setIsVisible(!0)},onClose:function(){K.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"text",title:J("tool-text"),image:t(ir),isVisible:!1,onOpen:function(){g.klColorSlider.enable(!0),q.setIsVisible(!0)},onClose:function(){q.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"shape",title:J("tool-shape"),image:t(ia),isVisible:!1,onOpen:function(){g.klColorSlider.enable(!0),Q.setIsVisible(!0)},onClose:function(){Q.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"layers",title:J("layers"),image:t(r8),onOpen:function(){g.layerManager.update(),g.layerManager.getElement().style.display="block"},onClose:function(){g.layerManager.getElement().style.display="none"},css:{minWidth:"45px"}},{id:"edit",label:J("tab-edit"),onOpen:function(){ee.show()},onClose:function(){ee.hide()},css:{padding:"0 7px"}},{id:"file",label:J("tab-file"),isVisible:!!ea,onOpen:function(){ea&&(ea.getElement().style.display="block",ea.setIsVisible(!0))},onClose:function(){ea&&(ea.getElement().style.display="none",ea.setIsVisible(!1))},css:{padding:"0 7px"}},{id:"settings",title:J("tab-settings"),image:t(r7),onOpen:function(){es.getElement().style.display="block"},onClose:function(){es.getElement().style.display="none"},css:{minWidth:"45px"}}]}),this.bottomBarWrapper=(0,W.BB).el({css:{width:"270px",position:"absolute",bottom:"0",left:"0"}}),n.bottomBar&&(this.bottomBar=n.bottomBar,this.bottomBarWrapper.append(this.bottomBar),new MutationObserver(function(){return g.updateBottomBar()}).observe(this.toolspaceInner,{attributes:!0,childList:!0,subtree:!0})),(0,W.BB).append(this.toolspaceInner,[this.layerPreview.getElement(),x.getElement(),F,U.getElement(),G.getElement(),K.getElement(),q.getElement(),Q.getElement(),this.layerManager.getElement(),ee.getElement(),ea?ea.getElement():void 0,es.getElement(),(0,W.BB).el({css:{height:"10px"}}),this.bottomBarWrapper?this.bottomBarWrapper:void 0]),this.toolspaceScroller=new rW.ToolspaceScroller({toolspace:this.toolspace,uiState:this.uiState}),this.embed||Object.defineProperty(window,"KL",{value:(r={onDraw:function(e){e&&0!==e.length&&(e.forEach(function(e,t){0===t?h.startLine(e.x,e.y,1):h.goLine(e.x,e.y,1)}),h.endLine(),g.klCanvasWorkspace.requestFrame())}},o=["Draw via the console! Learn more: %cKL.help()","background: #000; color: #0f0;"],"info"in console?(a=console).info.apply(a,(0,z._)(o)):(s=console).log.apply(s,(0,z._)(o)),Object.freeze({draw:function(e){r.onDraw(e)},help:function(){console.log("KL.draw({x: number; y: number}[]) // draw a line\nKL.help() // print help\n")}})),writable:!1}),this.resize(this.uiWidth,this.uiHeight),this.updateUi(),this.importHandler=new r6({klRootEl:this.klRootEl,klMaxCanvasSize:v,layerManager:this.layerManager,setCurrentLayer:j,klCanvas:this.klCanvas,klCanvasWorkspace:this.klCanvasWorkspace,handUi:U},{onColor:function(e){return C.setColor(e)}}),this.embed||(new rW.KlImageDropper({target:document.body,onDrop:function(e,t){rW.dialogCounter.get()>0||g.importHandler.handleFileSelect(e,t)},enabledTest:function(){return 0===rW.dialogCounter.get()}}),window.document.addEventListener("paste",function(e){return g.importHandler.onPaste(e)},!1)),window.addEventListener("resize",function(){g.resize(window.innerWidth,window.innerHeight)}),window.addEventListener("orientationchange",function(){g.resize(window.innerWidth,window.innerHeight)});var eo=(0,W.BB).el({parent:document.body,css:{position:"fixed",left:"0",top:"0",right:"0",bottom:"0",pointerEvents:"none",zIndex:"-1",userSelect:"none"}});try{new ResizeObserver(function(){return g.resize(window.innerWidth,window.innerHeight)}).observe(eo)}catch(e){eo.remove()}this.klRootEl.addEventListener("wheel",function(e){T.isPressed("ctrl")&&e.preventDefault()});var el=function(e){e.preventDefault()};window.addEventListener("gesturestart",el),window.addEventListener("gesturechange",el),window.addEventListener("gestureend",el)}return(0,D._)(e,[{key:"updateCollapse",value:function(){this.uiWidth<this.collapseThreshold?(this.toolspaceCollapser.getElement().style.display="block",this.toolspaceCollapser.setDirection(this.uiState),this.toolspaceCollapser.isOpen()?("left"===this.uiState?((0,W.BB).css(this.toolspaceCollapser.getElement(),{left:"271px",right:""}),(0,W.BB).css(this.klCanvasWorkspace.getElement(),{left:"271px"})):((0,W.BB).css(this.toolspaceCollapser.getElement(),{left:"",right:"271px"}),(0,W.BB).css(this.klCanvasWorkspace.getElement(),{left:"0"})),this.toolspace.style.display="block",this.klCanvasWorkspace.setSize(Math.max(0,this.uiWidth-this.toolWidth),this.uiHeight),this.statusOverlay.setWide(!1)):("left"===this.uiState?(0,W.BB).css(this.toolspaceCollapser.getElement(),{left:"0",right:""}):(0,W.BB).css(this.toolspaceCollapser.getElement(),{left:"",right:"0"}),(0,W.BB).css(this.klCanvasWorkspace.getElement(),{left:"0"}),this.toolspace.style.display="none",this.klCanvasWorkspace.setSize(Math.max(0,this.uiWidth),this.uiHeight),this.statusOverlay.setWide(!0))):(this.toolspaceCollapser.getElement().style.display="none","left"===this.uiState?(0,W.BB).css(this.klCanvasWorkspace.getElement(),{left:"271px"}):(0,W.BB).css(this.klCanvasWorkspace.getElement(),{left:"0"}),this.toolspace.style.display="block",this.klCanvasWorkspace.setSize(Math.max(0,this.uiWidth-this.toolWidth),this.uiHeight),this.statusOverlay.setWide(!1))}},{key:"updateBottomBar",value:function(){if(this.bottomBar){var e=this.toolspaceInner.scrollHeight+40<window.innerHeight?"":"none";e!==this.bottomBarWrapper.style.display&&(this.bottomBarWrapper.style.display=e)}}},{key:"updateUi",value:function(){this.toolspace.classList.toggle("kl-toolspace--left","left"===this.uiState),this.toolspace.classList.toggle("kl-toolspace--right","right"===this.uiState),"left"===this.uiState?((0,W.BB).css(this.toolspace,{left:"0",right:""}),(0,W.BB).css(this.klCanvasWorkspace.getElement(),{left:"271px"})):((0,W.BB).css(this.toolspace,{left:"",right:"0"}),(0,W.BB).css(this.klCanvasWorkspace.getElement(),{left:"0"})),this.statusOverlay.setUiState(this.uiState),this.layerPreview.setUiState(this.uiState),this.layerManager.setUiState(this.uiState),this.updateCollapse(),this.toolspaceScroller.updateUiState(this.uiState)}},{key:"getEl",value:function(){return this.klRootEl}},{key:"resize",value:function(e,t){window.scrollY>0&&window.scrollTo(0,0),(this.uiWidth!==Math.max(0,e)||this.uiHeight!==Math.max(0,t))&&(this.uiWidth=Math.max(0,e),this.uiHeight=Math.max(0,t),this.updateCollapse(),this.updateBottomBar(),this.layerPreview.setIsVisible(this.uiHeight>=579),this.klColorSlider.setHeight(Math.max(163,Math.min(400,this.uiHeight-505))),this.toolspaceToolRow.setIsSmall(this.uiHeight<540))}},{key:"out",value:function(e){this.statusOverlay.out(e)}},{key:"getPNG",value:function(){return n0(this.klCanvas.getCompleteCanvas(1).toDataURL("image/png"))}},{key:"getProject",value:function(){return this.klCanvas.getProject()}},{key:"swapUiLeftRight",value:function(){this.uiState="left"===this.uiState?"right":"left",this.embed||(0,n5.LocalStorage).setItem("uiState",this.uiState),this.updateUi()}},{key:"saveAsPsd",value:function(){this.saveToComputer.save("psd")}},{key:"isDrawing",value:function(){return this.lineSanitizer.getIsDrawing()||this.klCanvasWorkspace.getIsDrawing()}},{key:"injectLayer",value:function(e,t){var i=this;V.pause(!0);for(var n=0;n<this.klCanvas.layerCanvasArr.length&&this.klCanvas.layerCanvasArr[n].name!==t;n++);if(n===this.klCanvas.layerCanvasArr.length){if(this.klCanvas.isLayerLimitReached())return;this.klCanvas.addLayer(),this.klCanvas.layerCanvasArr[n].name=t}var r=new Image;r.onload=function(){var e=(0,W.BB).ctx(i.klCanvas.layerCanvasArr[n]);e.clearRect(0,0,i.klCanvas.getWidth(),i.klCanvas.getHeight()),e.drawImage(r,0,0)},r.src=e,this.layerManager.update(),V.pause(!1),V.push({tool:["misc"],action:"importImage",params:[(0,W.BB).copyCanvas(this.klCanvas.layerCanvasArr[n]),t]})}}]),e}();function ae(e){var t=document.createElement("div");t.style.textAlign="center",t.style.background="#fff",t.style.padding="20px",t.innerHTML="<h1>App failed to initialize</h1>";var i=document.createElement("div");i.textContent="Error: "+(e.message?e.message:""+e),t.append(i),document.body.append(t),console.error(e)}I("1C8RU"),M(function(){var e,t;function i(){return n.apply(this,arguments)}function n(){return(n=M(function(){var t,n,r,a,s;return R(this,function(o){switch(o.label){case 0:o.trys.push([0,5,,6]),window.removeEventListener("DOMContentLoaded",i),t=new rW.ProjectStore,n=null,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,t.read()];case 2:return(r=o.sent())&&(n=r.project),[3,4];case 3:return 0===(a=o.sent()).message.indexOf("db-error")?s="Failed to access Browser Storage":(a.message.indexOf("format-error"),s="Failed to restore from Browser Storage"),s&&setTimeout(function(){throw e&&e.out(s),Error("Initial browser storage error, "+a)},100),[3,4];case 4:return function(t,i){if(e)throw"onKlProjectObjLoaded called more than once";var n=document.getElementById("loading-screen");null==n||n.remove();var r=new rW.SaveReminder(V,!0,!0,function(){return e.saveAsPsd()},function(){return!!e&&e.isDrawing()},null,null);e=new r9(t,{saveReminder:r,projectStore:i}),r.init(),t&&setTimeout(function(){e.out(J("file-storage-restored"))},100),document.body.append(e.getEl()),window.klecks=e}(n,t),[3,6];case 5:return ae(o.sent()),[3,6];case 6:return[2]}})})).apply(this,arguments)}return R(this,function(e){switch(e.label){case 0:t=!1,e.label=1;case 1:return e.trys.push([1,3,,4]),window.addEventListener("DOMContentLoaded",function(){t=!0}),[4,Z.setLanguage(Q)];case 2:return e.sent(),[3,4];case 3:return ae(e.sent()),[2];case 4:return t?i():window.addEventListener("DOMContentLoaded",i),[2]}})})()}();
//# sourceMappingURL=index.72b01985.js.map
