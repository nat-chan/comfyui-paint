let t,e,i,s,r,a,n;var o,l,h,c,p,d,u="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};function g(t,e,i,s){Object.defineProperty(t,e,{get:i,set:s,enumerable:!0,configurable:!0})}function m(t){return t&&t.__esModule?t.default:t}var y={},f={},x=u.parcelRequire94c2;null==x&&((x=function(t){if(t in y)return y[t].exports;if(t in f){var e=f[t];delete f[t];var i={id:t,exports:{}};return y[t]=i,e.call(i.exports,i,i.exports),i.exports}var s=Error("Cannot find module '"+t+"'");throw s.code="MODULE_NOT_FOUND",s}).register=function(t,e){f[t]=e},u.parcelRequire94c2=x);var v=x.register;if(v("lytfz",function(t,e){t.exports=x("fKq5I")(x("kb8hZ").resolve("6OT74")).then(()=>x("11sRX"))}),v("fKq5I",function(t,e){var i=x("20Uq9");t.exports=i(function(t){return new Promise(function(e,i){var s="i".concat((""+Math.random()).slice(2));u[s]=function(t){e(t),r()};var r=function(){delete u[s],a.onerror=null,a.remove()},a=document.createElement("script");a.async=!0,a.type="module",a.charset="utf-8",a.textContent="import * as m from '".concat(t,"'; ").concat(s,"(m);"),a.onerror=function(t){i(t),r()},document.head.appendChild(a)})})}),v("20Uq9",function(t,e){var i={},s={},r={};t.exports=function(t,e){return function(a){var n=function(t){switch(t){case"preload":return s;case"prefetch":return r;default:return i}}(e);return n[a]?n[a]:n[a]=t.apply(null,arguments).catch(function(t){throw delete n[a],t})}}}),v("1JS1i",function(t,e){t.exports=x("fKq5I")(x("kb8hZ").resolve("i8WN1")).then(()=>x("aZ0Sx"))}),v("9KmPU",function(t,e){t.exports=x("fKq5I")(x("kb8hZ").resolve("hUIiR")).then(()=>x("2BQEx"))}),v("1Rdf4",function(t,e){t.exports=x("fKq5I")(x("kb8hZ").resolve("klZAl")).then(()=>x("68m8f"))}),v("lb7jn",function(t,e){t.exports=x("fKq5I")(x("kb8hZ").resolve("i3Nr5")).then(()=>x("5ukhf"))}),v("hpkwJ",function(t,e){t.exports=x("fKq5I")(x("kb8hZ").resolve("eiNJp")).then(()=>x("2C9ch"))}),v("cGAWy",function(t,e){t.exports=x("fKq5I")(x("kb8hZ").resolve("b1997")).then(()=>x("aGeQD"))}),v("6KItP",function(t,e){Object.defineProperty(t.exports,"__esModule",{value:!0});var i=x("1erBK");x("brs90"),x("7YdyD"),x("42Upt");var s=i.default({key:"css"}),r=s.flush,a=s.hydrate,n=s.cx,o=s.merge,l=s.getRegisteredStyles,h=s.injectGlobal,c=s.keyframes,p=s.css,d=s.sheet,u=s.cache;t.exports.cache=u,t.exports.css=p,t.exports.cx=n,t.exports.flush=r,t.exports.getRegisteredStyles=l,t.exports.hydrate=a,t.exports.injectGlobal=h,t.exports.keyframes=c,t.exports.merge=o,t.exports.sheet=d}),v("1erBK",function(t,e){Object.defineProperty(t.exports,"__esModule",{value:!0});var i=x("brs90"),s=x("7YdyD"),r=x("42Upt"),a=i&&i.__esModule?i:{default:i};function n(t,e){if(void 0===t.inserted[e.name])return t.insert("",e,t.sheet,!0)}function o(t,e,i){var s=[],a=r.getRegisteredStyles(t,s,i);return s.length<2?i:a+e(s)}var l=function t(e){for(var i="",s=0;s<e.length;s++){var r=e[s];if(null!=r){var a=void 0;switch(typeof r){case"boolean":break;case"object":if(Array.isArray(r))a=t(r);else for(var n in a="",r)r[n]&&n&&(a&&(a+=" "),a+=n);break;default:a=r}a&&(i&&(i+=" "),i+=a)}}return i};t.exports.default=function(t){var e=a.default(t);e.sheet.speedy=function(t){this.isSpeedy=t},e.compat=!0;var i=function(){for(var t=arguments.length,i=Array(t),a=0;a<t;a++)i[a]=arguments[a];var n=s.serializeStyles(i,e.registered,void 0);return r.insertStyles(e,n,!1),e.key+"-"+n.name};return{css:i,cx:function(){for(var t=arguments.length,s=Array(t),r=0;r<t;r++)s[r]=arguments[r];return o(e.registered,i,l(s))},injectGlobal:function(){for(var t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];var a=s.serializeStyles(i,e.registered);n(e,a)},keyframes:function(){for(var t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];var a=s.serializeStyles(i,e.registered),o="animation-"+a.name;return n(e,{name:a.name,styles:"@keyframes "+o+"{"+a.styles+"}"}),o},hydrate:function(t){t.forEach(function(t){e.inserted[t]=!0})},flush:function(){e.registered={},e.inserted={},e.sheet.flush()},sheet:e.sheet,cache:e,getRegisteredStyles:r.getRegisteredStyles.bind(null,e.registered),merge:o.bind(null,e.registered,i)}}}),v("brs90",function(t,e){Object.defineProperty(t.exports,"__esModule",{value:!0,configurable:!0}),g(t.exports,"default",function(){return c});var i=x("n9S4x"),s=x("fOtsb");x("irnze"),x("tBGmN");var r=function(t,e,i){for(var r=0,a=0;r=a,a=(0,s.peek)(),38===r&&12===a&&(e[i]=1),!(0,s.token)(a);)(0,s.next)();return(0,s.slice)(t,s.position)},a=function(t,e){var i=-1,a=44;do switch((0,s.token)(a)){case 0:38===a&&12===(0,s.peek)()&&(e[i]=1),t[i]+=r(s.position-1,e,i);break;case 2:t[i]+=(0,s.delimit)(a);break;case 4:if(44===a){t[++i]=58===(0,s.peek)()?"&\f":"",e[i]=t[i].length;break}default:t[i]+=(0,s.from)(a)}while(a=(0,s.next)())return t},n=new WeakMap,o=function(t){if("rule"===t.type&&t.parent&&!(t.length<1)){for(var e=t.value,i=t.parent,r=t.column===i.column&&t.line===i.line;"rule"!==i.type;)if(!(i=i.parent))return;if((1!==t.props.length||58===e.charCodeAt(0)||n.get(i))&&!r){n.set(t,!0);for(var o=[],l=(0,s.dealloc)(a((0,s.alloc)(e),o)),h=i.props,c=0,p=0;c<l.length;c++)for(var d=0;d<h.length;d++,p++)t.props[p]=o[c]?l[c].replace(/&\f/g,h[d]):h[d]+" "+l[c]}}},l=function(t){if("decl"===t.type){var e=t.value;108===e.charCodeAt(0)&&98===e.charCodeAt(2)&&(t.return="",t.value="")}},h=[function(t,e,i,r){if(t.length>-1&&!t.return)switch(t.type){case s.DECLARATION:t.return=function t(e,i){switch((0,s.hash)(e,i)){case 5103:return s.WEBKIT+"print-"+e+e;case 5737:case 4201:case 3177:case 3433:case 1641:case 4457:case 2921:case 5572:case 6356:case 5844:case 3191:case 6645:case 3005:case 6391:case 5879:case 5623:case 6135:case 4599:case 4855:case 4215:case 6389:case 5109:case 5365:case 5621:case 3829:return s.WEBKIT+e+e;case 5349:case 4246:case 4810:case 6968:case 2756:return s.WEBKIT+e+s.MOZ+e+s.MS+e+e;case 6828:case 4268:return s.WEBKIT+e+s.MS+e+e;case 6165:return s.WEBKIT+e+s.MS+"flex-"+e+e;case 5187:return s.WEBKIT+e+(0,s.replace)(e,/(\w+).+(:[^]+)/,s.WEBKIT+"box-$1$2"+s.MS+"flex-$1$2")+e;case 5443:return s.WEBKIT+e+s.MS+"flex-item-"+(0,s.replace)(e,/flex-|-self/,"")+e;case 4675:return s.WEBKIT+e+s.MS+"flex-line-pack"+(0,s.replace)(e,/align-content|flex-|-self/,"")+e;case 5548:return s.WEBKIT+e+s.MS+(0,s.replace)(e,"shrink","negative")+e;case 5292:return s.WEBKIT+e+s.MS+(0,s.replace)(e,"basis","preferred-size")+e;case 6060:return s.WEBKIT+"box-"+(0,s.replace)(e,"-grow","")+s.WEBKIT+e+s.MS+(0,s.replace)(e,"grow","positive")+e;case 4554:return s.WEBKIT+(0,s.replace)(e,/([^-])(transform)/g,"$1"+s.WEBKIT+"$2")+e;case 6187:return(0,s.replace)((0,s.replace)((0,s.replace)(e,/(zoom-|grab)/,s.WEBKIT+"$1"),/(image-set)/,s.WEBKIT+"$1"),e,"")+e;case 5495:case 3959:return(0,s.replace)(e,/(image-set\([^]*)/,s.WEBKIT+"$1$`$1");case 4968:return(0,s.replace)((0,s.replace)(e,/(.+:)(flex-)?(.*)/,s.WEBKIT+"box-pack:$3"+s.MS+"flex-pack:$3"),/s.+-b[^;]+/,"justify")+s.WEBKIT+e+e;case 4095:case 3583:case 4068:case 2532:return(0,s.replace)(e,/(.+)-inline(.+)/,s.WEBKIT+"$1$2")+e;case 8116:case 7059:case 5753:case 5535:case 5445:case 5701:case 4933:case 4677:case 5533:case 5789:case 5021:case 4765:if((0,s.strlen)(e)-1-i>6)switch((0,s.charat)(e,i+1)){case 109:if(45!==(0,s.charat)(e,i+4))break;case 102:return(0,s.replace)(e,/(.+:)(.+)-([^]+)/,"$1"+s.WEBKIT+"$2-$3$1"+s.MOZ+(108==(0,s.charat)(e,i+3)?"$3":"$2-$3"))+e;case 115:return~(0,s.indexof)(e,"stretch")?t((0,s.replace)(e,"stretch","fill-available"),i)+e:e}break;case 4949:if(115!==(0,s.charat)(e,i+1))break;case 6444:switch((0,s.charat)(e,(0,s.strlen)(e)-3-(~(0,s.indexof)(e,"!important")&&10))){case 107:return(0,s.replace)(e,":",":"+s.WEBKIT)+e;case 101:return(0,s.replace)(e,/(.+:)([^;!]+)(;|!.+)?/,"$1"+s.WEBKIT+(45===(0,s.charat)(e,14)?"inline-":"")+"box$3$1"+s.WEBKIT+"$2$3$1"+s.MS+"$2box$3")+e}break;case 5936:switch((0,s.charat)(e,i+11)){case 114:return s.WEBKIT+e+s.MS+(0,s.replace)(e,/[svh]\w+-[tblr]{2}/,"tb")+e;case 108:return s.WEBKIT+e+s.MS+(0,s.replace)(e,/[svh]\w+-[tblr]{2}/,"tb-rl")+e;case 45:return s.WEBKIT+e+s.MS+(0,s.replace)(e,/[svh]\w+-[tblr]{2}/,"lr")+e}return s.WEBKIT+e+s.MS+e+e}return e}(t.value,t.length);break;case s.KEYFRAMES:return(0,s.serialize)([(0,s.copy)(t,{value:(0,s.replace)(t.value,"@","@"+s.WEBKIT)})],r);case s.RULESET:if(t.length)return(0,s.combine)(t.props,function(e){switch((0,s.match)(e,/(::plac\w+|:read-\w+)/)){case":read-only":case":read-write":return(0,s.serialize)([(0,s.copy)(t,{props:[(0,s.replace)(e,/:(read-\w+)/,":"+s.MOZ+"$1")]})],r);case"::placeholder":return(0,s.serialize)([(0,s.copy)(t,{props:[(0,s.replace)(e,/:(plac\w+)/,":"+s.WEBKIT+"input-$1")]}),(0,s.copy)(t,{props:[(0,s.replace)(e,/:(plac\w+)/,":"+s.MOZ+"$1")]}),(0,s.copy)(t,{props:[(0,s.replace)(e,/:(plac\w+)/,s.MS+"input-$1")]})],r)}return""})}}],c=function(t){var e,r,a,n=t.key;if("css"===n){var c=document.querySelectorAll("style[data-emotion]:not([data-s])");Array.prototype.forEach.call(c,function(t){-1!==t.getAttribute("data-emotion").indexOf(" ")&&(document.head.appendChild(t),t.setAttribute("data-s",""))})}var p=t.stylisPlugins||h,d={},u=[];e=t.container||document.head,Array.prototype.forEach.call(document.querySelectorAll('style[data-emotion^="'+n+' "]'),function(t){for(var e=t.getAttribute("data-emotion").split(" "),i=1;i<e.length;i++)d[e[i]]=!0;u.push(t)});var g=[s.stringify,(0,s.rulesheet)(function(t){a.insert(t)})],m=(0,s.middleware)([o,l].concat(p,g));r=function(t,e,i,r){var n;a=i,n=t?t+"{"+e.styles+"}":e.styles,(0,s.serialize)((0,s.compile)(n),m),r&&(y.inserted[e.name]=!0)};var y={key:n,sheet:new i.StyleSheet({key:n,container:e,nonce:t.nonce,speedy:t.speedy,prepend:t.prepend,insertionPoint:t.insertionPoint}),nonce:t.nonce,inserted:d,registered:{},insert:r};return y.sheet.hydrate(u),y}}),v("n9S4x",function(t,e){g(t.exports,"StyleSheet",function(){return i});var i=function(){function t(t){var e=this;this._insertTag=function(t){var i;i=0===e.tags.length?e.insertionPoint?e.insertionPoint.nextSibling:e.prepend?e.container.firstChild:e.before:e.tags[e.tags.length-1].nextSibling,e.container.insertBefore(t,i),e.tags.push(t)},this.isSpeedy=void 0===t.speedy||t.speedy,this.tags=[],this.ctr=0,this.nonce=t.nonce,this.key=t.key,this.container=t.container,this.prepend=t.prepend,this.insertionPoint=t.insertionPoint,this.before=null}var e=t.prototype;return e.hydrate=function(t){t.forEach(this._insertTag)},e.insert=function(t){if(this.ctr%(this.isSpeedy?65e3:1)==0){var e;this._insertTag(((e=document.createElement("style")).setAttribute("data-emotion",this.key),void 0!==this.nonce&&e.setAttribute("nonce",this.nonce),e.appendChild(document.createTextNode("")),e.setAttribute("data-s",""),e))}var i=this.tags[this.tags.length-1];if(this.isSpeedy){var s=function(t){if(t.sheet)return t.sheet;for(var e=0;e<document.styleSheets.length;e++)if(document.styleSheets[e].ownerNode===t)return document.styleSheets[e]}(i);try{s.insertRule(t,s.cssRules.length)}catch(t){}}else i.appendChild(document.createTextNode(t));this.ctr++},e.flush=function(){this.tags.forEach(function(t){return t.parentNode&&t.parentNode.removeChild(t)}),this.tags=[],this.ctr=0},t}()}),v("fOtsb",function(t,e){g(t.exports,"MS",function(){return i}),g(t.exports,"MOZ",function(){return s}),g(t.exports,"WEBKIT",function(){return r}),g(t.exports,"RULESET",function(){return n}),g(t.exports,"DECLARATION",function(){return o}),g(t.exports,"KEYFRAMES",function(){return l}),g(t.exports,"from",function(){return c}),g(t.exports,"hash",function(){return d}),g(t.exports,"charat",function(){return f}),g(t.exports,"match",function(){return u}),g(t.exports,"replace",function(){return m}),g(t.exports,"indexof",function(){return y}),g(t.exports,"strlen",function(){return v}),g(t.exports,"combine",function(){return w}),g(t.exports,"position",function(){return E}),g(t.exports,"copy",function(){return M}),g(t.exports,"next",function(){return L}),g(t.exports,"peek",function(){return R}),g(t.exports,"slice",function(){return P}),g(t.exports,"token",function(){return D}),g(t.exports,"alloc",function(){return B}),g(t.exports,"dealloc",function(){return O}),g(t.exports,"delimit",function(){return z}),g(t.exports,"compile",function(){return V}),g(t.exports,"serialize",function(){return F}),g(t.exports,"stringify",function(){return W}),g(t.exports,"middleware",function(){return U}),g(t.exports,"rulesheet",function(){return N});var i="-ms-",s="-moz-",r="-webkit-",a="comm",n="rule",o="decl",l="@keyframes",h=Math.abs,c=String.fromCharCode,p=Object.assign;function d(t,e){return 45^f(t,0)?(((e<<2^f(t,0))<<2^f(t,1))<<2^f(t,2))<<2^f(t,3):0}function u(t,e){return(t=e.exec(t))?t[0]:t}function m(t,e,i){return t.replace(e,i)}function y(t,e){return t.indexOf(e)}function f(t,e){return 0|t.charCodeAt(e)}function x(t,e,i){return t.slice(e,i)}function v(t){return t.length}function b(t,e){return e.push(t),t}function w(t,e){return t.map(e).join("")}var C=1,S=1,k=0,E=0,I=0,A="";function T(t,e,i,s,r,a,n){return{value:t,root:e,parent:i,type:s,props:r,children:a,line:C,column:S,length:n,return:""}}function M(t,e){return p(T("",null,null,"",null,null,0),t,{length:-t.length},e)}function L(){return I=E<k?f(A,E++):0,S++,10===I&&(S=1,C++),I}function R(){return f(A,E)}function P(t,e){return x(A,t,e)}function D(t){switch(t){case 0:case 9:case 10:case 13:case 32:return 5;case 33:case 43:case 44:case 47:case 62:case 64:case 126:case 59:case 123:case 125:return 4;case 58:return 3;case 34:case 39:case 40:case 91:return 2;case 41:case 93:return 1}return 0}function B(t){return C=S=1,k=v(A=t),E=0,[]}function O(t){return A="",t}function z(t){return P(E-1,function t(e){for(;L();)switch(I){case e:return E;case 34:case 39:34!==e&&39!==e&&t(I);break;case 40:41===e&&t(e);break;case 92:L()}return E}(91===t?t+2:40===t?t+1:t)).trim()}function V(t){return O(function t(e,i,s,r,n,o,l,h,p){for(var d,u=0,g=0,w=l,k=0,M=0,B=0,O=1,V=1,F=1,W=0,U="",N=n,_=o,Y=r,X=U;V;)switch(B=W,W=L()){case 40:if(108!=B&&58==f(X,w-1)){-1!=y(X+=m(z(W),"&","&\f"),"&\f")&&(F=-1);break}case 34:case 39:case 91:X+=z(W);break;case 9:case 10:case 13:case 32:X+=function(t){for(;I=R();)if(I<33)L();else break;return D(t)>2||D(I)>3?"":" "}(B);break;case 92:X+=function(t,e){for(;--e&&L()&&!(I<48)&&!(I>102)&&(!(I>57)||!(I<65))&&(!(I>70)||!(I<97)););return P(t,E+(e<6&&32==R()&&32==L()))}(E-1,7);continue;case 47:switch(R()){case 42:case 47:b(T(d=function(t,e){for(;L();)if(t+I===57)break;else if(t+I===84&&47===R())break;return"/*"+P(e,E-1)+"*"+c(47===t?t:L())}(L(),E),i,s,a,c(I),x(d,2,-2),0),p);break;default:X+="/"}break;case 123*O:h[u++]=v(X)*F;case 125*O:case 59:case 0:switch(W){case 0:case 125:V=0;case 59+g:-1==F&&(X=m(X,/\f/g,"")),M>0&&v(X)-w&&b(M>32?j(X+";",r,s,w-1):j(m(X," ","")+";",r,s,w-2),p);break;case 59:X+=";";default:if(b(Y=H(X,i,s,u,g,n,h,U,N=[],_=[],w),o),123===W){if(0===g)t(X,i,Y,Y,N,o,w,h,_);else switch(99===k&&110===f(X,3)?100:k){case 100:case 108:case 109:case 115:t(e,Y,Y,r&&b(H(e,Y,Y,0,0,n,h,U,n,N=[],w),_),n,_,w,h,r?N:_);break;default:t(X,Y,Y,Y,[""],_,0,h,_)}}}u=g=M=0,O=F=1,U=X="",w=l;break;case 58:w=1+v(X),M=B;default:if(O<1){if(123==W)--O;else if(125==W&&0==O++&&125==(I=E>0?f(A,--E):0,S--,10===I&&(S=1,C--),I))continue}switch(X+=c(W),W*O){case 38:F=g>0?1:(X+="\f",-1);break;case 44:h[u++]=(v(X)-1)*F,F=1;break;case 64:45===R()&&(X+=z(L())),k=R(),g=w=v(U=X+=function(t){for(;!D(R());)L();return P(t,E)}(E)),W++;break;case 45:45===B&&2==v(X)&&(O=0)}}return o}("",null,null,null,[""],t=B(t),0,[0],t))}function H(t,e,i,s,r,a,o,l,c,p,d){for(var u=r-1,g=0===r?a:[""],y=g.length,f=0,v=0,b=0;f<s;++f)for(var w=0,C=x(t,u+1,u=h(v=o[f])),S=t;w<y;++w)(S=(v>0?g[w]+" "+C:m(C,/&\f/g,g[w])).trim())&&(c[b++]=S);return T(t,e,i,0===r?n:l,c,p,d)}function j(t,e,i,s){return T(t,e,i,o,x(t,0,s),x(t,s+1,-1),s)}function F(t,e){for(var i="",s=t.length,r=0;r<s;r++)i+=e(t[r],r,t,e)||"";return i}function W(t,e,i,s){switch(t.type){case"@layer":if(t.children.length)break;case"@import":case o:return t.return=t.return||t.value;case a:return"";case l:return t.return=t.value+"{"+F(t.children,s)+"}";case n:t.value=t.props.join(",")}return v(i=F(t.children,s))?t.return=t.value+"{"+i+"}":""}function U(t){var e=t.length;return function(i,s,r,a){for(var n="",o=0;o<e;o++)n+=t[o](i,s,r,a)||"";return n}}function N(t){return function(e){!e.root&&(e=e.return)&&t(e)}}}),v("irnze",function(t,e){}),v("tBGmN",function(t,e){g(t.exports,"default",function(){return i});function i(t){var e=Object.create(null);return function(i){return void 0===e[i]&&(e[i]=t(i)),e[i]}}}),v("7YdyD",function(t,e){g(t.exports,"serializeStyles",function(){return m});var i,s=x("9Z4kD"),r=x("6mYn6"),a=x("tBGmN"),n=/[A-Z]|^ms/g,o=/_EMO_([^_]+?)_([^]*?)_EMO_/g,l=function(t){return 45===t.charCodeAt(1)},h=function(t){return null!=t&&"boolean"!=typeof t},c=(0,a.default)(function(t){return l(t)?t:t.replace(n,"-$&").toLowerCase()}),p=function(t,e){switch(t){case"animation":case"animationName":if("string"==typeof e)return e.replace(o,function(t,e,s){return i={name:e,styles:s,next:i},e})}return 1===r.default[t]||l(t)||"number"!=typeof e||0===e?e:e+"px"};function d(t,e,s){if(null==s)return"";if(void 0!==s.__emotion_styles)return s;switch(typeof s){case"boolean":return"";case"object":if(1===s.anim)return i={name:s.name,styles:s.styles,next:i},s.name;if(void 0!==s.styles){var r=s.next;if(void 0!==r)for(;void 0!==r;)i={name:r.name,styles:r.styles,next:i},r=r.next;return s.styles+";"}return function(t,e,i){var s="";if(Array.isArray(i))for(var r=0;r<i.length;r++)s+=d(t,e,i[r])+";";else for(var a in i){var n=i[a];if("object"!=typeof n)null!=e&&void 0!==e[n]?s+=a+"{"+e[n]+"}":h(n)&&(s+=c(a)+":"+p(a,n)+";");else if(Array.isArray(n)&&"string"==typeof n[0]&&(null==e||void 0===e[n[0]]))for(var o=0;o<n.length;o++)h(n[o])&&(s+=c(a)+":"+p(a,n[o])+";");else{var l=d(t,e,n);switch(a){case"animation":case"animationName":s+=c(a)+":"+l+";";break;default:s+=a+"{"+l+"}"}}}return s}(t,e,s);case"function":if(void 0!==t){var a=i,n=s(t);return i=a,d(t,e,n)}}if(null==e)return s;var o=e[s];return void 0!==o?o:s}var u=/label:\s*([^\s;\n{]+)\s*(;|$)/g,m=function(t,e,r){if(1===t.length&&"object"==typeof t[0]&&null!==t[0]&&void 0!==t[0].styles)return t[0];var a,n=!0,o="";i=void 0;var l=t[0];null==l||void 0===l.raw?(n=!1,o+=d(r,e,l)):o+=l[0];for(var h=1;h<t.length;h++)o+=d(r,e,t[h]),n&&(o+=l[h]);u.lastIndex=0;for(var c="";null!==(a=u.exec(o));)c+="-"+a[1];return{name:(0,s.default)(o)+c,styles:o,next:i}}}),v("9Z4kD",function(t,e){g(t.exports,"default",function(){return i});function i(t){for(var e,i=0,s=0,r=t.length;r>=4;++s,r-=4)e=(65535&(e=255&t.charCodeAt(s)|(255&t.charCodeAt(++s))<<8|(255&t.charCodeAt(++s))<<16|(255&t.charCodeAt(++s))<<24))*1540483477+((e>>>16)*59797<<16),e^=e>>>24,i=(65535&e)*1540483477+((e>>>16)*59797<<16)^(65535&i)*1540483477+((i>>>16)*59797<<16);switch(r){case 3:i^=(255&t.charCodeAt(s+2))<<16;case 2:i^=(255&t.charCodeAt(s+1))<<8;case 1:i^=255&t.charCodeAt(s),i=(65535&i)*1540483477+((i>>>16)*59797<<16)}return i^=i>>>13,(((i=(65535&i)*1540483477+((i>>>16)*59797<<16))^i>>>15)>>>0).toString(36)}}),v("6mYn6",function(t,e){g(t.exports,"default",function(){return i});var i={animationIterationCount:1,aspectRatio:1,borderImageOutset:1,borderImageSlice:1,borderImageWidth:1,boxFlex:1,boxFlexGroup:1,boxOrdinalGroup:1,columnCount:1,columns:1,flex:1,flexGrow:1,flexPositive:1,flexShrink:1,flexNegative:1,flexOrder:1,gridRow:1,gridRowEnd:1,gridRowSpan:1,gridRowStart:1,gridColumn:1,gridColumnEnd:1,gridColumnSpan:1,gridColumnStart:1,msGridRow:1,msGridRowSpan:1,msGridColumn:1,msGridColumnSpan:1,fontWeight:1,lineHeight:1,opacity:1,order:1,orphans:1,tabSize:1,widows:1,zIndex:1,zoom:1,WebkitLineClamp:1,fillOpacity:1,floodOpacity:1,stopOpacity:1,strokeDasharray:1,strokeDashoffset:1,strokeMiterlimit:1,strokeOpacity:1,strokeWidth:1}}),v("42Upt",function(t,e){function i(t,e,i){var s="";return i.split(" ").forEach(function(i){void 0!==t[i]?e.push(t[i]+";"):s+=i+" "}),s}g(t.exports,"getRegisteredStyles",function(){return i}),g(t.exports,"insertStyles",function(){return r});var s=function(t,e,i){var s=t.key+"-"+e.name;!1===i&&void 0===t.registered[s]&&(t.registered[s]=e.styles)},r=function(t,e,i){s(t,e,i);var r=t.key+"-"+e.name;if(void 0===t.inserted[e.name]){var a=e;do t.insert(e===a?"."+r:"",a,t.sheet,!0),a=a.next;while(void 0!==a)}}}),v("k6Jw8",function(t,e){t.exports=x("fKq5I")(x("kb8hZ").resolve("4tKUq")).then(()=>x("duojR"))}),v("cMiRD",function(t,e){t.exports=x("fKq5I")(x("kb8hZ").resolve("hn23i")).then(()=>x("2vgBY"))}),v("5goSP",function(t,e){t.exports=x("fKq5I")(x("kb8hZ").resolve("af9Ft")).then(()=>x("lbeJP"))}),!function(){function t(){var t=Array.prototype.slice.call(arguments),e=document.createDocumentFragment();t.forEach(function(t){var i=t instanceof Node;e.appendChild(i?t:document.createTextNode(String(t)))}),this.appendChild(e)}[Element.prototype,Document.prototype,DocumentFragment.prototype].forEach(function(e){e.hasOwnProperty("append")||Object.defineProperty(e,"append",{configurable:!0,enumerable:!0,writable:!0,value:t})})}(),!function(){function t(){var t=Array.prototype.slice.call(arguments),e=document.createDocumentFragment();t.forEach(function(t){var i=t instanceof Node;e.appendChild(i?t:document.createTextNode(String(t)))}),this.insertBefore(e,this.firstChild)}[Element.prototype,Document.prototype,DocumentFragment.prototype].forEach(function(e){e.hasOwnProperty("prepend")||Object.defineProperty(e,"prepend",{configurable:!0,enumerable:!0,writable:!0,value:t})})}(),String.prototype.padStart||(String.prototype.padStart=function(t,e){return t>>=0,e=String(e||" "),this.length>t?String(this):((t-=this.length)>e.length&&(e+=e.repeat(t/e.length)),e.slice(0,t)+String(this))}),Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(t){if(null==this)throw TypeError('"this" is null or not defined');var e=Object(this),i=e.length>>>0;if("function"!=typeof t)throw TypeError("predicate must be a function");for(var s=arguments[1],r=0;r<i;){var a=e[r];if(t.call(s,a,r,e))return r;r++}return -1}}),"scrollTo"in Element.prototype||Object.defineProperty(Element.prototype,"scrollTo",{value:function(t,e){this.scrollLeft=t,this.scrollTop=e}}),"scrollBy"in Element.prototype||Object.defineProperty(Element.prototype,"scrollBy",{value:function(t,e){this.scrollLeft+=t,this.scrollTop+=e}}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function t(...e){let i=isNaN(e[0])?1:Number(e[0]);return i?Array.prototype.reduce.call(this,function(e,s){return Array.isArray(s)?e.push.apply(e,t.call(s,i-1)):e.push(s),e},[]):Array.prototype.slice.call(this)},writable:!0}),String.prototype.replaceAll||Object.defineProperty(String.prototype,"replaceAll",{value:function(t,e){if("function"==typeof e)throw Error("replaceAll polyfill does not support replaceValue: function");return this.replace(RegExp(t,"g"),e)}}),Object.fromEntries||Object.defineProperty(Object,"fromEntries",{value(t){if(!t||!t[Symbol.iterator])throw Error("Object.fromEntries() requires a single iterable argument");let e={};return Object.keys(t).forEach(i=>{let[s,r]=t[i];e[s]=r}),e}}),!("localStorage"in window))try{window.localStorage={getItem:()=>null,setItem:()=>{},removeItem:()=>{}}}catch(t){}function b(t,e){let i;let s=Object.keys(e),r=t.style;for(let t=0;t<s.length;t++)r[i=s[t]]=e[i],"userSelect"===i&&(r.webkitUserSelect=e[i])}function w(t,e){return e?w(e,t%e):t}function C(t,e){let i=w(t,e);return[t/i,e/i]}function S(t){return JSON.parse(JSON.stringify(t))}function k(t){let e=document.createElementNS("http://www.w3.org/2000/svg",t.elementType);return Object.entries(t).forEach(([t,i])=>{"childrenArr"===t?i.forEach(t=>{e.append(k(t))}):"elementType"!==t&&e.setAttribute(t,i)}),e}function E(t){if(null===t)throw Error("value is null");return t}function I(t,e="value is undefined"){if(void 0===t)throw Error(e);return t}function A(t){return null===t?void 0:t}const T="matchMedia"in window&&window.matchMedia("(prefers-color-scheme: dark)");function M(){return T&&T.matches}function L(t){T&&"addEventListener"in T&&T.addEventListener("change",t)}let R=!1;class P{pause(){}addListener(){}push(){}undo(){return[]}redo(){}getAll(){return[]}canRedo(){return!1}canUndo(){return!1}getState(){return 0}getActionNumber(){return 0}}const D=new class{broadcast(t){setTimeout(()=>{for(let e=0;e<this.listeners.length;e++)this.listeners[e](t);this.state++},1)}pause(t){t?this.pauseStack++:this.pauseStack=Math.max(0,this.pauseStack-1)}addListener(t){this.listeners.push(t)}push(t){if(this.pauseStack>0)return;for(;this.actionNumber<this.entries.length-1;)this.entries.pop();let e=this.entries[this.entries.length-1];if(e&&"canvas"===t.tool[0]&&"canvas"===e.tool[0]&&"layerOpacity"===t.action&&"layerOpacity"===e.action&&e.params[0]===t.params[0]){this.entries[this.entries.length-1]=t,this.state++;return}if(e&&"canvas"===t.tool[0]&&"canvas"===e.tool[0]&&"setLayerIsVisible"===t.action&&"setLayerIsVisible"===e.action&&e.params[0]===t.params[0]&&e.params[1]!=t.params[1]){this.entries.pop(),this.actionNumber--,this.state++,this.broadcast(null);return}if("focusLayer"===t.action&&e&&"focusLayer"===e.action){this.entries[this.entries.length-1]=t,this.state++;return}this.entries[this.entries.length]=t,this.actionNumber=this.entries.length-1;let i=this.maxState;if(this.maxState=Math.max(this.maxState,this.actionNumber-this.max),i<this.maxState){let t=this.entries[this.maxState];if(!t)throw Error("this.dataArr[this.maxState] null");this.broadcast({bufferUpdate:t})}else this.broadcast(null);this.maxState>=0&&(this.entries[this.maxState]=null)}undo(){let t=[];if(!this.canUndo())return t;for(let e=this.maxState+1;e<this.actionNumber;e++)t.push(E(this.entries[e]));return this.actionNumber--,this.broadcast(null),t}redo(){if(this.canRedo())return this.actionNumber++,this.broadcast(null),E(this.entries[this.actionNumber])}getAll(){return[...this.entries]}canRedo(){return this.actionNumber<this.entries.length-1}canUndo(){return this.actionNumber>this.maxState}getState(){return this.state}getActionNumber(){return this.actionNumber+1}constructor(){if(this.max=20,R)throw Error("klHistory already instantiated");R=!0,this.state=0,this.entries=[],this.listeners=[],this.pauseStack=0,this.maxState=-1,this.actionNumber=-1}},B=new class{emit(){this.listeners.forEach(t=>{t(this.count)})}increase(t){void 0!==t?this.count+=t:this.count++,this.emit()}decrease(t){void 0!==t?this.count-=t:this.count--,this.emit()}get(){return this.count}subscribe(t){this.listeners.push(t)}constructor(){this.listeners=[],this.count=0}},O=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,z=function(){let t=new Event("").timeStamp<36e5;return function(){return t}}(),V=!!window.PointerEvent,H=function(){let t;function e(){let e=document.createElement("div");e.style.position="absolute",e.style.top="0",e.style.left="max(0px, 25px)",document.body.append(e),setTimeout(function(){t=25===e.offsetLeft,e.remove()},25)}return document.body?e():window.addEventListener("DOMContentLoaded",function(){e()}),function(){if(void 0===t)throw Error("isCssMinMaxSupported not initialized");return t}}(),j=(()=>{let t={space:[" ","Spacebar"],alt:["Alt","AltGraph"],shift:"Shift",ctrl:"Control",cmd:["Meta","MetaLeft","MetaRight"],enter:"Enter",esc:"Escape",backspace:"Backspace",delete:"Delete",sqbr_open:"[",sqbr_close:"]",a:["a","A"],b:["b","B"],c:["c","C"],e:["e","E"],f:["f","F"],g:["g","G"],r:["r","R"],s:["s","S"],t:["t","T"],u:["u","U"],x:["x","X"],y:["y","Y"],z:["z","Z"],plus:"+",minus:"-",left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown",home:"Home",end:"End"},e=Object.keys(t),i=Object.entries(t).reduce((t,[e])=>(t[e]=!1,t),{}),s=Object.entries(t).reduce((t,[e,i])=>("string"==typeof i?t[i]=e:i.forEach(i=>{t[i]=e}),t),{}),r=[],a={},n=[],o=function(t,e,i,s){n.forEach(r=>{r[0]&&r[0](t,e,i,s)})},l=function(t,e,i){n.forEach(s=>{s[1]&&s[1](t,e,i)})},h=function(){n.forEach(t=>{t[2]&&t[2]()})};function c(t){let e=t.key,n=t.code;if(e in s){let l=s[e];if(i[l]){o(l,t,r.join("+"),!0);return}i[l]=!0,a[n]=l,r.push(l),o(l,t,r.join("+"))}}function p(t){let e=t.code,s=r.join("+");if(["Meta","MetaLeft","MetaRight","OSLeft","OSRight"].includes(e)){d();return}let n=a[e];if(void 0!==n){i[n]=!1,a[e]=void 0;for(let t=0;t<r.length;t++)r[t]==n&&(r.splice(t,1),t--);l(n,t,s)}}function d(){let t=r.join("+");r=[],a={};let s=[];e.forEach(t=>{i[t]&&(i[t]=!1,s.push(t))});for(let e=0;e<s.length;e++)l(s[e],{preventDefault:function(){},stopPropagation:function(){}},t);h()}return{add:t=>{if(n.includes(t))return;let e=0===n.length;n.push(t),e&&(document.addEventListener("keydown",c),document.addEventListener("keyup",p),window.addEventListener("blur",d))},remove:t=>{if(!n.includes(t))return;let e=1===n.length;for(let e=0;e<n.length;e++)if(n[e]===t){n.splice(e,1);break}e&&(document.removeEventListener("keydown",c),document.removeEventListener("keyup",p),window.removeEventListener("blur",d))},getIsDown:()=>i,getCombo:()=>r}})();class F{emit(t){null!==this.position&&null!==this.sequenceUnit&&this.callback({deltaY:Math.round(t/this.sequenceUnit),pageX:this.position.pageX,pageY:this.position.pageY,clientX:this.position.clientX,clientY:this.position.clientY})}endSequence(){null!==this.toEmitDelta&&(this.emit(this.toEmitDelta),this.toEmitDelta=null),null===this.sequenceUnit||this.knownUnitArr.includes(this.sequenceUnit)||this.knownUnitArr.push(this.sequenceUnit),this.sequenceLength=0,this.sequenceUnit=null}process(t){this.position={pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY},this.endSequenceTimeout&&clearTimeout(this.endSequenceTimeout),this.endSequenceTimeout=setTimeout(()=>this.endSequence(),200);let e=t.deltaY;"deltaMode"in t&&1===t.deltaMode&&(e*=100/3);let i=Math.abs(e);if(0===this.sequenceLength){if(this.sequenceLength++,i<50)return;this.sequenceUnit=i,this.knownUnitArr.includes(this.sequenceUnit)?this.emit(e):this.toEmitDelta=e;return}if(null===this.sequenceUnit){this.toEmitDelta=null;return}if(0!==i){if(i===this.sequenceUnit||i/this.sequenceUnit%1<1e-4);else if(this.sequenceUnit/i%1<1e-4)this.sequenceUnit=i;else if(i!==this.sequenceUnit){this.sequenceUnit=null,this.toEmitDelta=null;return}null!==this.toEmitDelta&&(this.emit(this.toEmitDelta),this.toEmitDelta=null),this.emit(e)}}constructor(t){this.callback=t,this.knownUnitArr=[100],this.sequenceLength=0,this.sequenceUnit=null,this.toEmitDelta=null,this.position=null}}function W(t,e,i){return t*(1-i)+e*i}function U(t,e,i,s){return Math.sqrt(Math.pow(t-i,2)+Math.pow(e-s,2))}function N(t,e){return Math.atan2(e.y-t.y,e.x-t.x)}function _(t,e){return 180*N(t,e)/Math.PI}function Y(t,e,i){return t<e?e:t>i?i:t}function X(t,e,i){let s=Math.PI/180*i,r=Math.cos(s),a=Math.sin(s);return{x:t*r-e*a,y:t*a+e*r}}const G=[];function K(t){switch(t){case 1:return"left";case 2:return"right";case 4:return"middle";default:return}}const q=new class{normalize(t){return 0===t||1===t?t:(this.count<60?(0===this.count||null===this.count?this.avgPressure=t:this.avgPressure=W(t,this.avgPressure,.95),this.count++):!this.normalizeIsComplete&&(this.normalizeIsComplete=!0,this.avgPressure<.13&&(this.normalizeFactor=2.3)),Math.pow(t,1/this.normalizeFactor))}constructor(){this.count=0,this.avgPressure=0,this.normalizeIsComplete=!1,this.normalizeFactor=1}},$=z()?0:-performance.timing.navigationStart,Q=V?"pointerdown":"mousedown",Z=V?"pointermove":"mousemove",J=V?"pointerup":"mouseup",tt=V?"pointercancel":"mousecancel",te=V?"pointerleave":"mouseleave",ti=V?"pointerenter":"mouseenter";function ts(t){if("corrected"in t)return t.corrected;let e={pointerId:t.pointerId,pointerType:t.pointerType,pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY,movementX:t.movementX,movementY:t.movementY,timeStamp:t.timeStamp+$,pressure:q.normalize(t.pressure),buttons:void 0!==t.buttons?t.buttons:void 0!==t.button?[1,4,2,8,16][t.button]:0,button:t.button,coalescedArr:[],eventPreventDefault:()=>t.preventDefault(),eventStopPropagation:()=>t.stopPropagation()};t.corrected=e;let i=null;"pointerId"in t?"pressure"in t&&0!==t.buttons&&(["mouse"].includes(t.pointerType)||"touch"===t.pointerType&&0===t.pressure)&&(e.pressure=1,i=1):(e.pointerId=0,e.pointerType="mouse",e.pressure=0!==t.buttons?1:0,i=e.pressure),O&&"mouse"!=t.pointerType&&"pointermove"===t.type&&0===t.buttons&&(e.buttons=1);let s=[];"getCoalescedEvents"in t&&(s=t.getCoalescedEvents());let r=function(t){for(let e=G.length-1;e>=0;e--)if(t.pointerId===G[e].pointerId)return G[e];return null}(e)||function(t){let e={pointerId:t.pointerId,lastPageX:null,lastPageY:null};return G.push(e),G.length>15&&G.shift(),e}(e),a=r.lastPageX,n=r.lastPageY;for(let t=0;t<s.length;t++){let a=s[t];e.coalescedArr.push({pageX:a.pageX,pageY:a.pageY,clientX:a.clientX,clientY:a.clientY,movementX:null===r.lastPageX?0:a.pageX-r.lastPageX,movementY:null===r.lastPageY?0:a.pageY-r.lastPageY,timeStamp:0===a.timeStamp?e.timeStamp:a.timeStamp+$,pressure:null===i?q.normalize(a.pressure):i}),r.lastPageX=a.pageX,r.lastPageY=a.pageY}return r.lastPageX=e.pageX,r.lastPageY=e.pageY,e.movementX=null===a?0:r.lastPageX-a,e.movementY=null===n?0:r.lastPageY-n,e}class tr{getDragObj(t){for(let e=0;e<this.dragObjArr.length;e++)if(t===this.dragObjArr[e].pointerId)return this.dragObjArr[e];return null}removeDragObj(t){let e=null;for(let i=0;i<this.dragPointerIdArr.length;i++)this.dragPointerIdArr[i]===t&&(e=this.dragObjArr[i],this.dragObjArr.splice(i,1),this.dragPointerIdArr.splice(i,1),i--);return e}createPointerOutEvent(t,e,i){let s=this.targetElement.getBoundingClientRect(),r={type:t,pointerId:e.pointerId,pointerType:e.pointerType,pageX:e.pageX,pageY:e.pageY,clientX:e.clientX,clientY:e.clientY,relX:e.clientX-s.left+this.targetElement.scrollLeft,relY:e.clientY-s.top+this.targetElement.scrollTop,dX:e.movementX,dY:e.movementY,time:e.timeStamp,eventPreventDefault:e.eventPreventDefault,eventStopPropagation:e.eventStopPropagation,...i};if("pointermove"===t&&(r.coalescedArr=[],e.coalescedArr.length>1)){let t;for(let i=0;i<e.coalescedArr.length;i++)t=e.coalescedArr[i],r.coalescedArr.push({pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY,relX:t.clientX-s.left+this.targetElement.scrollLeft,relY:t.clientY-s.top+this.targetElement.scrollTop,dX:t.movementX,dY:t.movementY,time:t.timeStamp})}return r}setupDocumentListeners(){this.windowOnPointerMove&&document.addEventListener(Z,this.windowOnPointerMove),this.windowOnPointerUp&&document.addEventListener(J,this.windowOnPointerUp),this.windowOnPointerLeave&&document.addEventListener(tt,this.windowOnPointerLeave),this.windowOnPointerLeave&&document.addEventListener(te,this.windowOnPointerLeave)}destroyDocumentListeners(){this.windowOnPointerMove&&document.removeEventListener(Z,this.windowOnPointerMove),this.windowOnPointerUp&&document.removeEventListener(J,this.windowOnPointerUp),this.windowOnPointerLeave&&document.removeEventListener(tt,this.windowOnPointerLeave),this.windowOnPointerLeave&&document.removeEventListener(te,this.windowOnPointerLeave)}destroy(){!this.isDestroyed&&(this.isDestroyed=!0,this.onPointerEnter&&this.targetElement.removeEventListener(ti,this.onPointerEnter),this.onPointerLeave&&this.targetElement.removeEventListener(te,this.onPointerLeave),this.onPointerMove&&this.targetElement.removeEventListener(Z,this.onPointerMove),this.onPointerDown&&this.targetElement.removeEventListener(Q,this.onPointerDown),this.onWheel&&this.targetElement.removeEventListener("wheel",this.onWheel),this.destroyDocumentListeners(),this.onTouchMoveScribbleFix&&document.removeEventListener("touchmove",this.onTouchMoveScribbleFix),this.onTouchStart&&this.targetElement.removeEventListener("touchstart",this.onTouchStart),this.onTouchMove&&this.targetElement.removeEventListener("touchmove",this.onTouchMove),this.onTouchEnd&&this.targetElement.removeEventListener("touchend",this.onTouchEnd),this.onTouchCancel&&this.targetElement.removeEventListener("touchcancel",this.onTouchCancel))}constructor(t){if(this.isDestroyed=!1,this.isOverCounter=0,this.dragObjArr=[],this.dragPointerIdArr=[],this.lastPointerType=null,this.didSkip=!1,this.targetElement=t.target,this.onPointerCallback=t.onPointer,this.onWheelCallback=t.onWheel,this.onEnterLeaveCallback=t.onEnterLeave,this.maxPointers=Math.max(1,t.maxPointers||1),this.wheelCleaner=new F(t=>{if(this.isDestroyed||!this.onWheelCallback)return;let e=this.targetElement.getBoundingClientRect(),i={...t,relX:t.clientX-e.left+this.targetElement.scrollLeft,relY:t.clientY-e.top+this.targetElement.scrollTop};this.onWheelCallback(i)}),this.onPointerCallback&&(this.onPointerMove=t=>{let e=ts(t),i=this.lastPointerType;if(this.lastPointerType=e.pointerType,this.dragPointerIdArr.includes(e.pointerId)||this.dragPointerIdArr.length===this.maxPointers||"touch"===e.pointerType){this.didSkip=!1;return}if(!this.didSkip&&"mouse"===e.pointerType&&"pen"===i){this.didSkip=!0;return}this.didSkip=!1;let s=this.createPointerOutEvent("pointermove",e);this.onPointerCallback&&this.onPointerCallback(s)},this.onPointerDown=(t,e)=>{let i=ts(t);if(this.dragPointerIdArr.includes(i.pointerId)||this.dragPointerIdArr.length===this.maxPointers||![1,2,4].includes(i.buttons))return;0!==this.dragObjArr.length||e||this.setupDocumentListeners();let s={pointerId:i.pointerId,pointerType:i.pointerType,downPageX:i.pageX,downPageY:i.pageY,buttons:i.buttons,lastPageX:i.pageX,lastPageY:i.pageY,lastTimeStamp:i.timeStamp};this.dragObjArr.push(s),this.dragPointerIdArr.push(i.pointerId);let r=this.createPointerOutEvent("pointerdown",i,{downPageX:i.pageX,downPageY:i.pageY,button:K(i.buttons),pressure:i.pressure});this.onPointerCallback&&this.onPointerCallback(r)},this.windowOnPointerMove=t=>{let e=ts(t);if(!this.dragPointerIdArr.includes(e.pointerId))return;let i=this.getDragObj(e.pointerId);if(!i)return;if(e.buttons!==i.buttons){1===this.dragObjArr.length&&this.destroyDocumentListeners(),this.removeDragObj(e.pointerId);let t=this.createPointerOutEvent("pointerup",e,{downPageX:i.downPageX,downPageY:i.downPageY});this.onPointerCallback&&this.onPointerCallback(t);return}if("pen"===e.pointerType&&e.pageX===i.lastPageX&&e.pageY===i.lastPageY&&e.timeStamp===i.lastTimeStamp)return;let s=this.createPointerOutEvent("pointermove",e,{downPageX:i.downPageX,downPageY:i.downPageY,button:K(e.buttons),pressure:e.pressure});i.lastPageX=e.pageX,i.lastPageY=e.pageY,i.lastTimeStamp=e.timeStamp,this.onPointerCallback&&this.onPointerCallback(s)},this.windowOnPointerUp=t=>{let e=ts(t);if(!this.dragPointerIdArr.includes(e.pointerId))return;1===this.dragObjArr.length&&this.destroyDocumentListeners();let i=this.removeDragObj(e.pointerId);if(!i)return;let s=this.createPointerOutEvent("pointerup",e,{downPageX:i.downPageX,downPageY:i.downPageY});this.onPointerCallback&&this.onPointerCallback(s)},this.windowOnPointerLeave=t=>{let e=ts(t);if(!this.dragPointerIdArr.includes(e.pointerId))return;1===this.dragObjArr.length&&this.destroyDocumentListeners();let i=this.removeDragObj(e.pointerId);if(!i)return;let s=this.createPointerOutEvent("pointerup",e,{downPageX:i.downPageX,downPageY:i.downPageY});this.onPointerCallback&&this.onPointerCallback(s)},this.targetElement.addEventListener(Z,this.onPointerMove),this.targetElement.addEventListener(Q,this.onPointerDown),!V)){let t=(t,e,i)=>({pointerId:t.identifier,pointerType:"touch",pageX:t.pageX,pageY:t.pageY,clientX:t.clientX,clientY:t.clientY,button:i?0:void 0,buttons:i?1:0,timeStamp:e.timeStamp,target:e.target,pressure:i?1:0,preventDefault:()=>e.preventDefault(),stopPropagation:()=>e.stopPropagation()}),e=(e,i)=>{for(let s=0;s<e.changedTouches.length;s++){let r=t(e.changedTouches[s],e,["start","move"].includes(i));"start"===i?this.onPointerDown(r,!1):"move"===i?this.windowOnPointerMove(r):"end"===i?this.windowOnPointerUp(r):this.windowOnPointerLeave(r)}};this.onTouchStart=t=>{t.preventDefault(),e(t,"start")},this.onTouchMove=t=>{e(t,"move")},this.onTouchEnd=t=>{e(t,"end")},this.onTouchCancel=t=>{e(t,"cancel")},this.targetElement.addEventListener("touchstart",this.onTouchStart),this.targetElement.addEventListener("touchmove",this.onTouchMove),this.targetElement.addEventListener("touchend",this.onTouchEnd),this.targetElement.addEventListener("touchcancel",this.onTouchCancel)}this.onWheelCallback&&(this.onWheel=t=>{this.wheelCleaner.process(t)},this.targetElement.addEventListener("wheel",this.onWheel)),this.onEnterLeaveCallback&&(this.onPointerEnter=()=>{this.isOverCounter++,this.onEnterLeaveCallback&&this.onEnterLeaveCallback(!0)},this.onPointerLeave=()=>{this.isOverCounter--,this.onEnterLeaveCallback&&this.onEnterLeaveCallback(!1)},this.targetElement.addEventListener(ti,this.onPointerEnter),this.targetElement.addEventListener(te,this.onPointerLeave)),t.fixScribble&&(this.onTouchMoveScribbleFix=t=>t.preventDefault(),this.targetElement.addEventListener("touchmove",this.onTouchMoveScribbleFix))}}function ta(t,e){let i=document.createElement("canvas");return t&&e&&(i.width=t,i.height=e),i}const tn=function(t,e){let i;let s=ta();if(t<1){if(s.width=1,s.height=1,!(i=s.getContext("2d")))throw Error("2d context not supported or canvas already initialized");i.fillStyle="rgb(128, 128, 128)",i.fillRect(0,0,1,1)}else if(t>200)s.width=401,s.height=401;else{if(s.width=2*t,s.height=2*t,!(i=s.getContext("2d")))throw Error("2d context not supported or canvas already initialized");i.fillStyle=e?"rgb(90, 90, 90)":"rgb(255, 255, 255)",i.fillRect(0,0,2*t,2*t),i.fillStyle=e?"rgb(63, 63, 63)":"rgb(200, 200, 200)",i.fillRect(0,0,t,t),i.fillRect(t,t,2*t,2*t)}return s},to=function(){let t={"8l":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMElEQVQ4T2M8ceLEfwY8wNzcHJ80A+OoAcMiDP7//483HZw8eRJ/Ohg1gIFx6IcBAIhJUqnarXQ1AAAAAElFTkSuQmCC","4l":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAJ0lEQVQoU2M8ceLEfwYkYG5ujsxlYKSDgv///6O44eTJk6huoL0CAGsOKVVu8UYvAAAAAElFTkSuQmCC"};return function(e,i,s){let r=s?"d":"l";function a(e){if(t[""+(e=parseInt(""+e))+r])return t[""+e+r];let i=tn(e,s).toDataURL("image/png");return t[""+e+r]=i,i}if(!i)return a(e);setTimeout(function(){i(a(e))},1)}}();function tl(t,e){return[e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15]]}const th=Object.freeze({getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},multiplyMatrixAndPoint:tl,multiplyMatrices:function(t,e){let i=[e[0],e[1],e[2],e[3]],s=[e[4],e[5],e[6],e[7]],r=[e[8],e[9],e[10],e[11]],a=[e[12],e[13],e[14],e[15]],n=tl(t,i),o=tl(t,s),l=tl(t,r),h=tl(t,a);return[n[0],n[1],n[2],n[3],o[0],o[1],o[2],o[3],l[0],l[1],l[2],l[3],h[0],h[1],h[2],h[3]]},createTranslationMatrix:function(t,e){return[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1]},createRotationMatrix:function(t){return[Math.cos(-t),-Math.sin(-t),0,0,Math.sin(-t),Math.cos(-t),0,0,0,0,1,0,0,0,0,1]},createScaleMatrix:function(t){return[t,0,0,0,0,t,0,0,0,0,1,0,0,0,0,1]}}),tc={add:function(t,e){return{x:t.x+e.x,y:t.y+e.y}},sub:function(t,e){return{x:t.x-e.x,y:t.y-e.y}},nor:function(t){let e=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2));return{x:t.x/e,y:t.y/e}},len:function(t){return Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2))},dist:function(t,e){return tc.len(tc.sub(t,e))},mul:function(t,e){return{x:t.x*e,y:t.y*e}},angle:function(t,e){return Math.atan2(e.y-t.y,e.x-t.x)},dot:function(t,e){let i=[t.x,t.y],s=[e.x,e.y];return i.map((t,e)=>i[e]*s[e]).reduce((t,e)=>t+e)}};class tp{getAtDist(t){let e=Math.min(this.getLength(),t),i=0;for(;e>this.segmentArr[i].length&&i<this.segmentArr.length-2;i++)e-=this.segmentArr[i].length;let s=Math.min(1,Math.max(0,e/this.segmentArr[i].length));return{x:this.segmentArr[i].x*(1-s)+this.segmentArr[i+1].x*s,y:this.segmentArr[i].y*(1-s)+this.segmentArr[i+1].y*s}}getLength(){let t=0;for(let e=0;e<this.segmentArr.length-1;e++)t+=this.segmentArr[e].length;return t}constructor(t){this.segmentArr=[];for(let e=0;e<t.points.length;e++)(e=>{let i=0;e<t.points.length-1&&(i=U(t.points[e].x,t.points[e].y,t.points[e+1].x,t.points[e+1].y)),this.segmentArr[e]={x:t.points[e].x,y:t.points[e].y,length:i}})(e)}}class td{constructor(t,e,i){this.h=Math.max(0,Math.min(360,t)),this.s=Math.max(.001,Math.min(100,e)),this.v=Math.max(0,Math.min(100,i))}}class tu{constructor(t,e,i){this.r=Math.max(0,Math.min(255,t)),this.g=Math.max(0,Math.min(255,e)),this.b=Math.max(0,Math.min(255,i))}}class tg{constructor(t,e,i,s){this.c=Math.max(0,Math.min(100,t)),this.m=Math.max(0,Math.min(100,e)),this.y=Math.max(0,Math.min(100,i)),this.k=Math.max(0,Math.min(100,s))}}const tm={_RGBtoHSV:function(t){let e=new td(0,0,0),i=t.r/255,s=t.g/255,r=t.b/255,a=Math.min(i,s,r),n=Math.max(i,s,r),o=n-a;if(e.v=n,0==o)e.h=0,e.s=0;else{e.s=o/n;let t=((n-i)/6+o/2)/o,a=((n-s)/6+o/2)/o,l=((n-r)/6+o/2)/o;i==n?e.h=l-a:s==n?e.h=1/3+t-l:r==n&&(e.h=2/3+a-t),e.h<0&&(e.h+=1),e.h>1&&(e.h-=1)}return e.h=Math.round(360*e.h),e.s=Math.round(100*e.s),e.v=Math.round(100*e.v),e},_HSVtoRGB:function(t){let e,i,s,r,a,n,o,l;let h=new tu(0,0,0),c=t.h/360%1,p=t.s/100,d=t.v/100;return 0==p?(h.r=255*d,h.g=255*d,h.b=255*d):(i=Math.floor(e=6*c),s=d*(1-p),r=d*(1-p*(e-i)),a=d*(1-p*(1-(e-i))),0==i?(n=d,o=a,l=s):1==i?(n=r,o=d,l=s):2==i?(n=s,o=d,l=a):3==i?(n=s,o=r,l=d):4==i?(n=a,o=s,l=d):(n=d,o=s,l=r),h.r=255*n,h.g=255*o,h.b=255*l,h.r=Math.round(h.r),h.g=Math.round(h.g),h.b=Math.round(h.b)),h},_CMYKtoRGB:function(t){let e=new tu(0,0,0),i=t.c/100,s=t.m/100,r=t.y/100,a=t.k/100;return e.r=1-Math.min(1,i*(1-a)+a),e.g=1-Math.min(1,s*(1-a)+a),e.b=1-Math.min(1,r*(1-a)+a),e.r=Math.round(255*e.r),e.g=Math.round(255*e.g),e.b=Math.round(255*e.b),e},_RGBtoCMYK:function(t){let e=new tg(0,0,0,0),i=t.r/255,s=t.g/255,r=t.b/255;return e.k=Math.min(1-i,1-s,1-r),e.c=(1-i-e.k)/(1-e.k),e.m=(1-s-e.k)/(1-e.k),e.y=(1-r-e.k)/(1-e.k),e.c=Math.round(100*e.c),e.m=Math.round(100*e.m),e.y=Math.round(100*e.y),e.k=Math.round(100*e.k),e},toRGB:function(t){if(t instanceof tu)return t;if(t instanceof td)return this._HSVtoRGB(t);if(t instanceof tg)return this._CMYKtoRGB(t);throw Error("unknown type")},toHSV:function(t){if(t instanceof td)return t;if(t instanceof tu)return this._RGBtoHSV(t);if(t instanceof tg)return this._RGBtoHSV(this._CMYKtoRGB(t));throw Error("unknown type")},toCMYK:function(t){if(t instanceof tg)return t;if(t instanceof tu)return this._RGBtoCMYK(t);if(t instanceof td)return this._RGBtoCMYK(this._HSVtoRGB(t));throw Error("unknown type")},toHexString:function(t){if(t instanceof tu||"r"in t&&"g"in t&&"b"in t){let e=parseInt(""+t.r).toString(16),i=parseInt(""+t.g).toString(16),s=parseInt(""+t.b).toString(16);return 1==e.length&&(e="0"+e),1==i.length&&(i="0"+i),1==s.length&&(s="0"+s),e+i+s}return"#000"},toRgbStr:function(t){return"rgb("+Math.round(t.r)+", "+Math.round(t.g)+", "+Math.round(t.b)+")"},toRgbaStr:function(t){return"rgba("+Math.round(t.r)+", "+Math.round(t.g)+", "+Math.round(t.b)+", "+t.a+")"},hexToRGB:function(t){t=(t=t.trim()).replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,e,i,s){return e+e+i+i+s+s});let e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?new tu(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)):void 0}};function ty(t=!1){var e;let i=!!document.activeElement&&["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName);return t?i:i&&!(null===(e=document.activeElement)||void 0===e?void 0:e.getAttribute("data-ignore-focus"))}const tf=function(){function t(t){t.preventDefault();let e=!1;if(t.relatedTarget)try{t.relatedTarget.focus(),e=!0}catch(t){console.error("failed to focus")}e||t.currentTarget.blur()}return function(e){e.setAttribute("tabindex","-1"),e.addEventListener("focus",t)}}(),tx=[];function tv(t){if(!t)return document.createElement("div");let e=document.createElement(t.tagName?t.tagName:"div");t.css&&b(e,t.css),t.content&&("string"==typeof t.content?e.innerHTML=t.content:Array.isArray(t.content)?tI.append(e,t.content):e.append(t.content)),t.textContent&&(e.textContent=t.textContent),t.className&&(e.className=t.className),t.id&&(e.id=t.id),t.parent&&t.parent.append(e),"title"in t&&void 0!==t.title&&(e.title=t.title);let i=[];if(void 0!==t.onClick&&(e.addEventListener("click",t.onClick),t.noRef||i.push(["click",t.onClick])),void 0!==t.onChange&&(e.addEventListener("change",t.onChange),t.noRef||i.push(["change",t.onChange])),i.length>0&&tx.push({el:e,listeners:i}),"custom"in t&&t.custom){let i=Object.keys(t.custom);for(let s=0;s<i.length;s++)e.setAttribute(i[s],t.custom[i[s]])}return e}class tb{static subscribe(t){tb.listeners.includes(t)||tb.listeners.push(t)}static unsubscribe(t){for(let e=0;e<tb.listeners.length;e++)if(t===tb.listeners[e]){tb.listeners.splice(e,1);return}}static emit(t){tb.listeners.forEach(e=>{e(t)})}constructor(){}}tb.listeners=[];class tw{static getItem(t){let e=null;try{e=localStorage.getItem(t)}catch(t){this.error=t}return e}static setItem(t,e){try{localStorage.setItem(t,e)}catch(t){this.error=t}}static removeItem(t){try{localStorage.removeItem(t)}catch(t){this.error=t}}static getError(){return this.error}}class tC{end(){this.gestureObj=null,this.eventQueueArr=[]}fail(t){if(this.gestureObj){if(this.timeoutObj.secondFingerTimeout&&clearTimeout(this.timeoutObj.secondFingerTimeout),!t)for(let t=0;t<this.eventQueueArr.length;t++)this.chainOut&&this.chainOut(this.eventQueueArr[t]);this.end()}}setupFailTimeout(t){let e=t-this.nowTime;return!(e<=0)&&(this.timeoutObj.secondFingerTimeout=setTimeout(()=>this.fail(),e),!0)}processEvent(t){if("pointerdown"===t.type)this.pointersDownIdArr.push(t.pointerId);else if("pointerup"===t.type){for(let e=0;e<this.pointersDownIdArr.length;e++)if(this.pointersDownIdArr[e]===t.pointerId){this.pointersDownIdArr.splice(e,1);break}}if(this.gestureObj||"touch"===t.pointerType&&("pointermove"!==t.type||!(this.pointersDownIdArr.length>0))&&!(this.pointersDownIdArr.length>1)&&"pointerup"!==t.type){if(this.nowTime=performance.now(),"pointerdown"===t.type){if(this.gestureObj){if("touch"===t.pointerType){this.gestureObj.touchPointerArr.push({pointerId:t.pointerId,relX:t.relX,relY:t.relY}),this.gestureObj.isInProgress?this.continuePinch(this.gestureObj,{type:"down",index:this.gestureObj.touchPointerArr.length-1}):(this.timeoutObj.secondFingerTimeout&&clearTimeout(this.timeoutObj.secondFingerTimeout),this.gestureObj.isInProgress=!0,this.beginPinch(this.gestureObj));return}this.gestureObj.isInProgress?this.gestureObj.otherPointerIdArr.push(t.pointerId):this.fail();return}this.gestureObj={touchPointerArr:[{pointerId:t.pointerId,relX:t.relX,relY:t.relY,downRelX:t.relX,downRelY:t.relY}],otherPointerIdArr:[],isInProgress:!1},this.setupFailTimeout(t.time+this.untilSecondFingerDurationMs)||this.fail();return}if(!this.gestureObj){this.fail();return}if("pointermove"===t.type&&"touch"===t.pointerType){let e=null,i=0;for(;i<this.gestureObj.touchPointerArr.length;i++)if(t.pointerId===this.gestureObj.touchPointerArr[i].pointerId){e=this.gestureObj.touchPointerArr[i];break}if(!e){this.fail();return}if(e.relX=t.relX,e.relY=t.relY,this.gestureObj.isInProgress)i<2&&this.continuePinch(this.gestureObj,{type:"move",index:i});else{if(!("downRelX"in e&&void 0!==e.downRelX)||!("downRelY"in e&&void 0!==e.downRelY)){this.fail();return}U(e.downRelX,e.downRelY,e.relX,e.relY)>this.firstFingerMaxDistancePx&&this.fail()}return}if("pointerup"===t.type){if("touch"===t.pointerType){let e=0;for(;e<this.gestureObj.touchPointerArr.length;e++)if(this.gestureObj.touchPointerArr[e].pointerId===t.pointerId){this.gestureObj.touchPointerArr.splice(e,1);break}this.gestureObj.touchPointerArr.length>0&&this.continuePinch(this.gestureObj,{type:"up",index:e})}else for(let e=0;e<this.gestureObj.otherPointerIdArr.length;e++)if(this.gestureObj.otherPointerIdArr[e]===t.pointerId){this.gestureObj.otherPointerIdArr.splice(e,1);break}if(0===this.gestureObj.touchPointerArr.length&&0===this.gestureObj.otherPointerIdArr.length){this.gestureObj.isInProgress?(this.end(),this.endPinch()):this.fail();return}}}}beginPinch(t){for(let e=0;e<t.touchPointerArr.length;e++){let i=t.touchPointerArr[e];this.pincherArr.push({pointerId:i.pointerId,relX:i.relX,relY:i.relY,downRelX:i.relX,downRelY:i.relY})}let e={type:"move",downRelX:0,downRelY:0,relX:0,relY:0,angleRad:0,scale:1};1===this.pincherArr.length?(e.relX=this.pincherArr[0].downRelX,e.relY=this.pincherArr[0].downRelY):(e.relX=.5*(this.pincherArr[0].downRelX+this.pincherArr[1].downRelX),e.relY=.5*(this.pincherArr[0].downRelY+this.pincherArr[1].downRelY)),e.downRelX=e.relX,e.downRelY=e.relY,this.onPinch(e)}continuePinch(t,e){if(!(e.index>1)){if("move"===e.type){let i;if(this.pincherArr[e.index].relX=t.touchPointerArr[e.index].relX,this.pincherArr[e.index].relY=t.touchPointerArr[e.index].relY,1===this.pincherArr.length)i={type:"move",downRelX:this.pincherArr[0].downRelX,downRelY:this.pincherArr[0].downRelY,relX:this.pincherArr[0].relX,relY:this.pincherArr[0].relY,angleRad:0,scale:1};else{let t=U(this.pincherArr[0].downRelX,this.pincherArr[0].downRelY,this.pincherArr[1].downRelX,this.pincherArr[1].downRelY),e=U(this.pincherArr[0].relX,this.pincherArr[0].relY,this.pincherArr[1].relX,this.pincherArr[1].relY),s=N({x:this.pincherArr[0].downRelX,y:this.pincherArr[0].downRelY},{x:this.pincherArr[1].downRelX,y:this.pincherArr[1].downRelY}),r=N({x:this.pincherArr[0].relX,y:this.pincherArr[0].relY},{x:this.pincherArr[1].relX,y:this.pincherArr[1].relY});i={type:"move",downRelX:.5*(this.pincherArr[0].downRelX+this.pincherArr[1].downRelX),downRelY:.5*(this.pincherArr[0].downRelY+this.pincherArr[1].downRelY),relX:.5*(this.pincherArr[0].relX+this.pincherArr[1].relX),relY:.5*(this.pincherArr[0].relY+this.pincherArr[1].relY),angleRad:r-s,scale:e/t}}this.onPinch(i)}else("down"===e.type||"up"===e.type)&&(this.endPinch(),this.beginPinch(t))}}endPinch(){this.pincherArr=[],this.onPinch({type:"end"})}chainIn(t){return(this.processEvent(t),this.gestureObj)?(this.gestureObj.isInProgress||this.eventQueueArr.push(t),null):t}setChainOut(t){this.chainOut=t}constructor(t){this.firstFingerMaxDistancePx=10,this.untilSecondFingerDurationMs=250,this.pointersDownIdArr=[],this.gestureObj=null,this.eventQueueArr=[],this.nowTime=performance.now(),this.timeoutObj={secondFingerTimeout:null},this.pincherArr=[],this.onPinch=t.onPinch}}class tS{success(){this.timeoutObj.fail=null,this.timeoutObj.success=null,this.eventQueueArr=[];let t=this.sequenceArr[this.sequenceArr.length-1];this.sequenceArr=[],"pageX"in t&&this.onDoubleTap({pageX:t.pageX,pageY:t.pageY,relX:t.relX,relY:t.relY})}setupTimeout(t,e,i,s){let r=i-this.nowTime;return(!(r<=0)||!!s)&&(this.timeoutObj[t]=setTimeout(e,Math.max(0,r)),!0)}processEvent(t){if("pointerdown"===t.type)this.pointersDownIdArr.push(t.pointerId);else if("pointerup"===t.type){for(let e=0;e<this.pointersDownIdArr.length;e++)if(this.pointersDownIdArr[e]===t.pointerId){this.pointersDownIdArr.splice(e,1);break}}if(!this.allowedPointerTypeArr.includes(t.pointerType)){this.gestureFailed();return}this.nowTime=performance.now();let e=this.sequenceArr.length>0?this.sequenceArr[this.sequenceArr.length-1]:null;if("pointerup"===t.type&&(this.lastUpTime=t.time),"pointerdown"===t.type){if(this.pointersDownIdArr.length>1||null!==this.timeoutObj.success||0===this.sequenceArr.length&&this.nowTime-this.lastUpTime<this.minSilenceBeforeDurationMs||t.button&&!this.allowedButtonArr.includes(t.button)||e&&"isDown"in e&&e.isDown||this.sequenceArr.length>2){this.gestureFailed();return}if(e&&"position"in e&&U(e.position[0],e.position[1],t.pageX,t.pageY)>this.maxInbetweenDistancePx&&(this.gestureFailed(),"time"in e&&this.nowTime-e.time<this.minSilenceBeforeDurationMs))return;if(this.sequenceArr.push({isDown:!0,time:this.nowTime,position:[t.pageX,t.pageY],pointerId:t.pointerId}),this.sequenceArr.length>1)this.timeoutObj.maxUntilSecondDown&&clearTimeout(this.timeoutObj.maxUntilSecondDown);else if(!this.setupTimeout("maxUntilSecondDown",()=>this.gestureFailed(),t.time+this.maxUntilSecondDownDurationMs)){this.gestureFailed();return}if(this.timeoutObj.fail&&clearTimeout(this.timeoutObj.fail),!this.setupTimeout("fail",()=>this.gestureFailed(),t.time+this.maxPressedDurationMs)){this.gestureFailed();return}}if(e&&"pointermove"===t.type&&"pointerId"in e&&e.pointerId===t.pointerId&&U(e.position[0],e.position[1],t.pageX,t.pageY)>this.maxPressedDistancePx){this.gestureFailed();return}if(e&&"pointerup"===t.type){if("pointerId"in e&&e.pointerId!==t.pointerId||"time"in e&&this.nowTime>=e.time+this.maxPressedDurationMs){this.gestureFailed();return}if(this.timeoutObj.fail&&clearTimeout(this.timeoutObj.fail),this.sequenceArr.length<3){if(!this.setupTimeout("fail",()=>this.gestureFailed(),t.time+this.maxUpToUpDurationMs)){this.gestureFailed();return}this.sequenceArr=[e,{isUp:!0,time:this.nowTime,position:[t.pageX,t.pageY]}];return}"time"in this.sequenceArr[1]&&this.nowTime<this.sequenceArr[1].time+this.maxUpToUpDurationMs?(this.sequenceArr.push({pageX:t.pageX,pageY:t.pageY,relX:t.relX,relY:t.relY}),this.setupTimeout("success",()=>this.success(),t.time+this.minSilenceAfterMs,!0)||this.gestureFailed()):this.gestureFailed()}}chainIn(t){return(this.processEvent(t),0===this.sequenceArr.length)?(this.gestureFailed(),t):(this.eventQueueArr.push(t),null)}setChainOut(t){this.chainOut=t}setAllowedPointerTypeArr(t){this.allowedPointerTypeArr=[...t]}setAllowedButtonArr(t){this.allowedButtonArr=[...t]}constructor(t){this.allowedPointerTypeArr=["touch","mouse","pen"],this.allowedButtonArr=["left"],this.minSilenceBeforeDurationMs=400,this.maxPressedDurationMs=300,this.maxPressedDistancePx=10,this.maxInbetweenDistancePx=19,this.maxUpToUpDurationMs=500,this.maxUntilSecondDownDurationMs=300,this.minSilenceAfterMs=250,this.sequenceArr=[],this.pointersDownIdArr=[],this.lastUpTime=0,this.nowTime=0,this.eventQueueArr=[],this.timeoutObj={fail:null,maxUntilSecondDown:null,success:null},this.onDoubleTap=t.onDoubleTap,t.isInstant&&(this.minSilenceBeforeDurationMs=0,this.minSilenceAfterMs=0),this.gestureFailed=()=>{if(0!==this.sequenceArr.length){if(this.timeoutObj.fail&&clearTimeout(this.timeoutObj.fail),this.timeoutObj.maxUntilSecondDown&&clearTimeout(this.timeoutObj.maxUntilSecondDown),this.timeoutObj.success&&clearTimeout(this.timeoutObj.success),this.timeoutObj.fail=null,this.timeoutObj.maxUntilSecondDown=null,this.timeoutObj.success=null,this.chainOut)for(let t=0;t<this.eventQueueArr.length;t++)this.chainOut(this.eventQueueArr[t]);this.eventQueueArr=[],this.sequenceArr=[]}}}}class tk{chainIn(t){if(this.ignorePointerIdArr.includes(t.pointerId)){if("pointerup"===t.type){for(let e=0;e<this.ignorePointerIdArr.length;e++)if(this.ignorePointerIdArr[e]===t.pointerId){this.ignorePointerIdArr.splice(e,1);break}}return null}return null===this.downPointerId?("pointerdown"===t.type&&(this.downPointerId=t.pointerId),t):t.pointerId!==this.downPointerId?("pointerdown"===t.type&&this.ignorePointerIdArr.push(t.pointerId),null):("pointerup"===t.type&&(this.downPointerId=null),t)}setChainOut(t){this.chainOut=t}constructor(){this.downPointerId=null,this.ignorePointerIdArr=[]}}class tE{continueChain(t,e){for(;t<this.chainArr.length;t++)if(null===(e=this.chainArr[t].chainIn(e)))return null;return this.chainOut&&this.chainOut(e),null}chainIn(t){return this.continueChain(0,t)}setChainOut(t){this.chainOut=t}constructor(t){this.chainArr=t.chainArr;for(let t=0;t<this.chainArr.length;t++)(t=>{this.chainArr[t].setChainOut(e=>{this.continueChain(t+1,e)})})(t)}}const tI={eventUsesHighResTimeStamp:z,hasPointerEvents:V,isCssMinMaxSupported:H,canShareFiles:function(){return"share"in navigator&&"canShare"in navigator},unsetEventHandler:function(t,...e){e.forEach(e=>{t[e]=null})},insertAfter:function(t,e){t.parentNode&&t.parentNode.insertBefore(e,t.nextSibling)},loadImage:function(t,e){let i=0;!function s(){if(1e3===i){alert("couldn't load");return}t.complete?(i++,e()):setTimeout(s,1)}()},css:b,setAttributes:function(t,e){let i;let s=Object.keys(e);for(let r=0;r<s.length;r++)i=s[r],t.setAttribute(i,e[i])},append:function(t,e){let i=document.createDocumentFragment();e.forEach(t=>t&&i.append(t)),t.append(i)},fitInto:function(t,e,i,s,r){let a=t*i,n=e*i;return a>i&&(n=i/a*n,a=i),n>s&&(a=s/n*a,n=s),r&&(a=Math.max(r,a),n=Math.max(r,n)),{width:a,height:n}},centerWithin:function(t,e,i,s){return{x:t/2-i/2,y:e/2-s/2}},getDate:function(){let t=new Date,e=t.getFullYear();return e+"_"+(t.getMonth()+1).toString().padStart(2,"0")+"_"+t.getDate().toString().padStart(2,"0")+"_"+(60*t.getHours()+t.getMinutes()).toString(36).padStart(3,"0")+"_"},gcd:w,reduce:C,decToFraction:function(t){let e=Math.pow(10,t.toString().length-2);return C(t*e,e)},imageBlobToUrl:function(t){if(!t)throw Error("blobObj is undefined or null");if(window.Blob&&t instanceof Blob)return URL.createObjectURL(t);if("Object"===t.constructor.name)return"data:"+t.type+";"+t.encoding+","+t.data;throw Error("unknown blob format")},dateDayDifference:function(t,e){return t=new Date(t),e=new Date(e),t.setHours(0,0,0,0),e.setHours(0,0,0,0),(e.getTime()-t.getTime())/864e5},copyObj:S,shareCanvas:function(t){let e="image/png",i=()=>alert("sharing not supported");t.canvas.toBlob(function(s){if(!s){i(),t.callback();return}try{let r=[new File([s],t.fileName,{type:e})];navigator.share({title:t.title,files:r}).then(()=>{}).catch(()=>{i()})}catch(t){i()}t.callback()},e)},handleClick:function(t){let e=t.target;return!!e&&(!!["A","LABEL","INPUT","SUMMARY"].includes(e.tagName)||!!e.allowClick||(t.preventDefault(),!1))},createSvg:k,BbLog:tb,LocalStorage:tw,throwIfNull:E,nullToUndefined:A,isDark:M,mix:W,dist:U,distSquared:function(t,e,i,s){return Math.pow(t-i,2)+Math.pow(e-s,2)},lenSquared:function(t,e){return t*t+e*e},pointsToAngleRad:N,pointsToAngleDeg:_,isInsideRect:function(t,e){return e.x<=t.x&&t.x<=e.x+e.width&&e.y<=t.y&&t.y<=e.y+e.height},clamp:Y,rotate:X,rotateAround:function(t,e,i){let s=X(e.x-t.x,e.y-t.y,i);return s.x+=t.x,s.y+=t.y,s},Matrix:th,Vec2:tc,intDxy:function(t,e,i){t.x+=e,t.y+=i;let s=Math.round(t.x),r=Math.round(t.y);return t.x-=s,t.y-=r,{dX:s,dY:r}},roundEven:function(t){if(t%1==0)return t%2==0?t:t+1;let e=Math.ceil(t),i=Math.floor(t);return e%2==0?e:i},roundUneven:function(t){if(t%1==0)return t%2==0?t+1:t;let e=Math.ceil(t),i=Math.floor(t);return e%2==1?e:i},round:function(t,e){let i=Math.pow(10,e);return Math.round(t*i)/i},updateBounds:function(t,e){if(!e&&!t)throw Error("at least one param needs to be defined");return e&&(t?(t.x1=Math.min(t.x1,e.x1),t.y1=Math.min(t.y1,e.y1),t.x2=Math.max(t.x2,e.x2),t.y2=Math.max(t.y2,e.y2)):t={x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2}),t},boundsInArea:function(t,e,i){if(!t)return;let s=Math.max(0,t.x1),r=Math.max(0,t.y1),a=Math.min(e-1,t.x2),n=Math.min(i-1,t.y2);if(!(s>a)&&!(r>n))return{x1:s,y1:r,x2:a,y2:n}},projectPointOnLine:function(t,e,i){let s;if(t.x===e.x)return{x:t.x,y:i.y};let r=(e.y-t.y)/(e.x-t.x),a=t.y-r*t.x;return{x:(r*i.y+i.x-r*a)/(r*r+1),y:(r*r*i.y+r*i.x+a)/(r*r+1)}},PointLine:tp,BezierLine:class{getBezierPoints(t,e,i,s,r){let a;let n=[];for(let o=0;o<=r;o++)a=o/r,n[n.length]={x:Math.pow(1-a,3)*t.x+3*Math.pow(1-a,2)*a*e.x+3*(1-a)*Math.pow(a,2)*i.x+Math.pow(a,3)*s.x,y:Math.pow(1-a,3)*t.y+3*Math.pow(1-a,2)*a*e.y+3*(1-a)*Math.pow(a,2)*i.y+Math.pow(a,3)*s.y};return n}add(t,e,i,s,r){let a;if(this.lastPoint&&t===this.lastPoint.x&&e===this.lastPoint.y)return;if(this.lastPoint={x:t,y:e},this.pointArr[this.pointArr.length]={x:t,y:e,spacing:i},1===this.pointArr.length){this.lastSpacing=i;return}if(2===this.pointArr.length){this.pointArr[0].dir=tc.nor(tc.sub(this.pointArr[1],this.pointArr[0])),this.lastDot=i,this.lastSpacing=i;return}{let t=this.pointArr[this.pointArr.length-1],e=this.pointArr[this.pointArr.length-2],i=this.pointArr[this.pointArr.length-3];e.dir=tc.nor(tc.sub(t,i)),(isNaN(e.dir.x)||isNaN(e.dir.y))&&(e.dir=S(i.dir))}let n=this.pointArr[this.pointArr.length-3],o=this.pointArr[this.pointArr.length-2],l=tc.add(n,tc.mul(n.dir,tc.dist(n,o)/4)),h=tc.sub(o,tc.mul(o.dir,tc.dist(n,o)/4)),c=(a=new tp(s?{points:this.getBezierPoints(n,l,h,o,20)}:{points:[n,o]})).getLength(),p=W(this.lastSpacing,i,Y(this.lastDot/c,0,1)),d=this.lastDot;for(;d<=c;d+=p){p=W(this.lastSpacing,i,Y(d/c,0,1));let t=a.getAtDist(d),e=this.lastCallbackPoint?_(this.lastCallbackPoint,t):void 0;s&&s({x:t.x,y:t.y,t:d/c,angle:e,dAngle:this.lastCallbackPoint?e-this.lastAngle:0}),this.lastCallbackPoint=t,this.lastAngle=e}s?this.lastDot=d-c:(this.lastDot=0,r&&r({p1:n,p2:l,p3:h,p4:o})),this.lastSpacing=i}addFinal(t,e,i){if(this.pointArr.length<2)return;let s=this.pointArr[this.pointArr.length-2],r=this.pointArr[this.pointArr.length-1],a=tc.add(r,tc.sub(r,s));this.add(a.x,a.y,t,e,i)}constructor(){this.lastDot=0,this.pointArr=[]}},SplineInterpolator:class{getFirstX(){return this.first}getLastX(){return this.last}interpolate(t){let e=this.ya.length,i=0,s=e-1;for(;s-i>1;){let e=s+i>>1;this.xa[e]>t?s=e:i=e}let r=this.xa[s]-this.xa[i],a=(this.xa[s]-t)/r,n=(t-this.xa[i])/r;return a*this.ya[i]+n*this.ya[s]+((a*a*a-a)*this.y2[i]+(n*n*n-n)*this.y2[s])*(r*r)/6}findX(t,e){let i,s;for(let r=0;r<=e;r++){let a=r/e,n=this.interpolate(a);if(void 0===i){i=a,s=Math.abs(n-t);continue}let o=Math.abs(n-t);if(o<s)i=a,s=o;else break}return i}constructor(t){let e;let i=t.length;for(this.xa=[],this.ya=[],this.u=[],this.y2=[],this.first=t[0][0],this.last=t[t.length-1][0],t.sort(function(t,e){return t[0]-e[0]}),e=0;e<i;e++)this.xa.push(t[e][0]),this.ya.push(t[e][1]);for(e=1,this.u[0]=0,this.y2[0]=0;e<i-1;++e){let t=this.xa[e+1]-this.xa[e-1],i=(this.xa[e]-this.xa[e-1])/t,s=i*this.y2[e-1]+2;this.y2[e]=(i-1)/s;let r=(this.ya[e+1]-this.ya[e])/(this.xa[e+1]-this.xa[e])-(this.ya[e]-this.ya[e-1])/(this.xa[e]-this.xa[e-1]);this.u[e]=(6*r/t-i*this.u[e-1])/s}for(this.y2[i-1]=0,e=i-2;e>=0;--e)this.y2[e]=this.y2[e]*this.y2[e+1]+this.u[e]}},quadraticSplineInput:function(t,e,i){function s(t,e){return Math.round(t*Math.pow(10,e))/Math.pow(10,e)}let r=[];for(let a=0;a<=1;a+=i)r.push([s(a,4),s(t+Math.pow(a,2)*(e-t),4)]);return r},canvas:ta,ctx:function(t,e){let i=t.getContext("2d",e);if(!i)throw Error("couldn't get 2d context");return i},copyCanvas:function(t){let e=ta(t.width,t.height),i=e.getContext("2d");if(!i)throw Error("2d context not supported or canvas already initialized");return i.drawImage(t,0,0),e},testShouldPixelate:function(t,e,i){if(![1,-1].includes(e)||![1,-1].includes(i)||t.width%1!=0||t.height%1!=0||Math.abs(t.angleDeg)%90!=0)return!1;let s=Math.abs(t.angleDeg-90)%180==0,r=s?t.height:t.width,a=s?t.width:t.height;return(Math.abs(r)%2==0&&t.x%1==0||Math.abs(r)%2==1&&t.x%1==.5)&&(Math.abs(a)%2==0&&t.y%1==0||Math.abs(a)%2==1&&t.y%1==.5)},drawTransformedImageWithBounds:function(t,e,i,s,r){s||(s={x:0,y:0,width:e.width,height:e.height}),t.save(),r?t.imageSmoothingEnabled=!1:(t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high"),t.translate(i.x,i.y),t.rotate(i.angleDeg/180*Math.PI),t.scale(i.width>0?1:-1,i.height>0?1:-1),t.drawImage(e,s.x,s.y,s.width,s.height,-Math.abs(i.width)/2,-Math.abs(i.height)/2,Math.abs(i.width),Math.abs(i.height)),t.restore()},drawTransformedImageOnCanvas:function(t,e,i){(i=S(i)).center||(i.center={x:e.width/2,y:e.height/2}),i.scale||(i.scale={x:1,y:1}),i.angleDegree||(i.angleDegree=0),i.translate||(i.translate={x:0,y:0});let s=t.getContext("2d");if(!s)throw Error("2d context not supported or canvas already initialized");s.save(),Math.abs(i.scale.x-1)>1e-6||Math.abs(i.scale.y-1)>1e-6||Math.abs(i.angleDegree%90)>1e-6?(s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high"):s.imageSmoothingEnabled=!1,s.translate(i.translate.x,i.translate.y),s.translate(i.center.x,i.center.y),s.rotate(i.angleDegree/180*Math.PI),s.scale(i.scale.x,i.scale.y),s.translate(-i.center.x,-i.center.y),s.drawImage(e,0,0,e.width,e.height),s.restore()},createCheckerCanvas:tn,createCheckerDataUrl:to,resizeCanvas:function t(e,i,s,r,a){if(i&&s&&(i!==e.width||s!==e.height)){if(i=Math.max(i,1),s=Math.max(s,1),i<=e.width&&s<=e.height){let t,n;r=r||ta(),a=a||ta();let o=function(t,e,i,s){let r={oldWidthEx:Math.round(Math.log2(t)),oldHeightEx:Math.round(Math.log2(e)),newWidthEx:Math.ceil(Math.log2(i)),newHeightEx:Math.ceil(Math.log2(s))};return r.oldWidthEx=Math.max(r.oldWidthEx,r.newWidthEx),r.oldHeightEx=Math.max(r.oldHeightEx,r.newHeightEx),r}(e.width,e.height,i,s);a.width=o.oldWidthEx>o.newWidthEx?Math.pow(2,o.oldWidthEx):i,a.height=o.oldHeightEx>o.newHeightEx?Math.pow(2,o.oldHeightEx):s,r.getContext("2d").save(),a.getContext("2d").save();let l=r,h=a;t=o.oldWidthEx,n=o.oldHeightEx;let c=h.getContext("2d");c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.globalCompositeOperation="copy",c.drawImage(e,0,0,h.width,h.height);let p=h.width,d=h.height;for(;t>o.newWidthEx||n>o.newHeightEx;t--,n--){(c=l.getContext("2d")).imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.globalCompositeOperation="copy";let e=t>o.newWidthEx?p/2:p,i=n>o.newHeightEx?d/2:d;l.width=e,l.height=i,c.drawImage(h,0,0,p,d,0,0,e,i),p=e,d=i;let s=l;l=h,h=s}e.width=i,e.height=s;let u=e.getContext("2d");u.save(),u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(h,0,0,p,d,0,0,i,s),u.restore(),r.getContext("2d").restore(),a.getContext("2d").restore()}else if(i>=e.width&&s>=e.height){(r=r||ta()).width=i,r.height=s;let t=r.getContext("2d");t.save(),t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="high",t.drawImage(e,0,0,i,s),t.restore(),e.width=i,e.height=s,e.getContext("2d").drawImage(r,0,0)}else t(e,i,e.height,r,a),t(e,i,s,r,a)}},convertToAlphaChannelCanvas:function(t){let e=t.getContext("2d").getImageData(0,0,t.width,t.height);for(let t=0;t<e.data.length;t+=4)0!==e.data[t+3]&&(e.data[t+3]=(e.data[t]+e.data[t+1]+e.data[t+2])/3*(e.data[t+3]/255));t.getContext("2d").putImageData(e,0,0)},freeCanvas:function(t){t.width=1,t.height=1,t.remove()},canvasBounds:function(t){let e={x:0,y:0,width:0,height:0};{let i={x1:void 0,y1:void 0,x2:void 0,y2:void 0},s=t.getImageData(0,0,t.canvas.width,t.canvas.height);if(s.data[3]>0&&s.data[s.data.length-1]>0)i.x1=0,i.y1=0,i.x2=t.canvas.width-1,i.y2=t.canvas.height-1;else for(let e=3;e<s.data.length;e+=4)if(s.data[e]>0){let s=(e-3)/4%t.canvas.width,r=Math.floor((e-3)/4/t.canvas.width);(void 0===i.x1||i.x1>s)&&(i.x1=s),void 0===i.y1&&(i.y1=r),(void 0===i.x2||i.x2<s)&&(i.x2=s),(void 0===i.y2||i.y2<r)&&(i.y2=r)}if(void 0===i.x1||void 0===i.y1||void 0===i.x2||void 0===i.y2)return;e.x=i.x1,e.y=i.y1,e.width=i.x2-i.x1+1,e.height=i.y2-i.y1+1}return e},HSV:td,RGB:tu,CMYK:tg,ColorConverter:tm,testIsWhiteBestContrast:function(t){return .299*t.r+.587*t.g+.114*t.b<125},appendTextDiv:function(t,e){let i=document.createElement("div");return i.innerHTML=e,t.append(i),i},clearSelection:function(){if(window.getSelection){let t=window.getSelection();t&&(t.empty?t.empty():t.removeAllRanges&&t.removeAllRanges())}},makeUnfocusable:tf,el:tv,destroyEl:function(t){if(t)for(let e=0;e<tx.length;e++){let i=tx[e];if(i.el===t){i.listeners.forEach(e=>{t.removeEventListener(e[0],e[1])}),tx.splice(e,1);break}}},isInputFocused:ty,unfocusAnyInput:function(){if(ty(!0)){let t=tI.el({parent:document.body,tagName:"input",css:{opacity:"0",width:"0",height:"0"}});setTimeout(()=>{t.select(),t.focus(),t.remove()},10)}},KeyListener:class{isPressed(t){if(!(t in j.getIsDown()))throw'key "'+t+'" not found';return j.getIsDown()[t]}getComboStr(){return j.getCombo().join("+")}comboOnlyContains(t){for(let e=0;e<j.getCombo().length;e++)if(!t.includes(j.getCombo()[e]))return!1;return!0}destroy(){j.remove(this.ref)}constructor(t){this.onDown=t.onDown,this.onUp=t.onUp,this.onBlur=t.onBlur,this.ref=[this.onDown,this.onUp,this.onBlur],j.add(this.ref)}},PointerListener:tr,sameKeys:function(t,e){return t.split("+").sort().join("+")===e.split("+").sort().join("+")},EventChain:tE,DoubleTapper:tS,NFingerTapper:class{failGesture(){if(0!==this.eventQueueArr.length){this.timeoutObj.firstLastDownTimeout&&clearTimeout(this.timeoutObj.firstLastDownTimeout),this.timeoutObj.tapTimeout&&clearTimeout(this.timeoutObj.tapTimeout);for(let t=0;t<this.eventQueueArr.length;t++)this.chainOut&&this.chainOut(this.eventQueueArr[t]);this.eventQueueArr=[],this.fingerArr=[]}}success(){this.timeoutObj.firstLastDownTimeout&&clearTimeout(this.timeoutObj.firstLastDownTimeout),this.timeoutObj.tapTimeout&&clearTimeout(this.timeoutObj.tapTimeout),this.eventQueueArr=[],this.fingerArr=[],this.onTap()}setupTimeout(t,e){let i=e-this.nowTime;return!(i<=0)&&(this.timeoutObj[t]=setTimeout(()=>this.failGesture(),i),!0)}processEvent(t){let e=this.lastEventTime;if(this.lastEventTime=t.time,"pointerdown"===t.type)this.pointersDownIdArr.push(t.pointerId);else if("pointerup"===t.type){for(let e=0;e<this.pointersDownIdArr.length;e++)if(this.pointersDownIdArr[e]===t.pointerId){this.pointersDownIdArr.splice(e,1);break}}if("touch"!==t.pointerType){this.fingerArr.length>0&&this.failGesture();return}if(this.nowTime=performance.now(),"pointerdown"===t.type){if(this.fingerArr.length+1!==this.pointersDownIdArr.length||this.fingerArr.length===this.fingers||this.fingerArr.length>0&&t.time-this.maxFirstLastFingerDownMs>this.fingerArr[0].downTimeMs||0===this.fingerArr.length&&t.time-this.minSilenceBeforeDurationMs<e||0===this.fingerArr.length&&(this.firstDownTime=t.time,!this.setupTimeout("firstLastDownTimeout",t.time+this.maxFirstLastFingerDownMs)||!this.setupTimeout("tapTimeout",t.time+this.maxTapMs))){this.failGesture();return}this.fingerArr.push({pointerId:t.pointerId,downTimeMs:t.time,downPageX:t.pageX,downPageY:t.pageY});return}if("pointermove"===t.type){if(0===this.fingerArr.length)return;let e=null;for(let i=0;i<this.fingerArr.length;i++)if(this.fingerArr[i].pointerId===t.pointerId){e=this.fingerArr[i];break}if(null===e||t.time-this.maxTapMs>this.firstDownTime||U(t.pageX,t.pageY,e.downPageX,e.downPageY)>this.maxPressedDistancePx){this.failGesture();return}}if("pointerup"===t.type){if(0===this.fingerArr.length)return;if(this.fingerArr.length!==this.fingers){this.failGesture();return}let e=null,i=0;for(;i<this.fingerArr.length;i++)if(this.fingerArr[i].pointerId===t.pointerId){e=this.fingerArr[i];break}if(null===e)return;if(t.time-this.maxTapMs>this.firstDownTime||U(t.pageX,t.pageY,e.downPageX,e.downPageY)>this.maxPressedDistancePx){this.failGesture();return}e.isUp=!0;let s=!0;for(let t=0;t<this.fingerArr.length;t++)if(!this.fingerArr[t].isUp){s=!1;break}if(s)return this.success(),!0}}chainIn(t){return!0===this.processEvent(t)?null:0===this.fingerArr.length?t:(this.eventQueueArr.push(t),null)}setChainOut(t){this.chainOut=t}constructor(t){this.minSilenceBeforeDurationMs=50,this.maxTapMs=500,this.maxFirstLastFingerDownMs=250,this.maxPressedDistancePx=12,this.fingerArr=[],this.eventQueueArr=[],this.firstDownTime=0,this.lastEventTime=0,this.nowTime=performance.now(),this.pointersDownIdArr=[],this.timeoutObj={firstLastDownTimeout:null,tapTimeout:null},this.fingers=t.fingers,this.onTap=t.onTap}},PinchZoomer:tC,CoalescedExploder:class{setChainOut(t){this.chainOut=t}chainIn(t){if("pointermove"!==t.type||!t.coalescedArr||!(t.coalescedArr.length>0))return t;for(let e=0;e<t.coalescedArr.length;e++){let i=S(t);0===e&&(i.coalescedArr=[]);let s=t.coalescedArr[e];i.pageX=s.pageX,i.pageY=s.pageY,i.relX=s.relX,i.relY=s.relY,i.dX=s.dX,i.dY=s.dY,i.time=s.time,e<t.coalescedArr.length-1&&(i.isCoalesced=!0),this.chainOut&&this.chainOut(i)}return null}},OnePointerLimiter:tk};Object.keys(tI);const tA=m(JSON.parse('{"switch-ui-left-right":"Switch left/right UI","toggle-show-tools":"Show/Hide Tools","scroll":"Scroll","donate":"Donate","home":"Home","modal-new-tab":"Open in new tab","tab-edit":"Edit","tab-file":"File","tool-brush":"Brush","tool-paint-bucket":"Paint Bucket","tool-gradient":"Gradient","tool-shape":"Shape","tool-text":"Text","tool-hand":"Hand Tool","tool-zoom":"Zoom","undo":"Undo","redo":"Redo","brush-pen":"Pen","brush-blend":"Blend","brush-sketchy":"Sketchy","brush-pixel":"Pixel","brush-chemy":"Chemy","brush-smudge":"Smudge","brush-size":"Size","brush-blending":"Blending","brush-toggle-pressure":"Toggle Pressure Sensitivity","brush-pen-circle":"Circle","brush-pen-chalk":"Chalk","brush-pen-calligraphy":"Calligraphy","brush-pen-square":"Square","brush-sketchy-scale":"Scale","brush-pixel-dither":"Dither","brush-chemy-fill":"Fill","brush-chemy-stroke":"Stroke","brush-chemy-mirror-x":"Horizontal Symmetry","brush-chemy-mirror-y":"Vertical Symmetry","brush-chemy-gradient":"Gradient","brush-eraser-transparent-bg":"Transparent Background","stabilizer":"Stabilizer","stabilizer-title":"Stroke Stabilizer","eyedropper":"Eyedropper","secondary-color":"Secondary Color","manual-color-input":"Manual Color Input","mci-hex":"Hex","mci-copy":"Copy","modal-ok":"Ok","modal-cancel":"Cancel","modal-close":"Close","layers-active-layer":"Active Layer","layers-layer":"Layer","layers-copy":"copy","layers-blending":"Blending","layers-new":"New Layer","layers-remove":"Remove Layer","layers-duplicate":"Duplicate Layer","layers-merge":"Merge with layer below","layers-merge-all":"Merge all","layers-rename":"Rename","layers-active-layer-visible":"Active layer is visible","layers-active-layer-hidden":"Active layer is hidden","layers-visibility-toggle":"Layer Visibility","layers-blend-normal":"normal","layers-blend-darken":"darken","layers-blend-multiply":"multiply","layers-blend-color-burn":"color burn","layers-blend-lighten":"lighten","layers-blend-screen":"screen","layers-blend-color-dodge":"color dodge","layers-blend-overlay":"overlay","layers-blend-soft-light":"soft light","layers-blend-hard-light":"hard light","layers-blend-difference":"difference","layers-blend-exclusion":"exclusion","layers-blend-hue":"hue","layers-blend-saturation":"saturation","layers-blend-color":"color","layers-blend-luminosity":"luminosity","layers-rename-title":"Rename Layer","layers-rename-name":"Name","layers-rename-clear":"Clear Name","layers-rename-sketch":"Sketch","layers-rename-colors":"Colors","layers-rename-shading":"Shading","layers-rename-lines":"Lines","layers-rename-effects":"Effects","layers-rename-foreground":"Foreground","layers-merge-modal-title":"Merge/Mix Layers","layers-merge-description":"Merges the selected layer with the one underneath. Select the mix mode:","file-no-autosave":"No autosave, no cloud storage","file-new":"New","file-import":"Import","file-save":"Save","file-format":"File Format","file-copy":"Copy","file-copy-title":"Copy To Clipboard","file-share":"Share","file-storage":"Browser Storage","file-storage-thumb-title":"Restores when reopening page","file-storage-about":"About Browser Storage","file-storage-cant-access":"Can\'t access","file-storage-empty":"Empty","file-storage-store":"Store","file-storage-clear":"Clear","file-storage-storing":"Storing","file-storage-overwrite":"Overwrite","file-storage-min-ago":"{x}min ago","file-storage-hours-ago":"{x}h ago","file-storage-days-ago":"{x}d ago","file-storage-month-ago":"> 1month ago","file-storage-restored":"Restored from Browser Storage","file-storage-stored":"Stored to Browser Storage","file-storage-failed":"Failed to store to Browser Storage","file-storage-failed-1":"Failed to store. Possible causes:","file-storage-failed-2":"Out of disk space","file-storage-failed-3":"Storage disabled in incognito tab","file-storage-failed-4":"Browser doesn\'t support storage","file-storage-failed-clear":"Failed to clear.","file-upload":"Upload","cleared-layer":"Cleared layer","filled":"Filled","new-title":"New Image","new-current":"Current","new-fit":"Fit","new-oversize":"Oversize","new-square":"Square","new-landscape":"Landscape","new-portrait":"Portrait","new-screen":"Screen","new-video":"Video","new-din-paper":"DIN Paper","new-px":"px","new-ratio":"Ratio","upload-title":"Upload to Imgur","upload-link-notice":"Anyone with the link to your uploaded image will be able to view it.","upload-name":"Title","upload-title-untitled":"Untitled","upload-caption":"Caption","upload-submit":"Upload","upload-uploading":"Uploading...","upload-success":"Upload Successful","upload-failed":"Upload failed.","upload-delete":"To delete your image from Imgur visit:","cropcopy-title-copy":"Copy To Clipboard","cropcopy-title-crop":"Crop","cropcopy-click-hold":"Right-click or press hold to copy.","cropcopy-btn-copy":"To Clipboard","cropcopy-copied":"Copied.","cropcopy-btn-crop":"Apply Crop","crop-drag-to-crop":"Drag to crop","filter-crop-extend":"Crop/Extend","filter-flip":"Flip","filter-perspective":"Perspective","filter-resize":"Resize","filter-rotate":"Rotate","filter-transform":"Transform","filter-bright-contrast":"Bright/Contrast","filter-curves":"Curves","filter-hue-sat":"Hue/Saturation","filter-invert":"Invert","filter-tilt-shift":"Tilt Shift","filter-to-alpha":"To Alpha","filter-triangle-blur":"Triangle Blur","filter-unsharp-mask":"Unsharp Mask","filter-crop-title":"Crop / Extend","filter-crop-description":"Crop or extend the image.","filter-crop-left":"Left","filter-crop-right":"Right","filter-crop-top":"Top","filter-crop-bottom":"Bottom","filter-crop-rule-thirds":"Rule of Thirds","filter-crop-fill":"Fill","filter-flip-title":"Flip","filter-flip-description":"Flips layer or whole image.","filter-flip-horizontal":"Horizontal","filter-flip-vertical":"Vertical","filter-flip-image":"Flip Image","filter-flip-layer":"Flip Layer","filter-perspective-title":"Perspective","filter-perspective-description":"Transforms the selected layer.","filter-resize-title":"Resize","filter-resize-description":"Resizes the image.","filter-rotate-title":"Rotate","filter-rotate-description":"Rotates the image.","filter-transform-empty":"Layer is empty.","filter-transform-title":"Transform","filter-transform-description":"Transforms selected layer. Hold Shift for additional behavior.","filter-transform-rotation":"Rotation","filter-transform-flip":"Flip","filter-transform-center":"Center","filter-transform-constrain":"Constrain","filter-transform-snap":"Snap","filter-transform-snap-title":"Snap Rotation And Position","filter-bright-contrast-title":"Brightness / Contrast","filter-bright-contrast-description":"Change brightness and contrast for the selected layer.","filter-bright-contrast-brightness":"Brightness","filter-bright-contrast-contrast":"Contrast","filter-curves-title":"Curves","filter-curves-description":"Apply curves on the selected layer.","filter-curves-all":"All","filter-hue-sat-title":"Hue / Saturation","filter-hue-sat-description":"Change hue and saturation for the selected layer.","filter-hue-sat-hue":"Hue","filter-hue-sat-saturation":"Saturation","filter-applied":"applied","filter-tilt-shift-title":"Tilt Shift","filter-tilt-shift-description":"Applies tilt shift on the selected layer.","filter-tilt-shift-blur":"Blur Radius","filter-tilt-shift-gradient":"Gradient Radius","filter-to-alpha-title":"To Alpha","filter-to-alpha-description":"Generates alpha channel for selected layer from:","filter-to-alpha-inverted-lum":"Inverted Luminance","filter-to-alpha-lum":"Luminance","filter-to-alpha-replace":"Replace RGB","filter-triangle-blur-title":"Triangle Blur","filter-triangle-blur-description":"Applies triangle blur on the selected layer.","filter-unsharp-mask-title":"Unsharp Mask","filter-unsharp-mask-description":"Sharpens the selected layer by scaling pixels away from the average of their neighbors.","filter-unsharp-mask-strength":"Strength","filter-grid":"Grid","filter-grid-description":"Draws grid on selected layer.","filter-noise":"Noise","filter-noise-description":"Adds noise to selected layer.","filter-noise-scale":"Scale","filter-noise-alpha":"Alpha","filter-pattern":"Pattern","filter-pattern-description":"Generates pattern on selected layer. Drag the preview for further controls.","filter-distort":"Distort","filter-distort-description":"Distorts the selected layer.","filter-distort-phase":"Phase","filter-distort-stepsize":"Step Size","filter-distort-sync-xy":"Sync XY","filter-vanish-point":"Vanish Point","filter-vanish-point-title":"Vanishing Point","filter-vanish-point-description":"Adds vanishing point to selected layer. Drag preview to move.","filter-vanish-point-lines":"Lines","import-opening":"Opening file...","import-title":"Import Image","import-too-large":"Image too large, will be downscaled.","import-btn-as-layer":"As Layer","import-btn-as-image":"As Image","import-as-layer-title":"Import Image as New Layer","import-as-layer-description":"Adjust the position of the imported image.","import-as-layer-limit-reached":"Layer limit reached. Image will be placed on existing layer.","import-as-layer-fit":"Fit","import-flatten":"Flatten image","import-unsupported-file":"Unsupported file type. See Help for supported types.","import-broken-file":"Couldn\'t load image. File might be corrupted.","import-psd-unsupported":"Unsupported features. PSD had to be flattened.","import-psd-limited-support":"PSD support is limited. Flattened will more likely look correct.","import-psd-too-large":"Image exceeds maximum dimensions of {x} x {x} pixels. Unable to import.","import-psd-size":"Image size","hand-reset":"Reset","hand-fit":"Fit","bucket-tolerance":"Tolerance","bucket-sample":"Sample","bucket-sample-title":"Which layers to sample color from","bucket-sample-all":"All","bucket-sample-active":"Active","bucket-sample-above":"Above","bucket-grow":"Grow","bucket-grow-title":"Grow filled area (in pixels)","bucket-contiguous":"Contiguous","bucket-contiguous-title":"Only fill connected areas","gradient-linear":"Linear","gradient-linear-mirror":"Linear-Mirror","gradient-radial":"Radial","shape-stroke":"Stroke","shape-fill":"Fill","shape-rect":"Rectangle","shape-ellipse":"Ellipse","shape-line":"Line","shape-line-width":"Line Width","shape-outwards":"Outwards","shape-fixed":"Fixed 1:1","text-instruction":"Click canvas to place text","text-title":"Add Text","text-text":"Text","text-font":"Font","text-placeholder":"Your text","text-color":"Color","text-size":"Size","text-line-height":"Line Height","text-letter-spacing":"Letter Spacing","text-left":"Left","text-center":"Center","text-right":"Right","text-italic":"Italic","text-bold":"Bold","save-reminder-title":"Unsaved Work","save-reminder-text":"Image was not saved in {a} minutes{b}. Save now to prevent eventual loss.","save-reminder-save-psd":"Save As PSD","save-reminder-psd-layers":"PSD will remember all layers.","backup-drawing":"You can backup your drawing.","submit":"Submit","submit-title":"Submit Drawing","submit-prompt":"Submit drawing?","submit-submitting":"Submitting","embed-init-loading":"Loading app","embed-init-waiting":"Waiting for image","unsaved":"Unsaved","help":"Help","tab-settings":"Settings","settings-language":"Language","settings-language-reload":"Will update after reloading.","settings-theme":"Theme","settings-save-reminder-label":"Save Reminder","settings-save-reminder-disabled":"disabled","settings-save-reminder-confirm-title":"Turn off Save Reminder?","settings-save-reminder-confirm-a":"There is no autosave and browser tabs don\'t last forever. If you don\'t periodically save you will likely lose work.","settings-save-reminder-confirm-b":"Disable at your own risk?","settings-save-reminder-confirm-disable":"Disable","theme-dark":"Dark","theme-light":"Light","terms-of-service":"Terms of Service","licenses":"Licenses","source-code":"Source Code","auto":"auto","zoom-in":"Zoom In","zoom-out":"Zoom Out","radius":"Radius","constrain-proportions":"Constrain Proportions","width":"Width","height":"Height","opacity":"Opacity","red":"Red","green":"Green","blue":"Blue","eraser":"Eraser","center":"Center","layers":"Layers","background":"Background","scaling-algorithm":"Scaling Algorithm","algorithm-smooth":"Smooth","algorithm-pixelated":"Pixelated","preview":"Preview","angle-snap":"Snap","angle-snap-title":"45 Angle Snapping","lock-alpha":"Lock Alpha","lock-alpha-title":"Locks layer\'s alpha channel","reverse":"Reverse","compare-before":"Before","compare-after":"After","loading":"Loading","more":"More","x-minutes":"{x}min"}')),tT=[{code:"en",name:"English"},{code:"de",name:"Deutsch"},{code:"fr",name:"Franais"},{code:"ja",name:""},{code:"ko",name:""},{code:"ru",name:""},{code:"zh-CN",name:""},{code:"zh-TW",name:""}],tM=async t=>{if("en"===t)return tA;if("de"===t)return await x("lytfz");if("fr"===t)return await x("1JS1i");if("ja"===t)return await x("9KmPU");if("ko"===t)return await x("1Rdf4");if("ru"===t)return await x("lb7jn");if("zh-CN"===t)return await x("hpkwJ");else if("zh-TW"===t)return await x("cGAWy");throw Error("unknown language code")},tL="klecks-language";function tR(t){let e="en",i=[];if((navigator.languages?navigator.languages:[navigator.language]).forEach(t=>{let e=t.split("-");i.push(t),2===e.length&&i.push(e[0])}),t)try{let t=localStorage.getItem(tL);t&&i.unshift(t)}catch(t){}for(let t=0;t<i.length;t++){let s=i[t],r=tT.find(t=>t.code.toLowerCase()===s.toLowerCase());if(r){e=r.code;break}}return e}const tP=tR(!0),tD=new class{async setLanguage(t){"en"===t?this.data={...tA}:this.data={...tA,...await tM(t)},this.code=t,document.documentElement.setAttribute("lang",t),this.listeners.forEach(t=>{t()})}get(t){if(!(t in this.data))throw Error("translation code doesn't exist: "+t);return this.data[t]}getLanguage(){return tT.find(t=>t.code===this.code)}getAutoLanguage(){let t=tR(!1);return tT.find(e=>e.code===t)}getCode(){return this.code}subscribe(t){this.listeners.includes(t)||this.listeners.push(t)}unsubscribe(t){for(let e=0;e<this.listeners.length;e++)if(t===this.listeners[e]){this.listeners.splice(e,1);return}}constructor(){this.listeners=[],this.data={...tA},this.code="en"}},tB=(t,e)=>{if(!e)return tD.get(t);{let i=tD.get(t);return Object.keys(e).forEach(t=>{i=i.replace(`{${t}}`,e[t])}),i}},tO=()=>tD.setLanguage(tP);window.onscroll=t=>{t.preventDefault()};var tz={};tz=x("dwTKp").getBundleURL("lrLBb")+"cancel.5edb67d5.svg";var tV={};function tH(t){let e,i,s;B.increase();let r=!1,a=!!t.ignoreBackground,n=tI.el({parent:document.body,css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",overflow:"hidden"}}),o=tI.el({parent:n,className:"kl-popup"}),l=tI.el({parent:o,css:{width:"100%",minHeight:"100%",position:"relative",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}}),h=tI.el({parent:l,onClick:()=>{a||x("Cancel")},css:{position:"absolute",left:"0",top:"0",zIndex:"0",width:"100%",height:"100%"}}),c=tI.el({tagName:"button",className:"popup-x",content:`<img alt="${tB("modal-close")}" height="20" src="${m(tz)}">`,title:tB("modal-close"),onClick:()=>{x("Cancel")},css:{width:"40px",height:"40px",lineHeight:"40px",position:"absolute",right:"0",top:"0",background:"none",boxShadow:"none"}});t.type&&(s=tI.el({className:{error:"kl-popup__icon-error",ok:"kl-popup__icon-ok",warning:"kl-popup__icon-warning",upload:"kl-popup__icon-upload"}[t.type]}));let p=["kl-popup-box"];p.push("kl-popup-box--sm");let d=tI.el({content:[c,s,tI.el({content:t.message,css:{marginRight:"15px",marginBottom:t.div?"10px":void 0}}),t.div],className:p.join(" "),css:t.style?t.style:void 0});l.append(tI.el({css:{flex:"0.5"}}),d,tI.el({css:{flex:"1"}}));let u=new tI.KeyListener({onDown:function(t,e,s){r||(i&&"enter"===s&&!tI.isInputFocused()&&(e.stopPropagation(),setTimeout(()=>{i&&i.click()},10)),"esc"===s&&(e.stopPropagation(),x("Cancel")))}}),g=t=>{u.isPressed("ctrl")&&t.preventDefault()};o.addEventListener("wheel",g),o.onclick=tI.handleClick,e=t.autoFocus?t.autoFocus:!1===t.autoFocus?void 0:"Ok";let y=t.buttons&&t.buttons.length>0?tI.el({parent:d,css:{display:"flex",flexWrap:"wrap",justifyContent:"flex-end",marginTop:"12px",marginLeft:"-8px"}}):void 0,f=[];function x(e){!r&&(r=!0,tI.clearSelection(),tI.unfocusAnyInput(),n.remove(),B.decrease(),tI.destroyEl(c),tI.destroyEl(h),u.destroy(),o.removeEventListener("wheel",g),o.onclick=null,f.forEach(t=>tI.destroyEl(t)),f.splice(0,f.length),t.callback&&t.callback(e))}return t.buttons&&t.buttons.forEach(s=>{let r,a;let n=["kl-popup__btn"];("Ok"===s||t.primaries&&t.primaries.includes(s))&&n.push("kl-button-primary");let l=s;"Ok"===s&&(l=tB("modal-ok"),r=m(tV)),"Cancel"===s&&(l=tB("modal-cancel"),r=m(tz),n.push("kl-button-cancel")),r&&(a=tI.el({tagName:"img",custom:{src:r,height:"17"}}));let h=tI.el({parent:y,tagName:"button",className:n.join(" "),content:[a,tI.el({className:"kl-popup__btn__text",content:l})],onClick:()=>{x(s)}});f.push(h),e===s&&(setTimeout(()=>{h.focus(),o.scrollTo(0,0)},10),setTimeout(()=>{o.scrollTo(0,0)},20)),s===t.clickOnEnter&&(i=h)}),t.closeFunc&&t.closeFunc(function(){x("Cancel")}),{setIgnoreBackground:t=>{a=t}}}tV=x("dwTKp").getBundleURL("lrLBb")+"check.42e17e77.svg";class tj{close(){B.decrease(),tI.destroyEl(this.rootEl),this.rootEl.remove(),window.removeEventListener("resize",this.updatePos),this.keyListener.destroy(),tI.destroyEl(this.xButton),tI.destroyEl(this.bgEl),this.onClose&&this.onClose()}constructor(t){B.increase(),this.onClose=t.onClose,this.parent=document.body,this.rootEl=tI.el({parent:this.parent,className:"g-root kl-d-modal-root",css:{position:"fixed",left:"0",top:"0",bottom:"0",right:"0",overflow:"auto",animationName:"consoleIn",animationDuration:"0.3s",animationTimingFunction:"ease-out"},onClick:tI.handleClick}),this.bgEl=tI.el({parent:this.rootEl,css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0"},onClick:()=>this.close()});let e=tI.el({parent:this.rootEl,className:"kl-d-modal",css:{position:"absolute",width:tI.isCssMinMaxSupported()?"min(calc(100% - 40px), "+(t.width?t.width:400)+"px)":(t.width?t.width:400)+"px",height:"calc(100% - 40px)",borderRadius:"10px",overflow:"hidden"}});this.updatePos=()=>{let t=e.offsetWidth,i=e.offsetHeight;tI.css(e,{left:Math.max(0,(window.innerWidth-t)/2)+"px",top:Math.max(20,(window.innerHeight-i)/2-.2*i)+"px"})},this.updatePos(),window.addEventListener("resize",this.updatePos);let i=tI.el({parent:e,css:{height:"40px",display:"flex",justifyContent:"space-between",alignItems:"center",paddingLeft:"20px"}});t.title&&i.append(t.title),this.xButton=tI.el({parent:i,tagName:"button",className:"popup-x",content:`<img alt="${tB("modal-close")}" height="20" src="${m(tz)}">`,title:tB("modal-close"),onClick:()=>this.close(),css:{width:"40px",height:"40px",lineHeight:"40px",background:"none",boxShadow:"none"},custom:{tabindex:"0"}});let s=tI.el({parent:e,css:{height:"calc(100% - 40px)"}});t.content&&s.append(t.content),this.keyListener=new tI.KeyListener({onDown:(t,e)=>{"esc"===t&&(e.stopPropagation(),this.close())}})}}class tF{getValue(){return this.check.checked}setValue(t){this.check.checked=!!t,this.doHighlight&&this.element.classList.toggle("kl-checkbox--highlight",this.check.checked)}getElement(){return this.element}destroy(){this.check.onchange=null}constructor(t){this.doHighlight=!!t.doHighlight,this.element=tI.el({className:"kl-checkbox"});let e=tI.el({parent:this.element,tagName:"label",className:"kl-checkbox__inner",css:{display:"flex"}});this.check=tI.el({parent:e,tagName:"input",css:{margin:"0 5px 0 0"},custom:{type:"checkbox"}}),this.check.checked=!!t.init,this.doHighlight&&this.check.checked&&this.element.classList.add("kl-checkbox--highlight"),t.allowTab||(this.check.tabIndex=-1),t.title&&(e.title=t.title),tI.el({parent:e,content:t.label,css:{}}).allowClick=!0,this.check.onchange=()=>{this.doHighlight&&this.element.classList.toggle("kl-checkbox--highlight",this.check.checked),t.callback&&t.callback(this.check.checked),setTimeout(()=>{this.check.blur()},0)},t.css&&tI.css(this.element,t.css)}}class tW{getElement(){return this.rootEl}getValue(){return this.input.value}setValue(t){this.input.value=""+t}destroy(){this.pointerListener&&this.pointerListener.destroy(),this.keyListener.destroy()}constructor(t){var e,i;this.keyListener={destroy:()=>{}},this.rootEl=tI.el({tagName:"label",content:t.label,css:{display:"flex",alignItems:"center",gap:"5px"}}),this.input=tI.el({tagName:"input",parent:this.rootEl,title:t.title}),this.input.type,this.type=null!==(e=t.type)&&void 0!==e?e:"text";try{this.input.type=this.type}catch(t){}let s=null!==(i=t.step)&&void 0!==i?i:1;"number"===this.type&&(void 0!==t.min&&(this.input.min=""+t.min),void 0!==t.max&&(this.input.max=""+t.max),void 0!==t.step&&(this.input.step=""+s)),this.input.value=""+t.init;let r=this.input.value,a=()=>{let e=r,i=this.input.value;if(t.doResetIfInvalid){let e=!1;""===i&&(i=r,e=!0),void 0!==t.min&&parseFloat(i)<t.min&&(i=""+t.min,e=!0),void 0!==t.max&&parseFloat(i)>t.max&&(i=""+t.max,e=!0),e&&(this.input.value=""+i)}return r=i,e!==i};if(t.onChange){let e=t.onChange;this.input.onchange=()=>{a()&&e(this.input.value)}}if(t.css&&tI.css(this.input,t.css),t.doScrollWithoutFocus&&"number"===t.type&&t.onChange){let e=t.onChange;this.keyListener=new tI.KeyListener({}),this.pointerListener=new tI.PointerListener({target:this.input,onWheel:t=>{let i=this.keyListener.isPressed("shift")?4:1;this.input.value=""+(parseFloat(this.input.value)-t.deltaY*s*i),a()&&e(this.input.value)}})}}}const tU=function(t){let e=document.createElement("input");if(t.type)try{e.type=t.type}catch(t){}else e.type="text";return void 0!==t.min&&(e.min=""+t.min),void 0!==t.max&&(e.max=""+t.max),e.value=""+t.init,t.callback&&(e.onchange=function(){t.callback(e.value)}),t.css&&tI.css(e,t.css),e};class tN{setValue(t){this.selectEl.value=void 0===t?"":t}getValue(){return this.selectEl.value}setDeltaValue(t){let e=0;for(let t=0;t<this.optionArr.length;t++){let i=this.optionArr[t];if(i.item&&""+i.item[0]===this.selectEl.value){e=t;break}}e=Math.max(0,Math.min(this.optionArr.length-1,e+t));let i=this.optionArr[e];this.selectEl.value=i.item?i.item[0]:"",this.onChange&&this.onChange(this.getValue())}getElement(){return this.selectEl}updateLabel(t,e){this.optionArr.forEach(i=>{i.item&&i.item[0]===t&&i.el&&(i.item[1]=e,i.el.textContent=i.item[1])})}setOptionArr(t){this.optionArr=[],this.selectEl.innerHTML="";for(let e=0;e<t.length;e++){let i=t[e];if(!i){this.optionArr.push({item:i});continue}let s=document.createElement("option");s.value=i[0],s.textContent=i[1],i[2]&&tI.css(s,i[2].css),this.optionArr.push({item:i,el:s}),this.selectEl.append(s)}}destroy(){this.selectEl.removeEventListener("change",this.changeListener)}constructor(t){this.optionArr=[],this.selectEl=tI.el({tagName:"select",title:t.title,className:"kl-select",css:{cursor:"pointer",fontSize:"15px",padding:"3px"}}),t.css&&tI.css(this.selectEl,t.css);let e=t.isFocusable;e||(this.selectEl.tabIndex=-1),this.setOptionArr(t.optionArr),t.onChange&&(this.onChange=t.onChange),this.changeListener=()=>{e||this.selectEl.blur(),this.onChange&&this.onChange(this.getValue())},this.selectEl.addEventListener("change",this.changeListener),this.selectEl.value=void 0!==t.initValue?t.initValue:""}}class t_{update(){this.rootEl.classList.toggle("image-toggle-active",this.isActive)}setValue(t){this.isActive=!!t,this.update()}getElement(){return this.rootEl}getValue(){return this.isActive}destroy(){tI.destroyEl(this.rootEl)}constructor(t){this.isActive=!!t.initValue,this.rootEl=tI.el({className:"image-toggle",title:t.title,content:tI.el({className:"image-toggle__im"+(t.darkInvert?" dark-invert":""),css:{backgroundImage:"url('"+t.image+"')"}}),onClick:e=>{e.preventDefault(),t.isRadio&&this.isActive||(this.isActive=!this.isActive,this.update(),t.onChange(this.isActive))}}),this.update()}}class tY{getElement(){return this.rootEl}getValue(){return this.optionArr[this.activeIndex].id}destroy(){this.optionArr.forEach(t=>{t.radioEl.destroy()})}constructor(t){let e;this.rootEl=tI.el({className:"image-radio-wrapper",css:{display:"flex"}}),this.optionArr=[];let i=(e,i)=>{this.activeIndex=e;for(let t=0;t<this.optionArr.length;t++)this.optionArr[t].radioEl.setValue(t===this.activeIndex);t.onChange(i)},s=(s,r)=>{r.id===t.initId&&(e=s);let a=new t_({image:r.image,title:r.title,initValue:r.id===t.initId,isRadio:!0,onChange:()=>{i(s,r.id)},darkInvert:r.darkInvert});return this.rootEl.append(a.getElement()),{id:r.id,radioEl:a}};for(let e=0;e<t.optionArr.length;e++)this.optionArr.push(s(e,t.optionArr[e]));if(void 0===e)throw Error("initId not in optionArr");this.activeIndex=e}}var tX={};tX=x("dwTKp").getBundleURL("lrLBb")+"brush-pressure.f4437531.svg";class tG{update(){this.el.classList.toggle("kl-box-toggle--active",this.value)}getValue(){return this.value}setValue(t){this.value=!!t,this.update()}getElement(){return this.el}destroy(){tI.destroyEl(this.el)}constructor(t){this.value=!!t.init,this.el=tI.el({content:t.label,title:t.title,className:"string"==typeof t.label?"kl-box-toggle":"kl-box-toggle kl-box-toggle--custom-el",onClick:()=>{this.value=!this.value,this.update(),t.onChange(this.value)},css:{cursor:"pointer"}}),"string"!=typeof t.label&&tI.css(t.label,{display:"block",pointerEvents:"none"}),this.update()}}const tK=function(t,e){return new tG({label:tI.el({className:"dark-invert",css:{width:"17px",height:"17px",backgroundImage:'url("'+m(tX)+'")',backgroundSize:"contain",backgroundRepeat:"no-repeat",margin:"1px",borderRadius:"3px"}}),title:tB("brush-toggle-pressure"),init:t,onChange:t=>{e(t)}}).getElement()};function tq(t,e){let i=Math.min(10,1+Math.pow(Math.floor(t/50),2));return e&&(i*=2),1/i}class t${emit(){this.lastValue!==Number(this.input.value)&&(this.onChange(Number(this.input.value)),this.lastValue=Number(this.input.value))}privateOnClose(){this.isClosed||(this.isClosed=!0,this.emit(),this.onClose(),setTimeout(()=>{this.scrollBefore&&window.scrollTo(this.scrollBefore.x,this.scrollBefore.y),this.scrollBefore=void 0}))}getElement(){return this.input}setIsEnabled(t){this.isEnabled=!!t}focus(){this.input.focus(),this.input.select()}destroy(){tI.destroyEl(this.input)}constructor(t,e,i,s,r,a,n){let o;this.onChange=r,this.onClose=a,this.isEnabled=!0,this.isClosed=!1,this.input=tU({type:"number",init:t,min:e,max:i,callback:t=>{this.emit()}}),0!==n&&this.input.setAttribute("step","any"),this.input.onblur=()=>{this.privateOnClose()},this.input.addEventListener("keyup",t=>{["Enter","Escape"].includes(t.key)?this.privateOnClose():this.emit()}),this.input.addEventListener("wheel",()=>this.emit()),this.scrollBefore={x:window.scrollX,y:window.scrollY},o=n||0===n?tI.round(t,n):t,this.lastValue=o,this.input.value=""+o,tI.css(this.input,{width:s.width+"px",height:s.height+"px"})}}class tQ{valueToSliderValue(t){return this.useSpline&&this.splineInterpolator?this.splineInterpolator.findX(t,Math.floor(this.resolution))||0:(t-this.min)/(this.max-this.min)}sliderValueToValue(t){let e=this.min+t*(this.max-this.min);return this.useSpline&&this.splineInterpolator&&(e=this.splineInterpolator.interpolate(t)||0),e}updateLabel(){let t=this.valueToDisplayValue(this.value);t=(t=this.formatFunc?this.formatFunc(t):Math.round(t)).toLocaleString(tD.getCode());let e=void 0!==this.unit?this.unit:"";this.textEl.innerHTML=this.label+'&nbsp;&nbsp;<span style="font-weight:bold">'+t+e+"</span>";let i=this.valueToSliderValue(this.value);this.control.style.width=i*this.elementWidth+"px"}emit(t){if(t||!this.isChangeOnFinal){if(t||!this.eventResMs){this.onChange(this.value),this.emitInterval&&(clearInterval(this.emitInterval),this.emitInterval=void 0);return}this.emitInterval?this.emitValue=this.value:(this.onChange(this.value),this.emitInterval=setInterval(()=>{void 0===this.emitValue?(clearInterval(this.emitInterval),this.emitInterval=void 0):(this.onChange(this.emitValue),this.emitValue=void 0)},this.eventResMs))}}updateEnable(){this.sliderWrapperEl.classList.toggle("slider-wrapper--disabled",!this.isEnabled),tI.css(this.sliderWrapperEl,{opacity:this.isEnabled?"":"0.5",pointerEvents:this.isEnabled?"":"none"}),this.manualInput&&this.manualInput.setIsEnabled(this.isEnabled)}showManualInput(){this.manualInput=new t$(this.valueToDisplayValue(this.value),this.valueToDisplayValue(this.min),this.valueToDisplayValue(this.max),this.sliderWrapperEl.getBoundingClientRect(),t=>{t=this.displayValueToValue(t),this.setValue(tI.clamp(t,this.min,this.max)),this.onChange(this.value)},()=>{tI.css(this.sliderWrapperEl,{display:""}),this.manualInput&&(this.manualInput.getElement().remove(),this.manualInput.destroy()),this.manualInput=void 0},this.manualInputRoundDigits&&this.manualInputRoundDigits>0?this.manualInputRoundDigits:0),this.manualInput.setIsEnabled(this.isEnabled),this.rootEl.append(this.manualInput.getElement()),setTimeout(()=>{this.manualInput&&this.manualInput.focus()}),tI.css(this.sliderWrapperEl,{display:"none"})}changeSliderValue(t){if(!this.isEnabled)return;let e=this.valueToSliderValue(this.value);e=tI.clamp(e+t,0,1),this.value=this.sliderValueToValue(e),this.updateLabel(),this.onChange(this.value)}setValue(t){this.value=tI.clamp(t,this.min,this.max),this.updateLabel()}getValue(){return this.value}update(t){if(this.min=t.min,this.max=t.max,this.useSpline=!!t.curve,this.useSpline){if(!t.curve)throw Error("curve needs to be set if useSpline true");let e="quadratic"===t.curve?tI.quadraticSplineInput(this.min,this.max,.1):t.curve;this.splineInterpolator=new tI.SplineInterpolator(e)}else this.splineInterpolator=void 0;this.setIsEnabled(!t.isDisabled)}setIsEnabled(t){this.isEnabled=!!t,this.updateEnable()}destroy(){clearTimeout(this.pointerListenerTimeout),this.pointerListener&&this.pointerListener.destroy(),this.manualInput&&this.manualInput.destroy(),this.emitInterval&&clearInterval(this.emitInterval)}getElement(){return this.rootEl}constructor(t){let e;if(this.isEnabled=!1!==t.isEnabled,this.manualInputRoundDigits=t.manualInputRoundDigits,this.useSpline=!!t.curve,!t.label)throw Error("KlSlider missing params");if(0!=t.min&&0!=t.max&&0!=t.value&&(!t.min||!t.max||!t.value)||t.min>=t.max)throw Error("KlSlider broken params");if(this.min=t.min,this.max=t.max,this.value=tI.clamp(t.value,this.min,this.max),this.elementWidth=t.width,this.elementHeight=t.height,this.resolution=t.resolution?t.resolution:2*this.elementWidth,this.onChange=t.onChange?t.onChange:()=>{},!t.toValue!=!t.toDisplayValue)throw Error("both or neither have to be set, toValue and toDisplayValue");if(this.displayValueToValue=t.toValue?t.toValue:t=>t,this.valueToDisplayValue=t.toDisplayValue?t.toDisplayValue:t=>t,this.isChangeOnFinal=!!t.isChangeOnFinal,this.formatFunc=t.formatFunc,this.eventResMs=t.eventResMs,this.unit=t.unit,this.useSpline){if(!t.curve)throw Error("curve needs to be set if useSpline true");let e="quadratic"===t.curve?tI.quadraticSplineInput(this.min,this.max,.1):t.curve;this.splineInterpolator=new tI.SplineInterpolator(e)}this.rootEl=tI.el({css:{display:"flex"}}),this.sliderWrapperEl=tI.el({parent:this.rootEl,className:"slider-wrapper",css:{overflow:"hidden",position:"relative",width:this.elementWidth+"px",height:this.elementHeight+"px",userSelect:"none"}}),this.rootEl.oncontextmenu=function(){return!1},this.label=t.label;let i=this.elementHeight-14;this.textEl=tI.el({content:this.label,css:{position:"absolute",display:"flex",alignItems:"center",marginLeft:"7px",height:"100%",fontSize:i+"px",pointerEvents:"none"}}),this.control=tI.el({className:"slider-inner",css:{position:"absolute",left:"0",top:"0",width:this.valueToSliderValue(this.value)*this.elementWidth+"px",height:this.elementHeight+"px"}});let s=document.createElement("div");this.sliderWrapperEl.append(this.control,this.textEl),this.control.append(s),this.updateEnable();let r=new tI.DoubleTapper({onDoubleTap:()=>{this.showManualInput()}});r.setAllowedButtonArr(["left","right"]);let a=new tI.EventChain({chainArr:[r]}),n=t=>{if(t.eventPreventDefault(),this.isEnabled){if("pointerdown"===t.type){if(tI.unfocusAnyInput(),this.sliderWrapperEl.className="slider-wrapper slider-wrapper--active","left"===t.button){let e=t.relX/this.elementWidth;e=Math.max(0,Math.min(1,e)),this.value=this.sliderValueToValue(e),this.updateLabel(),this.emit(!1)}e=this.valueToSliderValue(this.value)}if("pointermove"===t.type&&["left","right"].includes(t.button||"")){let i=t.dX;i*=tq(Math.abs(t.pageY-(t.downPageY||0)),"right"===t.button),i/=this.elementWidth;let s=Math.max(0,Math.min(1,e+=i));this.value=this.sliderValueToValue(s),this.updateLabel(),this.emit(!1)}"pointerup"===t.type&&(this.sliderWrapperEl.className="slider-wrapper",this.emit(!0))}};this.pointerListenerTimeout=setTimeout(()=>{this.pointerListener=new tI.PointerListener({target:this.sliderWrapperEl,fixScribble:!0,onPointer:t=>{n(t),a.chainIn(t)},onWheel:t=>{let e=this.valueToSliderValue(this.value);e=tI.clamp(e-t.deltaY/40,0,1),this.value=this.sliderValueToValue(e),this.updateLabel(),this.onChange(this.value)}}),this.updateLabel()},1)}}var tZ={};function tJ(t,e){var i;if(void 0===t)return document.createElement("div");if("string"!=typeof t)return t instanceof HTMLElement||(t=tv(t)),e&&("string"==typeof e?t.innerHTML=e:t.append(...e)),t;let s=function(t){let e,i;if(""===t)return{};let s=[];1===(e=t.split(".")).length?i=(e=e[0].split(",")).shift():(i=e.shift(),e.forEach((t,i)=>{if(i===e.length-1){let i=(e=t.split(",")).shift();void 0!==i&&s.push(i)}else s.push(t)}));let r={};return""!==i&&(r.tagName=i),s.length>0&&(r.classes=s),e.length>0&&(r.styles=e),r}(t),r=document.createElement(null!==(i=s.tagName)&&void 0!==i?i:"div");return s.classes&&r.classList.add(...s.classes),s.styles&&function(t,e){let i={},s={c:t=>{i.color=t[0]},bg:t=>{i.background=t[0]},p:t=>{i.padding=t[0]+"px"},py:t=>{i.paddingTop=t[0]+"px",i.paddingBottom=t[0]+"px"},pt:t=>{i.paddingTop=t[0]+"px"},pr:t=>{i.paddingRight=t[0]+"px"},pb:t=>{i.paddingBottom=t[0]+"px"},pl:t=>{i.paddingLeft=t[0]+"px"},mt:t=>{i.marginTop=t[0]+"px"},mr:t=>{i.marginRight=t[0]+"px"},mb:t=>{i.marginBottom=t[0]+"px"},ml:t=>{i.marginLeft=t[0]+"px"},flex:()=>{i.display="flex"},flexCol:()=>{i.flexDirection="column"},flexWrap:()=>{i.flexWrap="wrap"},gap:t=>{i.gap=t.map(t=>t+"px").join(" ")},grow:()=>{i.flexGrow="1"},justify:t=>{i.justifyContent=t[0]},items:t=>{i.alignItems=t[0]},hidden:()=>{i.display="none"},nowrap:()=>{i.whiteSpace="nowrap"},abs:t=>{i.position="absolute",i.left=t[0]+"px",i.top=t[1]+"px"},w:t=>{i.width="full"===t[0]?"100%":t[0]+"px"},h:t=>{i.height="full"===t[0]?"100%":t[0]+"px"},minh:t=>{i.minHeight=t[0]+"px"},z:t=>{i.zIndex=t[0]},overflow:t=>{i.overflow=t[0]},pos:t=>{i.position=t[0]},left:t=>{i.left="full"===t[0]?"100%":t[0]+"px"},top:t=>{i.top="full"===t[0]?"100%":t[0]+"px"},right:t=>{i.right="full"===t[0]?"100%":t[0]+"px"},bottom:t=>{i.bottom="full"===t[0]?"100%":t[0]+"px"},size:t=>{i.fontSize=t[0]+"px"},pointer:t=>{i.pointerEvents=t[0]}};e.forEach(t=>{let e=t.split("-");s[e.shift()](e)}),tI.css(t,i)}(r,s.styles),e&&("string"==typeof e?r.innerHTML=e:r.append(...e)),r}tZ=x("dwTKp").getBundleURL("lrLBb")+"copy.4adadd0c.svg";var t0=x("brs90"),t1=x("7YdyD"),t2=x("42Upt");function t5(t,e){if(void 0===t.inserted[e.name])return t.insert("",e,t.sheet,!0)}function t3(t,e,i){var s=[],r=(0,t2.getRegisteredStyles)(t,s,i);return s.length<2?i:r+e(s)}var t4=function t(e){for(var i="",s=0;s<e.length;s++){var r=e[s];if(null!=r){var a=void 0;switch(typeof r){case"boolean":break;case"object":if(Array.isArray(r))a=t(r);else for(var n in a="",r)r[n]&&n&&(a&&(a+=" "),a+=n);break;default:a=r}a&&(i&&(i+=" "),i+=a)}}return i};x("brs90"),x("7YdyD"),x("42Upt");var t9=(o={key:"css"},(l=(0,t0.default)(o)).sheet.speedy=function(t){this.isSpeedy=t},l.compat=!0,{css:h=function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];var s=(0,t1.serializeStyles)(e,l.registered,void 0);return(0,t2.insertStyles)(l,s,!1),l.key+"-"+s.name},cx:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];return t3(l.registered,h,t4(e))},injectGlobal:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];var s=(0,t1.serializeStyles)(e,l.registered);t5(l,s)},keyframes:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];var s=(0,t1.serializeStyles)(e,l.registered),r="animation-"+s.name;return t5(l,{name:s.name,styles:"@keyframes "+r+"{"+s.styles+"}"}),r},hydrate:function(t){t.forEach(function(t){l.inserted[t]=!0})},flush:function(){l.registered={},l.inserted={},l.sheet.flush()},sheet:l.sheet,cache:l,getRegisteredStyles:(0,t2.getRegisteredStyles).bind(null,l.registered),merge:t3.bind(null,l.registered,h)}),t6=(t9.flush,t9.hydrate,t9.cx,t9.merge,t9.getRegisteredStyles,t9.injectGlobal,t9.keyframes,t9.css);t9.sheet,t9.cache;class t8{constructor(t){let e=new tI.RGB(t.color.r,t.color.g,t.color.b),i=tI.el({css:{width:"20px",height:"20px",marginBottom:"10px",boxShadow:"inset 0 0 0 1px #fff, 0 0 0 1px #000",background:"#"+tI.ColorConverter.toHexString(e)}}),s=tI.el({content:tB("mci-hex")}),r=tU({init:"#"+tI.ColorConverter.toHexString(e),css:{width:"80px"},callback:function(){let t=tI.ColorConverter.hexToRGB(r.value);t?e=t:(t=e,r.value="#"+tI.ColorConverter.toHexString(e)),i.style.background="#"+tI.ColorConverter.toHexString(t);for(let t=0;t<l.length;t++)l[t].update()}}),a=tI.el({tagName:"button",content:'<img src="'+m(tZ)+'" height="20" alt=""/>',title:tB("mci-copy"),onClick:function(){r.select(),navigator.clipboard.writeText(r.value).then().catch()}}),n=tJ({css:{display:"flex",alignItems:"center",marginBottom:"15px",flexWrap:"wrap",gap:"5px 10px",maxWidth:"250px"}},[s,tJ(",flex,items-center,gap-10",[r,a])]);function o(t,s){let a=tU({init:e[s],min:0,max:255,type:"number",css:{width:"80px"},callback:function(){if(""===a.value||0>parseFloat(a.value)||parseFloat(a.value)>255){n.update();return}a.value=""+Math.round(parseFloat(a.value)),e[s]=Number(a.value),i.style.background="#"+tI.ColorConverter.toHexString(e),r.value="#"+tI.ColorConverter.toHexString(e)}}),n={update:()=>{a.value=""+e[s]},destroy:()=>{tI.unsetEventHandler(a,"onchange")},element:tJ("tr",[tJ("td,pr-10",t),tJ("td",[a])])};return n}setTimeout(function(){r.focus(),r.select()},0);let l=[o(tB("red"),"r"),o(tB("green"),"g"),o(tB("blue"),"b")],h=tJ("",[i,n,tJ("table."+t6({borderCollapse:"collapse",td:{paddingBottom:"5px"}}),[tJ("tbody",l.map(t=>t.element))])]);tH({target:document.body,message:`<b>${tB("manual-color-input")}</b>`,div:h,autoFocus:!1,clickOnEnter:"Ok",buttons:["Ok","Cancel"],callback:function(e){tI.destroyEl(a),l.forEach(t=>t.destroy()),l.splice(0,l.length),t.onClose("Ok"===e?tI.ColorConverter.hexToRGB(r.value):void 0)}})}}var t7={};t7=x("dwTKp").getBundleURL("lrLBb")+"tool-picker.d0e69c3a.svg";const et="klecks-theme",ee=new class{updateTheme(){let t=this.theme;this.theme=this.storedTheme||this.mediaQueryTheme,this.theme!==t&&(document.body.classList.toggle("kl-theme-dark","dark"===this.theme),this.listeners.forEach(t=>t()))}readLocalStorage(){let t=localStorage.getItem(et);return t&&("string"!=typeof t||["dark","light"].includes(t))||(t=void 0,localStorage.removeItem(et)),t}isDark(){return"dark"===this.theme}addIsDarkListener(t){this.listeners.includes(t)||this.listeners.push(t)}removeIsDarkListener(t){for(let e=0;e<this.listeners.length;e++)if(this.listeners[e]===t){this.listeners.splice(e,1);return}}getMediaQueryTheme(){return this.mediaQueryTheme}getStoredTheme(){return this.storedTheme}setStoredTheme(t){t?localStorage.setItem(et,t):localStorage.removeItem(et),this.storedTheme=t,this.updateTheme()}constructor(){this.mediaQueryTheme="light",this.theme="light",this.listeners=[],this.mediaQueryTheme=M()?"dark":"light",L(()=>{this.mediaQueryTheme=M()?"dark":"light",this.updateTheme()}),this.storedTheme=this.readLocalStorage(),addEventListener("storage",t=>{t.key===et&&(this.storedTheme=this.readLocalStorage(),this.updateTheme())}),this.updateTheme()}},ei=(ee.isDark(),255);class es{updateSV(){let t=tI.ctx(this.canvasSV);if(!t)throw Error("couldnt create canvas");for(let e=0;e<this.canvasSV.height;e+=1){let i=t.createLinearGradient(0,0,this.canvasSV.width,0),s=tI.ColorConverter.toRGB(new tI.HSV(this.color.h,1,100-e/this.canvasSV.height*100)),r=tI.ColorConverter.toRGB(new tI.HSV(this.color.h,100,100-e/this.canvasSV.height*100));i.addColorStop(0,"#"+tI.ColorConverter.toHexString(s)),i.addColorStop(1,"#"+tI.ColorConverter.toHexString(r)),t.fillStyle="#ff0000",t.fillStyle=i,t.fillRect(0,e,this.canvasSV.width,1)}}updateSVPointer(){let t=this.color.s/100*this.width-4,e=(1-this.color.v/100)*this.heightSV-4;tI.css(this.pointerSV,{left:t+"px",top:e+"px"})}updateHPointer(){this.pointerH.style.left=this.color.h/359.999*this.width-1+"px"}setColor(t){this.color=tI.ColorConverter.toHSV(new tI.RGB(t.r,t.g,t.b)),this.updateSV(),this.updateSVPointer(),this.updateHPointer()}getColor(){return tI.ColorConverter.toRGB(this.color)}getElement(){return this.rootEl}destroy(){this.svPointerListener.destroy(),this.hPointerListener.destroy()}end(){this.svPointerId=null,this.hPointerId=null}constructor(t){this.rootEl=tI.el({css:{width:t.width+"px",position:"relative",overflow:"hidden",userSelect:"none"}}),this.rootEl.oncontextmenu=t=>{t.preventDefault()},this.color=tI.ColorConverter.toHSV(new tI.RGB(t.color.r,t.color.g,t.color.b)),this.width=t.width,this.heightSV=t.heightSV,this.canvasSV=tI.canvas(10,10),tI.css(this.canvasSV,{width:this.width+"px",height:this.heightSV+"px",cursor:"crosshair"}),this.updateSV();let e=tI.canvas(t.width,t.heightH);e.style.cursor="ew-resize",(()=>{let i=tI.ctx(e),s=i.createLinearGradient(0,0,t.width,0);for(let t=0;t<1;t+=.01){let e=tI.ColorConverter.toRGB(new tI.HSV(360*t,100,100));s.addColorStop(t,"rgba("+parseInt(""+e.r)+", "+parseInt(""+e.g)+", "+parseInt(""+e.b)+", 1)")}i.fillStyle=s,i.fillRect(0,0,t.width,t.heightH)})(),tI.css(this.canvasSV,{width:t.width+"px",height:t.heightSV+"px",overflow:"hidden",position:"relative"}),this.canvasSV.style.cssFloat="left",e.style.cssFloat="left",this.rootEl.append(this.canvasSV,e),this.pointerSV=tI.el({parent:this.rootEl,css:{width:"8px",height:"8px",borderRadius:"8px",position:"absolute",pointerEvents:"none",boxShadow:"0 0 0 1px #000, inset 0 0 0 1px #fff"}}),this.pointerH=tI.el({parent:this.rootEl,css:{width:"0",height:t.heightH+"px",borderLeft:"1px solid #fff",borderRight:"1px solid #000",position:"absolute",top:t.heightSV+"px",pointerEvents:"none"}}),this.updateSVPointer(),this.updateHPointer();let i={h:0,s:0,v:0};this.svPointerId=null,this.svPointerListener=new tI.PointerListener({target:this.canvasSV,fixScribble:!0,onPointer:e=>{if("pointerdown"===e.type&&(tI.unfocusAnyInput(),this.svPointerId=e.pointerId,"left"===e.button?(i.s=e.relX/t.width*100,i.v=100-e.relY/t.heightSV*100,this.color=new tI.HSV(this.color.h,i.s,i.v),this.updateSVPointer(),t.callback(tI.ColorConverter.toRGB(this.color))):(i.s=this.color.s,i.v=this.color.v)),"pointermove"===e.type&&["left","right"].includes(""+e.button)&&this.svPointerId===e.pointerId){let s=1;"right"===e.button&&(s=.5),i.s+=e.dX/t.width*100*s,i.v-=e.dY/t.heightSV*100*s,this.color=new tI.HSV(this.color.h,i.s,i.v),this.updateSVPointer(),t.callback(tI.ColorConverter.toRGB(this.color))}"pointerup"===e.type&&(this.svPointerId=null)}}),this.hPointerId=null,this.hPointerListener=new tI.PointerListener({target:e,fixScribble:!0,onPointer:e=>{if("pointerdown"===e.type&&(this.hPointerId=e.pointerId,"left"===e.button?(i.h=e.relX/t.width*359.99,this.color=new tI.HSV(i.h,this.color.s,this.color.v),this.updateSV(),this.updateHPointer(),t.callback(tI.ColorConverter.toRGB(this.color))):i.h=this.color.h),"pointermove"===e.type&&["left","right"].includes(""+e.button)&&this.hPointerId===e.pointerId){let s=tq(Math.abs(e.pageY-e.downPageY),"right"===e.button);i.h+=e.dX/t.width*359.99*s,"right"===e.button&&(i.h=i.h%359.99,i.h<0&&(i.h+=359.99)),i.h=Math.min(359.99,i.h),this.color=new tI.HSV(i.h,this.color.s,this.color.v),this.updateSV(),this.updateHPointer(),t.callback(tI.ColorConverter.toRGB(this.color))}"pointerup"===e.type&&(this.hPointerId=null)}}),tI.el({parent:this.rootEl,css:{clear:"both"}})}}class er{getEl(){return this.rootEl}setActive(t){this.sliderPoint.style.backgroundColor=t?"#fff":"#eaeaea"}destroy(){this.pointerListener.destroy()}constructor(t){let e;this.rootEl=tI.el({css:{position:"relative"}}),tI.el({parent:this.rootEl,className:"kl-point-slider__line",css:{marginTop:parseInt(""+(t.pointSize/2-1))+"px",width:t.width+"px"}}),this.sliderPoint=tI.el({parent:this.rootEl,className:"kl-point-slider__point"}),tI.el({parent:this.sliderPoint,css:{margin:"-7px 0 0 -7px",width:"calc(100% + 14px)",height:"calc(100% + 7px)"}});let i=()=>{tI.css(this.sliderPoint,{left:e+"px"})},s=()=>e/(t.width-t.pointSize);{let r,a;e=tI.clamp(t.init*(t.width-t.pointSize),0,t.width-t.pointSize),tI.css(this.sliderPoint,{width:t.pointSize+"px",height:t.pointSize+"px",borderRadius:t.pointSize+"px"}),i(),this.pointerListener=new tI.PointerListener({target:this.sliderPoint,fixScribble:!0,onPointer:n=>{"pointerdown"===n.type&&"left"===n.button?(r=!0,a=e,i(),n.eventStopPropagation()):"pointermove"===n.type&&"left"===n.button&&(n.eventStopPropagation(),a+=n.dX,e=parseInt(""+tI.clamp(a,0,t.width-t.pointSize)),i(),t.callback(s(),r,!1),r=!1),"pointerup"===n.type&&(n.eventStopPropagation(),i(),t.callback(s(),!1,!0))}})}}}class ea{getElement(){return this.rootEl}getValue(){return this.colorArr[this.selectedIndex]}destroy(){this.rootEl.remove(),this.buttonArr.forEach(t=>{tI.destroyEl(t.el)}),this.buttonArr.splice(0,this.buttonArr.length),ee.removeIsDarkListener(this.updateCheckerboard),this.colorInput.onchange=null,this.colorInput.oninput=null}constructor(t){var e;this.colorArr=[],this.selectedIndex=0,this.rootEl=tI.el({content:t.label?t.label:"",title:null!==(e=t.title)&&void 0!==e?e:void 0,css:{display:"flex",alignItems:"center",gap:"7px"}}),this.buttonArr=[];let i=tI.createCheckerDataUrl(5,void 0,ee.isDark());this.onColorInputChange=()=>{let e=this.selectedIndex,i=this.colorArr[e];if(!i||i.a<1)return;let s=this.colorInput.value;this.buttonArr[this.selectedIndex].el.style.backgroundColor=s,this.colorArr[e]={...tm.hexToRGB(s),a:1},t.onChange(this.colorArr[e])},this.colorInput=tI.el({tagName:"input",custom:{type:"color",tabIndex:"-1"}}),this.colorInput.onchange=this.onColorInputChange,this.colorInput.oninput=this.onColorInputChange;for(let e=0;e<t.colorArr.length;e++){let i=t.colorArr[e],s=!1;for(let t=0;t<this.colorArr.length;t++){let e=this.colorArr[t];if(e===i||null!==e&&null!==i&&e.r===i.r&&e.g===i.g&&e.b===i.b&&e.a===i.a){s=!0;break}}!s&&(this.colorArr.push(i),"initialIndex"in t&&t.initialIndex===e&&(this.selectedIndex=this.colorArr.length-1))}for(let e=0;e<this.colorArr.length;e++)(e=>{let r=this.colorArr[e],a=tI.el({parent:this.rootEl,content:r?"":"X",className:"kl-color-option",css:{width:"22px",height:"22px",backgroundColor:r?tI.ColorConverter.toRgbaStr(r):"transparent",lineHeight:"23px"},onClick:i=>{if(this.selectedIndex===e){r&&1===r.a&&(this.colorInput.showPicker?this.colorInput.showPicker():this.colorInput.click());return}i.preventDefault(),this.selectedIndex=e,s(),t.onChange(this.colorArr[e])}});r&&0===r.a&&(a.style.backgroundImage="url("+i+")");let n=t=>{a.classList.toggle("kl-color-option--active",t)};this.buttonArr.push({el:a,setIsSelected:n})})(e);this.rootEl.append(tJ(",w-0,h-0,overflow-hidden",[this.colorInput]));let s=()=>{for(let t=0;t<this.buttonArr.length;t++)this.buttonArr[t].setIsSelected(t===this.selectedIndex)};s(),this.updateCheckerboard=()=>{let t=tI.createCheckerDataUrl(5,void 0,ee.isDark());this.buttonArr.forEach((e,i)=>{let s=this.colorArr[i];s&&0===s.a&&(e.el.style.backgroundImage="url("+t+")")})},ee.addIsDarkListener(this.updateCheckerboard)}}class en{getIndex(){for(let t=0;t<this.optionArr.length;t++)if(this.optionArr[t].id===this.selectedId)return t;return -1}update(){for(let t=0;t<this.optionArr.length;t++)this.optionArr[t].el.classList.toggle("kl-option-selected",this.optionArr[t].id===this.selectedId)}getElement(){return this.rootEl}getValue(){return this.selectedId}next(){this.selectedId=this.optionArr[(this.getIndex()+1)%this.optionArr.length].id,this.update(),this.onChange&&this.onChange(this.selectedId)}previous(){this.selectedId=this.optionArr[(this.optionArr.length+this.getIndex()-1)%this.optionArr.length].id,this.update(),this.onChange&&this.onChange(this.selectedId)}destroy(){this.rootEl.remove(),this.optionArr.forEach(t=>{tI.destroyEl(t.el)}),this.optionArr.splice(0,this.optionArr.length)}constructor(t){this.rootEl=tI.el();let e=tI.el({parent:this.rootEl,className:"kl-option-wrapper",css:{display:"flex"}});t.onChange&&(this.onChange=t.onChange),this.optionArr=[],this.selectedId="initialId"in t&&void 0!==t.initId?t.initId:t.optionArr[0].id;let i=i=>{let s=["kl-option"];t.isSmall&&s.push("kl-option--small"),"string"!=typeof i.label&&(s.push("kl-option--custom-el"),tI.css(i.label,{display:"block",pointerEvents:"none"}));let r={id:i.id,el:tI.el({parent:e,content:i.label,className:s.join(" "),onClick:()=>{this.selectedId!==r.id&&(this.selectedId=r.id,this.update(),this.onChange&&this.onChange(this.selectedId))}})};i.title&&(r.el.title=i.title),this.optionArr.push(r)};for(let e=0;e<t.optionArr.length;e++)i(t.optionArr[e]);this.update(),t.changeOnInit&&setTimeout(()=>{this.onChange&&this.onChange(this.selectedId)},0)}}var eo={};function el(t,e){return Array.isArray(e)?[t.a*e[0]+t.c*e[1]+t.e,t.b*e[0]+t.d*e[1]+t.f]:{x:t.a*e.x+t.c*e.y+t.e,y:t.b*e.x+t.d*e.y+t.f}}function eh(t){let{a:e,b:i,c:s,d:r,e:a,f:n}=t,o=e*r-i*s;return{a:r/o,b:-(i/o),c:-(s/o),d:e/o,e:-((r*a-s*n)/o),f:(i*a-e*n)/o}}function ec(t){return void 0===t}function ep(t,e=0){return{a:1,c:0,e:t,b:0,d:1,f:e}}function ed(...t){t=Array.isArray(t[0])?t[0]:t;let e=(t,e)=>({a:t.a*e.a+t.c*e.b,c:t.a*e.c+t.c*e.d,e:t.a*e.e+t.c*e.f+t.e,b:t.b*e.a+t.d*e.b,d:t.b*e.c+t.d*e.d,f:t.b*e.e+t.d*e.f+t.f});switch(t.length){case 0:throw Error("no matrices provided");case 1:return t[0];case 2:return e(t[0],t[1]);default:{let[i,s,...r]=t;return ed(e(i,s),...r)}}}function eu(...t){return ed(...t)}eo=x("dwTKp").getBundleURL("lrLBb")+"angle.f0b557ac.svg";const{cos:eg,sin:em,PI:ey}=Math;function ef(t,e,i){let s=eg(t),r=em(t),a={a:s,c:-r,e:0,b:r,d:s,f:0};return ec(e)||ec(i)?a:ed([ep(e,i),a,ep(-e,-i)])}function ex(t,e,i,s){ec(e)&&(e=t);let r={a:t,c:0,e:0,b:0,d:e,f:0};return ec(i)||ec(s)?r:ed([ep(i,s),r,ep(-i,-s)])}const{tan:ev}=Math;function eb(t,e,i,s){var r=Error.call(this,t);return Object.setPrototypeOf&&Object.setPrototypeOf(r,eb.prototype),r.expected=e,r.found=i,r.location=s,r.name="SyntaxError",r}function ew(t,e,i){return(i=i||" ",t.length>e)?t:(e-=t.length,t+(i+=i.repeat(e)).slice(0,e))}function eC(t){let e="scale"in t?t.scale:t.scaleX,i="scale"in t?t.scale:t.scaleY;return eu(ep(t.x,t.y),ef(t.angleDeg/180*Math.PI),ex(e,i))}function eS(t,e){return Math.round(e*t)/e}!function(t,e){function i(){this.constructor=t}i.prototype=e.prototype,t.prototype=new i}(eb,Error),eb.prototype.format=function(t){var e="Error: "+this.message;if(this.location){var i,s=null;for(i=0;i<t.length;i++)if(t[i].source===this.location.source){s=t[i].text.split(/\r\n|\n|\r/g);break}var r=this.location.start,a=this.location.source&&"function"==typeof this.location.source.offset?this.location.source.offset(r):r,n=this.location.source+":"+a.line+":"+a.column;if(s){var o=this.location.end,l=ew("",a.line.toString().length," "),h=s[r.line-1],c=(r.line===o.line?o.column:h.length+1)-r.column||1;e+="\n --> "+n+"\n"+l+" |\n"+a.line+" | "+h+"\n"+l+" | "+ew("",r.column-1," ")+ew("",c,"^")}else e+="\n at "+n}return e},eb.buildMessage=function(t,e){var i={literal:function(t){return'"'+r(t.text)+'"'},class:function(t){var e=t.parts.map(function(t){return Array.isArray(t)?a(t[0])+"-"+a(t[1]):a(t)});return"["+(t.inverted?"^":"")+e.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(t){return t.description}};function s(t){return t.charCodeAt(0).toString(16).toUpperCase()}function r(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(t){return"\\x0"+s(t)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(t){return"\\x"+s(t)})}function a(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(t){return"\\x0"+s(t)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(t){return"\\x"+s(t)})}function n(t){return i[t.type](t)}return"Expected "+function(t){var e,i,s=t.map(n);if(s.sort(),s.length>0){for(e=1,i=1;e<s.length;e++)s[e-1]!==s[e]&&(s[i]=s[e],i++);s.length=i}switch(s.length){case 1:return s[0];case 2:return s[0]+" or "+s[1];default:return s.slice(0,-1).join(", ")+", or "+s[s.length-1]}}(t)+" but "+(e?'"'+r(e)+'"':"end of input")+" found."};class ek{render(){let t=ee.isDark(),e={...this.transform,x:this.transform.x,y:this.transform.y,scale:this.transform.scale};this.doResize&&(this.doResize=!1,this.resFactor=this.useNativeResolution?devicePixelRatio:1,this.canvas.width=Math.round(this.width*this.resFactor),this.canvas.height=Math.round(this.height*this.resFactor));let i={x:Math.round(e.x),y:Math.round(e.y),scaleX:eS(e.scale,this.project.width),scaleY:eS(e.scale,this.project.height),angleDeg:e.angleDeg},s=eC(i);if(this.ctx.save(),this.ctx.imageSmoothingEnabled=!1,this.drawBackground?(this.ctx.fillStyle=t?"rgb(33, 33, 33)":"rgb(158,158,158)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)):(this.ctx.fillStyle=this.pattern,this.ctx.fillRect(0,0,this.width,this.height)),this.ctx.translate(i.x,i.y),this.ctx.scale(i.scaleX,i.scaleY),this.ctx.rotate(i.angleDeg/180*Math.PI),this.drawBackground){this.ctx.save(),this.ctx.fillStyle=ee.isDark()?"rgba(255,255,255,0.25)":"rgba(0,0,0,0.2)";let t=1/i.scaleX,e=1/i.scaleY;this.ctx.fillRect(-t,-e,this.project.width+2*t,this.project.height+2*e),this.ctx.fillStyle=this.pattern,this.pattern.setTransform(eh(s)),this.ctx.fillRect(0,0,this.project.width,this.project.height),this.ctx.restore()}this.project.layers.forEach(t=>{if(!t.isVisible||!t.opacity)return;this.ctx.save(),this.ctx.globalCompositeOperation=t.mixModeStr,this.ctx.globalAlpha=t.opacity;let e={};if("function"==typeof t.image){let r=t.image(i,this.canvas.width,this.canvas.height);"image"in r&&"transform"in r?(e=r.image,this.ctx.setTransform(eu(s,r.transform))):e=r}else e=t.image;this.ctx.drawImage(e,0,0),this.ctx.restore()}),this.ctx.restore()}setSize(t,e){this.doResize=!0,this.width=t,this.height=e,tI.css(this.canvas,{width:this.doFillParent?"100%":this.width+"px",height:this.doFillParent?"100%":this.height+"px"})}setTransform(t){this.transform={...t}}getTransform(){return{...this.transform}}setUseNativeResolution(t){this.useNativeResolution=t,this.doResize=!0}getUseNativeResolution(){return this.useNativeResolution}getElement(){return this.canvas}destroy(){tI.freeCanvas(this.canvas),ee.removeIsDarkListener(this.onIsDark),window.removeEventListener("resize",this.resizeListener)}constructor(t){this.doResize=!0,this.onIsDark=()=>{this.pattern=E(this.ctx.createPattern(tI.createCheckerCanvas(10,ee.isDark()),"repeat")),this.render()},this.oldDPR=devicePixelRatio,this.resizeListener=()=>{devicePixelRatio!==this.oldDPR&&(this.canvas.style.imageRendering=Math.round(devicePixelRatio)!==devicePixelRatio?"":"pixelated",this.oldDPR=devicePixelRatio)},this.width=t.width,this.height=t.height,this.project=t.project,this.useNativeResolution=!!t.useNativeResolution,this.drawBackground=!!t.drawBackground,this.doFillParent=!!t.fillParent,this.transform={...t.transform},this.resFactor=this.useNativeResolution?devicePixelRatio:1,this.canvas=tI.canvas(this.width*this.resFactor,this.height*this.resFactor),this.ctx=tI.ctx(this.canvas),tI.css(this.canvas,{width:this.doFillParent?"100%":this.width+"px",height:this.doFillParent?"100%":this.height+"px",imageRendering:Math.round(devicePixelRatio)!==devicePixelRatio?void 0:"pixelated",display:"block"}),window.addEventListener("resize",this.resizeListener),this.pattern=E(this.ctx.createPattern(tI.createCheckerCanvas(10,ee.isDark()),"repeat")),ee.addIsDarkListener(this.onIsDark)}}var eE={};eE=x("dwTKp").getBundleURL("lrLBb")+"tool-zoom-in.d413f042.svg";var eI={};eI=x("dwTKp").getBundleURL("lrLBb")+"tool-zoom-out.299f4d1f.svg";var eA={};eA=x("dwTKp").getBundleURL("lrLBb")+"viewport-reset.25476ab5.svg";var eT={};eT=x("dwTKp").getBundleURL("lrLBb")+"tool-hand.e7fc81b9.svg";var eM={};function eL(t,e){let i=Math.log2(t)/Math.abs(e);return i+=e>0?1:-1,Math.pow(2,i=Math.round(i)*Math.abs(e))}function eR(t,e,i,s){let r=el(eu(ex(-i,-i),ef(s/180*Math.PI)),e);return r.x+=t.x,r.y+=t.y,{x:r.x,y:r.y,scale:i,angleDeg:s}}function eP(t,e){let i=el(eh(eC(t)),e);return{viewportP:e,canvasP:i,scale:t.scale,angleDeg:t.angleDeg}}eM=x("dwTKp").getBundleURL("lrLBb")+"edit-pencil.d7636d97.svg";class eD{requestRerender(){this.doRender=!0}resetOrZoom(t,e){if(this.isReset){this.isReset=!1;let i=el(eh(eC(this.viewport.getTransform())),{x:t,y:e});this.viewport.setTransform(eR({x:this.width/2,y:this.height/2},i,1,0)),this.requestRerender()}else this.reset()}reset(){let t=tI.fitInto(this.project.width,this.project.height,this.width-2*this.padding,this.height-2*this.padding).width/this.project.width;this.viewport.setTransform(eR({x:this.width/2,y:this.height/2},{x:this.project.width/2,y:this.project.height/2},t,0)),this.isReset=!0,this.requestRerender()}transformCanvas(t){if("translate"===t.type){let e=this.viewport.getTransform();if(0===t.x&&0===t.y)return;this.viewport.setTransform({...e,x:e.x+t.x,y:e.y+t.y})}else if("zoom"===t.type){var e,i;let s=this.viewport.getTransform(),r=this.viewport.getElement().getBoundingClientRect();t.vX=null!==(e=t.vX)&&void 0!==e?e:r.width/2,t.vY=null!==(i=t.vY)&&void 0!==i?i:r.height/2;let a=eP(s,{x:t.vX,y:t.vY});a.scale*=t.fac,this.viewport.setTransform(eR(a.viewportP,a.canvasP,a.scale,a.angleDeg))}this.isReset=!1,this.requestRerender()}render(){this.requestRerender()}setTransform(t){this.viewport.setTransform(t),this.requestRerender(),this.isReset=!1}getTransform(){return this.viewport.getTransform()}onPointer(t){this.pointerChain.chainIn(t)}getElement(){return this.rootEl}destroy(){void 0!==this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.viewport.destroy(),this.viewportPointerListener.destroy(),this.rootEl.remove(),this.modeToggle&&this.modeToggle.destroy()}constructor(t){var e;let i;this.isReset=!0,this.doRender=!1,this.lastEmittedTransform={x:0,y:0,scale:0,angleDeg:0},this.renderLoop=()=>{if(this.animationFrameId=requestAnimationFrame(this.renderLoop),this.doRender){this.doRender=!1,this.viewport.render();let t=this.viewport.getTransform();this.onTransformChange&&JSON.stringify(this.lastEmittedTransform)!==JSON.stringify(t)&&(this.onTransformChange(t),this.lastEmittedTransform=t)}},this.onWheel=t=>{let e=this.viewport.getElement().getBoundingClientRect(),i=t.pageX-e.x,s=t.pageY-e.y,r=this.viewport.getTransform().scale,a=eL(r,-t.deltaY/2);this.transformCanvas({type:"zoom",vX:i,vY:s,fac:a/r})},this.width=t.width,this.height=t.height,this.project=t.project,this.onTransformChange=t.onTransformChange,this.padding=null!==(e=t.padding)&&void 0!==e?e:10;let s=tI.fitInto(this.project.width,this.project.height,this.width-2*this.padding,this.height-2*this.padding).width/this.project.width;this.viewport=new ek({width:this.width,height:this.height,transform:eR({x:this.width/2,y:this.height/2},{x:this.project.width/2,y:this.project.height/2},s,0),project:this.project,useNativeResolution:!1,drawBackground:!0});let r=new tS({onDoubleTap:t=>{let e=eC(this.viewport.getTransform()),i=el(e,{x:0,y:0}),s=el(e,{x:this.project.width,y:this.project.height}),r=tI.isInsideRect({x:t.relX,y:t.relY},{x:i.x,y:i.y,width:s.x-i.x,height:s.y-i.y});(!this.isReset||r)&&this.resetOrZoom(t.relX,t.relY)},isInstant:!0}),a=new tC({onPinch:t=>{if("move"===t.type){i||(i=this.viewport.getTransform());let e=eP(i,{x:t.downRelX,y:t.downRelY});e.scale*=t.scale,e.viewportP.x+=t.relX-t.downRelX,e.viewportP.y+=t.relY-t.downRelY,this.viewport.setTransform(eR(e.viewportP,e.canvasP,e.scale,e.angleDeg)),this.requestRerender(),this.isReset=!1}else"end"===t.type&&(i=void 0)}});this.pointerChain=new tE({chainArr:[a,r]}),this.pointerChain.setChainOut(t=>{t.button&&["left","middle"].includes(t.button)&&this.transformCanvas({type:"translate",x:t.dX,y:t.dY})}),this.viewport.getElement().classList.add(t6({cursor:"grab",":active":{cursor:"grabbing"}})),tI.css(this.viewport.getElement(),{userSelect:"none",touchAction:"none"}),this.viewport.getElement().addEventListener("touchend",t=>(t.preventDefault(),!1)),this.viewport.getElement().addEventListener("contextmenu",t=>(t.preventDefault(),!1)),this.viewport.getElement().addEventListener("dragstart",t=>(t.preventDefault(),!1)),this.viewportPointerListener=new tr({target:this.viewport.getElement(),onPointer:t=>{this.pointerChain.chainIn(t)},onWheel:this.onWheel,maxPointers:2}),this.viewport.getElement().addEventListener("wheel",t=>{t.preventDefault()}),t.hasEditMode&&(this.modeToggle=new en({optionArr:["edit","hand"].map(e=>{var i;let s=tI.el({className:"dark-invert",css:{width:"28px",height:"28px",backgroundSize:"contain",margin:"5px",backgroundImage:`url(${"edit"===e?null!==(i=t.editIcon)&&void 0!==i?i:m(eM):m(eT)})`,backgroundPosition:"center",backgroundRepeat:"no-repeat"}});return{id:e,label:s,title:"edit"===e?tB("tab-edit"):tB("tool-hand")}}),initId:"edit",onChange:e=>{t.onModeChange&&t.onModeChange(e)}}));let n=t6(!1===t.hasBorder?{}:{borderTop:"1px solid #7f7f7f",borderBottom:"1px solid #7f7f7f",".kl-theme-dark &":{borderTop:"1px solid #636363",borderBottom:"1px solid #636363"}});this.rootEl=tJ({className:n,css:{position:"relative"}},[this.viewport.getElement(),...this.modeToggle?[tJ(",pos-absolute,left-5,top-5,z-1,pointer-auto",[this.modeToggle.getElement()])]:[],tJ(",pos-absolute,right-5,bottom-5,flex,flexCol,gap-5,z-1,pointer-auto",[tJ({tagName:"button",title:tB("hand-reset"),onClick:()=>{this.reset()},content:`<img alt="reset" height="20" src="${m(eA)}">`,noRef:!0}),tJ({tagName:"button",title:tB("zoom-in"),onClick:()=>{let t=this.viewport.getTransform().scale,e=eL(t,1);this.transformCanvas({type:"zoom",fac:e/t})},content:`<img alt="zoom-in" height="20" src="${m(eE)}">`,noRef:!0}),tJ({tagName:"button",title:tB("zoom-out"),onClick:()=>{let t=this.viewport.getTransform().scale,e=eL(t,-1);this.transformCanvas({type:"zoom",fac:e/t})},content:`<img alt="zoom-out" height="20" src="${m(eI)}">`,noRef:!0})])]),this.renderLoop()}}var eB={};eB=x("dwTKp").getBundleURL("lrLBb")+"edit-crop.16c534dd.svg";class eO{resetCrop(){this.crop={x:0,y:0,width:this.canvas.width,height:this.canvas.height}}getViewportSelectionRect(){let t=this.preview.getTransform(),e=el(eC(t),this.crop);return{x:e.x,y:e.y,width:this.crop.width*t.scale,height:this.crop.height*t.scale}}updateCroppedCanvas(){this.croppedCanvas.width=Math.round(this.crop.width),this.croppedCanvas.height=Math.round(this.crop.height),tI.ctx(this.croppedCanvas).drawImage(this.canvas,Math.round(-this.crop.x),Math.round(-this.crop.y)),this.croppedImage&&(this.croppedImage.src=this.croppedCanvas.toDataURL("image/png")),this.onChange&&this.onChange(this.croppedCanvas.width,this.croppedCanvas.height)}updateSelectionRect(){let t=this.getViewportSelectionRect();tI.css(this.selectionRectEl,{left:t.x+"px",top:t.y+"px",width:t.width+"px",height:t.height+"px",display:this.isReset()?"none":""}),this.onChange&&this.onChange(Math.round(this.crop.width),Math.round(this.crop.height))}getEl(){return this.rootEl}reset(){this.resetCrop(),this.updateCroppedCanvas(),this.updateSelectionRect()}destroy(){this.rootEl.remove(),this.eventTarget.style.removeProperty("width"),this.eventTarget.style.removeProperty("height"),this.keyListener.destroy(),this.pointerListener.destroy(),this.preview.destroy()}isReset(){return 0===this.crop.x&&0===this.crop.y&&this.crop.width===this.canvas.width&&this.crop.height===this.canvas.height}getRect(){return tI.copyObj(this.crop)}getCroppedCanvas(){return this.croppedCanvas}constructor(t){let e,i;this.crop={x:0,y:0,width:0,height:0},this.mode="edit",this.rootEl=tI.el({className:"kl-edit-crop-preview",css:{position:"relative",height:t.height+"px",width:t.width+"px",overflow:"hidden"}}),t.onChange&&(this.onChange=t.onChange),this.canvas=t.canvas,this.resetCrop();let s=t=>tI.isInsideRect(t,this.getViewportSelectionRect());this.croppedCanvas=tI.canvas(),this.eventTarget=this.croppedCanvas,t.isNotCopy||(this.croppedImage=new Image,this.eventTarget=this.croppedImage),tI.css(this.eventTarget,{height:t.height+"px",width:t.width+"px"}),this.rootEl.append(this.eventTarget),this.updateCroppedCanvas(),this.preview=new eD({width:t.width,height:t.height-2,project:{width:t.canvas.width,height:t.canvas.height,layers:[{image:t.canvas,opacity:1,isVisible:!0,mixModeStr:"source-over",hasClipping:!1}]},hasEditMode:!0,onModeChange:t=>{this.mode=t,this.preview.getElement().style.pointerEvents="edit"===t?"none":"",this.rootEl.title="edit"===t?tB("crop-drag-to-crop"):""},onTransformChange:()=>this.updateSelectionRect(),padding:20,hasBorder:!1,editIcon:m(eB)}),tI.css(this.preview.getElement(),{position:"absolute",left:"0",top:"0",overflow:"hidden",pointerEvents:"none"}),this.preview.render(),this.rootEl.append(this.preview.getElement()),this.selectionRectEl=tI.el({parent:this.preview.getElement(),className:"kl-edit-crop-preview__sel"}),this.updateSelectionRect();let r=(t,e)=>{let i=eh(eC(this.preview.getTransform())),s={x:Math.min(t.x,e.x),y:Math.min(t.y,e.y)},r={x:Math.max(t.x,e.x),y:Math.max(t.y,e.y)},a=el(i,s),n=el(i,r);return a.x=Y(Math.floor(a.x),0,this.canvas.width),a.y=Y(Math.floor(a.y),0,this.canvas.height),n.x=Y(Math.ceil(n.x),0,this.canvas.width),n.y=Y(Math.ceil(n.y),0,this.canvas.height),{x:a.x,y:a.y,width:n.x-a.x,height:n.y-a.y}},a=null,n=!1,o=!1,l=new tE({chainArr:[new tk]});l.setChainOut(t=>{if("pointerdown"===t.type&&"left"===t.button)t.eventPreventDefault(),n=!0,e={x:t.relX,y:t.relY},!this.isReset()&&s(e)?a={x:this.crop.x,y:this.crop.y,width:this.crop.width,height:this.crop.height}:this.crop=r(e,e);else if("pointermove"===t.type&&"left"===t.button){if(t.eventPreventDefault(),o=!0,a){let i=this.preview.getTransform();this.crop.x=a.x+Math.round((t.relX-e.x)/i.scale),this.crop.y=a.y+Math.round((t.relY-e.y)/i.scale),this.crop.x=tI.clamp(this.crop.x,0,this.canvas.width-this.crop.width),this.crop.y=tI.clamp(this.crop.y,0,this.canvas.height-this.crop.height)}else this.crop=r(e,{x:t.relX,y:t.relY});this.updateSelectionRect()}else"pointerup"===t.type&&e&&(t.eventPreventDefault(),n=!1,a=null,e=null,0!==this.crop.width&&0!==this.crop.height&&o||(this.resetCrop(),this.updateSelectionRect()),o=!1,i=setTimeout(()=>this.updateCroppedCanvas(),1))}),this.pointerListener=new tI.PointerListener({target:this.eventTarget,fixScribble:!0,onWheel:t=>{this.preview.onWheel(t)},onPointer:t=>{if("hand"===this.mode){t.eventPreventDefault(),this.preview.onPointer(t);return}l.chainIn(t)},maxPointers:2}),this.keyListener=new tI.KeyListener({onDown:(t,e)=>{if(n)return;let s=!1,r=Math.max(1,1/this.preview.getTransform().scale),a=this.keyListener.isPressed("shift");"left"===t&&(a?this.crop.width=tI.clamp(this.crop.width-r,1,this.canvas.width-this.crop.x):this.crop.x=tI.clamp(this.crop.x-r,0,this.canvas.width-this.crop.width),s=!0),"right"===t&&(a?this.crop.width=tI.clamp(this.crop.width+r,1,this.canvas.width-this.crop.x):this.crop.x=tI.clamp(this.crop.x+r,0,this.canvas.width-this.crop.width),s=!0),"up"===t&&(a?this.crop.height=tI.clamp(this.crop.height-r,1,this.canvas.height-this.crop.y):this.crop.y=tI.clamp(this.crop.y-r,0,this.canvas.height-this.crop.height),s=!0),"down"===t&&(a?this.crop.height=tI.clamp(this.crop.height+r,1,this.canvas.height-this.crop.y):this.crop.y=tI.clamp(this.crop.y+r,0,this.canvas.height-this.crop.height),s=!0),s&&(e.preventDefault(),this.updateSelectionRect(),clearTimeout(i),i=setTimeout(()=>this.updateCroppedCanvas(),100))}})}}function ez(i,s,r,a,n){if(t=r%i+a,e=Math.floor(r/i)+n,!(t<0)&&!(e<0)&&!(t>=i)&&!(e>=s))return e*i+t}function eV(t,e,i,s,r,a,n){return void 0!==n&&255!==e[n]&&!!(t[4*n]===r[0]&&t[4*n+1]===r[1]&&t[4*n+2]===r[2]&&t[4*n+3]===r[3]||a>0&&Math.abs(t[4*n]-r[0])<=a&&Math.abs(t[4*n+1]-r[1])<=a&&Math.abs(t[4*n+2]-r[2])<=a&&Math.abs(t[4*n+3]-r[3])<=a)&&(e[n]=255,!0)}function eH(t,e,i,s,r,a,n,o){s=Math.round(s),r=Math.round(r);let l=new Uint8Array(new ArrayBuffer(e*i));return!function(t,e,i,s,r,a,n,o,l){let h,c,p,d,u,g,m,y,f,x,v,b;let w=[t[(a*i+r)*4],t[(a*i+r)*4+1],t[(a*i+r)*4+2],t[(a*i+r)*4+3]];if(l){let o,l;let h=[];for(h.push(a*i+r),e[a*i+r]=255;h.length;)l=ez(i,s,o=h.pop(),-1,0),eV(t,e,i,s,w,n,l)&&h.push(l),l=ez(i,s,o,1,0),eV(t,e,i,s,w,n,l)&&h.push(l),l=ez(i,s,o,0,-1),eV(t,e,i,s,w,n,l)&&h.push(l),l=ez(i,s,o,0,1),eV(t,e,i,s,w,n,l)&&h.push(l)}else for(let r=0;r<i*s;r++)eV(t,e,i,s,w,n,r);if(0!==o){for(let t=0;t<i;t++)for(let r=0;r<s;r++)255===e[r*i+t]&&(h=t,c=t,p=r,d=r,u=255!==e[r*i+t-1],g=255!==e[(r-1)*i+t-1],m=255!==e[(r-1)*i+t],y=255!==e[(r-1)*i+t+1],f=255!==e[r*i+t+1],x=255!==e[(r+1)*i+t+1],v=255!==e[(r+1)*i+t],b=255!==e[(r+1)*i+t-1],u&&(h=t-o),u&&g&&m&&(h=t-o,p=r-o),m&&(p=Math.min(p,r-o)),m&&y&&f&&(p=Math.min(p,r-o),c=t+o),f&&(c=Math.max(c,t+o)),f&&x&&v&&(c=Math.max(c,t+o),d=Math.max(d,r+o)),v&&(d=Math.max(d,r+o)),v&&b&&u&&(h=Math.min(h,t-o),d=Math.max(d,r+o)),(u||g||m||y||f||x||v||b)&&function(t,e,i,s,r,a){for(let n=i;n<=r;n++)for(let i=s;i<=a;i++)255!==t[i*e+n]&&(t[i*e+n]=254)}(e,i,Math.max(0,h),Math.max(0,p),Math.min(i-1,c),Math.min(s-1,d)));for(let t=0;t<i*s;t++)254===e[t]&&(e[t]=255)}}(t,l,e,i,s,r,a,n,o),{data:l}}function ej(t,e){if(["rect","ellipse","line"].includes((e={angleRad:0,isOutwards:!1,opacity:1,isEraser:!1,doLockAlpha:!1,...tI.copyObj(e)}).type)){let i,s;if(void 0===e.angleRad)throw Error("angleRad undefined");let r=void 0===e.lineWidth?-1:Math.round(e.lineWidth),a=180*e.angleRad/Math.PI;if(!e.isEraser&&void 0===e.fillRgb&&void 0===e.strokeRgb)throw Error("fillRgb and strokeRgb undefined");let n=e.isEraser?{r:255,g:255,b:255}:e.fillRgb?e.fillRgb:e.strokeRgb;t.save(),e.opacity&&(t.globalAlpha=e.opacity),e.isEraser&&(t.globalCompositeOperation="destination-out"),e.doLockAlpha&&(t.globalCompositeOperation="source-atop"),t.rotate(-e.angleRad),e.fillRgb?t.fillStyle=tI.ColorConverter.toRgbStr(n):e.strokeRgb&&(t.strokeStyle=tI.ColorConverter.toRgbStr(n),t.lineWidth=r);let o=e.x1,l=e.y1,h=e.x2,c=e.y2;if(e.isAngleSnap){let t=tI.rotate(o,l,e.angleRad/Math.PI*180),i=tI.rotate(h,c,e.angleRad/Math.PI*180),s=tI.pointsToAngleDeg(t,i)+90,r=45*Math.round(s/45),n=tI.rotateAround({x:o,y:l},{x:h,y:c},r-s);h=n.x,c=n.y,(a+r)%90==0&&(Math.round((a-r)/90)%2==0?h=o:c=l)}let p=o,d=l,u=h-o,g=c-l;if("line"!==e.type&&e.isFixedRatio){let t=tI.rotate(e.x1,e.y1,e.angleRad/Math.PI*180),i=tI.rotate(e.x2,e.y2,e.angleRad/Math.PI*180),s=t.x,r=t.y,a=i.x-t.x,n=i.y-t.y;Math.abs(a)<Math.abs(n)?n=Math.abs(a)*(n<0?-1:1):a=Math.abs(n)*(a<0?-1:1),i.x=s+a,i.y=r+n,t=tI.rotate(t.x,t.y,-e.angleRad/Math.PI*180),i=tI.rotate(i.x,i.y,-e.angleRad/Math.PI*180),o=t.x,l=t.y,h=i.x,c=i.y,p=o,d=l,u=h-o,g=c-l}if(e.isOutwards&&(p-=u,d-=g,u*=2,g*=2,o=p,l=d,h=p+u,c=d+g),"line"===e.type){let a=Math.round(o),n=Math.round(l),p=Math.round(h),d=Math.round(c),u=Math.floor(o),g=Math.floor(l),m=Math.floor(h),y=Math.floor(c);r%2==0?n===d?(i={x:u,y:n},s={x:m,y:d},u<m?s.x+=1:i.x+=1):a===p?(i={x:a,y:g},s={x:p,y:y},g<y?s.y+=1:i.y+=1):(i={x:o,y:l},s={x:h,y:c}):(i={x:u,y:g},s={x:m,y:y},g===y?(u<m?s.x+=1:i.x+=1,i.y+=.5,s.y+=.5):u===m?(g<y?s.y+=1:i.y+=1,i.x+=.5,s.x+=.5):(i.x=o,i.y=l,s.x=h,s.y=c)),i=tI.rotate(i.x,i.y,e.angleRad/Math.PI*180),s=tI.rotate(s.x,s.y,e.angleRad/Math.PI*180),t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.stroke()}else if("rect"===e.type){let n=Math.floor(o),p=Math.floor(l),d=Math.floor(h),u=Math.floor(c);a%90==0?e.fillRgb?(o%1==0&&(o+=1),l%1==0&&(l+=1),h%1==0&&(h+=1),c%1==0&&(c+=1),i={x:o<h?n:d,y:l<c?p:u},(s={x:Math.ceil((o<h?h:o)-i.x),y:Math.ceil((l<c?c:l)-i.y)}).x=i.x+s.x,s.y=i.y+s.y):r%2==0?(i={x:n,y:p},s={x:d,y:u}):(i={x:n+.5,y:p+.5},s={x:d+.5,y:u+.5}):(i={x:o,y:l},s={x:h,y:c}),i=tI.rotate(i.x,i.y,e.angleRad/Math.PI*180),(s=tI.rotate(s.x,s.y,e.angleRad/Math.PI*180)).x=s.x-i.x,s.y=s.y-i.y,e.fillRgb?t.fillRect(i.x,i.y,s.x,s.y):t.strokeRect(i.x,i.y,s.x,s.y)}else i=tI.rotate(o,l,e.angleRad/Math.PI*180),s=tI.rotate(h,c,e.angleRad/Math.PI*180),p=i.x,d=i.y,u=s.x-i.x,g=s.y-i.y,t.beginPath(),t.ellipse(p+u/2,d+g/2,Math.abs(u/2),Math.abs(g/2),0,0,2*Math.PI),e.fillRgb?t.fill():t.stroke();t.restore()}else throw Error("unknown shape")}function eF(t,e){e=tI.copyObj(e);let i=tI.ctx(t);i.save(),i.textAlign=e.align,i.letterSpacing=e.letterSpacing?e.letterSpacing+"px":"0";let s=[e.size+"px "+(e.font?e.font:"sans-serif")];e.isBold&&s.unshift("bold"),e.isItalic&&s.unshift("italic"),i.font=s.join(" "),i.fillStyle=e.fill?tI.ColorConverter.toRgbaStr(e.fill.color):"transparent",i.strokeStyle=e.stroke?tI.ColorConverter.toRgbaStr(e.stroke.color):"transparent",e.stroke&&(i.lineWidth=e.stroke.lineWidth,i.lineJoin="round"),i.translate(e.x,e.y),i.rotate(-e.angleRad);let r=e.text.split("\n").map(t=>t.replaceAll("	","    ")),a={x1:0,y1:0,x2:0,y2:0};{let t=!0;r.forEach((s,r)=>{var n;let o=i.measureText(s),l=e.size*(null!==(n=e.lineHeight)&&void 0!==n?n:1)*r,h=function(t,e){var i,s;let r=null!==(i=t.fontBoundingBoxAscent)&&void 0!==i?i:t.actualBoundingBoxAscent,a=null!==(s=t.fontBoundingBoxDescent)&&void 0!==s?s:t.actualBoundingBoxDescent;return"left"===e?{x:0,y:-r,width:t.width,height:r+a}:"right"===e?{x:-t.width,y:-r,width:t.width,height:r+a}:{x:-t.width/2,y:-r,width:t.width,height:r+a}}(o,e.align);t?(t=!1,a.x1=0+h.x,a.y1=l+h.y,a.x2=0+h.x+h.width,a.y2=l+h.y+h.height):(a.x1=Math.min(a.x1,0+h.x),a.y1=Math.min(a.y1,l+h.y),a.x2=Math.max(a.x2,0+h.x+h.width),a.y2=Math.max(a.y2,l+h.y+h.height))})}return r.forEach((t,s)=>{var r;let a=e.size*(null!==(r=e.lineHeight)&&void 0!==r?r:1)*s;i.strokeText(t,0,a)}),r.forEach((t,s)=>{var r;let a=e.size*(null!==(r=e.lineHeight)&&void 0!==r?r:1)*s;i.fillText(t,0,a)}),i.restore(),{x:a.x1,y:a.y1,width:a.x2-a.x1,height:a.y2-a.y1}}function eW(t,e){let i=tI.canvas(Math.max(1,Math.round(t.width*e)),Math.max(1,Math.round(t.height*e))),s=tI.ctx(i);s.save(),e>1&&(s.imageSmoothingEnabled=!1);for(let e=0;e<t.layers.length;e++){let r=t.layers[e];if(!r.isVisible||0===r.opacity)continue;s.globalAlpha=r.opacity;let a=r.mixModeStr;s.globalCompositeOperation=void 0!==a?a:"source-over",s.drawImage(r.image,0,0,i.width,i.height)}return s.restore(),i}function eU(t,e){let i;t.save();let s=e.x1,r=e.y1,a=e.x2,n=e.y2;if(e.doSnap){let t=180*e.angleRad/Math.PI,i=tI.rotate(s,r,e.angleRad/Math.PI*180),o=tI.rotate(a,n,e.angleRad/Math.PI*180),l=tI.pointsToAngleDeg(i,o)+90,h=45*Math.round(l/45),c=tI.rotateAround({x:s,y:r},{x:a,y:n},h-l);a=c.x,n=c.y,(t+h)%90==0&&(Math.round((t-h)/90)%2==0?a=s:n=r)}let o=e.color1;e.isEraser&&e.doLockAlpha&&(o={r:255,g:255,b:255});let l={...o,a:e.opacity},h={...o,a:0};if(e.isReversed){let t=l;l=h,h=t}if("linear"===e.type)(i=t.createLinearGradient(s,r,a,n)).addColorStop(0,tI.ColorConverter.toRgbaStr(l)),i.addColorStop(1,tI.ColorConverter.toRgbaStr(h));else if("linear-mirror"===e.type){let e={x:a-s,y:n-r};(i=t.createLinearGradient(s-e.x,r-e.y,a,n)).addColorStop(0,tI.ColorConverter.toRgbaStr(h)),i.addColorStop(.5,tI.ColorConverter.toRgbaStr(l)),i.addColorStop(1,tI.ColorConverter.toRgbaStr(h))}else if("radial"===e.type){let e=tI.Vec2.dist({x:s,y:r},{x:a,y:n});(i=t.createRadialGradient(s,r,0,s,r,e)).addColorStop(0,tI.ColorConverter.toRgbaStr(l)),i.addColorStop(1,tI.ColorConverter.toRgbaStr(h))}t.fillStyle=i,e.isEraser&&(t.globalCompositeOperation="destination-out"),e.doLockAlpha&&(t.globalCompositeOperation="source-atop"),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()}const eN=["source-over","darken","multiply","color-burn","lighten","screen","color-dodge","overlay","soft-light","hard-light","difference","exclusion","hue","saturation","color","luminosity"];function e_(t){if(!t)return tB("layers-blend-normal");let e={"source-over":"layers-blend-normal",darken:"layers-blend-darken",multiply:"layers-blend-multiply","color-burn":"layers-blend-color-burn",lighten:"layers-blend-lighten",screen:"layers-blend-screen","color-dodge":"layers-blend-color-dodge",overlay:"layers-blend-overlay","soft-light":"layers-blend-soft-light","hard-light":"layers-blend-hard-light",difference:"layers-blend-difference",exclusion:"layers-blend-exclusion",hue:"layers-blend-hue",saturation:"layers-blend-saturation",color:"layers-blend-color",luminosity:"layers-blend-luminosity"};if(!(t in e))throw Error("unknown blend mode");return tB(e[t])}var eY={};eY=x("dwTKp").getBundleURL("lrLBb")+"remove-layer.4e9b2b7d.svg";class eX{getElement(){return this.rootElement}setEnabled(t,e){this.onSetEnabled(t,e)}constructor(t){this.isExpanded=!1,this.onSetEnabled=()=>0;let e=tJ("button,w-full,h-full",[t.button]);e.onclick=()=>{a(!this.isExpanded)},t.buttonTitle&&(e.title=t.buttonTitle),tf(e);let i=[],s={};t.items.forEach(e=>{let r=tJ("button",e[1]);tf(r),r.onclick=()=>{a(!1),t.onItemClick(e[0])},i.push(r),s[e[0]]=r}),this.onSetEnabled=(t,e)=>{s[t].disabled=!e};let r=tJ(".kl-dropdown-menu,right-0,top-full,nowrap,hidden",i);this.rootElement=tJ(",pos-relative",[e,r]);let a=t=>{this.isExpanded=t,r.style.display=this.isExpanded?"block":"none",this.isExpanded?(document.addEventListener("pointerdown",n),window.addEventListener("blur",o)):(document.removeEventListener("pointerdown",n),window.removeEventListener("blur",o))},n=t=>{let i=t.target;e.contains(i)||r.contains(i)||a(!1)},o=()=>a(!1)}}var eG={};eG=x("dwTKp").getBundleURL("lrLBb")+"add-layer.ce1078bb.svg";var eK={};eK=x("dwTKp").getBundleURL("lrLBb")+"duplicate-layer.3314e3c7.svg";var eq={};eq=x("dwTKp").getBundleURL("lrLBb")+"merge-layers.19da79a6.svg";var e$={};e$=x("dwTKp").getBundleURL("lrLBb")+"rename-layer.7c31d4f4.svg";var eQ={};eQ=x("dwTKp").getBundleURL("lrLBb")+"caret-down.68d4cd16.svg";class eZ{getElement(){return this.rootElement}setSize(t,e){this.rootElement.setAttribute("width",""+t),this.rootElement.setAttribute("height",""+e),this.compass.setAttribute("transform","translate("+t/2+", "+e/2+")")}updateCursor(t){void 0!==t.x&&(this.brushCircleOuter.setAttribute("cx",""+t.x),this.brushCircleInner.setAttribute("cx",""+t.x)),void 0!==t.y&&(this.brushCircleOuter.setAttribute("cy",""+t.y),this.brushCircleInner.setAttribute("cy",""+t.y)),void 0!==t.radius&&(this.brushCircleOuter.setAttribute("r",""+Math.max(0,t.radius)),this.brushCircleInner.setAttribute("r",""+Math.max(0,t.radius-1))),void 0!==t.isVisible&&(this.brushCircleOuter.style.opacity=t.isVisible?"1":"0",this.brushCircleInner.style.opacity=t.isVisible?"1":"0")}updateColorPreview(t){if(void 0!==t.x&&(this.pickerPreviewCol.setAttribute("cx",""+t.x),this.pickerPreviewBorder.setAttribute("cx",""+t.x)),void 0!==t.y&&(this.pickerPreviewCol.setAttribute("cy",""+t.y),this.pickerPreviewBorder.setAttribute("cy",""+t.y)),t.color){this.pickerPreviewCol.setAttribute("stroke",tI.ColorConverter.toRgbStr(t.color));let e=tI.testIsWhiteBestContrast(t.color)?"rgba(255,255,255,0.5)":"rgba(0,0,0,0.5)";this.pickerPreviewBorder.setAttribute("stroke",e)}void 0!==t.isVisible&&(this.pickerPreviewCol.style.opacity=t.isVisible?"1":"0",this.pickerPreviewBorder.style.opacity=t.isVisible?"1":"0")}updateCompass(t){void 0!==t.angleDeg&&(this.compassInner.setAttribute("transform","rotate("+t.angleDeg+")"),this.compassLineCircle.style.opacity=t.angleDeg%90==0?"1":"0"),void 0!==t.isVisible&&(this.compass.style.opacity=t.isVisible?"1":"0")}constructor(t){this.rootElement=tI.createSvg({elementType:"svg",width:""+t.width,height:""+t.height}),tI.css(this.rootElement,{position:"absolute",left:"0",top:"0",pointerEvents:"none",userSelect:"none"}),this.brushCircleOuter=tI.createSvg({elementType:"circle",r:"10",stroke:"rgba(0,0,0,0.7)","stroke-width":"1",fill:"none"}),this.brushCircleInner=tI.createSvg({elementType:"circle",r:"9",stroke:"rgba(255,255,255,0.7)","stroke-width":"1",fill:"none"}),this.rootElement.append(this.brushCircleOuter,this.brushCircleInner),this.pickerPreviewBorder=tI.createSvg({elementType:"circle",r:"47",stroke:"black","stroke-width":"22",fill:"none"}),this.pickerPreviewBorder.style.opacity="0",this.pickerPreviewCol=tI.createSvg({elementType:"circle",r:"47",stroke:"black","stroke-width":"20",fill:"none"}),this.pickerPreviewCol.style.opacity="0",this.rootElement.append(this.pickerPreviewBorder,this.pickerPreviewCol),this.compassSize=30,this.compass=tI.createSvg({elementType:"g",transform:"translate("+t.width/2+", "+t.height/2+")"}),tI.css(this.compass,{transition:"opacity 0.25s ease-in-out",opacity:"0"}),this.compassInner=tI.createSvg({elementType:"g",transform:"rotate(45)"}),this.compassBaseCircle=tI.createSvg({elementType:"circle",fill:"rgba(0,0,0,0.9)",stroke:"none",cx:"0",cy:"0",r:""+this.compassSize}),this.compassLineCircle=tI.createSvg({elementType:"circle",fill:"none",stroke:"rgba(255,255,255,0.75)","stroke-width":"1",cx:"0",cy:"0",r:""+.9*this.compassSize}),this.compassUpperTriangle=tI.createSvg({elementType:"path",fill:"#f00",stroke:"none",d:"M -"+.25*this.compassSize+",0 "+.25*this.compassSize+",0 0,-"+.9*this.compassSize+" z"}),this.compassLowerTriangle=tI.createSvg({elementType:"path",fill:"#fff",stroke:"none",d:"M -"+.25*this.compassSize+",0 "+.25*this.compassSize+",0 0,"+.9*this.compassSize+" z"}),this.compassInner.append(this.compassBaseCircle,this.compassLineCircle,this.compassUpperTriangle,this.compassLowerTriangle),this.compass.append(this.compassInner),this.rootElement.append(this.compass)}}var eJ={};eJ=x("dwTKp").getBundleURL("lrLBb")+"cursor-picker.dc155349.png";var e0={};e0=x("dwTKp").getBundleURL("lrLBb")+"cursor-zoom-ew.9ecaf1c2.png";var e1={};e1=x("dwTKp").getBundleURL("lrLBb")+"cursor-fill.999c4916.png";var e2={};e2=x("dwTKp").getBundleURL("lrLBb")+"cursor-text.582bc0db.png";class e5{process(t){if("down"===t.type&&(this.downEvent=t,this.direction=null,t.shiftIsPressed)){this.onDraw({type:"line",x0:null,y0:null,pressure0:null,x1:t.x,y1:t.y,pressure1:t.pressure}),this.eventQueue.push(t);return}if("move"===t.type&&this.downEvent){if(t.shiftIsPressed){if(null===this.direction){let e=Math.abs(t.x-this.downEvent.x),i=Math.abs(t.y-this.downEvent.y);if(e>5||i>5){this.direction=e>i?0:1;for(let t=0;t<this.eventQueue.length;t++){let e=this.eventQueue[t];"up"!==e.type&&(0===this.direction?e.y=this.downEvent.y:e.x=this.downEvent.x),this.onDraw(tI.copyObj(e))}this.eventQueue=[]}}if(null===this.direction){this.eventQueue.push(t);return}0===this.direction?t.y=this.downEvent.y:t.x=this.downEvent.x}else if(this.eventQueue.length>0){for(let t=0;t<this.eventQueue.length;t++)this.onDraw(tI.copyObj(this.eventQueue[t]));this.eventQueue=[]}}"up"===t.type&&(this.eventQueue=[],this.downEvent=null),this.onDraw(tI.copyObj(t))}constructor(t){this.downEvent=null,this.eventQueue=[],this.direction=null,this.onDraw=t.onDraw}}const e3={filenameBase:"Klecks"},e4=1/16;(c=p||(p={}))[c.Draw=0]="Draw",c[c.Hand=1]="Hand",c[c.HandGrabbing=2]="HandGrabbing",c[c.Pick=3]="Pick",c[c.Zoom=4]="Zoom",c[c.Rotate=5]="Rotate",c[c.Rotating=6]="Rotating",c[c.Fill=7]="Fill",c[c.Gradient=8]="Gradient",c[c.Text=9]="Text",c[c.Shape=10]="Shape";class e9{getElement(){return this.canvas}render(){if(this.ctx){this.ctx.save(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.layers.length;t++){let e=this.layers[t];e.isVisible&&0!==e.opacity&&(this.ctx.globalAlpha=this.layers[t].opacity,this.ctx.globalCompositeOperation=this.layers[t].mixModeStr,this.canvas.width>this.layers[t].image.width&&(this.ctx.imageSmoothingEnabled=!1),this.ctx.drawImage(this.layers[t].image,0,0,this.canvas.width,this.canvas.height))}this.ctx.restore()}}destroy(){ee.removeIsDarkListener(this.updateCheckerboard)}constructor(t){this.layers=t.layers;let e=t.width/t.layers[0].image.width,i=e>1?t.layers[0].image.width:t.width,s=e>1?t.layers[0].image.height:t.height;this.canvas=tI.canvas(i,s),this.updateCheckerboard=()=>{this.canvas.style.backgroundImage="url("+tI.createCheckerDataUrl(8,void 0,ee.isDark())+")"},this.updateCheckerboard(),this.ctx=tI.ctx(this.canvas),tI.css(this.canvas,{width:"100%",height:"100%",imageRendering:e>1?"pixelated":void 0}),setTimeout(()=>this.render(),0),ee.addIsDarkListener(this.updateCheckerboard)}}var e6={};function e8(t){if(Math.abs(t.angleDeg)%90!=0)return;t.width=Math.round(t.width),t.height=Math.round(t.height);let e=Math.abs(t.angleDeg-90)%180==0;t.x=(e?t.height:t.width)%2==0?Math.round(t.x):Math.round(t.x-.5)+.5,t.y=(e?t.width:t.height)%2==0?Math.round(t.y):Math.round(t.y-.5)+.5}function e7(t){return{x:t.x,y:t.y,width:t.width,height:t.height,angleDeg:t.angleDeg}}function it(t,e,i){let s=tI.rotateAround({x:0,y:0},{x:t,y:e},i.angleDeg);return{x:s.x+i.x,y:s.y+i.y}}e6=x("dwTKp").getBundleURL("lrLBb")+"cursor-rotate.4dea8425.png";class ie{updateScaled(){this.scaled.x=this.value.x*this.viewportTransform.scale,this.scaled.y=this.value.y*this.viewportTransform.scale,this.scaled.width=this.value.width*this.viewportTransform.scale,this.scaled.height=this.value.height*this.viewportTransform.scale,this.scaled.corners=this.corners.map(t=>({x:t.x*this.viewportTransform.scale,y:t.y*this.viewportTransform.scale}))}snapCorner(t,e){var i,s;let r;if(!this.snappingEnabled)return{x:t,y:e};let a={x:void 0,y:void 0,dist:{x:void 0,y:void 0}};for(let e=0;e<this.snapX.length;e++)(r=Math.abs(t-this.snapX[e]))<this.minSnapDist/this.viewportTransform.scale&&(void 0===a.x||r<a.dist.x)&&(a.x=this.snapX[e],a.dist.x=r);for(let t=0;t<this.snapY.length;t++)(r=Math.abs(e-this.snapY[t]))<this.minSnapDist/this.viewportTransform.scale&&(void 0===a.y||r<a.dist.y)&&(a.y=this.snapY[t],a.dist.y=r);return void 0===a.x&&void 0===a.y?{x:t,y:e}:{x:null!==(i=a.x)&&void 0!==i?i:t,y:null!==(s=a.y)&&void 0!==s?s:e}}constrainCorner(t,e,i){if(!this.isConstrained)return{x:e,y:i};let s=this.value.width*this.value.height<0?-1:1;return tI.projectPointOnLine({x:this.value.x,y:this.value.y},it(this.ratio,s*([0,2].includes(t)?1:-1),this.value),{x:e,y:i})}updateCornerPositions(){this.corners[0].x=-this.value.width/2,this.corners[0].y=-this.value.height/2,this.corners[1].x=this.value.width/2,this.corners[1].y=-this.value.height/2,this.corners[2].x=this.value.width/2,this.corners[2].y=this.value.height/2,this.corners[3].x=-this.value.width/2,this.corners[3].y=this.value.height/2}restoreRatio(t,e){if(!this.isConstrained)return;let i=Math.abs(this.value.angleDeg)%90==0,s=Math.abs(this.value.angleDeg-90)%180==0;if(e&&!t){let t=Math.abs(this.corners[3].y-this.corners[0].y),e=this.ratio*t;i&&(e=(s?this.value.y%1:this.value.x%1)==0?tI.roundEven(e):tI.roundUneven(e)),this.corners[1].x-this.corners[0].x<0&&(e*=-1),this.corners[0].x=-e/2,this.corners[3].x=-e/2,this.corners[1].x=e/2,this.corners[2].x=e/2}if(!e&&t){let t=Math.abs(this.corners[0].x-this.corners[1].x)/this.ratio;i&&(t=(s?this.value.x%1:this.value.y%1)==0?tI.roundEven(t):tI.roundUneven(t)),this.corners[3].y-this.corners[0].y<0&&(t*=-1),this.corners[0].y=-t/2,this.corners[1].y=-t/2,this.corners[2].y=t/2,this.corners[3].y=t/2}}updateTransformViaCorners(){let t=tI.rotateAround({x:0,y:0},{x:(this.corners[0].x+this.corners[1].x)/2,y:(this.corners[0].y+this.corners[3].y)/2},this.value.angleDeg);this.value.x=t.x+this.value.x,this.value.y=t.y+this.value.y,this.value.width=this.corners[1].x-this.corners[0].x,this.value.height=this.corners[3].y-this.corners[0].y,this.updateCornerPositions(),this.updateDOM()}updateDOM(t){this.updateScaled(),tI.css(this.transEl,{left:this.viewportTransform.x+this.scaled.x+"px",top:this.viewportTransform.y+this.scaled.y+"px",transformOrigin:"0 0",transform:"rotate("+this.value.angleDeg+"deg)"}),tI.css(this.boundsEl,{width:Math.abs(this.scaled.width)+"px",height:Math.abs(this.scaled.height)+"px",left:Math.min(this.scaled.corners[0].x,this.scaled.corners[1].x)+"px",top:Math.min(this.scaled.corners[0].y,this.scaled.corners[3].y)+"px"}),this.corners[0].updateDOM(),this.corners[1].updateDOM(),this.corners[2].updateDOM(),this.corners[3].updateDOM(),this.edges[0].updateDOM(),this.edges[1].updateDOM(),this.edges[2].updateDOM(),this.edges[3].updateDOM(),this.angleGrip.x=0,this.angleGrip.y=-Math.abs(this.value.height*this.viewportTransform.scale)/2-20,this.angleGrip.updateDOM(),!t&&this.callback&&this.callback(e7(this.value))}getValue(){return e7(this.value)}setIsConstrained(t){this.isConstrained=t,t&&0!==this.value.width&&0!==this.value.height&&(this.ratio=Math.abs(this.value.width/this.value.height))}setSnapping(t){this.snappingEnabled=t}setPos(t){this.value.x=t.x,this.value.y=t.y,this.updateDOM(!0)}move(t,e){this.value.x+=t,this.value.y+=e,this.updateDOM(!1)}setSize(t,e){this.value.width=t,this.value.height=e,Math.abs(this.value.angleDeg)%90==0&&e8(this.value),this.updateCornerPositions(),this.updateDOM(!1)}setAngleDeg(t){this.value.angleDeg=t,Math.abs(this.value.angleDeg)%90==0&&(e8(this.value),this.updateCornerPositions()),this.updateDOM(!0)}setViewportTransform(t){this.viewportTransform=t,this.updateScaled(),this.updateDOM()}getElement(){return this.rootEl}getRatio(){return this.ratio}destroy(){this.keyListener.destroy(),this.boundsPointerListener.destroy(),this.corners.forEach(t=>t.pointerListener.destroy()),this.edges.forEach(t=>t.pointerListener.destroy()),this.anglePointerListener.destroy()}constructor(t){let e;this.scaled={x:0,y:0,width:0,height:0,corners:[{x:0,y:0}]},this.minSnapDist=7,this.cornerCursors=["nw","n","ne","e","se","s","sw","w"],this.gripSize=16,this.edgeSize=10,this.corners=[],this.edges=[],this.viewportTransform={...t.viewportTransform},this.value={x:t.x,y:t.y,width:t.width,height:t.height,angleDeg:t.angleDeg},this.isConstrained=t.isConstrained,this.snapX=t.snapX,this.snapY=t.snapY,this.callback=t.callback,this.snappingEnabled=!0,this.ratio=this.value.width/this.value.height,this.rootEl=tI.el({className:"kl-free-transform",css:{userSelect:"none"}}),this.transEl=tI.el({parent:this.rootEl,css:{position:"absolute"}}),this.boundsEl=tI.el({css:{position:"absolute",cursor:"move",boxShadow:"rgba(255, 255, 255, 0.5) 0 0 0 1px inset, rgba(0, 0, 0, 0.5) 0 0 0 1px"}});let i={x:0,y:0};this.keyListener=new tI.KeyListener({});let s={x:0,y:0};this.boundsPointerListener=new tI.PointerListener({target:this.boundsEl,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointerdown"===t.type&&(s={x:this.value.x,y:this.value.y}),"pointermove"===t.type&&"left"===t.button){let e;this.value.x=s.x+(t.pageX-t.downPageX)/this.viewportTransform.scale,this.value.y=s.y+(t.pageY-t.downPageY)/this.viewportTransform.scale;let i={distX:-1,distY:-1};if(this.snappingEnabled){let t,s;for(t=0;t<this.snapX.length;t++)(e=Math.abs(this.value.x-this.snapX[t]))<this.minSnapDist/this.viewportTransform.scale&&(void 0===i.x||e<i.distX)&&(i.x=this.snapX[t],i.distX=e);for(t=0;t<this.snapY.length;t++)(e=Math.abs(this.value.y-this.snapY[t]))<this.minSnapDist/this.viewportTransform.scale&&(void 0===i.y||e<i.distY)&&(i.y=this.snapY[t],i.distY=e);for(t=0;t<4;t++){let r;for(r=0,s=it(this.corners[t].x,this.corners[t].y,this.value);r<this.snapX.length;r++)(e=Math.abs(s.x-this.snapX[r]))<this.minSnapDist/this.viewportTransform.scale&&(void 0===i.x||e<i.distX)&&(i.x=this.snapX[r]-(s.x-this.value.x),i.distX=e);for(r=0;r<this.snapY.length;r++)(e=Math.abs(s.y-this.snapY[r]))<this.minSnapDist/this.viewportTransform.scale&&(void 0===i.y||e<i.distY)&&(i.y=this.snapY[r]-(s.y-this.value.y),i.distY=e)}}if("shift"===this.keyListener.getComboStr()){let t=tI.projectPointOnLine({x:0,y:s.y},{x:10,y:s.y},{x:this.value.x,y:this.value.y}),e=tI.dist(t.x,t.y,this.value.x,this.value.y);i={x:t.x,y:t.y,distX:e,distY:e},t=tI.projectPointOnLine({x:s.x,y:0},{x:s.x,y:10},{x:this.value.x,y:this.value.y}),(e=tI.dist(t.x,t.y,this.value.x,this.value.y))<i.distX&&(i={x:t.x,y:t.y,distX:e,distY:e}),t=tI.projectPointOnLine({x:s.x,y:s.y},{x:s.x+1,y:s.y+1},{x:this.value.x,y:this.value.y}),(e=tI.dist(t.x,t.y,this.value.x,this.value.y))<i.distX&&(i={x:t.x,y:t.y,distX:e,distY:e}),t=tI.projectPointOnLine({x:s.x,y:s.y},{x:s.x+1,y:s.y-1},{x:this.value.x,y:this.value.y}),(e=tI.dist(t.x,t.y,this.value.x,this.value.y))<i.distX&&(i={x:t.x,y:t.y,distX:e,distY:e})}void 0!=i.x&&(this.value.x=i.x),void 0!=i.y&&(this.value.y=i.y),Math.abs(this.value.angleDeg)%90==0&&(e8(this.value),this.updateCornerPositions()),this.updateDOM()}}});for(let t=0;t<4;t++)(t=>{let e=this.corners[t]={i:t,el:tI.el({css:{width:this.gripSize+"px",height:this.gripSize+"px",background:"#fff",borderRadius:this.gripSize+"px",position:"absolute",border:"2px solid #000"}}),x:0,y:0,virtualPos:{x:0,y:0}};e.updateDOM=()=>{let i=[[-1,-1],[1,-1],[1,1],[-1,1]].map(t=>(t[0]*=this.value.width>0?1:-1,t[1]*=this.value.height>0?1:-1,t)),s=20>Math.abs(this.scaled.width)||20>Math.abs(this.scaled.height)?10:0;tI.css(e.el,{left:this.scaled.corners[e.i].x-this.gripSize/2+i[t][0]*s+"px",top:this.scaled.corners[e.i].y-this.gripSize/2+i[t][1]*s+"px"});let r=tI.pointsToAngleDeg({x:this.value.x,y:this.value.y},it(e.x,e.y,this.value))+135;for(;r<0;)r+=360;let a=Math.round(r/45)%this.cornerCursors.length;tI.css(e.el,{cursor:this.cornerCursors[a]+"-resize"})},e.pointerListener=new tI.PointerListener({target:this.corners[t].el,fixScribble:!0,onPointer:e=>{if(e.eventPreventDefault(),"pointerdown"===e.type&&"left"===e.button)this.corners[t].virtualPos=it(this.corners[t].x,this.corners[t].y,this.value);else if("pointermove"===e.type&&"left"===e.button){this.corners[t].virtualPos.x+=e.dX/this.viewportTransform.scale,this.corners[t].virtualPos.y+=e.dY/this.viewportTransform.scale;let i={x:this.corners[t].virtualPos.x,y:this.corners[t].virtualPos.y};i=this.constrainCorner(t,i.x,i.y),this.isConstrained||(i=this.snapCorner(i.x,i.y)),Math.abs(this.value.angleDeg)%90==0&&(i.x=Math.round(i.x),i.y=Math.round(i.y));let s=function(t,e,i){let s,r;s=t-i.x,r=e-i.y;let a=tI.rotateAround({x:0,y:0},{x:s,y:r},-i.angleDeg);return{x:s=a.x,y:r=a.y}}(i.x,i.y,this.value),r=s.x-this.corners[t].x,a=s.y-this.corners[t].y;this.corners[t].x=s.x,this.corners[t].y=s.y;let n=[];0===t?n=[3,1,2]:1===t?n=[2,0,3]:2===t?n=[1,3,0]:3===t&&(n=[0,2,1]),this.corners[n[0]].x=this.corners[t].x,this.corners[n[1]].y=this.corners[t].y,this.keyListener.isPressed("shift")&&(this.corners[n[2]].x-=r,this.corners[n[2]].y-=a,this.corners[n[1]].x=this.corners[n[2]].x,this.corners[n[0]].y=this.corners[n[2]].y),this.updateTransformViaCorners()}}})})(t);this.updateCornerPositions(),this.updateScaled();for(let t=0;t<4;t++)(t=>{this.edges[t]={el:tI.el({css:{width:this.edgeSize+"px",height:this.edgeSize+"px",position:"absolute"}})};let s=this.edges[t];s.updateDOM=()=>{0===t?tI.css(s.el,{left:Math.min(this.scaled.corners[0].x,this.scaled.corners[1].x)+"px",top:Math.min(this.scaled.corners[0].y,this.scaled.corners[3].y)-this.edgeSize+"px",width:Math.abs(this.scaled.width)+"px",height:this.edgeSize+"px"}):1===t?tI.css(s.el,{left:Math.max(this.scaled.corners[0].x,this.scaled.corners[1].x)+"px",top:Math.min(this.scaled.corners[1].y,this.scaled.corners[2].y)+"px",width:this.edgeSize+"px",height:Math.abs(this.scaled.height)+"px"}):2===t?tI.css(s.el,{left:Math.min(this.scaled.corners[3].x,this.scaled.corners[2].x)+"px",top:Math.max(this.scaled.corners[0].y,this.scaled.corners[3].y)+"px",width:Math.abs(this.scaled.width)+"px",height:this.edgeSize+"px"}):3===t&&tI.css(s.el,{left:Math.min(this.scaled.corners[0].x,this.scaled.corners[1].x)-this.edgeSize+"px",top:Math.min(this.scaled.corners[0].y,this.scaled.corners[3].y)+"px",width:this.edgeSize+"px",height:Math.abs(this.scaled.height)+"px"});let e=Math.round(this.value.angleDeg/45);for(;e<0;)e+=8;e=(2*t+1+e)%this.cornerCursors.length,s.el.style.cursor=this.cornerCursors[e]+"-resize"};let r=[0,2].includes(t);s.pointerListener=new tI.PointerListener({target:this.edges[t].el,fixScribble:!0,onPointer:s=>{if(s.eventPreventDefault(),"pointerdown"===s.type&&"left"===s.button&&(e=r?this.corners[0].y>=this.corners[3].y:this.corners[0].x>=this.corners[1].x,i.x=0,i.y=0),"pointermove"===s.type&&"left"===s.button){let a=tI.rotateAround({x:0,y:0},{x:s.dX/this.viewportTransform.scale,y:s.dY/this.viewportTransform.scale},-this.value.angleDeg),n={dX:a.x,dY:a.y};Math.abs(this.value.angleDeg)%90==0&&(n=tI.intDxy(i,a.x,a.y));let o=[];0===t?o=[2,3,0,1]:1===t?o=[0,3,1,2]:2===t?o=[0,1,2,3]:3===t&&(o=[1,2,0,3]);let l=r?"y":"x",h=r?n.dY:n.dX;e?(this.corners[o[0]][l]+=h,this.corners[o[1]][l]+=h):(this.corners[o[2]][l]+=h,this.corners[o[3]][l]+=h),this.keyListener.isPressed("shift")&&(e?(this.corners[o[2]][l]-=h,this.corners[o[3]][l]-=h):(this.corners[o[0]][l]-=h,this.corners[o[1]][l]-=h)),r?this.restoreRatio(!1,!0):this.restoreRatio(!0,!1),this.updateTransformViaCorners()}}})})(t);this.angleGrip={el:tI.el({css:{cursor:"url("+m(e6)+") 10 10, move",width:this.gripSize+"px",height:this.gripSize+"px",background:"#0ff",borderRadius:this.gripSize+"px",position:"absolute",boxShadow:"inset 0 0 0 2px #000"}}),x:0,y:0,snap:!1,updateDOM:()=>{tI.css(this.angleGrip.el,{left:this.angleGrip.x-this.gripSize/2+"px",top:this.angleGrip.y-this.gripSize/2+"px"})}},tI.el({parent:this.angleGrip.el,css:{width:"2px",height:"13px",left:this.gripSize/2-1+"px",top:this.gripSize+"px",background:"#0ff",position:"absolute"}}),this.anglePointerListener=new tI.PointerListener({target:this.angleGrip.el,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){let e=this.rootEl.getBoundingClientRect(),i={x:e.left-this.rootEl.scrollLeft+this.viewportTransform.x,y:e.top-this.rootEl.scrollTop+this.viewportTransform.y},s={x:(t.clientX-i.x)/this.viewportTransform.scale,y:(t.clientY-i.y)/this.viewportTransform.scale},r=tI.pointsToAngleDeg({x:this.value.x,y:this.value.y},s)+90;this.value.angleDeg=r;let a=45*Math.round(r/360*8);"shift"===this.keyListener.getComboStr()?this.value.angleDeg=a:this.snappingEnabled&&8>Math.abs(a-r)&&(this.value.angleDeg=a),this.updateDOM()}"pointerup"===t.type&&Math.abs(this.value.angleDeg)%90==0&&(e8(this.value),this.updateCornerPositions(),this.updateDOM())}}),e8(this.value),this.updateDOM(!0),tI.append(this.transEl,[this.boundsEl,this.edges[0].el,this.edges[1].el,this.edges[2].el,this.edges[3].el,this.corners[0].el,this.corners[1].el,this.corners[2].el,this.corners[3].el,this.angleGrip.el])}}var ii={};ii=x("6KItP");class is{updatePreview(){let t=this.freeTransform.getValue(),e=tI.ctx(this.previewCanvas);e.save(),e.clearRect(0,0,this.previewCanvas.width,this.previewCanvas.height),tI.drawTransformedImageWithBounds(e,this.layers[this.transformIndex].image,t,void 0,tI.testShouldPixelate(t,t.width/this.initTransform.width,t.height/this.initTransform.height)),e.restore(),this.preview.render()}move(t,e){this.freeTransform.move(t,e)}reset(){let t=this.layers[this.transformIndex].image.width,e=this.layers[this.transformIndex].image.height;this.freeTransform.setSize(t,e),this.freeTransform.setPos({x:t/2,y:e/2}),this.freeTransform.setAngleDeg(0),this.updatePreview()}setTransformFit(){let t=tI.fitInto(this.layers[this.transformIndex].image.width,this.layers[this.transformIndex].image.height,this.imageWidth,this.imageHeight,1);this.freeTransform.setSize(t.width,t.height),this.freeTransform.setPos({x:t.width/2,y:t.height/2}),this.freeTransform.setAngleDeg(0),this.updatePreview()}setTransformCenter(){this.freeTransform.setPos({x:this.imageWidth/2,y:this.imageHeight/2}),this.freeTransform.setAngleDeg(0),this.updatePreview()}getTransformation(){return this.freeTransform.getValue()}getIsPixelated(){let t=this.freeTransform.getValue();return tI.testShouldPixelate(t,t.width/this.initTransform.width,t.height/this.initTransform.height)}getElement(){return this.rootEl}destroy(){this.freeTransform.destroy(),this.preview.destroy(),tI.freeCanvas(this.previewCanvas)}constructor(t){this.imageWidth=t.imageWidth,this.imageHeight=t.imageHeight,this.rootEl=tI.el({className:"kl-preview-wrapper",css:{width:t.elementWidth+"px",height:t.elementHeight+"px"}}),this.rootEl.oncontextmenu=()=>!1,this.layers=t.layers,this.transformIndex=t.transformIndex,this.previewLayerArr=this.layers.map(t=>{var e;return{image:t.image,isVisible:t.isVisible,mixModeStr:null!==(e=t.mixModeStr)&&void 0!==e?e:"source-over",opacity:t.opacity,hasClipping:!1}}),this.previewCanvas=tI.canvas(this.imageWidth,this.imageHeight),this.previewLayerArr[this.previewLayerArr.length-1].image=this.previewCanvas,this.preview=new eD({width:t.elementWidth,height:t.elementHeight,project:{width:t.imageWidth,height:t.imageHeight,layers:this.previewLayerArr},hasEditMode:!0,onModeChange:t=>{this.freeTransform.getElement().style.pointerEvents="edit"===t?"":"none",this.freeTransform.getElement().style.opacity="edit"===t?"":"0.5"},onTransformChange:t=>{this.freeTransform.setViewportTransform(t)},padding:30}),this.preview.getElement().classList.add((0,ii.css)({overflow:"hidden",marginLeft:"-20px",marginRight:"-20px"})),this.rootEl.append(this.preview.getElement()),this.initTransform={x:this.imageWidth/2,y:this.imageHeight/2,width:this.layers[this.transformIndex].image.width,height:this.layers[this.transformIndex].image.height},this.freeTransform=new ie({x:this.initTransform.x,y:this.initTransform.y,width:this.initTransform.width,height:this.initTransform.height,angleDeg:0,isConstrained:!0,snapX:[0,this.imageWidth],snapY:[0,this.imageHeight],viewportTransform:this.preview.getTransform(),callback:()=>{this.updatePreview()}}),this.preview.getElement().append(this.freeTransform.getElement()),tI.css(this.freeTransform.getElement(),{position:"absolute",left:"0",top:"0"}),setTimeout(()=>this.updatePreview(),0)}}class ir{update(){this.edges[0].update(),this.edges[1].update(),this.edges[2].update(),this.edges[3].update(),this.cornerElArr[0].update(),this.cornerElArr[1].update(),this.cornerElArr[2].update(),this.cornerElArr[3].update(),this.darken[0].update(),this.darken[1].update(),this.darken[2].update(),this.darken[3].update(),this.outline.update(),this.thirdsHorizontal.update(),this.thirdsVertical.update()}commit(){this.pointerRemainder.x=0,this.pointerRemainder.y=0,this.callback(this.getTransform())}getTransform(){return this.grips[1].x-=this.grips[0].x,this.grips[1].y-=this.grips[0].y,this.grips[2].x-=this.grips[0].x,this.grips[2].y-=this.grips[0].y,this.grips[3].x-=this.grips[0].x,this.grips[3].y-=this.grips[0].y,this.x+=this.grips[0].x,this.y+=this.grips[0].y,this.grips[0].x=0,this.grips[0].y=0,{x:this.x,y:this.y,width:this.grips[1].x,height:this.grips[2].y}}setTransform(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,tI.css(this.rootEl,{left:this.x*this.scale+"px",top:this.y*this.scale+"px"}),this.grips[0].x=0,this.grips[0].y=0,this.grips[1].x=this.width,this.grips[1].y=0,this.grips[2].x=this.width,this.grips[2].y=this.height,this.grips[3].x=0,this.grips[3].y=this.height,this.update(),this.commit()}setScale(t){this.scale=t,tI.css(this.rootEl,{left:this.x*this.scale+"px",top:this.y*this.scale+"px"}),this.update()}showThirds(t){this.thirdsHorizontal.el.style.display=t?"block":"none",this.thirdsVertical.el.style.display=t?"block":"none"}getElement(){return this.rootEl}destroy(){this.keyListener.destroy(),this.outlinePointerListener.destroy(),this.corner0PointerListener.destroy(),this.corner1PointerListener.destroy(),this.corner2PointerListener.destroy(),this.corner3PointerListener.destroy(),this.edge0PointerListener.destroy(),this.edge1PointerListener.destroy(),this.edge2PointerListener.destroy(),this.edge3PointerListener.destroy()}constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.scale=t.scale,this.callback=t.callback;let e=t.maxW,i=t.maxW;this.rootEl=tI.el();let s=["nw","n","ne","e","se","s","sw","w"];this.keyListener=new tI.KeyListener({}),tI.css(this.rootEl,{position:"absolute",left:this.x*this.scale+"px",top:this.y*this.scale+"px"}),this.outline={el:tI.el({css:{position:"absolute",border:"1px dashed #fff",cursor:"move"}}),update:()=>{tI.css(this.outline.el,{left:this.grips[0].x*this.scale-1+"px",top:this.grips[0].y*this.scale-1+"px",width:(this.grips[2].x-this.grips[0].x)*this.scale+"px",height:(this.grips[2].y-this.grips[0].y)*this.scale+"px"})}},this.pointerRemainder={x:0,y:0},this.outlinePointerListener=new tI.PointerListener({target:this.outline.el,onPointer:t=>{if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){let{dX:e,dY:i}=tI.intDxy(this.pointerRemainder,t.dX/this.scale,t.dY/this.scale);this.grips[0].x+=e,this.grips[0].y+=i,this.grips[1].x+=e,this.grips[1].y+=i,this.grips[2].x+=e,this.grips[2].y+=i,this.grips[3].x+=e,this.grips[3].y+=i,this.update()}"pointerup"===t.type&&this.commit()}}),this.thirdsHorizontal={el:tI.el({css:{position:"absolute",borderTop:"1px solid #0ff",borderBottom:"1px solid #0ff"}}),update:()=>{tI.css(this.thirdsHorizontal.el,{left:this.grips[0].x*this.scale+"px",top:(this.grips[0].y+(this.grips[2].y-this.grips[0].y)/3)*this.scale+"px",width:(this.grips[2].x-this.grips[0].x)*this.scale+"px",height:(this.grips[2].y-this.grips[0].y)/3*this.scale+"px"})}},this.thirdsVertical={el:tI.el({css:{position:"absolute",borderLeft:"1px solid #0ff",borderRight:"1px solid #0ff"}}),update:()=>{tI.css(this.thirdsVertical.el,{left:(this.grips[0].x+(this.grips[2].x-this.grips[0].x)/3)*this.scale+"px",top:this.grips[0].y*this.scale+"px",width:(this.grips[2].x-this.grips[0].x)/3*this.scale+"px",height:(this.grips[2].y-this.grips[0].y)*this.scale+"px"})}},this.grips=[{x:0,y:0},{x:this.width,y:0},{x:this.width,y:this.height},{x:0,y:this.height}];let r=t=>{this.grips[0].y+=t,this.grips[0].y=tI.clamp(this.grips[0].y,this.grips[3].y-i,this.grips[3].y-1),this.grips[1].y=this.grips[0].y},a=t=>{this.grips[1].x+=t,this.grips[1].x=tI.clamp(this.grips[1].x,this.grips[0].x+1,this.grips[0].x+e),this.grips[2].x=this.grips[1].x},n=t=>{this.grips[2].y+=t,this.grips[2].y=tI.clamp(this.grips[2].y,this.grips[1].y+1,this.grips[1].y+i),this.grips[3].y=this.grips[2].y},o=t=>{this.grips[0].x+=t,this.grips[0].x=tI.clamp(this.grips[0].x,this.grips[1].x-e,this.grips[1].x-1),this.grips[3].x=this.grips[0].x};this.edges=[];for(let t=0;t<4;t++)(t=>{let e=tI.el({css:{width:"40px",height:"40px",position:"absolute"}}),i=()=>{0===t?tI.css(e,{left:this.grips[0].x*this.scale+10+"px",top:this.grips[0].y*this.scale-80+10+"px",width:(this.grips[1].x-this.grips[0].x)*this.scale-20+"px",height:"80px"}):1===t?tI.css(e,{left:this.grips[1].x*this.scale-10+"px",top:this.grips[1].y*this.scale+10+"px",width:"80px",height:(this.grips[2].y-this.grips[1].y)*this.scale-20+"px"}):2===t?tI.css(e,{left:this.grips[3].x*this.scale+10+"px",top:this.grips[3].y*this.scale-10+"px",width:(this.grips[2].x-this.grips[3].x)*this.scale-20+"px",height:"80px"}):3===t&&tI.css(e,{left:this.grips[0].x*this.scale-80+10+"px",top:this.grips[0].y*this.scale+10+"px",width:"80px",height:(this.grips[3].y-this.grips[0].y)*this.scale-20+"px"});let i=2*t+1;e.style.cursor=s[i]+"-resize"};this.edges[t]={el:e,update:i}})(t);this.darken=[];for(let t=0;t<4;t++)(t=>{let e=tI.el({css:{position:"absolute",background:"#000",opacity:"0.5"}}),i=()=>{0===t?tI.css(e,{left:this.grips[0].x*this.scale+"px",top:this.grips[0].y*this.scale-8e3+"px",width:(this.grips[1].x-this.grips[0].x)*this.scale+"px",height:"8000px"}):1===t?tI.css(e,{left:this.grips[1].x*this.scale+"px",top:this.grips[1].y*this.scale-8e3+"px",width:"8000px",height:"16000px"}):2===t?tI.css(e,{left:this.grips[3].x*this.scale+"px",top:this.grips[3].y*this.scale+"px",width:(this.grips[2].x-this.grips[3].x)*this.scale+"px",height:"8000px"}):3===t&&tI.css(e,{left:this.grips[0].x*this.scale-8e3+"px",top:this.grips[0].y*this.scale-8e3+"px",width:"8000px",height:"16000px"})};this.darken[t]={el:e,update:i}})(t);this.edge0PointerListener=new tI.PointerListener({target:this.edges[0].el,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){let{dY:e}=tI.intDxy(this.pointerRemainder,t.dX/this.scale,t.dY/this.scale);r(e),this.keyListener.isPressed("shift")&&n(-e),this.update()}"pointerup"===t.type&&this.commit()}}),this.edge1PointerListener=new tI.PointerListener({target:this.edges[1].el,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){let{dX:e,dY:i}=tI.intDxy(this.pointerRemainder,t.dX/this.scale,t.dY/this.scale);a(e),this.keyListener.isPressed("shift")&&o(-e),this.update()}"pointerup"===t.type&&this.commit()}}),this.edge2PointerListener=new tI.PointerListener({target:this.edges[2].el,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){let{dX:e,dY:i}=tI.intDxy(this.pointerRemainder,t.dX/this.scale,t.dY/this.scale);n(i),this.keyListener.isPressed("shift")&&r(-i),this.update()}"pointerup"===t.type&&this.commit()}}),this.edge3PointerListener=new tI.PointerListener({target:this.edges[3].el,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){let{dX:e,dY:i}=tI.intDxy(this.pointerRemainder,t.dX/this.scale,t.dY/this.scale);o(e),this.keyListener.isPressed("shift")&&a(-e),this.update()}"pointerup"===t.type&&this.commit()}}),this.cornerElArr=[],(()=>{for(let t=0;t<4;t++)(t=>{let e=tI.el({css:{width:"80px",height:"80px",position:"absolute",cursor:["nwse-resize","nesw-resize"][t%2]}}),i=()=>{0===t?tI.css(e,{left:this.grips[0].x*this.scale-80+10+"px",top:this.grips[0].y*this.scale-80+10+"px"}):1===t?tI.css(e,{left:this.grips[1].x*this.scale-10+"px",top:this.grips[1].y*this.scale-80+10+"px"}):2===t?tI.css(e,{left:this.grips[1].x*this.scale-10+"px",top:this.grips[2].y*this.scale-10+"px"}):3===t&&tI.css(e,{left:this.grips[0].x*this.scale-80+10+"px",top:this.grips[2].y*this.scale-10+"px"})};this.cornerElArr[t]={el:e,update:i}})(t)})(),this.corner0PointerListener=new tI.PointerListener({target:this.cornerElArr[0].el,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){let{dX:e,dY:i}=tI.intDxy(this.pointerRemainder,t.dX/this.scale,t.dY/this.scale);o(e),r(i),this.keyListener.isPressed("shift")&&(a(-e),n(-i)),this.update()}"pointerup"===t.type&&this.commit()}}),this.corner1PointerListener=new tI.PointerListener({target:this.cornerElArr[1].el,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){let{dX:e,dY:i}=tI.intDxy(this.pointerRemainder,t.dX/this.scale,t.dY/this.scale);a(e),r(i),this.keyListener.isPressed("shift")&&(o(-e),n(-i)),this.update()}"pointerup"===t.type&&this.commit()}}),this.corner2PointerListener=new tI.PointerListener({target:this.cornerElArr[2].el,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){let{dX:e,dY:i}=tI.intDxy(this.pointerRemainder,t.dX/this.scale,t.dY/this.scale);a(e),n(i),this.keyListener.isPressed("shift")&&(o(-e),r(-i)),this.update()}"pointerup"===t.type&&this.commit()}}),this.corner3PointerListener=new tI.PointerListener({target:this.cornerElArr[3].el,fixScribble:!0,onPointer:t=>{if(t.eventPreventDefault(),"pointermove"===t.type&&"left"===t.button){let{dX:e,dY:i}=tI.intDxy(this.pointerRemainder,t.dX/this.scale,t.dY/this.scale);o(e),n(i),this.keyListener.isPressed("shift")&&(a(-e),r(-i)),this.update()}"pointerup"===t.type&&this.commit()}}),this.rootEl.append(this.darken[1].el,this.darken[0].el,this.darken[2].el,this.darken[3].el,this.thirdsHorizontal.el,this.thirdsVertical.el,this.outline.el,this.edges[1].el,this.edges[0].el,this.edges[2].el,this.edges[3].el,this.cornerElArr[0].el,this.cornerElArr[1].el,this.cornerElArr[2].el,this.cornerElArr[3].el),this.update()}}function ia(){return window.innerWidth<550}const io={width:340,height:220},il={width:540,height:300};function ih(t){return t?io.width:il.width}function ic(t){return t?io.height:il.height}var ip={};ip=x("dwTKp").getBundleURL("lrLBb")+"klecks-logo.2dcce02e.png";var id={};id=x("dwTKp").getBundleURL("lrLBb")+"new-image.2d692480.svg";var iu={};iu=x("dwTKp").getBundleURL("lrLBb")+"import.7a68c844.svg";var ig={};ig=x("dwTKp").getBundleURL("lrLBb")+"export.2deb9ff8.svg";var im={};im=x("dwTKp").getBundleURL("lrLBb")+"share.454898d1.svg";var iy={};iy=x("dwTKp").getBundleURL("lrLBb")+"help.208e9032.svg";var ix={};ix=x("dwTKp").getBundleURL("lrLBb")+"tool-paint.f73a8943.svg";var iv={};iv=x("dwTKp").getBundleURL("lrLBb")+"tool-fill.3358320a.svg";var ib={};ib=x("dwTKp").getBundleURL("lrLBb")+"tool-gradient.64486254.svg";var iw={};iw=x("dwTKp").getBundleURL("lrLBb")+"tool-text.1cbd0325.svg";var iC={};iC=x("dwTKp").getBundleURL("lrLBb")+"tool-shape.3de78c3f.svg";class iS{updateButton(){this.activeButton.title=this.titleArr[this.currentActiveIndex],this.activeButtonIm.style.backgroundImage="url('"+this.imArr[this.currentActiveIndex]+"')"}setIsSmall(t){this.activeButton.style.padding=t?this.smallMargin:"10px 0";for(let e=0;e<this.optionArr.length;e++)this.dropdownBtnArr[e].setIsSmall(t);t?(this.arrowButton.style.width="14px",this.arrowButton.style.height="14px"):(this.arrowButton.style.width="18px",this.arrowButton.style.height="18px")}setActive(t){if(this.optionArr.includes(t)){this.isActive=!0;for(let e=0;e<this.optionArr.length;e++)if(this.optionArr[e]===t){this.currentActiveIndex=e;break}this.activeButton.classList.add("toolspace-row-button-activated"),this.updateButton()}else this.isActive=!1,this.activeButton.classList.remove("toolspace-row-button-activated")}getActive(){return this.optionArr[this.currentActiveIndex]}getElement(){return this.rootEl}constructor(t){let e,i,s;this.smallMargin="6px 0",this.optionArr=["draw","fill","gradient","text","shape"],this.imArr=[m(ix),m(iv),m(ib),m(iw),m(iC)],this.titleArr=[`${tB("tool-brush")} [B]`,`${tB("tool-paint-bucket")} [G]`,`${tB("tool-gradient")} [G]`,`${tB("tool-text")} [T]`,`${tB("tool-shape")} [U]`],this.currentActiveIndex=0,this.isActive=!0;let r=!1;setTimeout(()=>{for(let t=1;t<this.imArr.length;t++)new Image().src=this.imArr[t]},100),this.rootEl=tI.el({css:{position:"relative",flexGrow:"1"}});let a=!1;tI.hasPointerEvents&&new tI.PointerListener({target:this.rootEl,onPointer:n=>{if("pointerdown"===n.type)r||(e=setTimeout(()=>{c()},400),a=!0,i=n.pageX,s=n.pageY);else if("pointermove"===n.type)a&&!r&&tI.dist(i,s,n.pageX,n.pageY)>5&&(clearTimeout(e),c());else if("pointerup"===n.type){if(clearTimeout(e),r&&a){let e=document.elementFromPoint(n.pageX,n.pageY);for(let i=0;i<this.dropdownBtnArr.length;i++)if(e===this.dropdownBtnArr[i].wrapper){p(),this.isActive=!0,this.currentActiveIndex=i,this.updateButton(),t.onChange(this.optionArr[this.currentActiveIndex]);break}}a=!1}}}),this.activeButton=tI.el({parent:this.rootEl,className:"toolspace-row-button nohighlight toolspace-row-button-activated",title:this.titleArr[this.currentActiveIndex],onClick:e=>{if(this.isActive&&!r){e.preventDefault(),e.stopPropagation(),c();return}this.isActive=!0,t.onChange(this.optionArr[this.currentActiveIndex]),r&&p()},css:{padding:"10px 0",pointerEvents:"auto",height:"100%",boxSizing:"border-box"}}),this.activeButtonIm=tI.el({parent:this.activeButton,className:"dark-invert",css:{backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",width:"calc(100% - 7px)",height:"100%",pointerEvents:"none",opacity:"0.75"}}),this.arrowButton=tI.el({parent:this.activeButton,className:"dark-invert",css:{position:"absolute",right:"1px",bottom:"1px",width:"18px",height:"18px",cursor:"pointer",backgroundImage:"url('"+m(eQ)+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"60%"},title:"More Tools",onClick:t=>{t.preventDefault(),t.stopPropagation(),c()}});let n=tI.el({css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0"}});new tI.PointerListener({target:n,onPointer:t=>{"pointerdown"===t.type&&(t.eventPreventDefault(),p())}});let o=tI.el({className:"tool-dropdown-wrapper",css:{position:"absolute",width:"100%",height:100*(this.optionArr.length-1)+"%",top:"100%",left:"0",zIndex:"1",boxSizing:"border-box",cursor:"pointer",transition:"height 0.1s ease-in-out, opacity 0.1s ease-in-out",borderBottomLeftRadius:"5px",borderBottomRightRadius:"5px",overflow:"hidden"}});this.dropdownBtnArr=[];let l=t=>{let e=tI.el({parent:o,className:"tool-dropdown-button",title:t.title,css:{padding:"10px 0",height:100/(this.optionArr.length-1)+"%",boxSizing:"border-box"},onClick:e=>{e.preventDefault(),e.stopPropagation(),t.onClick(t.index)}});return tI.el({parent:e,className:"dark-invert",css:{backgroundImage:"url('"+t.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:"contain",height:"100%",pointerEvents:"none",opacity:"0.75"}}),{wrapper:e,show:t=>{e.style.display=t?"block":"none"},setIsSmall:t=>{e.style.padding=t?this.smallMargin:"10px 0"}}},h=e=>{p(),this.isActive=!0,this.currentActiveIndex=e,this.updateButton(),t.onChange(this.optionArr[this.currentActiveIndex])};for(let t=0;t<this.optionArr.length;t++)this.dropdownBtnArr.push(l({index:t,id:this.optionArr[t],image:this.imArr[t],title:this.titleArr[t],onClick:h}));let c=()=>{B.increase(.5),r=!0;for(let t=0;t<this.optionArr.length;t++)this.dropdownBtnArr[t].show(this.currentActiveIndex!==t);this.arrowButton.style.display="none",this.rootEl.style.zIndex="1",document.body.append(n),this.rootEl.append(o)},p=()=>{B.decrease(.5),r=!1,this.arrowButton.style.removeProperty("display"),this.rootEl.style.removeProperty("z-index"),n.remove(),o.remove()};this.updateButton()}}var ik={};ik=x("dwTKp").getBundleURL("lrLBb")+"tool-undo.540bf765.svg";var iE={};iE=x("dwTKp").getBundleURL("lrLBb")+"inverted-border.3353c7f3.svg";class iI{update(){for(let t=0;t<this.tabArr.length;t++)this.tabArr[t].update(this.activeTab)}getElement(){return this.rootEl}open(t){for(let e=0;e<this.tabArr.length;e++)if(this.tabArr[e].id===t){if(this.activeTab===this.tabArr[e])return;this.activeTab.onClose(),this.activeTab=this.tabArr[e],this.activeTab.onOpen(),this.activeTab.el.append(this.roundRight,this.roundLeft),this.update();return}throw"TabRow.open - invalid tabId"}getOpenedTabId(){return""+this.activeTab.id}setIsVisible(t,e){for(let i=0;i<this.tabArr.length;i++)if(this.tabArr[i].id===t){this.tabArr[i].isVisible=e,this.update();return}throw"TabRow.setIsVisible - invalid tabId"}destroy(){this.tabArr.forEach(t=>{tI.destroyEl(t.el),t.pointerListener.destroy()})}constructor(t){var e;let i=null!==(e=t.height)&&void 0!==e?e:35;this.rootEl=tI.el({className:"tabrow",css:{height:i+1+"px"}}),this.tabArr=[],this.roundRight=tI.el({css:{width:"10px",height:"10px",backgroundImage:`url('${m(iE)}')`,backgroundSize:"cover",position:"absolute",right:"-10px",bottom:"0",pointerEvents:"none"}}),this.roundLeft=tI.el({css:{width:"10px",height:"10px",backgroundImage:`url('${m(iE)}')`,backgroundSize:"cover",position:"absolute",left:"-10px",bottom:"0",transform:"scale(-1,1)",pointerEvents:"none"}});let s=(t,e,s)=>{let r=!("isVisible"in t)||void 0===t.isVisible||t.isVisible,a={id:t.id,isVisible:r,onOpen:t.onOpen,onClose:t.onClose,update:t=>{a.el.className=t===a?s?"tabrow__tab tabrow__tab--opened-accented":"tabrow__tab tabrow__tab--opened":"tabrow__tab",a.el.style.display=a.isVisible?"block":"none"},el:tI.el({parent:this.rootEl,content:"label"in t?t.label:"",title:"title"in t?t.title:void 0,className:e===t.id?s?"tabrow__tab tabrow__tab--opened-accented":"tabrow__tab tabrow__tab--opened":"tabrow__tab",css:{lineHeight:i+"px",display:r?"block":"none",zIndex:"0"},onClick:()=>{this.activeTab!==a&&this.open(a.id)}}),pointerListener:{}};return"image"in t&&tI.el({tagName:"span",parent:a.el,className:"dark-invert",css:{backgroundImage:`url("${t.image}")`,backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat",display:"flex",height:i-7+"px",justifyContent:"center",margin:"4px auto"}}),"css"in t&&void 0!==t.css&&tI.css(a.el,t.css),a.pointerListener=new tI.PointerListener({target:a.el,onEnterLeave:t=>{a.el.classList.toggle("tabrow__tab-hover",t)}}),e===a.id?(a.onOpen(),a.el.append(this.roundRight,this.roundLeft)):a.onClose(),a},r=null;for(let e=0;e<t.tabArr.length;e++){let i=s(t.tabArr[e],t.initialId,t.useAccent||!1);i.id===t.initialId&&(r=i),this.tabArr.push(i)}if(!r)throw"invalid initialId";this.activeTab=r}}var iA={};function iT(t,e){let i=tI.el({tagName:"table",className:"kl-table"});return t.forEach((t,s)=>{let r=tI.el({tagName:"tr"});r.append(...t.map((t,i)=>{let r=tI.el({tagName:"td",content:t}),a=s+"."+i;return void 0!==e&&a in e&&(r.rowSpan=e[a].rowspan),r})),i.append(r)}),i}iA=x("dwTKp").getBundleURL("lrLBb")+"edit-rotate.fd0e572a.svg";var iM={};iM=x("dwTKp").getBundleURL("lrLBb")+"ui-collapse.2b5dfc6a.svg";class iL{getElement(){return this.rootEl}getValues(){let t=this.colorOptions.getValue();return null===t||(null==t?void 0:t.a)===0?{fill:void 0}:{fill:{color:{...t,a:this.opacitySlider.getValue()}}}}destroy(){this.colorOptions.destroy(),this.opacitySlider.destroy()}constructor(t){let e=()=>{t.onUpdate(this.getValues())},i=[null,t.fill?{...t.fill.color,a:1}:null,{...t.primaryColor,a:1},{...t.secondaryColor,a:1},{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];this.colorOptions=new ea({colorArr:i,initialIndex:t.fill?1:0,title:tB("shape-fill"),onChange:t=>{this.opacitySlider.getElement().style.display=null!==t?"":"none",e()}}),this.opacitySlider=new tQ({label:tB("opacity"),width:150,height:30,min:.01,max:1,value:t.fill?t.fill.color.a:1,resolution:225,eventResMs:1e3/30,toValue:t=>t/100,toDisplayValue:t=>100*t,onChange:()=>e()}),this.opacitySlider.getElement().style.display=t.fill?"":"none";let s=k({elementType:"svg",class:"dark-invert",width:"25px",height:"25px",viewBox:"0 0 30 30",childrenArr:[{elementType:"polyline",points:"0,0 30,0 30,8 19,8 19,30 11,30 11,8 0,8 0,0 1,0","transform-origin":"15px 15px",transform:"scale(0.8)",fill:"#000c"}]});this.rootEl=tJ(",flex,gap-10,items-center,flexWrap,minh-30",[s,this.colorOptions.getElement(),this.opacitySlider.getElement()])}}var iR={};iR=x("dwTKp").getBundleURL("lrLBb")+"align-left.4876a845.svg";var iP={};iP=x("dwTKp").getBundleURL("lrLBb")+"align-center.6f56d4bd.svg";var iD={};iD=x("dwTKp").getBundleURL("lrLBb")+"align-right.1521d61c.svg";var iB={};iB=x("dwTKp").getBundleURL("lrLBb")+"typo-italic.7ab32910.svg";var iO={};iO=x("dwTKp").getBundleURL("lrLBb")+"typo-bold.5c790c89.svg";var iz={};iz=x("dwTKp").getBundleURL("lrLBb")+"Caveat-Regular.2fe80bbd.woff2";var iV={};iV=x("dwTKp").getBundleURL("lrLBb")+"ClimateCrisis-Regular-VariableFont_YEAR.3ad02523.woff2";var iH={};iH=x("dwTKp").getBundleURL("lrLBb")+"CorrectionBrush.a69973aa.woff2";var ij={};ij=x("dwTKp").getBundleURL("lrLBb")+"DancingScript-Regular.ef2fe647.woff2";var iF={};iF=x("dwTKp").getBundleURL("lrLBb")+"Diabolik-Regular-VF.f4eeb79e.woff2";var iW={};iW=x("dwTKp").getBundleURL("lrLBb")+"FreckleFace-Regular.05946539.woff2";var iU={};iU=x("dwTKp").getBundleURL("lrLBb")+"Gloock-Regular.60f8f765.woff2";var iN={};iN=x("dwTKp").getBundleURL("lrLBb")+"Pacha.08c8457a.woff2";var i_={};i_=x("dwTKp").getBundleURL("lrLBb")+"GochiHand-Regular.c45792b0.woff2";var iY={};iY=x("dwTKp").getBundleURL("lrLBb")+"PassionOne-Bold.9e08b0dc.woff2";var iX={};iX=x("dwTKp").getBundleURL("lrLBb")+"PixeloidSans.bc292131.woff2";var iG={};iG=x("dwTKp").getBundleURL("lrLBb")+"PlaypenSans-Thin.314b29a4.woff2";var iK={};iK=x("dwTKp").getBundleURL("lrLBb")+"Quicksand-Light.1f0c44a2.woff2";var iq={};iq=x("dwTKp").getBundleURL("lrLBb")+"Silkscreen-Regular.cef2b4cb.woff2";var i$={};i$=x("dwTKp").getBundleURL("lrLBb")+"Tehroc-Regular.4540047b.woff2";var iQ={};iQ=x("dwTKp").getBundleURL("lrLBb")+"YUNGA-Display.30c04a15.woff2";const iZ=[{name:"Caveat",url:m(iz)},{name:"ClimateCrisis",url:m(iV)},{name:"CorrectionBrush",url:m(iH)},{name:"DancingScript",url:m(ij)},{name:"Diabolik",url:m(iF)},{name:"FreckleFace",url:m(iW)},{name:"Gloock",url:m(iU)},{name:"GochiHand",url:m(i_)},{name:"Pacha",url:m(iN)},{name:"PassionOne",url:m(iY)},{name:"PixeloidSans",url:m(iX)},{name:"PlaypenSans",url:m(iG)},{name:"Quicksand",url:m(iK)},{name:"Silkscreen",url:m(iq)},{name:"Tehroc",url:m(i$)},{name:"YUNGA",url:m(iQ)}],iJ=[{fontFamily:"sans-serif",fontName:"Sans-serif"},{fontFamily:"serif",fontName:"Serif"},{fontFamily:"monospace",fontName:"Monospace"},{fontFamily:"cursive",fontName:"Cursive"},{fontFamily:"fantasy",fontName:"Fantasy"},...iZ.map(t=>({fontFamily:t.name,fontName:t.name}))];let i0=!1;async function i1(){if(i0)return;i0=!0;let t=[];for(let e=0;e<iZ.length;e++)t.push((async()=>{let t=iZ[e],i=await fetch(t.url),s=await i.arrayBuffer(),r=new FontFace(t.name,s);document.fonts.add(r)})());await Promise.all(t)}class i2{loadBundledFonts(){i0||i1().then(()=>{this.onUpdate({font:this.fontSelect.getValue()})})}importFont(){let t=document.createElement("input");t.type="file",t.multiple=!0,t.accept=".ttf, .otf, .woff, .woff2, .eot",t.focus(),t.click(),t.onchange=async()=>{let e;if(!t.files||0===t.files.length)return;let i=iJ.map(t=>t.fontFamily);for(let s=0;s<t.files.length;s++){let r=t.files[s],a="kl-"+iJ.length;if(i.includes(a))continue;e||(e=a,this.importButton.disabled=!0,this.importButton.innerText=tB("loading"));let n=r.name.split(".");n.pop(),iJ.push({fontFamily:a,fontName:n.join(".")});let o=new FontFace(a,await r.arrayBuffer());document.fonts.add(o)}setTimeout(()=>{this.fontSelect.setOptionArr(iJ.map(t=>[t.fontFamily,t.fontName,{css:{fontFamily:t.fontFamily,fontSize:"1.2em"}}])),this.fontSelect.setValue(e),this.onUpdate({font:e}),this.importButton.disabled=!1,this.importButton.innerText=tB("file-import")})}}getElement(){return this.rootEl}getValues(){return{font:this.fontSelect.getValue(),size:+this.sizeInput.getValue(),letterSpacing:+this.letterSpacingInput.getValue(),lineHeight:+this.lineHeightInput.getValue(),align:this.alignRadioList.getValue(),isItalic:this.italicToggle.getValue(),isBold:this.boldToggle.getValue()}}destroy(){this.fontPointerListener.destroy(),this.fontSelect.getElement().removeEventListener("focus",this.onFocus),this.fontSelect.destroy(),tI.destroyEl(this.importButton),this.sizeInput.destroy(),this.lineHeightInput.destroy(),this.letterSpacingInput.destroy(),this.alignRadioList.destroy(),this.italicToggle.destroy(),this.boldToggle.destroy()}constructor(t){var e,i;this.onUpdate=t.onUpdate,this.fontSelect=new tN({initValue:t.font,optionArr:iJ.map(t=>[t.fontFamily,t.fontName,{css:{fontFamily:t.fontFamily,fontSize:"1.2em"}}]),isFocusable:!0,css:{width:"180px"},onChange:e=>{this.loadBundledFonts(),t.onUpdate({font:e})}}),this.onFocus=()=>this.loadBundledFonts(),this.fontSelect.getElement().addEventListener("focus",this.onFocus),this.fontPointerListener=new tI.PointerListener({target:this.fontSelect.getElement(),onWheel:t=>this.fontSelect.setDeltaValue(t.deltaY)}),this.importButton=tI.el({tagName:"button",content:tB("file-import"),onClick:()=>{this.importFont()}});let s=tI.el({content:'<div><span style="font-size: 0.6em; margin-right: -1px">A</span>A</div>',css:{width:"25px",height:"25px",display:"flex",justifyContent:"center",alignItems:"center",fontSize:"1.2em",userSelect:"none"}});this.sizeInput=new tW({title:tB("text-size"),type:"number",min:0,max:1e3,init:t.size,onChange:e=>{t.onUpdate({size:parseFloat(e)})},doResetIfInvalid:!0,doScrollWithoutFocus:!0,css:{width:"70px"}}),this.lineHeightInput=new tW({label:tB("text-line-height"),type:"number",min:0,max:10,step:.1,init:null!==(e=t.lineHeight)&&void 0!==e?e:1,onChange:e=>{t.onUpdate({lineHeight:parseFloat(e)})},doResetIfInvalid:!0,doScrollWithoutFocus:!0,css:{width:"60px"}}),this.letterSpacingInput=new tW({label:tB("text-letter-spacing"),type:"number",min:-100,max:100,init:null!==(i=t.letterSpacing)&&void 0!==i?i:0,onChange:e=>{t.onUpdate({letterSpacing:parseFloat(e)})},doResetIfInvalid:!0,doScrollWithoutFocus:!0,css:{width:"60px"}}),this.alignRadioList=new tY({optionArr:[{id:"left",title:tB("text-left"),image:m(iR),darkInvert:!0},{id:"center",title:tB("text-center"),image:m(iP),darkInvert:!0},{id:"right",title:tB("text-right"),image:m(iD),darkInvert:!0}],initId:t.align,onChange:e=>t.onUpdate({align:e})}),this.italicToggle=new t_({image:m(iB),title:tB("text-italic"),initValue:t.isItalic,onChange:e=>t.onUpdate({isItalic:e}),darkInvert:!0}),this.boldToggle=new t_({image:m(iO),title:tB("text-bold"),initValue:t.isBold,onChange:e=>t.onUpdate({isBold:e}),darkInvert:!0}),this.rootEl=tJ(",flex,flexWrap,gap-10-15,items-center",[tJ(",flex,gap-5,items-center",[s,this.sizeInput.getElement()]),tJ(",flex,gap-5",[this.fontSelect.getElement(),this.importButton]),tJ(",flex,gap-7",[this.alignRadioList.getElement(),this.italicToggle.getElement(),this.boldToggle.getElement()]),this.letterSpacingInput.getElement(),this.lineHeightInput.getElement()])}}class i5{getElement(){return this.rootEl}getValues(){let t=this.colorOptions.getValue();return null===t||(null==t?void 0:t.a)===0?{stroke:void 0}:{stroke:{color:{...t,a:this.opacitySlider.getValue()},lineWidth:this.lineWidthSlider.getValue()}}}destroy(){this.colorOptions.destroy(),this.opacitySlider.destroy(),this.lineWidthSlider.destroy()}constructor(t){this.rootEl=tI.el({css:{boxShadow:"0 0 0 1px #aaa"}});let e=()=>{t.onUpdate(this.getValues())},i=[null,t.stroke?{...t.stroke.color,a:1}:null,{...t.secondaryColor,a:1},{...t.primaryColor,a:1},{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1}];this.colorOptions=new ea({colorArr:i,initialIndex:t.stroke?1:0,title:tB("shape-stroke"),onChange:t=>{this.opacitySlider.getElement().style.display=null!==t?"":"none",this.lineWidthSlider.getElement().style.display=null!==t?"":"none",e()}}),this.opacitySlider=new tQ({label:tB("opacity"),width:150,height:30,min:.01,max:1,value:t.stroke?t.stroke.color.a:1,resolution:225,eventResMs:1e3/30,toValue:t=>t/100,toDisplayValue:t=>100*t,onChange:()=>e()}),this.lineWidthSlider=new tQ({label:tB("shape-line-width"),width:150,height:30,min:.5,max:100,value:t.stroke?t.stroke.lineWidth:2,eventResMs:1e3/30,curve:"quadratic",onChange:()=>e()}),this.opacitySlider.getElement().style.display=t.stroke?"":"none",this.lineWidthSlider.getElement().style.display=t.stroke?"":"none";let s=k({elementType:"svg",class:"dark-invert",width:"25px",height:"25px",viewBox:"0 0 30 30",childrenArr:[{elementType:"polyline",points:"0,0 30,0 30,8 19,8 19,30 11,30 11,8 0,8 0,0 1,0",fill:"none",stroke:"#000c","stroke-width":"3","transform-origin":"15px 15px",transform:"scale(0.8)"}]});this.rootEl=tJ(",flex,gap-10,items-center,flexWrap,minh-30",[s,this.colorOptions.getElement(),this.opacitySlider.getElement(),this.lineWidthSlider.getElement()])}}class i3{emit(){let t=this.textInput.value;t!==this.lastEmittedText&&(this.lastEmittedText=t,this.onUpdate({text:t}))}getElement(){return this.rootEl}getValues(){return{text:this.textInput.value}}focus(){this.textInput.focus()}destroy(){tI.destroyEl(this.textInput),this.textInput.removeEventListener("input",this.onInput)}constructor(t){this.onInput=()=>{this.emit()},this.lastEmittedText=t.text,this.onUpdate=t.onUpdate,this.rootEl=tJ(""),this.textInput=tI.el({tagName:"textarea",parent:this.rootEl,content:t.text,custom:{placeholder:tB("text-placeholder")},css:{whiteSpace:"pre",overflow:"auto",width:"100%",height:"70px",resize:"vertical"},onChange:()=>{this.emit()}}),this.textInput.addEventListener("input",this.onInput)}}class i4{canZoom(t){return this.zoomFac!==Math.min(2,Math.max(-2,this.zoomFac+t))}changeZoomFac(t){this.zoomFac=Math.min(2,Math.max(-2,this.zoomFac+t)),this.render(),this.zoomInBtn.disabled=!this.canZoom(1),this.zoomOutBtn.disabled=!this.canZoom(-1)}move(t,e){let i=tI.rotate(t,e,-this.rotationSlider.getValue()/Math.PI*180);this.text.x+=i.x/this.scale,this.text.y+=i.y/this.scale,this.render()}render(){let t=this.rotationSlider.getValue();this.textCtx.clearRect(0,0,this.textCanvas.width,this.textCanvas.height);let e=eF(this.textCanvas,{...this.text,x:this.text.x,y:this.text.y,angleRad:this.rotationSlider.getValue()}),i=tI.Vec2.mul(tI.rotate(this.offset.x,this.offset.y,-t/Math.PI*180),1/this.scale);e.width=Math.max(e.width,1),e.height=Math.max(e.height,1);let s=tI.rotate(e.x,e.y,-t/Math.PI*180),r=tI.rotate(e.width,e.height,-t/Math.PI*180),a=this.text.x+s.x+r.x/2+i.x,n=this.text.y+s.y+r.y/2+i.y,o=tI.fitInto(e.width,e.height,this.width-100,this.height-100);this.scale=Math.min(1,o.width/e.width),this.scale=Math.min(4,this.scale*Math.pow(2,this.zoomFac)),this.targetCtx.save(),this.scale>=4?this.targetCtx.imageSmoothingEnabled=!1:(this.targetCtx.imageSmoothingEnabled=!0,this.targetCtx.imageSmoothingQuality=this.scale>=1?"low":"medium"),this.targetCtx.clearRect(0,0,this.previewCanvas.width,this.previewCanvas.height),this.targetCtx.translate(this.width/2,this.height/2),this.targetCtx.scale(this.scale,this.scale),this.targetCtx.rotate(t),this.targetCtx.drawImage(this.layerArr[this.layerIndex].canvas,-a,-n),this.targetCtx.drawImage(this.textCanvas,-a,-n),this.targetCtx.restore();let l=ee.isDark();this.layersCtx.save(),this.layersCtx.fillStyle=l?"rgb(33,33,33)":"rgb(158,158,158)",this.layersCtx.fillRect(0,0,this.width,this.height);{this.layersCtx.save(),this.layersCtx.translate(this.width/2,this.height/2),this.layersCtx.scale(this.scale,this.scale),this.layersCtx.rotate(t),this.layersCtx.imageSmoothingEnabled=!1;let e=1/this.scale;this.layersCtx.globalAlpha=l?.25:.2,this.layersCtx.drawImage(l?this.emptyCanvasLight:this.emptyCanvas,-a-e,-n-e,this.textCanvas.width+2*e,this.textCanvas.height+2*e),this.layersCtx.globalAlpha=1,this.layersCtx.globalCompositeOperation="destination-out",this.layersCtx.drawImage(this.emptyCanvas,-a,-n,this.textCanvas.width,this.textCanvas.height),this.layersCtx.restore()}this.scale>=4?this.layersCtx.imageSmoothingEnabled=!1:(this.layersCtx.imageSmoothingEnabled=!0,this.layersCtx.imageSmoothingQuality=this.scale>=1?"low":"medium"),this.layersCtx.save(),this.layersCtx.translate(this.width/2,this.height/2),this.layersCtx.scale(this.scale,this.scale),this.layersCtx.rotate(t);for(let t=0;t<this.layerIndex;t++)this.layerArr[t].isVisible&&this.layerArr[t].opacity>0&&(this.layersCtx.globalAlpha=this.layerArr[t].opacity,this.layersCtx.globalCompositeOperation=this.layerArr[t].mixModeStr,this.layersCtx.drawImage(this.layerArr[t].canvas,-a,-n));this.layersCtx.restore(),this.layersCtx.globalAlpha=this.layerArr[this.layerIndex].opacity*(this.layerArr[this.layerIndex].isVisible?1:0),this.layersCtx.globalCompositeOperation=this.layerArr[this.layerIndex].mixModeStr,this.layersCtx.drawImage(this.targetCanvas,0,0),this.layersCtx.save(),this.layersCtx.translate(this.width/2,this.height/2),this.layersCtx.scale(this.scale,this.scale),this.layersCtx.rotate(t);for(let t=this.layerIndex+1;t<this.layerArr.length;t++)this.layerArr[t].isVisible&&this.layerArr[t].opacity>0&&(this.layersCtx.globalAlpha=this.layerArr[t].opacity,this.layersCtx.globalCompositeOperation=this.layerArr[t].mixModeStr,this.layersCtx.drawImage(this.layerArr[t].canvas,-a,-n));this.layersCtx.restore(),this.layersCtx.restore(),this.previewCtx.save(),this.previewCtx.fillStyle=this.checkerPattern,this.previewCtx.fillRect(0,0,this.previewCanvas.width,this.previewCanvas.height),this.previewCtx.drawImage(this.layersCanvas,0,0),this.previewCtx.restore(),this.previewCtx.save(),this.previewCtx.globalCompositeOperation="difference",this.previewCtx.strokeStyle="#fff",this.previewCtx.lineWidth=.5,this.previewCtx.translate(-this.offset.x,-this.offset.y),this.previewCtx.strokeRect(Math.round(this.width/2-e.width/2*this.scale)+.5,Math.round(this.height/2-e.height/2*this.scale)+.5,Math.round(e.width*this.scale),Math.round(e.height*this.scale)),this.previewCtx.restore()}getElement(){return this.rootEl}getInputsElement(){return this.inputsRootEl}getValues(){return{x:this.text.x,y:this.text.y,angleRad:this.rotationSlider.getValue()}}setText(t){let e=this.text.x,i=this.text.y,s=this.text.angleRad;this.text={...t,x:e,y:i,angleRad:s},this.render()}setSize(t,e){(t!==this.width||e!==this.height)&&(this.width=t,this.height=e,this.targetCanvas.width=this.width,this.targetCanvas.height=this.height,this.layersCanvas.width=this.width,this.layersCanvas.height=this.height,this.previewCanvas.width=this.width,this.previewCanvas.height=this.height,this.previewWrapper.style.width=this.width+"px",this.render())}destroy(){tI.destroyEl(this.rootEl),tI.destroyEl(this.inputsRootEl),tI.destroyEl(this.previewWrapper),clearInterval(this.interval),this.rotationSlider.destroy(),tI.destroyEl(this.zoomInBtn),tI.destroyEl(this.zoomOutBtn),this.eventCapture.remove(),this.previewPointerListener.destroy(),this.keyListener.destroy(),ee.removeIsDarkListener(this.onDarkChange)}constructor(t){this.offset={x:0,y:0},this.zoomFac=0,this.scale=1,this.layerArr=[],this.onDarkChange=()=>{this.checkerPattern=E(this.previewCtx.createPattern(tI.createCheckerCanvas(8,ee.isDark()),"repeat")),this.render()},this.rootEl=tJ(),this.text=t.text,this.layerIndex=t.layerIndex;let e=window.innerWidth<550,i=window.innerHeight<630;this.width=e?340:540,this.height=e?i?210:260:i?230:350,this.layerArr=t.klCanvas.getLayersFast(),this.textCanvas=tI.canvas(t.klCanvas.getWidth(),t.klCanvas.getHeight()),this.textCtx=tI.ctx(this.textCanvas),this.targetCanvas=tI.canvas(this.width,this.height),this.targetCtx=tI.ctx(this.targetCanvas),this.layersCanvas=tI.canvas(this.width,this.height),this.layersCtx=tI.ctx(this.layersCanvas),this.previewCanvas=tI.canvas(this.width,this.height),this.previewCtx=tI.ctx(this.previewCanvas),tI.css(this.previewCanvas,{display:"block"}),this.previewWrapper=tI.el({parent:this.rootEl,css:{position:"relative",width:this.width+"px",cursor:"move",touchAction:"none"}}),tI.el({parent:this.previewWrapper,className:"kl-text-preview-wrapper"}),this.previewWrapper.append(this.previewCanvas),this.checkerPattern=E(this.previewCtx.createPattern(tI.createCheckerCanvas(8,ee.isDark()),"repeat")),this.emptyCanvas=tI.canvas(1,1),this.emptyCanvasLight=tI.canvas(1,1);{let t=tI.ctx(this.emptyCanvas);t.fillRect(0,0,1,1),(t=tI.ctx(this.emptyCanvasLight)).fillStyle="#fff",t.fillRect(0,0,1,1)}ee.addIsDarkListener(this.onDarkChange),this.previewCanvas.oncontextmenu=t=>t.preventDefault();let s=!1,r=!1,a=!1;this.previewPointerListener=new tI.PointerListener({target:this.previewCanvas,onPointer:e=>{if("pointerdown"===e.type&&(s=!1,r=!0),"pointermove"===e.type&&r&&(s=!0),"pointerup"===e.type&&(r&&s&&"mouse"===e.pointerType&&t.onDragEnd(),s=!1,r=!1),"pointermove"===e.type&&"left"===e.button&&(e.eventPreventDefault(),this.offset={x:0,y:0},this.move(-e.dX,-e.dY)),"pointerdown"===e.type&&"right"===e.button&&document.body.append(this.eventCapture),"pointerup"===e.type&&setTimeout(()=>this.eventCapture.remove(),20),"pointermove"===e.type&&"right"===e.button&&(a=!0,e.eventPreventDefault(),this.offset.x-=e.dX,this.offset.y-=e.dY,this.render()),"pointerup"===e.type&&a){let t=0;this.interval=setInterval(()=>{t>8&&(clearInterval(this.interval),this.offset={x:0,y:0},this.render()),this.offset={x:.6*this.offset.x,y:.6*this.offset.y},this.render(),t++},10),this.offset={x:.6*this.offset.x,y:.6*this.offset.y},this.render()}},onWheel:t=>{this.changeZoomFac(-t.deltaY)}}),this.previewCanvas.addEventListener("wheel",t=>t.preventDefault()),this.rotationSlider=new tQ({label:tB("filter-transform-rotation"),width:150,height:30,min:-Math.PI,max:Math.PI,value:t.text.angleRad,resolution:225,toValue:t=>t*Math.PI/180,toDisplayValue:t=>t/Math.PI*180,onChange:()=>{this.offset={x:0,y:0},this.render()},unit:""}),this.zoomInBtn=tI.el({tagName:"button",content:`<img height="20" src="${m(eE)}">`,title:tB("zoom-in"),onClick:()=>this.changeZoomFac(1),css:{fontWeight:"bold"}}),this.zoomOutBtn=tI.el({tagName:"button",content:`<img height="20" src="${m(eI)}">`,title:tB("zoom-out"),onClick:()=>this.changeZoomFac(-1),css:{fontWeight:"bold"}}),this.eventCapture=tI.el({css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",zIndex:"999",cursor:"move"}}),this.eventCapture.oncontextmenu=t=>t.preventDefault(),this.keyListener=new tI.KeyListener({onDown:t=>{if(tI.isInputFocused(!0))return;let e=this.keyListener.isPressed("shift")?4:1;"left"===t&&this.move(-e,0),"right"===t&&this.move(e,0),"up"===t&&this.move(0,-e),"down"===t&&this.move(0,e)}}),this.inputsRootEl=tJ(",flex,gap-5",[this.rotationSlider.getElement(),tJ(),this.zoomInBtn,this.zoomOutBtn])}}d="_5vlQAW_viewportWrapper";var i9={};function i6(){i||(s=Object.fromEntries(Object.entries(i={"source-over":"normal",darken:"darken",multiply:"multiply","color-burn":"color burn",lighten:"lighten",screen:"screen","color-dodge":"color dodge",overlay:"overlay","soft-light":"soft light","hard-light":"hard light",difference:"difference",exclusion:"exclusion",hue:"hue",saturation:"saturation",color:"color",luminosity:"luminosity"}).map(t=>t.reverse())))}function i8(t){return i6(),s[t]}function i7(t){return i6(),i[t]}function st(t){let e;if(!t.canvas)throw Error("psdObj.canvas undefined");let i={type:"psd",canvas:t.canvas,width:t.width,height:t.height};function s(t){i.warningArr||(i.warningArr=[]),i.warningArr.includes(t)||i.warningArr.push(t)}function r(t){let e=i8(t);return e||(s("blend-mode"),e="source-over"),e}if(8!==t.bitsPerChannel&&s("bits-per-channel"),!t.children||0+function t(e){let i=0;if(e.blendMode){let t=i8(e.blendMode);if(t&&"source-over"!==t)return 1}if(e.children)for(let r=0;r<e.children.length;r++){let a=e.children[r];!a.clipping&&!a.adjustment&&(a.children?(s("group"),i+=t(a)):i++)}return i}(t)>16)return i.error=!0,i;function a(t,e){let i=tI.ctx(t),s=i.getImageData(0,0,t.width,t.height);if(0===e)for(let t=0;t<s.data.length;t+=4)s.data[t+3]=s.data[t];else for(let t=0;t<s.data.length;t+=4)s.data[t+3]=255-s.data[t];i.putImageData(s,0,0)}return i.layers=[],i.layers=function t(e){let n,o,l=[],h=!e.hidden,c=I(e.opacity,"groupOpacity is undefined"),p=r(e.blendMode);if("source-over"!==p&&(n=ta(i.width,i.height),o=tI.ctx(n)),e.mask&&(s("mask"),a(e.mask.canvas,e.mask.defaultColor)),e.children)for(let p=0;p<e.children.length;p++){let d=e.children[p];if(d.clipping)continue;if(d.adjustment){s("adjustment");continue}let u=(d.children||d.canvas)&&e.children[p+1]&&e.children[p+1].clipping;if(u&&s("clipping"),d.children){let s=t(d);for(let t=0;t<s.length;t++){let a=s[t],h=tI.ctx(a.image);if(u){let t=ta(i.width,i.height),s=tI.ctx(t);s.drawImage(a.image,0,0);for(let t=p+1;t<e.children.length&&e.children[t].clipping;t++){let i=e.children[t];if(0!==i.opacity&&!i.hidden){if(void 0===i.blendMode)throw Error("clippingItem.blendMode undefined");if(void 0===i.opacity)throw Error("clippingItem.opacity undefined");if(void 0===i.canvas)throw Error("clippingItem.canvas undefined");if(void 0===i.left)throw Error("clippingItem.left undefined");if(void 0===i.top)throw Error("clippingItem.top undefined");s.globalCompositeOperation=r(i.blendMode),s.globalAlpha=i.opacity,s.drawImage(i.canvas,i.left,i.top)}}h.globalCompositeOperation="source-atop",h.drawImage(t,0,0)}if(e.mask){if(h.globalCompositeOperation=0===e.mask.defaultColor?"destination-in":"destination-out",void 0===e.mask.canvas)throw Error("psdGroupObj.mask.canvas undefined");if(void 0===e.mask.left)throw Error("psdGroupObj.mask.left undefined");if(void 0===e.mask.top)throw Error("psdGroupObj.mask.top undefined");h.drawImage(e.mask.canvas,e.mask.left,e.mask.top)}if(n){if(void 0===o)throw Error("groupCtx undefined");o.globalCompositeOperation=a.mixModeStr,o.globalAlpha=a.opacity,o.drawImage(a.image,0,0)}else a.opacity=a.opacity*c,l.push(a)}continue}let g=ta(i.width,i.height),m=tI.ctx(g);if(d.canvas){if(void 0===d.top)throw Error("item.top undefined");if(void 0===d.left)throw Error("item.left undefined");m.drawImage(d.canvas,d.left,d.top)}if(d.effects&&s("layer-effect"),d.mask){if(s("mask"),void 0===d.mask.canvas)throw Error("item.mask.canvas undefined");if(void 0===d.mask.defaultColor)throw Error("item.mask.defaultColor undefined");if(void 0===d.mask.left)throw Error("item.mask.left undefined");if(void 0===d.mask.top)throw Error("item.mask.top undefined");a(d.mask.canvas,d.mask.defaultColor),m.globalCompositeOperation=0===d.mask.defaultColor?"destination-in":"destination-out",m.drawImage(d.mask.canvas,d.mask.left,d.mask.top)}if(u){if(void 0===d.right)throw Error("item.right undefined");if(void 0===d.left)throw Error("item.left undefined");if(void 0===d.bottom)throw Error("item.bottom undefined");if(void 0===d.top)throw Error("item.top undefined");if(void 0===d.canvas)throw Error("item.canvas undefined");let t=ta(d.right-d.left,d.bottom-d.top),i=tI.ctx(t);i.drawImage(d.canvas,0,0);for(let t=p+1;t<e.children.length&&e.children[t].clipping;t++){let s=e.children[t];if(0!==s.opacity&&!s.hidden){if(void 0===s.blendMode)throw Error("clippingItem.blendMode undefined");if(void 0===s.opacity)throw Error("clippingItem.opacity undefined");if(void 0===s.canvas)throw Error("clippingItem.canvas undefined");if(void 0===s.left)throw Error("clippingItem.left undefined");if(void 0===s.top)throw Error("clippingItem.top undefined");i.globalCompositeOperation=r(s.blendMode),i.globalAlpha=s.opacity,i.drawImage(s.canvas,s.left-d.left,s.top-d.top)}}m.globalCompositeOperation="source-atop",m.drawImage(t,d.left,d.top)}if(e.mask){if(m.globalCompositeOperation=0===e.mask.defaultColor?"destination-in":"destination-out",void 0===e.mask.canvas)throw Error("psdGroupObj.mask.canvas undefined");if(void 0===e.mask.left)throw Error("psdGroupObj.mask.left undefined");if(void 0===e.mask.top)throw Error("psdGroupObj.mask.top undefined");m.drawImage(e.mask.canvas,e.mask.left,e.mask.top)}if(void 0===d.blendMode)throw Error("item.blendMode undefined");if(void 0===d.hidden)throw Error("item.hidden  undefined");if(void 0===d.opacity)throw Error("item.opacity undefined");if(n&&o)c>0&&(o.globalCompositeOperation=r(d.blendMode),o.globalAlpha=d.hidden?0:d.opacity,o.drawImage(g,0,0));else{if(void 0===d.name)throw Error("item.name undefined");l.push({name:d.name,isVisible:!d.hidden&&h,opacity:d.opacity*c,mixModeStr:r(d.blendMode),image:g})}}if(n){if(void 0===e.name)throw Error("psdGroupObj.name undefined");l=[{name:e.name,isVisible:h,opacity:c,mixModeStr:p,image:n}]}return l}({name:"root",opacity:1,blendMode:"normal",children:t.children}),i}function se(t){let e={width:t.width,height:t.height,layers:[]};return t.layers?e.layers=t.layers.map(t=>({name:t.name,isVisible:t.isVisible,opacity:t.opacity,mixModeStr:t.mixModeStr,image:t.image})):e.layers=[{name:tB("background"),isVisible:!0,opacity:1,mixModeStr:"source-over",image:t.canvas}],e}g(i9,"blendPsdToKl",function(){return i8}),g(i9,"blendKlToPsd",function(){return i7}),g(i9,"readPsd",function(){return st}),g(i9,"klPsdToKlProject",function(){return se});var si={};g(si,"setDbName",function(){return sn}),g(si,"getKlProjectObj",function(){return sl}),g(si,"storeKlProjectObj",function(){return sh}),g(si,"clear",function(){return sc});const ss=!!window.indexedDB;let sr="Klecks";const sa="ProjectStore";function sn(t){sr=""+t}function so(t,e,i){let s,r=!1;function a(t){r||(r=!0,i(t))}if(!ss){setTimeout(function(){a("no indexed db available")},0);return}try{s=window.indexedDB.open(sr,1)}catch(t){a(t.message);return}s.onupgradeneeded=function(){try{s.result.createObjectStore(sa,{keyPath:"id"}).createIndex("id","id",{unique:!0})}catch(t){a(t.message)}},s.onerror=function(){a("indexedDB.open failed, "+s.error)},s.onsuccess=function(){let i,n,o;try{if(!(i=s.result).objectStoreNames.contains(sa)){window.indexedDB.deleteDatabase(sr),a("object store "+sa+" missing. destroying db");return}(o=(n=i.transaction(sa,"readwrite")).objectStore(sa)).index("id")}catch(t){a(t.message);return}i.onerror=function(){a("database error, "+i.error)};try{t(o)}catch(t){a(t.message);return}n.oncomplete=function(){r||(r=!0,e()),i.close()},n.onerror=function(){a("transaction error, "+n.error)}}}function sl(t,e){if(ss){let i;so(function(t){i=t.get(1)},function(){t(i.result)},function(t){e("execIndexedDBTransaction error, "+t)})}else t(void 0)}function sh(t,e,i){so(function(e){e.put(t)},function(){e()},function(t){i(t)})}function sc(t,e){so(function(t){t.delete(1)},function(){t()},function(t){e(t)})}var sp={};sp=x("dwTKp").getBundleURL("lrLBb")+"edit-brightness-contrast.8430cb26.svg";var sd={};sd=x("dwTKp").getBundleURL("lrLBb")+"edit-curves.bbdb97b2.svg";var su={};su=x("dwTKp").getBundleURL("lrLBb")+"edit-flip.00fd2c6b.svg";var sg={};sg=x("dwTKp").getBundleURL("lrLBb")+"edit-hue-saturation.6e36cf05.svg";var sm={};sm=x("dwTKp").getBundleURL("lrLBb")+"edit-invert.f5d05ba3.png";var sy={};sy=x("dwTKp").getBundleURL("lrLBb")+"edit-perspective.e23100db.svg";var sf={};sf=x("dwTKp").getBundleURL("lrLBb")+"edit-resize.56391e2b.svg";var sx={};sx=x("dwTKp").getBundleURL("lrLBb")+"edit-tilt-shift.f8ae88b3.png";var sv={};sv=x("dwTKp").getBundleURL("lrLBb")+"edit-to-alpha.f7a2065a.svg";var sb={};sb=x("dwTKp").getBundleURL("lrLBb")+"edit-transform.c8795430.svg";var sw={};sw=x("dwTKp").getBundleURL("lrLBb")+"edit-triangle-blur.d2c20f1d.png";var sC={};sC=x("dwTKp").getBundleURL("lrLBb")+"edit-unsharp-mask.f1520547.png";var sS={};sS=x("dwTKp").getBundleURL("lrLBb")+"edit-grid.e900ce7b.svg";var sk={};sk=x("dwTKp").getBundleURL("lrLBb")+"edit-noise.51bd751c.svg";var sE={};sE=x("dwTKp").getBundleURL("lrLBb")+"edit-pattern.1a06e094.svg";var sI={};sI=x("dwTKp").getBundleURL("lrLBb")+"edit-vanish-point.fc5858e4.svg";var sA={};sA=x("dwTKp").getBundleURL("lrLBb")+"edit-distort.bdb643f2.svg";const sT={isLoaded:!1},sM={brightnessContrast:{lang:{name:"filter-bright-contrast-title",button:"filter-bright-contrast",description:"filter-bright-contrast-description"},icon:m(sp),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},cropExtend:{lang:{name:"filter-crop-title",button:"filter-crop-extend",description:"filter-crop-description"},icon:m(eB),updatePos:!0,getDialog:null,apply:null,inEmbed:!1},curves:{lang:{name:"filter-curves-title",button:"filter-curves",description:"filter-curves-description"},icon:m(sd),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},distort:{lang:{name:"filter-distort",button:"filter-distort",description:"filter-distort-description"},icon:m(sA),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},flip:{lang:{name:"filter-flip-title",button:"filter-flip",description:"filter-flip-description"},icon:m(su),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},hueSaturation:{lang:{name:"filter-hue-sat-title",button:"filter-hue-sat",description:"filter-hue-sat-description"},icon:m(sg),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},invert:{lang:{name:"filter-invert",button:"filter-invert"},icon:m(sm),updatePos:!1,isInstant:!0,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},perspective:{lang:{name:"filter-perspective-title",button:"filter-perspective",description:"filter-perspective-description"},icon:m(sy),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},resize:{lang:{name:"filter-resize-title",button:"filter-resize",description:"filter-resize-description"},icon:m(sf),updatePos:!0,getDialog:null,apply:null,inEmbed:!1},rotate:{lang:{name:"filter-rotate-title",button:"filter-rotate",description:"filter-rotate-description"},icon:m(iA),updatePos:!0,getDialog:null,apply:null,inEmbed:!1},tiltShift:{lang:{name:"filter-tilt-shift-title",button:"filter-tilt-shift",description:"filter-tilt-shift-description"},icon:m(sx),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},toAlpha:{lang:{name:"filter-to-alpha-title",button:"filter-to-alpha",description:"filter-to-alpha-description"},icon:m(sv),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},transform:{lang:{name:"filter-transform-title",button:"filter-transform",description:"filter-transform-description"},icon:m(sb),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},blur:{lang:{name:"filter-triangle-blur-title",button:"filter-triangle-blur",description:"filter-triangle-blur-description"},icon:m(sw),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},unsharpMask:{lang:{name:"filter-unsharp-mask-title",button:"filter-unsharp-mask",description:"filter-unsharp-mask-description"},icon:m(sC),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,darkNoInvert:!0,webGL:!0},grid:{lang:{name:"filter-grid",button:"filter-grid",description:"filter-grid-description"},icon:m(sS),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},noise:{lang:{name:"filter-noise",button:"filter-noise",description:"filter-noise-description"},icon:m(sk),updatePos:!1,getDialog:null,apply:null,inEmbed:!0,webGL:!0},pattern:{lang:{name:"filter-pattern",button:"filter-pattern",description:"filter-pattern-description"},icon:m(sE),updatePos:!1,getDialog:null,apply:null,inEmbed:!0},vanishPoint:{lang:{name:"filter-vanish-point-title",button:"filter-vanish-point",description:"filter-vanish-point-description"},icon:m(sI),updatePos:!1,getDialog:null,apply:null,inEmbed:!0}},sL={};class sR{dot2(t,e){return this.x*t+this.y*e}constructor(t,e,i){this.x=t,this.y=e,this.z=i}}const sP=[new sR(1,1,0),new sR(-1,1,0),new sR(1,-1,0),new sR(-1,-1,0),new sR(1,0,1),new sR(-1,0,1),new sR(1,0,-1),new sR(-1,0,-1),new sR(0,1,1),new sR(0,-1,1),new sR(0,1,-1),new sR(0,-1,-1)],sD=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],sB=Array(512),sO=Array(512);sL.seed=function(t){t>0&&t<1&&(t*=65536),(t=Math.floor(t))<256&&(t|=t<<8);for(let e=0;e<256;e++){let i;i=1&e?sD[e]^255&t:sD[e]^t>>8&255,sB[e]=sB[e+256]=i,sO[e]=sO[e+256]=sP[i%12]}},sL.seed(0);const sz=.5*(Math.sqrt(3)-1),sV=(3-Math.sqrt(3))/6;function sH(t){let e=t/500,i=tI.canvas(t,t),s=tI.ctx(i),r=s.createImageData(t,t);for(let i=0;i<t;i++)for(let s=0;s<t;s++){let a=(s*t+i)*4,n=e+.04*sL.simplex2(i/50/e,s/50/e),o=100+(sL.simplex2(i/50/n,s/50/n)+1)/2*100;o-=(sL.simplex2(i/10/e,s/10/e)+1)/2*100;let l=tI.dist(t/2,t/2,i,s);o*=tI.clamp(1-((l-t/2.5)/(t/14)+sL.simplex2(i/22/n,s/22/n)),0,1)*(2*tI.clamp(1-l/t,0,1)),r.data[a]=0,r.data[a+1]=0,r.data[a+2]=0,r.data[a+3]=tI.clamp(o,0,255)}return s.putImageData(r,0,0),i}function sj(t){let e,i;e=2/3*(1/4),i=1/3*(1/4);let s={x:1/4*t,y:t-1/4*t},r={x:t-1/4*t,y:1/4*t},a=tI.canvas(t,t),n=tI.ctx(a),o=n.createImageData(t,t);for(let a=0;a<t;a++)for(let n=0;n<t;n++){let l=(n*t+a)*4,h=function(t,e,i){let s=tI.Vec2.sub(i,e),r=tI.Vec2.sub(t,e),a=tI.clamp(tI.Vec2.dot(r,s)/tI.Vec2.dot(s,s),0,1);return tI.Vec2.len(tI.Vec2.sub(r,tI.Vec2.mul(s,a)))}({x:a,y:n},s,r);h=tI.clamp(255-(h-t*e)/(t*i)*255,0,255),o.data[l]=0,o.data[l+1]=0,o.data[l+2]=0,o.data[l+3]=h}return n.putImageData(o,0,0),a}sL.simplex2=function(t,e){let i,s,r,a,n;let o=(t+e)*sz,l=Math.floor(t+o),h=Math.floor(e+o),c=(l+h)*sV,p=t-l+c,d=e-h+c;p>d?(a=1,n=0):(a=0,n=1);let u=p-a+sV,g=d-n+sV,m=p-1+2*sV,y=d-1+2*sV,f=sO[(l&=255)+sB[h&=255]],x=sO[l+a+sB[h+n]],v=sO[l+1+sB[h+1]],b=.5-p*p-d*d;b<0?i=0:(b*=b,i=b*b*f.dot2(p,d));let w=.5-u*u-g*g;w<0?s=0:(w*=w,s=w*w*x.dot2(u,g));let C=.5-m*m-y*y;return C<0?r=0:(C*=C,r=C*C*v.dot2(m,y)),70*(i+s+r)};const sF=[];sF[1]=sH(128),sF[2]=sj(128);const sW=2*Math.PI,sU=tI.canvas(32,32),sN=tI.ctx(sU),s_={PenBrush:class{updateAlphaCanvas(){let t;if(0===this.settingAlphaId||3===this.settingAlphaId)return;let e=[[this.alphaCanvas128,128],[this.alphaCanvas64,64],[this.alphaCanvas32,32]];for(let i=0;i<e.length;i++)(t=tI.ctx(e[i][0])).save(),t.clearRect(0,0,e[i][1],e[i][1]),t.fillStyle="rgba("+this.settingColor.r+", "+this.settingColor.g+", "+this.settingColor.b+", "+this.alphaOpacityArr[this.settingAlphaId]+")",t.fillRect(0,0,e[i][1],e[i][1]),t.globalCompositeOperation="destination-in",t.imageSmoothingQuality="high",t.drawImage(sF[this.settingAlphaId],0,0,e[i][1],e[i][1]),t.restore()}calcOpacity(t){return this.settingOpacity*(this.settingHasOpacityPressure?t*t:1)}drawDot(t,e,i,s,r,a){if(!(i<=0)){if(this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop"),a&&a[3]===s||(this.context.globalAlpha=s),a||0!==this.settingAlphaId&&3!==this.settingAlphaId||(this.context.fillStyle=this.settingColorStr),0===this.settingAlphaId)this.context.beginPath(),this.context.arc(t,e,i,0,sW),this.context.closePath(),this.context.fill(),this.hasDrawnDot=!0;else if(3===this.settingAlphaId)void 0!==r&&(this.context.save(),this.context.translate(t,e),this.context.rotate(r/180*Math.PI),this.context.fillRect(-i,-i,2*i,2*i),this.context.restore(),this.hasDrawnDot=!0);else{this.context.save(),this.context.translate(t,e);let s=this.alphaCanvas128;i<=32&&i>16?s=this.alphaCanvas64:i<=16&&(s=this.alphaCanvas32),this.context.scale(i,i),1===this.settingAlphaId&&this.context.rotate((t+e)*53123%sW),this.context.drawImage(s,-1,-1,2,2),this.context.restore(),this.hasDrawnDot=!0}}}continueLine(t,e,i,s){let r;null===this.bezierLine&&(this.bezierLine=new tI.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,()=>{}));let a=[],n=t=>{let e=tI.mix(this.lastInput2.pressure,s,t.t),i=this.calcOpacity(e),r=Math.max(.1,this.settingSize*(this.settingHasSizePressure?e:1));a.push([t.x,t.y,r,i,t.angle])},o=i*this.settingSpacing;null===t||null===e?this.bezierLine.addFinal(o,n):this.bezierLine.add(t,e,o,n),this.context.save();for(let t=0;t<a.length;t++){let e=a[t];this.drawDot(e[0],e[1],e[2],e[3],e[4],r),r=e}this.context.restore()}startLine(t,e,i){this.historyEntry={tool:["brush","PenBrush"],actions:[{action:"opacityPressure",params:[this.settingHasOpacityPressure]},{action:"sizePressure",params:[this.settingHasSizePressure]},{action:"setSize",params:[this.settingSize]},{action:"setSpacing",params:[this.settingSpacing]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setAlpha",params:[this.settingAlphaId]},{action:"setLockAlpha",params:[this.settingLockLayerAlpha]}]},i=tI.clamp(i,0,1);let s=this.calcOpacity(i),r=this.settingHasSizePressure?Math.max(.1,i*this.settingSize):Math.max(.1,this.settingSize);this.hasDrawnDot=!1,this.inputIsDrawing=!0,this.context.save(),this.drawDot(t,e,r,s),this.context.restore(),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=t,this.lastInput.y=e,this.lastInput.pressure=i,this.lastInput2.pressure=i,this.inputArr=[{x:t,y:e,pressure:i}],this.historyEntry.actions.push({action:"startLine",params:[t,e,i]})}goLine(t,e,i){if(!this.inputIsDrawing)return;this.historyEntry.actions.push({action:"goLine",params:[t,e,i]});let s=tI.clamp(i,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.context.save(),this.continueLine(t,e,r,this.lastInput.pressure),this.context.restore(),this.lastInput.x=t,this.lastInput.y=e,this.lastInput2.pressure=this.lastInput.pressure,this.lastInput.pressure=s,this.inputArr.push({x:t,y:e,pressure:i})}endLine(t,e){let i=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);if(this.context.save(),this.continueLine(null,null,i,this.lastInput.pressure),this.context.restore(),this.inputIsDrawing=!1,3===this.settingAlphaId&&!this.hasDrawnDot){let t=this.inputArr[0];this.inputArr.forEach(e=>{e.pressure>t.pressure&&(t=e)}),this.context.save();let e=tI.clamp(t.pressure,0,1),s=this.calcOpacity(e);this.drawDot(t.x,t.y,i,s,0),this.context.restore()}this.bezierLine=null,this.historyEntry&&(this.historyEntry.actions.push({action:"endLine",params:[t,e]}),this.history.push(this.historyEntry),this.historyEntry=void 0),this.hasDrawnDot=!1,this.inputArr=[]}drawLineSegment(t,e,i,s){let r;if(this.lastInput.x=i,this.lastInput.y=s,this.lastInput.pressure=1,this.inputIsDrawing||void 0===t)return;let a=tI.pointsToAngleDeg({x:t,y:e},{x:i,y:s}),n=Math.sqrt(Math.pow(i-t,2)+Math.pow(s-e,2)),o=(i-t)/n,l=(s-e)/n,h=this.settingSize*this.settingSpacing;for(this.lineToolLastDot=this.settingSize*this.settingSpacing,this.context.save(),r=this.lineToolLastDot;r<=n;r+=h)this.drawDot(t+o*r,e+l*r,this.settingSize,this.settingOpacity,a);this.context.restore();let c={tool:["brush","PenBrush"],actions:[{action:"opacityPressure",params:[this.settingHasOpacityPressure]},{action:"sizePressure",params:[this.settingHasSizePressure]},{action:"setSize",params:[this.settingSize]},{action:"setSpacing",params:[this.settingSpacing]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setAlpha",params:[this.settingAlphaId]},{action:"setLockAlpha",params:[this.settingLockLayerAlpha]},{action:"drawLineSegment",params:[t,e,i,s]}]};this.history.push(c)}isDrawing(){return this.inputIsDrawing}setAlpha(t){this.settingAlphaId!==t&&(this.settingAlphaId=t,this.updateAlphaCanvas())}setColor(t){this.settingColor!==t&&(this.settingColor={r:t.r,g:t.g,b:t.b},this.settingColorStr="rgb("+this.settingColor.r+","+this.settingColor.g+","+this.settingColor.b+")",this.updateAlphaCanvas())}setContext(t){this.context=t}setHistory(t){this.history=t}setSize(t){this.settingSize=t}setOpacity(t){this.settingOpacity=t}setSpacing(t){this.settingSpacing=t}sizePressure(t){this.settingHasSizePressure=t}opacityPressure(t){this.settingHasOpacityPressure=t}setLockAlpha(t){this.settingLockLayerAlpha=t}getSpacing(){return this.settingSpacing}getSize(){return this.settingSize}getOpacity(){return this.settingOpacity}getLockAlpha(){return this.settingLockLayerAlpha}constructor(){this.context={},this.history=new rH.DecoyKlHistory,this.settingHasOpacityPressure=!1,this.settingHasSizePressure=!0,this.settingSize=2,this.settingSpacing=.8489,this.settingOpacity=1,this.settingColor={},this.settingColorStr="",this.settingAlphaId=0,this.settingLockLayerAlpha=!1,this.hasDrawnDot=!1,this.lineToolLastDot=0,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.inputArr=[],this.inputIsDrawing=!1,this.bezierLine=null,this.alphaCanvas128=tI.canvas(128,128),this.alphaCanvas64=tI.canvas(64,64),this.alphaCanvas32=tI.canvas(32,32),this.alphaOpacityArr=[1,.9,1,1]}},BlendBrush:class{updateRedrawBounds(t){this.redrawBounds=tI.updateBounds(this.redrawBounds,t)}getCellsWidth(){return Math.ceil(this.context.canvas.width/256)}drawChangedCells(){if(!this.redrawBounds)return;let t=this.cells.map(()=>void 0);this.getTouchedCells(this.redrawBounds).forEach((e,i)=>{e&&(t[i]=this.cells[i])}),this.drawCells(t),this.redrawBounds=void 0}getTouchedCells(t){let e=this.cells.map(()=>!1),i=this.getCellsWidth();t={x1:Math.floor(t.x1/256),y1:Math.floor(t.y1/256),x2:Math.floor(t.x2/256),y2:Math.floor(t.y2/256)};for(let s=t.x1;s<=t.x2;s++)for(let r=t.y1;r<=t.y2;r++)e[r*i+s]=!0;return e}sliceBounds(t){let e=this.getCellsWidth(),i=[];return this.getTouchedCells(t).forEach((s,r)=>{if(!s)return;let a=r%e*256,n=256*Math.floor(r/e),o=this.cells[r].width,l=this.cells[r].height,h={x1:Math.max(0,t.x1-a),y1:Math.max(0,t.y1-n),x2:Math.min(o-1,t.x2-a),y2:Math.min(l-1,t.y2-n)};h.x1>h.x2||h.y1>h.y2||i.push({index:r,bounds:h})}),i}copyFromCanvas(t){if(!t)return;let e=this.getTouchedCells(t),i=this.getCellsWidth();e.forEach((t,e)=>{if(!t||this.cells[e])return;let s=e%i,r=Math.floor(e/i),a=(Math.min(256*s+256,this.context.canvas.width)-1)%256+1,n=(Math.min(256*r+256,this.context.canvas.height)-1)%256+1,o=tI.canvas(a,n),l=tI.ctx(o);l.drawImage(this.context.canvas,-(256*s),-(256*r)),this.cells[e]=l.getImageData(0,0,a,n)})}getAverage(t,e,i){let s=Math.max(0,Math.floor(t-(i=Math.max(.5,.75*i)))),r=Math.max(0,Math.floor(e-i)),a=Math.min(this.context.canvas.width-1,Math.ceil(t+i)),n=Math.min(this.context.canvas.height-1,Math.ceil(e+i));if(s>a||r>n)return{r:0,g:0,b:0,a:0};let o=0,l=0,h=0,c=0,p;return this.sliceBounds({x1:s,y1:r,x2:a,y2:n}).forEach(t=>{let e=this.cells[t.index].width,i=this.cells[t.index].data,s=t.bounds;for(let t=s.y1;t<=s.y2;t+=4)for(let r=s.x1,a=t*e*4+4*s.x1;r<=s.x2;r+=4,a+=16)p=i[a+3],o+=i[a]*p,l+=i[a+1]*p,h+=i[a+2]*p,c+=p}),0!==c&&(o/=c,l/=c,h/=c,c=Math.min(1,c)),{r:o,g:l,b:h,a:c}}prepDot(t,e,i){let s=Math.max(0,Math.floor(t-(i=Math.max(.5,i)))),r=Math.max(0,Math.floor(e-i)),a=Math.min(this.context.canvas.width-1,Math.ceil(t+i)),n=Math.min(this.context.canvas.height-1,Math.ceil(e+i));if(!(s>a)&&!(r>n))return{x1:s,y1:r,x2:a,y2:n}}drawDot(t){let e=0,i=t.size>30?1024:512,s=[];for(let t=0;t<i;t++)s[t]=(Math.random()-.5)/1.001+.5;let r=[8,4,4,4,2,2,2,2,2,2][Math.floor(2*t.size)],a=r?r*r:0,n=[];if(r){let t=0;for(let e=0;e<r;e++)for(let i=0;i<r;i++,t+=2)n[t]=(e+1)/r,n[t+1]=(i+1)/r}let o=.8*Math.pow(t.opacity,2),l=1-o,h=t.size*t.size,c=h*l/t.opacity,p=(1+o/l)*t.opacity,d=this.sliceBounds({x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2}),u=this.getCellsWidth();d.forEach(r=>{let o=r.index%u*256,l=256*Math.floor(r.index/u),d=this.cells[r.index].width,g=this.cells[r.index].data;for(let u=r.bounds.y1,m=u+l-t.y;u<=r.bounds.y2;u++,m++)for(let l=r.bounds.x1,y=u*d*4+4*r.bounds.x1,f=l+o-t.x;l<=r.bounds.x2;l++,y+=4,f++){let r=0;if(a){for(let e=0;e<n.length;e+=2){let i=tI.lenSquared(f+n[e],m+n[e+1]);i>=h||(r+=Y(p-i/c,0,t.opacity))}if(!r)continue;r/=a}else{let e=Math.pow(f,2)+Math.pow(m,2);if(e>=h)continue;r=Y(p-e/c,0,t.opacity)}let o=1-r,l=g[y+3]/255;if(this.settingLockLayerAlpha){let i=t.r*r+g[y]*o,a=t.g*r+g[y+1]*o,n=t.b*r+g[y+2]*o;l&&(g[y]=Math.floor(i+s[e]),g[y+1]=Math.floor(a+s[e]),g[y+2]=Math.floor(n+s[e]))}else{let i=t.r*r+g[y]*l*o,a=t.g*r+g[y+1]*l*o,n=t.b*r+g[y+2]*l*o,h=1-o*(1-l);g[y+3]=Math.floor(Math.min(255,255*h)+.5),h&&(g[y]=Math.floor(i/h+s[e]),g[y+1]=Math.floor(a/h+s[e]),g[y+2]=Math.floor(n/h+s[e]))}e=(e+1)%i}})}calcSpacing(t){return tI.mix(2*t/2,2*t/9,Y((t-2.7)/9.3,0,1))}continueLine(t,e,i,s){let r,a,n;this.drawBuffer=[];let o=this.settingSizePressure?Math.max(1,i*this.size):Math.max(1,this.size),l=this.calcSpacing(o),h=void 0===t?this.lastInput.x:t,c=void 0===e?this.lastInput.y:e;if(0===this.blending)this.mixCol.r=this.color.r,this.mixCol.g=this.color.g,this.mixCol.b=this.color.b;else{let t;if(s)t={r:this.localColOld.r,g:this.localColOld.g,b:this.localColOld.b,a:0};else{let e=[h,c,this.settingSizePressure?Math.max(.5,i*this.size):Math.max(.5,this.size)],s=this.prepDot(e[0],e[1],e[2]);s&&this.copyFromCanvas(s),t=this.getAverage(e[0],e[1],e[2])}n={r:0,g:0,b:0,a:0},t.a>0&&0===this.blendCol.a?(this.blendCol.r=t.r,this.blendCol.g=t.g,this.blendCol.b=t.b,this.blendCol.a=t.a):(0===t.a&&(t.r=this.color.r,t.g=this.color.g,t.b=this.color.b,t.a=1-this.blending),this.blendCol.r=tI.mix(this.blendCol.r,tI.mix(this.blendCol.r,t.r,this.blendMix),t.a),this.blendCol.g=tI.mix(this.blendCol.g,tI.mix(this.blendCol.g,t.g,this.blendMix),t.a),this.blendCol.b=tI.mix(this.blendCol.b,tI.mix(this.blendCol.b,t.b,this.blendMix),t.a),this.blendCol.a=Math.min(1,this.blendCol.a+t.a)),n.r=this.blendCol.r,n.g=this.blendCol.g,n.b=this.blendCol.b,n.a=this.blendCol.a}let p=t=>{if(this.blending>=1&&this.blendCol.a<=0)return;let e=t.t;r=this.lastInput2.pressure*(1-e)+i*e,a=this.settingOpacityPressure?this.opacity*r*r:this.opacity,o=this.settingSizePressure?Math.max(.1,r*this.size):Math.max(.1,this.size),0!=this.blending&&(this.mixCol.r=tI.mix(this.localColOld.r,n.r,e),this.mixCol.g=tI.mix(this.localColOld.g,n.g,e),this.mixCol.b=tI.mix(this.localColOld.b,n.b,e)),1===this.blending&&0===this.localColOld.a&&(this.mixCol.r=n.r,this.mixCol.g=n.g,this.mixCol.b=n.b);let s=this.prepDot(t.x,t.y,o);s&&(this.updateRedrawBounds(s),this.drawBuffer.push({x:t.x,y:t.y,size:o,opacity:a,x1:s.x1,y1:s.y1,x2:s.x2,y2:s.y2,r:tI.mix(this.color.r,this.mixCol.r,this.blending),g:tI.mix(this.color.g,this.mixCol.g,this.blending),b:tI.mix(this.color.b,this.mixCol.b,this.blending)}))};void 0===t||void 0===e?this.bezierLine.addFinal(l,p):this.bezierLine.add(t,e,l,p),this.copyFromCanvas(this.redrawBounds),this.drawBuffer.forEach(t=>{this.drawDot(t)}),this.drawBuffer=[],this.localColOld=n}setHistory(t){this.history=t}getSize(){return this.size}setSize(t){this.size=t}getOpacity(){return this.opacity}setOpacity(t){this.opacity=t}getBlending(){return this.blending}setBlending(t){this.blending=t}setColor(t){this.color=tI.copyObj(t)}setContext(t){this.context=t}setSizePressure(t){this.settingSizePressure=t}setOpacityPressure(t){this.settingOpacityPressure=t}getLockAlpha(){return this.settingLockLayerAlpha}setLockAlpha(t){this.settingLockLayerAlpha=t}getIsDrawing(){return this.isDrawing}setIsTesting(t){this.isTesting=t}startLine(t,e,i){this.historyEntry={tool:["brush","BlendBrush"],actions:[]};let s=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.cells="0".repeat(s).split("").map(()=>void 0),this.isDrawing=!0,i=Math.max(0,Math.min(1,i));let r=this.settingOpacityPressure?this.opacity*i*i:this.opacity,a=this.settingSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size);if(0===this.blending)this.mixCol.r=this.color.r,this.mixCol.g=this.color.g,this.mixCol.b=this.color.b;else{this.copyFromCanvas(this.prepDot(t,e,a));let s=this.getAverage(t,e,this.settingSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size));0===s.a?this.blendCol={r:this.color.r,g:this.color.g,b:this.color.b,a:1-this.blending}:this.blendCol={r:s.r,g:s.g,b:s.b,a:s.a},this.mixCol.r=this.blendCol.r,this.mixCol.g=this.blendCol.g,this.mixCol.b=this.blendCol.b}if(this.localColOld={r:this.mixCol.r,g:this.mixCol.g,b:this.mixCol.b,a:this.blendCol.a},this.redrawBounds=void 0,this.drawBuffer=[],this.blending<1||this.blendCol.a>0){let i=this.prepDot(t,e,a);i&&(this.updateRedrawBounds(i),this.drawBuffer.push({x:t,y:e,size:a,opacity:r,x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2,r:tI.mix(this.color.r,this.mixCol.r,this.blending),g:tI.mix(this.color.g,this.mixCol.g,this.blending),b:tI.mix(this.color.b,this.mixCol.b,this.blending)}))}this.copyFromCanvas(this.redrawBounds),this.drawBuffer.forEach(t=>{this.drawDot(t)}),this.drawBuffer=[],this.bezierLine=new tI.BezierLine,this.bezierLine.add(t,e,0,function(){}),this.lastInput.x=t,this.lastInput.y=e,this.lastInput.pressure=i,this.lastInput2=tI.copyObj(this.lastInput),this.isTesting||this.drawChangedCells()}goLine(t,e,i,s){this.isDrawing&&(this.continueLine(t,e,this.lastInput.pressure,s),this.lastInput2=tI.copyObj(this.lastInput),this.lastInput.x=t,this.lastInput.y=e,this.lastInput.pressure=i,this.isTesting||this.drawChangedCells())}endLine(){this.bezierLine&&this.continueLine(void 0,void 0,this.lastInput.pressure,!1),this.isDrawing=!1,this.bezierLine=void 0,this.drawChangedCells(),this.historyEntry&&this.history&&this.cells.find(t=>!!t)&&(this.historyEntry.actions.push({action:"drawCells",params:[this.cells]}),this.history.push(this.historyEntry),this.historyEntry=void 0),this.cells=[]}drawCells(t){let e=this.getCellsWidth();t.forEach((t,i)=>{if(!t)return;let s=256*Math.floor(i/e);this.context.putImageData(t,i%e*256,s)})}drawLineSegment(t,e,i,s){if(this.lastInput.x=i,this.lastInput.y=s,this.isDrawing||void 0===t)return;let r=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.cells="0".repeat(r).split("").map(()=>void 0),this.redrawBounds=void 0,this.drawBuffer=[],this.copyFromCanvas(this.prepDot(t,e,Math.max(.1,this.size)));let a=this.getAverage(t,e,Math.max(.1,this.size));0===a.a?this.blendCol={r:this.color.r,g:this.color.g,b:this.color.b,a:1-this.blending}:this.blendCol={r:a.r,g:a.g,b:a.b,a:a.a},this.mixCol.r=this.color.r*(1-this.blendCol.a)+(this.blending*this.blendCol.r+this.color.r*(1-this.blending))*this.blendCol.a,this.mixCol.g=this.color.g*(1-this.blendCol.a)+(this.blending*this.blendCol.g+this.color.g*(1-this.blending))*this.blendCol.a,this.mixCol.b=this.color.b*(1-this.blendCol.a)+(this.blending*this.blendCol.b+this.color.b*(1-this.blending))*this.blendCol.a;let n=this.settingOpacityPressure?1*this.opacity:this.opacity,o=this.settingSizePressure?Math.max(.1,1*this.size):Math.max(.1,this.size),l=Math.sqrt(Math.pow(i-t,2)+Math.pow(s-e,2)),h=(i-t)/l,c=(s-e)/l,p=this.calcSpacing(o);for(let i=0;i<=l;i+=p){let s=this.prepDot(t+h*i,e+c*i,o);s&&(this.copyFromCanvas(s),this.drawBuffer.push({x:t+h*i,y:e+c*i,size:o,opacity:n,x1:s.x1,y1:s.y1,x2:s.x2,y2:s.y2,r:tI.mix(this.color.r,this.mixCol.r,this.blending),g:tI.mix(this.color.g,this.mixCol.g,this.blending),b:tI.mix(this.color.b,this.mixCol.b,this.blending)}))}this.drawBuffer.forEach(t=>{this.drawDot(t)}),this.drawBuffer=[],this.history&&this.cells.find(t=>!!t)&&(this.drawCells(this.cells),this.historyEntry={tool:["brush","BlendBrush"],actions:[{action:"drawCells",params:[this.cells]}]},this.history.push(this.historyEntry),this.historyEntry=void 0),this.cells=[]}constructor(){this.isTesting=!1,this.context={},this.color={},this.size=29,this.opacity=.6,this.blending=.65,this.settingLockLayerAlpha=!1,this.settingSizePressure=!0,this.settingOpacityPressure=!1,this.blendCol={r:0,g:0,b:0,a:1},this.blendMix=.45,this.mixCol={r:0,g:0,b:0},this.localColOld={},this.isDrawing=!1,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.cells=[],this.drawBuffer=[]}},SketchyBrush:class{rand(){return this.sketchySeed++,.5*Math.sin(6324634.2345*Math.cos(5342.3423*this.sketchySeed))+.5}setHistory(t){this.history=t}setSeed(t){this.sketchySeed=parseInt(""+t)}getSeed(){return parseInt(""+this.sketchySeed)}getSize(){return this.settingSize/2}setColor(t){this.settingColor=t}getOpacity(){return this.settingOpacity}setOpacity(t){this.settingOpacity=t}getBlending(){return this.settingBlending}setBlending(t){this.settingBlending=t}setSize(t){this.settingSize=2*t}getScale(){return this.settingScale}setScale(t){this.settingScale=t}setContext(t){this.context=t}startLine(t,e,i,s){s&&this.lastInput.x?(this.inputIsDrawing=!0,this.endLine()):(this.inputIsDrawing=!0,this.lastX=t,this.lastY=e,this.lastInput.x=t,this.lastInput.y=e,this.historyEntry={tool:["brush","SketchyBrush"],actions:[{action:"setScale",params:[this.settingScale]},{action:"setSize",params:[this.settingSize/2]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setBlending",params:[this.settingBlending]},{action:"startLine",params:[t,e,i]}]})}goLine(t,e,i,s){let r,a,n,o;if(!this.inputIsDrawing||t===this.lastInput.x&&e===this.lastInput.y)return;let l=parseInt(""+t),h=parseInt(""+e);this.points.push([l,h]);let c=this.settingColor.r,p=this.settingColor.g,d=this.settingColor.b;if(s)c=s.r,p=s.g,d=s.b;else if(0!==this.settingBlending&&l+5>=0&&h+5>=0&&l-5<this.context.canvas.width-1&&h-5<this.context.canvas.height-1){c=0,p=0,d=0;let t=Math.min(this.context.canvas.width-1,Math.max(0,l-5)),e=Math.min(this.context.canvas.height-1,Math.max(0,h-5)),i=Math.min(this.context.canvas.width-1,Math.max(0,l+5)),s=Math.min(this.context.canvas.height-1,Math.max(0,h+5));if(i-=t,s-=e,i>0&&s>0){let r=this.context.getImageData(t,e,i,s),a=0;for(let t=0;t<r.data.length;t+=4)c+=r.data[t+0],p+=r.data[t+1],d+=r.data[t+2],a++;c/=a,p/=a,d/=a}let r=this.mixMode[0](new tI.RGB(c,p,d),this.settingColor);c=parseInt(""+tI.mix(this.settingColor.r,r.r,this.settingBlending)),p=parseInt(""+tI.mix(this.settingColor.g,r.g,this.settingBlending)),d=parseInt(""+tI.mix(this.settingColor.b,r.b,this.settingBlending))}for(this.context.save(),this.context.strokeStyle="rgba("+c+", "+p+", "+d+", "+this.settingOpacity+")",this.context.lineWidth=this.settingSize,this.context.beginPath(),this.context.moveTo(this.lastX,this.lastY),this.context.lineTo(l,h),r=0;r<this.points.length;r++)(o=(a=this.points[r][0]-this.points[this.count][0])*a+(n=this.points[r][1]-this.points[this.count][1])*n)<4e3*this.settingScale*this.settingScale&&this.rand()>o/2e3/this.settingScale/this.settingScale&&(this.context.moveTo(this.points[this.count][0]+.3*a,this.points[this.count][1]+.3*n),this.context.lineTo(this.points[r][0]-.3*a,this.points[r][1]-.3*n));this.context.stroke(),this.context.restore(),this.count++,this.lastX=l,this.lastY=h,this.lastInput.x=l,this.lastInput.y=h,this.historyEntry.actions.push({action:"goLine",params:[t,e,i,{r:c,g:p,b:d}]})}endLine(){this.inputIsDrawing=!1,this.count=0,this.points=[],this.historyEntry&&(this.historyEntry.actions.push({action:"endLine",params:[]}),this.history.push(this.historyEntry),this.historyEntry=void 0)}drawLineSegment(t,e,i,s){if(this.lastInput.x=i,this.lastInput.y=s,this.inputIsDrawing||void 0===t)return;this.context.save(),this.context.lineWidth=this.settingSize;let r={r:this.settingColor.r,g:this.settingColor.g,b:this.settingColor.b};if(t+5>=0&&e+5>=0&&t-5<this.context.canvas.width-1&&e-5<this.context.canvas.height-1){r.r=0,r.g=0,r.b=0;let i=Math.min(this.context.canvas.width-1,Math.max(0,t-5)),s=Math.min(this.context.canvas.height-1,Math.max(0,e-5)),a=Math.min(this.context.canvas.width-1,Math.max(0,t+5)),n=Math.min(this.context.canvas.height-1,Math.max(0,e+5));if(a-=i,n-=s,a>0&&n>0){let t=Math.min(sU.width,a),e=Math.min(sU.height,n);sN.save(),sN.globalCompositeOperation="copy",sN.drawImage(this.context.canvas,i,s,a,n,0,0,t,e),sN.restore();let o=sN.getImageData(i,s,a,n),l=0;for(let t=0;t<o.data.length;t+=4)r.r+=o.data[t+0],r.g+=o.data[t+1],r.b+=o.data[t+2],l++;r.r/=l,r.g/=l,r.b/=l}}let a=this.mixMode[0](new tI.RGB(r.r,r.g,r.b),this.settingColor);r.r=parseInt(""+(this.settingBlending*a.r+this.settingColor.r*(1-this.settingBlending))),r.g=parseInt(""+(this.settingBlending*a.g+this.settingColor.g*(1-this.settingBlending))),r.b=parseInt(""+(this.settingBlending*a.b+this.settingColor.b*(1-this.settingBlending))),this.context.strokeStyle="rgba("+r.r+", "+r.g+", "+r.b+", "+this.settingOpacity+")",this.context.beginPath(),this.context.moveTo(t,e),this.context.lineTo(i,s),this.context.stroke(),this.context.strokeStyle="rgba("+r.r+", "+r.g+", "+r.b+", "+this.settingOpacity+")",this.context.restore();let n={tool:["brush","SketchyBrush"],actions:[{action:"setScale",params:[this.settingScale]},{action:"setSize",params:[this.settingSize/2]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setBlending",params:[this.settingBlending]},{action:"drawLineSegment",params:[t,e,i,s]}]};this.history.push(n)}isDrawing(){return this.inputIsDrawing}constructor(){this.context={},this.settingColor={},this.settingSize=1,this.settingOpacity=.2,this.settingBlending=.5,this.settingScale=1,this.lastX=0,this.lastY=0,this.inputIsDrawing=!1,this.lastInput={x:0,y:0,pressure:0},this.history=new rH.DecoyKlHistory,this.sketchySeed=0,this.points=[],this.count=0,this.mixMode=[t=>t,(t,e)=>{let i=new tI.RGB(t.r,t.g,t.b);return i.r*=e.r/255,i.g*=e.g/255,i.b*=e.b/255,i}]}},PixelBrush:class{updateDither(){this.ditherCtx.clearRect(0,0,4,4),this.ditherCtx.fillStyle=this.settingIsEraser?`rgb(${ei},${ei},${ei})`:this.settingColorStr;for(let t=0;t<Math.max(1,Math.round(this.settingOpacity*this.ditherArr.length));t++)this.ditherCtx.fillRect(this.ditherArr[t][0],this.ditherArr[t][1],1,1);this.ditherPattern=E(this.context.createPattern(this.ditherCanvas,"repeat"))}cubicCurveOverThreshold(t,e,i,s,r){let a=tI.Vec2.nor({x:s.x-t.x,y:s.y-t.y}),n=tI.Vec2.nor({x:e.x-t.x,y:e.y-t.y}),o=tI.Vec2.nor({x:s.x-i.x,y:s.y-i.y});return Math.max(tI.Vec2.dist(a,n),tI.Vec2.dist(a,o))>r}plotCubicBezierLine(t,e,i,s){let r=this.cubicCurveOverThreshold(t,e,i,s,.1);t.x=Math.floor(t.x),t.y=Math.floor(t.y),s.x=Math.floor(s.x),s.y=Math.floor(s.y);let a=tI.dist(t.x,t.y,s.x,s.y);if(!r||a<7){this.plotLine(t.x,t.y,s.x,s.y,!0);return}let n=Math.max(2,Math.round(a/4)),o=[];for(let r=0;r<=n;r++){let a=r/n,l=Math.pow(1-a,3),h=3*a*Math.pow(1-a,2),c=3*Math.pow(a,2)*(1-a),p=Math.pow(a,3);o.push({x:l*t.x+h*e.x+c*i.x+p*s.x,y:l*t.y+h*e.y+c*i.y+p*s.y})}for(let t=0;t<n;t++)this.plotLine(Math.round(o[t].x),Math.round(o[t].y),Math.round(o[t+1].x),Math.round(o[t+1].y),!0)}drawDot(t,e,i,s){this.context.save(),this.settingIsEraser?(this.context.fillStyle=this.settingUseDither?this.ditherPattern:"#fff",this.settingLockLayerAlpha?this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out"):(this.context.fillStyle=this.settingUseDither?this.ditherPattern:this.settingColorStr,this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop")),this.context.globalAlpha=this.settingUseDither?1:s,this.context.fillRect(Math.round(t+-i),Math.round(e+-i),Math.round(2*i),Math.round(2*i)),this.context.restore()}continueLine(t,e,i,s){null===this.bezierLine&&(this.bezierLine=new tI.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,()=>{})),this.context.save();let r=t=>{let e=tI.mix(this.lastInput2.pressure,s,t.t),i=this.settingOpacity*(this.settingHasOpacityPressure?e*e:1),r=Math.max(.5,this.settingSize*(this.settingHasSizePressure?e:1));this.drawDot(t.x,t.y,r,i)},a=t=>{this.plotCubicBezierLine(t.p1,t.p2,t.p3,t.p4)};if(1===Math.round(2*this.settingSize))null===t||null===e?this.bezierLine.addFinal(4,void 0,a):this.bezierLine.add(t,e,4,void 0,a);else{let s=i*this.settingSpacing;null===t||null===e?this.bezierLine.addFinal(s,r):this.bezierLine.add(t,e,s,r)}this.context.restore()}plotLine(t,e,i,s,r){this.context.save(),this.settingIsEraser?(this.context.fillStyle=this.settingUseDither?this.ditherPattern:"#fff",this.settingLockLayerAlpha?this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out"):(this.context.fillStyle=this.settingUseDither?this.ditherPattern:this.settingColorStr,this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop")),this.context.globalAlpha=this.settingUseDither?1:this.settingOpacity,t=Math.floor(t),e=Math.floor(e);let a=Math.abs((i=Math.floor(i))-t),n=t<i?1:-1,o=-Math.abs((s=Math.floor(s))-e),l=e<s?1:-1,h=a+o;for(;r?r=!1:this.context.fillRect(t,e,1,1),t!==i||e!==s;){let i=2*h;i>=o&&(h+=o,t+=n),i<=a&&(h+=a,e+=l)}this.context.restore()}startLine(t,e,i){this.historyEntry={tool:["brush","PixelBrush"],actions:[{action:"sizePressure",params:[this.settingHasSizePressure]},{action:"opacityPressure",params:[this.settingHasOpacityPressure]},{action:"setSize",params:[this.settingSize]},{action:"setSpacing",params:[this.settingSpacing]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setLockAlpha",params:[this.settingLockLayerAlpha]},{action:"setIsEraser",params:[this.settingIsEraser]},{action:"setUseDither",params:[this.settingUseDither]}]},this.settingUseDither&&this.updateDither(),i=Math.max(0,Math.min(1,i));let s=this.settingHasOpacityPressure?this.settingOpacity*i*i:this.settingOpacity,r=this.settingHasSizePressure?Math.max(.5,i*this.settingSize):Math.max(.5,this.settingSize);this.inputIsDrawing=!0,this.drawDot(t,e,r,s),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=t,this.lastInput.y=e,this.lastInput.pressure=i,this.lastInput2=tI.copyObj(this.lastInput),this.historyEntry.actions.push({action:"startLine",params:[t,e,i]})}goLine(t,e,i){if(!this.inputIsDrawing)return;this.historyEntry.actions.push({action:"goLine",params:[t,e,i]});let s=tI.clamp(i,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(t,e,r,this.lastInput.pressure),this.lastInput2=tI.copyObj(this.lastInput),this.lastInput.x=t,this.lastInput.y=e,this.lastInput.pressure=s}endLine(t,e){let i=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(null,null,i,this.lastInput.pressure),this.inputIsDrawing=!1,this.bezierLine=null,this.historyEntry&&(this.historyEntry.actions.push({action:"endLine",params:[t,e]}),this.history.push(this.historyEntry),this.historyEntry=void 0)}drawLineSegment(t,e,i,s){if(this.lastInput.x=i,this.lastInput.y=s,this.lastInput.pressure=1,this.inputIsDrawing||void 0===t)return;if(this.settingUseDither&&this.updateDither(),1===Math.round(2*this.settingSize))this.plotLine(t,e,i,s,!0);else{let r;let a=Math.sqrt(Math.pow(i-t,2)+Math.pow(s-e,2)),n=(i-t)/a,o=(s-e)/a,l=this.settingSize*this.settingSpacing;for(this.lineToolLastDot=this.settingSize*this.settingSpacing,r=this.lineToolLastDot;r<=a;r+=l)this.drawDot(t+n*r,e+o*r,this.settingSize,this.settingOpacity)}let r={tool:["brush","PixelBrush"],actions:[{action:"sizePressure",params:[this.settingHasSizePressure]},{action:"opacityPressure",params:[this.settingHasOpacityPressure]},{action:"setSize",params:[this.settingSize]},{action:"setSpacing",params:[this.settingSpacing]},{action:"setOpacity",params:[this.settingOpacity]},{action:"setColor",params:[this.settingColor]},{action:"setLockAlpha",params:[this.settingLockLayerAlpha]},{action:"setIsEraser",params:[this.settingIsEraser]},{action:"setUseDither",params:[this.settingUseDither]},{action:"drawLineSegment",params:[t,e,i,s]}]};this.history.push(r)}isDrawing(){return this.inputIsDrawing}setColor(t){this.settingColor!==t&&(this.settingColor=t,this.settingColorStr="rgb("+this.settingColor.r+","+this.settingColor.g+","+this.settingColor.b+")")}setContext(t){this.context=t}setHistory(t){this.history=t}setSize(t){this.settingSize=Math.round(2*t)/2}setOpacity(t){this.settingOpacity=t}setSpacing(t){this.settingSpacing=t}sizePressure(t){this.settingHasSizePressure=t}opacityPressure(t){this.settingHasOpacityPressure=t}setLockAlpha(t){this.settingLockLayerAlpha=t}setIsEraser(t){this.settingIsEraser=t}setUseDither(t){this.settingUseDither=t}getSpacing(){return this.settingSpacing}getSize(){return this.settingSize}getOpacity(){return this.settingOpacity}getLockAlpha(){return this.settingLockLayerAlpha}getIsEraser(){return this.settingIsEraser}getUseDither(){return this.settingUseDither}constructor(){this.history=new rH.DecoyKlHistory,this.context={},this.settingHasSizePressure=!0,this.settingHasOpacityPressure=!1,this.settingSize=.5,this.settingSpacing=.9,this.settingOpacity=1,this.settingColor={},this.settingColorStr="",this.settingLockLayerAlpha=!1,this.settingIsEraser=!1,this.settingUseDither=!0,this.inputIsDrawing=!1,this.lineToolLastDot=0,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.bezierLine=null,this.ditherArr=[[3,2],[1,0],[3,0],[1,2],[2,1],[0,3],[0,1],[2,3],[2,0],[0,2],[0,0],[2,2],[1,1],[3,3],[3,1],[1,3]],this.ditherPattern={},this.ditherCanvas=tI.canvas(4,4),this.ditherCtx=tI.ctx(this.ditherCanvas)}},ChemyBrush:class{updateCompleteRedrawBounds(t,e){let i={x1:t,y1:e,x2:t,y2:e};this.settingXSymmetry&&(i=tI.updateBounds(i,{x1:-t+this.copyCanvas.width,y1:e,x2:-t+this.copyCanvas.width,y2:e})),this.settingYSymmetry&&(i=tI.updateBounds(i,{x1:t,y1:-e+this.copyCanvas.height,x2:t,y2:-e+this.copyCanvas.height}));let s="stroke"===this.settingMode?this.settingSize+1:1;i.x1=Math.floor(i.x1-s),i.y1=Math.floor(i.y1-s),i.x2=Math.ceil(i.x2+s),i.y2=Math.ceil(i.y2+s),this.completeRedrawBounds=tI.updateBounds(this.completeRedrawBounds,i)}drawShape(){this.context.save(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.drawImage(this.copyCanvas,0,0);let t={...this.settingColor};if(this.settingIsEraser?(t.r=ei,t.g=ei,t.b=ei,this.settingLockLayerAlpha?this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out"):this.settingLockLayerAlpha&&(this.context.globalCompositeOperation="source-atop"),this.path.length>1){let e=new Path2D;this.path.forEach((t,i)=>{0===i?e.moveTo(t.x,t.y):e.lineTo(t.x,t.y)});let i=tI.ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:this.settingOpacity});if(this.settingGradient){let e=this.path[0].x>this.path[this.path.length-1].x,s=this.context.createLinearGradient(0,e?this.minY:this.maxY,0,e?this.maxY:this.minY);s.addColorStop(0,tI.ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:this.settingOpacity})),s.addColorStop(1,tI.ColorConverter.toRgbaStr({r:t.r,g:t.g,b:t.b,a:0})),i=s}"fill"===this.settingMode?this.context.fillStyle=i:(this.context.lineWidth=2*this.settingSize,this.context.lineJoin="bevel",this.context.strokeStyle=i);let s=()=>{"fill"===this.settingMode?this.context.fill(e):this.context.stroke(e)};s(),this.settingXSymmetry&&(this.context.save(),this.context.translate(this.context.canvas.width/2,0),this.context.scale(-1,1),this.context.translate(-this.context.canvas.width/2,0),s(),this.context.restore()),this.settingYSymmetry&&(this.context.save(),this.context.translate(0,this.context.canvas.height/2),this.context.scale(1,-1),this.context.translate(0,-this.context.canvas.height/2),s(),this.context.restore(),this.settingXSymmetry&&(this.context.save(),this.context.translate(this.context.canvas.width/2,this.context.canvas.height/2),this.context.scale(-1,-1),this.context.translate(-this.context.canvas.width/2,-this.context.canvas.height/2),s(),this.context.restore()))}this.context.restore()}setHistory(t){this.history=t}getSize(){return"stroke"===this.settingMode?this.settingSize:0}setSize(t){this.settingSize=t}getOpacity(){return this.settingOpacity}setOpacity(t){this.settingOpacity=t}setColor(t){this.settingColor=tI.copyObj(t)}setContext(t){this.context=t}setMode(t){this.settingMode=t}getMode(){return this.settingMode}setDistort(t){this.settingDistort=tI.clamp(t,0,1)}getDistort(){return this.settingDistort}setXSymmetry(t){this.settingXSymmetry=t}getXSymmetry(){return this.settingXSymmetry}setYSymmetry(t){this.settingYSymmetry=t}getYSymmetry(){return this.settingYSymmetry}setGradient(t){this.settingGradient=t}getGradient(){return this.settingGradient}getLockAlpha(){return this.settingLockLayerAlpha}setLockAlpha(t){this.settingLockLayerAlpha=t}getIsEraser(){return this.settingIsEraser}setIsEraser(t){this.settingIsEraser=t}getIsDrawing(){return this.isDrawing}startLine(t,e){this.isDrawing=!0,this.path=[{x:t,y:e}],this.minY=e,this.maxY=e,this.copyCanvas=tI.canvas(this.context.canvas.width,this.context.canvas.height),tI.ctx(this.copyCanvas).drawImage(this.context.canvas,0,0),this.completeRedrawBounds=void 0,this.updateCompleteRedrawBounds(t,e)}goLine(t,e){if(!this.isDrawing)return;let i={x:t,y:e};this.settingDistort>0&&(i.x+=(Math.random()-.5)*this.settingDistort*80,i.y+=(Math.random()-.5)*this.settingDistort*80),this.minY=Math.min(this.minY,i.y),this.maxY=Math.max(this.maxY,i.y),this.path.push(i),this.updateCompleteRedrawBounds(t,e),this.drawShape()}endLine(){if(this.isDrawing=!1,this.completeRedrawBounds=tI.boundsInArea(this.completeRedrawBounds,this.copyCanvas.width,this.copyCanvas.height),this.path.length>1&&this.completeRedrawBounds){let t=tI.canvas(this.completeRedrawBounds.x2-this.completeRedrawBounds.x1+1,this.completeRedrawBounds.y2-this.completeRedrawBounds.y1+1);tI.ctx(t).drawImage(this.context.canvas,-this.completeRedrawBounds.x1,-this.completeRedrawBounds.y1),this.history.push({tool:["brush","ChemyBrush"],actions:[{action:"drawImage",params:[t,this.completeRedrawBounds.x1,this.completeRedrawBounds.y1]}]})}this.path=[],this.copyCanvas={}}drawImage(t,e,i){this.context.save(),this.context.clearRect(e,i,t.width,t.height),this.context.drawImage(t,e,i),this.context.restore()}drawLineSegment(t,e,i,s){}constructor(){this.context={},this.settingColor={},this.settingSize=.25,this.settingOpacity=1,this.settingLockLayerAlpha=!1,this.settingIsEraser=!1,this.settingMode="fill",this.settingDistort=0,this.settingXSymmetry=!1,this.settingYSymmetry=!1,this.settingGradient=!1,this.isDrawing=!1,this.history=new rH.DecoyKlHistory,this.copyCanvas={},this.path=[],this.minY=0,this.maxY=0}},SmudgeBrush:class{resetRedrawBounds(){this.redrawBounds=void 0}updateRedrawBounds(t){this.redrawBounds=tI.updateBounds(this.redrawBounds,t)}updateCompleteRedrawBounds(t,e,i,s){this.completeRedrawBounds=tI.updateBounds(this.completeRedrawBounds,{x1:t,y1:e,x2:i,y2:s})}copyFromCanvas(){let t=this.copiedCells.map(()=>!1),e=[],i=Math.ceil(this.copyImageData.width/256);this.redrawBounds&&(e.push({x1:Math.floor(this.redrawBounds.x1/256),y1:Math.floor(this.redrawBounds.y1/256),x2:Math.floor(this.redrawBounds.x2/256),y2:Math.floor(this.redrawBounds.y2/256)}),e.forEach(e=>{for(let s=e.x1;s<=e.x2;s++)for(let r=e.y1;r<=e.y2;r++)t[r*i+s]=!0}),t.forEach((t,e)=>{if(!t||this.copiedCells[e])return;this.copiedCells[e]=!0;let s=e%i,r=Math.floor(e/i),a=(Math.min(256*s+256,this.copyImageData.width)-1)%256+1,n=(Math.min(256*r+256,this.copyImageData.height)-1)%256+1,o=tI.canvas(a,n),l=tI.ctx(o);l.drawImage(this.context.canvas,-(256*s),-(256*r));let h=l.getImageData(0,0,a,n);for(let t=0;t<n;t++)for(let e=0,i=t*a*4,n=((256*r+t)*this.copyImageData.width+256*s)*4;e<a;e++,i+=4,n+=4)this.copyImageData.data[n]=h.data[i],this.copyImageData.data[n+1]=h.data[i+1],this.copyImageData.data[n+2]=h.data[i+2],this.copyImageData.data[n+3]=h.data[i+3]}))}prepDot(t,e,i,s){if(!this.lastDot){this.lastDot={x:t,y:e};return}let r=Math.round(2*(i=Math.round(i))),a=Math.round(2*i),n=function(t,e,i,s,r){if(i.x===s.x&&i.y===s.y)return null;i=tI.copyObj(i),s=tI.copyObj(s),r=tI.copyObj(r);{let a=0,n=0,o=0,l=0;if(i.x<0&&(l=-i.x),i.y<0&&(a=-i.y),s.x<0&&(l=Math.max(l,-s.x)),s.y<0&&(a=Math.max(a,-s.y)),i.x+r.w>t&&(n=i.x+r.w-t),i.y+r.h>e&&(o=i.y+r.h-e),s.x+r.w>t&&(n=Math.max(n,s.x+r.w-t)),s.y+r.h>e&&(o=Math.max(o,s.y+r.h-e)),i.x+=l,s.x+=l,i.y+=a,s.y+=a,r.w=r.w-l-n,r.h=r.h-a-o,r.w<=0||r.h<=0)return null}return{aP:{x:i.x,y:i.y},bP:{x:s.x,y:s.y},size:{w:r.w,h:r.h}}}(this.copyImageData.width,this.copyImageData.height,{x:Math.round(this.lastDot.x-i),y:Math.round(this.lastDot.y-i)},{x:Math.round(t-i),y:Math.round(e-i)},{w:r,h:a});if(n){let r={aP:n.aP,bP:n.bP,size:n.size,brush:{center:{x:t,y:e},size:i,opacity:s,alphaLock:this.settingLockLayerAlpha}};this.updateRedrawBounds({x1:r.bP.x,y1:r.bP.y,x2:r.bP.x+2*r.brush.size,y2:r.bP.y+2*r.brush.size}),this.drawBuffer.push(r)}this.lastDot={x:t,y:e}}continueLine(t,e,i,s){this.drawBuffer=[],this.bezierLine||(this.bezierLine=new tI.BezierLine,this.bezierLine.add(this.lastInput.x,this.lastInput.y,0,function(){}));let r=[],a=t=>{let e=tI.mix(this.lastInput2.pressure,s,t.t),i=this.settingOpacity*(this.settingHasOpacityPressure?e*e:1),a=Math.max(.1,this.settingSize*(this.settingHasSizePressure?e:1));r.push([t.x,t.y,a,i])},n=i*this.settingSpacing/3;void 0===t||void 0===e?this.bezierLine.addFinal(n,a):this.bezierLine.add(t,e,n,a);for(let t=0;t<r.length;t++){let e=r[t];this.prepDot(e[0],e[1],e[2],e[3])}this.copyFromCanvas();for(let t=0;t<this.drawBuffer.length;t++)!function(t,e){let i=(e=tI.copyObj(e)).brush.size,s=e.brush.center.x,r=e.brush.center.y,a=e.aP.y*t.width+e.aP.x,n=(e.bP.y*t.width+e.bP.x-a)*4,o=0,l=i>30?1024:512,h=[];for(let t=0;t<l;t++)h[t]=(Math.random()-.5)/1.001+.5;let c=Math.max(3,Math.min(8,e.brush.size-8)),p=(a,n,p,d)=>{let u=tI.dist(s,r,p,d),g=1-e.brush.opacity*(1-Y((u-(i-c))/c,0,1));if(1!==g){if(t.data[a+3]){if(t.data[n+3]){let e;e=t.data[a+3]<t.data[n+3]?1-t.data[a+3]/t.data[n+3]*(1-g):t.data[n+3]/t.data[a+3]*g,t.data[n]=Math.floor(tI.mix(t.data[a],t.data[n+0],e)+h[o]),t.data[n+1]=Math.floor(tI.mix(t.data[a+1],t.data[n+1],e)+h[o]),t.data[n+2]=Math.floor(tI.mix(t.data[a+2],t.data[n+2],e)+h[o]),o=(o+1)%l}else t.data[n]=t.data[a],t.data[n+1]=t.data[a+1],t.data[n+2]=t.data[a+2]}e.brush.alphaLock||(t.data[n+3]=Math.floor(tI.mix(t.data[a+3],t.data[n+3],g)+.5))}},d=4*e.bP.x,u=d+(e.size.w-1)*4;if(e.aP.y<e.bP.y)for(let i=e.size.h-1,s=e.bP.y+e.size.h-1;i>=0;i--,s--){let r=(i+e.bP.y)*t.width*4;for(let t=u+r,i=u+r-n,a=e.bP.x+e.size.w-1;t>=d+r;t-=4,i-=4,a--)p(i,t,a,s)}else if(e.aP.y>e.bP.y)for(let i=0,s=e.bP.y;i<e.size.h;i++,s++){let r=(i+e.bP.y)*t.width*4;for(let t=u+r,i=u+r-n,a=e.bP.x+e.size.w-1;t>=d+r;t-=4,i-=4,a--)p(i,t,a,s)}else if(e.aP.x<e.bP.x)for(let i=e.size.h-1,s=e.bP.y+e.size.h-1;i>=0;i--,s--){let r=(i+e.bP.y)*t.width*4;for(let t=u+r,i=u+r-n,a=e.bP.x+e.size.w-1;t>=d+r;t-=4,i-=4,a--)p(i,t,a,s)}else for(let i=0,s=e.bP.y;i<e.size.h;i++,s++){let r=(i+e.bP.y)*t.width*4;for(let t=d+r,i=d+r-n,a=e.bP.x;t<u+r;t+=4,i+=4,a++)p(i,t,a,s)}}(this.copyImageData,this.drawBuffer[t])}startLine(t,e,i){this.historyEntry={tool:["brush","SmudgeBrush"],actions:[]},i=tI.clamp(i,0,1);let s=this.settingHasOpacityPressure?this.settingOpacity*i*i:this.settingOpacity,r=this.settingHasSizePressure?Math.max(.1,i*this.settingSize):Math.max(.1,this.settingSize);this.lastDot=void 0,this.isDrawing=!0,this.copyImageData=new ImageData(this.context.canvas.width,this.context.canvas.height);let a=Math.ceil(this.context.canvas.width/256)*Math.ceil(this.context.canvas.height/256);this.copiedCells="0".repeat(a).split("").map(()=>!1),this.prepDot(t,e,r,s),this.lineToolLastDot=r*this.settingSpacing,this.lastInput.x=t,this.lastInput.y=e,this.lastInput.pressure=i,this.lastInput2.pressure=i,this.completeRedrawBounds=void 0}goLine(t,e,i){if(!this.isDrawing)return;this.resetRedrawBounds();let s=tI.clamp(i,0,1),r=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);this.continueLine(t,e,r,this.lastInput.pressure),this.redrawBounds&&(this.context.putImageData(this.copyImageData,0,0,this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2-this.redrawBounds.x1-1,this.redrawBounds.y2-this.redrawBounds.y1-1),this.updateCompleteRedrawBounds(this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2,this.redrawBounds.y2)),this.lastInput.x=t,this.lastInput.y=e,this.lastInput2.pressure=this.lastInput.pressure,this.lastInput.pressure=s}endLine(){this.resetRedrawBounds();let t=this.settingHasSizePressure?Math.max(.1,this.lastInput.pressure*this.settingSize):Math.max(.1,this.settingSize);if(this.context.save(),this.continueLine(void 0,void 0,t,this.lastInput.pressure),this.context.restore(),this.isDrawing=!1,this.bezierLine=void 0,this.redrawBounds&&(this.context.putImageData(this.copyImageData,0,0,this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2-this.redrawBounds.x1-1,this.redrawBounds.y2-this.redrawBounds.y1-1),this.updateCompleteRedrawBounds(this.redrawBounds.x1,this.redrawBounds.y1,this.redrawBounds.x2,this.redrawBounds.y2)),this.historyEntry&&this.completeRedrawBounds){let t=this.copyImageData;if(!(0===this.completeRedrawBounds.x1&&0===this.completeRedrawBounds.y1&&this.completeRedrawBounds.x2>=this.context.canvas.width-1&&this.completeRedrawBounds.y2>=this.context.canvas.height-1)){let e=tI.canvas(this.completeRedrawBounds.x2-this.completeRedrawBounds.x1+1,this.completeRedrawBounds.y2-this.completeRedrawBounds.y1+1);tI.ctx(e).drawImage(this.context.canvas,-this.completeRedrawBounds.x1,-this.completeRedrawBounds.y1),t=e}this.historyEntry.actions.push({action:"drawImage",params:[t,this.completeRedrawBounds.x1,this.completeRedrawBounds.y1]}),this.history.push(this.historyEntry),this.historyEntry=void 0}this.copyImageData={}}drawImage(t,e,i){t instanceof ImageData?this.context.putImageData(t,e,i):(this.context.clearRect(e,i,t.width,t.height),this.context.drawImage(t,e,i))}drawLineSegment(t,e,i,s){}getIsDrawing(){return this.isDrawing}setColor(t){(this.settingColor.r!==t.r||this.settingColor.g!==t.g||this.settingColor.b!==t.b)&&(this.settingColor={r:t.r,g:t.g,b:t.b})}setContext(t){this.context=t}setHistory(t){this.history=t}setSize(t){this.settingSize=t}setOpacity(t){this.settingOpacity=t}setSpacing(t){this.settingSpacing=t}sizePressure(t){this.settingHasSizePressure=t}opacityPressure(t){this.settingHasOpacityPressure=t}setLockAlpha(t){this.settingLockLayerAlpha=t}getSpacing(){return this.settingSpacing}getSize(){return this.settingSize}getOpacity(){return this.settingOpacity}getLockAlpha(){return this.settingLockLayerAlpha}constructor(){this.context={},this.history=new rH.DecoyKlHistory,this.settingColor={r:0,g:0,b:0},this.settingSize=35,this.settingSpacing=.20446882736951905,this.settingOpacity=.8,this.settingHasSizePressure=!1,this.settingHasOpacityPressure=!1,this.settingLockLayerAlpha=!1,this.lineToolLastDot=0,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0},this.isDrawing=!1,this.copyImageData={},this.drawBuffer=[],this.copiedCells=[]}},EraserBrush:class{drawDot(t,e,i,s){this.context.save(),this.isBaseLayer?this.isTransparentBG?this.context.globalCompositeOperation="destination-out":this.context.globalCompositeOperation="source-atop":this.context.globalCompositeOperation="destination-out";let r=this.context.createRadialGradient(i,i,0,i,i,i),a=Math.pow(s,2);a=Math.max(0,Math.min((i-1)/i,a));let n=Math.max(0,Math.min(1,s));r.addColorStop(a,`rgba(${ei}, ${ei}, ${ei}, `+(2*n-n*n)+")"),r.addColorStop(1,`rgba(${ei}, ${ei}, ${ei}, 0)`),this.context.fillStyle=r,this.context.translate(t-i,e-i),this.context.fillRect(0,0,2*i,2*i),this.context.restore()}continueLine(t,e,i){let s,r;i=Math.max(0,Math.min(1,i));let a=this.useSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size),n=Math.max(1,Math.max(.5,1-this.opacity)*a*this.spacing),o=t=>{let e=t.t;s=this.lastInput2.pressure*(1-e)+i*e,r=this.useOpacityPressure?this.opacity*s*s:this.opacity,a=this.useSizePressure?Math.max(.1,s*this.size):Math.max(.1,this.size),this.drawDot(t.x,t.y,a,r)};void 0===t||void 0===e?this.bezierLine.addFinal(n,o):this.bezierLine.add(t,e,n,o)}startLine(t,e,i){this.historyEntry={tool:["brush","EraserBrush"],actions:[{action:"opacityPressure",params:[this.useOpacityPressure]},{action:"sizePressure",params:[this.useSizePressure]},{action:"setSize",params:[this.size]},{action:"setOpacity",params:[this.opacity]},{action:"setTransparentBG",params:[this.isTransparentBG]},{action:"startLine",params:[t,e,i]}]},this.isBaseLayer=0===this.context.canvas.index,i=Math.max(0,Math.min(1,i));let s=this.useOpacityPressure?this.opacity*i*i:this.opacity,r=this.useSizePressure?Math.max(.1,i*this.size):Math.max(.1,this.size);this.started=!0,r>1&&this.drawDot(t,e,r,s),this.lastDot=r*this.spacing,this.lastInput.x=t,this.lastInput.y=e,this.lastInput.pressure=i,this.lastInput2=tI.copyObj(this.lastInput),this.bezierLine=new tI.BezierLine,this.bezierLine.add(t,e,0,()=>void 0)}goLine(t,e,i){var s;this.started&&this.historyEntry&&(null===(s=this.historyEntry.actions)||void 0===s||s.push({action:"goLine",params:[t,e,i]}),this.continueLine(t,e,this.lastInput.pressure),this.lastInput2=tI.copyObj(this.lastInput),this.lastInput.x=t,this.lastInput.y=e,this.lastInput.pressure=i)}endLine(){if(this.bezierLine&&this.continueLine(void 0,void 0,this.lastInput.pressure),this.started=!1,this.bezierLine=void 0,this.historyEntry){var t;null===(t=this.historyEntry.actions)||void 0===t||t.push({action:"endLine",params:[]}),this.history.push(this.historyEntry),this.historyEntry=void 0}}drawLineSegment(t,e,i,s){let r;if(this.isBaseLayer=0===this.context.canvas.index,this.lastInput.x=i,this.lastInput.y=s,this.started||void 0===t)return;let a=Math.sqrt(Math.pow(i-t,2)+Math.pow(s-e,2)),n=(i-t)/a,o=(s-e)/a,l=Math.max(1,Math.max(.5,1-this.opacity)*this.size*this.spacing);for(this.lastDot=0,r=this.lastDot;r<=a;r+=l)this.drawDot(t+n*r,e+o*r,this.size,this.opacity);let h={tool:["brush","EraserBrush"],actions:[{action:"opacityPressure",params:[this.useOpacityPressure]},{action:"sizePressure",params:[this.useSizePressure]},{action:"setSize",params:[this.size]},{action:"setOpacity",params:[this.opacity]},{action:"setTransparentBG",params:[this.isTransparentBG]},{action:"drawLineSegment",params:[t,e,i,s]}]};this.history.push(h)}isDrawing(){return this.started}setContext(t){this.context=t}setHistory(t){this.history=t}setSize(t){this.size=t}setOpacity(t){this.opacity=t}sizePressure(t){this.useSizePressure=t}opacityPressure(t){this.useOpacityPressure=t}setTransparentBG(t){this.isTransparentBG=t}getSize(){return this.size}getOpacity(){return this.opacity}constructor(){this.size=30,this.spacing=.4,this.opacity=1,this.useSizePressure=!0,this.useOpacityPressure=!1,this.isTransparentBG=!1,this.history=new rH.DecoyKlHistory,this.isBaseLayer=!1,this.context={},this.started=!1,this.lastInput={x:0,y:0,pressure:0},this.lastInput2={x:0,y:0,pressure:0}}}};var sY={};sY=x("dwTKp").getBundleURL("lrLBb")+"brush-pen.49a7b91e.svg";const sX=function(){let t={image:m(sY),tooltip:tB("brush-pen"),sizeSlider:{min:.5,max:100,curve:tI.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1,curve:[[0,.01],[.5,.3],[1,1]]}},e=[tB("brush-pen-circle"),tB("brush-pen-chalk"),tB("brush-pen-calligraphy"),tB("brush-pen-square")];return tD.subscribe(()=>{t.tooltip=tB("brush-pen"),e=[tB("brush-pen-circle"),tB("brush-pen-chalk"),tB("brush-pen-calligraphy"),tB("brush-pen-square")]}),t.Ui=function(i){let s,r;let a=document.createElement("div"),n=new s_.PenBrush;n.setHistory(D),i.onSizeChange(n.getSize());let o=new en({optionArr:[0,1,2,3].map(t=>{let i=tI.el({className:"dark-invert",css:{width:"31px",height:"31px",backgroundSize:"contain",margin:"2px"}}),s=tI.canvas(70,70),r=tI.ctx(s);return 0===t||3===t?0===t?(r.beginPath(),r.arc(35,35,30,0,2*Math.PI),r.closePath(),r.fill()):r.fillRect(5,5,60,60):1===t?r.drawImage(sH(60),5,5):2===t&&r.drawImage(sj(60),5,5),i.style.backgroundImage="url("+s.toDataURL("image/png")+")",{id:t,label:i,title:e[t]}}),initId:0,onChange:t=>{n.setAlpha(t)}}),l=new tF({init:n.getLockAlpha(),label:tB("lock-alpha"),callback:function(t){n.setLockAlpha(t)},doHighlight:!0,title:tB("lock-alpha-title"),css:{display:"inline-block"}}),h=new tI.SplineInterpolator([[0,15],[8,7],[14,4],[30,3],[50,2.7],[100,2]]);function c(t){n.setSize(t),n.setSpacing(Math.max(2,h.interpolate(t))/15)}(function(){s=new tQ({label:tB("brush-size"),width:225,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,value:n.getSize(),curve:t.sizeSlider.curve,eventResMs:20,toDisplayValue:t=>2*t,toValue:t=>t/2,onChange:t=>{c(t),i.onSizeChange(t)},formatFunc:t=>t<10?tI.round(t,1):Math.round(t),manualInputRoundDigits:1}),r=new tQ({label:tB("opacity"),width:225,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,value:t.opacitySlider.max,curve:t.opacitySlider.curve,eventResMs:20,toDisplayValue:t=>100*t,toValue:t=>t/100,onChange:t=>{n.setOpacity(t),i.onOpacityChange(t)}});let e=tK(!0,function(t){n.sizePressure(t)}),h=tK(!1,function(t){n.opacityPressure(t)});a.append(tI.el({content:[s.getElement(),e],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),tI.el({content:[r.getElement(),h],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),tI.el({content:o.getElement(),css:{marginTop:"10px"}}),tI.el({content:l.getElement(),css:{marginTop:"10px"}}))})(),this.increaseSize=function(t){n.isDrawing()||s.changeSliderValue(t)},this.decreaseSize=function(t){n.isDrawing()||s.changeSliderValue(-t)},this.getSize=function(){return n.getSize()},this.setSize=function(t){c(t),s.setValue(t)},this.getOpacity=function(){return n.getOpacity()},this.setOpacity=function(t){n.setOpacity(t),r.setValue(t)},this.setColor=function(t){n.setColor(t)},this.setContext=function(t){n.setContext(t)},this.startLine=function(t,e,i){n.startLine(t,e,i)},this.goLine=function(t,e,i){n.goLine(t,e,i)},this.endLine=function(t,e){n.endLine(t,e)},this.getBrush=function(){return n},this.isDrawing=function(){return n.isDrawing()},this.getElement=function(){return a}},t}();var sG={};sG=x("dwTKp").getBundleURL("lrLBb")+"brush-blend.3706e8a1.svg";const sK=function(){let t={image:m(sG),tooltip:tB("brush-blend"),sizeSlider:{min:.5,max:100,curve:tI.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1}};return tD.subscribe(()=>{t.tooltip=tB("brush-blend")}),t.Ui=function(e){let i,s;let r=document.createElement("div"),a=new s_.BlendBrush;function n(t){a.setSize(t)}a.setHistory(D),e.onSizeChange(a.getSize()),function(){i=new tQ({label:tB("brush-size"),width:225,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,value:58,curve:t.sizeSlider.curve,eventResMs:20,toDisplayValue:t=>2*t,toValue:t=>t/2,onChange:t=>{n(t),e.onSizeChange(t)}}),s=new tQ({label:tB("opacity"),width:225,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,value:a.getOpacity(),curve:t.opacitySlider.curve,eventResMs:20,toDisplayValue:t=>100*t,toValue:t=>t/100,onChange:t=>{a.setOpacity(t),e.onOpacityChange(t)}});let o=new tQ({label:tB("brush-blending"),width:225,height:30,min:0,max:1,value:a.getBlending(),eventResMs:20,toDisplayValue:t=>100*t,toValue:t=>t/100,onChange:function(t){a.setBlending(t)}});o.getElement().style.marginTop="10px";let l=tK(!0,function(t){a.setSizePressure(t)}),h=tK(!1,function(t){a.setOpacityPressure(t)}),c=new tF({init:a.getLockAlpha(),label:tB("lock-alpha"),callback:function(t){a.setLockAlpha(t)},doHighlight:!0,title:tB("lock-alpha-title"),css:{marginTop:"10px",display:"inline-block"}});r.append(tI.el({content:[i.getElement(),l],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),tI.el({content:[s.getElement(),h],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}),o.getElement(),c.getElement())}(),this.increaseSize=function(t){a.getIsDrawing()||i.changeSliderValue(t)},this.decreaseSize=function(t){a.getIsDrawing()||i.changeSliderValue(-t)},this.getSize=function(){return a.getSize()},this.setSize=function(t){n(t),i.setValue(t)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(t){a.setOpacity(t),s.setValue(t)},this.setColor=function(t){a.setColor(t)},this.setContext=function(t){a.setContext(t)},this.startLine=function(t,e,i){a.startLine(t,e,i)},this.goLine=function(t,e,i,s){a.goLine(t,e,i,s)},this.endLine=function(){a.endLine()},this.getBrush=function(){return a},this.isDrawing=function(){return a.getIsDrawing()},this.getElement=function(){return r}},t}();var sq={};sq=x("dwTKp").getBundleURL("lrLBb")+"brush-sketchy.4c477c01.png";const s$=function(){let t={image:m(sq),tooltip:tB("brush-sketchy"),sizeSlider:{min:.5,max:10},opacitySlider:{min:.01,max:1}};return tD.subscribe(()=>{t.tooltip=tB("brush-sketchy")}),t.Ui=function(e){let i,s;let r=document.createElement("div"),a=new s_.SketchyBrush;a.setHistory(D),e.onSizeChange(a.getSize()),function(){i=new tQ({label:tB("brush-size"),width:250,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,value:2*a.getSize(),eventResMs:20,toDisplayValue:t=>2*t,toValue:t=>t/2,onChange:function(t){a.setSize(t),e.onSizeChange(t)},formatFunc:t=>t<10?tI.round(t,1):Math.round(t),manualInputRoundDigits:1}),s=new tQ({label:tB("opacity"),width:250,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,value:a.getOpacity(),eventResMs:20,toDisplayValue:t=>100*t,toValue:t=>t/100,onChange:t=>{a.setOpacity(t),e.onOpacityChange(t)}});let n=new tQ({label:tB("brush-blending"),width:250,height:30,min:0,max:1,value:a.getBlending(),eventResMs:20,toDisplayValue:t=>100*t,toValue:t=>t/100,onChange:function(t){a.setBlending(t)}}),o=new tQ({label:tB("brush-sketchy-scale"),width:250,height:30,min:1,max:20,value:a.getScale(),eventResMs:20,onChange:function(t){a.setScale(t)}});s.getElement().style.marginTop="10px",n.getElement().style.marginTop="10px",o.getElement().style.marginTop="10px",r.append(i.getElement(),s.getElement(),n.getElement(),o.getElement())}(),this.increaseSize=function(t){a.isDrawing()||i.changeSliderValue(t)},this.decreaseSize=function(t){a.isDrawing()||i.changeSliderValue(-t)},this.getSize=function(){return a.getSize()},this.setSize=function(t){a.setSize(t),i.setValue(t)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(t){a.setOpacity(t),s.setValue(t)},this.setColor=function(t){a.setColor(t)},this.setContext=function(t){a.setContext(t)},this.startLine=function(t,e,i){a.startLine(t,e,i)},this.goLine=function(t,e,i){a.goLine(t,e,i,void 0)},this.endLine=function(){a.endLine()},this.getSeed=function(){return parseInt(""+a.getSeed())},this.setSeed=function(t){a.setSeed(parseInt(""+t))},this.getBrush=function(){return a},this.isDrawing=function(){return a.isDrawing()},this.getElement=function(){return r}},t}();var sQ={};sQ=x("dwTKp").getBundleURL("lrLBb")+"brush-pixel.673f3e4c.svg";const sZ=function(){let t={image:m(sQ),tooltip:tB("brush-pixel"),sizeSlider:{min:.5,max:100,curve:tI.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1,curve:[[0,.01],[.5,.3],[1,1]]}};return tD.subscribe(()=>{t.tooltip=tB("brush-pixel")}),t.Ui=function(e){let i,s;let r=document.createElement("div"),a=new s_.PixelBrush;a.setHistory(D),e.onSizeChange(a.getSize());let n=new tF({init:a.getLockAlpha(),label:tB("lock-alpha"),callback:function(t){a.setLockAlpha(t)},doHighlight:!0,title:tB("lock-alpha-title"),css:{marginRight:"10px"}}),o=new tF({init:a.getIsEraser(),label:tB("eraser"),callback:function(t){a.setIsEraser(t)},css:{marginRight:"10px"}}),l=new tF({init:a.getUseDither(),label:tB("brush-pixel-dither"),callback:function(t){a.setUseDither(t)}}),h=new tI.SplineInterpolator([[.5,.45],[100,4]]);function c(t){a.setSize(t),a.setSpacing(h.interpolate(t)/t)}(function(){i=new tQ({label:tB("brush-size"),width:225,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,value:a.getSize(),curve:t.sizeSlider.curve,eventResMs:20,toDisplayValue:t=>2*t,toValue:t=>t/2,onChange:t=>{c(t),e.onSizeChange(t)}}),s=new tQ({label:tB("opacity"),width:225,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,value:t.opacitySlider.max,eventResMs:20,toDisplayValue:t=>100*t,toValue:t=>t/100,onChange:t=>{a.setOpacity(t),e.onOpacityChange(t)}});let h=tK(!0,function(t){a.sizePressure(t)});r.append(tI.el({content:[i.getElement(),h],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),s.getElement()),tI.el({parent:r,css:{display:"flex",marginTop:"10px"}}).append(n.getElement(),o.getElement(),l.getElement())})(),this.increaseSize=function(t){a.isDrawing()||i.changeSliderValue(t)},this.decreaseSize=function(t){a.isDrawing()||i.changeSliderValue(-t)},this.getSize=function(){return a.getSize()},this.setSize=function(t){c(t),i.setValue(2*t)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(t){a.setOpacity(t),s.setValue(100*t)},this.setColor=function(t){a.setColor(t)},this.setContext=function(t){a.setContext(t)},this.startLine=function(t,e,i){a.startLine(t,e,i)},this.goLine=function(t,e,i){a.goLine(t,e,i)},this.endLine=function(t,e){a.endLine(t,e)},this.getBrush=function(){return a},this.isDrawing=function(){return a.isDrawing()},this.toggleEraser=()=>{o.setValue(!o.getValue()),a.setIsEraser(o.getValue())},this.getElement=function(){return r}},t}();var sJ={};sJ=x("dwTKp").getBundleURL("lrLBb")+"brush-eraser.a9e10dce.svg";const s0=function(){let t={image:m(sJ),tooltip:tB("eraser")+" [E]",sizeSlider:{min:.5,max:200,curve:tI.quadraticSplineInput(.5,200,.1)},opacitySlider:{min:.01,max:1}};return tD.subscribe(()=>{t.tooltip=tB("eraser")+" [E]"}),t.Ui=function(e){let i,s;let r=document.createElement("div"),a=new s_.EraserBrush;a.setHistory(D),e.onSizeChange(a.getSize());let n=!1;function o(t){a.setSize(t)}(function(){i=new tQ({label:tB("brush-size"),width:225,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,value:30,curve:t.sizeSlider.curve,eventResMs:20,toDisplayValue:t=>2*t,toValue:t=>t/2,onChange:t=>{o(t),e.onSizeChange(t)},formatFunc:t=>t<10?tI.round(t,1):Math.round(t),manualInputRoundDigits:1}),s=new tQ({label:tB("opacity"),width:225,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,value:t.opacitySlider.max,eventResMs:20,toDisplayValue:t=>100*t,toValue:t=>t/100,onChange:t=>{a.setOpacity(t),e.onOpacityChange(t)}});let l=tK(!0,function(t){a.sizePressure(t)}),h=tK(!1,function(t){a.opacityPressure(t)});r.append(tI.el({content:[i.getElement(),l],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),tI.el({content:[s.getElement(),h],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}));let c=new tF({init:!1,label:tB("brush-eraser-transparent-bg"),callback:function(t){n=t,a.setTransparentBG(t)},css:{marginTop:"10px"}});r.append(c.getElement())})(),this.increaseSize=function(t){a.isDrawing()||i.changeSliderValue(t)},this.decreaseSize=function(t){a.isDrawing()||i.changeSliderValue(-t)},this.getSize=function(){return a.getSize()},this.setSize=function(t){o(t),i.setValue(t)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(t){a.setOpacity(t),s.setValue(t)},this.setColor=function(){},this.setContext=function(t){a.setContext(t)},this.startLine=function(t,e,i){a.startLine(t,e,i)},this.goLine=function(t,e,i){a.goLine(t,e,i)},this.endLine=function(){a.endLine()},this.getBrush=function(){return a},this.getIsTransparentBg=function(){return n},this.isDrawing=function(){return a.isDrawing()},this.getElement=function(){return r}},t}();var s1={};s1=x("dwTKp").getBundleURL("lrLBb")+"brush-smudge.45852bcd.svg";const s2=function(){let t={image:m(s1),tooltip:tB("brush-smudge"),sizeSlider:{min:.5,max:100,curve:tI.quadraticSplineInput(.5,100,.1)},opacitySlider:{min:.01,max:1,curve:[[0,.01],[.5,.3],[1,1]]}};return tD.subscribe(()=>{t.tooltip=tB("brush-smudge")}),t.Ui=function(e){let i,s;let r=document.createElement("div"),a=new s_.SmudgeBrush;a.setHistory(D),e.onSizeChange(a.getSize());let n=new tF({init:a.getLockAlpha(),label:tB("lock-alpha"),callback:function(t){a.setLockAlpha(t)},doHighlight:!0,title:tB("lock-alpha-title")}),o=new tI.SplineInterpolator([[0,15],[8,7],[14,4],[30,3],[50,2.7],[100,2]]);function l(t){a.setSize(t),a.setSpacing(Math.max(2,o.interpolate(t))/15)}(function(){i=new tQ({label:tB("brush-size"),width:225,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,value:a.getSize(),curve:t.sizeSlider.curve,eventResMs:20,toDisplayValue:t=>2*t,toValue:t=>t/2,onChange:t=>{l(t),e.onSizeChange(t)},formatFunc:t=>t<10?tI.round(t,1):Math.round(t),manualInputRoundDigits:1}),s=new tQ({label:tB("opacity"),width:225,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,value:a.getOpacity(),curve:t.opacitySlider.curve,eventResMs:20,toDisplayValue:t=>100*t,toValue:t=>t/100,onChange:t=>{a.setOpacity(t),e.onOpacityChange(t)}});let o=tK(!1,function(t){a.sizePressure(t)}),h=tK(!1,function(t){a.opacityPressure(t)});r.append(tI.el({content:[i.getElement(),o],css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),tI.el({content:[s.getElement(),h],css:{display:"flex",justifyContent:"space-between",alignItems:"center"}})),tI.el({parent:r,css:{marginTop:"10px"}}).append(n.getElement())})(),this.increaseSize=function(t){a.getIsDrawing()||i.changeSliderValue(t)},this.decreaseSize=function(t){a.getIsDrawing()||i.changeSliderValue(-t)},this.getSize=function(){return a.getSize()},this.setSize=function(t){l(t),i.setValue(t)},this.getOpacity=function(){return a.getOpacity()},this.setOpacity=function(t){a.setOpacity(t),s.setValue(t)},this.setColor=function(t){a.setColor(t)},this.setContext=function(t){a.setContext(t)},this.startLine=function(t,e,i){a.startLine(t,e,i)},this.goLine=function(t,e,i){a.goLine(t,e,i)},this.endLine=function(){a.endLine()},this.getBrush=function(){return a},this.isDrawing=function(){return a.getIsDrawing()},this.getElement=function(){return r}},t}();var s5={};s5=x("dwTKp").getBundleURL("lrLBb")+"brush-chemy.a5a188f6.svg";const s3=function(){let t={image:m(s5),tooltip:tB("brush-chemy"),sizeSlider:{min:.25,max:25,curve:tI.quadraticSplineInput(.25,25,.1),isDisabled:!0},opacitySlider:{min:.01,max:1}};return tD.subscribe(()=>{t.tooltip=tB("brush-chemy")}),t.Ui=function(e){let i,s,r;let a=document.createElement("div"),n=new s_.ChemyBrush;function o(t){n.setSize(t)}n.setHistory(D),e.onSizeChange(n.getSize()),function(){i=new tQ({label:tB("brush-size"),width:250,height:30,min:t.sizeSlider.min,max:t.sizeSlider.max,value:n.getSize(),curve:t.sizeSlider.curve,eventResMs:20,isEnabled:"stroke"===n.getMode(),toDisplayValue:t=>2*t,toValue:t=>t/2,onChange:t=>{o(t),e.onSizeChange(t)},formatFunc:t=>t<5?tI.round(t,1):Math.round(t),manualInputRoundDigits:1}),s=new tQ({label:tB("opacity"),width:250,height:30,min:t.opacitySlider.min,max:t.opacitySlider.max,value:n.getOpacity(),eventResMs:20,toDisplayValue:t=>100*t,toValue:t=>t/100,onChange:t=>{n.setOpacity(t),e.onOpacityChange(t)}}),tI.css(s.getElement(),{marginTop:"10px"}),r=new tF({init:n.getIsEraser(),label:tB("eraser"),callback:function(t){n.setIsEraser(t)},css:{marginTop:"10px",marginLeft:"10px"}});let l=new tF({init:n.getLockAlpha(),label:tB("lock-alpha"),callback:function(t){n.setLockAlpha(t)},doHighlight:!0,title:tB("lock-alpha-title"),css:{marginTop:"10px"}}),h=tI.el({css:{display:"flex",marginTop:"10px"}}),c=new en({optionArr:[{id:"fill",label:tI.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"#000",style:"transform-origin: 0 0; transform: translate(-0.5px, -0.5px) scale(19, 19) translate(0.5px, 0.5px)",d:"M 0,0 C 1.5,0 -0.5,1 1,1"}]}),title:tB("brush-chemy-fill")},{id:"stroke",label:tI.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 0.12px; transform-origin: 0 0; transform: translate(-0.5px, -0.5px) scale(19, 19) translate(0.5px, 0.5px)",d:"M 0,0 C 1.5,0 -0.5,1 1,1"}]}),title:tB("brush-chemy-stroke")}],initId:n.getMode(),onChange:s=>{n.setMode(s),t.sizeSlider.isDisabled="fill"===n.getMode(),i.setIsEnabled(!t.sizeSlider.isDisabled);let r=n.getSize();i.setValue(r),e.onSizeChange(r),e.onConfigChange()}}),p=new tG({label:tI.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 1px",d:"M 17.5,8 17.5,27"}]}),title:tB("brush-chemy-mirror-x"),init:n.getXSymmetry(),onChange:t=>{n.setXSymmetry(t)}}),d=new tG({label:tI.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"path",fill:"none",stroke:"#000",style:"stroke-width: 1px",d:"M 8,17.5 27,17.5"}]}),title:tB("brush-chemy-mirror-y"),init:n.getYSymmetry(),onChange:t=>{n.setYSymmetry(t)}}),u=new tG({label:tI.createSvg({class:"dark-invert",elementType:"svg",width:"35",height:"35",childrenArr:[{elementType:"defs",childrenArr:[{elementType:"linearGradient",id:"gradient",x1:"0",y1:"0",x2:"0",y2:"1",childrenArr:[{elementType:"stop",offset:"0%","stop-color":"rgba(0,0,0,0)"},{elementType:"stop",offset:"100%","stop-color":"rgba(0,0,0,1)"}]}]},{elementType:"rect",fill:"url('#gradient')",x:"8",y:"8",width:"19",height:"19"}]}),title:tB("brush-chemy-gradient"),init:n.getGradient(),onChange:t=>{n.setGradient(t)}});tI.css(p.getElement(),{marginLeft:"10px"});{let t={marginLeft:"4px"};tI.css(d.getElement(),t),tI.css(u.getElement(),t)}h.append(c.getElement(),p.getElement(),d.getElement(),u.getElement()),a.append(i.getElement(),s.getElement(),h,tI.el({content:[l.getElement(),r.getElement()],css:{display:"flex"}}))}(),this.increaseSize=function(t){n.getIsDrawing()||"stroke"!==n.getMode()||i.changeSliderValue(t)},this.decreaseSize=function(t){n.getIsDrawing()||"stroke"!==n.getMode()||i.changeSliderValue(-t)},this.getSize=function(){return n.getSize()},this.setSize=function(t){o(t),i.setValue(t)},this.getOpacity=function(){return n.getOpacity()},this.setOpacity=function(t){n.setOpacity(t),s.setValue(t)},this.setColor=function(t){n.setColor(t)},this.setContext=function(t){n.setContext(t)},this.startLine=function(t,e,i){n.startLine(t,e)},this.goLine=function(t,e,i,s){n.goLine(t,e)},this.endLine=function(){n.endLine()},this.getBrush=function(){return n},this.isDrawing=function(){return n.getIsDrawing()},this.toggleEraser=()=>{r.setValue(!r.getValue()),n.setIsEraser(r.getValue())},this.getElement=function(){return a}},t}();function s4(t,e){let i;if(!e&&(window.innerHeight<500||window.innerWidth<700)){window.open(t);return}let s=tI.el({tagName:"iframe",custom:{src:t},css:{width:"100%",height:"100%",opacity:"0"}});setTimeout(()=>{s.style.opacity=""},500);let r=tI.el();e||(i=tI.el({tagName:"a",parent:r,content:tB("modal-new-tab"),custom:{href:"help",target:"_blank"},onClick:function(){a.close()}}),s.onload=()=>{i&&s.contentWindow&&tI.setAttributes(i,{href:""+s.contentWindow.location}),s.style.opacity=""});let a=new tj({title:r,content:s,width:880,isMaxHeight:!0,onClose:()=>{i&&(s.src="about:blank",tI.destroyEl(i),i=void 0)}})}class s9{updateAge(){let t;if(!this.timestamp)return;let e=new Date().getTime()-this.timestamp;e=Math.floor(e/1e3/60),t=tB("file-storage-min-ago").replace("{x}",""+e),e>60&&(e=Math.floor(e/60),t=tB("file-storage-hours-ago").replace("{x}",""+e),e>24&&(e=Math.floor(e/24),t=tB("file-storage-days-ago").replace("{x}",""+e),e>31&&(t=tB("file-storage-month-ago")))),this.ageEl.textContent=t}resetButtons(){this.timestamp?(this.storeButtonEl.textContent=tB("file-storage-overwrite"),this.storeButtonEl.disabled=!1,this.clearButtonEl.disabled=!1):(this.storeButtonEl.textContent=tB("file-storage-store"),this.storeButtonEl.disabled=!1,this.clearButtonEl.disabled=!0)}updateThumb(t,e){this.timestamp=t,this.thumbnail=e,this.timestamp&&e?(e.classList.add("kl-storage-preview__im"),this.previewEl.innerHTML="",this.updateAge(),this.previewEl.append(e,this.ageEl)):this.previewEl.innerHTML=tB("file-storage-empty"),this.resetButtons()}async store(){this.storeButtonEl.textContent=tB("file-storage-storing"),this.storeButtonEl.disabled=!0,this.clearButtonEl.disabled=!0,await new Promise(t=>{setTimeout(()=>t(null),20)});try{await this.projectStore.store(this.getProject()),this.saveReminder.reset()}catch(t){this.resetButtons(),rH.popup({target:this.klRootEl,type:"error",message:`${tB("file-storage-failed-1")}<ul><li>${tB("file-storage-failed-2")}</li><li>${tB("file-storage-failed-3")}</li><li>${tB("file-storage-failed-4")}</li></ul>`,buttons:["Ok"]}),setTimeout(()=>{throw Error("storage-ui: failed to store browser storage, "+t)},0)}}async clear(){this.storeButtonEl.disabled=!0,this.clearButtonEl.disabled=!0;try{await this.projectStore.clear()}catch(t){this.resetButtons(),rH.popup({target:this.klRootEl,type:"error",message:tB("file-storage-failed-clear"),buttons:["Ok"]}),setTimeout(()=>{throw Error("storage-ui: failed to clear browser storage, "+t)},0)}}getElement(){return this.element}show(){}hide(){}destroy(){tI.destroyEl(this.infoEl),tI.destroyEl(this.storeButtonEl),tI.destroyEl(this.clearButtonEl),ee.removeIsDarkListener(this.updateCheckerboard),this.projectStore.unsubscribe(this.storeListener)}constructor(t,e,i,s,r){var a;this.projectStore=t,this.getProject=e,this.saveReminder=i,this.klRootEl=s,this.options=r,this.previewEl={},this.infoEl={},this.ageEl={},this.storeButtonEl={},this.clearButtonEl={},this.storeListener={},this.updateCheckerboard=()=>{},this.element=tI.el({css:{display:"grid",gridTemplateColumns:"1fr 0fr",gridTemplateRows:"0fr 0fr 0fr",gap:"0 0",gridTemplateAreas:'"title title" "preview store" "preview clear"'}});let n=tI.el({parent:this.element,content:tB("file-storage"),css:{gridArea:"title",display:"flex",margin:"-5px 0",gap:"5px"}});if(this.infoEl=tI.el({parent:n,content:"?",className:"kl-info-btn",title:tB("file-storage-about"),onClick:()=>{s4("./help/#help-browser-storage",!1)}}),this.projectStore.isBroken()){tI.el({parent:this.element,content:"\uD83D\uDD34 "+tB("file-storage-cant-access"),css:{marginTop:"10px"}});return}this.previewEl=tI.el({parent:this.element,title:tB("file-storage-thumb-title"),className:"kl-storage-preview"}),this.ageEl=tI.el({css:{position:"absolute",right:"1px",bottom:"1px",width:"calc(100% - 2px)",textAlign:"center",background:"rgba(0,0,0,0.7)",color:"#fff",textSize:"13px"}});let o=(null==r?void 0:r.isFocusable)?{}:{tabIndex:"-1"};this.storeButtonEl=tI.el({parent:this.element,tagName:"button",className:"grid-button",content:tB("file-storage-store"),css:{gridArea:"store"},custom:o,onClick:()=>this.store()}),this.clearButtonEl=tI.el({parent:this.element,tagName:"button",className:"grid-button",content:'<img src="'+m(eY)+'" height="20"/> '+tB("file-storage-clear"),css:{gridArea:"clear"},custom:o,onClick:()=>this.clear()}),(null===(a=this.options)||void 0===a?void 0:a.hideClearButton)&&(this.clearButtonEl.style.visibility="hidden"),this.storeListener={onUpdate:(t,e)=>{this.updateThumb(t,e)}},this.projectStore.subscribe(this.storeListener),this.updateCheckerboard=()=>{this.thumbnail&&tI.css(this.thumbnail,{background:"url('"+tI.createCheckerCanvas(4,ee.isDark()).toDataURL("image/png")+"')"})},ee.addIsDarkListener(this.updateCheckerboard),setInterval(()=>this.updateAge(),6e4),(async()=>{try{let t=await this.projectStore.read();t?this.updateThumb(t.timestamp,t.thumbnail):this.updateThumb()}catch(t){setTimeout(()=>{throw Error("storage-ui: failed initial read browser storage, "+t)},0)}})()}}function s6(t){let e=t.match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/),i=atob(e[3]),s=new Uint8Array(new ArrayBuffer(i.length));for(let t=0;t<s.length;t++)s[t]=i.charCodeAt(t);return new Blob([s],{type:e[1]})}function s8(t){return new Promise((e,i)=>{let s=new Image;try{s.src=tI.imageBlobToUrl(t)}catch(t){i("imageBlobToUrl, "+(t instanceof Error?t.message:""));return}s.onload=()=>{URL.revokeObjectURL(s.src),e(s)},s.onabort=()=>{i("layer image failed loading")},s.onerror=()=>{i("layer image failed loading")}})}class s7{static createThumbnail(t){let e=tI.fitInto(t.width,t.height,240,240).width/t.width;return eW(t,e)}static createStorageProject(t){return{id:1,timestamp:new Date().getTime(),thumbnail:s6(s7.createThumbnail(t).toDataURL("image/png")),width:t.width,height:t.height,layers:t.layers.map(t=>{let e;if(t.image instanceof HTMLCanvasElement)e=s6(t.image.toDataURL("image/png"));else throw Error("Not implemented");return{name:t.name,isVisible:t.isVisible,opacity:t.opacity,mixModeStr:t.mixModeStr,blob:e}})}}static async readStorageProject(t){let e;if(!t.width||!t.height||isNaN(t.width)||isNaN(t.height)||t.width<1||t.height<1)throw Error("readStorageProject invalid canvas size: "+t.width+", "+t.height);let i={width:t.width,height:t.height,layers:(await Promise.all(t.layers.map(t=>s8(t.blob)))).map((e,i)=>{let s=t.layers[i];return{name:s.name,isVisible:!("isVisible"in s)||s.isVisible,opacity:s.opacity,mixModeStr:s.mixModeStr,image:e}})};return e=t.thumbnail?await s8(t.thumbnail):s7.createThumbnail(i),{project:i,timestamp:t.timestamp,thumbnail:e}}}function rt(t){return new Promise((e,i)=>{t(e,i)})}var re={};function ri(t,e,i,s){(i||this._.texture).use(),this._.spareTexture.drawTo(function(){t.uniforms(e).drawRect()}),this._.spareTexture.swapWith(s||this._.texture)}re=x("dwTKp").getBundleURL("lrLBb")+"upload.5289e924.svg";class rs{static getDefaultShader(){return r.defaultShader=r.defaultShader||new rs,r.defaultShader}compileSource(t,e,i){let s=tI.throwIfNull(r.createShader(t));if(r.shaderSource(s,e.replace(/#define.*/,"")),r.compileShader(s),!r.getShaderParameter(s,r.COMPILE_STATUS))throw"compile error: "+i+" - "+r.getShaderInfoLog(s);return s}testPrecisionSupport(t){let e=r.getShaderPrecisionFormat(r.FRAGMENT_SHADER,t);return null!==e&&0!==e.precision}destroy(){r.deleteProgram(this.program),this.program=null}uniforms(t){return r.useProgram(this.program),Object.entries(t).forEach(([t,e])=>{let i=r.getUniformLocation(this.program,t);if(null!==i){if("[object Array]"==Object.prototype.toString.call(e))switch(e.length){case 1:r.uniform1fv(i,new Float32Array(e));break;case 2:r.uniform2fv(i,new Float32Array(e));break;case 3:r.uniform3fv(i,new Float32Array(e));break;case 4:r.uniform4fv(i,new Float32Array(e));break;case 9:r.uniformMatrix3fv(i,!1,new Float32Array(e));break;case 16:r.uniformMatrix4fv(i,!1,new Float32Array(e));break;default:throw"dont't know how to load uniform \""+t+'" of length '+e.length}else if("[object Number]"==Object.prototype.toString.call(e))r.uniform1f(i,e);else throw'attempted to set uniform "'+t+'" to invalid value '+(e||"undefined").toString()}}),this}textures(t){return r.useProgram(this.program),Object.entries(t).forEach(([t,e])=>{r.uniform1i(r.getUniformLocation(this.program,t),e)}),this}drawRect(t,e,i,s){let a;let n=r.getParameter(r.VIEWPORT);e=e!==a?(e-n[1])/n[3]:0,t=t!==a?(t-n[0])/n[2]:0,i=i!==a?(i-n[0])/n[2]:1,s=s!==a?(s-n[1])/n[3]:1,(r.vertexBuffer===a||null===r.vertexBuffer)&&(r.vertexBuffer=tI.throwIfNull(r.createBuffer())),r.bindBuffer(r.ARRAY_BUFFER,r.vertexBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array([t,e,t,s,i,e,i,s]),r.STATIC_DRAW),null==r.texCoordBuffer&&(r.texCoordBuffer=tI.throwIfNull(r.createBuffer()),r.bindBuffer(r.ARRAY_BUFFER,r.texCoordBuffer),r.bufferData(r.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),r.STATIC_DRAW)),null==this.vertexAttribute&&(this.vertexAttribute=r.getAttribLocation(this.program,"vertex"),r.enableVertexAttribArray(this.vertexAttribute)),null==this.texCoordAttribute&&(this.texCoordAttribute=r.getAttribLocation(this.program,"_texCoord"),r.enableVertexAttribArray(this.texCoordAttribute)),r.useProgram(this.program),r.bindBuffer(r.ARRAY_BUFFER,r.vertexBuffer),r.vertexAttribPointer(this.vertexAttribute,2,r.FLOAT,!1,0,0),r.bindBuffer(r.ARRAY_BUFFER,r.texCoordBuffer),r.vertexAttribPointer(this.texCoordAttribute,2,r.FLOAT,!1,0,0),r.drawArrays(r.TRIANGLE_STRIP,0,4)}constructor(t,e,i){if(this.vertexAttribute=null,this.texCoordAttribute=null,this.program=tI.throwIfNull(r.createProgram()),t=t||"    attribute vec2 vertex;    attribute vec2 _texCoord;    varying vec2 texCoord;    void main() {        texCoord = _texCoord;        gl_Position = vec4(vertex * 2.0 - 1.0, 0.0, 1.0);    }",e=e||"    uniform sampler2D texture;    varying vec2 texCoord;    void main() {        gl_FragColor = texture2D(texture, texCoord);    }",a||(a=this.testPrecisionSupport(r.HIGH_FLOAT)?"highp":this.testPrecisionSupport(r.MEDIUM_FLOAT)?"mediump":"lowp"),e="precision "+a+" float;"+e,r.attachShader(this.program,this.compileSource(r.VERTEX_SHADER,t,i+"(vertex)")),r.attachShader(this.program,this.compileSource(r.FRAGMENT_SHADER,e,i+"(fragment)")),r.linkProgram(this.program),!r.getProgramParameter(this.program,r.LINK_STATUS))throw"link error: "+r.getProgramInfoLog(this.program)}}const rr=function(t,e){return r.brightnessContrast=r.brightnessContrast||new rs(null,"        uniform sampler2D texture;        uniform float brightness;        uniform float contrast;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color.rgb += brightness;            if (contrast > 0.0) {                color.rgb = (color.rgb - 0.5) / (1.0 - contrast) + 0.5;            } else {                color.rgb = (color.rgb - 0.5) * (1.0 + contrast) + 0.5;            }            gl_FragColor = color;        }    ","brightnessContrast"),ri.call(this,r.brightnessContrast,{brightness:tI.clamp(t,-1,1),contrast:tI.clamp(e,-1,1)}),this};class ra{static fromElement(t){let e=new ra(0,0,r.RGBA,r.UNSIGNED_BYTE);return e.loadContentsOf(t),e}loadContentsOf(t){this.width=t.width||t.videoWidth,this.height=t.height||t.videoHeight,r.bindTexture(r.TEXTURE_2D,this.id),r.texImage2D(r.TEXTURE_2D,0,this.format,this.format,this.type,t)}initFromBytes(t,e,i){this.width=t,this.height=e,this.format=r.RGBA,this.type=r.UNSIGNED_BYTE,r.bindTexture(r.TEXTURE_2D,this.id),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,t,e,0,r.RGBA,this.type,new Uint8Array(i))}destroy(){r.deleteTexture(this.id),this.id=null}use(t){r.activeTexture(r.TEXTURE0+(t||0)),r.bindTexture(r.TEXTURE_2D,this.id)}unuse(t){r.activeTexture(r.TEXTURE0+(t||0)),r.bindTexture(r.TEXTURE_2D,null)}ensureFormat(t,e,i,s){(t!=this.width||e!=this.height||i!=this.format||s!=this.type)&&(this.width=t,this.height=e,this.format=i,this.type=s,r.bindTexture(r.TEXTURE_2D,this.id),r.texImage2D(r.TEXTURE_2D,0,this.format,t,e,0,this.format,this.type,null))}ensureFormatViaTexture(t){this.ensureFormat(t.width,t.height,t.format,t.type)}drawTo(t){if(r.framebuffer=r.framebuffer||r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,r.framebuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,this.id,0),r.checkFramebufferStatus(r.FRAMEBUFFER)!==r.FRAMEBUFFER_COMPLETE)throw Error("incomplete framebuffer");r.viewport(0,0,this.width,this.height),t(),r.bindFramebuffer(r.FRAMEBUFFER,null)}swapWith(t){let e;e=t.id,t.id=this.id,this.id=e,e=t.width,t.width=this.width,this.width=e,e=t.height,t.height=this.height,this.height=e,e=t.format,t.format=this.format,this.format=e}constructor(t,e,i,s){this.gl=r,this.id=tI.throwIfNull(r.createTexture()),this.width=t,this.height=e,this.format=i,this.type=s,this.canvas=null,r.bindTexture(r.TEXTURE_2D,this.id),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),t&&e&&r.texImage2D(r.TEXTURE_2D,0,this.format,t,e,0,this.format,this.type,null)}}function rn(t){let e=new tI.SplineInterpolator(t),i=[];for(let t=0;t<256;t++)i.push(tI.clamp(Math.floor(256*e.interpolate(t/255)),0,255));return i}const ro=function(t,e,i){let s=rn(t),a=rn(e),n=rn(i),o=[];for(let t=0;t<256;t++)o.splice(o.length,0,s[t],a[t],n[t],255);return this._.extraTexture.initFromBytes(256,1,o),this._.extraTexture.use(1),r.curves=r.curves||new rs(null,"        uniform sampler2D texture;        uniform sampler2D map;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);            color.r = texture2D(map, vec2(color.r)).r;            color.g = texture2D(map, vec2(color.g)).g;            color.b = texture2D(map, vec2(color.b)).b;            gl_FragColor = color;        }    ","curves"),r.curves.textures({map:1}),ri.call(this,r.curves,{}),this},rl=function(t,e){return r.hueSaturation=r.hueSaturation||new rs(null,"        uniform sampler2D texture;        uniform float hue;        uniform float saturation;        varying vec2 texCoord;        void main() {            vec4 color = texture2D(texture, texCoord);                        /* hue adjustment, wolfram alpha: RotationTransform[angle, {1, 1, 1}][{x, y, z}] */            float angle = hue * 3.14159265;            float s = sin(angle), c = cos(angle);            vec3 weights = (vec3(2.0 * c, -sqrt(3.0) * s - c, sqrt(3.0) * s - c) + 1.0) / 3.0;            float len = length(color.rgb);            color.rgb = vec3(                dot(color.rgb, weights.xyz),                dot(color.rgb, weights.zxy),                dot(color.rgb, weights.yzx)            );                        /* saturation adjustment */            float average = (color.r + color.g + color.b) / 3.0;            if (saturation > 0.0) {                color.rgb += (average - color.rgb) * (1.0 - 1.0 / (1.001 - saturation));            } else {                color.rgb += (average - color.rgb) * (-saturation);            }                        gl_FragColor = color;        }    ","hueSaturation"),ri.call(this,r.hueSaturation,{hue:tI.clamp(t,-1,1),saturation:tI.clamp(e,-1,1)}),this};var rh={};rh="#define GLSLIFY 1\nuniform sampler2D texture;\nvarying vec2 texCoord;\nuniform vec2 texSize;\n\nuniform float seed;\nuniform float type;\nuniform vec2 scale;\nuniform vec2 offset;\nuniform float octaves;\nuniform float samples;\n\nuniform float peaks;\nuniform float contrast;\nuniform float brightness;\nuniform float isReversed;\n\nuniform vec3 colA;\nuniform vec3 colB;\n\nuniform float channels; // 0 - rgb, 1 - alpha\n\n// fbm, cellular_noise based on\n// https://github.com/Gonkee/Gonkees-Shaders\n// MIT, Copyright  Gonkee\n\n// hash & simplex based on\n// https://www.shadertoy.com/view/Msf3WH\n// MIT, Copyright  2013 Inigo Quilez\n// https://www.youtube.com/c/InigoQuilez\n// https://iquilezles.org\n\nfloat rand(vec2 co) {\n    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);\n}\n\nfloat value_noise(vec2 coord){\n    return rand(floor(coord) / 100.0);\n}\n\nfloat cellular_noise(vec2 coord) {\n    vec2 i = floor(coord);\n    vec2 f = fract(coord);\n\n    float min_dist = 99999.0;\n    for (float x = -1.0; x <= 1.0; x++) {\n        for (float y = -1.0; y <= 1.0; y++) {\n            vec2 node = rand(i + vec2(x, y)) + vec2(x, y);\n            float dist = sqrt((f - node).x * (f - node).x + (f - node).y * (f - node).y);\n            min_dist = min(min_dist, dist);\n        }\n    }\n    return min_dist;\n}\n\n// ---------- Simplex Alternative ---------------------\n\nvec3 hash(vec3 p)\n{ p=vec3(dot(p, vec3(127.1, 311.7, 74.7))\n, dot(p, vec3(269.5, 183.3, 246.1))\n, dot(p, vec3(113.5, 271.9, 124.6)))\n;return fract(sin(p)*43758.5453123)*2.-1.; }\n\nmat3 hash(mat3 p)\n{ return mat3(hash(p[0]), hash(p[1]), hash(p[2])); }\n\nvec3 dots(mat3 a, vec3 w, mat3 b){ return vec3\n(dot(a[0], w-b[0]), dot(a[1], w-b[1]), dot(a[2], w-b[2])); }\n\n//return noiseGra13dx as .x, and its derivatives as .yzw\n// https://www.shadertoy.com/view/llByD1\nvec3 noiseGra13dx(in vec3 x) {\n    vec3 p=floor(x), w=fract(x)\n    #if 1\n    , u=w*w*w*(w*(w*6.-15.)+10.), v=30.*w*w*(w*(w-2.)+1.)//quintic hermite\n    #else\n    , u=w*w*(3.-2.*w), v=6.*w*(1.-w)//cubic hermite\n    #endif\n    //gradients\n    , G=hash(p+vec3(0)), F=hash(p+vec3(1))\n    ;mat3 D=hash(mat3(p, p, p)+mat3(1)), E=hash(mat3(p, p, p)+1.-mat3(1));\n    //projections\n    vec3 d=dots(D, w, mat3(1)), e=dots(E, w, 1.-mat3(1));\n    //interpolations\n    float g=dot(G, w), f=dot(F, w-vec3(1));\n    vec3 h=u.yzx*(g-d.xyx-d.yzz+e.zxy)+d-g, U=u*h, a=d-e;\n    mat3 S=D-mat3(G, G, G), W=D-E;\n    a.x=(a.x+a.y+a.z)+f-g;\n    ;float b=u.x*u.y*u.z;\n\n    vec4 result = vec4(g+U.x+U.y+U.z+a.x*b// value\n    , G*(1.-b)+b*(W[0]+W[1]+W[2]+F)//https://www.shadertoy.com/view/llByD1\n    +u.x*(S[0]+u.y*(G-D[0]-D[1]+E[2]))// derivatives\n    +u.y*(S[1]+u.z*(G-D[1]-D[2]+E[0]))\n    +u.z*(S[2]+u.x*(G-D[0]-D[2]+E[1]))\n    +v*(u.zxy*(g-d.xxy-d.zyz+e.yzx)+h+u.yzx*u.zxy*a.x));\n    return 0.5 + 0.5 * result.xxx;\n}\n\nfloat fbm(vec2 coord) {\n    float normalize_factor = 0.0;\n    float value = 0.0;\n    float scale = 0.5;\n\n    for (float i = 0.0; i < 7.0; i++){\n        if (i < octaves) {\n            if (type == 0.0) {\n                value += value_noise(coord) * scale;\n            } else if (type == 1.0) {\n                value += noiseGra13dx(vec3(coord.x, coord.y, 0.0)).r * scale;\n            } else if (type == 2.0) {\n                value += cellular_noise(coord) * scale;\n            }\n            normalize_factor += scale;\n            coord *= 2.0;\n            scale *= 0.5;\n        }\n    }\n    return value / normalize_factor;\n}\n\nfloat render (vec2 pos) {\n    float result = fbm(pos);\n    //\n\n    if (peaks > 0.0) {\n        result = abs(mod(result * peaks - 0.5, 1.0) - 0.5) * 2.0;// triangle\n        //result = mod(result * (peaks + 1.0), 1.0); // sawtooth\n    }\n\n    result += brightness;\n    if (contrast > 0.0) {\n        result = clamp((result - 0.5) / (1.0 - contrast) + 0.5, 0.0, 1.0);\n    } else if (contrast < 0.0) {\n        result = clamp((result - 0.5) * (1.0 + contrast) + 0.5, 0.0, 1.0);\n    }\n\n    if (isReversed == 1.0) {\n        result = 1.0 - result;\n    }\n    return result;\n}\n\nvoid main() {\n    vec4 color;\n\n    vec2 seedOffset;\n    seedOffset.x = (rand(vec2(seed, 0.0)) * 100.0 - 50.0);\n    seedOffset.y = (rand(vec2(0.0, seed)) * 100.0 - 50.0);\n\n    float val = 0.0;\n    vec2 basePos = texCoord * texSize / scale - offset / scale + seedOffset;\n\n    if (samples == 1.0) {\n        val = render(basePos);\n\n    }/* else if (samples == 4.0) {\n        for (float i = 0.0; i < 2.0; i++) {\n            for (float e = 0.0; e < 2.0; e++) {\n                val += render(basePos + (vec2(i, e) - 0.5) * 0.5 / scale);\n            }\n        }\n        val /= 4.0;\n\n    }*/ else if (samples == 16.0) {\n        for (float i = 0.0; i < 4.0; i++) {\n            for (float e = 0.0; e < 4.0; e++) {\n                val += render(basePos + (vec2(i, e) - 0.25) * 0.25 / scale);\n            }\n        }\n        val /= 16.0;\n    }\n\n    if (channels == 0.0) {\n        gl_FragColor = vec4(vec3(mix(colA, colB, val)), 1.0);\n    } else {\n        gl_FragColor = vec4(vec3(1.0), val);\n    }\n}";const rc=function(t,e,i,s,a,n,o,l,h,c,p,d,u){return r.noise=r.noise||new rs(null,m(rh).replace(/#define.*/,""),"noise"),ri.call(this,r.noise,{seed:t||0,type:e,scale:[i[0],i[1]],offset:s,octaves:a,samples:n,texSize:[this.width,this.height],peaks:o,brightness:l,contrast:h,isReversed:c?1:0,colA:p?[p.r/255,p.g/255,p.b/255]:[0,0,0],colB:d?[d.r/255,d.g/255,d.b/255]:[1,1,1],channels:"rgb"===u?0:1}),this},rp="    float random(vec3 scale, float seed) {        /* use the fragment position for a different seed per-pixel */        return fract(sin(dot(gl_FragCoord.xyz + seed, scale)) * 43758.5453 + seed);    }",rd=function(t){return r.triangleBlur=r.triangleBlur||new rs(null,"        uniform sampler2D texture;        uniform vec2 delta;        varying vec2 texCoord;        "+rp+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec4 sample = texture2D(texture, texCoord + delta * percent);                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;        }    ","triangleBlur"),ri.call(this,r.triangleBlur,{delta:[t/this.width,0]}),ri.call(this,r.triangleBlur,{delta:[0,t/this.height]}),this},ru=function(t,e,i,s,a,n){r.tiltShift=r.tiltShift||new rs(null,"        uniform sampler2D texture;        uniform float blurRadius;        uniform float gradientRadius;        uniform vec2 start;        uniform vec2 end;        uniform vec2 delta;        uniform vec2 texSize;        varying vec2 texCoord;        "+rp+"        void main() {            vec4 color = vec4(0.0);            float total = 0.0;                        /* randomize the lookup values to hide the fixed number of samples */            float offset = random(vec3(12.9898, 78.233, 151.7182), 0.0);                        vec2 normal = normalize(vec2(start.y - end.y, end.x - start.x));            float radius = smoothstep(0.0, 1.0, abs(dot(texCoord * texSize - start, normal)) / gradientRadius) * blurRadius;            for (float t = -30.0; t <= 30.0; t++) {                float percent = (t + offset - 0.5) / 30.0;                float weight = 1.0 - abs(percent);                vec4 sample = texture2D(texture, texCoord + delta / texSize * percent * radius);                                color += sample * weight;                total += weight;            }                        gl_FragColor = color / total;        }    ","tiltShift");let o=i-t,l=s-e,h=Math.sqrt(o*o+l*l);return ri.call(this,r.tiltShift,{blurRadius:a,gradientRadius:n,start:[t,e],end:[i,s],delta:[o/h,l/h],texSize:[this.width,this.height]}),ri.call(this,r.tiltShift,{blurRadius:a,gradientRadius:n,start:[t,e],end:[i,s],delta:[-l/h,o/h],texSize:[this.width,this.height]}),this};function rg(t,e){return new rs(null,t+"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;    void main() {        vec2 coord = texCoord * texSize;        "+e+"        gl_FragColor = texture2D(texture, coord / texSize);        vec2 clampedCoord = clamp(coord, vec2(0.0), texSize);        if (coord != clampedCoord) {            /* fade to transparent if we are outside the image */            gl_FragColor.a *= max(0.0, 1.0 - length(coord - clampedCoord));        }    }","warp")}function rm(t,e,i,s,r,a,n,o){let l=i-r,h=s-a,c=n-r,p=o-a,d=t-i+r-n,u=e-s+a-o,g=l*p-c*h,m=(d*p-c*u)/g,y=(l*u-d*h)/g;return[i-t+m*i,s-e+m*s,m,n-t+y*n,o-e+y*o,y,t,e,1]}function ry(t){let e=t[0],i=t[1],s=t[2],r=t[3],a=t[4],n=t[5],o=t[6],l=t[7],h=t[8],c=e*a*h-e*n*l-i*r*h+i*n*o+s*r*l-s*a*o;return[(a*h-n*l)/c,(s*l-i*h)/c,(i*n-s*a)/c,(n*o-r*h)/c,(e*h-s*o)/c,(s*r-e*n)/c,(r*l-a*o)/c,(i*o-e*l)/c,(e*a-i*r)/c]}const rf=function(t,e,i){if(r.matrixWarp=r.matrixWarp||rg("        uniform mat3 matrix;        uniform bool useTextureSpace;    ","        if (useTextureSpace) coord = coord / texSize * 2.0 - 1.0;        vec3 warp = matrix * vec3(coord, 1.0);        coord = warp.xy / warp.z;        if (useTextureSpace) coord = (coord * 0.5 + 0.5) * texSize;    "),4==(t=t.flat()).length)t=[t[0],t[1],0,t[2],t[3],0,0,0,1];else if(9!=t.length)throw"can only warp with 2x2 or 3x3 matrix";return ri.call(this,r.matrixWarp,{matrix:e?ry(t):t,texSize:[this.width,this.height],useTextureSpace:i?1:0}),this},rx=function(t,e){return r.unsharpMask=r.unsharpMask||new rs(null,"        uniform sampler2D blurredTexture;        uniform sampler2D originalTexture;        uniform float strength;        uniform float threshold;        varying vec2 texCoord;        void main() {            vec4 blurred = texture2D(blurredTexture, texCoord);            vec4 original = texture2D(originalTexture, texCoord);            gl_FragColor = mix(blurred, original, 1.0 + strength);        }    ","unsharpMask"),this._.extraTexture.ensureFormatViaTexture(this._.texture),this._.texture.use(),this._.extraTexture.drawTo(function(){rs.getDefaultShader().drawRect()}),this._.extraTexture.use(1),this.triangleBlur(t),r.unsharpMask.textures({originalTexture:1}),ri.call(this,r.unsharpMask,{strength:e}),this._.extraTexture.unuse(1),this},rv=function(t,e){return r.toAlpha=r.toAlpha||new rs(null,"    uniform bool isInverted;    uniform vec4 replace;    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        float alpha = (color.r + color.g + color.b) / 3.0;        if (isInverted) alpha = 1.0 - alpha;        alpha = min(color.a, alpha);        if (replace.a > 0.0) color = replace;        gl_FragColor = vec4(color.r, color.g, color.b, alpha);    }","toAlpha"),ri.call(this,r.toAlpha,{isInverted:t?1:0,replace:e?[e.r/255,e.g/255,e.b/255,e.a]:[0,0,0,0],texSize:[this.width,this.height]}),this},rb=function(){return r.invert=r.invert||new rs(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        color.rgb = 1.0 - color.rgb;        gl_FragColor = color;    }","invert"),ri.call(this,r.invert,{texSize:[this.width,this.height]}),this},rw=function(t,e){var i;let s=rm(...e),r=rm(...t),a=[(i=ry(s))[0]*r[0]+i[1]*r[3]+i[2]*r[6],i[0]*r[1]+i[1]*r[4]+i[2]*r[7],i[0]*r[2]+i[1]*r[5]+i[2]*r[8],i[3]*r[0]+i[4]*r[3]+i[5]*r[6],i[3]*r[1]+i[4]*r[4]+i[5]*r[7],i[3]*r[2]+i[4]*r[5]+i[5]*r[8],i[6]*r[0]+i[7]*r[3]+i[8]*r[6],i[6]*r[1]+i[7]*r[4]+i[8]*r[7],i[6]*r[2]+i[7]*r[5]+i[8]*r[8]];return this.matrixWarp(a)},rC=function(){return r.unmultiplyAlpha=r.unmultiplyAlpha||new rs(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        if(color.a > 0.0) {            color.rgb /= color.a;        }        gl_FragColor = color;    }","unmultiplyAlpha"),ri.call(this,r.unmultiplyAlpha,{texSize:[this.width,this.height]}),this},rS=function(t){return r.distort=r.distort||rg(`
    uniform float stepSize;
    uniform vec2 scale;
    uniform vec2 strength;
    uniform vec2 phase;
    uniform float type;
    uniform vec2 offset;
`,`
    const float PI = 3.14159265;
    float x = coord.x + offset.x;
    float y = coord.y + offset.y;
    if (stepSize > 1.0) {
        x = floor(x / stepSize) * stepSize;
        y = floor(y / stepSize) * stepSize;
    }
    float distortX = sin((x/scale.x + phase.x) * PI * 2.0) * strength.x;
    float distortY = sin((y/scale.y + phase.y) * PI * 2.0) * strength.y;
    if (type == 0.0) {
        coord.y += distortX;
        coord.x += distortY;
    } else if (type == 1.0) {
        coord.x += distortX;
        coord.y += distortY;
    } else if (type == 2.0) {
        x -= offset.x;
        y -= offset.y;
        gl_FragColor = texture2D(texture, vec2(x, y) / texSize);
        coord.y += sin(gl_FragColor.r/scale.x*200.0 + phase.x * PI * 2.0) * strength.x;
        coord.x += cos(gl_FragColor.g/scale.y*200.0 + phase.y * PI * 2.0) * strength.y;
    }
    coord.x = mod(coord.x, texSize.x);
    coord.y = mod(coord.y, texSize.y);
`),ri.call(this,r.distort,{stepSize:t.stepSize,type:t.distortType,scale:[t.scale.x,t.scale.y],strength:[t.strength.x,t.strength.y],phase:[t.phase.x,t.phase.y],offset:[t.offset.x,t.offset.y],texSize:[this.width,this.height]}),this},rk=function(){return r.multiplyAlpha=r.multiplyAlpha||new rs(null,"    uniform sampler2D texture;    uniform vec2 texSize;    varying vec2 texCoord;        void main() {        vec4 color = texture2D(texture, texCoord);        color.rgb *= color.a;        gl_FragColor = color;    }","multiplyAlpha"),ri.call(this,r.multiplyAlpha,{texSize:[this.width,this.height]}),this},rE=function(){function t(t){return{_:t,loadContentsOf:function(t){r=this._.gl,this._.loadContentsOf(t)},destroy:function(){r=this._.gl,this._.destroy()}}}function e(e){return t(ra.fromElement(e))}function i(t,e){let i=function(){let t=r.UNSIGNED_BYTE;if(r.getExtension("WEBGL_color_buffer_float")&&r.getExtension("OES_texture_float")&&r.getExtension("OES_texture_float_linear")){let e=new ra(100,100,r.RGBA,r.FLOAT);try{e.drawTo(function(){t=r.FLOAT})}catch(t){}e.destroy()}return t}();this._.texture&&this._.texture.destroy(),this._.spareTexture&&this._.spareTexture.destroy(),this.width=t,this.height=e,this._.texture=new ra(t,e,r.RGBA,i),this._.spareTexture=new ra(t,e,r.RGBA,i),this._.extraTexture=this._.extraTexture||new ra(0,0,r.RGBA,i),this._.flippedShader=this._.flippedShader||new rs(null,`
uniform sampler2D texture;
varying vec2 texCoord;
void main() {
    gl_FragColor = texture2D(texture, vec2(texCoord.x, 1.0 - texCoord.y));
}
        `,"flippedShader"),this._.isInitialized=!0}function s(t,e,s){return this._.isInitialized&&t._.width==this.width&&t._.height==this.height||i.call(this,e||t._.width,s||t._.height),t._.use(),this._.texture.drawTo(function(){rs.getDefaultShader().drawRect()}),this}function a(){return this._.texture.use(),this._.flippedShader.drawRect(),this}function n(){let e=new ra(this._.texture.width,this._.texture.height,r.RGBA,r.UNSIGNED_BYTE);return this._.texture.use(),e.drawTo(function(){rs.getDefaultShader().drawRect()}),t(e)}function o(){let t=this._.texture.width,e=this._.texture.height,i=new Uint8Array(t*e*4);return this._.texture.drawTo(function(){r.readPixels(0,0,t,e,r.RGBA,r.UNSIGNED_BYTE,i)}),i}function l(t){return function(...e){return r=this._.gl,t.apply(this,e)}}return()=>{var t;let i;if(!window.WebGLRenderingContext)throw"WebGLRenderingContext not set. Browser does not support WebGL.";let h=tI.canvas(1,1),c=(t={premultipliedAlpha:!1},i=null,["webgl","experimental-webgl","webgl2"].forEach(e=>{if(!i)try{i=h.getContext(e,t)}catch(t){}}),i);if(!c)throw"This browser does not support WebGL";return r=c,h._={gl:r,isInitialized:!1,texture:null,spareTexture:null,flippedShader:null},h.texture=l(e),h.draw=l(s),h.update=l(a),h.contents=l(n),h.getPixelArray=l(o),h.brightnessContrast=l(rr),h.hueSaturation=l(rl),h.triangleBlur=l(rd),h.unsharpMask=l(rx),h.perspective=l(rw),h.matrixWarp=l(rf),h.tiltShift=l(ru),h.noise=l(rc),h.curves=l(ro),h.invert=l(rb),h.multiplyAlpha=l(rk),h.unmultiplyAlpha=l(rC),h.toAlpha=l(rv),h.distort=l(rS),h}}();let rI=!1,rA=null;function rT(){if(rI)return rA;if(!rA||rA._.gl.isContextLost())try{rA=rE()}catch(t){rI=!0,rA=null,setTimeout(()=>{throw t})}return rA}var rM={};async function rL(t,e,i,s,r){let a;let n=s6(t.toDataURL("image/"+s)),o=window.open();if(!o)throw Error("could not create new tab");let l=o.document.createElement("div"),h=o.document.createElement("img");h.src=m(rM),l.append(h),tI.css(h,{filter:"invert(1)"}),tI.css(o.document.body,{backgroundColor:"#121211",backgroundImage:"linear-gradient(#2b2b2b 0%, #121211 50%)",backgroundRepeat:"no-repeat"});let c=o.document.createElement("div");c.style.marginTop="10px",l.append(c),c.textContent=tB("upload-uploading"),o.document.body.append(l),tI.css(l,{marginLeft:"auto",marginRight:"auto",marginTop:"100px",fontFamily:"system-ui, sans-serif",fontSize:"20px",textAlign:"center",transition:"opacity 0.3s ease-in-out",opacity:"0",color:"#ccc"}),setTimeout(function(){l.style.opacity="1"},20);try{let t=new FormData;t.append("title",e),t.append("description",i),t.append("image",n),a=await fetch("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID "+r},body:t})}catch(t){throw o.close(),t}if(!a.ok)throw o.close(),Error();let p=(await a.json()).data;return o.location.href=p.link.replace(/\.(jpg|png)/,""),p}async function rR(){return n||(n=await x("k6Jw8")),n}rM=x("dwTKp").getBundleURL("lrLBb")+"loading.7ff8a2ac.gif";const rP="kl-save-reminder";function rD(t,e){let i=document.createElementNS("http://www.w3.org/1999/xhtml","a");i.download=e,i.rel="noopener",i.href=URL.createObjectURL(t),setTimeout(()=>URL.revokeObjectURL(i.href),4e4),setTimeout(()=>i.click(),0)}function rB(t,e,i,s,r,a){if("brush"===t.tool[0]){let e=s[t.tool[1]];t.actions.forEach(t=>{e[t.action](...t.params)})}else if("canvas"===t.tool[0]){let a=t.params,n=i[t.action](...a);if("number"==typeof n){e=n;let t=E(i.getLayerContext(e));r(t),Object.entries(s).forEach(([,e])=>e.setContext(t))}}else if("filter"===t.tool[0]){let e=[{context:a(),klCanvas:i,input:t.params[0].input,history:new rH.DecoyKlHistory}];rH.filterLib[t.tool[1]][t.action](...e)}else if("misc"===t.tool[0]&&"focusLayer"===t.action){e=t.params[0];let a=E(i.getLayerContext(e));r(a),Object.entries(s).forEach(([,t])=>t.setContext(a))}else if("misc"===t.tool[0]&&"importImage"===t.action){let n=i.addLayer();if("number"==typeof n){e=n,t.params[1]&&i.renameLayer(e,t.params[1]);let a=E(i.getLayerContext(e));r(a),Object.entries(s).forEach(([,t])=>t.setContext(a))}a().drawImage(t.params[0],0,0)}return e}class rO{emit(t,e){for(let i=0;i<this.subscriberArr.length;i++)this.subscriberArr[i]!==e&&this.subscriberArr[i](t)}emitColor(t,e){this.emit({type:"color",value:t},e)}emitSize(t,e){this.emit({type:"size",value:t},e)}emitOpacity(t,e){this.emit({type:"opacity",value:t},e)}emitSliderConfig(t,e){this.emit({type:"sliderConfig",value:t},e)}setColor(t,e){this.onSetColor(t),this.emitColor(t,e)}setSize(t,e){this.onSetSize(t)}setOpacity(t,e){this.onSetOpacity(t)}getColor(){return this.onGetColor()}getSize(){return this.onGetSize()}getOpacity(){return this.onGetOpacity()}getSliderConfig(){return this.onGetSliderConfig()}subscribe(t){this.subscriberArr.includes(t)||this.subscriberArr.push(t)}unsubscribe(t){for(let e=0;e<this.subscriberArr.length;e++)t===this.subscriberArr[e]&&(this.subscriberArr.splice(e,1),e--)}constructor(t,e,i,s,r,a,n){if(this.onSetColor=t,this.onSetSize=e,this.onSetOpacity=i,this.onGetColor=s,this.onGetSize=r,this.onGetOpacity=a,this.onGetSliderConfig=n,this.subscriberArr=[],rO.instance)throw Error("BrushSettingService already instantiated");rO.instance=this}}var rz={};rz=x("dwTKp").getBundleURL("lrLBb")+"bitbof-logo.bc5e3ed5.svg";var rV={};rV=x("dwTKp").getBundleURL("lrLBb")+"ui-swap-lr.7f474f51.svg";const rH={brushes:s_,brushesUI:{penBrush:sX,blendBrush:sK,sketchyBrush:s$,pixelBrush:sZ,chemyBrush:s3,smudgeBrush:s2,eraserBrush:s0},BrushSettingService:rO,KlCanvas:class{init(t,e){if(!t||!e||isNaN(t)||isNaN(e)||t<1||e<1)throw Error("init - invalid canvas size: "+t+", "+e);this.width=t,this.height=e}emitChange(){this.changeListenerArr.forEach(t=>t())}updateIndices(){this.layerCanvasArr.forEach((t,e)=>{t.index=e})}setHistory(t){this.history=t}reset(t){if(!t.width||!t.height||t.width<1||t.height<1||isNaN(t.width)||isNaN(t.height))throw Error("invalid canvas size");if(this.history.pause(!0),this.width=t.width,this.height=t.height,this.layerCanvasArr.splice(1,Math.max(0,this.layerCanvasArr.length-1)),t.layers)for(let e=0;e<t.layers.length;e++){let i=t.layers[e];this.layerCanvasArr[e]||this.addLayer(),this.layerCanvasArr[e].name=i.name,this.layerCanvasArr[e].isVisible=i.isVisible,this.layerCanvasArr[e].width=this.width,this.layerCanvasArr[e].height=this.height,this.layerCanvasArr[e].mixModeStr=i.mixModeStr?i.mixModeStr:"source-over",tI.ctx(this.layerCanvasArr[e]).drawImage(i.image,0,0),this.layerOpacity(e,i.opacity)}else this.layerCanvasArr[0].name=t.layerName?t.layerName:tB("layers-layer")+" 1",this.layerCanvasArr[0].isVisible=!0,this.layerCanvasArr[0].width=this.width,this.layerCanvasArr[0].height=this.height,this.layerCanvasArr[0].mixModeStr="source-over",this.layerOpacity(0,1),t.color?this.layerFill(0,t.color):t.image&&tI.ctx(this.layerCanvasArr[0]).drawImage(t.image,0,0);return this.updateIndices(),this.history.pause(!1),this.history.push({tool:["canvas"],action:"reset",params:[t]}),this.layerCanvasArr.length-1}isLayerLimitReached(){return this.layerCanvasArr.length>=16}getWidth(){return this.width}getHeight(){return this.height}copy(t){if(1>t.getWidth()||1>t.getHeight()||isNaN(t.getWidth())||isNaN(t.getHeight()))throw Error("invalid canvas size");let e=t.getLayers();for(;this.layerCanvasArr.length>e.length;)this.removeLayer(this.layerCanvasArr.length-1);(t.getWidth()!=this.width||t.getHeight()!=this.height)&&this.init(t.getWidth(),t.getHeight());for(let t=0;t<e.length;t++)t>=this.layerCanvasArr.length?this.addLayer():(this.layerCanvasArr[t].width=this.width,this.layerCanvasArr[t].height=this.height),this.layerOpacity(t,e[t].opacity),this.layerCanvasArr[t].name=e[t].name,this.layerCanvasArr[t].isVisible=e[t].isVisible,this.layerCanvasArr[t].mixModeStr=e[t].mixModeStr,tI.ctx(this.layerCanvasArr[t]).drawImage(e[t].context.canvas,0,0);this.updateIndices()}getLayerCount(){return this.layerCanvasArr.length}resize(t,e,i="smooth"){let s,r;if(!t||!e||t===this.width&&e===this.height||isNaN(t)||isNaN(e)||t<1||e<1)return!1;if(t=Math.max(t,1),e=Math.max(e,1),"pixelated"===i){s=tI.canvas(t,e);let i=tI.ctx(s);i.imageSmoothingEnabled=!1;for(let r=0;r<this.layerCanvasArr.length;r++){r>0&&i.clearRect(0,0,t,e);let a=this.layerCanvasArr[r];i.drawImage(a,0,0,t,e),a.width=t,a.height=e,tI.ctx(a).drawImage(s,0,0)}}else if("smooth"===i){s=tI.canvas(),r=tI.canvas();for(let i=0;i<this.layerCanvasArr.length;i++)tI.resizeCanvas(this.layerCanvasArr[i],t,e,s,r)}else throw Error("unknown resize algorithm");return this.width=t,this.height=e,!0}resizeCanvas(t){let e=Math.round(t.left)+this.width+Math.round(t.right),i=Math.round(t.top)+this.height+Math.round(t.bottom),s=Math.round(t.left),r=Math.round(t.top);if(isNaN(e)||isNaN(i)||e<1||i<1)throw Error("KlCanvas.resizeCanvas - invalid canvas size");for(let a=0;a<this.layerCanvasArr.length;a++){let n=tI.canvas(this.width,this.height),o=this.layerCanvasArr[a],l=tI.ctx(this.layerCanvasArr[a]);tI.ctx(n).drawImage(o,0,0),this.layerCanvasArr[a].width=e,this.layerCanvasArr[a].height=i,l.save(),0===a&&t.fillColor&&(l.fillStyle=tI.ColorConverter.toRgbStr(t.fillColor),l.fillRect(0,0,e,i),l.clearRect(s,r,this.width,this.height)),l.drawImage(n,s,r),l.restore()}this.width=e,this.height=i}addLayer(t){if(this.isLayerLimitReached())return!1;let e=tI.canvas(this.width,this.height);if(!e.getContext("2d"))throw Error("kl-create-canvas-error");return e.isVisible=!0,e.mixModeStr="source-over",void 0===t?(this.layerCanvasArr[this.layerCanvasArr.length]=e,t=Math.max(0,this.layerCanvasArr.length-1)):(this.layerCanvasArr.splice(t+1,0,e),t++),e.name=tB("layers-layer")+" "+(this.layerCanvasArr.length+this.layerNrOffset),this.history.pause(!0),this.layerOpacity(t,1),this.history.pause(!1),this.updateIndices(),this.history.push({tool:["canvas"],action:"addLayer",params:[t-1]}),t}duplicateLayer(t){if(!this.layerCanvasArr[t]||this.isLayerLimitReached())return!1;let e=tI.canvas(this.width,this.height);return this.layerCanvasArr.splice(t+1,0,e),e.name=this.layerCanvasArr[t].name+" "+tB("layers-copy"),e.isVisible=this.layerCanvasArr[t].isVisible,e.mixModeStr=this.layerCanvasArr[t].mixModeStr,tI.ctx(e).putImageData(tI.ctx(this.layerCanvasArr[t]).getImageData(0,0,this.width,this.height),0,0),this.history.pause(!0),this.layerOpacity(t+1,this.layerCanvasArr[t].opacity),this.history.pause(!1),this.updateIndices(),this.history.push({tool:["canvas"],action:"duplicateLayer",params:[t]}),t+1}getLayerContext(t,e){if(this.layerCanvasArr[t])return tI.ctx(this.layerCanvasArr[t]);if(e)return null;throw Error("layer of index "+t+" not found (in "+this.layerCanvasArr.length+" layers)")}removeLayer(t){return!!this.layerCanvasArr[t]&&(this.layerCanvasArr.splice(t,1),this.updateIndices(),this.history.push({tool:["canvas"],action:"removeLayer",params:[t]}),Math.max(0,t-1))}renameLayer(t,e){return!!this.layerCanvasArr[t]&&(this.layerCanvasArr[t].name=e,this.history.push({tool:["canvas"],action:"renameLayer",params:[t,e]}),!0)}layerOpacity(t,e){this.layerCanvasArr[t]&&(e=Math.max(0,Math.min(1,e)),this.layerCanvasArr[t].opacity=e,this.history.push({tool:["canvas"],action:"layerOpacity",params:[t,e]}),this.emitChange())}setLayerIsVisible(t,e){if(this.layerCanvasArr[t])this.layerCanvasArr[t].isVisible=e;else throw Error(`layer ${t} undefined`);this.history.push({tool:["canvas"],action:"setLayerIsVisible",params:[t,e]})}moveLayer(t,e){if(0!==e&&this.layerCanvasArr[t]){let i=this.layerCanvasArr[t];this.layerCanvasArr.splice(t,1);let s=Math.max(0,Math.min(t+e,this.layerCanvasArr.length));return this.layerCanvasArr.splice(s,0,i),this.updateIndices(),this.history.push({tool:["canvas"],action:"moveLayer",params:[t,e]}),s}}mergeLayers(t,e,i){if(!this.layerCanvasArr[t]||!this.layerCanvasArr[e]||t===e)return;if(t>e){let i=t;t=e,e=i}let s=this.layerCanvasArr[e].opacity;if(0!==s&&s){let r=tI.ctx(this.layerCanvasArr[t]);r.save(),"as-alpha"===i?(tI.convertToAlphaChannelCanvas(this.layerCanvasArr[e]),r.globalCompositeOperation="destination-in"):i&&(r.globalCompositeOperation=i),r.globalAlpha=s,tI.ctx(this.layerCanvasArr[t]).drawImage(this.layerCanvasArr[e],0,0),r.restore(),i&&(r.save(),r.fillStyle="rgba(0,0,0,0.01)",r.fillRect(-.9999999,-.9999999,1,1),r.restore())}return this.updateIndices(),this.history.pause(!0),this.removeLayer(e),this.history.pause(!1),this.history.push({tool:["canvas"],action:"mergeLayers",params:[t,e,i]}),t}mergeAll(){if(1===this.layerCanvasArr.length)return!1;let t=tI.ctx(this.layerCanvasArr[0]);for(let e=1;e<this.layerCanvasArr.length;e++){let i=this.layerCanvasArr[e];i.isVisible&&0!==i.opacity&&(t.save(),t.globalCompositeOperation=i.mixModeStr,t.globalAlpha=i.opacity,t.drawImage(i,0,0),t.restore())}this.history.pause(!0);for(let t=this.layerCanvasArr.length-1;t>0;t--)this.removeLayer(t);return this.renameLayer(0,tB("layers-layer")+" 1"),this.history.pause(!1),this.history.push({tool:["canvas"],action:"mergeAll",params:[]}),0}rotate(t){for(;t<0;)t+=360;if((t%=360)%90!=0||0===t)return;let e=tI.canvas();0===t||180===t?(e.width=this.width,e.height=this.height):(90===t||270===t)&&(e.width=this.height,e.height=this.width);let i=tI.ctx(e);for(let s=0;s<this.layerCanvasArr.length;s++)i.clearRect(0,0,e.width,e.height),i.save(),i.translate(e.width/2,e.height/2),i.rotate(t*Math.PI/180),180===t?i.drawImage(this.layerCanvasArr[s],-e.width/2,-e.height/2):(90===t||270===t)&&i.drawImage(this.layerCanvasArr[s],-e.height/2,-e.width/2),this.layerCanvasArr[s].width=e.width,this.layerCanvasArr[s].height=e.height,tI.ctx(this.layerCanvasArr[s]).clearRect(0,0,this.layerCanvasArr[s].width,this.layerCanvasArr[s].height),tI.ctx(this.layerCanvasArr[s]).drawImage(e,0,0),i.restore();this.width=e.width,this.height=e.height}flip(t,e,i){if(!t&&!e)return;let s=tI.canvas(this.width,this.height);s.width=this.width,s.height=this.height;let r=tI.ctx(s);for(let a=0;a<this.layerCanvasArr.length;a++)(i||0===i)&&a!==i||(r.save(),r.clearRect(0,0,s.width,s.height),r.translate(s.width/2,s.height/2),r.scale(t?-1:1,e?-1:1),r.drawImage(this.layerCanvasArr[a],-s.width/2,-s.height/2),r.restore(),tI.ctx(this.layerCanvasArr[a]).clearRect(0,0,this.layerCanvasArr[a].width,this.layerCanvasArr[a].height),tI.ctx(this.layerCanvasArr[a]).drawImage(s,0,0))}layerFill(t,e,i){let s=tI.ctx(this.layerCanvasArr[t]);s.save(),i&&(s.globalCompositeOperation=i),s.fillStyle="rgba("+e.r+","+e.g+","+e.b+",1)",s.fillRect(0,0,this.layerCanvasArr[t].width,this.layerCanvasArr[t].height),s.restore(),s.save(),s.fillStyle="rgba(0,0,0,0.01)",s.fillRect(-.9999999,-.9999999,1,1),s.restore(),this.history.push({tool:["canvas"],action:"layerFill",params:[t,e,i]})}floodFill(t,e,i,s,r,a,n,o,l){let h,c,p;if(e<0||i<0||e>=this.width||i>=this.height||0===r)return;if(a=Math.round(a),!["above","current","all"].includes(n))throw Error("invalid sampleStr");if("all"===n){let s=1===this.layerCanvasArr.length?this.layerCanvasArr[0]:this.getCompleteCanvas(1);h=eH(tI.ctx(s).getImageData(0,0,this.width,this.height).data,this.width,this.height,e,i,a,Math.round(o),l),p=(c=tI.ctx(this.layerCanvasArr[t])).getImageData(0,0,this.width,this.height)}else{let s="above"===n?t+1:t;if(s>=this.layerCanvasArr.length)return;let r=tI.ctx(this.layerCanvasArr[s]),d=r.getImageData(0,0,this.width,this.height);h=eH(d.data,this.width,this.height,e,i,a,Math.round(o),l),c=t===s?r:tI.ctx(this.layerCanvasArr[t]),p=t===s?d:c.getImageData(0,0,this.width,this.height)}let d=p.data;if(s){if(1===r)for(let t=0;t<this.width*this.height;t++)255===h.data[t]&&(d[4*t]=s.r,d[4*t+1]=s.g,d[4*t+2]=s.b,d[4*t+3]=255);else for(let t=0;t<this.width*this.height;t++)255===h.data[t]&&(d[4*t]=tI.mix(d[4*t],s.r,r),d[4*t+1]=tI.mix(d[4*t+1],s.g,r),d[4*t+2]=tI.mix(d[4*t+2],s.b,r),d[4*t+3]=tI.mix(d[4*t+3],255,r))}else if(1===r)for(let t=0;t<this.width*this.height;t++)255===h.data[t]&&(d[4*t+3]=0);else for(let t=0;t<this.width*this.height;t++)255===h.data[t]&&(d[4*t+3]=tI.mix(d[4*t+3],0,r));c.putImageData(p,0,0),this.history.push({tool:["canvas"],action:"replaceLayer",params:[t,p]})}drawShape(t,e){(e.x1!==e.x2||e.y1!==e.y2)&&(ej(tI.ctx(this.layerCanvasArr[t]),e),this.history.push({tool:["canvas"],action:"drawShape",params:[t,tI.copyObj(e)]}))}drawGradient(t,e){eU(tI.ctx(this.layerCanvasArr[t]),e),this.history.push({tool:["canvas"],action:"drawGradient",params:[t,tI.copyObj(e)]})}text(t,e){eF(this.layerCanvasArr[t],tI.copyObj(e)),this.history.push({tool:["canvas"],action:"text",params:[t,tI.copyObj(e)]})}replaceLayer(t,e){tI.ctx(this.layerCanvasArr[t]).putImageData(e,0,0),this.history.push({tool:["canvas"],action:"replaceLayer",params:[t,e]})}clearLayer(t){let e=tI.ctx(this.layerCanvasArr[t]);e.save(),e.clearRect(0,0,this.layerCanvasArr[t].width,this.layerCanvasArr[t].height),e.restore(),this.history.push({tool:["canvas"],action:"clearLayer",params:[t]})}getLayers(){return this.layerCanvasArr.map(t=>({context:tI.ctx(t),isVisible:t.isVisible,opacity:t.opacity,name:t.name,mixModeStr:t.mixModeStr}))}getLayersFast(){return this.layerCanvasArr.map(t=>({canvas:t,isVisible:t.isVisible,opacity:t.opacity,name:t.name,mixModeStr:t.mixModeStr}))}getLayerIndex(t,e){for(let e=0;e<this.layerCanvasArr.length;e++)if(this.layerCanvasArr[e]===t)return e;if(!e)throw Error("layer not found (in "+this.layerCanvasArr.length+" layers)");return null}getLayer(t,e){if(this.layerCanvasArr[t])return{context:tI.ctx(this.layerCanvasArr[t]),isVisible:this.layerCanvasArr[t].isVisible,opacity:this.layerCanvasArr[t].opacity,name:this.layerCanvasArr[t].name,id:t};if(!e)throw Error("layer of index "+t+" not found (in "+this.layerCanvasArr.length+" layers)");return null}getColorAt(t,e){t=Math.floor(t),e=Math.floor(e);let i=tI.ctx(this.pickCanvas);i.save(),i.imageSmoothingEnabled=!1,i.clearRect(0,0,1,1);for(let s=0;s<this.layerCanvasArr.length;s++){let r=this.layerCanvasArr[s];r.isVisible&&0!==r.opacity&&(i.globalAlpha=r.opacity,i.globalCompositeOperation=r.mixModeStr,i.drawImage(r,-t,-e))}i.restore();let s=i.getImageData(0,0,1,1);return new tI.RGB(s.data[0],s.data[1],s.data[2])}getCompleteCanvas(t){return eW(this.getProject(),t)}getProject(){return{width:this.width,height:this.height,layers:this.layerCanvasArr.map(t=>({name:t.name,isVisible:t.isVisible,opacity:t.opacity,mixModeStr:t.mixModeStr,image:t}))}}addChangeListener(t){this.changeListenerArr.includes(t)||this.changeListenerArr.push(t)}removeChangeListener(t){for(let e=0;e<this.changeListenerArr.length;e++)if(this.changeListenerArr[e]===t){this.changeListenerArr.splice(e,1);return}}setMixMode(t,e){if(!this.layerCanvasArr[t])throw Error("invalid layer");this.layerCanvasArr[t].mixModeStr=e,this.history.push({tool:["canvas"],action:"setMixMode",params:[t,""+e]})}setComposite(t,e){if(!this.layerCanvasArr[t])throw Error("invalid layer");this.layerCanvasArr[t].compositeObj=A(e)}destroy(){this.isDestroyed||(this.layerCanvasArr.forEach(t=>{tI.freeCanvas(t)}),this.layerCanvasArr=[],this.isDestroyed=!0)}constructor(t,e=0){if(this.layerNrOffset=e,this.isDestroyed=!1,this.layerCanvasArr=[],this.pickCanvas=tI.canvas(1,1),this.history=new P,"copy"in t?(this.width=1,this.height=1):"width"in t&&"height"in t?(this.width=t.width,this.height=t.height):(this.width=1,this.height=1),this.init(this.width,this.height),this.changeListenerArr=[],"copy"in t)try{this.copy(t.copy)}catch(t){throw this.destroy(),t}else if("projectObj"in t){let e=[...t.projectObj.layers];if(this.init(t.projectObj.width,t.projectObj.height),!e.length)throw Error("project.layers needs at least 1 layer");for(let t=0;t<e.length;t++){let i=e[t].mixModeStr;if(i&&!eN.includes(i))throw Error("unknown mixModeStr "+e[t].mixModeStr);this.addLayer(),this.layerOpacity(t,e[t].opacity),this.layerCanvasArr[t].name=e[t].name,this.layerCanvasArr[t].isVisible=e[t].isVisible,this.layerCanvasArr[t].mixModeStr=i||"source-over",tI.ctx(this.layerCanvasArr[t]).drawImage(e[t].image,0,0)}}this.updateIndices()}},drawProject:eW,WorkspaceSvgOverlay:eZ,KlCanvasWorkspace:class{getRenderedTransform(){let t=this.renderedTransformObj;return t.x=this.highResTransformObj.x,t.y=this.highResTransformObj.y,t.scale=this.highResTransformObj.scale,t.angle=this.highResTransformObj.angle,t.angle%(Math.PI/2)==0&&t.scale%1==0&&(t.x=Math.round(t.x),t.y=Math.round(t.y)),t}updateChangeListener(){this.klCanvas.addChangeListener(()=>{this.lastRenderedState=-1,this.reqFrame()})}updateCursor(t,e){if(t===this.currentMode&&!e)return;let i=this.currentMode;if(this.currentMode=t,this.lastRenderedState=-1,0===this.currentMode?this.rootEl.style.cursor="crosshair":1===this.currentMode?this.rootEl.style.cursor="grab":2===this.currentMode?this.rootEl.style.cursor="grabbing":3===this.currentMode?this.rootEl.style.cursor="url('"+m(eJ)+"') 0 15, crosshair":4===this.currentMode?this.rootEl.style.cursor="url('"+m(e0)+"') 7 7, zoom-in":5===this.currentMode?this.rootEl.style.cursor="grab":6===this.currentMode?this.rootEl.style.cursor="grabbing":7===this.currentMode?this.rootEl.style.cursor="url('"+m(e1)+"') 1 12, crosshair":8===this.currentMode?this.rootEl.style.cursor="crosshair":9===this.currentMode?this.rootEl.style.cursor="url('"+m(e2)+"') 1 12, crosshair":10===this.currentMode&&(this.rootEl.style.cursor="crosshair"),[0,3,7,9,10].includes(this.globalMode)){let t=[1,2].includes(i),e=[1,2].includes(this.currentMode);!t&&e&&this.mainDoubleTapper.setAllowedPointerTypeArr(["mouse","pen","touch"]),t&&!e&&this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])}3!==this.currentMode&&this.svgOverlay.updateColorPreview({isVisible:!1})}internalZoomByStep(t,e,i){let s=Math.log2(this.targetTransformObj.scale)/Math.abs(t);s+=t>0?1:-1;let r=Math.max(e4,Math.min(128,Math.pow(2,s=Math.round(s)*Math.abs(t))));if(r===this.targetTransformObj.scale)return!1;let a=r/this.targetTransformObj.scale;this.targetTransformObj.scale=r;let n=tI.Matrix.getIdentity();n=tI.Matrix.multiplyMatrices(n,tI.Matrix.createTranslationMatrix(e,i)),n=tI.Matrix.multiplyMatrices(n,tI.Matrix.createScaleMatrix(a)),n=tI.Matrix.multiplyMatrices(n,tI.Matrix.createTranslationMatrix(-e,-i));let o=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];return o=tI.Matrix.multiplyMatrixAndPoint(n,o),this.targetTransformObj.x=o[0],this.targetTransformObj.y=o[1],this.transformIsDirty=!0,!0}mixTransformObj(t,e,i){if(t.angle===e.angle){t.scale=tI.mix(t.scale,e.scale,i),t.x=tI.mix(t.x,e.x,i),t.y=tI.mix(t.y,e.y,i),t.angle=tI.mix(t.angle,e.angle,i);return}let s=this.klCanvas.getWidth(),r=this.klCanvas.getHeight(),a=this.canvasToWorkspaceCoord({x:s/2,y:r/2},t),n=this.canvasToWorkspaceCoord({x:s/2,y:r/2},e);t.x=tI.mix(a.x,n.x,i),t.y=tI.mix(a.y,n.y,i),t.scale=tI.mix(t.scale,e.scale,i),t.angle=tI.mix(t.angle,e.angle,i);let o=this.canvasToWorkspaceCoord({x:-s/2,y:-r/2},t);t.x=o.x,t.y=o.y}render(){this.doResizeCanvas&&(this.doResizeCanvas=!1,this.renderTargetCanvas.width=this.renderWidth,this.renderTargetCanvas.height=this.renderHeight),this.renderContext(this.renderTargetCtx)}testBgVisible(){let t=[[0,0],[this.renderWidth,0],[this.renderWidth,this.renderHeight],[0,this.renderHeight]],e=this.getRenderedTransform(),i=tI.Matrix.getIdentity();i=tI.Matrix.multiplyMatrices(i,tI.Matrix.createScaleMatrix(1/e.scale)),i=tI.Matrix.multiplyMatrices(i,tI.Matrix.createRotationMatrix(-e.angle)),i=tI.Matrix.multiplyMatrices(i,tI.Matrix.createTranslationMatrix(-e.x,-e.y));for(let e=0;e<t.length;e++){let s=[t[e][0],t[e][1],0,1];if(!(0<=(s=tI.Matrix.multiplyMatrixAndPoint(i,s))[0]&&s[0]<=this.klCanvas.getWidth()&&0<=s[1]&&s[1]<=this.klCanvas.getHeight()))return!0}return!1}renderContext(t){let e=this.klCanvas.getWidth(),i=this.klCanvas.getHeight(),s=this.getRenderedTransform(),r=ee.isDark();s.scale>=4||1===s.scale&&0===s.angle?t.imageSmoothingEnabled=!1:(t.imageSmoothingEnabled=!0,t.imageSmoothingQuality="low"),t.save();{this.bgVisible?(t.fillStyle=r?"rgb(33, 33, 33)":"rgb(158,158,158)",t.fillRect(0,0,this.renderWidth,this.renderHeight)):t.clearRect(0,0,this.renderWidth,this.renderHeight),this.bgVisible&&(t.save(),t.translate(s.x,s.y),t.scale(s.scale,s.scale),t.rotate(s.angle),t.imageSmoothingEnabled=!1,t.globalAlpha=r?.25:.2,t.drawImage(r?this.emptyLightCanvas:this.emptyCanvas,-1/s.scale,-1/s.scale,e+2/s.scale,i+2/s.scale),t.globalAlpha=1,t.globalCompositeOperation="destination-out",t.drawImage(this.emptyCanvas,0,0,e,i),t.restore()),t.translate(s.x,s.y),t.scale(s.scale,s.scale),t.rotate(s.angle);let a=this.klCanvas.getLayersFast();for(let s=0;s<a.length;s++){if(!a[s].isVisible||0===a[s].opacity)continue;t.globalAlpha=a[s].opacity,t.globalCompositeOperation=a[s].mixModeStr;let r=a[s].canvas.compositeObj;r?(this.compositeCanvas.width!==a[s].canvas.width||this.compositeCanvas.height!==a[s].canvas.height?(this.compositeCanvas.width=a[s].canvas.width,this.compositeCanvas.height=a[s].canvas.height):this.compositeCtx.clearRect(0,0,this.compositeCanvas.width,this.compositeCanvas.height),this.compositeCtx.drawImage(a[s].canvas,0,0),r.draw(this.compositeCtx),t.drawImage(this.compositeCanvas,0,0,e,i)):t.drawImage(a[s].canvas,0,0,e,i)}t.globalAlpha=1}t.restore(),5===this.currentMode||6===this.currentMode?this.svgOverlay.updateCompass({isVisible:!0,angleDeg:s.angle/Math.PI*180}):this.svgOverlay.updateCompass({isVisible:!1})}workspaceToCanvasCoord(t){let e=this.getRenderedTransform(),i=tI.Matrix.getIdentity();i=tI.Matrix.multiplyMatrices(i,tI.Matrix.createScaleMatrix(1/e.scale)),i=tI.Matrix.multiplyMatrices(i,tI.Matrix.createRotationMatrix(-e.angle)),i=tI.Matrix.multiplyMatrices(i,tI.Matrix.createTranslationMatrix(-e.x,-e.y));let s=[t.x,t.y,0,1];return{x:(s=tI.Matrix.multiplyMatrixAndPoint(i,s))[0],y:s[1]}}canvasToWorkspaceCoord(t,e){let i=tI.Matrix.getIdentity();i=tI.Matrix.multiplyMatrices(i,tI.Matrix.createTranslationMatrix(e.x,e.y)),i=tI.Matrix.multiplyMatrices(i,tI.Matrix.createRotationMatrix(e.angle)),i=tI.Matrix.multiplyMatrices(i,tI.Matrix.createScaleMatrix(e.scale));let s=[t.x,t.y,0,1];return{x:(s=tI.Matrix.multiplyMatrixAndPoint(i,s))[0],y:s[1]}}snapAngleRad(t,e,i){let s=180*t/Math.PI,r=Math.abs(s%e);return Math.min(r,e-r)<=i&&(s=Math.round(s/e)*e),s/180*Math.PI}minimizeAngleRad(t){return(t%=2*Math.PI)>Math.PI?t-=2*Math.PI:t<-Math.PI&&(t+=2*Math.PI),t}resetInputProcessor(){this.currentInputProcessor=null,this.updateCursor(this.globalMode),this.reqFrame(!0)}reqFrame(t){this.animationFrameRequested=!0,t&&(this.lastRenderedState=-1)}updateLoop(){window.requestAnimationFrame(()=>this.updateLoop());let t=D.getState(),e=this.lastRenderedState<t,i=performance.now(),s=(i-this.lastRenderTime)*60/1e3;this.lastRenderTime=i,(this.animationFrameRequested||e)&&(this.animationFrameRequested=!1,this.checkChange(s))}checkChange(t){let e=D.getState(),i=this.lastRenderedState<e||this.highResTransformObj.scale!==this.targetTransformObj.scale||this.highResTransformObj.x!==this.targetTransformObj.x||this.highResTransformObj.y!==this.targetTransformObj.y;if(!this.doAnimateTranslate&&(this.highResTransformObj.scale===this.targetTransformObj.scale||Math.abs(this.highResTransformObj.scale-this.targetTransformObj.scale)<.008*this.targetTransformObj.scale))this.highResTransformObj.scale=this.targetTransformObj.scale,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.highResTransformObj.angle=this.targetTransformObj.angle,this.transformIsDirty&&(this.transformIsDirty=!1,this.bgVisible=this.testBgVisible()),this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale});else if((this.highResTransformObj.x===this.targetTransformObj.x||.5>Math.abs(this.highResTransformObj.x-this.targetTransformObj.x))&&(this.highResTransformObj.y===this.targetTransformObj.y||.5>Math.abs(this.highResTransformObj.y-this.targetTransformObj.y))&&(this.highResTransformObj.scale===this.targetTransformObj.scale||Math.abs(this.highResTransformObj.scale-this.targetTransformObj.scale)<.008*this.targetTransformObj.scale))this.highResTransformObj.scale=this.targetTransformObj.scale,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.highResTransformObj.angle=this.targetTransformObj.angle,this.doAnimateTranslate=!1,this.transformIsDirty&&(this.transformIsDirty=!1,this.bgVisible=this.testBgVisible()),this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale});else{this.reqFrame();let e=Math.min(1,.3*t);this.mixTransformObj(this.highResTransformObj,this.targetTransformObj,e),this.bgVisible=!0,this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale})}if(this.pointer&&0==this.currentMode&&!this.usesCssCursor?this.svgOverlay.updateCursor({x:this.pointer.x,y:this.pointer.y,isVisible:!0}):this.svgOverlay.updateCursor({isVisible:!1}),i){this.lastRenderedState=e;let t=performance.now();this.render(),this.renderTime=tI.mix(this.renderTime,performance.now()-t,.05)}}getElement(){return this.rootEl}setCanvas(t){this.klCanvas=t,this.lastDrawEvent=null,this.resetView(),this.updateChangeListener(),this.lastRenderedState=-1,this.reqFrame()}setSize(t,e){let i=this.renderWidth,s=this.renderHeight;(t!==i||e!==s)&&(this.doResizeCanvas=!0,this.renderWidth=t,this.renderHeight=e,this.svgOverlay.setSize(t,e),this.targetTransformObj.x+=(t-i)/2,this.targetTransformObj.y+=(e-s)/2,this.highResTransformObj.x=this.targetTransformObj.x,this.highResTransformObj.y=this.targetTransformObj.y,this.bgVisible=this.testBgVisible(),this.lastRenderedState=-1,this.reqFrame())}setMode(t){"draw"===t&&(this.globalMode=0,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"fill"===t&&(this.globalMode=7,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"gradient"===t&&(this.globalMode=8,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"text"===t&&(this.globalMode=9,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"shape"===t&&(this.globalMode=10,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"])),"hand"===t&&(this.globalMode=1,this.mainDoubleTapper.setAllowedPointerTypeArr(["mouse","pen","touch"])),"pick"===t&&(this.globalMode=3,this.mainDoubleTapper.setAllowedPointerTypeArr(["touch"]))}getMode(){if(0===this.globalMode)return"draw";if(7===this.globalMode)return"fill";if(8===this.globalMode)return"gradient";if(9===this.globalMode)return"text";if(10===this.globalMode)return"shape";if(1===this.globalMode)return"hand";if(3===this.globalMode)return"pick";throw Error("unknown globalMode")}setCursorSize(t){this.brushRadius=t/2,this.svgOverlay.updateCursor({radius:this.brushRadius*this.highResTransformObj.scale}),null===this.pointer&&(this.hideBrushCursorTimeout&&clearTimeout(this.hideBrushCursorTimeout),this.svgOverlay.updateCursor({x:this.renderWidth/2,y:this.renderHeight/2,isVisible:!0}),this.hideBrushCursorTimeout=setTimeout(()=>{null===this.pointer&&this.svgOverlay.updateCursor({isVisible:!1})},500))}zoomByStep(t){this.internalZoomByStep(t,this.renderWidth/2,this.renderHeight/2)&&(this.lastRenderedState=-1,this.reqFrame(),this.onViewChange({changed:["scale"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale}))}resetView(t){this.targetTransformObj.scale=1,this.targetTransformObj.angle=0,this.targetTransformObj.x=(this.renderWidth-this.klCanvas.getWidth())/2,this.targetTransformObj.y=(this.renderHeight-this.klCanvas.getHeight())/2,t?(this.doAnimateTranslate=!0,this.transformIsDirty=!0):this.highResTransformObj=tI.copyObj(this.targetTransformObj),this.bgVisible=this.testBgVisible(),this.reqFrame(),t&&this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle})}fitView(t){let e=this.snapAngleRad(this.targetTransformObj.angle,90,90),i=[[0,0],[this.klCanvas.getWidth(),0],[this.klCanvas.getWidth(),this.klCanvas.getHeight()],[0,this.klCanvas.getHeight()],[this.klCanvas.getWidth()/2,this.klCanvas.getHeight()/2]],s=tI.Matrix.getIdentity();s=tI.Matrix.multiplyMatrices(s,tI.Matrix.createRotationMatrix(e));for(let t=0;t<i.length;t++){let e=[i[t][0],i[t][1],0,1];e=tI.Matrix.multiplyMatrixAndPoint(s,e),i[t][0]=e[0],i[t][1]=e[1]}let r={};for(let t=0;t<i.length;t++)(void 0===r.x1||i[t][0]<r.x1)&&(r.x1=i[t][0]),(void 0===r.y1||i[t][1]<r.y1)&&(r.y1=i[t][1]),(void 0===r.x2||i[t][0]>r.x2)&&(r.x2=i[t][0]),(void 0===r.y2||i[t][1]>r.y2)&&(r.y2=i[t][1]);let a=r.x2-r.x1,n=r.y2-r.y1,{width:o}=tI.fitInto(a,n,this.renderWidth-0,this.renderHeight-0,1),l=Math.min(128,o/a),h={angle:e,x:this.renderWidth/2-(i[4][0]-i[0][0])*l,y:this.renderHeight/2-(i[4][1]-i[0][1])*l,scale:l};return(!(h.angle===this.targetTransformObj.angle&&1e-10>Math.abs(h.x-this.targetTransformObj.x)&&1e-10>Math.abs(h.y-this.targetTransformObj.y))||h.scale!==this.targetTransformObj.scale)&&(this.targetTransformObj=h,t?this.doAnimateTranslate=!0:this.highResTransformObj=tI.copyObj(this.targetTransformObj),this.transformIsDirty=!0,this.reqFrame(),t&&this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle}),!0)}resetOrFitView(){!e3.disableAutoFit&&this.klCanvas.getWidth()<=this.renderWidth/4&&this.klCanvas.getHeight()<=this.renderHeight/4?this.fitView():this.resetView()}setAngle(t,e){let i={x:this.renderWidth/2,y:this.renderHeight/2},s=this.targetTransformObj.angle,r=t/180*Math.PI;e?this.targetTransformObj.angle+=r:this.targetTransformObj.angle=r,this.targetTransformObj.angle=this.minimizeAngleRad(this.snapAngleRad(this.targetTransformObj.angle,90,4));let a=tI.Matrix.getIdentity();a=tI.Matrix.multiplyMatrices(a,tI.Matrix.createTranslationMatrix(i.x,i.y)),a=tI.Matrix.multiplyMatrices(a,tI.Matrix.createRotationMatrix(this.targetTransformObj.angle-s)),a=tI.Matrix.multiplyMatrices(a,tI.Matrix.createTranslationMatrix(-i.x,-i.y));let n=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];n=tI.Matrix.multiplyMatrixAndPoint(a,n),this.targetTransformObj.x=n[0],this.targetTransformObj.y=n[1],this.highResTransformObj=tI.copyObj(this.targetTransformObj),this.transformIsDirty=!0,this.reqFrame(!0)}translateView(t,e){this.targetTransformObj.x+=40*t,this.targetTransformObj.y+=40*e,this.transformIsDirty=!0,this.doAnimateTranslate=!0,this.reqFrame(!0)}getIsDrawing(){return this.isDrawing}getScale(){return this.targetTransformObj.scale}getAngleDeg(){return 180*this.targetTransformObj.angle/Math.PI}getMaxScale(){return 128}getMinScale(){return e4}requestFrame(){this.lastRenderedState=-1,this.reqFrame()}setLastDrawEvent(t,e,i){if(void 0===t){this.lastDrawEvent=null;return}this.lastDrawEvent||(this.lastDrawEvent={x:0,y:0,pressure:0}),this.lastDrawEvent.x=t,this.lastDrawEvent.y=e,this.lastDrawEvent.pressure=i}constructor(t){this.rootEl=tI.el({css:{position:"absolute",left:"0",right:"0",top:"0",bottom:"0",cursor:"crosshair",userSelect:"none"}}),this.klCanvas=t.klCanvas,this.onViewChange=t.onViewChange,this.renderTargetCanvas=tI.canvas(t.width,t.height),this.renderTargetCtx=tI.ctx(this.renderTargetCanvas),this.renderWidth=t.width,this.renderHeight=t.height,this.compositeCanvas=tI.canvas(1,1),this.compositeCtx=tI.ctx(this.compositeCanvas),this.doResizeCanvas=!1,this.oldTransformObj=null,this.targetTransformObj={x:0,y:0,scale:1,angle:0},this.highResTransformObj={x:0,y:0,scale:1,angle:0},this.renderedTransformObj={},this.cursorPos={x:0,y:0},this.usesCssCursor=!1,this.bgVisible=!0,this.transformIsDirty=!0,this.doAnimateTranslate=!0,this.svgOverlay=new eZ({width:t.width,height:t.height}),tI.css(this.renderTargetCanvas,{userSelect:"none",pointerEvents:"none"}),tI.createCheckerDataUrl(8,t=>{this.renderTargetCanvas.style.background="url("+t+")"},ee.isDark()),ee.addIsDarkListener(()=>{this.renderTargetCanvas.style.background="url("+tI.createCheckerDataUrl(8,void 0,ee.isDark())+")",this.lastRenderedState=-1,this.reqFrame()}),this.rootEl.append(this.renderTargetCanvas,this.svgOverlay.getElement()),this.rootEl.addEventListener("touchend",t=>(t.preventDefault(),!1)),this.rootEl.addEventListener("contextmenu",t=>(t.preventDefault(),!1)),this.rootEl.addEventListener("dragstart",t=>(t.preventDefault(),!1)),this.emptyCanvas=tI.canvas(1,1),this.emptyLightCanvas=tI.canvas(1,1);{let t=tI.ctx(this.emptyCanvas);t.fillRect(0,0,1,1),(t=tI.ctx(this.emptyLightCanvas)).fillStyle="#fff",t.fillRect(0,0,1,1)}this.keyListener=new tI.KeyListener({onDown:(t,e,i,s)=>{if(!(rH.dialogCounter.get()>0||tI.isInputFocused(!0))&&("alt"===t&&e.preventDefault(),!s)){if(this.currentInputProcessor)this.currentInputProcessor.onKeyDown(t,e,i,s);else{if([0,3,7,8,9,10].includes(this.globalMode)&&"space"===i){this.currentInputProcessor=this.inputProcessorObj.spaceHand,this.currentInputProcessor.onKeyDown(t,e,i,s);return}if([0,1,7,8,9,10].includes(this.globalMode)&&"alt"===i){this.currentInputProcessor=this.inputProcessorObj.altPicker,this.currentInputProcessor.onKeyDown(t,e,i,s);return}if(["r","shift+r"].includes(i)){this.currentInputProcessor=this.inputProcessorObj.rotate,this.currentInputProcessor.onKeyDown(t,e,i,s);return}if("z"===i){this.currentInputProcessor=this.inputProcessorObj.zoom,this.currentInputProcessor.onKeyDown(t,e,i,s);return}}}},onUp:(t,e,i)=>{"alt"===t&&e.preventDefault(),this.currentInputProcessor&&this.currentInputProcessor.onKeyUp(t,e,i)}}),this.updateChangeListener(),this.currentMode=0,this.globalMode=0,this.renderTime=0,this.lastDrawEvent=null,this.linetoolProcessor=new e5({onDraw:e=>{let i=()=>{let t=this.getRenderedTransform(),e=tI.Matrix.getIdentity();return e=tI.Matrix.multiplyMatrices(e,tI.Matrix.createScaleMatrix(1/t.scale)),e=tI.Matrix.multiplyMatrices(e,tI.Matrix.createRotationMatrix(-t.angle)),e=tI.Matrix.multiplyMatrices(e,tI.Matrix.createTranslationMatrix(-t.x,-t.y))};if("line"===e.type&&!this.lastDrawEvent){let t=i(),s=[e.x1,e.y1,0,1];s=tI.Matrix.multiplyMatrixAndPoint(t,s),this.lastDrawEvent={x:s[0],y:s[1],pressure:e.pressure1};return}if("x"in e||"x0"in e){let t=i();if("x"in e){let i=[e.x,e.y,0,1];i=tI.Matrix.multiplyMatrixAndPoint(t,i),e.x=i[0],e.y=i[1]}if("x0"in e){e.x0=this.lastDrawEvent.x,e.y0=this.lastDrawEvent.y,e.pressure0=this.lastDrawEvent.pressure;let i=[e.x1,e.y1,0,1];i=tI.Matrix.multiplyMatrixAndPoint(t,i),e.x1=i[0],e.y1=i[1],this.lastDrawEvent={x:e.x1,y:e.y1,pressure:e.pressure1}}}("down"===e.type||"move"===e.type)&&(this.lastDrawEvent={x:e.x,y:e.y,pressure:e.pressure}),t.onDraw(e)}}),this.pointer=null,this.isDrawing=!1,this.inputProcessorObj={draw:{onPointer:t=>{this.reqFrame(),this.updateCursor(0);let e=this.keyListener.getComboStr(),i={scale:this.highResTransformObj.scale};if(i.shiftIsPressed="shift"===e,i.pressure=t.pressure,i.isCoalesced=!!t.isCoalesced,"pointerdown"===t.type)this.isDrawing=!0,i.type="down";else if(t.button)i.type="move";else{if("pointerup"!==t.type)return;this.isDrawing=!1,i.type="up",this.linetoolProcessor.process(i),this.resetInputProcessor();return}i.x=t.relX,i.y=t.relY,this.linetoolProcessor.process(i)},onKeyDown:(t,e,i,s)=>{},onKeyUp:(t,e,i)=>{}},fill:{onPointer:e=>{if(this.reqFrame(),this.updateCursor(7),"pointerdown"===e.type){let i=this.workspaceToCanvasCoord({x:e.relX,y:e.relY});t.onFill(Math.floor(i.x),Math.floor(i.y))}else if("pointerup"===e.type){this.resetInputProcessor();return}},onKeyDown:(t,e,i,s)=>{},onKeyUp:(t,e,i)=>{}},gradient:{onPointer:e=>{this.reqFrame(),this.updateCursor(8);let i=this.workspaceToCanvasCoord({x:e.relX,y:e.relY});"pointerdown"===e.type?(this.isDrawing=!0,t.onGradient("down",i.x,i.y,this.renderedTransformObj.angle)):"pointermove"===e.type?t.onGradient("move",i.x,i.y,this.renderedTransformObj.angle):"pointerup"===e.type&&(this.isDrawing=!1,t.onGradient("up",i.x,i.y,this.renderedTransformObj.angle),this.resetInputProcessor())},onKeyDown:(t,e,i,s)=>{},onKeyUp:(t,e,i)=>{}},text:{onPointer:e=>{if(this.reqFrame(),this.updateCursor(9),"pointerdown"===e.type){let i=this.workspaceToCanvasCoord({x:e.relX,y:e.relY});t.onText(Math.floor(i.x),Math.floor(i.y),this.renderedTransformObj.angle)}else if("pointerup"===e.type){this.resetInputProcessor();return}},onKeyDown:(t,e,i,s)=>{},onKeyUp:(t,e,i)=>{}},shape:{onPointer:e=>{this.reqFrame(),this.updateCursor(10);let i=this.workspaceToCanvasCoord({x:e.relX,y:e.relY});"pointerdown"===e.type?(this.isDrawing=!0,t.onShape("down",i.x,i.y,this.renderedTransformObj.angle)):"pointermove"===e.type?t.onShape("move",i.x,i.y,this.renderedTransformObj.angle):"pointerup"===e.type&&(this.isDrawing=!1,t.onShape("up",i.x,i.y,this.renderedTransformObj.angle),this.resetInputProcessor())},onKeyDown:(t,e,i,s)=>{},onKeyUp:(t,e,i)=>{}},hand:{onPointer:t=>{this.updateCursor(1),["left","middle"].includes(t.button||"")?(this.updateCursor(2),this.targetTransformObj.x+=t.dX,this.targetTransformObj.y+=t.dY,this.highResTransformObj=tI.copyObj(this.targetTransformObj),this.doAnimateTranslate=!1,this.transformIsDirty=!0,this.reqFrame(!0)):"pointerup"===t.type&&this.resetInputProcessor()},onKeyDown:(t,e,i,s)=>{},onKeyUp:(t,e,i)=>{}},spaceHand:{onPointer:t=>{this.updateCursor(1),["left","middle"].includes(t.button||"")&&(this.updateCursor(2),this.targetTransformObj.x+=t.dX,this.targetTransformObj.y+=t.dY,this.highResTransformObj=tI.copyObj(this.targetTransformObj),this.doAnimateTranslate=!1,this.transformIsDirty=!0,this.reqFrame(!0))},onKeyDown:(t,e,i,s)=>{"space"!==i?this.resetInputProcessor():this.updateCursor(1)},onKeyUp:(t,e,i)=>{this.resetInputProcessor()}},zoom:{onPointer:t=>{if(this.updateCursor(4),"left"===t.button&&!t.isCoalesced&&0!=t.dX){let e=t.pageX-t.relX,i=t.pageY-t.relY;this.internalZoomByStep(t.dX/175,t.downPageX-e,t.downPageY-i),this.highResTransformObj=tI.copyObj(this.targetTransformObj),this.lastRenderedState=-1,this.reqFrame(),this.onViewChange({changed:["scale"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale})}},onKeyDown:(t,e,i,s)=>{"z"!==i?this.resetInputProcessor():this.updateCursor(4)},onKeyUp:(t,e,i)=>{this.resetInputProcessor()}},picker:{onPointer:e=>{if(this.updateCursor(3),["left","right"].includes(e.button||"")&&!e.isCoalesced||"pointerup"===e.type){let i=this.workspaceToCanvasCoord({x:e.relX,y:e.relY}),s=this.klCanvas.getColorAt(i.x,i.y);t.onPick(s,"pointerup"===e.type),this.svgOverlay.updateColorPreview({x:e.relX,y:e.relY,color:s,isVisible:"pointerup"!==e.type}),"pointerup"===e.type&&this.resetInputProcessor()}},onKeyDown:(t,e,i,s)=>{},onKeyUp:(t,e,i)=>{}},altPicker:{onPointer:e=>{if(this.updateCursor(3),["left","right"].includes(e.button||"")&&!e.isCoalesced||"pointerup"===e.type){let i=this.workspaceToCanvasCoord({x:e.relX,y:e.relY}),s=this.klCanvas.getColorAt(i.x,i.y);t.onPick(s,"pointerup"===e.type),this.svgOverlay.updateColorPreview({x:e.relX,y:e.relY,color:s,isVisible:"pointerup"!==e.type})}},onKeyDown:(t,e,i,s)=>{"alt"!==i?this.resetInputProcessor():this.updateCursor(3)},onKeyUp:(t,e,i)=>{this.resetInputProcessor()}},rotate:{onPointer:t=>{if(this.updateCursor("left"===t.button?6:5),"pointerdown"===t.type&&"left"===t.button)this.oldTransformObj=tI.copyObj(this.targetTransformObj);else if("left"===t.button&&!t.isCoalesced&&this.oldTransformObj){let e=t.pageX-t.relX,i=t.pageY-t.relY,s={x:this.renderWidth/2,y:this.renderHeight/2},r=tI.Vec2.angle(s,{x:t.downPageX-e,y:t.downPageY-i}),a=tI.Vec2.angle(s,{x:t.pageX-e,y:t.pageY-i})-r;this.targetTransformObj=tI.copyObj(this.oldTransformObj),this.targetTransformObj.angle+=a,this.keyListener.isPressed("shift")&&(this.targetTransformObj.angle=Math.round(this.targetTransformObj.angle/Math.PI*8)*Math.PI/8,a=this.targetTransformObj.angle-this.oldTransformObj.angle),this.targetTransformObj.angle=this.minimizeAngleRad(this.targetTransformObj.angle);let n=tI.Matrix.getIdentity();n=tI.Matrix.multiplyMatrices(n,tI.Matrix.createTranslationMatrix(s.x,s.y)),n=tI.Matrix.multiplyMatrices(n,tI.Matrix.createRotationMatrix(a)),n=tI.Matrix.multiplyMatrices(n,tI.Matrix.createTranslationMatrix(-s.x,-s.y));let o=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];o=tI.Matrix.multiplyMatrixAndPoint(n,o),this.targetTransformObj.x=o[0],this.targetTransformObj.y=o[1],this.highResTransformObj=tI.copyObj(this.targetTransformObj),this.transformIsDirty=!0,this.lastRenderedState=-1,this.reqFrame(),this.onViewChange({changed:["angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle})}},onKeyDown:(t,e,i,s)=>{["r","r+shift","shift+r","r+left","r+right","r+left+right","r+right+left","r+up"].includes(i)?this.updateCursor(5):this.resetInputProcessor()},onKeyUp:(t,e,i)=>{["r","r+shift","shift+r","r+left","r+right","r+left+right","r+right+left","r+up"].includes(this.keyListener.getComboStr())?this.updateCursor(5):this.resetInputProcessor()}}},this.currentInputProcessor=null,this.angleIsExtraSticky=!1,this.pinchZoomer=new tI.PinchZoomer({onPinch:t=>{if("move"===t.type){this.oldTransformObj||(this.oldTransformObj=tI.copyObj(this.targetTransformObj),this.angleIsExtraSticky=this.targetTransformObj.angle%(Math.PI/2)==0),this.targetTransformObj=tI.copyObj(this.oldTransformObj),t.scale=Math.max(e4,Math.min(128,this.targetTransformObj.scale*t.scale))/this.targetTransformObj.scale,this.targetTransformObj.scale*=t.scale,this.targetTransformObj.angle+=t.angleRad,this.targetTransformObj.angle=this.minimizeAngleRad(this.snapAngleRad(this.targetTransformObj.angle,90,this.angleIsExtraSticky?12:4)),this.targetTransformObj.angle%(Math.PI/2)!=0&&(this.angleIsExtraSticky=!1),t.angleRad=this.targetTransformObj.angle-this.oldTransformObj.angle;{let e=tI.Matrix.getIdentity();e=tI.Matrix.multiplyMatrices(e,tI.Matrix.createTranslationMatrix(t.relX,t.relY)),e=tI.Matrix.multiplyMatrices(e,tI.Matrix.createScaleMatrix(t.scale)),e=tI.Matrix.multiplyMatrices(e,tI.Matrix.createRotationMatrix(t.angleRad)),e=tI.Matrix.multiplyMatrices(e,tI.Matrix.createTranslationMatrix(-t.relX,-t.relY)),e=tI.Matrix.multiplyMatrices(e,tI.Matrix.createTranslationMatrix(t.relX-t.downRelX,t.relY-t.downRelY));let i=[this.targetTransformObj.x,this.targetTransformObj.y,0,1];i=tI.Matrix.multiplyMatrixAndPoint(e,i),this.targetTransformObj.x=i[0],this.targetTransformObj.y=i[1]}this.highResTransformObj=tI.copyObj(this.targetTransformObj),this.onViewChange({changed:["scale","angle"],scale:this.targetTransformObj.scale,angle:this.targetTransformObj.angle}),this.reqFrame(),this.transformIsDirty=!0,this.lastRenderedState=-1}else"end"===t.type&&(this.oldTransformObj=null)}});let e=t=>{this.fitView(!0)?(this.lastRenderedState=-1,this.reqFrame()):(this.internalZoomByStep(2,t.relX,t.relY)&&this.onViewChange({changed:["scale"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale}),this.lastRenderedState=-1)};this.mainDoubleTapper=new tI.DoubleTapper({onDoubleTap:e}),this.middleDoubleTapper=new tI.DoubleTapper({onDoubleTap:e}),this.middleDoubleTapper.setAllowedButtonArr(["middle"]),this.twoFingerTap=new tI.NFingerTapper({fingers:2,onTap:()=>{t.onUndo()}}),this.threeFingerTap=new tI.NFingerTapper({fingers:3,onTap:()=>{t.onRedo()}}),this.pointerEventChain=new tI.EventChain({chainArr:[this.twoFingerTap,this.threeFingerTap,this.mainDoubleTapper,this.middleDoubleTapper,this.pinchZoomer,new tI.OnePointerLimiter,new tI.CoalescedExploder]}),this.pointerEventChain.setChainOut(t=>{if(this.cursorPos.x=t.relX,this.cursorPos.y=t.relY,"pointerup"===t.type&&"touch"===t.pointerType?(this.pointer=null,this.lastRenderedState=-1,this.reqFrame()):(this.pointer||(this.pointer={x:0,y:0}),this.pointer.x=t.relX,this.pointer.y=t.relY),this.currentInputProcessor)this.currentInputProcessor.onPointer(t);else{let e=this.keyListener.getComboStr();0===this.globalMode?["","shift","ctrl"].includes(e)&&"pointerdown"===t.type&&"left"===t.button?(this.currentInputProcessor=this.inputProcessorObj.draw,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"right"===t.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"middle"===t.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):(this.updateCursor(0),this.reqFrame()):1===this.globalMode?"pointerdown"===t.type&&["left","middle"].includes(t.button||"")?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"right"===t.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):this.updateCursor(1):3===this.globalMode?"pointerdown"===t.type&&["left","right"].includes(t.button||"")?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"middle"===t.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):this.updateCursor(3):7===this.globalMode?"pointerdown"===t.type&&"left"===t.button?(this.currentInputProcessor=this.inputProcessorObj.fill,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"right"===t.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"middle"===t.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):(this.updateCursor(7),this.reqFrame()):8===this.globalMode?["","shift","ctrl"].includes(e)&&"pointerdown"===t.type&&"left"===t.button?(this.currentInputProcessor=this.inputProcessorObj.gradient,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"right"===t.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"middle"===t.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):(this.updateCursor(8),this.reqFrame()):9===this.globalMode?"pointerdown"===t.type&&"left"===t.button?(this.currentInputProcessor=this.inputProcessorObj.text,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"right"===t.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"middle"===t.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):(this.updateCursor(9),this.reqFrame()):10===this.globalMode&&(["","shift","ctrl"].includes(e)&&"pointerdown"===t.type&&"left"===t.button?(this.currentInputProcessor=this.inputProcessorObj.shape,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"right"===t.button?(this.currentInputProcessor=this.inputProcessorObj.picker,this.currentInputProcessor.onPointer(t)):[""].includes(e)&&"pointerdown"===t.type&&"middle"===t.button?(this.currentInputProcessor=this.inputProcessorObj.hand,this.currentInputProcessor.onPointer(t)):(this.updateCursor(10),this.reqFrame()))}}),this.rootEl.addEventListener("wheel",t=>{t.preventDefault()}),setTimeout(()=>{this.pointerListener=new tI.PointerListener({target:this.rootEl,fixScribble:!0,onPointer:t=>{if("pointerdown"===t.type&&"middle"===t.button)try{t.eventPreventDefault()}catch(t){}"pointerdown"===t.type&&tI.unfocusAnyInput(),this.pointerEventChain.chainIn(t)},onWheel:t=>{this.isDrawing||(this.reqFrame(),this.internalZoomByStep(-t.deltaY/(this.keyListener.isPressed("shift")?8:2),t.relX,t.relY)&&this.onViewChange({changed:["scale"],angle:this.targetTransformObj.angle,scale:this.targetTransformObj.scale}),this.lastRenderedState=-1)},onEnterLeave:t=>{t||this.isDrawing||(this.pointer=null,this.lastRenderedState=-1)},maxPointers:4})},1),this.brushRadius=1,this.animationFrameRequested=!1,this.lastRenderedState=-2,this.lastRenderTime=performance.now(),window.requestAnimationFrame(()=>this.updateLoop()),this.resetOrFitView()}},KlCanvasPreview:e9,filterLibStatus:sT,filterLib:sM,UndoRedoCatchup:class{shouldIgnoreTest(){return!!this.doIgnore||(this.doIgnore=!0,setTimeout(()=>{this.doIgnore=!1},0),!1)}undo(){if(this.shouldIgnoreTest()||!D.canUndo())return!1;let t=D.undo(),e=this.getKlCanvas();D.pause(!0);let i=this.getInitState(),s={w:e.getWidth(),h:e.getHeight()};e.copy(i.canvas);let r=i.focus;this.setCurrentLayerCtx(E(e.getLayerContext(r)));let a={};return Object.entries(rH.brushes).forEach(([t,e])=>{a[t]=new e,a[t].setContext(this.getCurrentLayerCtx())}),a.SketchyBrush.setSeed(i.brushes.SketchyBrush.getSeed()),t.forEach(t=>{r=rB(t,r,e,a,t=>this.setCurrentLayerCtx(t),()=>E(this.getCurrentLayerCtx()))}),(s.w!==e.getWidth()||s.h!==e.getHeight())&&(this.klCanvasWorkspace.resetOrFitView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())),this.layerManager.update(r),this.layerPreview.setLayer(E(e.getLayer(r))),this.brushUiMap.sketchyBrush.setSeed(a.SketchyBrush.getSeed()),this.getCurrentBrush().setContext(this.getCurrentLayerCtx()),this.klCanvasWorkspace.setLastDrawEvent(),D.pause(!1),!0}redo(){if(this.shouldIgnoreTest()||!D.canRedo())return!1;let t=D.redo();if(!t)return setTimeout(()=>{throw Error("redo failed. redo entry undefined")}),!1;let e=this.getKlCanvas();D.pause(!0);let i={w:e.getWidth(),h:e.getHeight()},s={};Object.entries(rH.brushes).forEach(([t,e])=>{s[t]=new e,s[t].setContext(this.getCurrentLayerCtx())}),s.SketchyBrush.setSeed(this.brushUiMap.sketchyBrush.getSeed()),rB(t,0,e,s,t=>this.setCurrentLayerCtx(t),()=>E(this.getCurrentLayerCtx())),(i.w!==e.getWidth()||i.h!==e.getHeight())&&(this.klCanvasWorkspace.resetOrFitView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg()));let r=E(e.getLayerIndex(this.getCurrentLayerCtx().canvas));return this.layerManager.update(r),this.layerPreview.setLayer(e.getLayer(r)),this.brushUiMap.sketchyBrush.setSeed(s.SketchyBrush.getSeed()),this.getCurrentBrush().setContext(this.getCurrentLayerCtx()),this.klCanvasWorkspace.setLastDrawEvent(),D.pause(!1),!0}catchup(t){if(!t||!t.bufferUpdate)return;let e=this.getInitState(),i=e.canvas.getLayerContext(e.focus);e.focus=rB(t.bufferUpdate,e.focus,e.canvas,e.brushes,t=>{i=t},()=>E(i))}constructor(t,e,i,s,r,a,n,o,l,h){this.brushUiMap=t,this.layerPreview=e,this.layerManager=i,this.handUi=s,this.klCanvasWorkspace=r,this.getInitState=a,this.getKlCanvas=n,this.getCurrentLayerCtx=o,this.setCurrentLayerCtx=l,this.getCurrentBrush=h,this.doIgnore=!1}},renderText:eF,floodFillBits:eH,ShapeTool:class{onDown(t,e,i){this.downX=t,this.downY=e,this.downAngleRad=i}onMove(t,e){this.onShape(!1,this.downX,this.downY,t,e,this.downAngleRad)}onUp(t,e){this.onShape(!0,this.downX,this.downY,t,e,this.downAngleRad)}constructor(t){this.downX=0,this.downY=0,this.downAngleRad=0,this.onShape=t.onShape}},drawShape:ej,GradientTool:class{onDown(t,e,i){this.downX=t,this.downY=e,this.downAngleRad=i}onMove(t,e){this.onGradient(!1,this.downX,this.downY,t,e,this.downAngleRad)}onUp(t,e){this.onGradient(!0,this.downX,this.downY,t,e,this.downAngleRad)}constructor(t){this.downX=0,this.downY=0,this.downAngleRad=0,this.onGradient=t.onGradient}},drawGradient:eU,PSD:i9,setDbName:sn,indexedDb:si,ProjectStore:class{async lowLevelStore(t){await new Promise((e,i)=>{sh(t,e,i)})}async lowLevelRead(){return await rt(sl)}async lowLevelClear(){await rt(sc)}emit(t,e){this.listeners.forEach(i=>{i.onUpdate(t,e)})}updateTimestamp(){tw.setItem("indexedDbUpdatedAt",""+new Date().getTime())}async read(){let t,e;try{t=await this.lowLevelRead()}catch(t){throw this.accessHasFailed=!0,Error("db-error: "+t)}if(t){try{e=await s7.readStorageProject(t)}catch(t){throw Error("format-error: "+t)}return e}}async store(t){try{let e=s7.createStorageProject(t);await this.lowLevelStore(e)}catch(t){throw this.accessHasFailed=!0,Error("db-error: "+t)}{let t;let e=await this.lowLevelRead();try{t=await s7.readStorageProject(e)}catch(t){throw await this.lowLevelClear(),this.updateTimestamp(),setTimeout(()=>this.emit(),0),Error("format-error: "+t)}this.updateTimestamp(),setTimeout(()=>this.emit(t.timestamp,t.thumbnail),0)}}async clear(){await this.lowLevelClear(),this.updateTimestamp(),setTimeout(()=>this.emit(),0)}subscribe(t){this.listeners.includes(t)||this.listeners.push(t)}unsubscribe(t){for(let e=0;e<this.listeners.length;e++)if(t===this.listeners[e]){this.listeners.splice(e,1);return}}isBroken(){return this.accessHasFailed}constructor(){this.listeners=[],this.accessHasFailed=!1,window.addEventListener("storage",t=>{if("indexedDbUpdatedAt"===t.key&&0!==this.listeners.length)try{(async()=>{let t=await this.read();t?this.emit(t.timestamp,t.thumbnail):this.emit()})()}catch(t){t instanceof Error&&0===t.message.indexOf("db-error")&&(this.accessHasFailed=!0)}})}},loadAgPsd:rR,SaveToComputer:class{saveImage(t,e,i){let s=t.toDataURL(i).match(/data:([^;]*)(;base64)?,([0-9A-Za-z+/]+)/);if(!s)throw Error("saveImage: empty parts");let r=atob(s[3]),a=new Uint8Array(new ArrayBuffer(r.length));for(let t=0;t<a.length;t++)a[t]=r.charCodeAt(t);rD(new Blob([a],{type:s[1]}),e)}save(t){if(this.saveReminder.reset(),t||(t=this.getExportType()),"png"===t){let t=tI.getDate()+e3.filenameBase+".png",e=this.getKlCanvas().getCompleteCanvas(1);try{this.saveImage(e,t,"image/png")}catch(t){throw alert("could not save"),Error("failed png export")}}else if("layers"===t){let t=tI.getDate()+e3.filenameBase,e=this.getKlCanvas().getLayersFast();for(let i=0;i<e.length;i++){let s=e[i],r=[t,"_",(""+(i+1)).padStart(2,"0"),"_",s.name,".","png"];this.saveImage(s.canvas,r.join(""),"image/png")}}else if("psd"===t){let t=this.getKlCanvas().getLayersFast(),e={width:this.getKlCanvas().getWidth(),height:this.getKlCanvas().getHeight(),children:[],canvas:this.getKlCanvas().getCompleteCanvas(1)};for(let i=0;i<t.length;i++){let s=t[i];e.children.push({name:s.name,hidden:!s.isVisible,opacity:s.opacity,canvas:s.canvas,blendMode:rH.PSD.blendKlToPsd(s.mixModeStr),left:0,top:0})}rH.loadAgPsd().then(t=>{rD(new Blob([t.writePsdBuffer(e)],{type:"application/octet-stream"}),tI.getDate()+e3.filenameBase+".psd")}).catch(()=>{alert("Error: failed to load PSD library")})}}constructor(t,e,i){this.saveReminder=t,this.getExportType=e,this.getKlCanvas=i}},calcSliderFalloffFactor:tq,Checkbox:tF,input:tU,Select:tN,ImageToggle:t_,ImageRadioList:tY,RadioList:class{getValue(){for(let t=0;t<this.inputs.length;t++)if(this.inputs[t].checked)return this.inputs[t].value;return null}getElement(){return this.el}constructor({name:t,init:e,items:i,ignoreFocus:s}){this.inputs=[],this.el=tI.el({className:"kl-radio"}),i.forEach(i=>{let r=tI.el({tagName:"label"}),a=tI.el({tagName:"input",parent:r,custom:{name:t,value:i.value,type:"radio"}});s&&a.setAttribute("data-ignore-focus","true"),e===i.value&&(a.checked=!0),r.append(i.label),this.el.append(r),this.inputs.push(a)})}},createPenPressureToggle:tK,KlSlider:tQ,HexColorDialog:t8,KlColorSlider:class{updatePrimaryHSV(t){0===t.s?this.primaryColorHSV=new tI.HSV(this.primaryColorHSV.h,t.s,t.v):this.primaryColorHSV=new tI.HSV(t.h,t.s,t.v)}updateSVCanvas(){let t=tI.ColorConverter.toRGB(new tI.HSV(this.primaryColorHSV.h,100,100));tI.setAttributes(this.hueStop,{"stop-color":"#"+tI.ColorConverter.toHexString(t)})}updateSVPointer(){let t=this.primaryColorHSV.s/100*this.width-7,e=(1-this.primaryColorHSV.v/100)*this.svHeight-6;tI.css(this.pointerSV,{left:t+"px",top:e+"px"})}setColPreview(){this.divPreview.style.backgroundColor="rgb("+this.primaryColorRGB.r+","+this.primaryColorRGB.g+","+this.primaryColorRGB.b+")",tI.testIsWhiteBestContrast(this.primaryColorRGB)?(tI.css(this.pickerButton,{filter:"invert(1)"}),tI.css(this.hexButton,{filter:"invert(1)"})):(tI.css(this.pickerButton,{filter:""}),tI.css(this.hexButton,{filter:""}))}updateSecondaryColor(){this.secondaryColorBtn.style.backgroundColor=tI.ColorConverter.toRgbStr(this.secondaryColorRGB)}setColor(t){this.primaryColorRGB={r:parseInt(""+t.r),g:parseInt(""+t.g),b:parseInt(""+t.b)},this.updatePrimaryHSV(tI.ColorConverter.toHSV(t)),this.controlH.style.left=parseInt(""+(this.primaryColorHSV.h/359*this.width-1))+"px",this.updateSVCanvas(),this.updateSVPointer(),this.setColPreview()}getColor(){return new tI.RGB(this.primaryColorRGB.r,this.primaryColorRGB.g,this.primaryColorRGB.b)}getSecondaryRGB(){return new tI.RGB(this.secondaryColorRGB.r,this.secondaryColorRGB.g,this.secondaryColorRGB.b)}setPickCallback(t){this.pickCallback=t}pickingDone(){this.isPicking&&(this.isPicking=!1,this.pickerButton.classList.remove("color-picker-preview-button-active"))}enable(t){t?(this.rootEl.style.pointerEvents="",this.rootEl.style.opacity="1",this.outputDiv.style.pointerEvents="",this.outputDiv.style.opacity="1"):(this.rootEl.style.pointerEvents="none",this.rootEl.style.opacity="0.5",this.outputDiv.style.pointerEvents="none",this.outputDiv.style.opacity="0.5")}setHeight(t){(t=parseInt(""+(t-2*this.height-3),10))!==this.svHeight&&(this.svHeight=t,tI.css(this.svSvg,{width:this.width+"px",height:this.svHeight+"px"}),this.SVContainer.style.height=this.svHeight+"px",this.updateSVPointer())}swapColors(){let t=this.secondaryColorHSV;this.secondaryColorHSV=this.primaryColorHSV,this.updatePrimaryHSV(t),t=this.secondaryColorRGB,this.secondaryColorRGB=this.primaryColorRGB,this.primaryColorRGB=t,this.controlH.style.left=parseInt(""+(this.primaryColorHSV.h/359*this.width-1))+"px",this.updateSVCanvas(),this.updateSVPointer(),this.setColPreview(),this.updateSecondaryColor(),this.emitColor(new tI.RGB(this.primaryColorRGB.r,this.primaryColorRGB.g,this.primaryColorRGB.b))}getElement(){return this.rootEl}getOutputElement(){return this.outputDiv}constructor(t){this.rootEl=tI.el({className:"kl-color-picker",css:{position:"relative"}}),this.outputDiv=tI.el({css:{display:"flex",alignItems:"center"}}),this.width=t.width,this.svHeight=t.svHeight,this.height=t.height,this.emitColor=t.onPick,this.primaryColorRGB={r:parseInt(""+t.startValue.r),g:parseInt(""+t.startValue.g),b:parseInt(""+t.startValue.b)},this.primaryColorHSV=tI.ColorConverter.toHSV(t.startValue),this.secondaryColorRGB={r:ei,g:ei,b:ei},this.secondaryColorHSV=tI.ColorConverter._RGBtoHSV(this.secondaryColorRGB);let e=tI.el();this.svSvg=new DOMParser().parseFromString('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><defs><linearGradient id="value" gradientTransform="rotate(90)"><stop offset="0" stop-color="#fff"/><stop offset="100%" stop-color="#000"/></linearGradient><linearGradient id="hue" gradientTransform="rotate(0)"><stop offset="0" stop-color="#fff"/><stop id="hue-stop" offset="100%" stop-color="#f00"/></linearGradient></defs><rect x="0" y="0" width="100" height="100" fill="url(\'#hue\')"/><rect x="0" y="0" width="100" height="100" fill="url(\'#value\')" style="mix-blend-mode: multiply"/></svg>',"image/svg+xml").documentElement;{let t=this.svSvg.querySelector("#hue-stop");if(!t)throw Error("#hue-stop not found in svSvg");this.hueStop=t}tI.setAttributes(this.hueStop,{"stop-color":"#f0f"}),tI.css(this.svSvg,{width:this.width+"px",height:this.svHeight+"px"}),e.append(this.svSvg);let i=tI.el({className:"kl-color-picker__h",css:{overflow:"hidden",position:"relative",width:this.width+"px",height:this.height+"px",cursor:"ew-resize",marginTop:"1px",marginBottom:"1px"}});this.divPreview=tI.el({className:"kl-color-picker__preview",css:{display:"flex",justifyContent:"space-between",width:2.5*this.height+"px",height:this.height+"px"}}),this.controlH=tI.el();let s=t=>{let e=new Image;tI.css(e,{position:"absolute",left:"0",top:"0",display:"none",pointerEvents:"none"});let i=tI.canvas(this.width,this.height),s=tI.ctx(i),r=s.createLinearGradient(0,0,this.width,0);for(let t=0;t<1;t+=.01){let e=tI.ColorConverter.toRGB(new tI.HSV(360*t,100,100)),i=parseInt(""+e.r).toString(16),s=parseInt(""+e.g).toString(16),a=parseInt(""+e.b).toString(16);1===i.length&&(i="0"+i),1===s.length&&(s="0"+s),1===a.length&&(a="0"+a),r.addColorStop(t,"#"+i+s+a)}s.fillStyle=r,s.fillRect(0,0,this.width,this.height),t.append(e),e.alt="hue",e.src=i.toDataURL("image/png"),e.style.display="block"};this.updateSVCanvas(),this.rootEl.style.width=this.width+"px",this.rootEl.oncontextmenu=()=>!1,this.SVContainer=tI.el({className:"kl-color-picker__sv",css:{width:this.width+"px",height:this.svHeight+"px",overflow:"hidden",display:"block",position:"relative",cursor:"crosshair"}}),this.pointerSV=tI.el({css:{width:"12px",height:"12px",borderRadius:"6px",position:"absolute",pointerEvents:"none",boxShadow:"0px 0px 0 1px #000, inset 0px 0px 0 1px #fff"}}),this.SVContainer.append(e,this.pointerSV),this.updateSVPointer(),this.rootEl.append(this.SVContainer,i),this.outputDiv.append(this.divPreview),tI.css(this.controlH,{width:"1px",height:this.height+"px",background:"#000",borderLeft:"1px solid #fff",position:"absolute",top:"0",left:parseInt(""+(this.primaryColorHSV.h/360*this.width-1))+"px"});let r={h:0,s:0,v:0};this.pickerButton=tI.el({title:tB("eyedropper")+" [Alt]",className:"color-picker-preview-button",css:{width:"30px",height:"30px",backgroundImage:"url("+m(t7)+")",backgroundRepeat:"no-repeat",backgroundSize:"70%",backgroundPosition:"center"},onClick:()=>{this.isPicking?(this.pickCallback&&this.pickCallback(!1),this.pickingDone()):(this.pickerButton.classList.remove("color-picker-preview-button-hover"),this.pickerButton.classList.add("color-picker-preview-button-active"),this.isPicking=!0,this.pickCallback&&this.pickCallback(!0))}}),this.isPicking=!1,new tI.PointerListener({target:this.pickerButton,onEnterLeave:t=>{this.isPicking||this.pickerButton.classList.toggle("color-picker-preview-button-hover",t)}}),this.divPreview.append(this.pickerButton),this.hexButton=tI.el({content:"#",className:"color-picker-preview-button",title:tB("manual-color-input"),css:{height:"100%",width:this.height+"px",lineHeight:this.height+"px",fontSize:.65*this.height+"px"},onClick:()=>{new t8({color:new tI.RGB(this.primaryColorRGB.r,this.primaryColorRGB.g,this.primaryColorRGB.b),onClose:t=>{t&&(this.setColor(t),this.emitColor(new tI.RGB(this.primaryColorRGB.r,this.primaryColorRGB.g,this.primaryColorRGB.b)))}})}}),new tI.PointerListener({target:this.hexButton,onEnterLeave:t=>{this.hexButton.classList.toggle("color-picker-preview-button-hover",t)}}),this.divPreview.append(this.hexButton),this.setColPreview(),setTimeout(()=>{s(i),i.append(this.controlH),new tI.PointerListener({target:e,fixScribble:!0,onPointer:t=>{if("pointerdown"===t.type&&(tI.unfocusAnyInput(),this.SVContainer.classList.toggle("kl-color-picker--active",!0),"left"===t.button?(r.s=t.relX/this.width*100,r.v=100-t.relY/this.svHeight*100,this.primaryColorHSV=new tI.HSV(this.primaryColorHSV.h,r.s,r.v),this.primaryColorRGB=tI.ColorConverter.toRGB(this.primaryColorHSV),this.updateSVPointer(),this.setColPreview(),this.emitColor(tI.ColorConverter.toRGB(this.primaryColorHSV))):(r.s=this.primaryColorHSV.s,r.v=this.primaryColorHSV.v)),"pointermove"===t.type&&["left","right"].includes(t.button||"")){let e=1;"right"===t.button&&(e=.5),r.s+=t.dX/this.width*100*e,r.v-=t.dY/this.svHeight*100*e,this.primaryColorHSV=new tI.HSV(this.primaryColorHSV.h,r.s,r.v),this.primaryColorRGB=tI.ColorConverter.toRGB(this.primaryColorHSV),this.updateSVPointer(),this.setColPreview(),this.emitColor(tI.ColorConverter.toRGB(this.primaryColorHSV))}"pointerup"===t.type&&this.SVContainer.classList.toggle("kl-color-picker--active",!1)}}),new tI.PointerListener({target:i,fixScribble:!0,onPointer:t=>{if("pointerdown"===t.type&&(tI.unfocusAnyInput(),i.classList.toggle("kl-color-picker--active",!0),"left"===t.button?(r.h=t.relX/this.width*359.99,this.primaryColorHSV=new tI.HSV(r.h,this.primaryColorHSV.s,this.primaryColorHSV.v),this.primaryColorRGB=tI.ColorConverter.toRGB(this.primaryColorHSV),this.controlH.style.left=Math.round(this.primaryColorHSV.h/359.99*this.width)-1+"px",this.updateSVCanvas(),this.setColPreview(),this.emitColor(tI.ColorConverter.toRGB(this.primaryColorHSV))):r.h=this.primaryColorHSV.h),"pointermove"===t.type&&["left","right"].includes(t.button||"")){let e=tq(Math.abs(t.pageY-t.downPageY),"right"===t.button);r.h+=t.dX/this.width*359.99*e,"right"===t.button&&(r.h=r.h%359.99,r.h<0&&(r.h+=359.99)),r.h=Math.min(359.99,r.h),this.primaryColorHSV=new tI.HSV(r.h,this.primaryColorHSV.s,this.primaryColorHSV.v),this.primaryColorRGB=tI.ColorConverter.toRGB(this.primaryColorHSV),this.controlH.style.left=Math.round(this.primaryColorHSV.h/359.99*this.width)-1+"px",this.updateSVCanvas(),this.setColPreview(),this.emitColor(tI.ColorConverter.toRGB(this.primaryColorHSV))}"pointerup"===t.type&&i.classList.toggle("kl-color-picker--active",!1)}})},1),this.secondaryColorBtn=tI.el({parent:this.outputDiv,title:tB("secondary-color")+" [X]",className:"kl-color-picker__secondary",css:{cursor:"pointer",marginLeft:"5px",width:"22px",height:"22px"},onClick:t=>{t.preventDefault(),this.swapColors()}}),this.updateSecondaryColor()}},KlColorSliderSmall:es,PointSlider:er,ColorOptions:ea,Options:en,BoxToggle:tG,StatusOverlay:class{updateUiState(){"left"===this.uiState?this.el.style.left="271px":this.el.style.removeProperty("left")}setWide(t){this.isWide=t,this.el&&(this.isWide?(this.el.style.width="100%",this.el.style.left=""):(this.el.style.removeProperty("width"),this.el.style.left="left"===this.uiState?"271px":""))}setUiState(t){this.uiState=t,this.updateUiState()}out(t,e){"string"==typeof t?(this.angleIm.style.display="none",this.innerInnerEl.innerHTML=t):"transform"===t.type?(this.angleIm.style.display="inline-block",this.angleIm.style.transform="rotate("+t.angleDeg+"deg)",t.angleDeg%90==0?this.angleIm.style.boxShadow="inset 0 0 0 1px rgba(255, 255, 255, 0.7)":this.angleIm.style.boxShadow="",this.innerInnerEl.innerHTML=Math.round(100*t.scale)+"%"):this.angleIm.style.display="none",e&&(this.innerEl.style.animation="",setTimeout(()=>this.innerEl.style.animation="topOverlayPulse 0.5s ease-out",20),clearTimeout(this.timeout3),this.timeout3=setTimeout(()=>this.innerEl.style.animation="",520)),clearTimeout(this.timeout),clearTimeout(this.timeout2),this.el.style.animationName=e?"consoleInFast":"consoleIn",this.el.style.opacity="1",this.timeout=setTimeout(()=>{this.el.style.opacity="0",this.el.style.animationName="consoleOut",this.timeout2=setTimeout(()=>{this.el.style.display="none"},450)},1200),this.el.style.display="flex"}constructor(){this.isWide=!1,this.uiState="right",this.el=tI.el({className:"top-overlay g-root",onClick:tI.handleClick}),this.updateUiState(),this.innerEl=tI.el({className:"top-overlay--inner"}),this.angleIm=new Image,this.angleIm.src=m(eo),tI.css(this.angleIm,{verticalAlign:"bottom",width:"20px",height:"20px",marginLeft:"5px",borderRadius:"10px"}),this.innerInnerEl=document.createElement("div"),this.innerInnerEl.style.display="inline-block",this.innerEl.append(this.innerInnerEl,this.angleIm),this.el.append(this.innerEl),document.body.append(this.el),this.el.style.display="none"}},CropCopy:eO,FreeTransform:ie,FreeTransformCanvas:is,Cropper:ir,LayerPreview:class{updateCheckerPatterns(){let t=tI.createCheckerCanvas(4,ee.isDark());this.animationCanvasCheckerPattern=E(this.animationCanvasCtx.createPattern(t,"repeat")),this.largeCanvasCheckerPattern=E(this.canvasCtx.createPattern(t,"repeat"))}animate(){0!==this.animationCount&&(this.animationCount--,this.canvasCtx.save(),this.canvasCtx.globalAlpha=Math.pow((this.animationLength-this.animationCount)/this.animationLength,2),this.canvasCtx.drawImage(this.animationCanvas,0,0),this.canvasCtx.restore(),this.animationCount>0&&requestAnimationFrame(()=>this.animate()))}drawLargeCanvas(){if(!this.largeCanvasIsVisible||!this.layerObj)return;let t=this.layerObj.context.canvas,e=tI.fitInto(t.width,t.height,this.largeCanvasSize,this.largeCanvasSize,1);this.largeCanvas.width=Math.round(e.width),this.largeCanvas.height=Math.round(e.height),this.largeCanvasCtx.save(),this.largeCanvas.width>t.width?this.largeCanvasCtx.imageSmoothingEnabled=!1:(this.largeCanvasCtx.imageSmoothingEnabled=!0,this.largeCanvasCtx.imageSmoothingQuality="high"),this.largeCanvasCtx.fillStyle=this.largeCanvasCheckerPattern,this.largeCanvasCtx.fillRect(0,0,this.largeCanvas.width,this.largeCanvas.height),this.largeCanvasCtx.drawImage(t,0,0,this.largeCanvas.width,this.largeCanvas.height),this.largeCanvasCtx.restore();let i=this.rootEl.getBoundingClientRect();tI.css(this.largeCanvasWrapper,{top:Math.max(10,i.top+this.height/2-this.largeCanvas.height/2)+"px"})}draw(t){if(!this.isVisible||!this.layerObj)return;let e=this.layerObj.isVisible;this.checkEl.parentElement.title=e?tB("layers-active-layer-visible"):tB("layers-active-layer-hidden"),this.checkEl.checked=e,this.checkEl.style.boxShadow=e?"":"0 0 0 1px red",this.nameLabelEl.textContent=this.layerObj.name,this.layerObj.isVisible?this.opacityEl.innerHTML=tB("opacity")+"<br>"+Math.round(100*this.layerObj.opacity)+"%":this.opacityEl.innerHTML=tB("opacity")+"<br><s>"+Math.round(100*this.layerObj.opacity)+"%</s>";let i=this.layerObj.context.canvas;if(i.width!==this.lastDrawnSize.width||i.height!==this.lastDrawnSize.height){let e=tI.fitInto(i.width,i.height,this.canvasSize,this.canvasSize,1);this.canvas.width=Math.round(e.width),this.canvas.height=Math.round(e.height),t=!0}this.animationCanvas.width=this.canvas.width,this.animationCanvas.height=this.canvas.height,this.animationCanvasCtx.save(),this.animationCanvasCtx.imageSmoothingEnabled=!1,this.animationCanvasCtx.fillStyle=this.animationCanvasCheckerPattern,this.animationCanvasCtx.fillRect(0,0,this.animationCanvas.width,this.animationCanvas.height),this.animationCanvasCtx.drawImage(i,0,0,this.animationCanvas.width,this.animationCanvas.height),this.animationCanvasCtx.restore(),t?(this.animationCount=0,this.canvasCtx.save(),this.canvasCtx.drawImage(this.animationCanvas,0,0),this.canvasCtx.restore()):(this.animationCount=this.animationLength,this.animate()),this.drawLargeCanvas(),this.lastDrawnState=D.getState(),this.lastDrawnSize.width=i.width,this.lastDrawnSize.height=i.height}getElement(){return this.rootEl}setIsVisible(t){if(this.isVisible===t)return;this.isVisible=t,this.contentWrapperEl.style.display=this.isVisible?"flex":"none",this.rootEl.style.marginBottom=this.isVisible?"":"10px";let e=D.getState();t&&this.lastDrawnState!==e&&this.draw(!0)}setLayer(t){this.layerObj=t,this.draw(!0)}setUiState(t){this.uiState=t,"left"===this.uiState?tI.css(this.largeCanvasWrapper,{left:"280px",right:""}):tI.css(this.largeCanvasWrapper,{left:"",right:"280px"})}constructor(t){let e;this.animationCanvasCheckerPattern={},this.largeCanvasCheckerPattern={},this.rootEl=tI.el({className:"kl-layer-preview"}),this.isVisible=!0,this.height=40,this.canvasSize=this.height-10,this.largeCanvasSize=300,this.lastDrawnState=-2,this.lastDrawnSize={width:0,height:0},this.animationCanvas=tI.canvas(),this.animationCanvasCtx=tI.ctx(this.animationCanvas),this.animationLength=30,this.animationCount=0,this.largeCanvasIsVisible=!1,this.uiState=t.uiState,this.contentWrapperEl=tI.el({css:{display:"flex",alignItems:"center",height:this.height+"px"}});let i=tI.el({css:{display:"flex",justifyContent:"flex-end",alignItems:"center",width:"23px",flexShrink:"0"}});this.checkEl=tI.el({parent:i,tagName:"input",css:{pointerEvents:"none"},custom:{type:"checkbox",disabled:"true"}});let s=tI.el({css:{minWidth:this.height+"px",height:this.height+"px",display:"flex",justifyContent:"center",alignItems:"center"}});this.canvas=tI.canvas(this.canvasSize,this.canvasSize),this.canvasCtx=tI.ctx(this.canvas),this.canvas.title=tB("layers-active-layer");let r=tI.el({css:{flexGrow:"1",paddingLeft:"10px",fontSize:"13px",overflow:"hidden",position:"relative"}});this.nameLabelEl=tI.el({content:"",css:{cssFloat:"left",whiteSpace:"nowrap"}});let a=tI.el({css:{position:"absolute",left:"10px",top:"0",width:"90px",height:"100%"}});t.onClick&&(a.addEventListener("click",()=>t.onClick()),this.canvas.addEventListener("click",()=>t.onClick()),i.addEventListener("click",()=>t.onClick())),this.opacityEl=tI.el({content:tB("opacity")+"<br>100%",css:{minWidth:"60px",fontSize:"12px",textAlign:"center"}}),this.largeCanvasWrapper=tI.el({onClick:tI.handleClick,css:{pointerEvents:"none",background:"#fff",position:"absolute",right:"280px",top:"10px",border:"1px solid #aaa",boxShadow:"1px 1px 3px rgba(0,0,0,0.3)",transition:"opacity 300ms ease-in-out",userSelect:"none",display:"block",webkitTouchCallout:"none"}}),this.largeCanvas=tI.canvas(this.largeCanvasSize,this.largeCanvasSize),this.largeCanvasWrapper.append(this.largeCanvas),this.largeCanvasCtx=tI.ctx(this.largeCanvas),tI.css(this.largeCanvas,{display:"block"}),s.append(this.canvas),r.append(this.nameLabelEl,a),this.contentWrapperEl.append(i,s,r,this.opacityEl),this.rootEl.append(this.contentWrapperEl),this.updateCheckerPatterns(),ee.addIsDarkListener(()=>{this.updateCheckerPatterns(),this.draw(!0)}),setInterval(()=>{this.layerObj&&D.getState()!==this.lastDrawnState&&(this.layerObj.opacity=this.layerObj.context.canvas.opacity,this.draw(!1))},2e3);let n=()=>{this.largeCanvasWrapper.remove()},o=i=>{this.largeCanvasIsVisible!==i&&(clearTimeout(e),this.largeCanvasIsVisible=i,i?e=setTimeout(()=>{this.drawLargeCanvas(),this.largeCanvasWrapper.style.opacity="0",t.klRootEl.append(this.largeCanvasWrapper),setTimeout(()=>{this.largeCanvasWrapper.style.opacity="1"},20)},250):(this.largeCanvasWrapper.style.opacity="0",e=setTimeout(n,320)))};new tI.PointerListener({target:this.canvas,onEnterLeave:t=>{o(t)}})}},KlImageDropper:class{constructor(t){this.rootEl=tI.el({content:"Drop to import",css:{paddingTop:"100px",position:"fixed",left:"0",top:"0",width:"100%",height:"100%",background:"rgba(50, 50, 50, 0.7)",color:"#fff",textShadow:"2px 2px #000",textAlign:"center",fontSize:"25px"}});let e=tI.el({css:{marginTop:"50px",display:"flex",justifyContent:"center"}}),i={width:"200px",padding:"50px",margin:"10px",borderRadius:"20px",border:"1px dashed #fff",background:"#00aefe",fontWeight:"bold"},s=tI.el({content:"As Layer",css:i}),r=tI.el({content:"As New Image",css:i});this.rootEl.append(e),e.append(s,r);let a=0,n=0,o=0,l=()=>{a=0,n=0,o=0,this.rootEl.remove()},h=t=>!!t.dataTransfer&&!t.dataTransfer.types.includes("text/plain"),c=()=>{let t="0 0 20px 4px #fff";n>0?(s.style.boxShadow=t,r.style.boxShadow=""):o>0?(s.style.boxShadow="",r.style.boxShadow=t):(s.style.boxShadow="",r.style.boxShadow="")};s.addEventListener("dragenter",()=>{n++,c()}),s.addEventListener("dragleave",()=>{n--,c()}),r.addEventListener("dragenter",()=>{o++,c()}),r.addEventListener("dragleave",()=>{o--,c()}),window.addEventListener("dragover",t=>{h(t)&&(t.stopPropagation(),t.preventDefault())},!1),window.addEventListener("dragenter",e=>{t.enabledTest()&&h(e)&&(0===a&&t.target.append(this.rootEl),a++)},!1),window.addEventListener("dragleave",t=>{h(t)&&0!==a&&0===(a=Math.max(0,a-1))&&this.rootEl.remove()},!1),window.addEventListener("drop",e=>{if(!h(e)||!e.dataTransfer||0===e.dataTransfer.files.length){l();return}e.stopPropagation(),e.preventDefault();let i="default";n>0?i="layer":o>0&&(i="image"),t.onDrop(e.dataTransfer.files,i),a>0&&this.rootEl.remove(),a=0,n=0,o=0,c()},!1),this.rootEl.addEventListener("pointerdown",()=>{l()}),new tI.KeyListener({onDown:t=>{a>0&&"esc"===t&&l()}})}},OverlayToolspace:class{getElement(){return this.rootEl}constructor(t){let e={width:150,svHeight:90,hHeight:20,sliderHeight:25},i=!1;this.rootEl=tI.el({className:"kl-overlay-toolspace"});let s={color:null,size:null,opacity:null},r=tI.el({parent:this.rootEl,className:"kl-overlay-toolspace__color"}),a=new es({width:e.width,heightSV:e.svHeight,heightH:e.hHeight,color:t.brushSettingService.getColor(),callback:e=>{n.style.backgroundColor="rgb("+e.r+","+e.g+","+e.b+")",t.brushSettingService.setColor(e,c)}}),n=tI.el({css:{width:e.width+"px",height:e.hHeight+"px",pointerEvents:"none"}});{let e=t.brushSettingService.getColor();n.style.backgroundColor="rgb("+e.r+","+e.g+","+e.b+")"}r.append(n,a.getElement());let o=t=>{a.setColor(t),n.style.backgroundColor="rgb("+t.r+","+t.g+","+t.b+")"},l=new tQ({label:tB("brush-size"),width:e.width,height:e.sliderHeight,min:0,max:500,value:50,resolution:225,eventResMs:1e3/30,toDisplayValue:t=>2*t,toValue:t=>t/2,onChange:e=>{t.brushSettingService.setSize(e)},formatFunc:t=>t<10?tI.round(t,1):Math.round(t)});tI.css(l.getElement(),{marginTop:"2px"});let h=new tQ({label:tB("opacity"),width:e.width,height:e.sliderHeight,min:0,max:1,value:1,resolution:225,eventResMs:1e3/30,toDisplayValue:t=>100*t,toValue:t=>t/100,onChange:e=>{t.brushSettingService.setOpacity(e)}});tI.css(h.getElement(),{margin:"2px 0"}),this.rootEl.append(l.getElement(),h.getElement());let c=t=>{"color"===t.type&&(i?o(t.value):s.color=t.value),"size"===t.type&&(i?l.setValue(t.value):s.size=t.value),"opacity"===t.type&&(i?h.setValue(t.value):s.opacity=t.value),"sliderConfig"===t.type&&(l.update(t.value.sizeSlider),h.update(t.value.opacitySlider))};t.brushSettingService.subscribe(c);{let e=t.brushSettingService.getSliderConfig();l.update(e.sizeSlider),h.update(e.opacitySlider),l.setValue(t.brushSettingService.getSize()),h.setValue(t.brushSettingService.getOpacity())}let p=()=>{tI.unfocusAnyInput(),this.rootEl.style.display=i?"block":"none",i&&d&&tI.css(this.rootEl,{left:d.x-Math.round(e.width/2)+"px",top:d.y-Math.round(e.svHeight+3*e.hHeight/2)+"px"})},d=null;document.addEventListener("pointermove",t=>{d={x:t.pageX,y:t.pageY}}),new tI.KeyListener({onDown:(e,r,a,n)=>{if(!n){if(i){i=!1,p();return}t.enabledTest()&&d&&["ctrl+alt","cmd+alt","alt+ctrl","alt+cmd"].includes(a)&&(r.preventDefault(),i=!0,null!==s.color&&(o(s.color),s.color=null),null!==s.size&&(l.setValue(s.size),s.size=null),null!==s.opacity&&(h.setValue(s.opacity),s.opacity=null),p())}},onUp:(t,e,s)=>{["ctrl+alt","cmd+alt","alt+ctrl","alt+cmd"].includes(s)&&i&&(i=!1,a.end(),p())},onBlur:()=>{i&&(i=!1,a.end(),p())}})}},ToolspaceTopRow:class{getElement(){return this.rootEl}constructor(t){function e(t){let e=6+(t.extraPadding?t.extraPadding:0),i=tI.el({className:"toolspace-row-button nohighlight",title:t.title,onClick:t.onClick,css:{padding:t.contain?e+"px 0":""}}),s=tI.el({className:t.darkInvert?"dark-invert":void 0,css:{backgroundImage:"url('"+t.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:t.contain?"contain":"",height:"100%"}});s.style.pointerEvents="none",i.append(s);let r=new tI.PointerListener({target:i,onEnterLeave:function(t){i.classList.toggle("toolspace-row-button-hover",t)}});return{el:i,pointerListener:r}}this.rootEl=tI.el({className:"kl-toolspace-row",css:{height:"36px",display:"flex"}});let i=e({onClick:t.onLogo,title:tB("home"),image:t.logoImg?t.logoImg:m(ip),contain:!0,darkInvert:!0});i.el.classList.add("kl-tool-row-border-right"),tI.css(i.el,{width:"46px"});let s=e({onClick:t.onNew,title:tB("file-new"),image:m(id),extraPadding:1,contain:!0}),r=e({onClick:t.onImport,title:tB("file-import"),image:m(iu),extraPadding:1,contain:!0}),a=e({onClick:t.onSave,title:tB("file-save"),image:m(ig),extraPadding:1,contain:!0}),n=null;tI.canShareFiles()&&(n=e({onClick:t.onShare,title:tB("file-share"),image:m(im),contain:!0,darkInvert:!0}));let o=e({onClick:t.onHelp,title:tB("help"),image:m(iy),contain:!0,darkInvert:!0});tI.append(this.rootEl,[i.el,s.el,r.el,a.el,n?n.el:void 0,o.el])}},ToolDropdown:iS,ToolspaceToolRow:class{getElement(){return this.rootEl}setIsSmall(t){tI.css(this.rootEl,{height:t?"36px":"54px"}),this.toolDropdown.setIsSmall(t),this.handButton.setIsSmall(t),this.zoomInButton.setIsSmall(t),this.zoomOutButton.setIsSmall(t),this.undoButton.setIsSmall(t),this.redoButton.setIsSmall(t),t?(this.zoomInNOutButton.el.style.display="none",this.undoNRedoButton.el.style.display="none",this.zoomInButton.el.style.display="block",this.zoomOutButton.el.style.display="block",this.undoButton.el.style.display="block",this.redoButton.el.style.display="block"):(this.zoomInNOutButton.el.style.display="block",this.undoNRedoButton.el.style.display="block",this.zoomInButton.el.style.display="none",this.zoomOutButton.el.style.display="none",this.undoButton.el.style.display="none",this.redoButton.el.style.display="none")}setEnableZoomIn(t){this.zoomInButton.el.classList.toggle("toolspace-row-button-disabled",!t),this.zoomInNOutButton.setIsEnabledLeft(t)}setEnableZoomOut(t){this.zoomOutButton.el.classList.toggle("toolspace-row-button-disabled",!t),this.zoomInNOutButton.setIsEnabledRight(t)}setEnableUndo(t){this.undoButton.el.classList.toggle("toolspace-row-button-disabled",!t),this.undoNRedoButton.setIsEnabledLeft(t)}setEnableRedo(t){this.redoButton.el.classList.toggle("toolspace-row-button-disabled",!t),this.undoNRedoButton.setIsEnabledRight(t)}setActive(t,e){this.currentActiveStr!==t&&(this.currentActiveStr=t,this.toolDropdown.setActive(this.currentActiveStr),this.handButton.el.classList.toggle("toolspace-row-button-activated","hand"===this.currentActiveStr),e&&this.onActivate(this.currentActiveStr))}getActive(){return this.currentActiveStr}constructor(t){this.rootEl=tI.el({className:"kl-toolspace-row",css:{height:"54px",display:"flex"}}),this.onActivate=t.onActivate,this.currentActiveStr="draw";let e=t=>{let e=t.doLighten?"6px 0":"8px 0",i=tI.el({className:"toolspace-row-button nohighlight",onClick:t.onClick,css:{padding:t.contain?"10px 0":""}}),s=tI.el({className:"dark-invert",css:{backgroundImage:"url('"+t.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:t.contain?"contain":"",height:"100%",transform:t.doMirror?"scale(-1, 1)":"",pointerEvents:"none",opacity:t.doLighten?"0.75":"1"}});i.append(s);let r=new tI.PointerListener({target:i,onEnterLeave:t=>{i.classList.toggle("toolspace-row-button-hover",t)}});return{el:i,pointerListener:r,setIsSmall:s=>{i.style.padding=t.contain?s?e:"10px 0":""}}},i=t=>{let e=tI.el({css:{flexGrow:"1",position:"relative"}}),i=tI.createSvg({elementType:"svg",width:"67px",height:"54px",viewBox:"0 0 100 100",preserveAspectRatio:"none"});tI.css(i,{position:"absolute",left:"0",top:"0"});let s=tI.createSvg({elementType:"defs",childrenArr:[{elementType:"filter",id:"innershadow",x0:"-50%",y0:"-50%",width:"200%",height:"200%",childrenArr:[{elementType:"feGaussianBlur",in:"SourceAlpha",stdDeviation:"10",result:"blur"},{elementType:"feOffset",dx:"2",dy:"2"},{elementType:"feComposite",in2:"SourceAlpha",operator:"arithmetic",k2:"-1",k3:"1",result:"shadowDiff"},{elementType:"feFlood","flood-color":"#000","flood-opacity":"0.2"},{elementType:"feComposite",in2:"shadowDiff",operator:"in"},{elementType:"feComposite",in2:"SourceGraphic",operator:"over",result:"firstfilter"},{elementType:"feGaussianBlur",in:"firstfilter",stdDeviation:"10",result:"blur2"},{elementType:"feOffset",dx:"2",dy:"2"},{elementType:"feComposite",in2:"firstfilter",operator:"arithmetic",k2:"-1",k3:"1",result:"shadowDiff"},{elementType:"feFlood","flood-color":"#000","flood-opacity":"0.2"},{elementType:"feComposite",in2:"shadowDiff",operator:"in"},{elementType:"feComposite",in2:"firstfilter",operator:"over"}]}]}),r=tI.createSvg({elementType:"path","vector-effect":"non-scaling-stroke",d:"M0,0 L 100,0 0,100 z",fill:"rgba(0,0,0,0)",class:"toolspace-svg-triangle-button"});r.onclick=()=>{t.onLeft(),r.classList.remove("toolspace-svg-triangle-button-hover")};let a=tI.createSvg({elementType:"path","vector-effect":"non-scaling-stroke",d:"M100,100 L 100,0 0,100 z",fill:"rgba(0,0,0,0)",class:"toolspace-svg-triangle-button"});a.onclick=()=>{t.onRight(),a.classList.remove("toolspace-svg-triangle-button-hover")};let n=new tI.PointerListener({target:r,onEnterLeave:t=>{r.classList.toggle("toolspace-svg-triangle-button-hover",t)}}),o=new tI.PointerListener({target:a,onEnterLeave:t=>{a.classList.toggle("toolspace-svg-triangle-button-hover",t)}});i.append(s,r,a),e.append(i);let l=tI.el({parent:e,className:"dark-invert",css:{backgroundImage:"url('"+t.leftImage+"')",backgroundRepeat:"no-repeat",backgroundSize:"contain",width:"20px",height:"20px",position:"absolute",left:"10px",top:"8px",pointerEvents:"none"}});e.append(l);let h=tI.el({parent:e,className:"dark-invert",css:{backgroundImage:"url('"+(t.rightImage?t.rightImage:t.leftImage)+"')",backgroundRepeat:"no-repeat",backgroundSize:"contain",width:"20px",height:"20px",position:"absolute",right:"10px",bottom:"8px",transform:t.rightImage?"":"scale(-1, 1)",pointerEvents:"none"}});return{el:e,setIsEnabledLeft:t=>{r.classList.toggle("toolspace-row-button-disabled",!t),l.classList.toggle("toolspace-row-button-disabled",!t)},setIsEnabledRight:t=>{a.classList.toggle("toolspace-row-button-disabled",!t),h.classList.toggle("toolspace-row-button-disabled",!t)},leftPointerListener:n,rightPointerListener:o}};this.toolDropdown=new iS({onChange:t=>{this.setActive(t,!0)}}),this.rootEl.append(this.toolDropdown.getElement()),this.handButton=e({onClick:()=>{this.setActive("hand",!0)},image:m(eT),contain:!0,doLighten:!0}),this.handButton.el.classList.add("kl-tool-row-border-right"),this.handButton.el.title=tB("tool-hand"),this.rootEl.append(this.handButton.el),this.zoomInNOutButton=i({onLeft:t.onZoomIn,onRight:t.onZoomOut,leftImage:m(eE),rightImage:m(eI)}),this.zoomInNOutButton.el.title=tB("tool-zoom"),this.rootEl.append(this.zoomInNOutButton.el),this.zoomInButton=e({onClick:t.onZoomIn,image:m(eE),contain:!0}),this.zoomInButton.el.title=tB("zoom-in"),this.rootEl.append(this.zoomInButton.el),this.zoomOutButton=e({onClick:t.onZoomOut,image:m(eI),contain:!0}),this.zoomOutButton.el.title=tB("zoom-out"),this.rootEl.append(this.zoomOutButton.el),this.undoNRedoButton=i({onLeft:t.onUndo,onRight:t.onRedo,leftImage:m(ik),rightImage:null}),this.undoNRedoButton.el.title=tB("undo")+"/"+tB("redo"),this.undoNRedoButton.setIsEnabledLeft(!1),this.undoNRedoButton.setIsEnabledRight(!1),this.rootEl.append(this.undoNRedoButton.el),this.undoButton=e({onClick:t.onUndo,image:m(ik),contain:!0}),this.undoButton.el.title=tB("undo"),this.undoButton.el.classList.add("toolspace-row-button-disabled"),this.rootEl.append(this.undoButton.el),this.redoButton=e({onClick:t.onRedo,image:m(ik),contain:!0,doMirror:!0}),this.redoButton.el.title=tB("redo"),this.redoButton.el.classList.add("toolspace-row-button-disabled"),this.rootEl.append(this.redoButton.el),this.zoomInButton.el.style.display="none",this.zoomOutButton.el.style.display="none",this.undoButton.el.style.display="none",this.redoButton.el.style.display="none"}},ToolspaceStabilizerRow:class{getElement(){return this.rootEl}constructor(t){this.rootEl=tI.el({tagName:"label",className:"kl-stabilizer",content:tB("stabilizer")+"&nbsp;",title:tB("stabilizer-title")});let e=new tN({optionArr:[["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"]],initValue:""+t.smoothing,onChange:function(e){t.onSelect(parseInt(e))}});this.rootEl.append(e.getElement()),this.pointerListener=new tI.PointerListener({target:this.rootEl,onWheel:function(t){e.setDeltaValue(t.deltaY)}})}},TabRow:iI,ToolspaceCollapser:class{update(){"left"===this.directionStr?this.icon.style.transform=this.stateIsOpen?"rotate(180deg)":"":this.icon.style.transform=this.stateIsOpen?"":"rotate(180deg)"}isOpen(){return this.stateIsOpen}setDirection(t){this.directionStr=t,this.update()}getElement(){return this.rootEl}constructor(t){this.stateIsOpen=!0,this.directionStr="right",this.rootEl=tI.el({className:"kl-toolspace-toggle",css:{width:"36px",height:"36px",background:"rgba(100, 100, 100, 0.9)",color:"#fff",position:"absolute",top:"0",textAlign:"center",lineHeight:"36px",cursor:"pointer",userSelect:"none",padding:"6px",boxSizing:"border-box"},title:tB("toggle-show-tools"),onClick:e=>{e.preventDefault(),this.stateIsOpen=!this.stateIsOpen,this.update(),t.onChange()}}),this.icon=tI.el({parent:this.rootEl,css:{backgroundImage:`url(${m(iM)})`,width:"100%",height:"100%",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center",userSelect:"none"}}),this.rootEl.oncontextmenu=()=>!1}},BrowserStorageUi:s9,SaveReminder:class{showPopup(){if(!this.projectStore||!this.getProject)throw Error("projectStore and getProject need to be set");let t=Math.round((performance.now()-this.lastSavedAt)/1e3/60),e=tI.el();e.append(tI.el({content:tB("save-reminder-text",{a:"<strong>"+t,b:"</strong>"}),css:{marginBottom:"20px"}}));let i=tI.el({css:{borderTop:"1px solid #aaa",margin:"0 -20px",padding:"20px"}}),s=tI.el({css:{borderTop:"1px solid #aaa",margin:"0 -20px",padding:"20px",paddingBottom:"0"}});e.append(i,s);let r=tI.el({tagName:"button",className:"kl-button",content:tB("save-reminder-save-psd"),onClick:()=>this.onSaveAsPsd()});i.append(r,tI.el({content:tB("save-reminder-psd-layers"),css:{marginTop:"10px"}}));let a=new s9(this.projectStore,this.getProject,this,document.body,{hideClearButton:!0,isFocusable:!0});s.append(a.getElement()),rH.popup({target:document.body,message:`<b>${tB("save-reminder-title")}</b>`,div:e,ignoreBackground:!0,callback:()=>{a.destroy(),tI.destroyEl(r),this.closeFunc=void 0,this.lastReminderShownAt=performance.now()},closeFunc:t=>{this.closeFunc=t}}),setTimeout(()=>{r.focus()},40)}init(){void 0===this.lastSavedActionNumber&&(this.lastSavedActionNumber=this.history.getActionNumber(),this.lastReminderShownAt=performance.now(),this.lastSavedAt=performance.now(),this.showReminder&&setInterval(()=>{if("visible"!==document.visibilityState)return;let t=Math.abs(this.history.getActionNumber()-this.lastSavedActionNumber),e=6e4*({"20min":20,"40min":40,disabled:0})[this.setting];e>0&&0===rH.dialogCounter.get()&&!this.isDrawing()&&this.lastReminderShownAt+e<performance.now()&&t>=100&&this.showPopup()},5e3),this.history.addListener(()=>{let e=this.history.getActionNumber();this.lastSavedActionNumber!==e?window.onbeforeunload=t:window.onbeforeunload=null}),this.changeTitle&&document.addEventListener("visibilitychange",()=>{if("visible"===document.visibilityState)document.title=this.title,clearInterval(this.unsavedInterval);else{let t=this.history.getActionNumber();if(this.lastSavedActionNumber!==t){document.title=tB("unsaved")+" - "+this.title;let t=0;this.unsavedInterval=setInterval(()=>{1==(t=(t+1)%2)?document.title=tB("unsaved")+"  "+this.title:document.title=tB("unsaved")+" - "+this.title},18e4)}}}));function t(t){t.preventDefault(),t.returnValue=""}}reset(){void 0!==this.lastSavedActionNumber&&(this.lastSavedActionNumber=this.history.getActionNumber(),this.lastReminderShownAt=performance.now(),this.lastSavedAt=performance.now(),window.onbeforeunload=null,this.closeFunc&&this.closeFunc())}getSetting(){return this.setting}setSetting(t){this.setting=t,localStorage.setItem(rP,this.setting)}constructor(t,e,i,s,r,a,n,o="Klecks"){var l;this.history=t,this.showReminder=e,this.changeTitle=i,this.onSaveAsPsd=s,this.isDrawing=r,this.projectStore=a,this.getProject=n,this.title=o,this.lastSavedAt=0,this.lastReminderShownAt=0,this.setting=null!==(l=localStorage.getItem(rP))&&void 0!==l?l:"20min"}},ToolspaceScroller:class{update(){let t=this.upBtn.style.display,e=this.downBtn.style.display;this.toolspace.scrollHeight>this.toolspace.offsetHeight+3?(this.upInterval||(t=0===this.toolspace.scrollTop?"none":"block"),this.downInterval||(e=this.toolspace.scrollTop+this.toolspace.offsetHeight+1>=this.toolspace.scrollHeight?"none":"block")):(t="none",e="none"),t!==this.upBtn.style.display&&(this.upBtn.style.display=t),e!==this.downBtn.style.display&&(this.downBtn.style.display=e)}updateUiState(t){tI.css(this.upBtn,{left:"left"===t?"0":"",right:"right"===t?"0":""}),tI.css(this.downBtn,{left:"left"===t?"0":"",right:"right"===t?"0":""})}constructor(t){this.toolspace=t.toolspace,this.upBtn=tI.el({parent:this.toolspace,title:tB("scroll"),className:"kl-scroller",css:{top:"0",transform:"rotate(180deg)"}}),this.downBtn=tI.el({parent:this.toolspace,title:tB("scroll"),className:"kl-scroller",css:{bottom:"0"}}),this.updateUiState(t.uiState),new tI.PointerListener({target:this.upBtn,onPointer:t=>{"pointerdown"===t.type&&(this.upInterval=setInterval(()=>{this.toolspace.scrollBy(0,-13),this.update()},20)),"pointerup"===t.type&&(clearInterval(this.upInterval),setTimeout(()=>{this.upInterval=null,this.update()},50))}}),new tI.PointerListener({target:this.downBtn,onPointer:t=>{"pointerdown"===t.type&&(this.downInterval=setInterval(()=>{this.toolspace.scrollBy(0,13),this.update()},20)),"pointerup"===t.type&&(clearInterval(this.downInterval),setTimeout(()=>{this.downInterval=null,this.update()},50))}});let e=t=>{this.toolspace.scrollBy(0,Math.round(.7*t.deltaY)),this.update()};this.upBtn.addEventListener("wheel",e),this.downBtn.addEventListener("wheel",e),this.update(),new MutationObserver(()=>this.update()).observe(this.toolspace,{attributes:!0,childList:!0,subtree:!0}),window.addEventListener("resize",()=>this.update()),B.subscribe(t=>{this.upBtn.style.opacity=t>=1?"0":"",this.downBtn.style.opacity=t>=1?"0":""})}},dialogCounter:B,popup:tH,Popup:tj,clipboardDialog:function(t,e,i,s,r){let a,n,o,l=!1;try{l=!!ClipboardItem}catch(t){}let h=document.createElement("div"),c=window.innerWidth<550||window.innerHeight<550,p=tI.el({content:tB("crop-drag-to-crop")+(l?"":"<br>"+tB("cropcopy-click-hold")),css:{textAlign:"center"}});h.append(p);let d=new eO({width:c?340:540,height:c?300:350,canvas:e,isNotCopy:!1,onChange:()=>setTimeout(()=>void(l&&(clearTimeout(n),n=setTimeout(()=>{d.getCroppedCanvas().toBlob(t=>{a=null!=t?t:void 0},"image/png")},50))))});async function u(){if(a)try{await navigator.clipboard.write([new ClipboardItem({[a.type]:a})]),setTimeout(function(){s.out(tB("cropcopy-copied"),!0)},200)}catch(t){console.error(t.name,t.message);return}}tI.css(d.getEl(),{marginTop:"10px",marginLeft:"-20px"}),h.append(d.getEl());let g=new tI.KeyListener({onDown:function(t,e,i){["ctrl+c","cmd+c"].includes(i)&&(u(),o&&o())}});function m(){o&&o()}window.addEventListener("blur",m);let y=[];l&&y.push(tB("cropcopy-btn-copy")),r&&y.push(tB("cropcopy-btn-crop")),y.push("Cancel"),tH({target:t,message:"<b>"+(r?`${tB("cropcopy-title-copy")} / ${tB("cropcopy-title-crop")}`:`${tB("cropcopy-title-copy")}`)+"</b>",div:h,style:c?{}:{width:"540px"},buttons:y,primaries:[tB("cropcopy-btn-copy")],callback:function(t){if(t===tB("cropcopy-btn-copy"))u();else if(t===tB("cropcopy-btn-crop")){let t=d.getRect();i({left:Math.round(-t.x),right:Math.round(t.x+t.width-e.width),top:Math.round(-t.y),bottom:Math.round(t.y+t.height-e.height)})}window.removeEventListener("blur",m),tI.freeCanvas(d.getCroppedCanvas()),d.destroy(),g.destroy()},clickOnEnter:tB("cropcopy-btn-copy"),closeFunc:function(t){o=t}})},showImportAsLayerDialog:function(t){let e=document.createElement("div");if(tI.appendTextDiv(e,tB("import-as-layer-description")),t.klCanvas.isLayerLimitReached()){let t=tI.el({content:tB("import-as-layer-limit-reached"),css:{background:"#ff0",padding:"10px",marginTop:"5px",marginBottom:"5px",border:"1px solid #e7d321",borderRadius:"5px"}});e.append(t)}let i=ia(),s=tI.el({css:{display:"flex"}}),r=tI.el({tagName:"button",content:"1:1",css:{marginRight:"10px"},onClick:function(){l.reset()}}),a=tI.el({tagName:"button",content:tB("import-as-layer-fit"),css:{marginRight:"10px"},onClick:function(){l.setTransformFit()}}),n=tI.el({tagName:"button",content:tB("center"),css:{marginRight:"10px"},onClick:function(){l.setTransformCenter()}});s.append(r,a,n),e.append(s);let o=[];{let e=t.klCanvas.getLayers();for(let t=0;t<e.length;t++)o.push({image:e[t].context.canvas,isVisible:e[t].isVisible,opacity:e[t].opacity,mixModeStr:e[t].mixModeStr})}o.push({image:t.importImage,isVisible:!0,opacity:1,mixModeStr:"source-over"});let l=new is({elementWidth:ih(i),elementHeight:ic(i)+50,imageWidth:t.klCanvas.getLayerContext(0).canvas.width,imageHeight:t.klCanvas.getLayerContext(0).canvas.height,layers:o,transformIndex:o.length-1});function h(t,e){l.move(t,e)}tI.css(l.getElement(),{marginTop:"10px",marginLeft:"-20px"}),e.append(l.getElement());let c=new tI.KeyListener({onDown:function(t){"left"===t&&h(-1,0),"right"===t&&h(1,0),"up"===t&&h(0,-1),"down"===t&&h(0,1)}});tH({target:t.target,message:`<b>${tB("import-as-layer-title")}</b>`,div:e,style:i?void 0:{width:"540px"},buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:function(e){c.destroy(),l.destroy(),tI.destroyEl(r),tI.destroyEl(a),tI.destroyEl(n),"Ok"===e?t.callback(l.getTransformation(),l.getIsPixelated()):t.callback()}})},newImageDialog:function(t){let e=t.currentColor,i=t.secondaryColor,s=t.maxCanvasSize,r=t.canvasWidth,a=t.canvasHeight,n=t.workspaceWidth,o=t.workspaceHeight,l=t.onConfirm,h=t.onCancel;function c(t,e,i,r,a){return tI.fitInto(t,e,Math.min(s,i-a),Math.min(s,r-a),1)}let p=tI.el(),d=tI.el({tagName:"input"}),u={color:"#888",fontSize:"12px",marginLeft:"5px"},g=tI.el({textContent:tB("new-px"),css:u}),m=tI.el({tagName:"input"}),y=tI.el({textContent:tB("new-px"),css:u});d.setAttribute("data-ignore-focus","true"),m.setAttribute("data-ignore-focus","true"),d.type="number",d.min="1",d.max=""+s,tI.css(d,{width:"70px"}),m.type="number",m.min="1",m.max=""+s,m.style.width="70px",d.value=""+r,m.value=""+a,d.onclick=()=>{d.focus(),D()},m.onclick=()=>{m.focus(),D()};let f=iT([[tB("width")+":&nbsp;",d,g],[tI.el({css:{height:"5px"}}),"",""],[tB("height")+":&nbsp;",m,y]]);tI.css(f,{marginBottom:"10px"});let x=tI.el({css:{marginTop:"5px",color:"#888"}}),v=tI.el(),b=tI.el({tagName:"button"});v.style.marginBottom="10px";let w=tI.el({tagName:"button"}),C=tI.el({tagName:"button"}),S=tI.el({tagName:"button"}),k=tI.el({tagName:"button"}),E=tI.el({tagName:"button"});w.textContent=tB("new-current"),b.textContent=tB("new-fit"),E.textContent=tB("new-oversize"),S.textContent=tB("new-landscape"),k.textContent=tB("new-portrait"),C.textContent=tB("new-square"),w.style.marginRight="5px",b.style.marginRight="5px",E.style.marginRight="5px",S.style.marginTop="5px",S.style.marginRight="5px",k.style.marginTop="5px",k.style.marginRight="5px",v.append(w,b,E,C,S,k),w.onclick=function(){d.value=""+r,m.value=""+a,D()},b.onclick=function(){d.value=""+n,m.value=""+o,D()},E.onclick=function(){d.value=""+(n+500),m.value=""+(o+500),D()},C.onclick=function(){let t=c(1,1,n,o,0);d.value=""+Math.round(t.width),m.value=""+Math.round(t.height),D()},S.onclick=function(){let t=c(4,3,n,o,0);d.value=""+Math.round(t.width),m.value=""+Math.round(t.height),D()},k.onclick=function(){let t=c(3,4,n,o,0);d.value=""+Math.round(t.width),m.value=""+Math.round(t.height),D()};let I=new tN({isFocusable:!0,optionArr:[["screen",tB("new-screen")],["16 9",tB("new-video")+" 16:9"],["3 2","3:2"],["5 3","5:3"],["2 1","2:1"],["paper",tB("new-din-paper")+" 2:1"],["9 16","9:16"],["2 3","2:3"],["3 5","3:5"],["1 2","1:2"],["1 1.4142135623730951","1:2"]],onChange:function(t){if("screen"===t)d.value=""+window.screen.width,m.value=""+window.screen.height;else if("paper"===t){let t=c(Math.sqrt(2),1,n,o,0);d.value=""+Math.round(t.width),m.value=""+Math.round(t.height)}else{let e=t.split(" "),i=c(parseFloat(e[0]),parseFloat(e[1]),n,o,0);d.value=""+Math.round(i.width),m.value=""+Math.round(i.height)}D(),I.setValue(void 0)}});setTimeout(()=>{I.setValue(void 0)},0),tI.css(I.getElement(),{width:"80px"}),v.append(I.getElement());let A={r:255,g:255,b:255,a:1},T=[{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1},{r:0,g:0,b:0,a:0},{r:e.r,g:e.g,b:e.b,a:1},{r:i.r,g:i.g,b:i.b,a:1}],M=0;ee.isDark()&&T.forEach((t,e)=>{t.r===ei&&t.g===ei&&t.b===ei&&(M=e,A=t)});let L=new ea({colorArr:T,initialIndex:M,onChange:function(t){A=t,P.style.backgroundColor="rgba("+t.r+","+t.g+","+t.b+", "+t.a+")"}}),R=tI.el({className:"kl-transparent-preview",css:{boxSizing:"border-box",width:"340px",height:"140px",display:"table",padding:"10px",marginTop:"10px",marginLeft:"-20px"}}),P=tI.el({className:"kl-transparent-preview__canvas",css:{width:"200px",height:"100px",backgroundColor:"rgba("+A.r+","+A.g+","+A.b+", "+A.a+")",marginLeft:"auto",marginRight:"auto",color:"#aaa",fontSize:"16px",fontWeight:"bold",textAlign:"center",verticalAlign:"center",display:"table",overflow:"hidden"}});function D(){d.value=""+Math.min(s,parseInt(d.value)),m.value=""+Math.min(s,parseInt(m.value));let t=parseInt(d.value),e=parseInt(m.value);(t<1||t>s||e<1||e>s)&&(t>s?t=s:e>s&&(e=s),d.value=""+t,m.value=""+e);let i=[[1,2],[2,1],[2,3],[3,2],[3,4],[4,3],[4,5],[5,4],[16,9],[9,16],[3,2],[2,3],[5,3],[3,5],[2,1],[1,2],[1.414,1],[1,1.414]],r=tI.reduce(t,e),a=i[0],n=Math.abs(i[0][0]/i[0][1]-r[0]/r[1]);for(let t=0;t<i.length;t++)Math.abs(i[t][0]/i[t][1]-r[0]/r[1])<n&&(a=i[t],n=Math.abs(i[t][0]/i[t][1]-r[0]/r[1]));n>0&&n<.005?x.innerText=tB("new-ratio")+": ~"+a[0]+":"+a[1]:x.innerText=tB("new-ratio")+": "+r[0]+":"+r[1];let o=t,l=function(t,e){let i=t,s=e;for(;;){if(!(i%=s))return s;if(!(s%=i))return i}}(t,e);t/=l,e/=l,e*=260,(t*=260)>260&&(e=260/t*e,t=260),e>100&&(t=100/e*t,e=100),P.style.width=t+"px",P.style.height=e+"px",tI.createCheckerDataUrl(parseInt(""+t/o*30),function(t){R.style.background="url("+t+")"},ee.isDark())}tI.el({parent:R,content:P,css:{display:"table-cell",verticalAlign:"middle"}}),tI.el({parent:P,css:{display:"table-cell",verticalAlign:"middle"}}),ee.addIsDarkListener(D),d.onchange=()=>{(""===d.value||0>parseInt(d.value))&&(d.value="1"),D()},d.onkeyup=()=>{D()},m.onchange=()=>{(""===m.value||0>parseFloat(m.value))&&(m.value="1"),D()},m.onkeyup=()=>{D()},D(),p.append(v);let B=tI.el({parent:p,css:{display:"flex",justifyContent:"space-between",alignItems:"flex-end"}});tI.el({parent:B}).append(f,x),B.append(L.getElement()),p.append(R),tH({target:document.body,message:`<b>${tB("new-title")}</b>`,div:p,buttons:["Ok","Cancel"],callback:function(t){if(tI.unsetEventHandler(d,"onclick","onchange","onkeyup"),tI.unsetEventHandler(d,"onclick","onchange","onkeyup"),tI.unsetEventHandler(w,"onclick"),tI.unsetEventHandler(b,"onclick"),tI.unsetEventHandler(E,"onclick"),tI.unsetEventHandler(C,"onclick"),tI.unsetEventHandler(S,"onclick"),tI.unsetEventHandler(k,"onclick"),I.destroy(),L.destroy(),ee.removeIsDarkListener(D),"Cancel"===t||0>=parseInt(d.value)||0>=parseInt(m.value)||isNaN(parseInt(d.value))||isNaN(parseInt(m.value))){h();return}l(parseInt(d.value),parseInt(m.value),A)},clickOnEnter:"Ok"})},textToolDialog:function(t){let e=tI.el({}),i=tI.copyObj(t.text),s=tI.el({className:d}),r=new i4({text:i,klCanvas:t.klCanvas,layerIndex:t.layerIndex,onDragEnd:()=>"text"===p.getOpenedTabId()?c.focus():0});function a(t){i={...i,...t},r.setText(i)}r.render();let n=new i2({...i,onUpdate:t=>{a(t)}}),o=tI.el({css:{display:"flex",gap:"10px",flexDirection:"column"}}),l=new iL({fill:i.fill,primaryColor:t.primaryColor,secondaryColor:t.secondaryColor,onUpdate:t=>{a(t)}}),h=new i5({stroke:i.stroke,primaryColor:t.primaryColor,secondaryColor:t.secondaryColor,onUpdate:t=>{a(t)}}),c=new i3({text:i.text,onUpdate:t=>{void 0!==t.text&&x.setIgnoreBackground(t.text.length>0),a(t)}}),p=new iI({initialId:"text",height:40,tabArr:[{id:"text",label:tB("text-text"),onOpen:()=>{c.getElement().style.display="",c.focus()},onClose:()=>{c.getElement().style.display="none"}},{id:"font",label:tB("text-font"),onOpen:()=>{n.getElement().style.display="flex"},onClose:()=>{n.getElement().style.display="none"}},{id:"color",label:tB("text-color"),onOpen:()=>{o.style.display="flex"},onClose:()=>{o.style.display="none"}}]});p.getElement().classList.add(t6({minWidth:"200px",maxWidth:"500px",flexGrow:"1",borderBottom:"none !important"}));let u=t6({position:"relative",">*":{position:"absolute",right:0,top:10}}),g=t6({display:"flex",justifyContent:"space-between",flexDirection:"row-reverse",flexWrap:"wrap",marginTop:"10px",marginLeft:"-20px",marginRight:"-20px",padding:"0 20px","@media (min-width: 700px) and (min-height: 700px)":{display:"none !important"}}),m=t6({minHeight:72,marginTop:"10px","@media (min-width: 700px) and (min-height: 700px)":{display:"flex",flexDirection:"column",gap:"10px",">*":{display:"flex !important"}}});e.append(tJ("",[tJ(s,[r.getElement()]),tJ("."+u,[r.getInputsElement()]),tJ(".tabrow."+g,[tJ(",w-240,h-40"),p.getElement()]),tJ("."+m,[tJ(o,[l.getElement(),h.getElement()]),n.getElement(),c.getElement()])]));let y=()=>{let t=s.getBoundingClientRect(),e=Math.ceil(t.width),i=Math.ceil(t.height);r.setSize(e,i)};function f(){window.scrollTo(0,0)}window.addEventListener("resize",y),setTimeout(()=>{y()}),setTimeout(()=>{c.focus()},100),window.addEventListener("scroll",f);let x=tH({target:document.body,message:`<b>${tB("text-title")}</b>`,div:e,buttons:["Ok","Cancel"],ignoreBackground:t.text.text.length>0,callback:e=>{window.removeEventListener("resize",y),window.removeEventListener("scroll",f),r.destroy(),n.destroy(),l.destroy(),h.destroy(),c.destroy(),p.destroy(),"Ok"===e&&t.onConfirm({...r.getValues(),...n.getValues(),...l.getValues(),...h.getValues(),...c.getValues()})},style:{width:"calc(100% - 50px)",maxWidth:"1000px",minWidth:"300px",boxSizing:"border-box"},clickOnEnter:"Ok"})},showImportImageDialog:function(t){let e,i;let s=tI.el(),r=window.innerWidth<550||window.innerHeight<550,a=tI.el({css:{marginTop:"10px",textAlign:"center",color:"#888",lineHeight:"20px"}}),n=new eO({width:r?340:540,height:r?300:400,canvas:t.image.canvas,isNotCopy:!0,onChange:(t,e)=>{a&&o(t,e)}});function o(e,i){let s=tI.fitInto(e,i,t.maxSize,t.maxSize);s.width<e?(a.innerHTML=`<span class="kl-text-error">${e} X ${i}</span> \u{27F6} ${Math.round(s.width)} X ${Math.round(s.height)}`,a.title=tB("import-too-large")):(a.innerHTML=`${e} X ${i}`,a.title="")}tI.css(n.getEl(),{marginLeft:"-20px"}),n.getEl().title=tB("crop-drag-to-crop"),s.append(n.getEl(),a),o(t.image.width,t.image.height);let l=!1;if("psd"===t.image.type){if(t.image.layers){if(e=new tF({init:l,label:tB("import-flatten"),callback:t=>{l=t}}),s.append(e.getElement()),t.image.warningArr){let e=tI.el({className:"kl-import-note",content:tB("import-psd-limited-support")}),r=t.image.warningArr;i=tI.el({parent:e,tagName:"a",content:"Details",css:{marginLeft:"5px"},onClick:()=>(function(t){let e=[],i={mask:"Masks not supported. Mask was applied.",clipping:"Clipping not supported. Clipping layers were merged.",group:"Groups not supported. Layers were ungrouped.",adjustment:"Adjustment layers not supported.","layer-effect":"Layer effects not supported.","smart-object":"Smart objects not supported.","blend-mode":"Unsupported layer blend mode.","bits-per-channel":"Unsupported color depth. Only 8bit per channel supported."};for(let s=0;s<t.length;s++)e.push("- "+i[t[s]]);alert(e.join("\n"))})(r)}),s.append(e)}}else{let t=tI.el({className:"kl-import-note",content:tB("import-psd-unsupported")});s.append(t)}}tH({target:t.target,message:`<b>${tB("import-title")}</b>`,div:s,style:r?{}:{width:"540px"},buttons:[tB("import-btn-as-layer"),tB("import-btn-as-image"),"Cancel"],primaries:[tB("import-btn-as-layer"),tB("import-btn-as-image")],callback:function(s){let r=n.getCroppedCanvas(),a=n.getRect(),o=t.image.width!==a.width&&t.image.height!==a.height;n.destroy(),tI.destroyEl(i),e&&e.destroy(),s===tB("import-btn-as-layer")?(t.callback({type:"as-layer",image:o?r:t.image.canvas}),o||tI.freeCanvas(r)):s===tB("import-btn-as-image")?"psd"===t.image.type?(l&&delete t.image.layers,t.callback({type:"as-image-psd",image:t.image,cropObj:a}),tI.freeCanvas(r)):"image"===t.image.type&&t.callback({type:"as-image",image:r}):(t.callback({type:"cancel"}),tI.freeCanvas(r))},autoFocus:"As Image"})},showIframePopup:s4,imgurUpload:function(t,e,i,s){if(!s)throw Error("imgur key missing");let r=tI.el({tagName:"input"});r.type="text",r.value=tB("upload-title-untitled");let a=tI.el({tagName:"textarea",custom:{rows:"2"},css:{width:"100%",maxWidth:"100%"}}),n=tI.el({textContent:tB("upload-name")+":"}),o=tI.el({textContent:tB("upload-caption")+":",css:{marginTop:"10px"}}),l=tI.el({content:`<br/><a href="https://imgur.com/tos" target="_blank" rel="noopener noreferrer">${tB("terms-of-service")}</a>`}),h=new rH.RadioList({name:"filetype",init:"jpeg",items:[{label:"JPG",value:"jpeg"},{label:"PNG",value:"png"}],ignoreFocus:!0});tI.css(h.getElement(),{marginBottom:"10px"});let c=tI.el(),p=tI.el({className:"info-hint",textContent:tB("upload-link-notice")});c.append(p,h.getElement(),n,r,o,a,l),rH.popup({target:e,message:`<b>${tB("upload-title")}</b>`,type:"upload",div:c,buttons:[tB("upload-submit"),"Cancel"],clickOnEnter:tB("upload-submit"),primaries:[tB("upload-submit")],autoFocus:tB("upload-submit"),callback:async function(n){if(n===tB("upload-submit")||"Yes"===n||"Ok"===n)try{let n=await rL(t.getCompleteCanvas(1),r.value,a.value,h.getValue(),s);rH.popup({target:e,type:"ok",message:`<h3>${tB("upload-success")}</h3><br>${tB("upload-delete")}<br><a target='_blank' rel="noopener noreferrer" href='https://imgur.com/delete/${n.deletehash}'>imgur.com/delete/${n.deletehash}</a><br><br>`,buttons:["Ok"]}),i.reset()}catch(t){rH.popup({target:e,type:"error",message:tB("upload-failed"),buttons:["Ok"]})}}})},HandUi:class{updateUi(){this.scaleEl.innerHTML=Math.round(100*this.scale)+"%",this.angleEl.innerHTML=Math.round(this.angleDeg)+"",this.angleIm.style.transform="rotate("+this.angleDeg+"deg)",this.angleDeg%90==0?this.angleIm.style.boxShadow="inset 0 0 0 1px rgba(255,255,255, 1), 0 0 0 1px rgba(0, 0, 0, 0.3)":this.angleIm.style.boxShadow=""}getElement(){return this.rootEl}setIsVisible(t){this.isVisible=!!t,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.updateUi()}update(t,e){this.scale=t,this.angleDeg=e,this.isVisible&&this.updateUi()}constructor(t){this.isVisible=!0,this.rootEl=tI.el({css:{margin:"10px"}}),this.scale=t.scale,this.angleDeg=t.angleDeg,this.onAngleChange=t.onAngleChange;let e=tI.el({css:{marginBottom:"10px",display:"flex"}}),i=tI.el({css:{display:"flex",marginBottom:"10px"}}),s=tI.el({css:{display:"flex"}});this.rootEl.append(e,i,s),this.scaleEl=tI.el({css:{width:"55px",userSelect:"none"}}),e.append(this.scaleEl),this.angleIm=new Image,this.angleIm.src=m(eo),tI.css(this.angleIm,{verticalAlign:"bottom",width:"20px",height:"20px",marginRight:"5px",borderRadius:"10px",background:"rgba(0,0,0,0.2)",userSelect:"none"}),e.append(this.angleIm),this.angleEl=tI.el({parent:e,css:{userSelect:"none"}}),this.updateUi();let r=tI.el({tagName:"button",content:tB("hand-reset"),onClick:t.onReset});tI.makeUnfocusable(r);let a=tI.el({tagName:"button",content:tB("hand-fit"),css:{marginLeft:"10px"},onClick:t.onFit});tI.makeUnfocusable(a),i.append(r,a);let n=tI.el({tagName:"button",content:'<img height="20" src="'+m(iA)+'" alt="Rotate" style="transform: scale(-1, 1)"/>',onClick:function(){t.onAngleChange(-15,!0)}});tI.makeUnfocusable(n);let o=tI.el({tagName:"button",content:"0",css:{marginLeft:"10px"},onClick:function(){t.onAngleChange(0)}});tI.makeUnfocusable(o);let l=tI.el({tagName:"button",content:'<img height="20" src="'+m(iA)+'" alt="Rotate"/>',css:{marginLeft:"10px"},onClick:function(){t.onAngleChange(15,!0)}});tI.makeUnfocusable(l),s.append(n,o,l)}},FillUi:class{getElement(){return this.rootEl}setIsVisible(t){this.isVisible=!!t,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.colorDiv.append(this.colorSlider.getElement(),this.colorSlider.getOutputElement())}getTolerance(){return this.toleranceSlider.getValue()}getOpacity(){return this.opacitySlider.getValue()}getSample(){return this.modeSelect.getValue()}getGrow(){return parseInt(this.growSelect.getValue(),10)}getContiguous(){return this.isContiguous}getIsEraser(){return this.eraserToggle.getValue()}constructor(t){this.rootEl=tI.el({css:{margin:"10px"}}),this.isVisible=!0,this.colorDiv=tI.el({parent:this.rootEl,css:{marginBottom:"10px"}}),this.colorSlider=t.colorSlider,this.opacitySlider=new tQ({label:tB("opacity"),width:250,height:30,min:.01,max:1,value:1,toValue:t=>t/100,toDisplayValue:t=>100*t}),this.rootEl.append(this.opacitySlider.getElement()),this.toleranceSlider=new tQ({label:tB("bucket-tolerance"),width:250,height:30,min:0,max:255,value:51,toValue:t=>2.55*t,toDisplayValue:t=>t/2.55}),tI.css(this.toleranceSlider.getElement(),{marginTop:"10px"}),this.rootEl.append(this.toleranceSlider.getElement());let e=tI.el({parent:this.rootEl,css:{display:"flex",marginTop:"10px"}}),i=tI.el({content:tB("bucket-sample")+"&nbsp;",title:tB("bucket-sample-title"),css:{fontSize:"15px"}});this.modeSelect=new tN({optionArr:[["all",tB("bucket-sample-all")],["current",tB("bucket-sample-active")],["above",tB("bucket-sample-above")]],initValue:"all"}),new tI.PointerListener({target:this.modeSelect.getElement(),onWheel:t=>{this.modeSelect.setDeltaValue(t.deltaY)}}),i.append(this.modeSelect.getElement()),e.append(i);let s=tI.el({content:tB("bucket-grow")+"&nbsp;",title:tB("bucket-grow-title"),css:{fontSize:"15px",marginLeft:"10px"}});this.growSelect=new tN({optionArr:[["0","0"],["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"]],initValue:"0"}),new tI.PointerListener({target:this.growSelect.getElement(),onWheel:t=>{this.growSelect.setDeltaValue(t.deltaY)}}),s.append(this.growSelect.getElement()),e.append(s),this.isContiguous=!0;let r=new tF({init:!0,label:tB("bucket-contiguous"),title:tB("bucket-contiguous-title"),callback:t=>{this.isContiguous=t},css:{paddingRight:"5px",display:"inline-block",width:"50%"}});this.eraserToggle=new tF({init:!1,label:tB("eraser"),css:{paddingRight:"5px",display:"inline-block",width:"50%"}}),this.rootEl.append(tI.el({content:[r.getElement(),this.eraserToggle.getElement()],css:{display:"flex",marginTop:"10px"}}))}},GradientUi:class{updateIcons(){let t=this.settings.isReversed?"#0000":"#000",e=this.settings.isReversed?"#000":"#0000";this.iconArr[0].style.background=`linear-gradient(${t}, ${e})`,this.iconArr[1].style.background=`linear-gradient(${e}, ${t}, ${e})`,this.iconArr[2].style.background=`radial-gradient(${t}, ${e})`}getElement(){return this.rootEl}setIsVisible(t){this.isVisible=!!t,this.rootEl.style.display=t?"block":"none",t&&this.colorDiv.append(this.colorSlider.getElement(),this.colorSlider.getOutputElement())}getSettings(){return tI.copyObj(this.settings)}constructor(t){this.settings={opacity:1,type:"linear",doLockAlpha:!1,doSnap:!1,isReversed:!1,isEraser:!1},this.colorSlider=t.colorSlider,this.rootEl=tI.el({css:{margin:"10px"}}),this.isVisible=!0,this.colorDiv=tI.el({parent:this.rootEl,css:{marginBottom:"10px"}}),this.iconArr=[],[0,1,2].forEach(()=>{let t=tI.el({className:"dark-invert",css:{width:"33px",height:"33px",borderRadius:"3px",margin:"1px"}});this.iconArr.push(t)}),this.updateIcons();let e=new en({optionArr:[{id:"linear",label:this.iconArr[0],title:tB("gradient-linear")},{id:"linear-mirror",label:this.iconArr[1],title:tB("gradient-linear-mirror")},{id:"radial",label:this.iconArr[2],title:tB("gradient-radial")}],initId:"linear",onChange:t=>{this.settings.type=t}});this.rootEl.append(e.getElement());let i=new tQ({label:tB("opacity"),width:250,height:30,min:.01,max:1,value:this.settings.opacity,toValue:t=>t/100,toDisplayValue:t=>100*t,onChange:t=>{this.settings.opacity=t}});tI.css(i.getElement(),{marginTop:"10px"}),this.rootEl.append(i.getElement());let s=tI.el({parent:this.rootEl,css:{display:"flex",alignItems:"center",marginTop:"10px"}}),r=new tF({init:!1,label:tB("reverse"),callback:t=>{this.settings.isReversed=t,this.updateIcons()},css:{width:"50%"}}),a=new tF({init:!1,label:tB("angle-snap"),title:tB("angle-snap-title"),callback:t=>{this.settings.doSnap=t},css:{width:"50%"}});s.append(r.getElement(),a.getElement());let n=tI.el({parent:this.rootEl,css:{display:"flex",alignItems:"center",marginTop:"10px"}}),o=new tF({init:this.settings.isEraser,label:tB("eraser"),callback:t=>{this.settings.isEraser=t},css:{width:"50%"}}),l=new tF({init:!1,label:tB("lock-alpha"),title:tB("lock-alpha-title"),callback:t=>{this.settings.doLockAlpha=t},doHighlight:!0,css:{width:"50%"}});n.append(o.getElement(),l.getElement())}},TextUi:class{getElement(){return this.rootEl}setIsVisible(t){this.isVisible=!!t,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&this.colorDiv.append(this.colorSlider.getElement(),this.colorSlider.getOutputElement())}constructor(t){this.isVisible=!0,this.rootEl=tI.el({css:{margin:"10px"}}),this.colorSlider=t.colorSlider,this.colorDiv=tI.el({parent:this.rootEl,css:{marginBottom:"10px"}}),tI.el({parent:this.rootEl,content:tB("text-instruction")})}},ShapeUi:class{getElement(){return this.rootEl}setIsVisible(t){this.isVisible=!!t,this.rootEl.style.display=this.isVisible?"block":"none",this.isVisible&&(this.colorDiv.append(this.colorSlider.getElement()),this.colorDiv.append(this.colorSlider.getOutputElement()))}getShape(){return this.shape}getMode(){return this.mode}getIsEraser(){return this.eraserToggle.getValue()}getOpacity(){return this.opacitySlider.getValue()}getLineWidth(){return this.lineWidthSlider.getValue()}getIsOutwards(){return this.outwardsToggle.getValue()}getIsFixed(){return this.fixedToggle.getValue()}getIsSnap(){return this.snapToggle.getValue()}getDoLockAlpha(){return this.lockAlphaToggle.getValue()}constructor(t){this.shape="rect",this.mode="stroke",this.rootEl=tI.el({css:{margin:"10px"}}),this.isVisible=!0,this.colorDiv=tI.el({parent:this.rootEl,css:{marginBottom:"10px"}}),this.colorSlider=t.colorSlider;let e=tI.createSvg({elementType:"rect",x:"8",width:"19"}),i=tI.createSvg({elementType:"svg",width:"35",height:"35"});i.classList.add("dark-invert"),i.append(e),tI.css(i,{display:"block"});let s=tI.createSvg({elementType:"rect",x:"8",width:"19"}),r=tI.createSvg({elementType:"svg",width:"35",height:"35"});r.classList.add("dark-invert"),r.append(s),tI.css(r,{display:"block"});let a=tI.createSvg({elementType:"ellipse",cx:"17.5",cy:"17.5",rx:"9.5"}),n=tI.createSvg({elementType:"svg",width:"35",height:"35"});n.classList.add("dark-invert"),n.append(a),tI.css(n,{display:"block"});let o=tI.createSvg({elementType:"ellipse",cx:"17.5",cy:"17.5",rx:"9.5"}),l=tI.createSvg({elementType:"svg",width:"35",height:"35"});l.classList.add("dark-invert"),l.append(o),tI.css(l,{display:"block"});let h=tI.createSvg({elementType:"line",x1:"8",x2:"27"}),c=tI.createSvg({elementType:"svg",width:"35",height:"35"});c.classList.add("dark-invert"),c.append(h),tI.css(c,{display:"block"});let p=()=>{let t=tI.clamp(Math.round(this.lineWidthSlider.getValue()/10),1,10)+"px";tI.css(e,{fill:"none",stroke:"black",strokeWidth:t}),tI.css(s,{fill:"black",stroke:"none"}),tI.css(a,{fill:"none",stroke:"black",strokeWidth:t}),tI.css(o,{fill:"black",stroke:"none"}),tI.css(h,{fill:"none",stroke:"black",strokeWidth:t}),this.fixedToggle.getValue()?(e.setAttribute("y","8"),e.setAttribute("height","19"),s.setAttribute("y","8"),s.setAttribute("height","19"),a.setAttribute("ry","9.5"),o.setAttribute("ry","9.5")):(e.setAttribute("y","10.8"),e.setAttribute("height","13.399999999999999"),s.setAttribute("y","10.8"),s.setAttribute("height","13.399999999999999"),a.setAttribute("ry","6.699999999999999"),o.setAttribute("ry","6.699999999999999")),this.snapToggle.getValue()?(h.setAttribute("y1","27"),h.setAttribute("y2","8")):(h.setAttribute("y1","24.2"),h.setAttribute("y2","10.8"))},d=tI.el({parent:this.rootEl,css:{display:"flex",justifyContent:"space-between",alignItems:"start"}}),u=new en({optionArr:[{id:"rect-stroke",label:i,title:tB("shape-rect")+" "+tB("shape-stroke")},{id:"ellipse-stroke",label:n,title:tB("shape-ellipse")+" "+tB("shape-stroke")},{id:"line",label:c,title:tB("shape-line")},{id:"rect-fill",label:r,title:tB("shape-rect")+" "+tB("shape-fill")},{id:"ellipse-fill",label:l,title:tB("shape-ellipse")+" "+tB("shape-fill")}],initId:this.shape+" "+this.mode,onChange:t=>{let e=t.split("-");this.shape=e[0],this.mode=e[1],tI.css(this.fixedToggle.getElement(),{display:"line"===this.shape?"none":""}),tI.css(this.snapToggle.getElement(),{display:"line"===this.shape?"":"none"}),tI.css(this.lineWidthSlider.getElement(),{display:"line"!==this.shape&&"fill"===this.mode?"none":""})},changeOnInit:!0});u.getElement().style.width="120px",d.append(u.getElement()),this.eraserToggle=new tF({init:!1,label:tB("eraser"),callback:()=>{p()}}),this.lockAlphaToggle=new tF({init:!1,label:tB("lock-alpha"),title:tB("lock-alpha-title"),doHighlight:!0}),this.lockAlphaToggle.getElement().style.marginTop="10px",d.append(tI.el({content:[this.eraserToggle.getElement(),this.lockAlphaToggle.getElement()]})),this.lineWidthSlider=new tQ({label:tB("shape-line-width"),width:250,height:30,min:1,max:200,value:4,curve:"quadratic",onChange:()=>{p()}}),tI.css(this.lineWidthSlider.getElement(),{marginTop:"10px"}),this.rootEl.append(this.lineWidthSlider.getElement()),this.opacitySlider=new tQ({label:tB("opacity"),width:250,height:30,min:.01,max:1,value:1,toValue:t=>t/100,toDisplayValue:t=>100*t}),tI.css(this.opacitySlider.getElement(),{marginTop:"10px"}),this.rootEl.append(this.opacitySlider.getElement());let g=tI.el({parent:this.rootEl,css:{display:"flex",alignItems:"center",marginTop:"10px"}});this.outwardsToggle=new tF({init:!1,label:tB("shape-outwards"),css:{width:"50%",marginRight:"10px"}}),g.append(this.outwardsToggle.getElement()),this.fixedToggle=new tF({init:!1,label:tB("shape-fixed"),callback:()=>{p()},css:{flexGrow:"1"}}),g.append(this.fixedToggle.getElement()),this.snapToggle=new tF({init:!1,label:tB("angle-snap"),title:tB("angle-snap-title"),callback:()=>{p()},css:{flexGrow:"1"}}),g.append(this.snapToggle.getElement()),p()}},FileTab:class{refresh(){}getElement(){return this.rootEl}setIsVisible(t){t&&this.refresh()}triggerImport(){this.importButton&&this.importButton.click()}constructor(t,e,i,s,r,a,n,o,l,h,c,p){this.exportType=s,this.rootEl=document.createElement("div"),setTimeout(()=>{let s=document.createElement("div"),d=document.createElement("button"),u=document.createElement("button"),g=document.createElement("button"),y=document.createElement("button"),f=document.createElement("button");d.style.cssFloat="left",tI.css(u,{cssFloat:"left",clear:"both",flexGrow:"1"}),tI.css(f,{cssFloat:"left",clear:"both"}),d.tabIndex=-1,u.tabIndex=-1,g.tabIndex=-1,y.tabIndex=-1,f.tabIndex=-1,d.innerHTML=`<img class="dark-no-invert" src='${m(id)}' alt='icon' height='20'/>${tB("file-new")}`,u.innerHTML=`<img src='${m(ig)}' alt='icon' height='20'/>${tB("file-save")}`,g.innerHTML=`<img src='${m(im)}' alt='icon' height='20'/>${tB("file-share")}`,y.innerHTML=`<img style='float:left' src='${m(re)}' height='20' alt='icon'/>${tB("file-upload")}`,f.innerHTML=`<img src='${m(tZ)}' alt='icon' height='20'/>${tB("file-copy")}`,f.title=tB("file-copy-title"),d.className="grid-button",u.className="grid-button",g.className="grid-button",y.className="grid-button",f.className="grid-button";let x=tI.el({className:"grid-button",css:{position:"relative",cursor:"pointer",cssFloat:"left"}}),v=tI.el({parent:x,css:{width:"120px",height:"28px",overflow:"hidden",cursor:"pointer",position:"relative"}});this.importButton=tI.el({tagName:"input",parent:v,css:{display:"none"}}),this.importButton.tabIndex=-1,this.importButton.type="file",this.importButton.multiple=!0,this.importButton.accept="image",this.importButton.size=71,this.importButton.onchange=()=>{this.importButton&&(this.importButton.files&&a(this.importButton.files,"default"),this.importButton.value="")};let b=tI.el({tagName:"button",parent:x,content:"<img class=\"dark-no-invert\" style='float:left' height='20' src='"+m(iu)+"' alt='icon'/>"+tB("file-import"),css:{width:"120px",display:"box",position:"absolute",left:"0",top:"0",cursor:"pointer"}});b.tabIndex=-1,b.onclick=()=>this.importButton&&this.importButton.click();let w=new rH.Select({optionArr:[["png","PNG"],["psd","PSD"],["layers",tB("layers")+" (PNG)"]],initValue:this.exportType,onChange:t=>{this.exportType=t,r(this.exportType),n()},title:tB("file-format")});tI.css(w.getElement(),{width:"50%",height:"30px",marginTop:"10px",marginLeft:"10px"}),d.onclick=o,u.onclick=()=>{n()},g.onclick=()=>{g.disabled=!0,l(()=>{g.disabled=!1})},y.onclick=()=>h(),f.onclick=()=>{f.blur(),c()};let C=tI.el({className:"kl-toolspace-note",textContent:tB("file-no-autosave"),css:{margin:"10px 10px 0 10px"}}),S=()=>{let t=document.createElement("div"),e=document.createElement("div"),i=tI.el({className:"grid-hr"});return t.append(e,i),tI.css(e,{clear:"both"}),t};this.fileBrowserStorage=new s9(e,i,p,t),tI.css(this.fileBrowserStorage.getElement(),{margin:"10px"});let k=tI.el({content:[u,w.getElement()],className:"kl-file-save-row"});tI.append(s,[C,d,x,tI.el({css:{clear:"both"}}),k,f,tI.canShareFiles()?g:void 0,tI.el({css:{clear:"both"}}),S(),this.fileBrowserStorage.getElement(),S(),y]),this.rootEl.append(s)},1)}},FilterTab:class{testHasWebGL(){return!!rT()}init(){let t=rH.filterLib,e=[];if(!rH.filterLibStatus.isLoaded)throw Error("filters not loaded");let i=this.testHasWebGL();if(!i){let t=tI.el({parent:this.rootEl,className:"kl-toolspace-note",content:"Features disabled because WebGL is failing.",css:{margin:"10px",marginBottom:"0"}});tI.el({parent:t,tagName:"button",textContent:"Learn More",css:{marginLeft:"5px"}}).onclick=()=>{rH.popup({target:this.klRootEl,message:"<b>WebGL is not working</b>",div:tI.el({content:`
See if your browser supports WebGL and has it enabled: <a href="https://get.webgl.org" target="_blank" rel="noopener noreferrer">get.webgl.org</a><br>
<br>
Recently (2023-05) a number of Chrome users on Chrome OS reported that WebGL fails, although it is enabled & supported.
This has been reported to Google.
`}),buttons:["Ok"],clickOnEnter:"Ok"})}}let s=s=>{let r=t[s],a=document.createElement("button"),n=tB(r.lang.button),o="<img "+(r.darkNoInvert?'class="dark-no-invert"':"")+' height="20" width="18" src="'+r.icon+'" style="margin-right: 3px" alt="icon" />';a.innerHTML=o+n,a.className="grid-button grid-button--filter",tI.css(a,{lineHeight:"20px",fontSize:"12px"}),a.tabIndex=-1;let l=tB(r.lang.name),h=!0;return r.webGL&&!i&&(h=!1),h?a.onclick=()=>{let e=(t,e)=>{let s;if(!("error"in e)){if("Cancel"==t){e.destroy&&e.destroy();return}try{s=e.getInput()}catch(t){if(-1!==t.message.indexOf(".getInput is not a function"))throw"filterDialog.getInput is not a function, filter: "+l;throw t}i(s)}};if(!("apply"in t[s])){rH.popup({target:this.klRootEl,message:"Application not fully loaded",type:"error"});return}let i=e=>{!1===t[s].apply({context:this.getCurrentLayerCtx(),klCanvas:this.getKlCanvas(),history:D,input:e})&&rH.popup({target:this.klRootEl,message:"Couldn't apply the edit action",type:"error"}),!0===t[s].updatePos&&(this.klCanvasWorkspace.resetOrFitView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())),this.layerManager.update()};if(t[s].isInstant)a.blur(),i(null),this.statusOverlay.out('"'+l+'" '+tB("filter-applied"),!0);else{let i,a,n;let o=this.klColorSlider.getSecondaryRGB();try{n=t[s].getDialog({context:this.getCurrentLayerCtx(),klCanvas:this.getKlCanvas(),maxWidth:this.getKlMaxCanvasSize(),maxHeight:this.getKlMaxCanvasSize(),currentColorRgb:{r:this.getCurrentColor().r,g:this.getCurrentColor().g,b:this.getCurrentColor().b},secondaryColorRgb:{r:o.r,g:o.g,b:o.b}})}catch(t){setTimeout(()=>{throw t})}if(!n||"error"in n){rH.popup({target:this.klRootEl,message:n?n.error:"Error: Could not perform action.",type:"error"});return}n.errorCallback=t=>{rH.popup({target:this.klRootEl,message:"Error: Could not perform action.",type:"error"}),setTimeout(()=>{throw t},0),i()};let h={};"width"in n&&(h.width=n.width+"px");{let t=[tJ("b",l)];void 0!==r.lang.description&&t.push(tJ({className:"kl-info-btn",onClick:()=>{rH.popup({target:this.klRootEl,message:tB(r.lang.description)})},title:tB(r.lang.description),noRef:!0},"?")),a=tJ(",flex,gap-5",t)}rH.popup({target:this.klRootEl,message:a,div:n.element,style:h,buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:t=>{e(t,n)},closeFunc:t=>{i=t}})}}:a.disabled=!0,e.push(a),a},r=e=>{Object.entries(t).forEach(([t,i])=>{e.includes(t)&&(!this.isEmbed||i.inEmbed)&&this.rootEl.append(s(t))})};r(["cropExtend","flip","perspective","resize","rotate","transform"]),this.rootEl.append(tI.el({className:"grid-hr"})),r(["brightnessContrast","curves","distort","hueSaturation","invert","tiltShift","toAlpha","blur","unsharpMask"]),this.rootEl.append(tI.el({className:"grid-hr"})),r(["grid","noise","pattern","vanishPoint"]),this.isInit=!0}getElement(){return this.rootEl}show(){this.isInit||this.init(),this.rootEl.style.display="block"}hide(){this.rootEl.style.display="none"}constructor(t,e,i,s,r,a,n,o,l,h,c){this.klRootEl=t,this.klColorSlider=e,this.layerManager=i,this.klCanvasWorkspace=s,this.handUi=r,this.getCurrentColor=a,this.getKlMaxCanvasSize=n,this.getKlCanvas=o,this.getCurrentLayerCtx=l,this.isEmbed=h,this.statusOverlay=c,this.isInit=!1,this.rootEl=document.createElement("div")}},SettingsTab:class{getElement(){return this.rootEl}constructor(t,e,i){this.rootEl=tI.el({css:{margin:"10px"}});let s=tD.getAutoLanguage(),r=tI.el({parent:this.rootEl,content:tI.el({content:tB("settings-language")+":",css:{marginRight:"5px",marginBottom:"2px"}}),css:{display:"flex",alignItems:"center",flexWrap:"wrap"}}),a=[["auto",tB("auto")+` \u{2192} ${s.name} (${s.code})`],...tT.map(t=>[t.code,t.name+` (${t.code})`])],n=new rH.Select({initValue:A(tw.getItem(tL)?tw.getItem(tL):"auto"),optionArr:a,onChange:t=>{"auto"===t?tw.removeItem(tL):tw.setItem(tL,t),o.style.display="block"}});tI.css(n.getElement(),{flexGrow:"1"});let o=tI.el({className:"kl-toolspace-note",content:tB("settings-language-reload"),css:{display:"none",marginTop:"5px",flexGrow:"1"}});function l(t){return"dark"===t?" "+tB("theme-dark"):" "+tB("theme-light")}r.append(n.getElement(),o);let h=new rH.Select({optionArr:[["auto",tB("auto")+"  "+l(ee.getMediaQueryTheme())],["light",l("light")],["dark",l("dark")]],initValue:ee.getStoredTheme()||"auto",onChange:t=>{ee.setStoredTheme("auto"===t?void 0:t)}});if(tI.css(h.getElement(),{flexGrow:"1"}),L(()=>{h.updateLabel("auto",tB("auto")+"  "+l(ee.getMediaQueryTheme()))}),tI.el({parent:this.rootEl,content:[tI.el({content:tB("settings-theme")+":",css:{marginRight:"5px",marginBottom:"2px"}}),h.getElement()],css:{marginTop:"15px",display:"flex",alignItems:"center",flexWrap:"wrap"}}),e){let t=new rH.Select({optionArr:[["20min",tB("x-minutes",{x:"20"})],["40min",tB("x-minutes",{x:"40"})],["disabled"," "+tB("settings-save-reminder-disabled")]],initValue:e.getSetting(),onChange:i=>{if("disabled"!==i){e.setSetting(i);return}let s=tB("settings-save-reminder-confirm-disable");tH({target:document.body,message:""+tB("settings-save-reminder-confirm-title"),div:tJ("",[tJ(".info-hint",tB("settings-save-reminder-confirm-a")),tB("settings-save-reminder-confirm-b")]),buttons:[s,"Cancel"],callback:r=>{r===s?e.setSetting(i):t.setValue(e.getSetting())}})}});t.getElement().style.flexGrow="1",this.rootEl.append(tJ(",flex,items-center,gap-5,mt-15,flexWrap",[tB("settings-save-reminder-label")+":",t.getElement()]))}function c(){return tI.el({tagName:"a",content:tB("licenses"),onClick:()=>(function(){let t=t6({display:"flex",flexDirection:"column",gap:"10px","details > div":{padding:"10px",boxShadow:"0 0 0 1px",marginTop:"5px",fontFamily:"monospace",background:"#aaa2",overflow:"hidden"},summary:{cursor:"pointer",userSelect:"none"}}),e=tJ("."+t,tB("loading")),i=tJ("."+t,tB("loading")),s=tJ(",flex,flexCol,gap-10",[e,i]);new tj({title:tI.el({content:tB("licenses")}),content:tI.el({content:s,css:{height:"100%",overflowY:"auto",padding:"10px",boxSizing:"border-box"}}),width:800,isMaxHeight:!0,onClose:()=>{"#licenses"===window.location.hash&&history.replaceState("",document.title,window.location.pathname+window.location.search)}}),x("cMiRD").then(t=>{e.innerHTML="",t.licenses.forEach(t=>{e.append(tJ("details",[tJ("summary",t.title),tJ("",t.full.replace(/\n/g,"<br>"))]))})}),x("5goSP").then(t=>{i.innerHTML="",t.fontLicenses.forEach(t=>{i.append(tJ("details",[tJ("summary","Font: "+t.title),tJ("",t.full.replace(/\n/g,"<br>"))]))})})})()})}tI.el({tagName:"button",parent:this.rootEl,content:'<img height="20" width="18" src="'+m(rV)+'" alt="icon" style="margin-right: 5px"/>'+tB("switch-ui-left-right"),onClick:()=>t(),css:{marginTop:"15px"},custom:{tabIndex:"-1"}}),this.rootEl.append(tI.el({className:"grid-hr",css:{margin:"10px 0"}})),i?(this.rootEl.append(i),i.innerHTML||tI.el({parent:i,css:{textAlign:"center"}}).append(tI.el({content:`<img alt="icon" height="20" style="vertical-align:middle" src="${m(rz)}"> <a href="https://bitbof.com" target="_blank" tabIndex="-1">bitbof</a> \xa9 2023<br>`}),c())):tI.el({parent:this.rootEl,css:{textAlign:"center"},content:`
<img alt="Klecks" class="dark-invert" height="25" src="${m(ip)}"><br>
<img alt="icon" height="20" style="vertical-align:middle" src="${m(rz)}"> <a href="https://bitbof.com" target="_blank" tabIndex="-1">bitbof</a> \xa9 2023<br>`}).append(c(),document.createTextNode(" | "),tI.el({tagName:"a",content:tB("donate"),custom:{href:"https://kleki.com/donate/",target:"_blank"}}),document.createTextNode(" | "),tI.el({tagName:"a",content:tB("source-code"),custom:{href:"https://klecks.org",target:"_blank"}})),window.addEventListener("storage",t=>{t.key===tL&&n.setValue(A(tw.getItem(tL)?tw.getItem(tL):"auto"))})}},LayerManager:class{move(t,e){if(isNaN(t)||isNaN(e))throw"layermanager - invalid move";for(let i=0;i<this.klCanvasLayerArr.length;i++)(i=>{let s=this.layerElArr[i].spot;this.layerElArr[i].spot===t?s=e:(this.layerElArr[i].spot>t&&s--,s>=e&&s++),this.layerElArr[i].spot=s,this.layerElArr[i].posY=(this.layerHeight+this.layerSpacing)*(this.klCanvasLayerArr.length-s-1),this.layerElArr[i].style.top=this.layerElArr[i].posY+"px"})(i);t!==e&&(this.klCanvas.moveLayer(this.selectedSpotIndex,e-t),this.klCanvasLayerArr=this.klCanvas.getLayers(),this.selectedSpotIndex=e,this.mergeBtn.disabled=0===this.selectedSpotIndex)}posToSpot(t){let e=parseInt(""+(t/(this.layerHeight+this.layerSpacing)+.5));return e=Math.min(this.klCanvasLayerArr.length-1,Math.max(0,e)),e=this.klCanvasLayerArr.length-e-1}updateLayersVerticalPosition(t,e){if((e=Math.min(this.klCanvasLayerArr.length-1,Math.max(0,e)))!==this.lastpos){for(let i=0;i<this.klCanvasLayerArr.length;i++){if(this.layerElArr[i].spot===t)continue;let s=this.layerElArr[i].spot;this.layerElArr[i].spot>t&&s--,s>=e&&s++,this.layerElArr[i].posY=(this.layerHeight+this.layerSpacing)*(this.klCanvasLayerArr.length-s-1),this.layerElArr[i].style.top=this.layerElArr[i].posY+"px"}this.lastpos=e}}renameLayer(t){!function(t,e,i){let s=tI.el(),r=tI.el({content:tB("layers-rename-name")+":",css:{marginRight:"5px"}}),a=tI.el({css:{display:"flex"}}),n=tI.el({tagName:"input"});n.value=e,n.setAttribute("data-ignore-focus","true");let o=tI.el({tagName:"button",content:'<img src="'+m(eY)+'" height="20"/>',title:tB("layers-rename-clear"),css:{marginLeft:"10px"},onClick:()=>{n.value="",n.focus()}}),l=[tB("layers-rename-sketch"),tB("layers-rename-colors"),tB("layers-rename-shading"),tB("layers-rename-lines"),tB("layers-rename-effects"),tB("background"),tB("layers-rename-foreground")],h=[],c=tI.el({css:{display:"flex",flexWrap:"wrap",marginTop:"5px",marginLeft:"-5px"}});l.forEach(t=>{let e=tI.el({parent:c,tagName:"button",content:t,onClick:()=>{n.value=""+e.textContent},css:{margin:"5px 0 0 5px"}});h.push(e)}),s.append(r),r.append(a,c),a.append(n,o),setTimeout(()=>{n.focus(),n.select()},10),tH({target:t,message:`<b>${tB("layers-rename-title")}</b>`,div:s,buttons:[tB("layers-rename"),"Cancel"],primaries:[tB("layers-rename")],callback:t=>{tI.destroyEl(o),h.forEach(t=>{tI.destroyEl(t)}),h.splice(0,h.length),t===tB("layers-rename")?i(n.value):i(void 0)},clickOnEnter:tB("layers-rename")})}(this.parentEl,this.klCanvas.getLayer(t).name,e=>{void 0!==e&&e!==this.klCanvas.getLayer(t).name&&(this.klCanvas.renameLayer(t,e),this.createLayerList(),D.pause(!0),this.onSelect(t),D.pause(!1))})}updateHeight(){this.layerListEl.style.height=35*this.layerElArr.length+"px"}createLayerList(){this.oldHistoryState=D.getState(),this.klCanvasLayerArr=this.klCanvas.getLayers();let t=tI.createCheckerDataUrl(4,void 0,ee.isDark()),e=e=>{let i;let s=E(this.klCanvas.getLayer(e)),r=s.name,a=this.klCanvasLayerArr[e].opacity,n=s.isVisible,o=this.klCanvasLayerArr[e].context.canvas,l=tI.el({className:"kl-layer"});this.layerElArr[e]=l,l.posY=(this.klCanvasLayerArr.length-1)*35-35*e,tI.css(l,{top:l.posY+"px"});let h=tI.el();tI.css(h,{position:"relative"});let c=tI.el();tI.css(c,{width:"270px",height:"34px"});let p=tI.el();l.append(h),h.append(c,p),l.spot=e;{let t=tI.el({tagName:"label",parent:c,title:tB("layers-visibility-toggle"),css:{display:"flex",width:"25px",height:"100%",justifyContent:"right",alignItems:"center",cursor:"pointer"}}),e=tI.el({tagName:"input",parent:t,custom:{type:"checkbox",tabindex:"-1"},css:{display:"block",cursor:"pointer",margin:"0",marginRight:"5px"}});e.checked=n,e.onchange=()=>{this.klCanvas.setLayerIsVisible(l.spot,e.checked),this.createLayerList(),l.spot===this.selectedSpotIndex&&(D.pause(!0),this.onSelect(this.selectedSpotIndex),D.pause(!1))};let i=t=>{t.preventDefault(),t.stopPropagation()};V?t.onpointerdown=i:t.onmousedown=i}{let e=tI.fitInto(o.width,o.height,30,30,1);l.thumb=tI.canvas(e.width,e.height);let i=tI.ctx(l.thumb);i.save(),l.thumb.width>o.width&&(i.imageSmoothingEnabled=!1),i.drawImage(o,0,0,l.thumb.width,l.thumb.height),i.restore(),tI.css(l.thumb,{position:"absolute",left:(32-l.thumb.width)/2+25+"px",top:(32-l.thumb.height)/2+1+"px"}),l.thumb.style.backgroundImage="url("+t+")"}l.label=tI.el({className:"kl-layer__label"}),l.layerName=r,l.label.append(l.layerName),tI.css(l.label,{position:"absolute",left:"63px",top:"1px",fontSize:"13px",width:"170px",height:"20px",overflow:"hidden",whiteSpace:"nowrap"}),l.label.ondblclick=()=>{this.renameLayer(l.spot)},l.opacityLabel=tI.el({className:"kl-layer__opacity-label"}),l.opacity=a,l.opacityLabel.append(parseInt(""+100*l.opacity)+"%"),tI.css(l.opacityLabel,{position:"absolute",left:"214px",top:"1px",fontSize:"13px",textAlign:"right",width:"50px",transition:"color 0.2s ease-in-out",textDecoration:n?void 0:"line-through"});let d=new er({init:l.opacity,width:200,pointSize:14,callback:(t,e,s)=>{if(e){i=this.klCanvas.getLayer(l.spot).opacity,D.pause(!0);return}if(s){D.pause(!1),i!==t&&this.klCanvas.layerOpacity(l.spot,t);return}l.opacityLabel.innerHTML=Math.round(100*t)+"%",this.klCanvas.layerOpacity(l.spot,t)}});tI.css(d.getEl(),{position:"absolute",left:"64px",top:"17px"}),l.opacitySlider=d,l.thumb.onpointerover=t=>{if(0!==t.buttons&&(!t.pointerType||"touch"!==t.pointerType))return;let e=tI.fitInto(o.width,o.height,250,250,1);(this.largeThumbCanvas.width!==e.width||this.largeThumbCanvas.height!==e.height)&&(this.largeThumbCanvas.width=e.width,this.largeThumbCanvas.height=e.height);let i=tI.ctx(this.largeThumbCanvas);i.save(),this.largeThumbCanvas.width>o.width&&(i.imageSmoothingEnabled=!1),i.imageSmoothingQuality="high",i.clearRect(0,0,this.largeThumbCanvas.width,this.largeThumbCanvas.height),i.drawImage(o,0,0,this.largeThumbCanvas.width,this.largeThumbCanvas.height),i.restore(),tI.css(this.largeThumbDiv,{top:t.clientY-this.largeThumbCanvas.height/2+"px",opacity:"0"}),this.largeThumbInDocument||(document.body.append(this.largeThumbDiv),this.largeThumbInDocument=!0),clearTimeout(this.largeThumbInTimeout),this.largeThumbInTimeout=setTimeout(()=>{tI.css(this.largeThumbDiv,{opacity:"1"})},20),clearTimeout(this.largeThumbTimeout)},l.thumb.onpointerout=()=>{clearTimeout(this.largeThumbInTimeout),tI.css(this.largeThumbDiv,{opacity:"0"}),clearTimeout(this.largeThumbTimeout),this.largeThumbTimeout=setTimeout(()=>{this.largeThumbInDocument&&(this.largeThumbDiv.remove(),this.largeThumbInDocument=!1)},300)},c.append(l.thumb,l.label,l.opacityLabel,d.getEl());let u=!1,g=!1;l.pointerListener=new tI.PointerListener({target:c,onPointer:t=>{if("pointerdown"===t.type&&"left"===t.button)tI.css(l,{transition:"box-shadow 0.3s ease-in-out"}),l.style.zIndex="1",this.lastpos=l.spot,g=!1,l.isSelected||(g=!0,this.activateLayer(l.spot)),u=!0;else if("pointermove"===t.type&&"left"===t.button){u&&(u=!1,tI.css(l,{boxShadow:"1px 3px 5px rgba(0,0,0,0.4)"})),l.posY+=t.dY;let e=Math.max(0,Math.min((this.klCanvasLayerArr.length-1)*35,l.posY));l.style.top=e+"px",this.updateLayersVerticalPosition(l.spot,this.posToSpot(l.posY))}if("pointerup"===t.type){tI.css(l,{transition:"all 0.1s linear"}),setTimeout(()=>{tI.css(l,{boxShadow:""})},20),l.posY=Math.max(0,Math.min((this.klCanvasLayerArr.length-1)*35,l.posY)),l.style.zIndex="";let t=this.posToSpot(l.posY),e=l.spot;this.move(l.spot,t),e!=t&&(D.pause(!0),this.onSelect(this.selectedSpotIndex),D.pause(!1)),e===t&&g&&this.onSelect(this.selectedSpotIndex),g=!1}}}),this.layerListEl.append(l)};for(this.layerElArr=[];this.layerListEl.firstChild;){let t=this.layerListEl.firstChild;t.pointerListener.destroy(),t.opacitySlider.destroy(),t.remove()}for(let t=0;t<this.klCanvasLayerArr.length;t++)e(t);this.activateLayer(this.selectedSpotIndex),this.updateHeight()}updateButtons(){let t=16===this.klCanvasLayerArr.length,e=1===this.klCanvasLayerArr.length;this.addBtn.disabled=t,this.removeBtn.disabled=e,this.duplicateBtn.disabled=t,this.mergeBtn.disabled=0===this.selectedSpotIndex,this.moreDropdown.setEnabled("merge-all",!e)}update(t){this.klCanvasLayerArr=this.klCanvas.getLayers(),(t||0===t)&&(this.selectedSpotIndex=t),this.updateButtons(),setTimeout(()=>this.createLayerList(),1)}getSelected(){return this.selectedSpotIndex}activateLayer(t){if(t<0||t>this.layerElArr.length-1)throw"invalid spotIndex "+t+", layerElArr.length "+this.layerElArr.length;this.selectedSpotIndex=t,this.modeSelect.setValue(this.klCanvasLayerArr[this.selectedSpotIndex].mixModeStr);for(let t=0;t<this.layerElArr.length;t++){let e=this.layerElArr[t],i=this.selectedSpotIndex===e.spot;tI.css(e,{boxShadow:""}),e.classList.toggle("kl-layer--selected",i),e.opacitySlider.setActive(i),e.isSelected=i}this.mergeBtn.disabled=0===this.selectedSpotIndex}setUiState(t){this.uiState=t,"left"===this.uiState?tI.css(this.largeThumbDiv,{left:"280px",right:""}):tI.css(this.largeThumbDiv,{left:"",right:"280px"})}getElement(){return this.rootEl}constructor(t,e,i,s){let r;this.lastpos=0,this.layerHeight=35,this.layerSpacing=0,this.parentEl=i,this.klCanvas=t,this.layerElArr=[],this.layerHeight=35,this.layerSpacing=0,this.onSelect=e,this.uiState=s,this.largeThumbDiv=tI.el({onClick:tI.handleClick,css:{position:"absolute",top:"500px",background:"#aaa",boxShadow:"1px 1px 3px rgba(0,0,0,0.3)",pointerEvents:"none",padding:"0",border:"1px solid #aaa",transition:"opacity 0.3s ease-out",userSelect:"none"}}),this.setUiState(s),tI.createCheckerDataUrl(4,t=>{this.largeThumbDiv.style.backgroundImage="url("+t+")"},ee.isDark()),this.largeThumbCanvas=tI.canvas(200,200),this.largeThumbCanvas.style.display="block",this.largeThumbDiv.append(this.largeThumbCanvas),this.largeThumbInDocument=!1,this.klCanvasLayerArr=this.klCanvas.getLayers(),this.selectedSpotIndex=this.klCanvasLayerArr.length-1,this.rootEl=tI.el({css:{marginRight:"10px",marginBottom:"10px",marginLeft:"10px",marginTop:"10px",cursor:"default"}});let a=tI.el({css:{width:"270px",position:"relative",margin:"0 -10px",zIndex:"0"}});this.layerListEl=tI.el({parent:a}),this.addBtn=tI.el({tagName:"button"}),this.duplicateBtn=tI.el({tagName:"button"}),this.mergeBtn=tI.el({tagName:"button"}),this.removeBtn=tI.el({tagName:"button"});let n=tI.el({tagName:"button"});this.moreDropdown=new eX({button:tI.el({content:`<img src="${m(eQ)}" width="13"/>`,css:{display:"flex",justifyContent:"center",opacity:"0.9"}}),buttonTitle:tB("more"),items:[["merge-all",tB("layers-merge-all")]],onItemClick:t=>{if("merge-all"===t){let t=this.klCanvas.mergeAll();!1!==t&&(this.klCanvasLayerArr=this.klCanvas.getLayers(),this.selectedSpotIndex=t,this.createLayerList(),D.pause(!0),this.onSelect(this.selectedSpotIndex),D.pause(!1),this.updateButtons())}}}),this.updateButtons(),this.rootEl.append((()=>{let t=tI.el();return setTimeout(()=>{tI.makeUnfocusable(this.addBtn),tI.makeUnfocusable(this.duplicateBtn),tI.makeUnfocusable(this.mergeBtn),tI.makeUnfocusable(this.removeBtn),tI.makeUnfocusable(n),this.addBtn.style.cssFloat="left",this.duplicateBtn.style.cssFloat="left",this.mergeBtn.style.cssFloat="left",this.removeBtn.style.cssFloat="left",n.style.cssFloat="left",this.addBtn.title=tB("layers-new"),this.duplicateBtn.title=tB("layers-duplicate"),this.removeBtn.title=tB("layers-remove"),this.mergeBtn.title=tB("layers-merge"),n.title=tB("layers-rename-title"),this.addBtn.style.paddingLeft="5px",this.addBtn.style.paddingRight="3px",this.removeBtn.style.paddingLeft="5px",this.removeBtn.style.paddingRight="3px",this.duplicateBtn.style.paddingLeft="5px",this.duplicateBtn.style.paddingRight="3px",this.mergeBtn.style.paddingLeft="5px",this.mergeBtn.style.paddingRight="3px",n.style.height="30px",n.style.lineHeight="20px",this.addBtn.innerHTML="<img src='"+m(eG)+"' height='20'/>",this.duplicateBtn.innerHTML="<img src='"+m(eK)+"' height='20'/>",this.mergeBtn.innerHTML="<img src='"+m(eq)+"' height='20'/>",this.removeBtn.innerHTML="<img src='"+m(eY)+"' height='20'/>",n.innerHTML="<img src='"+m(e$)+"' height='20'/>",t.append(tJ(",flex,gap-5,mb-10",[this.addBtn,this.removeBtn,this.duplicateBtn,this.mergeBtn,n,tJ(",grow-1"),this.moreDropdown.getElement()])),this.addBtn.onclick=()=>{!1!==this.klCanvas.addLayer(this.selectedSpotIndex)&&(this.klCanvasLayerArr=this.klCanvas.getLayers(),this.selectedSpotIndex=this.selectedSpotIndex+1,this.createLayerList(),D.pause(!0),this.onSelect(this.selectedSpotIndex),D.pause(!1),this.updateButtons())},this.duplicateBtn.onclick=()=>{!1!==this.klCanvas.duplicateLayer(this.selectedSpotIndex)&&(this.klCanvasLayerArr=this.klCanvas.getLayers(),this.selectedSpotIndex++,this.createLayerList(),D.pause(!0),this.onSelect(this.selectedSpotIndex),D.pause(!1),this.updateButtons())},this.removeBtn.onclick=()=>{this.layerElArr.length<=1||(this.klCanvas.removeLayer(this.selectedSpotIndex),this.selectedSpotIndex>0&&this.selectedSpotIndex--,this.klCanvasLayerArr=this.klCanvas.getLayers(),this.createLayerList(),D.pause(!0),this.onSelect(this.selectedSpotIndex),D.pause(!1),this.updateButtons())},this.mergeBtn.onclick=()=>{this.selectedSpotIndex<=0||function(t,e){let i=tI.el();i.innerHTML=tB("layers-merge-description");let s=new en({optionArr:[{id:e.mixModeStr,label:e_(e.mixModeStr)},{id:"source-in",label:"source-in"},{id:"source-out",label:"source-out"},{id:"source-atop",label:"source-atop"},{id:"destination-in",label:"destination-in"},{id:"destination-out",label:"destination-out"},{id:"destination-atop",label:"destination-atop"},{id:"xor",label:"xor"}],initId:e.mixModeStr,onChange:()=>{h()},isSmall:!0});s.getElement().style.marginTop="5px",i.append(s.getElement());let r=tI.fitInto(e.topCanvas.width,e.topCanvas.height,200,200,1),a=tI.canvas(r.width,r.height);a.title=tB("preview"),a.className="kl-merge-preview";let n=tI.el({content:"<br/>",css:{clear:"both"}});function o(){tI.createCheckerDataUrl(4,t=>{a.style.backgroundImage="url("+t+")"},ee.isDark())}i.append(n,a),o(),ee.addIsDarkListener(o);let l=tI.copyCanvas(a);tI.ctx(l).drawImage(e.topCanvas,0,0,l.width,l.height),tI.convertToAlphaChannelCanvas(l);let h=()=>{let t=tI.ctx(a);t.save(),t.clearRect(0,0,a.width,a.height),a.width>e.topCanvas.width&&(t.imageSmoothingEnabled=!1),t.drawImage(e.bottomCanvas,0,0,a.width,a.height),"as-alpha"===s.getValue()?(t.globalCompositeOperation="destination-in",t.globalAlpha=e.topOpacity,t.drawImage(l,0,0,a.width,a.height)):(t.globalCompositeOperation=s.getValue(),t.globalAlpha=e.topOpacity,t.drawImage(e.topCanvas,0,0,a.width,a.height)),t.restore()};h();let c=new tI.KeyListener({onDown:t=>{"right"===t&&s.next(),"left"===t&&s.previous()}});tH({target:t,message:`<b>${tB("layers-merge-modal-title")}</b>`,div:i,buttons:["Ok","Cancel"],clickOnEnter:"Ok",callback:t=>{c.destroy(),s.destroy(),ee.removeIsDarkListener(o),"Ok"===t&&e.callback(s.getValue())}})}(this.parentEl,{topCanvas:this.klCanvasLayerArr[this.selectedSpotIndex].context.canvas,bottomCanvas:this.klCanvasLayerArr[this.selectedSpotIndex-1].context.canvas,topOpacity:this.klCanvas.getLayer(this.selectedSpotIndex).opacity,mixModeStr:this.klCanvasLayerArr[this.selectedSpotIndex].mixModeStr,callback:t=>{this.klCanvas.mergeLayers(this.selectedSpotIndex,this.selectedSpotIndex-1,t),this.klCanvasLayerArr=this.klCanvas.getLayers(),this.selectedSpotIndex--,this.createLayerList(),D.pause(!0),this.onSelect(this.selectedSpotIndex),D.pause(!1),this.updateButtons()}})},n.onclick=()=>{this.renameLayer(this.selectedSpotIndex)}},1),t})()),r=tI.el({content:tB("layers-blending")+"&nbsp;",css:{fontSize:"15px"}}),this.modeSelect=new tN({optionArr:["source-over",void 0,"darken","multiply","color-burn",void 0,"lighten","screen","color-dodge",void 0,"overlay","soft-light","hard-light",void 0,"difference","exclusion",void 0,"hue","saturation","color","luminosity"].map(t=>t?[t,e_(t)]:void 0),onChange:t=>{this.klCanvas.setMixMode(this.selectedSpotIndex,t),this.update(this.selectedSpotIndex)},css:{marginBottom:"10px"}}),r.append(this.modeSelect.getElement()),this.rootEl.append(r),this.rootEl.append(a),setInterval(()=>{if("block"!==this.rootEl.style.display)return;let t=D.getState();if(t!==this.oldHistoryState){this.oldHistoryState=t;for(let t=0;t<this.layerElArr.length;t++)if(this.selectedSpotIndex===this.layerElArr[t].spot&&this.klCanvasLayerArr[this.layerElArr[t].spot]){let e=tI.ctx(this.layerElArr[t].thumb);e.save(),e.clearRect(0,0,e.canvas.width,e.canvas.height),this.klCanvasLayerArr[this.layerElArr[t].spot].context.canvas.width<this.layerElArr[t].thumb.width&&(e.imageSmoothingEnabled=!1),e.drawImage(this.klCanvasLayerArr[this.layerElArr[t].spot].context.canvas,0,0,this.layerElArr[t].thumb.width,this.layerElArr[t].thumb.height),e.restore()}}},1),ee.addIsDarkListener(()=>{this.createLayerList()}),this.createLayerList()}},klHistory:D,DecoyKlHistory:P};Object.keys(rH);class rj{getElement(){return this.rootEl}constructor(t){function e(t){let e=6+(t.extraPadding?t.extraPadding:0),i=tI.el({className:"toolspace-row-button nohighlight",title:t.title,onClick:t.onClick,css:{padding:t.content?"":t.contain?e+"px 0":""}});if(t.content)i.append(t.content);else{let e=tI.el({className:"dark-invert",css:{backgroundImage:"url('"+t.image+"')",backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundSize:t.contain?"contain":"",height:"100%"}});e.style.pointerEvents="none",i.append(e)}let s=new tI.PointerListener({target:i,onEnterLeave:function(t){i.classList.toggle("toolspace-row-button-hover",t)}});return{el:i,pointerListener:s}}this.rootEl=tI.el({className:"kl-toolspace-row",css:{height:"36px",display:"flex"}});let i=e({onClick:t.onSubmit,title:tB("submit-title"),content:tI.el({content:tB("submit"),className:"toolspace-row-button__submit",css:{display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"100%"}}),contain:!0});i.el.style.width="45px";let s=e({onClick:t.onHelp,title:tB("help"),image:m(iy),contain:!0}),r=e({onClick:t.onLeftRight,title:tB("switch-ui-left-right"),image:m(rV),contain:!0});this.rootEl.append(i.el,r.el,s.el)}}class rF{setPostMix(t){this.postMix=t}destroy(){tI.freeCanvas(this.textureSource),this.texture&&(this.texture=this.fxCanvas.texture(this.textureSource),this.fxCanvas.draw(this.texture).update(),this.texture&&this.texture.destroy())}constructor(t){this.texture=void 0,this.oldOnUpdateProps={textureWidth:0,textureHeight:0,transform:{scaleX:0,scaleY:0,angleDeg:0,x:0,y:0}},this.render=(t,e,i)=>{let s;let r=eC(t);{let t=el(r,{x:0,y:0}),a=el(r,{x:this.original.width,y:this.original.height});a.x=Math.round(a.x),a.y=Math.round(a.y);let n={x:Math.max(0,t.x),y:Math.max(0,t.y)},o={x:Math.min(e-0,a.x),y:Math.min(i-0,a.y)};if((s={x:n.x,y:n.y,width:o.x-n.x,height:o.y-n.y}).width<=0||s.height<=0)return this.textureSource.width=1,this.textureSource.height=1,this.textureSource}let a=eu(eh(r),ep(0,0),ep(s.x-0,s.y-0)),n={textureWidth:Math.ceil(s.width),textureHeight:Math.ceil(s.height),transform:{scaleX:t.scaleX,scaleY:t.scaleY,angleDeg:t.angleDeg,x:t.x-s.x,y:t.y-s.y}},o=0,l=0;if(t.scaleX>1){let e=el(a,{x:0,y:0});o=-e.x,l=-e.y,e.x=Math.max(0,Math.floor(e.x)),e.y=Math.max(0,Math.floor(e.y)),o+=e.x,l+=e.y;let i=el(a,{x:s.width,y:s.height});i.x=Math.min(this.original.width,Math.ceil(i.x)),i.y=Math.min(this.original.height,Math.ceil(i.y));let r=i.x-e.x,h=i.y-e.y;n.textureWidth=r,n.textureHeight=h,n.transform={scaleX:1,scaleY:1,angleDeg:0,x:-e.x,y:-e.y},a=eu(a,ex(t.scaleX,t.scaleY),ep(o,l))}this.texture&&JSON.stringify(n)===JSON.stringify(this.oldOnUpdateProps)&&!this.postMix||(this.textureSource.width=n.textureWidth,this.textureSource.height=n.textureHeight,this.ctx.save(),this.ctx.imageSmoothingEnabled=!1,t.scaleX>1?this.ctx.setTransform(eC(n.transform)):this.ctx.setTransform(eh(a)),this.ctx.drawImage(this.original,0,0),this.ctx.restore(),this.texture&&JSON.stringify(n)===JSON.stringify(this.oldOnUpdateProps)||(this.texture&&this.texture.destroy(),this.texture=this.fxCanvas.texture(this.textureSource)),this.postMix||(this.textureSource.width=1,this.textureSource.height=1)),this.oldOnUpdateProps=n;let h=this.onUpdate(this.fxCanvas.draw(this.texture),n.transform).update();return this.postMix?(this.ctx.save(),this.ctx.globalAlpha=this.postMix.opacity,this.ctx.globalCompositeOperation=this.postMix.operation,this.ctx.drawImage(h,0,0),this.ctx.restore(),{image:this.textureSource,transform:a}):{image:h,transform:a}},this.original=t.original,this.onUpdate=t.onUpdate,this.textureSource=tI.canvas(1,1),this.ctx=tI.ctx(this.textureSource),this.fxCanvas=E(rT()),this.postMix=t.postMix}}function rW(){return tI.copyObj({r:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],g:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]],b:[[0,0],[1/3,1/3],[2/3,2/3],[1,1]]})}class rU{getElement(){return this.rootEl}destroy(){this.p0.pointerListener.destroy(),this.p1.pointerListener.destroy(),this.p2.pointerListener.destroy(),this.p3.pointerListener.destroy()}getModeButtons(){return this.modeButtons}constructor(t){this.rootEl=tI.el({css:{position:"relative",marginBottom:"10px"}}),this.rootEl.oncontextmenu=()=>!1;let e="All",i=t.curves;this.modeButtons=new en({optionArr:[{id:"All",label:tB("filter-curves-all")},{id:"Red",label:tB("red")},{id:"Green",label:tB("green")},{id:"Blue",label:tB("blue")}],initId:"All",onChange:t=>{"All"===(e=t)&&(i=rW());let s=i.r;"Green"===e&&(s=i.g),"Blue"===e&&(s=i.b),this.p0.setPos(0,a-s[0][1]*a),this.p1.setPos(s[1][0]*r,a-s[1][1]*a),this.p2.setPos(s[2][0]*r,a-s[2][1]*a),this.p3.setPos(r,a-s[3][1]*a),p()}}),this.rootEl.append(this.modeButtons.getElement());let s=tI.el({parent:this.rootEl,className:"kl-curves-graph",css:{position:"relative",marginTop:"10px"}}),r=300,a=100,n=tI.canvas(r,a),o=tI.ctx(n);s.append(n);let l=t=>Math.max(0,Math.min(1,t)),h=(t,e,i,n)=>{let o=e,l=t,h=tI.el({className:"kl-curves-graph__grip",css:{left:t-7+"px",top:e-7+"px",width:"14px",height:"14px",borderRadius:"14px"}}),c=()=>{tI.css(h,{left:t-7+"px",top:e-7+"px"})},p=new tI.PointerListener({target:h,onPointer:s=>{s.eventPreventDefault(),"pointerdown"===s.type&&(l=t,o=e),"left"===s.button&&"pointermove"===s.type&&(n||(l+=s.dX),t=Math.max(0,Math.min(r,l)),o+=s.dY,e=Math.max(0,Math.min(a,o)),c(),i({x:t,y:e}))}});return s.append(h),{el:h,setPos:(i,s)=>{t=i,o=e=s,l=t,tI.css(h,{left:t-7+"px",top:e-7+"px"})},pointerListener:p}},c=(t,s,n)=>{"All"===e&&(i.r[t]=[l(s/r),l(1-n/a)],i.g[t]=[l(s/r),l(1-n/a)],i.b[t]=[l(s/r),l(1-n/a)]),"Red"===e&&(i.r[t]=[l(s/r),l(1-n/a)]),"Green"===e&&(i.g[t]=[l(s/r),l(1-n/a)]),"Blue"===e&&(i.b[t]=[l(s/r),l(1-n/a)])};this.p0=h(0,a,t=>{c(0,t.x,t.y),p()},!0),this.p1=h(r/3,a/3*2,t=>{c(1,t.x,t.y),p()}),this.p2=h(r/3*2,a/3,t=>{c(2,t.x,t.y),p()}),this.p3=h(r,0,t=>{c(3,t.x,t.y),p()},!0);let p=()=>{(o=tI.ctx(n)).clearRect(0,0,n.width,n.height);let s={r:[],g:[],b:[]};for(let t=0;t<i.r.length;t++)s.r.push(i.r[t]),s.g.push(i.g[t]),s.b.push(i.b[t]);let l=t=>{o.beginPath();let e=new tI.SplineInterpolator(t);for(let t=0;t<100;t++){let i=e.interpolate(t/100);i=Math.max(0,Math.min(1,i)),0===t?o.moveTo(t/100*r,a-i*a):o.lineTo(t/100*r,a-i*a)}o.stroke()};o.save(),"All"===e?(o.strokeStyle="black",l(s.r)):(o.globalAlpha=.5,o.strokeStyle="red",l(s.r),o.strokeStyle="green",l(s.g),o.strokeStyle="blue",l(s.b)),o.restore(),t.callback(s)};p()}}class rN{update(){this.leftTab.classList.toggle("kl-2-tabs--active",0===this.value),this.rightTab.classList.toggle("kl-2-tabs--active",1===this.value)}getElement(){return this.rootEl}constructor(t){this.value=t.init,this.rootEl=tI.el({className:"kl-2-tabs"}),this.leftTab=tI.el({parent:this.rootEl,content:t.left,className:"kl-2-tabs__left"}),this.leftTab.onpointerdown=()=>!1,this.rightTab=tI.el({parent:this.rootEl,content:t.right,className:"kl-2-tabs__right"}),this.rightTab.onpointerdown=()=>!1,this.update(),this.leftTab.onclick=()=>{0!==this.value&&(this.value=0,this.update(),t.onChange(this.value))},this.rightTab.onclick=()=>{1!==this.value&&(this.value=1,this.update(),t.onChange(this.value))}}}class r_{update(){let t=el(eC(this.transform),this.value);tI.css(this.rootEl,{left:t.x-8+"px",top:t.y-8+"px"})}setTransform(t){JSON.stringify(this.transform)!==JSON.stringify(t)&&(this.transform=t,this.update())}getValue(){return this.value}setValue(t){this.value={...t},this.update()}getElement(){return this.rootEl}destroy(){this.rootEl.remove(),this.pointerListener.destroy()}constructor(t){this.value={...t.value},this.transform={x:0,y:0,scale:1,angleDeg:0},this.rootEl=tI.el({css:{width:"16px",height:"16px",backgroundColor:"#fff",border:"2px solid #000",borderRadius:"16px",position:"absolute",cursor:"move",userSelect:"none",touchAction:"none"}}),this.pointerListener=new tI.PointerListener({target:this.rootEl,onPointer:e=>{e.eventPreventDefault(),"left"===e.button&&"pointermove"===e.type&&(this.value.x+=e.dX/this.transform.scale,this.value.y+=e.dY/this.transform.scale,this.update(),t.onChange(this.value))}})}}var rY={};function rX(t,e,i,s,r,a){t.save();let n=t.canvas.width,o=t.canvas.height,l=(s=Math.round(s))%2==0;t.beginPath(),t.lineWidth=s,t.strokeStyle=r,t.globalAlpha=a;for(let i=0;i<e-1;i++){let s=n/e*(i+1);s=l?Math.round(s):Math.round(s+.5)-.5,t.moveTo(s,0),t.lineTo(s,o)}for(let e=0;e<i-1;e++){let s=o/i*(e+1);s=l?Math.round(s):Math.round(s+.5)-.5,t.moveTo(0,s),t.lineTo(n,s)}t.stroke(),t.restore()}rY=x("dwTKp").getBundleURL("lrLBb")+"constrain.62f04e45.svg";const rG=[{type:0,scaleX:1,scaleY:1,offsetX:0,offsetY:0,octaves:1,samples:1,peaks:0,brightness:0,contrast:0,isReversed:!0},{type:1,scaleX:166,scaleY:164,offsetX:105,offsetY:30,octaves:6,samples:1,peaks:0,brightness:.055,contrast:.23,isReversed:!0},{type:1,scaleX:235,scaleY:190,offsetX:3227,offsetY:2156,octaves:4,samples:16,peaks:22,brightness:-.375,contrast:1,isReversed:!1},{type:1,scaleX:40,scaleY:40,offsetX:0,offsetY:0,octaves:1,samples:1,peaks:0,brightness:0,contrast:0,isReversed:!1},{type:0,scaleX:26,scaleY:26,offsetX:557,offsetY:365,octaves:1,samples:1,peaks:0,brightness:.02,contrast:1,isReversed:!0},{type:1,scaleX:1500,scaleY:1500,offsetX:745,offsetY:2871,octaves:5,samples:16,peaks:156.02,brightness:.03,contrast:1,isReversed:!0},{type:1,scaleX:11,scaleY:11,offsetX:2940,offsetY:2045,octaves:1,samples:16,peaks:1,brightness:-.045,contrast:1,isReversed:!0},{type:2,scaleX:74,scaleY:74,offsetX:4816,offsetY:1304,octaves:3,samples:1,peaks:2.78,brightness:0,contrast:0,isReversed:!1}];function rK(t,e){t.noise(e.seed,e.type,[e.scaleX,e.scaleY],[t.width/2,t.height/2],e.octaves,e.samples,e.peaks,e.brightness,e.contrast,e.isReversed,e.colA,e.colB,e.channels?e.channels:"rgb").update()}function rq(t,e){let i=e.blend?Math.round(e.blend*e.width/2):0,s=e.blend?Math.round(e.blend*e.height/2):0,r=tI.canvas(e.width,e.height);if(e.blend){let a=tI.canvas(2*e.width,2*e.height),n=tI.ctx(a),o="#0000",l="#000";n.drawImage(t.canvas,-e.x+i,-e.y+s),n.save();let h=n.createLinearGradient(0,e.height,0,2*e.height);h.addColorStop(0,l),h.addColorStop(e.blend,o),n.globalCompositeOperation="destination-in",n.fillStyle=h,n.fillRect(0,0,a.width,a.height),n.restore(),n.save(),(h=n.createLinearGradient(0,0,0,e.height)).addColorStop(0,o),h.addColorStop(e.blend,l),n.globalCompositeOperation="destination-in",n.fillStyle=h,n.fillRect(0,0,2*e.width,2*e.height),n.restore(),n.save(),n.globalCompositeOperation="lighter",n.drawImage(a,0,-e.height),n.restore(),n.save(),(h=n.createLinearGradient(e.width,0,2*e.width,0)).addColorStop(0,l),h.addColorStop(e.blend,o),n.globalCompositeOperation="destination-in",n.fillStyle=h,n.fillRect(0,0,a.width,a.height),n.restore(),n.save(),(h=n.createLinearGradient(0,0,e.width,0)).addColorStop(0,o),h.addColorStop(e.blend,l),n.globalCompositeOperation="destination-in",n.fillStyle=h,n.fillRect(0,0,2*e.width,2*e.height),n.restore(),n.save(),n.globalCompositeOperation="lighter",n.drawImage(a,-e.width,0),n.restore(),tI.ctx(r).drawImage(a,0,0)}else tI.ctx(r).drawImage(t.canvas,-e.x,-e.y);t.save(),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.translate(e.offsetX-i,e.offsetY-s),t.fillStyle=E(t.createPattern(r,"repeat")),t.fillRect(-e.offsetX+i,-e.offsetY+s,t.canvas.width,t.canvas.height),t.restore()}function r$(t,e,i,s,r,a,n){t.save();let o=180/s;for(let s=0;s<180;s+=o){let o=tI.rotateAround({x:e,y:i},{x:e+9999,y:i},s);ej(t,{type:"line",x1:e,y1:i,x2:o.x,y2:o.y,isOutwards:!0,opacity:n,strokeRgb:a,lineWidth:r})}t.restore()}function rQ(t,e){e.getDialog&&(t.getDialog=e.getDialog),t.apply=e.apply}async function rZ(t){let e=t.getLayersFast(),i={width:t.getWidth(),height:t.getHeight(),children:e.map(t=>({name:t.name,hidden:!t.isVisible,opacity:t.opacity,canvas:t.canvas,blendMode:rH.PSD.blendKlToPsd(t.mixModeStr),left:0,top:0}))};return new Blob([(await rR()).writePsdBuffer(i)],{type:"application/octet-stream"})}class rJ{chainIn(t){if(t=tI.copyObj(t),this.timeout&&clearTimeout(this.timeout),this.interval&&clearInterval(this.interval),"down"===t.type&&(this.lastMixedInput={x:t.x,y:t.y,pressure:t.pressure}),"move"===t.type){let e=t.x,i=t.y,s=t.pressure;t.x=tI.mix(t.x,this.lastMixedInput.x,this.smoothing),t.y=tI.mix(t.y,this.lastMixedInput.y,this.smoothing),t.pressure=tI.mix(t.pressure,this.lastMixedInput.pressure,this.smoothing),this.lastMixedInput={x:t.x,y:t.y,pressure:t.pressure},this.smoothing>0&&(this.timeout=setTimeout(()=>{this.interval=setInterval(()=>{(t=JSON.parse(JSON.stringify(t))).x=tI.mix(e,this.lastMixedInput.x,this.smoothing),t.y=tI.mix(i,this.lastMixedInput.y,this.smoothing),t.pressure=tI.mix(s,this.lastMixedInput.pressure,this.smoothing),this.lastMixedInput={x:t.x,y:t.y,pressure:t.pressure},this.chainOut&&this.chainOut(t)},35)},80))}return t}setChainOut(t){this.chainOut=t}setSmoothing(t){this.smoothing=tI.clamp(t,0,1)}constructor(t){this.smoothing=tI.clamp(t.smoothing,0,1)}}class r0{chainIn(t){return("down"===t.type&&(this.isDrawing?this.chainOut&&this.chainOut({type:"up",scale:t.scale,shiftIsPressed:t.shiftIsPressed,isCoalesced:!1}):this.isDrawing=!0),this.isDrawing||"move"!==t.type&&"up"!==t.type)?("up"===t.type&&this.isDrawing&&(this.isDrawing=!1),t):null}setChainOut(t){this.chainOut=t}getIsDrawing(){return this.isDrawing}constructor(){this.isDrawing=!1}}function r1(t){return 1==t?.5:2==t?.84:3==t?.965:4==t?.9825:5==t?.99125:t}class r2{importFinishedLoading(t,e,i){if(!t||isNaN(t.width)||isNaN(t.height)||t.width<=0||t.height<=0){rH.popup({target:this.klRootEl,type:"error",message:tB("import-broken-file"),buttons:["Ok"]});return}let s=(t,e)=>{let i=parseInt(""+t),s=parseInt(""+e);return i>this.klMaxCanvasSize&&(s=this.klMaxCanvasSize/i*s,i=this.klMaxCanvasSize),s>this.klMaxCanvasSize&&(i=this.klMaxCanvasSize/s*i,s=this.klMaxCanvasSize),{width:i=parseInt(""+i),height:s=parseInt(""+s)}},r=t=>{let i=s(t.width,t.height),r=tI.canvas(t.width,t.height);tI.ctx(r).drawImage(t,0,0),tI.resizeCanvas(r,i.width,i.height),this.klCanvas.reset({width:i.width,height:i.height,image:r,layerName:e}),this.layerManager.update(0),this.setCurrentLayer(this.klCanvas.getLayer(0)),this.klCanvasWorkspace.resetOrFitView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())},a=(t,e)=>{let i;let r=(t,e,i)=>{e.width=e.width,tI.ctx(e).drawImage(t,-i.x,-i.y),t.width=i.width,t.height=i.height,tI.ctx(t).drawImage(e,0,0)};if(e&&(e.width!==t.width||e.height!==t.height)){let i=tI.canvas(e.width,e.height);if(t.width=e.width,t.height=e.height,t.layers||r(t.canvas,i,e),t.layers)for(let s=0;s<t.layers.length;s++)r(t.layers[s].image,i,e)}let a=s(t.width,t.height);if(t.width=a.width,t.height=a.height,t.layers||tI.resizeCanvas(t.canvas,t.width,t.height),t.layers)for(let e=0;e<t.layers.length;e++){let i=t.layers[e];tI.resizeCanvas(i.image,t.width,t.height)}i=t.layers?this.klCanvas.reset({width:t.width,height:t.height,layers:t.layers}):this.klCanvas.reset({width:t.width,height:t.height,image:t.canvas}),this.layerManager.update(i),this.setCurrentLayer(E(this.klCanvas.getLayer(i))),this.klCanvasWorkspace.resetOrFitView(),this.handUi.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())},n=t=>{rH.showImportAsLayerDialog({target:this.klRootEl,klCanvas:this.klCanvas,importImage:t,callback:(i,s)=>{if(!i)return;D.pause(!0),this.klCanvas.addLayer();let r=this.klCanvas.getLayers().length-1;e&&this.klCanvas.renameLayer(r,e);let a=E(this.klCanvas.getLayerContext(r));tI.drawTransformedImageWithBounds(a,t,i,void 0,s),this.setCurrentLayer(E(this.klCanvas.getLayer(r))),this.layerManager.update(r),D.pause(!1),D.push({tool:["misc"],action:"importImage",params:[tI.copyCanvas(a.canvas),e]})}})};"default"!==i&&i||rH.showImportImageDialog({image:t,target:this.klRootEl,maxSize:this.klMaxCanvasSize,callback:t=>{"as-image"===t.type?r(t.image):"as-image-psd"===t.type?a(t.image,t.cropObj):"as-layer"===t.type?n(t.image):t.type}}),"layer"===i&&n(t.canvas),"image"===i&&("psd"===t.type?a(t):r(t.canvas))}onPaste(t){!(rH.dialogCounter.get()>0)&&(t.stopPropagation(),t.preventDefault(),t.clipboardData&&(t.clipboardData.files[0]?((t,e)=>{if(t)for(let i=0;i<t.length;i++){if(-1==t[i].type.indexOf("image"))continue;let s=t[i].getAsFile();s&&e(s)}})(t.clipboardData.items,t=>{let e=new Image;e.onload=()=>{URL.revokeObjectURL(e.src),this.importFinishedLoading({type:"image",width:e.width,height:e.height,canvas:e},void 0,"default")};let i=window.URL||window.webkitURL;e.src=i.createObjectURL(t)}):t.clipboardData.items[0]&&t.clipboardData.items[0].getAsString(t=>{if((t=t.trim()).match(/^https?/)){let e=new Image;e.onload=()=>{this.importFinishedLoading({type:"image",width:e.width,height:e.height,canvas:e},void 0,"default")},e.onerror=t=>{console.log("error loading",t)},e.crossOrigin="Anonymous",e.src=t}else if(t.match(/^#?([a-fA-F0-9]{6}|[a-fA-F0-9]{3})$/)){let e=tI.ColorConverter.hexToRGB(t.replace("#",""));e&&this.onColor(e)}})))}handleFileSelect(t,e){let i=()=>{rH.popup({target:this.klRootEl,type:"warning",message:tB("import-psd-unsupported")+"<br /><br />",buttons:["Ok"]})},s=!1;for(let r=0,a;a=t[r];r++){let r=a.name.split(".");"psd"===r[r.length-1].toLowerCase()?(s=>{let r;if(s.size>=1073741824){rH.popup({target:this.klRootEl,type:"error",message:"File too big. Unable to import.<br /><br />",buttons:["Ok"]});return}let a=1===t.length&&s.size>=26214400,n=!0;a&&rH.popup({target:this.klRootEl,message:tB("import-opening"),callback:t=>{n=!1,r=null},closeFunc:t=>{r=t}});let o=new FileReader;o.onload=t=>{let o=E(t.target);rH.loadAgPsd().then(t=>{if(!a||n)try{let a;if((a=t.readPsd(o.result,{skipLayerImageData:!0,skipThumbnail:!0,skipCompositeImageData:!0})).width>4096||a.height>4096){r&&r(),rH.popup({target:this.klRootEl,type:"error",message:tB("import-psd-too-large").replace(/{x}/g,"4096")+"<br /><br />"+tB("import-psd-size")+": "+a.width+" x "+a.height+" pixels<br /><br />",buttons:["Ok"]});return}a=null;try{a=t.readPsd(o.result)}catch(t){}if(a){let t=rH.PSD.readPsd(a);"image"===e&&t.error&&i(),r&&r(),this.importFinishedLoading(t,s.name,e)}else a=t.readPsd(o.result,{skipLayerImageData:!0,skipThumbnail:!0}),"image"===e&&i(),r&&r(),this.importFinishedLoading({type:"psd",width:a.width,height:a.height,canvas:I(a.canvas),error:!0},s.name,e)}catch(t){r&&r(),rH.popup({target:this.klRootEl,type:"error",message:"Failed to load PSD.<br /><br />",buttons:["Ok"]}),console.log(t),setTimeout(()=>{throw Error("psd load error")})}}).catch(t=>{r&&r(),alert("Error: failed to load PSD library")})},o.readAsArrayBuffer(s)})(a):a.type.match("image.*")?(t=>{window.URL=window.URL||window.webkitURL;let i=window.URL.createObjectURL(t),s=new Image;s.src=i,tI.loadImage(s,()=>{this.importFinishedLoading({type:"image",width:s.width,height:s.height,canvas:s},t.name,e)})})(a):s=!0}s&&rH.popup({target:this.klRootEl,message:tB("import-unsupported-file"),type:"error",buttons:["OK"]})}constructor(t,e){this.klRootEl=t.klRootEl,this.klMaxCanvasSize=t.klMaxCanvasSize,this.layerManager=t.layerManager,this.setCurrentLayer=t.setCurrentLayer,this.klCanvas=t.klCanvas,this.klCanvasWorkspace=t.klCanvasWorkspace,this.handUi=t.handUi,this.onColor=e.onColor}}var r5={};r5=x("dwTKp").getBundleURL("lrLBb")+"tab-settings.be84ac7c.svg";var r3={};r3=x("dwTKp").getBundleURL("lrLBb")+"tab-layers.c8a104e7.svg",sT.isLoaded||(rQ(sM.brightnessContrast,{getDialog(t){let e=tI.el(),i={element:e},s=ia();s||(i.width=ih(s));let r=t.context,a=t.klCanvas;if(!r||!a)return!1;let n=a.getLayers(),o=a.getLayerIndex(r.canvas),l=0,h=0,c=new rF({original:r.canvas,onUpdate:t=>t.brightnessContrast(l,h)});return setTimeout(function(){let t=new tQ({label:tB("filter-bright-contrast-brightness"),width:300,height:30,min:0,max:100,value:(l+1)*50,eventResMs:60,onChange:function(t){l=t/50-1,d.render()}}),a=new tQ({label:tB("filter-bright-contrast-contrast"),width:300,height:30,min:0,max:100,value:(h+1)*50,eventResMs:60,onChange:function(t){h=t/50-1,d.render()}});t.getElement().style.marginBottom="10px",a.getElement().style.marginBottom="10px",e.append(t.getElement(),a.getElement());let p=[];for(let t=0;t<n.length;t++)p.push({image:t===o?c.render:n[t].context.canvas,isVisible:n[t].isVisible,opacity:n[t].opacity,mixModeStr:n[t].mixModeStr,hasClipping:!1});let d=new eD({width:ih(s),height:ic(s),project:{width:r.canvas.width,height:r.canvas.height,layers:p}});d.render(),d.getElement().classList.add((0,ii.css)({marginLeft:"-20px",marginRight:"-20px"})),e.append(d.getElement()),i.destroy=()=>{t.destroy(),a.destroy(),c.destroy(),d.destroy()},i.getInput=function(){return i.destroy(),{brightness:l,contrast:h}}},1),i},apply(t){let e=t.context,i=t.input.brightness,s=t.input.contrast,r=t.history;if(!e||!r)return!1;r.pause(!0);let a=rT();if(!a)return!1;let n=a.texture(e.canvas);return a.draw(n).brightnessContrast(i,s).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(a,0,0),n.destroy(),r.pause(!1),r.push({tool:["filter","brightnessContrast"],action:"apply",params:[{input:t.input}]}),!0}}),rQ(sM.cropExtend,{getDialog(t){let e=t.klCanvas;if(!e)return!1;let i=tI.canvas();{let t=tI.fitInto(e.getWidth(),e.getHeight(),560,400,1),s=parseInt(""+t.width),r=parseInt(""+t.height),a=s/e.getWidth();i.width=s,i.height=r,i.style.display="block",tI.ctx(i).drawImage(e.getCompleteCanvas(a),0,0,s,r)}let s=tI.el(),r={element:s},a=0,n=0,o=0,l=0,h=!1,c=!1,p=!1,d=!1,u=t.maxWidth,g=t.maxHeight,m=1,y=tI.el({css:{lineHeight:"30px",height:"35px"}}),f=tI.el({css:{lineHeight:"30px",height:"35px"}});s.append(y,f);let x=tU({init:0,type:"number",min:-e.getWidth(),max:u,css:{width:"75px",marginRight:"20px"},callback:function(){h=!0,S()}}),v=tU({init:0,type:"number",min:-e.getWidth(),max:u,css:{width:"75px"},callback:function(){c=!0,S()}}),b=tU({init:0,type:"number",min:-e.getHeight(),max:g,css:{width:"75px",marginRight:"20px"},callback:function(){p=!0,S()}}),w=tU({init:0,type:"number",min:-e.getHeight(),max:g,css:{width:"75px"},callback:function(){d=!0,S()}}),C={display:"inline-block",width:"60px"};function S(){a=parseInt(x.value),n=parseInt(v.value),o=parseInt(b.value),l=parseInt(w.value);let t=e.getWidth()+a+n,i=e.getHeight()+o+l;t<=0&&(h&&(a=-e.getWidth()-n+1,x.value=""+a),c&&(n=-e.getWidth()-a+1,v.value=""+n),t=1),t>u&&(h&&(a=-e.getWidth()-n+u,x.value=""+a),c&&(n=-e.getWidth()-a+u,v.value=""+n),t=u),i<=0&&(p&&(o=-e.getHeight()-l+1,b.value=""+o),d&&(l=-e.getHeight()-o+1,w.value=""+l),i=1),i>g&&(p&&(o=-e.getHeight()-l+g,b.value=""+o),d&&(l=-e.getHeight()-o+g,w.value=""+l),i=g),O.setTransform({x:-a,y:-o,width:t,height:i}),h=!1,c=!1,p=!1,d=!1}y.append(tI.el({content:tB("filter-crop-left")+":",css:C}),x,tI.el({content:tB("filter-crop-right")+":",css:C}),v),f.append(tI.el({content:tB("filter-crop-top")+":",css:C}),b,tI.el({content:tB("filter-crop-bottom")+":",css:C}),w);let k=!0,E=new tF({init:!0,label:tB("filter-crop-rule-thirds"),allowTab:!0,callback:function(t){k=t,O.showThirds(k)}});s.append(tI.el({css:{clear:"both"}}));let I={r:0,g:0,b:0,a:0},A=[{r:0,g:0,b:0,a:0},{r:255,g:255,b:255,a:1},{r:0,g:0,b:0,a:1}];A.push({r:t.currentColorRgb.r,g:t.currentColorRgb.g,b:t.currentColorRgb.b,a:1}),A.push({r:t.secondaryColorRgb.r,g:t.secondaryColorRgb.g,b:t.secondaryColorRgb.b,a:1});let T=new ea({label:tB("filter-crop-fill"),colorArr:A,onChange:function(t){0===(I=t).a?(D.style.background="",i.style.background=""):(D.style.background=tI.ColorConverter.toRgbStr(I),tI.createCheckerDataUrl(parseInt(""+50*m),function(t){i.style.background="url("+t+")"},ee.isDark()))}}),M=tI.el({css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:"10px"}});function L(t){let s=tI.fitInto(t.width,t.height,260,180,1);m=s.width/t.width;let r=tI.centerWithin(io.width,R,s.width,s.height);i.style.width=e.getWidth()*m+"px",i.style.height=e.getHeight()*m+"px",B.style.left=r.x-t.x*m+"px",B.style.top=r.y-t.y*m+"px",a=parseInt(""+-t.x),o=parseInt(""+-t.y),n=parseInt(""+(t.x+t.width-e.getWidth())),l=parseInt(""+(t.y+t.height-e.getHeight())),x.value=""+a,b.value=""+o,v.value=""+n,w.value=""+l,tI.createCheckerDataUrl(parseInt(""+50*m),function(t){P.style.background="url("+t+")",0!==I.a&&(i.style.background="url("+t+")")},ee.isDark()),P.style.backgroundPosition=r.x+"px "+r.y+"px",O.setScale(m)}s.append(M),M.append(E.getElement(),T.getElement());let R=io.height-2,P=tI.el({className:"kl-edit-crop-preview",css:{width:io.width+"px",marginTop:"10px",marginLeft:"-20px",height:R+"px",backgroundColor:"#9e9e9e",position:"relative",borderTop:"1px solid rgb(144,144,144)",borderBottom:"1px solid rgb(144,144,144)",overflow:"hidden",userSelect:"none",touchAction:"none"}});P.oncontextmenu=function(){return!1};let D=tI.el({css:{position:"absolute",left:"0",top:"0",bottom:"0",right:"0"}});P.append(D);let B=tI.el({parent:P,css:{position:"absolute",left:"0",top:"0"}});tI.el({parent:B,content:i,css:{boxShadow:"0 0 0px 1px rgb(130,130,130)",position:"absolute",left:"0px",top:"0px"}}),s.append(P);let O=new ir({x:0,y:0,width:e.getWidth(),height:e.getHeight(),scale:m,callback:L,maxW:u,maxH:g});function z(){S()}return L(O.getTransform()),B.append(O.getElement()),ee.addIsDarkListener(z),r.destroy=()=>{O.destroy(),E.destroy(),ee.removeIsDarkListener(z),T.destroy()},r.getInput=function(){return r.destroy(),{left:a,right:n,top:o,bottom:l,fillColor:0===I.a?void 0:I}},r},apply(t){let e=t.klCanvas,i=t.history;return!(!e||!i||isNaN(t.input.left)||isNaN(t.input.right)||isNaN(t.input.top)||isNaN(t.input.bottom))&&(i.pause(!0),e.resizeCanvas(t.input),i.pause(!1),i.push({tool:["filter","cropExtend"],action:"apply",params:[{input:tI.copyObj(t.input)}]}),!0)}}),rQ(sM.curves,{getDialog(t){let e=t.context,i=t.klCanvas;if(!e||!i)return!1;let s=i.getLayers(),r=i.getLayerIndex(e.canvas),a=tI.el(),n={element:a},o=ia();o||(n.width=ih(o));let l=rW(),h=new rF({original:e.canvas,onUpdate:t=>t.curves(l.r,l.g,l.b)});return setTimeout(function(){let t=[];for(let e=0;e<s.length;e++)t.push({image:e===r?h.render:s[e].context.canvas,isVisible:s[e].isVisible,opacity:s[e].opacity,mixModeStr:s[e].mixModeStr,hasClipping:!1});let i=new eD({width:ih(o),height:ic(o),project:{width:e.canvas.width,height:e.canvas.height,layers:t}});i.getElement().classList.add((0,ii.css)({marginLeft:"-20px",marginRight:"-20px"}));let c=new rU({curves:l,callback:function(t){l=t,i.render()}}),p=c.getModeButtons();a.append(c.getElement(),i.getElement()),n.destroy=()=>{c.destroy(),p.destroy(),h.destroy(),i.destroy()},n.getInput=function(){return n.destroy(),{curves:l}}},1),n},apply(t){let e=t.context,i=t.input.curves,s=t.history;if(!e||!s)return!1;s.pause(!0);let r=rT();if(!r)return!1;let a=r.texture(e.canvas);return r.draw(a).curves(i.r,i.g,i.b).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(r,0,0),a.destroy(),s.pause(!1),s.push({tool:["filter","curves"],action:"apply",params:[{input:t.input}]}),!0}}),rQ(sM.flip,{getDialog(t){let e=t.context,i=t.klCanvas;if(!e||!i)return!1;let s=i.getLayers(),r=i.getLayerIndex(e.canvas),a=tI.fitInto(e.canvas.width,e.canvas.height,280,200,1),n=parseInt(""+a.width),o=parseInt(""+a.height),l=tI.el(),h={element:l},c=!0,p=!1,d=!0,u=new tF({init:!0,label:tB("filter-flip-horizontal")+" ",allowTab:!0,callback:function(t){c=t,b()},css:{marginBottom:"10px"}}),g=new tF({init:p,label:tB("filter-flip-vertical")+" ",allowTab:!0,callback:function(t){p=t,b()},css:{marginBottom:"10px"}});l.append(u.getElement()),l.append(g.getElement());let m=new en({optionArr:[{id:!0,label:tB("filter-flip-image")},{id:!1,label:tB("filter-flip-layer")}],onChange:t=>{d=t,b()}});l.append(m.getElement());let y=tI.el({className:"kl-preview-wrapper",css:{width:io.width+"px",height:io.height+"px"}}),f={image:tI.canvas(Math.round(n),Math.round(o)),isVisible:!0,opacity:1,mixModeStr:"source-over"},x=new e9({width:Math.round(n),height:Math.round(o),layers:[f]}),v=tI.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+n)+"px",height:parseInt(""+o)+"px"}});function b(){let t=tI.ctx(f.image);t.save(),t.clearRect(0,0,f.image.width,f.image.height),d&&(c&&(t.translate(f.image.width,0),t.scale(-1,1)),p&&(t.translate(0,f.image.height),t.scale(1,-1)));for(let e=0;e<s.length;e++)s[e].isVisible&&(t.save(),!d&&r===e&&(c&&(t.translate(f.image.width,0),t.scale(-1,1)),p&&(t.translate(0,f.image.height),t.scale(1,-1))),t.canvas.width>s[e].context.canvas.width&&(t.imageSmoothingEnabled=!1),t.globalAlpha=s[e].opacity,t.globalCompositeOperation=s[e].mixModeStr,t.drawImage(s[e].context.canvas,0,0,f.image.width,f.image.height),t.restore());x.render(),t.restore()}return v.append(x.getElement()),y.append(v),setTimeout(b,0),l.append(y),h.destroy=()=>{u.destroy(),g.destroy(),m.destroy(),x.destroy()},h.getInput=function(){return h.destroy(),{horizontal:c,vertical:p,flipCanvas:d}},h},apply(t){let e=t.context,i=t.klCanvas,s=t.history,r=t.input.horizontal,a=t.input.vertical,n=t.input.flipCanvas;return!!e&&!!i&&!!s&&(s.pause(!0),i.flip(r,a,n?void 0:E(i.getLayerIndex(e.canvas))),s.pause(!1),s.push({tool:["filter","flip"],action:"apply",params:[{input:t.input}]}),!0)}}),rQ(sM.hueSaturation,{getDialog(t){let e=t.context,i=t.klCanvas;if(!e||!i)return!1;let s=i.getLayers(),r=i.getLayerIndex(e.canvas),a=tI.el(),n={element:a},o=ia();o||(n.width=ih(o));let l=0,h=0,c=new rF({original:e.canvas,onUpdate:t=>t.hueSaturation(l,h)});return setTimeout(function(){let t=new tQ({label:tB("filter-hue-sat-hue"),width:300,height:30,min:-100,max:100,value:100*l,eventResMs:60,onChange:function(t){l=t/100,d.render()}}),i=new tQ({label:tB("filter-hue-sat-saturation"),width:300,height:30,min:0,max:100,value:(h+1)*50,eventResMs:60,onChange:function(t){h=t/50-1,d.render()}});t.getElement().style.marginBottom="10px",i.getElement().style.marginBottom="10px",a.append(t.getElement(),i.getElement());let p=[];for(let t=0;t<s.length;t++)p.push({image:t===r?c.render:s[t].context.canvas,isVisible:s[t].isVisible,opacity:s[t].opacity,mixModeStr:s[t].mixModeStr,hasClipping:!1});let d=new eD({width:ih(o),height:ic(o),project:{width:e.canvas.width,height:e.canvas.height,layers:p}});d.render(),d.getElement().classList.add((0,ii.css)({marginLeft:"-20px",marginRight:"-20px"})),a.append(d.getElement()),n.destroy=()=>{t.destroy(),i.destroy(),c.destroy(),d.destroy()},n.getInput=function(){return n.destroy(),{hue:l,saturation:h}}},1),n},apply(t){let e=t.context,i=t.input.hue,s=t.history,r=t.input.saturation;if(!e||null===i||null===r||!s)return!1;s.pause(!0);let a=rT();if(!a)return!1;let n=a.texture(e.canvas);return a.draw(n).hueSaturation(i,r).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(a,0,0),n.destroy(),s.pause(!1),s.push({tool:["filter","hueSaturation"],action:"apply",params:[{input:t.input}]}),!0}}),rQ(sM.invert,{apply(t){let e=t.context,i=t.history;if(!e||!i)return!1;let s=rT();if(!s)return!1;i.pause(!0);let r=s.texture(e.canvas);return s.draw(r).invert().update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(s,0,0),r.destroy(),i.pause(!1),i.push({tool:["filter","invert"],action:"apply",params:[{input:t.input}]}),!0}}),rQ(sM.perspective,{getDialog(t){let e=t.context,i=t.klCanvas;if(!e||!i)return!1;let s=ia(),r=i.getLayers(),a=i.getLayerIndex(e.canvas),n=tI.el(),o={element:n};return s||(o.width=il.width),setTimeout(function(){let t=E(rT()),i=I(null==t?void 0:t.texture(e.canvas));function l(){u?t.draw(i).update():t.draw(i).perspective(d(c),d(p)).update(),y.render()}let h=[{x:0,y:0},{x:e.canvas.width,y:0},{x:e.canvas.width,y:e.canvas.height},{x:0,y:e.canvas.height}],c=h.map(t=>new r_({value:t,onChange:()=>{l()}}));c.forEach(t=>t.getElement().style.display="none");let p=h.map(t=>new r_({value:t,onChange:()=>{l()}}));function d(t,e){return t.flatMap(t=>{let i=t.getValue();return e&&(i=el(e,i)),[i.x,i.y]})}let u=!1,g=new rN({left:tB("compare-before"),right:tB("compare-after"),init:1,onChange:t=>{(u=0===t)?(c.forEach(t=>t.getElement().style.display="block"),p.forEach(t=>t.getElement().style.display="none")):(c.forEach((t,e)=>{p[e].setValue(t.getValue())}),c.forEach(t=>t.getElement().style.display="none"),p.forEach(t=>t.getElement().style.display="block")),l()}});n.append(g.getElement());let m=[];for(let e=0;e<r.length;e++)m.push({image:e===a?t:r[e].context.canvas,isVisible:r[e].isVisible,opacity:r[e].opacity,mixModeStr:r[e].mixModeStr,hasClipping:!1});let y=new eD({width:ih(s),height:ic(s),project:{width:e.canvas.width,height:e.canvas.height,layers:m},onTransformChange:t=>{c.forEach(e=>e.setTransform(t)),p.forEach(e=>e.setTransform(t))}});tI.css(y.getElement(),{overflow:"hidden",marginLeft:"-20px",marginRight:"-20px"}),y.getElement().append(...c.map(t=>t.getElement()),...p.map(t=>t.getElement())),n.append(y.getElement()),l(),o.destroy=()=>{y.destroy(),i.destroy,c.forEach(t=>t.destroy()),p.forEach(t=>t.destroy())},o.getInput=()=>(o.destroy(),{before:d(c),after:d(p)})},1),o},apply(t){let e=t.context,i=t.history,s=t.input.before,r=t.input.after;if(!e||!s||!r||!i)return!1;i.pause(!0);let a=rT();if(!a)return!1;let n=a.texture(e.canvas);return a.draw(n).multiplyAlpha().perspective(s,r).unmultiplyAlpha().update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(a,0,0),n.destroy(),i.pause(!1),i.push({tool:["filter","perspective"],action:"apply",params:[{input:t.input}]}),!0}}),rQ(sM.resize,{getDialog(t){let e=t.klCanvas;if(!e)return!1;let i=tI.fitInto(e.getWidth(),e.getHeight(),280,200,1),s=parseInt(""+i.width),r=parseInt(""+i.height),a=s/e.getWidth(),n=e.getCompleteCanvas(1),o=tI.el(),l={element:o},h=e.getWidth(),c=e.getHeight(),p=t.maxWidth,d=t.maxHeight,u=tI.el({css:{width:"150px",height:"35px",lineHeight:"30px"}}),g=tI.el({css:{width:"150px",height:"35px",lineHeight:"30px"}}),y=tI.el({tagName:"input",css:{cssFloat:"right",width:"90px"},custom:{type:"number",min:"1",max:""+p,value:""+e.getWidth()}}),f=tI.el({tagName:"input",css:{cssFloat:"right",width:"90px"},custom:{type:"number",min:"1",max:""+d,value:""+e.getHeight()}});y.onclick=function(){this.focus(),w=!0,T()},f.onclick=function(){this.focus(),b=!0,T()},y.onchange=function(){w=!0,T()},f.onchange=function(){b=!0,T()},u.append(tB("width")+": ",y),g.append(tB("height")+": ",f),tI.el({css:{background:"url("+m(rY)+") no-repeat 140px 5px",backgroundSize:"50px 52px"}}).append(u,g);let x=new Image;x.src=m(rY),x.height=40;let v=iT([[tB("width")+":&nbsp;",y,x],[tI.el({css:{height:"5px"}}),"",""],[tB("height")+":&nbsp;",f]],{"0.2":{rowspan:3}});tI.css(v,{marginBottom:"10px"}),o.append(v);let b=!1,w=!1,C=e.getWidth()/e.getHeight(),S=!0,k=new tF({init:!0,label:tB("constrain-proportions"),allowTab:!0,callback:function(t){S=t,x.style.display=S?"":"none",S&&(y.value=""+e.getWidth(),f.value=""+e.getHeight(),T())}});o.append(tI.el({css:{clear:"both"}}));let E=new tN({isFocusable:!0,optionArr:[["smooth",tB("algorithm-smooth")],["pixelated",tB("algorithm-pixelated")]],title:tB("scaling-algorithm"),initValue:"smooth",onChange:()=>{T()}});tI.el({parent:o,css:{display:"flex",justifyContent:"space-between",alignItems:"center"}}).append(k.getElement(),E.getElement());let I=tI.canvas(s,r);I.style.imageRendering="pixelated";let A=tI.ctx(I);function T(){if(0===y.value.length&&w||0===f.value.length&&b){b=!1,w=!1;return}if(y.value=""+Math.max(1,parseInt(y.value)),f.value=""+Math.max(1,parseInt(f.value)),S&&(b&&(y.value=""+parseInt(""+parseInt(f.value)*C)),w&&(f.value=""+parseInt(""+parseInt(y.value)/C)),parseInt(y.value)>p||parseInt(f.value)>d)){let t=tI.fitInto(parseInt(y.value),parseInt(f.value),p,d,1);y.value=""+parseInt(""+t.width),f.value=""+parseInt(""+t.height)}parseInt(y.value)>p&&(y.value=""+p),parseInt(f.value)>d&&(f.value=""+d),b=!1,w=!1,h=parseInt(y.value),c=parseInt(f.value);let t=tI.fitInto(h,c,280,200,1),i=parseInt(""+t.width),s=parseInt(""+t.height);a=i/h;let r=tI.centerWithin(io.width,io.height,i,s);"smooth"===E.getValue()?(I.style.imageRendering=a>1?"pixelated":"",I.width=e.getWidth(),I.height=e.getHeight(),A.save(),A.imageSmoothingQuality="high",A.drawImage(n,0,0),tI.resizeCanvas(I,h,c)):(I.style.imageRendering="pixelated",I.width=h,I.height=c,A.save(),A.imageSmoothingEnabled=!1,A.drawImage(n,0,0,I.width,I.height)),A.restore(),I.style.width=Math.max(1,i)+"px",I.style.height=Math.max(1,s)+"px",L.style.left=r.x+"px",L.style.top=r.y+"px",L.style.width=Math.max(1,i)+"px",L.style.height=Math.max(1,s)+"px"}let M=tI.el({className:"kl-transparent-preview",css:{width:io.width+"px",height:io.height+"px",marginLeft:"-20px",display:"table",marginTop:"10px",position:"relative",userSelect:"none"}}),L=tI.el({parent:M,content:I,className:"kl-transparent-preview__canvas",css:{width:s+"px",height:r+"px",position:"absolute",overflow:"hidden"}});function R(){tI.createCheckerDataUrl(8,function(t){M.style.background="url("+t+")"},ee.isDark())}return ee.addIsDarkListener(R),R(),o.append(M),T(),l.destroy=()=>{k.destroy(),ee.removeIsDarkListener(R)},l.getInput=function(){return l.destroy(),{width:h,height:c,algorithm:E.getValue()}},l},apply(t){let e=t.klCanvas,i=t.history,s=t.input.width,r=t.input.height,a=t.input.algorithm;return!!e&&!!i&&(i.pause(!0),e.resize(s,r,a),i.pause(!1),i.push({tool:["filter","resize"],action:"apply",params:[{input:t.input}]}),!0)}}),rQ(sM.rotate,{getDialog(t){let e=t.klCanvas;if(!e)return!1;let i=tI.fitInto(e.getWidth(),e.getHeight(),280,200,1),s=parseInt(""+i.width),r=parseInt(""+i.height),a=s/e.getWidth(),n=tI.canvas(s,r);n.style.display="block",tI.ctx(n).drawImage(e.getCompleteCanvas(a),0,0,s,r);let o=tI.el(),l={element:o},h=0;function c(){if(m.style.transform="rotate("+h+"deg)",90===Math.abs(h%180)){let t=parseInt(""+tI.fitInto(r,s,280,200,1).height)/s;m.style.transform="rotate("+h+"deg) scale("+t+")"}}let p=document.createElement("button");p.innerHTML="<span style='font-size: 1.3em'></span> 90";let d=document.createElement("button");d.innerHTML="<span style='font-size: 1.3em'></span> 90",d.style.marginRight="5px",p.onclick=function(){h+=90,c()},d.onclick=function(){h-=90,c()},o.append(d,p);let u=tI.el({className:"kl-preview-wrapper",css:{width:io.width+"px",height:io.height+"px",display:"table"}}),g=tI.el({parent:u,css:{display:"table-cell",verticalAlign:"middle"}}),m=tI.el({parent:g,content:n,className:"kl-preview-wrapper__canvas",css:{width:s+"px",height:r+"px",marginLeft:"auto",marginRight:"auto",overflow:"hidden"}});function y(){tI.createCheckerDataUrl(8,function(t){m.style.background="url("+t+")"},ee.isDark())}return ee.addIsDarkListener(y),y(),m.style.transition="all 0.2s ease-out",o.append(u),c(),l.destroy=()=>{ee.removeIsDarkListener(y)},l.getInput=function(){return l.destroy(),{deg:h}},l},apply(t){let e=t.klCanvas,i=t.history;return!!e&&!!i&&(i.pause(!0),e.rotate(t.input.deg),i.pause(!1),i.push({tool:["filter","rotate"],action:"apply",params:[{input:t.input}]}),!0)}}),rQ(sM.tiltShift,{getDialog(t){let e=t.context,i=t.klCanvas;if(!e||!i)return!1;let s=i.getLayers(),r=i.getLayerIndex(e.canvas),a=tI.el(),n={element:a},o=ia();o||(n.width=ih(o));let l=20,h=200,c={destroy:()=>{}};return setTimeout(function(){function t(){m.render()}c=new rF({original:e.canvas,onUpdate:(t,e)=>{i.setTransform(m.getTransform()),p.setTransform(m.getTransform());let s=eC(e),r=el(s,i.getValue()),a=el(s,p.getValue());return t.multiplyAlpha().tiltShift(r.x,r.y,a.x,a.y,l*e.scaleX,h*e.scaleX).unmultiplyAlpha()}});let i=new r_({value:{x:e.canvas.width/4,y:e.canvas.height/2},onChange:()=>{t()}}),p=new r_({value:{x:3*e.canvas.width/4,y:e.canvas.height/2},onChange:()=>{t()}}),d=new tQ({label:tB("filter-tilt-shift-gradient"),width:300,height:30,min:0,max:1e3,value:h,eventResMs:60,onChange:function(e){h=e,t()}});d.getElement().style.marginBottom="10px",a.append(d.getElement());let u=new tQ({label:tB("filter-tilt-shift-blur"),width:300,height:30,min:0,max:200,value:l,eventResMs:60,onChange:function(e){l=e,t()}});u.getElement().style.marginBottom="10px",a.append(u.getElement());let g=[];for(let t=0;t<s.length;t++)g.push({image:t===r?c.render:s[t].context.canvas,isVisible:s[t].isVisible,opacity:s[t].opacity,mixModeStr:s[t].mixModeStr,hasClipping:!1});let m=new eD({width:ih(o),height:ic(o),project:{width:e.canvas.width,height:e.canvas.height,layers:g}});m.render(),tI.css(m.getElement(),{overflow:"hidden",marginLeft:"-20px",marginRight:"-20px"}),m.getElement().append(i.getElement(),p.getElement()),a.append(m.getElement()),n.destroy=()=>{u.destroy(),d.destroy(),i.destroy(),p.destroy(),c.destroy(),m.destroy()},n.getInput=function(){return n.destroy(),{a:i.getValue(),b:p.getValue(),blur:l,gradient:h}}},1),n},apply(t){let e=t.context,i=t.history,s=t.input.a,r=t.input.b,a=t.input.blur,n=t.input.gradient;if(!e||!i)return!1;i.pause(!0);let o=rT();if(!o)return!1;let l=o.texture(e.canvas);return o.draw(l).multiplyAlpha().tiltShift(s.x,s.y,r.x,r.y,a,n).unmultiplyAlpha().update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(o,0,0),l.destroy(),i.pause(!1),i.push({tool:["filter","tiltShift"],action:"apply",params:[{input:t.input}]}),!0}}),rQ(sM.transform,{getDialog(t){let e=t.context,i=t.klCanvas;if(!e||!i)return!1;let s=ia(),r=i.getLayers(),a=E(i.getLayerIndex(e.canvas)),n=tI.canvasBounds(e);if(!n)return{error:tB("filter-transform-empty")};let o={x:n.x+n.width/2,y:n.y+n.height/2,width:n.width,height:n.height,angleDeg:0},l=tI.el(),h={element:l};s||(h.width=il.width);let c=new tI.KeyListener({onDown:function(t){tI.isInputFocused(!0)||("left"===t&&(m.value=""+(parseFloat(m.value)-1),F()),"right"===t&&(m.value=""+(parseFloat(m.value)+1),F()),"up"===t&&(g.value=""+(parseFloat(g.value)-1),F()),"down"===t&&(g.value=""+(parseFloat(g.value)+1),F()))}}),p=tI.el(),d=tI.el(),u=tI.el(),g=tI.el({tagName:"input"}),m=tI.el({tagName:"input"}),y=tI.el({tagName:"input"});p.style.width="100px",p.style.height="30px",d.style.width="100px",d.style.height="30px",d.style.display="inline-block",p.style.display="inline-block",u.style.display="inline-block",u.style.width="150px",u.style.height="30px",g.type="number",m.type="number",y.type="number",m.style.width="70px",g.style.width="70px",y.style.width="70px",g.value="0",m.value="0",y.value="0",g.onclick=function(){g.focus(),F()},m.onclick=function(){m.focus(),F()},y.onclick=function(){y.focus(),F()},g.onchange=function(){F()},m.onchange=function(){F()},y.onchange=function(){F()},g.onkeyup=function(){F()},m.onkeyup=function(){F()},y.onkeyup=function(){F()},p.append("X: ",m),d.append("Y: ",g),u.append(tB("filter-transform-rotation")+": ",y),s||tI.el({parent:l,css:{marginTop:"10px"}}).append(p,d,u);let f={marginLeft:"10px",marginTop:"10px"},x=tI.el({parent:l,css:{display:"flex",flexWrap:"wrap",marginLeft:"-10px"}}),v=tI.el({parent:x,tagName:"button",content:tB("filter-transform-flip")+" X",onClick:()=>{let t=j.getValue();j.setSize(-t.width,t.height)},css:f}),b=tI.el({parent:x,tagName:"button",content:tB("filter-transform-flip")+" Y",onClick:()=>{let t=j.getValue();j.setSize(t.width,-t.height)},css:f}),w=tI.el({parent:x,tagName:"button",content:"-90",onClick:()=>{let t=j.getValue();t.angleDeg-=90,t.angleDeg%=360,j.setAngleDeg(t.angleDeg),y.value=""+Math.round(t.angleDeg),H()},css:f}),C=tI.el({parent:x,tagName:"button",content:"+90",onClick:()=>{let t=j.getValue();t.angleDeg+=90,t.angleDeg%=360,j.setAngleDeg(t.angleDeg),y.value=""+Math.round(t.angleDeg),H()},css:f}),S=tI.el({parent:x,tagName:"button",content:"2x",onClick:()=>{let t=j.getValue();T.getValue()?j.setSize(j.getRatio()*t.height*2,2*t.height):j.setSize(2*t.width,2*t.height)},css:f}),k=tI.el({parent:x,tagName:"button",content:"1/2x",onClick:()=>{let t=j.getValue();j.setSize(Math.round(t.width/2),Math.round(t.height/2))},css:f}),I=tI.el({parent:x,tagName:"button",content:tB("center"),onClick:()=>{let t=j.getValue();j.setPos({x:e.canvas.width/2,y:e.canvas.height/2}),j.setAngleDeg(t.angleDeg),H()},css:f}),A=!0,T=new tF({init:!0,label:tB("filter-transform-constrain"),title:tB("constrain-proportions"),allowTab:!0,callback:function(t){A=t,j.setIsConstrained(A)},css:{display:"inline-block"}}),M=!1,L=new tF({init:!0,label:tB("filter-transform-snap"),title:tB("filter-transform-snap-title"),allowTab:!0,callback:function(t){M=t,j.setSnapping(M)},css:{display:"inline-block",marginLeft:"10px"}}),R=tI.el();R.append(T.getElement(),L.getElement()),l.append(tI.el({css:{clear:"both",height:"10px"}}));let P=tI.el({parent:l,css:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"}}),D=new tN({isFocusable:!0,optionArr:[["smooth",tB("algorithm-smooth")],["pixelated",tB("algorithm-pixelated")]],initValue:"smooth",title:tB("scaling-algorithm"),onChange:()=>{H(!0)}});P.append(R,D.getElement());let B=tI.canvas(e.canvas.width,e.canvas.height),O=[];for(let t=0;t<r.length;t++)O.push({image:t===a?B:r[t].context.canvas,isVisible:r[t].isVisible,opacity:r[t].opacity,mixModeStr:r[t].mixModeStr,hasClipping:!1});let z=new eD({width:ih(s),height:ic(s),project:{width:e.canvas.width,height:e.canvas.height,layers:O},hasEditMode:!0,onModeChange:t=>{j.getElement().style.pointerEvents="edit"===t?"":"none",j.getElement().style.opacity="edit"===t?"":"0.5"},onTransformChange:t=>{j.setViewportTransform(t)},padding:30});z.render(),z.getElement().classList.add((0,ii.css)({overflow:"hidden",marginLeft:"-20px",marginRight:"-20px"})),l.append(z.getElement());let V="";function H(t=!1){if(!j)return;let e=j.getValue();if(JSON.stringify(e)===V&&!t)return;V=JSON.stringify(e);let i=tI.ctx(B);i.save(),i.clearRect(0,0,B.width,B.height),tI.drawTransformedImageWithBounds(i,r[a].context.canvas,e,n,"pixelated"===D.getValue()||tI.testShouldPixelate(e,e.width/o.width,e.height/o.height)),i.restore(),z.render()}let j=new ie({x:o.x,y:o.y,width:o.width,height:o.height,angleDeg:o.angleDeg,isConstrained:!0,snapX:[0,e.canvas.width],snapY:[0,e.canvas.height],callback:function(t){m.value=""+Math.round(t.x-o.x),g.value=""+Math.round(t.y-o.y),y.value=""+Math.round(t.angleDeg),H()},viewportTransform:z.getTransform()});function F(){j.setPos({x:parseInt(m.value)+o.x,y:parseInt(g.value)+o.y}),j.setAngleDeg(parseInt(y.value)),H()}return tI.css(j.getElement(),{position:"absolute",left:"0",top:"0"}),z.getElement().append(j.getElement()),H(),h.destroy=()=>{c.destroy(),j.destroy(),T.destroy(),L.destroy(),tI.destroyEl(v),tI.destroyEl(b),tI.destroyEl(w),tI.destroyEl(C),tI.destroyEl(S),tI.destroyEl(k),tI.destroyEl(I),z.destroy(),tI.freeCanvas(B)},h.getInput=function(){let t=j.getValue(),e={transform:t,bounds:n,isPixelated:"pixelated"===D.getValue()||tI.testShouldPixelate(t,t.width/o.width,t.height/o.height)};return h.destroy(),tI.copyObj(e)},h},apply(t){let e=t.context,i=t.history;if(!e||!i)return!1;i.pause(!0);let s=t.input,r=tI.copyCanvas(e.canvas);return e.clearRect(0,0,e.canvas.width,e.canvas.height),tI.drawTransformedImageWithBounds(e,r,s.transform,s.bounds,s.isPixelated),i.pause(!1),i.push({tool:["filter","transform"],action:"apply",params:[{input:s}]}),!0}}),rQ(sM.blur,{getDialog(t){let e=t.klCanvas,i=t.context;if(!e||!i)return!1;let s=e.getLayers(),r=e.getLayerIndex(i.canvas),a=tI.el(),n={element:a},o=ia();o||(n.width=ih(o));let l=10,h=new rF({original:i.canvas,onUpdate:(t,e)=>t.multiplyAlpha().triangleBlur(l*e.scaleX).unmultiplyAlpha()});return setTimeout(function(){let t=new tQ({label:tB("radius"),width:300,height:30,min:1,max:200,value:l,eventResMs:60,onChange:t=>{l=t,c.render()}});t.getElement().style.marginBottom="10px",a.append(t.getElement());let e=[];for(let t=0;t<s.length;t++)e.push({image:t===r?h.render:s[t].context.canvas,isVisible:s[t].isVisible,opacity:s[t].opacity,mixModeStr:s[t].mixModeStr,hasClipping:!1});let c=new eD({width:ih(o),height:ic(o),project:{width:i.canvas.width,height:i.canvas.height,layers:e}});c.render(),c.getElement().classList.add((0,ii.css)({marginLeft:"-20px",marginRight:"-20px"})),a.append(c.getElement()),n.destroy=()=>{t.destroy(),h.destroy(),c.destroy()},n.getInput=function(){return n.destroy(),{radius:l}}},1),n},apply(t){let e=t.context,i=t.history,s=t.input.radius;if(!e||!s||!i)return!1;i.pause(!0);let r=rT();if(!r)return!1;let a=r.texture(e.canvas);return r.draw(a).multiplyAlpha().triangleBlur(s).unmultiplyAlpha().update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(r,0,0),a.destroy(),i.pause(!1),i.push({tool:["filter","blur"],action:"apply",params:[{input:t.input}]}),!0}}),rQ(sM.unsharpMask,{getDialog(t){let e=t.context,i=t.klCanvas;if(!e||!i)return!1;let s=i.getLayers(),r=i.getLayerIndex(e.canvas),a=tI.el(),n={element:a},o=ia();o||(n.width=ih(o));let l=2,h=.51,c=new rF({original:e.canvas,onUpdate:(t,e)=>t.unsharpMask(l*e.scaleX,h)});return setTimeout(function(){function t(){u.render()}let i=new tQ({label:tB("radius"),width:300,height:30,min:0,max:200,value:2,onChange:function(e){l=e,t()},curve:[[0,0],[.1,2],[.5,50],[1,200]]}),p=new tQ({label:tB("filter-unsharp-mask-strength"),width:300,height:30,min:0,max:50,value:5.1,onChange:function(e){h=e/10,t()},curve:[[0,0],[.1,2],[.5,10],[1,50]]});i.getElement().style.marginBottom="10px",p.getElement().style.marginBottom="10px",a.append(i.getElement()),a.append(p.getElement());let d=[];for(let t=0;t<s.length;t++)d.push({image:t===r?c.render:s[t].context.canvas,isVisible:s[t].isVisible,opacity:s[t].opacity,mixModeStr:s[t].mixModeStr,hasClipping:!1});let u=new eD({width:ih(o),height:ic(o),project:{width:e.canvas.width,height:e.canvas.height,layers:d}});t(),u.getElement().classList.add(t6({marginLeft:"-20px",marginRight:"-20px"})),a.append(u.getElement()),n.destroy=()=>{i.destroy(),p.destroy(),c.destroy(),u.destroy()},n.getInput=function(){return n.destroy(),{radius:l,strength:h}}},1),n},apply(t){let e=t.context,i=t.history,s=t.input.radius,r=t.input.strength;if(!e||null===s||null===r||!i)return!1;i.pause(!0);let a=rT();if(!a)return!1;let n=a.texture(e.canvas);return a.draw(n).unsharpMask(s,r).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(a,0,0),n.destroy(),i.pause(!1),i.push({tool:["filter","unsharpMask"],action:"apply",params:[{input:t.input}]}),!0}}),rQ(sM.toAlpha,{getDialog(t){let e=t.context,i=t.klCanvas;if(!e||!i)return!1;let s=i.getLayers(),r=i.getLayerIndex(e.canvas),a=tI.el(),n={element:a},o=ia();return o||(n.width=ih(o)),setTimeout(function(){let i=new rF({original:e.canvas,onUpdate:t=>t.toAlpha("inverted-luminance"===l,c)}),l="inverted-luminance",h=new en({optionArr:[{id:"inverted-luminance",label:tB("filter-to-alpha-inverted-lum")},{id:"luminance",label:tB("filter-to-alpha-lum")}],initId:l,onChange:function(t){l=t,g.render()}});a.append(h.getElement());let c={r:0,g:0,b:0,a:1},p=[null,{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1},{r:t.currentColorRgb.r,g:t.currentColorRgb.g,b:t.currentColorRgb.b,a:1},{r:t.secondaryColorRgb.r,g:t.secondaryColorRgb.g,b:t.secondaryColorRgb.b,a:1}],d=new ea({label:tB("filter-to-alpha-replace"),colorArr:p,initialIndex:1,onChange:function(t){c=t,g.render()}});d.getElement().style.marginTop="10px",d.getElement().style.marginBottom="10px",a.append(d.getElement());let u=[];for(let t=0;t<s.length;t++)u.push({image:t===r?i.render:s[t].context.canvas,isVisible:s[t].isVisible,opacity:s[t].opacity,mixModeStr:s[t].mixModeStr,hasClipping:!1});let g=new eD({width:ih(o),height:ic(o),project:{width:e.canvas.width,height:e.canvas.height,layers:u}});g.render(),g.getElement().classList.add((0,ii.css)({marginLeft:"-20px",marginRight:"-20px"})),a.append(g.getElement()),n.destroy=()=>{h.destroy(),d.destroy(),i.destroy(),g.destroy()},n.getInput=function(){return n.destroy(),{sourceId:l,selectedRgbaObj:c}}},1),n},apply(t){let e=t.context,i=t.history,s=t.input.sourceId,r=t.input.selectedRgbaObj;if(!e||!s||!i)return!1;i.pause(!0);let a=rT();if(!a)return!1;let n=a.texture(e.canvas);return a.draw(n).toAlpha("inverted-luminance"===s,r).update(),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(a,0,0),n.destroy(),i.pause(!1),i.push({tool:["filter","toAlpha"],action:"apply",params:[{input:t.input}]}),!0}}),rQ(sM.grid,{getDialog(t){let e=t.context,i=t.klCanvas;if(!e||!i)return!1;let s=i.getLayers(),r=E(i.getLayerIndex(e.canvas)),a=tI.el(),n={element:a},o=ia();o||(n.width=ih(o));let l={x:2,y:2,thickness:8,color:"#000",opacity:1},h=tI.el({parent:a,css:{display:"flex",alignItems:"center"}}),c=tI.el({parent:a,css:{display:"flex",alignItems:"center",marginTop:"10px",marginBottom:"10px"}}),p=tU({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(t){l.x=parseFloat(t),C()}}),d=tU({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(t){l.y=parseFloat(t),C()}}),u=tU({init:l.thickness,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(t){l.thickness=parseFloat(t),C()}}),g={r:0,g:0,b:0,a:1},m=[{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];m.push({r:t.currentColorRgb.r,g:t.currentColorRgb.g,b:t.currentColorRgb.b,a:1}),m.push({r:t.secondaryColorRgb.r,g:t.secondaryColorRgb.g,b:t.secondaryColorRgb.b,a:1}),l.color=tI.ColorConverter.toRgbStr(g);let y=new ea({label:tB("shape-stroke"),colorArr:m,onChange:function(t){g=t,l.color=tI.ColorConverter.toRgbStr(g),C()}}),f={display:"inline-block",marginRight:"5px"};h.append(tI.el({content:"X:",css:f}),p,tI.el({content:"Y:",css:f}),d),c.append(tI.el({content:tB("shape-line-width")+":",css:f}),u,tI.el({css:{flexGrow:"1"}}),y.getElement());let x=tI.canvas(e.canvas.width,e.canvas.height),v=tI.ctx(x),b=s.map((t,e)=>({image:e===r?x:t.context.canvas,isVisible:t.isVisible,opacity:t.opacity,mixModeStr:t.mixModeStr,hasClipping:!1})),w=new eD({width:ih(o),height:ic(o),project:{width:e.canvas.width,height:e.canvas.height,layers:b}});function C(){v.save(),v.clearRect(0,0,x.width,x.height),v.drawImage(e.canvas,0,0),rX(v,l.x,l.y,Math.max(l.thickness,1),l.color,l.opacity),v.restore(),w.render()}return w.getElement().classList.add((0,ii.css)({marginLeft:"-20px",marginRight:"-20px"})),a.append(w.getElement()),C(),w.render(),n.destroy=()=>{w.destroy(),tI.freeCanvas(x),y.destroy()},n.getInput=function(){return n.destroy(),tI.copyObj(l)},n},apply(t){let e=t.context,i=t.klCanvas,s=t.history;return!!e&&!!i&&!!s&&(s.pause(!0),rX(e,t.input.x,t.input.y,t.input.thickness,t.input.color,t.input.opacity),s.pause(!1),s.push({tool:["filter","grid"],action:"apply",params:[{input:t.input}]}),!0)}}),rQ(sM.noise,{getDialog(t){let e=t.context,i=t.klCanvas;if(!e||!i)return!1;let s=i.getLayers(),r=E(i.getLayerIndex(e.canvas)),a=[];{let t=E(rT()),e=tI.canvas(32,32),i=tI.ctx(e),s=t.texture(e);t.draw(s).update(),s.destroy(),rG.forEach(s=>{let r=new Image,n=tI.copyObj(s);n.scaleX/=10,n.scaleY/=10,rK(t,n),i.drawImage(t,0,0),r.src=e.toDataURL("image/png"),a.push(r)}),s.destroy()}let n=tI.el(),o={element:n},l=ia();l||(o.width=ih(l));let h={seed:300*Math.random(),presetIndex:0,scale:50,opacity:.5,isReversed:!1,channels:"rgb",mixModeStr:"source-over",colA:{r:0,g:0,b:0},colB:{r:255,g:255,b:255}},c=new en({optionArr:a.map((t,e)=>(tI.css(t,{margin:"1px",borderRadius:"3px",transition:"all 0.1s ease-in-out"}),{id:""+e,label:t})),initId:"0",onChange:t=>{h.presetIndex=Number(t),I()}});c.getElement().style.marginBottom="10px",n.append(c.getElement());let p=new tQ({label:tB("filter-noise-scale"),width:300,height:30,min:1,max:1e3,value:h.scale,eventResMs:60,curve:tI.quadraticSplineInput(1,1e3,.1),onChange:t=>{h.scale=t,I()}});p.getElement().style.marginBottom="10px";let d=new tQ({label:tB("opacity"),width:300,height:30,min:.01,max:1,value:h.opacity,eventResMs:60,toValue:t=>t/100,toDisplayValue:t=>100*t,onChange:t=>{h.opacity=t,I()}});d.getElement().style.marginBottom="10px";let u=tI.el({css:{display:"flex",alignItems:"center",marginBottom:"10px"}}),g=tI.el({css:{display:"flex",marginBottom:"10px"}}),m=new en({optionArr:[{id:"rgb",label:"RGB"},{id:"alpha",label:tB("filter-noise-alpha")}],initId:"rgb",onChange:t=>{h.channels=t,"rgb"===t?g.style.visibility="":g.style.visibility="hidden",I()}}),y=new tF({label:tB("reverse"),callback:t=>{h.isReversed=t,I()},allowTab:!0}),f=new tN({isFocusable:!0,optionArr:["source-over",void 0,"darken","multiply","color-burn",void 0,"lighten","screen","color-dodge",void 0,"overlay","soft-light","hard-light",void 0,"difference","exclusion",void 0,"hue","saturation","color","luminosity"].map(t=>t?[t,e_(t)]:void 0),initValue:h.mixModeStr,onChange:t=>{h.mixModeStr=t,I()}});f.getElement().title=tB("layers-blending");let x=tI.el({css:{display:"flex"}}),v={width:"34px",height:"34px",marginRight:"5px"},b=rH.input({type:"color",init:"#"+tm.toHexString(h.colA),callback:t=>{let e=tm.hexToRGB(t);e&&(h.colA=e,I())},css:v}),w=rH.input({type:"color",init:"#"+tm.toHexString(h.colB),callback:t=>{let e=tm.hexToRGB(t);e&&(h.colB=e,I())},css:v});x.append(b,w),u.append(m.getElement(),tI.el({css:{flexGrow:"1"}}),y.getElement()),g.append(f.getElement(),tI.el({css:{flexGrow:"1"}}),x),n.append(p.getElement(),d.getElement(),u,g);let C=new rF({original:e.canvas,onUpdate:(t,i)=>{let s=tI.copyObj(rG[h.presetIndex]);return s.seed=h.seed,s.scaleX=s.scaleX*h.scale/50*i.scaleX,s.scaleY=s.scaleY*h.scale/50*i.scaleY,s.colA=h.colA,s.colB=h.colB,s.isReversed=h.isReversed?!s.isReversed:s.isReversed,s.channels=h.channels,s.offsetX=e.canvas.width/2*i.scaleX+i.x,s.offsetY=e.canvas.height/2*i.scaleY+i.y,t.noise(s.seed,s.type,[s.scaleX,s.scaleY],[s.offsetX,s.offsetY],s.octaves,s.samples,s.peaks,s.brightness,s.contrast,s.isReversed,s.colA,s.colB,s.channels?s.channels:"rgb")},postMix:{opacity:h.opacity,operation:"alpha"===h.channels?"destination-out":h.mixModeStr}}),S=[];for(let t=0;t<s.length;t++)S.push({image:t===r?C.render:s[t].context.canvas,isVisible:s[t].isVisible,opacity:s[t].opacity,mixModeStr:s[t].mixModeStr,hasClipping:!1});let k=new eD({width:ih(l),height:ic(l),project:{width:e.canvas.width,height:e.canvas.height,layers:S}});function I(){C.setPostMix({opacity:h.opacity,operation:"alpha"===h.channels?"destination-out":h.mixModeStr}),k.render()}return k.render(),k.getElement().classList.add((0,ii.css)({marginLeft:"-20px",marginRight:"-20px"})),n.append(k.getElement()),o.destroy=()=>{c.destroy(),p.destroy(),d.destroy(),y.destroy(),m.destroy(),f.destroy(),k.destroy(),C.destroy()},o.getInput=function(){return o.destroy(),tI.copyObj(h)},o},apply(t){let e=t.context,i=t.klCanvas,s=t.history;if(!e||!i||!s)return!1;s.pause(!0);let r=rT();if(!r)return!1;let a=r.texture(e.canvas);r.draw(a).update(),a.destroy();let n=t.input,o=tI.copyObj(rG[n.presetIndex]);return o.seed=n.seed,o.scaleX=o.scaleX*n.scale/50,o.scaleY=o.scaleY*n.scale/50,o.colA=n.colA,o.colB=n.colB,o.isReversed=n.isReversed?!o.isReversed:o.isReversed,o.channels=n.channels,rK(r,o),e.save(),e.globalAlpha=n.opacity,"alpha"===n.channels?e.globalCompositeOperation="destination-out":e.globalCompositeOperation=n.mixModeStr,e.drawImage(r,0,0),e.restore(),s.pause(!1),s.push({tool:["canvas"],action:"replaceLayer",params:[i.getLayerIndex(e.canvas),e.getImageData(0,0,e.canvas.width,e.canvas.height)]}),!0}}),rQ(sM.pattern,{getDialog(t){let e;let i=ia(),s=tI.el(),r=t.context,a=r.canvas.width,n=r.canvas.height,o={x:0,y:0,width:a<=250?Math.round(a/4):200,height:n<=250?Math.round(n/4):200,blend:0,offsetX:0,offsetY:0},l=tI.canvasBounds(r);l&&l.width<=1024&&l.height<=1024&&(l.width<.75*a||l.height<.75*n)?(o.x=l.x,o.y=l.y,o.width=l.width,o.height=l.height):(o.x=Math.round(a/2-o.width/2),o.y=Math.round(n/2-o.height/2));let h=tU({init:o.x,type:"number",min:0,max:a,css:{width:"100%"},callback:function(t){o.x=Number(t),j()}}),c=tU({init:o.y,type:"number",min:0,max:n,css:{width:"100%"},callback:function(t){o.y=Number(t),j()}}),p=tU({init:o.width,type:"number",min:1,max:Math.min(1024,a),css:{width:"100%"},callback:function(t){o.width=Number(t),j()}}),d=tU({init:o.height,type:"number",min:1,max:Math.min(1024,n),css:{width:"100%"},callback:function(t){o.height=Number(t),j()}}),u={marginLeft:"5px",flex:"1"};s.append(tI.el({content:[tI.el({tagName:"label",content:["X:",h],css:u}),tI.el({tagName:"label",content:["Y:",c],css:u}),tI.el({tagName:"label",content:[tB("width")+":",p],css:u}),tI.el({tagName:"label",content:[tB("height")+":",d],css:u})],css:{display:"flex",marginLeft:"-5px"}}));let g=new tQ({label:tB("brush-blending"),width:300,height:30,min:0,max:1,value:o.blend,eventResMs:60,onChange:function(t){o.blend=t,j()},formatFunc:t=>tI.round(t,2),manualInputRoundDigits:2});tI.css(g.getElement(),{margin:"10px 0"}),s.append(g.getElement());let m=1,y=new rN({left:tB("compare-before"),right:tB("compare-after"),init:m,onChange:t=>{m=t,L.style.display=0===t?"block":"none",j(!0)}});s.append(y.getElement());let f=t.klCanvas,x=f.getLayers(),v=E(f.getLayerIndex(r.canvas)),b=tI.fitInto(r.canvas.width,r.canvas.height,i?280:490,i?200:240,1),w=parseInt(""+b.width),C=parseInt(""+b.height),S=Math.min(w,r.canvas.width),k=Math.min(C,r.canvas.height),I=w/r.canvas.width,A=tI.el({className:"kl-preview-wrapper",css:{width:ih(i)+"px",height:ic(i)+"px",marginTop:"0"}}),T={image:tI.canvas(S,k),isVisible:x[v].isVisible,opacity:x[v].opacity,mixModeStr:x[v].mixModeStr},M=new e9({width:Math.round(w),height:Math.round(C),layers:x.map((t,e)=>e===v?T:{image:t.context.canvas,isVisible:t.isVisible,opacity:t.opacity,mixModeStr:t.mixModeStr})}),L=tI.canvas(w,C);tI.css(L,{position:"absolute",left:"0",top:"0",mixBlendMode:"difference",imageRendering:"pixelated"});let R=tI.el({className:"kl-preview-wrapper__canvas",css:{width:parseInt(""+w)+"px",height:parseInt(""+C)+"px"}});R.append(M.getElement(),L),A.append(R),s.append(A);let P={};function D(){h.value=""+o.x,c.value=""+o.y,p.value=""+o.width,d.value=""+o.height}let B=new tI.KeyListener({});A.oncontextmenu=function(){return!1},R.style.touchAction="none";let O=new tI.PointerListener({target:R,onPointer:t=>{if(0===m){if("pointerdown"===t.type){if(!P.state){P.oldSettings=tI.copyObj(o);let e=t.relX/I,i=t.relY/I;tI.isInsideRect({x:e,y:i},{x:o.x,y:o.y,width:o.width,height:o.height})?P.state="move":P.state="select",P.start={x:e,y:i}}}else if("pointermove"===t.type){let e=t.relX/I,i=t.relY/I;if("select"===P.state){P.end={x:e,y:i};let t=Math.max(0,Math.min(P.start.x,P.end.x)),s=Math.max(0,Math.min(P.start.y,P.end.y)),r=Math.min(a,Math.max(P.start.x,P.end.x)),l=Math.min(n,Math.max(P.start.y,P.end.y));o.x=Math.floor(t),o.y=Math.floor(s),o.width=Math.min(1024,Math.ceil(r-o.x)),o.height=Math.min(1024,Math.ceil(l-o.y)),B.isPressed("shift")&&(o.width=Math.min(o.width,o.height),o.height=Math.min(o.width,o.height)),(0===o.width||0===o.height)&&(o=tI.copyObj(P.oldSettings)),D(),j()}else if("move"===P.state){let t=Math.round(e-P.start.x),s=Math.round(i-P.start.y);o.x=tI.clamp(P.oldSettings.x+t,0,a-o.width),o.y=tI.clamp(P.oldSettings.y+s,0,n-o.height),D(),j()}}else"pointerup"===t.type&&P.state&&(P.state=null)}else"pointerdown"===t.type?P.state||(P.state="move",P.oldSettings=tI.copyObj(o),P.start={x:t.relX/I,y:t.relY/I},P.end=null):"pointermove"===t.type?P.state&&(P.end={x:t.relX/I,y:t.relY/I},o.offsetX=Math.round(P.end.x-P.start.x)+P.oldSettings.offsetX,o.offsetY=Math.round(P.end.y-P.start.y)+P.oldSettings.offsetY,j()):"pointerup"===t.type&&P.state&&(P.end||(o.offsetX=0,o.offsetY=0,j()),P.state=null)}}),z=tI.canvas(a,n),V=tI.ctx(z);function H(t,e,i,s,r){let a=Math.round(e+.5)-.5,n=Math.round(i+.5)-.5,o=Math.round(e+s-a),l=Math.round(i+r-n);t.strokeRect(a,n,o,l)}function j(t){if(t||!e||JSON.stringify(e)!==JSON.stringify(o)){if(0===m){V.clearRect(0,0,a,n),V.drawImage(r.canvas,0,0);let t=T.image,e=tI.ctx(t);e.save(),e.clearRect(0,0,S,k),e.drawImage(z,0,0,S,k),e.restore();let i=o.width*I,s=o.height*I,l=tI.ctx(L);l.save(),l.clearRect(0,0,w,C),l.strokeStyle="#fff",H(l,o.x*I,o.y*I,i,s),o.blend>.05&&(l.strokeStyle="#f0f",H(l,o.x*I-i/2*o.blend,o.y*I-s/2*o.blend,i*(1+o.blend),s*(1+o.blend))),l.restore()}else{V.clearRect(0,0,a,n),V.drawImage(r.canvas,0,0),rq(V,o);let t=T.image,e=tI.ctx(t);e.clearRect(0,0,S,k),e.drawImage(z,0,0,S,k)}M.render(),e=tI.copyObj(o)}}j();let F=()=>{g.destroy(),B.destroy(),O.destroy(),M.destroy()},W={element:s,destroy:F,getInput:()=>(F(),tI.copyObj(o))};return i||(W.width=il.width),W},apply(t){let e=t.klCanvas,i=t.context,s=t.history;return!!e&&!!s&&(s.pause(!0),rq(i,t.input),s.pause(!1),s.push({tool:["filter","pattern"],action:"apply",params:[{input:t.input}]}),!0)}}),rQ(sM.distort,{getDialog(t){let e=ia(),i=tI.el(),s=t.context,r=!0,a={stepSize:1,distortType:0,scale:{x:100,y:100},strength:{x:20,y:20},phase:{x:0,y:0},offset:{x:0,y:0}},n=[];{let t=tI.canvas(32,32),e=tI.ctx(t);e.beginPath(),e.arc(16,16,12.8,0,2*Math.PI),e.fill();let i=e.createLinearGradient(0,0,32,32);i.addColorStop(0,"#00f"),i.addColorStop(.5,"#f00"),i.addColorStop(1,"#fff"),e.fillStyle=i,e.globalCompositeOperation="source-atop",e.fillRect(0,0,32,32),(i=e.createLinearGradient(32,0,0,32)).addColorStop(0,"#000"),i.addColorStop(1,"#000"),e.fillStyle=i,e.globalCompositeOperation="destination-atop",e.fillRect(0,0,32,32);let s=E(rT()),r=s.texture(t);s.draw(r).update(),[0,1,2].forEach(i=>{let o=new Image,l=tI.copyObj(a);l.distortType=i,l.scale.x/=20,l.scale.y/=20,l.strength.x/=20,l.strength.y/=20,s.draw(r).multiplyAlpha().distort(l).unmultiplyAlpha().update(),e.clearRect(0,0,32,32),e.drawImage(s,0,0),o.src=t.toDataURL("image/png"),n.push(o)}),r.destroy()}let o=tI.el({parent:i,css:{display:"flex",alignItems:"center"}}),l=new en({optionArr:n.map((t,e)=>(tI.css(t,{margin:"1px",borderRadius:"3px",transition:"all 0.1s ease-in-out"}),{id:""+e,label:t})),initId:"0",onChange:t=>{a.distortType=Number(t),C.render()}});function h(t){"x"===t?(a.scale.y=a.scale.x,a.strength.y=a.strength.x,a.phase.y=a.phase.x,m[3].setValue(a.scale.y),m[4].setValue(a.strength.y),m[5].setValue(a.phase.y)):(a.scale.x=a.scale.y,a.strength.x=a.strength.y,a.phase.x=a.phase.y,m[0].setValue(a.scale.x),m[1].setValue(a.strength.x),m[2].setValue(a.phase.x)),C.render()}let c=new tF({init:!0,label:tB("filter-distort-sync-xy"),callback:t=>{(r=t)&&h("x")}});o.append(l.getElement(),tI.el({css:{flexGrow:"1"}}),c.getElement());let p=tI.el({parent:i,css:{display:"flex",flexWrap:"wrap"}}),d=tI.el({parent:p,css:{marginRight:"10px"}}),u=tI.el({parent:p}),g=e?300:245,m=[];["x","y"].forEach((t,e)=>{let i=0===e?d:u,s=new tQ({label:tB("filter-noise-scale")+" "+t.toUpperCase(),width:g,height:30,min:1,max:1e3,curve:"quadratic",value:a.scale[t],eventResMs:60,onChange:e=>{a.scale[t]=e,r?h(t):C.render()}});s.getElement().style.marginTop="20px",i.append(s.getElement());let n=new tQ({label:tB("filter-unsharp-mask-strength")+" "+t.toUpperCase(),width:g,height:30,min:0,max:200,curve:"quadratic",value:a.strength[t],eventResMs:60,onChange:e=>{a.strength[t]=e,r?h(t):C.render()}});n.getElement().style.marginTop="10px",i.append(n.getElement());let o=new tQ({label:tB("filter-distort-phase")+" "+t.toUpperCase(),width:g,height:30,min:0,max:1,value:a.phase[t],manualInputRoundDigits:2,eventResMs:60,formatFunc:t=>tI.round(t,2),onChange:e=>{a.phase[t]=e,r?h(t):C.render()}});o.getElement().style.marginTop="10px",i.append(o.getElement()),m.push(s),m.push(n),m.push(o)});let y=new tQ({label:tB("filter-distort-stepsize"),width:300,height:30,min:1,max:300,curve:"quadratic",value:a.stepSize,eventResMs:60,onChange:t=>{a.stepSize=Math.round(t),C.render()}});y.getElement().style.marginTop="20px",y.getElement().style.marginBottom="10px",i.append(y.getElement());let f=t.klCanvas,x=f.getLayers(),v=E(f.getLayerIndex(s.canvas)),b=new rF({original:s.canvas,onUpdate:(t,e)=>{let i=tI.copyObj(a);return i.stepSize*=e.scaleX,i.strength.x*=e.scaleX,i.strength.y*=e.scaleY,2!==i.distortType&&(i.scale.x*=e.scaleX,i.scale.y*=e.scaleY),i.offset.x=-e.x,i.offset.y=-e.y,t.multiplyAlpha().distort(i).unmultiplyAlpha()}}),w=x.map((t,e)=>({image:e===v?b.render:t.context.canvas,isVisible:t.isVisible,opacity:t.opacity,mixModeStr:t.mixModeStr,hasClipping:!1})),C=new eD({width:ih(e),height:ic(e),project:{width:s.canvas.width,height:s.canvas.height,layers:w}});C.render(),C.getElement().classList.add((0,ii.css)({marginLeft:"-20px",marginRight:"-20px"})),i.append(C.getElement());let S=()=>{l.destroy(),m.forEach(t=>t.destroy()),y.destroy(),c.destroy(),b.destroy(),C.destroy()},k={element:i,destroy:S,getInput:()=>(S(),tI.copyObj(a))};return e||(k.width=il.width),k},apply(t){let e=t.klCanvas,i=t.context,s=t.history;if(!e||!s)return!1;s.pause(!0);let r=rT();if(!r)return!1;let a=r.texture(i.canvas);return r.draw(a).multiplyAlpha().distort(t.input).unmultiplyAlpha().update(),i.clearRect(0,0,i.canvas.width,i.canvas.height),i.drawImage(r,0,0),a.destroy(),s.pause(!1),s.push({tool:["filter","distort"],action:"apply",params:[{input:t.input}]}),!0}}),rQ(sM.vanishPoint,{getDialog(t){let e=t.context,i=t.klCanvas;if(!e||!i)return!1;let s=i.getLayers(),r=E(i.getLayerIndex(e.canvas)),a=tI.canvas(e.canvas.width,e.canvas.height),n=tI.ctx(a),o=tI.el(),l={element:o},h=ia();h||(l.width=ih(h));let c={x:e.canvas.width/2,y:e.canvas.height/2,lines:8,thickness:2,color:{r:0,g:0,b:0},opacity:1},p=new tQ({label:tB("filter-vanish-point-lines"),width:300,height:30,min:2,max:20,value:c.lines,curve:"quadratic",eventResMs:60,onChange:function(t){c.lines=Math.round(t),w()}});p.getElement().style.marginBottom="10px",o.append(p.getElement());let d=tI.el({parent:o,css:{display:"flex",alignItems:"center"}}),u=tI.el({parent:o,css:{display:"flex",alignItems:"center",marginTop:"10px",marginBottom:"10px"}}),g=tU({init:c.x,type:"number",css:{width:"75px",marginRight:"20px"},callback:function(t){c.x=parseFloat(t),I.setValue({x:c.x,y:c.y}),w()}}),m=tU({init:c.y,type:"number",css:{width:"75px",marginRight:"20px"},callback:function(t){c.y=parseFloat(t),I.setValue({x:c.x,y:c.y}),w()}}),y=tU({init:2,type:"number",min:1,css:{width:"75px",marginRight:"20px"},callback:function(t){c.thickness=parseFloat(t),w()}}),f={r:0,g:0,b:0,a:1},x=[{r:0,g:0,b:0,a:1},{r:255,g:255,b:255,a:1}];x.push({r:t.currentColorRgb.r,g:t.currentColorRgb.g,b:t.currentColorRgb.b,a:1}),x.push({r:t.secondaryColorRgb.r,g:t.secondaryColorRgb.g,b:t.secondaryColorRgb.b,a:1}),c.color=tI.copyObj(f);let v=new ea({label:tB("shape-stroke"),colorArr:x,onChange:function(t){f=t,c.color=tI.copyObj(f),w()}}),b={display:"inline-block",marginRight:"5px"};function w(){let t=a.width,i=a.height;n.save(),n.clearRect(0,0,t,i),n.drawImage(e.canvas,0,0,t,i),r$(n,c.x,c.y,c.lines,Math.max(c.thickness,1),c.color,c.opacity),n.restore(),k.render()}d.append(tI.el({content:"X:",css:b}),g,tI.el({content:"Y:",css:b}),m),u.append(tI.el({content:tB("shape-line-width")+":",css:b}),y,tI.el({css:{flexGrow:"1"}}),v.getElement());let C=()=>(I.setTransform(k.getTransform()),a),S=[];for(let t=0;t<s.length;t++)S.push({image:t===r?C:s[t].context.canvas,isVisible:s[t].isVisible,opacity:s[t].opacity,mixModeStr:s[t].mixModeStr,hasClipping:!1});let k=new eD({width:ih(h),height:ic(h),project:{width:e.canvas.width,height:e.canvas.height,layers:S}});tI.css(k.getElement(),{marginLeft:"-20px",marginRight:"-20px",overflow:"hidden"});let I=new r_({value:{x:c.x,y:c.y},onChange:t=>{c.x=Math.round(t.x),c.y=Math.round(t.y),g.value=""+c.x,m.value=""+c.y,w()}});return w(),k.getElement().append(I.getElement()),o.append(k.getElement()),l.destroy=()=>{p.destroy(),v.destroy(),k.destroy()},l.getInput=function(){return l.destroy(),tI.copyObj(c)},l},apply(t){let e=t.context,i=t.klCanvas,s=t.history;return!!e&&!!i&&!!s&&(s.pause(!0),r$(e,t.input.x,t.input.y,t.input.lines,t.input.thickness,t.input.color,t.input.opacity),s.pause(!1),s.push({tool:["filter","vanishPoint"],action:"apply",params:[{input:t.input}]}),!0)}}),sT.isLoaded=!0);class r4{updateCollapse(){this.uiWidth<this.collapseThreshold?(this.toolspaceCollapser.getElement().style.display="block",this.toolspaceCollapser.setDirection(this.uiState),this.toolspaceCollapser.isOpen()?("left"===this.uiState?(tI.css(this.toolspaceCollapser.getElement(),{left:"271px",right:""}),tI.css(this.klCanvasWorkspace.getElement(),{left:"271px"})):(tI.css(this.toolspaceCollapser.getElement(),{left:"",right:"271px"}),tI.css(this.klCanvasWorkspace.getElement(),{left:"0"})),this.toolspace.style.display="block",this.klCanvasWorkspace.setSize(Math.max(0,this.uiWidth-this.toolWidth),this.uiHeight),this.statusOverlay.setWide(!1)):("left"===this.uiState?tI.css(this.toolspaceCollapser.getElement(),{left:"0",right:""}):tI.css(this.toolspaceCollapser.getElement(),{left:"",right:"0"}),tI.css(this.klCanvasWorkspace.getElement(),{left:"0"}),this.toolspace.style.display="none",this.klCanvasWorkspace.setSize(Math.max(0,this.uiWidth),this.uiHeight),this.statusOverlay.setWide(!0))):(this.toolspaceCollapser.getElement().style.display="none","left"===this.uiState?tI.css(this.klCanvasWorkspace.getElement(),{left:"271px"}):tI.css(this.klCanvasWorkspace.getElement(),{left:"0"}),this.toolspace.style.display="block",this.klCanvasWorkspace.setSize(Math.max(0,this.uiWidth-this.toolWidth),this.uiHeight),this.statusOverlay.setWide(!1))}updateBottomBar(){if(!this.bottomBar)return;let t=this.toolspaceInner.scrollHeight+40<window.innerHeight?"":"none";t!==this.bottomBarWrapper.style.display&&(this.bottomBarWrapper.style.display=t)}updateUi(){this.toolspace.classList.toggle("kl-toolspace--left","left"===this.uiState),this.toolspace.classList.toggle("kl-toolspace--right","right"===this.uiState),"left"===this.uiState?(tI.css(this.toolspace,{left:"0",right:""}),tI.css(this.klCanvasWorkspace.getElement(),{left:"271px"})):(tI.css(this.toolspace,{left:"",right:"0"}),tI.css(this.klCanvasWorkspace.getElement(),{left:"0"})),this.statusOverlay.setUiState(this.uiState),this.layerPreview.setUiState(this.uiState),this.layerManager.setUiState(this.uiState),this.updateCollapse(),this.toolspaceScroller.updateUiState(this.uiState)}getEl(){return this.klRootEl}resize(t,e){window.scrollY>0&&window.scrollTo(0,0),(this.uiWidth!==Math.max(0,t)||this.uiHeight!==Math.max(0,e))&&(this.uiWidth=Math.max(0,t),this.uiHeight=Math.max(0,e),this.updateCollapse(),this.updateBottomBar(),this.layerPreview.setIsVisible(this.uiHeight>=579),this.klColorSlider.setHeight(Math.max(163,Math.min(400,this.uiHeight-505))),this.toolspaceToolRow.setIsSmall(this.uiHeight<540))}out(t){this.statusOverlay.out(t)}getPNG(){return s6(this.klCanvas.getCompleteCanvas(1).toDataURL("image/png"))}getProject(){return this.klCanvas.getProject()}swapUiLeftRight(){this.uiState="left"===this.uiState?"right":"left",this.embed||tw.setItem("uiState",this.uiState),this.updateUi()}saveAsPsd(){this.saveToComputer.save("psd")}isDrawing(){return this.lineSanitizer.getIsDrawing()||this.klCanvasWorkspace.getIsDrawing()}injectLayer(t,e){let i=0;for(;i<this.klCanvas.layerCanvasArr.length&&this.klCanvas.layerCanvasArr[i].name!==e;i++);if(i===this.klCanvas.layerCanvasArr.length){if(this.klCanvas.isLayerLimitReached())return;this.klCanvas.addLayer(),this.klCanvas.layerCanvasArr[i].name=e,this.klCanvas.layerCanvasArr[i].isVisible=!0,this.klCanvas.layerCanvasArr[i].mixModeStr="source-over",this.klCanvas.layerCanvasArr[i].opacity=1}let s=new Image;s.onload=()=>{tI.ctx(this.klCanvas.layerCanvasArr[i]).clearRect(0,0,this.klCanvas.getWidth(),this.klCanvas.getHeight()),tI.ctx(this.klCanvas.layerCanvasArr[i]).drawImage(s,0,0)},s.src=t,this.layerManager.update()}constructor(t,e){let i,s,r,a,n,o,l;this.collapseThreshold=820,this.toolWidth=271,this.getPSD=async()=>await rZ(this.klCanvas),this.embed=e.embed;let h=Math.min(4096,Math.max(2048,Math.max(window.screen.width,window.screen.height)));this.uiState=this.embed?"left":tw.getItem("uiState")?tw.getItem("uiState"):"right";let c=e.projectStore;this.klRootEl=tI.el({className:"g-root",css:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0"}}),this.uiWidth=Math.max(0,window.innerWidth),this.uiHeight=Math.max(0,window.innerHeight);let p="png";this.klCanvas=new rH.KlCanvas(t?{projectObj:t}:{width:Math.max(10,Math.min(h,window.innerWidth<this.collapseThreshold?this.uiWidth:this.uiWidth-this.toolWidth)),height:Math.max(10,Math.min(h,this.uiHeight))},this.embed?-1:0),this.klCanvas.setHistory(D),e.saveReminder||(e.saveReminder={init:()=>{},reset:()=>{}}),t?(t.layers.forEach(t=>{t.image=null}),t=null):(D.pause(!0),this.klCanvas.addLayer(),this.klCanvas.layerFill(0,{r:ei,g:ei,b:ei}),D.pause(!1));try{i={canvas:new rH.KlCanvas({copy:this.klCanvas},this.embed?-1:0),focus:this.klCanvas.getLayerCount()-1,brushes:{}}}catch(t){throw"kl-create-canvas-error"===t.message&&this.klCanvas.destroy(),t}Object.entries(rH.brushes).forEach(([t,e])=>{i.brushes[t]=new e,i.canvas&&i.brushes[t].setContext(i.canvas.getLayerContext(i.focus))});let d=new tI.RGB(0,0,0),u=E(this.klCanvas.getLayerContext(this.klCanvas.getLayerCount()-1)),g=()=>{if("eraserBrush"===r)return a;let t=Object.keys(S).filter(t=>"eraserBrush"!==t),e=t.findIndex(t=>t===r);return t[(e+1)%t.length]},y=t=>{f.emitSize(t),this.klCanvasWorkspace&&this.klCanvasWorkspace.setCursorSize(2*t)},f=new rH.BrushSettingService(t=>{this.klColorSlider.setColor(t),s.setColor(t),d=tI.copyObj(t)},t=>{s.setSize(t),this.klCanvasWorkspace.setCursorSize(2*t)},t=>{s.setOpacity(t)},()=>this.klColorSlider.getColor(),()=>S[r].getSize(),()=>S[r].getOpacity(),()=>({sizeSlider:rH.brushesUI[r].sizeSlider,opacitySlider:rH.brushesUI[r].opacitySlider})),x=new rJ({smoothing:r1(1)});this.lineSanitizer=new r0;let v=new tI.EventChain({chainArr:[this.lineSanitizer,x]});v.setChainOut(t=>{"down"===t.type&&(this.toolspace.style.pointerEvents="none",s.startLine(t.x,t.y,t.pressure),this.klCanvasWorkspace.requestFrame()),"move"===t.type&&(s.goLine(t.x,t.y,t.pressure,!1,t.isCoalesced),this.klCanvasWorkspace.setLastDrawEvent(t.x,t.y,t.pressure),this.klCanvasWorkspace.requestFrame()),"up"===t.type&&(this.toolspace.style.pointerEvents="",s.endLine(),this.klCanvasWorkspace.requestFrame()),"line"===t.type&&(s.getBrush().drawLineSegment(t.x0,t.y0,t.x1,t.y1),this.klCanvasWorkspace.requestFrame())});let b={size:20,align:"left",isBold:!1,isItalic:!1,font:"sans-serif",letterSpacing:0,lineHeight:1,fill:{color:{r:0,g:0,b:0,a:1}}};this.klCanvasWorkspace=new rH.KlCanvasWorkspace({klCanvas:this.klCanvas,width:Math.max(0,this.uiWidth-this.toolWidth),height:this.uiHeight,onDraw:t=>v.chainIn(t),onPick:(t,e)=>{f.setColor(t),e&&(this.klColorSlider.pickingDone(),this.klCanvasWorkspace.setMode(this.toolspaceToolRow.getActive()))},onFill:(t,e)=>{let i=E(this.klCanvas.getLayerIndex(u.canvas));this.klCanvas.floodFill(i,t,e,P.getIsEraser()?null:this.klColorSlider.getColor(),P.getOpacity(),P.getTolerance(),P.getSample(),P.getGrow(),P.getContiguous()),this.klCanvasWorkspace.requestFrame()},onGradient:(t,e,i,s)=>{"down"===t&&V.onDown(e,i,s),"move"===t&&V.onMove(e,i),"up"===t&&V.onUp(e,i)},onText:(t,e,i)=>{rH.dialogCounter.get()>0||rH.textToolDialog({klCanvas:this.klCanvas,layerIndex:E(this.klCanvas.getLayerIndex(u.canvas)),primaryColor:this.klColorSlider.getColor(),secondaryColor:this.klColorSlider.getSecondaryRGB(),text:{...b,text:"",x:t,y:e,angleRad:i,fill:b.fill?{color:{...this.klColorSlider.getColor(),a:b.fill.color.a}}:void 0,stroke:b.stroke?{...b.stroke,color:{...this.klColorSlider.getSecondaryRGB(),a:b.stroke.color.a}}:void 0},onConfirm:t=>{b={...t,text:""};let e=E(this.klCanvas.getLayerIndex(u.canvas));this.klCanvas.text(e,t),this.klCanvasWorkspace.requestFrame()}})},onShape:(t,e,i,s)=>{"down"===t&&H.onDown(e,i,s),"move"===t&&H.onMove(e,i),"up"===t&&H.onUp(e,i)},onViewChange:t=>{t.changed.includes("scale")&&this.statusOverlay.out({type:"transform",scale:t.scale,angleDeg:180*t.angle/Math.PI}),this.toolspaceToolRow.setEnableZoomIn(t.scale!==this.klCanvasWorkspace.getMaxScale()),this.toolspaceToolRow.setEnableZoomOut(t.scale!==this.klCanvasWorkspace.getMinScale()),R.update(t.scale,180*t.angle/Math.PI)},onUndo:()=>{D.canUndo()&&F.undo()&&this.statusOverlay.out(tB("undo"),!0)},onRedo:()=>{D.canRedo()&&F.redo()&&this.statusOverlay.out(tB("redo"),!0)}});let w=()=>{if(!l)return;let t=this.toolspaceToolRow.getActive(),e=l.getOpenedTabId(),i=["draw","hand","fill","gradient","text","shape"];for(let s=0;s<i.length;s++)t===i[s]?l.setIsVisible(i[s],!0):(l.setIsVisible(i[s],!1),e===i[s]&&l.open(t))},C=new tI.KeyListener({onDown:(t,i,a)=>{if(!(rH.dialogCounter.get()>0||tI.isInputFocused(!0))&&!(this.lineSanitizer.getIsDrawing()||this.klCanvasWorkspace.getIsDrawing())){if("plus"===a&&this.klCanvasWorkspace.zoomByStep(C.isPressed("shift")?1/8:.5),"minus"===a&&this.klCanvasWorkspace.zoomByStep(C.isPressed("shift")?-1/8:-.5),"home"===a&&this.klCanvasWorkspace.fitView(!0),"end"===a&&this.klCanvasWorkspace.resetView(!0),["ctrl+z","cmd+z"].includes(a)&&(i.preventDefault(),F.undo()),(["ctrl+y","cmd+y"].includes(a)||(tI.sameKeys("ctrl+shift+z",a)||tI.sameKeys("cmd+shift+z",a))&&"z"===t)&&(i.preventDefault(),F.redo()),!this.embed&&(["ctrl+s","cmd+s"].includes(a)&&(i.preventDefault(),this.saveToComputer.save()),["ctrl+shift+s","cmd+shift+s"].includes(a)&&(i.preventDefault(),(async()=>{let t=!0;try{await c.store(this.klCanvas.getProject())}catch(e){t=!1,setTimeout(()=>{throw Error("keyboard-shortcut: failed to store browser storage, "+e)},0),this.statusOverlay.out(" "+tB("file-storage-failed"),!0)}t&&(e.saveReminder.reset(),this.statusOverlay.out(tB("file-storage-stored"),!0))})()),["ctrl+c","cmd+c"].includes(a)&&(i.preventDefault(),N(!0))),["ctrl+a","cmd+a"].includes(a)&&i.preventDefault(),C.comboOnlyContains(["left","right","up","down"])&&("left"===t&&this.klCanvasWorkspace.translateView(1,0),"right"===t&&this.klCanvasWorkspace.translateView(-1,0),"up"===t&&this.klCanvasWorkspace.translateView(0,1),"down"===t&&this.klCanvasWorkspace.translateView(0,-1)),["r+left","r+right"].includes(a)&&("left"===t&&(this.klCanvasWorkspace.setAngle(-15,!0),R.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())),"right"===t&&(this.klCanvasWorkspace.setAngle(15,!0),R.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg()))),["r+up"].includes(a)&&(this.klCanvasWorkspace.setAngle(0),R.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())),"sqbr_open"===a&&s.decreaseSize(.03/this.klCanvasWorkspace.getScale()),"sqbr_close"===a&&s.increaseSize(.03/this.klCanvasWorkspace.getScale()),"enter"===a&&(this.klCanvas.layerFill(E(this.klCanvas.getLayerIndex(u.canvas)),this.klColorSlider.getColor()),this.statusOverlay.out(tB("filled"),!0)),["delete","backspace"].includes(a)){let t=E(this.klCanvas.getLayerIndex(u.canvas));0!==t||S.eraserBrush.getIsTransparentBg()?this.klCanvas.clearLayer(t):this.klCanvas.layerFill(t,{r:255,g:255,b:255},"source-in"),this.statusOverlay.out(tB("cleared-layer"),!0)}if("shift+e"===a?(i.preventDefault(),s.toggleEraser&&s.toggleEraser()):"e"===a&&(i.preventDefault(),this.klCanvasWorkspace.setMode("draw"),this.toolspaceToolRow.setActive("draw"),l&&l.open("draw"),w(),L.open("eraserBrush")),"b"===a){i.preventDefault();let t=this.klCanvasWorkspace.getMode();this.klCanvasWorkspace.setMode("draw"),this.toolspaceToolRow.setActive("draw"),l&&l.open("draw"),w(),L.open("draw"===t?g():r)}if("g"===a){i.preventDefault();let t="fill"===this.klCanvasWorkspace.getMode()?"gradient":"fill";this.klCanvasWorkspace.setMode(t),this.toolspaceToolRow.setActive(t),l&&l.open(t),w()}"t"===a&&(i.preventDefault(),this.klCanvasWorkspace.setMode("text"),this.toolspaceToolRow.setActive("text"),l&&l.open("text"),w()),"u"===a&&(i.preventDefault(),this.klCanvasWorkspace.setMode("shape"),this.toolspaceToolRow.setActive("shape"),l&&l.open("shape"),w()),"x"===a&&(i.preventDefault(),this.klColorSlider.swapColors())}},onUp:(t,e)=>{}}),S={};Object.entries(rH.brushesUI).forEach(([t,e])=>{let i=new e.Ui({onSizeChange:y,onOpacityChange:t=>{f.emitOpacity(t)},onConfigChange:()=>{f.emitSliderConfig({sizeSlider:rH.brushesUI[r].sizeSlider,opacitySlider:rH.brushesUI[r].opacitySlider})}});S[t]=i,i.getElement().style.padding="10px"}),this.statusOverlay=new rH.StatusOverlay,this.toolspace=tI.el({className:"kl-toolspace",css:{position:"absolute",right:"0",top:"0",bottom:"0",width:this.toolWidth+"px",overflow:"hidden",userSelect:"none",touchAction:"none"}}),this.toolspaceInner=tI.el({parent:this.toolspace}),this.toolspace.oncontextmenu=()=>!1,this.toolspace.onclick=tI.handleClick,this.toolspaceCollapser=new rH.ToolspaceCollapser({onChange:()=>{this.updateCollapse()}}),this.updateCollapse(),setTimeout(()=>{n=new rH.OverlayToolspace({enabledTest:()=>0===rH.dialogCounter.get()&&!this.lineSanitizer.getIsDrawing(),brushSettingService:f}),this.klRootEl.append(n.getElement())},0),tI.append(this.klRootEl,[this.klCanvasWorkspace.getElement(),this.toolspace,this.toolspaceCollapser.getElement()]),(o=this.embed?new rj({onHelp:()=>{s4(this.embed.url+"/help.html",!!this.embed)},onSubmit:()=>{let t=()=>{let t;let e=tI.el({tagName:"button",textContent:tB("save-reminder-save-psd"),css:{display:"block"}});e.onclick=()=>{this.saveAsPsd(),t()},rH.popup({target:this.klRootEl,message:"<b>"+tB("upload-failed")+"</b>",div:tI.el({content:[tI.el({content:tB("backup-drawing"),css:{marginBottom:"10px"}}),e]}),ignoreBackground:!0,closeFunc:e=>{t=e}})};rH.popup({target:this.klRootEl,message:tB("submit-prompt"),buttons:[tB("submit"),"Cancel"],callback:async i=>{if(i!==tB("submit"))return;let s=tI.el({parent:this.klRootEl,className:"upload-overlay",content:'<div class="spinner"></div> '+tB("submit-submitting")});this.embed.onSubmit(()=>{e.saveReminder.reset(),s.remove()},()=>{s.remove(),t()})}})},onLeftRight:()=>{this.uiState="left"===this.uiState?"right":"left",this.updateUi()}}):new rH.ToolspaceTopRow({logoImg:e.logoImg,onLogo:()=>{s4("./home/",!!this.embed)},onNew:()=>{W()},onImport:()=>{_.triggerImport()},onSave:()=>{this.saveToComputer.save()},onShare:()=>{U()},onHelp:()=>{s4("./help/",!!this.embed)}})).getElement().style.marginBottom="10px",this.toolspaceInner.append(o.getElement()),this.toolspaceToolRow=new rH.ToolspaceToolRow({onActivate:t=>{if("draw"===t)this.klCanvasWorkspace.setMode("draw");else if("hand"===t)this.klCanvasWorkspace.setMode("hand");else if("fill"===t)this.klCanvasWorkspace.setMode("fill");else if("gradient"===t)this.klCanvasWorkspace.setMode("gradient");else if("text"===t)this.klCanvasWorkspace.setMode("text");else if("shape"===t)this.klCanvasWorkspace.setMode("shape");else throw Error("unknown activeStr");l&&l.open(t),w(),this.klColorSlider.pickingDone()},onZoomIn:()=>{this.klCanvasWorkspace.zoomByStep(C.isPressed("shift")?1/8:.5)},onZoomOut:()=>{this.klCanvasWorkspace.zoomByStep(C.isPressed("shift")?-1/8:-.5)},onUndo:()=>{F.undo()},onRedo:()=>{F.redo()}}),this.toolspaceToolRow.setIsSmall(this.uiHeight<540),D.addListener(()=>{this.toolspaceToolRow.setEnableUndo(D.canUndo()),this.toolspaceToolRow.setEnableRedo(D.canRedo())}),this.toolspaceInner.append(this.toolspaceToolRow.getElement()),this.klColorSlider=new rH.KlColorSlider({width:250,height:30,svHeight:100,startValue:new tI.RGB(0,0,0),onPick:t=>{d=t,s.setColor(t),f.emitColor(t),this.klColorSlider.pickingDone()}}),this.klColorSlider.setHeight(Math.max(163,Math.min(400,this.uiHeight-505))),this.klColorSlider.setPickCallback(t=>{t?this.klCanvasWorkspace.setMode("pick"):(this.klCanvasWorkspace.setMode(this.toolspaceToolRow.getActive()),w())});let k=t=>{"eraserBrush"!==t&&(a=t),this.klColorSlider&&("eraserBrush"===t?this.klColorSlider.enable(!1):this.klColorSlider.enable(!0)),r=t,(s=S[t]).setColor(d),s.setContext(u),this.klCanvasWorkspace.setMode("draw"),this.toolspaceToolRow.setActive("draw"),w()},I=t=>{u=t.context,s.setContext(t.context),this.layerPreview.setLayer(t)},A=tI.el(),T=tI.el({css:{margin:"10px",display:"flex",flexWrap:"wrap",justifyContent:"space-between",alignItems:"flex-end"}}),M=new rH.ToolspaceStabilizerRow({smoothing:1,onSelect:t=>{x.setSmoothing(r1(t))}});A.append(T),tI.append(T,[this.klColorSlider.getElement(),this.klColorSlider.getOutputElement(),M.getElement()]);let L=new rH.TabRow({initialId:"penBrush",useAccent:!0,tabArr:(()=>{let t=[],e=t=>({id:t,image:rH.brushesUI[t].image,title:rH.brushesUI[t].tooltip,onOpen:()=>{S[t].getElement().style.display="block",k(t),this.klColorSlider.pickingDone(),f.emitSliderConfig({sizeSlider:rH.brushesUI[t].sizeSlider,opacitySlider:rH.brushesUI[t].opacitySlider}),y(S[t].getSize()),f.emitOpacity(S[t].getOpacity())},onClose:()=>{S[t].getElement().style.display="none"}}),i=Object.keys(S);for(let s=0;s<i.length;s++)t.push(e(i[s]));return t})()});tI.append(A,[L.getElement(),...Object.entries(rH.brushesUI).map(([t])=>S[t].getElement())]);let R=new rH.HandUi({scale:this.klCanvasWorkspace.getScale(),angleDeg:0,onReset:()=>{this.klCanvasWorkspace.resetView(!0),R.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())},onFit:()=>{this.klCanvasWorkspace.fitView(!0),R.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())},onAngleChange:(t,e)=>{this.klCanvasWorkspace.setAngle(t,e),R.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())}}),P=new rH.FillUi({colorSlider:this.klColorSlider}),B=new rH.GradientUi({colorSlider:this.klColorSlider}),O=new rH.TextUi({colorSlider:this.klColorSlider}),z=new rH.ShapeUi({colorSlider:this.klColorSlider}),V=new rH.GradientTool({onGradient:(t,e,i,s,r,a)=>{let n=E(this.klCanvas.getLayerIndex(u.canvas)),o=B.getSettings(),l={type:o.type,color1:this.klColorSlider.getColor(),isReversed:o.isReversed,opacity:o.opacity,doLockAlpha:o.doLockAlpha,isEraser:o.isEraser,doSnap:C.isPressed("shift")||o.doSnap,x1:e,y1:i,x2:s,y2:r,angleRad:a};t?(this.klCanvas.setComposite(n,null),this.klCanvas.drawGradient(n,l)):this.klCanvas.setComposite(n,{draw:t=>{rH.drawGradient(t,l)}}),this.klCanvasWorkspace.requestFrame()}}),H=new rH.ShapeTool({onShape:(t,e,i,s,r,a)=>{let n=E(this.klCanvas.getLayerIndex(u.canvas)),o={type:z.getShape(),x1:e,y1:i,x2:s,y2:r,angleRad:a,isOutwards:z.getIsOutwards(),opacity:z.getOpacity(),isEraser:z.getIsEraser(),doLockAlpha:z.getDoLockAlpha()};"line"===z.getShape()?(o.strokeRgb=this.klColorSlider.getColor(),o.lineWidth=z.getLineWidth(),o.isAngleSnap=z.getIsSnap()||C.isPressed("shift")):(o.isFixedRatio=z.getIsFixed()||C.isPressed("shift"),"stroke"===z.getMode()?(o.strokeRgb=this.klColorSlider.getColor(),o.lineWidth=z.getLineWidth()):o.fillRgb=this.klColorSlider.getColor()),t?(this.klCanvas.setComposite(n,null),this.klCanvas.drawShape(n,o)):this.klCanvas.setComposite(n,{draw:t=>{rH.drawShape(t,o)}}),this.klCanvasWorkspace.requestFrame()}});this.layerManager=new rH.LayerManager(this.klCanvas,t=>{I(E(this.klCanvas.getLayer(t))),D.push({tool:["misc"],action:"focusLayer",params:[t]})},this.klRootEl,this.uiState),this.layerPreview=new rH.LayerPreview({klRootEl:this.klRootEl,onClick:()=>{l&&l.open("layers")},uiState:this.uiState}),this.layerPreview.setIsVisible(this.uiHeight>=579),this.layerPreview.setLayer(this.klCanvas.getLayer(this.klCanvas.getLayerIndex(u.canvas)));let j=new rH.FilterTab(this.klRootEl,this.klColorSlider,this.layerManager,this.klCanvasWorkspace,R,()=>d,()=>h,()=>this.klCanvas,()=>u,!!this.embed,this.statusOverlay),F=new rH.UndoRedoCatchup(S,this.layerPreview,this.layerManager,R,this.klCanvasWorkspace,()=>{if(!i)throw Error("initState not initialized");return i},()=>this.klCanvas,()=>u,t=>{u=t},()=>s);D.addListener(t=>{F.catchup(t)});let W=()=>{rH.newImageDialog({currentColor:d,secondaryColor:this.klColorSlider.getSecondaryRGB(),maxCanvasSize:h,canvasWidth:this.klCanvas.getWidth(),canvasHeight:this.klCanvas.getHeight(),workspaceWidth:window.innerWidth<this.collapseThreshold?this.uiWidth:this.uiWidth-this.toolWidth,workspaceHeight:this.uiHeight,onConfirm:(t,e,i)=>{this.klCanvas.reset({width:t,height:e,color:1===i.a?i:void 0}),this.layerManager.update(0),I(E(this.klCanvas.getLayer(0))),this.klCanvasWorkspace.resetOrFitView(),R.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg())},onCancel:()=>{}})},U=t=>{tI.shareCanvas({canvas:this.klCanvas.getCompleteCanvas(1),fileName:tI.getDate()+e3.filenameBase+".png",title:tI.getDate()+e3.filenameBase+".png",callback:t||(()=>{})})};this.saveToComputer=new rH.SaveToComputer(e.saveReminder,()=>p,()=>this.klCanvas);let N=t=>{rH.clipboardDialog(this.klRootEl,this.klCanvas.getCompleteCanvas(1),t=>{(0!==t.left||0!==t.right||0!==t.top||0!==t.bottom)&&(rH.filterLib.cropExtend.apply({context:u,klCanvas:this.klCanvas,input:t,history:D}),this.layerManager.update(),this.klCanvasWorkspace.resetOrFitView(),R.update(this.klCanvasWorkspace.getScale(),this.klCanvasWorkspace.getAngleDeg()))},this.statusOverlay,t||!1)},_=this.embed?null:new rH.FileTab(this.klRootEl,c,()=>this.klCanvas.getProject(),p,t=>{p=t},(t,e)=>X.handleFileSelect(t,e),()=>this.saveToComputer.save(),W,U,()=>{rH.imgurUpload(this.klCanvas,this.klRootEl,e.saveReminder,e.app&&e.app.imgurKey?e.app.imgurKey:"")},N,e.saveReminder),Y=new rH.SettingsTab(()=>{this.uiState="left"===this.uiState?"right":"left",this.updateUi(),this.embed||tw.setItem("uiState",this.uiState)},this.embed?void 0:e.saveReminder,e.aboutEl);l=new rH.TabRow({initialId:"draw",tabArr:[{id:"draw",title:tB("tool-brush"),image:m(ix),onOpen:()=>{"eraserBrush"===r&&this.klColorSlider.enable(!1),tI.append(T,[this.klColorSlider.getElement(),this.klColorSlider.getOutputElement(),M.getElement()]),A.style.display="block"},onClose:()=>{A.style.display="none"},css:{minWidth:"45px"}},{id:"hand",title:tB("tool-hand"),image:m(eT),isVisible:!1,onOpen:()=>{R.setIsVisible(!0)},onClose:()=>{R.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"fill",title:tB("tool-paint-bucket"),image:m(iv),isVisible:!1,onOpen:()=>{this.klColorSlider.enable(!0),P.setIsVisible(!0)},onClose:()=>{P.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"gradient",title:tB("tool-gradient"),image:m(ib),isVisible:!1,onOpen:()=>{this.klColorSlider.enable(!0),B.setIsVisible(!0)},onClose:()=>{B.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"text",title:tB("tool-text"),image:m(iw),isVisible:!1,onOpen:()=>{this.klColorSlider.enable(!0),O.setIsVisible(!0)},onClose:()=>{O.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"shape",title:tB("tool-shape"),image:m(iC),isVisible:!1,onOpen:()=>{this.klColorSlider.enable(!0),z.setIsVisible(!0)},onClose:()=>{z.setIsVisible(!1)},css:{minWidth:"45px"}},{id:"layers",title:tB("layers"),image:m(r3),onOpen:()=>{this.layerManager.update(),this.layerManager.getElement().style.display="block"},onClose:()=>{this.layerManager.getElement().style.display="none"},css:{minWidth:"45px"}},{id:"edit",label:tB("tab-edit"),onOpen:()=>{j.show()},onClose:()=>{j.hide()},css:{padding:"0 7px"}},{id:"file",label:tB("tab-file"),isVisible:!!_,onOpen:()=>{_&&(_.getElement().style.display="block",_.setIsVisible(!0))},onClose:()=>{_&&(_.getElement().style.display="none",_.setIsVisible(!1))},css:{padding:"0 7px"}},{id:"settings",title:tB("tab-settings"),image:m(r5),onOpen:()=>{Y.getElement().style.display="block"},onClose:()=>{Y.getElement().style.display="none"},css:{minWidth:"45px"}}]}),this.bottomBarWrapper=tI.el({css:{width:"270px",position:"absolute",bottom:"0",left:"0"}}),e.bottomBar&&(this.bottomBar=e.bottomBar,this.bottomBarWrapper.append(this.bottomBar),new MutationObserver(()=>this.updateBottomBar()).observe(this.toolspaceInner,{attributes:!0,childList:!0,subtree:!0})),tI.append(this.toolspaceInner,[this.layerPreview.getElement(),l.getElement(),A,R.getElement(),P.getElement(),B.getElement(),O.getElement(),z.getElement(),this.layerManager.getElement(),j.getElement(),_?_.getElement():void 0,Y.getElement(),tI.el({css:{height:"10px"}}),this.bottomBarWrapper?this.bottomBarWrapper:void 0]),this.toolspaceScroller=new rH.ToolspaceScroller({toolspace:this.toolspace,uiState:this.uiState}),this.embed||Object.defineProperty(window,"KL",{value:function(t){let e=["Draw via the console! Learn more: %cKL.help()","background: #000; color: #0f0;"];return"info"in console?console.info(...e):console.log(...e),Object.freeze({draw:e=>{t.onDraw(e)},help:()=>{console.log(`KL.draw({x: number; y: number}[]) // draw a line
KL.help() // print help
`)}})}({onDraw:t=>{t&&0!==t.length&&(t.forEach((t,e)=>{0===e?s.startLine(t.x,t.y,1):s.goLine(t.x,t.y,1)}),s.endLine(),this.klCanvasWorkspace.requestFrame())}}),writable:!1}),this.resize(this.uiWidth,this.uiHeight),this.updateUi();let X=new r2({klRootEl:this.klRootEl,klMaxCanvasSize:h,layerManager:this.layerManager,setCurrentLayer:I,klCanvas:this.klCanvas,klCanvasWorkspace:this.klCanvasWorkspace,handUi:R},{onColor:t=>f.setColor(t)});this.embed||(new rH.KlImageDropper({target:document.body,onDrop:(t,e)=>{rH.dialogCounter.get()>0||X.handleFileSelect(t,e)},enabledTest:()=>0===rH.dialogCounter.get()}),window.document.addEventListener("paste",t=>X.onPaste(t),!1));{window.addEventListener("resize",()=>{this.resize(window.innerWidth,window.innerHeight)}),window.addEventListener("orientationchange",()=>{this.resize(window.innerWidth,window.innerHeight)});let t=tI.el({parent:document.body,css:{position:"fixed",left:"0",top:"0",right:"0",bottom:"0",pointerEvents:"none",zIndex:"-1",userSelect:"none"}});try{new ResizeObserver(()=>this.resize(window.innerWidth,window.innerHeight)).observe(t)}catch(e){t.remove()}this.klRootEl.addEventListener("wheel",t=>{C.isPressed("ctrl")&&t.preventDefault()});let e=t=>{t.preventDefault()};window.addEventListener("gesturestart",e),window.addEventListener("gesturechange",e),window.addEventListener("gestureend",e)}}}function r9(t){let e=document.createElement("div");e.style.textAlign="center",e.style.background="#fff",e.style.padding="20px",e.innerHTML="<h1>App failed to initialize</h1>";let i=document.createElement("div");i.textContent="Error: "+(t.message?t.message:""+t),e.append(i),document.body.append(e),console.error(t)}(async()=>{let t;let e=!1;try{window.addEventListener("DOMContentLoaded",()=>{e=!0}),await tO()}catch(t){r9(t);return}async function i(){try{window.removeEventListener("DOMContentLoaded",i);let e=new rH.ProjectStore,s=null;try{let t=await e.read();t&&(s=t.project)}catch(i){let e;0===i.message.indexOf("db-error")?e="Failed to access Browser Storage":(i.message.indexOf("format-error"),e="Failed to restore from Browser Storage"),e&&setTimeout(function(){throw t&&t.out(e),Error("Initial browser storage error, "+i)},100)}!function(e,i){if(t)throw"onKlProjectObjLoaded called more than once";let s=document.getElementById("loading-screen");null==s||s.remove();let r=new rH.SaveReminder(D,!0,!0,()=>t.saveAsPsd(),()=>!!t&&t.isDrawing(),null,null);t=new r4(e,{saveReminder:r,projectStore:i}),r.init(),e&&setTimeout(()=>{t.out(tB("file-storage-restored"))},100),document.body.append(t.getEl()),window.klecks=t}(s,e)}catch(t){r9(t)}}e?i():window.addEventListener("DOMContentLoaded",i)})();
//# sourceMappingURL=index.564750fa.js.map
